<!DOCTYPE html>
<!-- saved from url=(0044)https://wwrk-2019-06.container.training/#599 -->
<html class="remark-container" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style data-merge-styles="true"></style><style type="text/css" title="remark">html.remark-container,body.remark-container{height:100%;width:100%;-webkit-print-color-adjust:exact}.remark-container{background:#d7d8d2;margin:0;overflow:hidden}.remark-container:focus{outline-style:solid;outline-width:1px}.remark-container:-webkit-full-screen{width:100%;height:100%}body:-webkit-full-screen{background:#000000}body:-moz-full-screen{background:#000000}body:fullscreen{background:#000000}.remark-slides-area{position:relative;height:100%;width:100%}.remark-slide-container{display:none;position:absolute;height:100%;width:100%;page-break-after:always}.remark-slide-scaler{background-color:transparent;overflow:hidden;position:absolute;-webkit-transform-origin:top left;-moz-transform-origin:top left;transform-origin:top-left;-moz-box-shadow:0 0 30px #888;-webkit-box-shadow:0 0 30px #888;box-shadow:0 0 30px #888}.remark-slide{height:100%;width:100%;display:table;table-layout:fixed}.remark-slide>.left{text-align:left}.remark-slide>.center{text-align:center}.remark-slide>.right{text-align:right}.remark-slide>.top{vertical-align:top}.remark-slide>.middle{vertical-align:middle}.remark-slide>.bottom{vertical-align:bottom}.remark-slide-content{background-color:#fff;background-position:center;background-repeat:no-repeat;display:table-cell;font-size:20px;padding:1em 4em 1em 4em}.remark-slide-content h1{font-size:55px}.remark-slide-content h2{font-size:45px}.remark-slide-content h3{font-size:35px}.remark-slide-content .left{display:block;text-align:left}.remark-slide-content .center{display:block;text-align:center}.remark-slide-content .right{display:block;text-align:right}.remark-slide-number{bottom:12px;opacity:.5;position:absolute;right:20px}.remark-slide-notes{border-top:3px solid black;position:absolute;display:none}.remark-code{font-size:18px}.remark-code-line{min-height:1em}.remark-code-line-highlighted{background-color:rgba(255,255,0,0.5)}.remark-code-span-highlighted{background-color:rgba(255,255,0,0.5);padding:1px 2px 2px 2px}.remark-visible{display:block;z-index:2}.remark-fading{display:block;z-index:1}.remark-fading .remark-slide-scaler{-moz-box-shadow:none;-webkit-box-shadow:none;box-shadow:none}.remark-backdrop{position:absolute;top:0;bottom:0;left:0;right:0;display:none;background:#000;z-index:2}.remark-pause{bottom:0;top:0;right:0;left:0;display:none;position:absolute;z-index:1000}.remark-pause .remark-pause-lozenge{margin-top:30%;text-align:center}.remark-pause .remark-pause-lozenge span{color:white;background:black;border:2px solid black;border-radius:20px;padding:20px 30px;font-family:Helvetica,arial,freesans,clean,sans-serif;font-size:42pt;font-weight:bold}.remark-container.remark-presenter-mode.remark-pause-mode .remark-pause{display:block}.remark-container.remark-presenter-mode.remark-pause-mode .remark-backdrop{display:block;opacity:.5}.remark-help{bottom:0;top:0;right:0;left:0;display:none;position:absolute;z-index:1000;-webkit-transform-origin:top left;-moz-transform-origin:top left;transform-origin:top-left}.remark-help .remark-help-content{color:white;font-family:Helvetica,arial,freesans,clean,sans-serif;font-size:12pt;position:absolute;top:5%;bottom:10%;height:10%;left:5%;width:90%}.remark-help .remark-help-content h1{font-size:36px}.remark-help .remark-help-content td{color:white;font-size:12pt;padding:10px}.remark-help .remark-help-content td:first-child{padding-left:0}.remark-help .remark-help-content .key{background:white;color:black;min-width:1em;display:inline-block;padding:3px 6px;text-align:center;border-radius:4px;font-size:14px}.remark-help .dismiss{top:85%}.remark-container.remark-help-mode .remark-help{display:block}.remark-container.remark-help-mode .remark-backdrop{display:block;opacity:.95}.remark-preview-area{bottom:2%;left:2%;display:none;opacity:.5;position:absolute;height:47.25%;width:48%}.remark-preview-area .remark-slide-container{display:block}.remark-notes-area{background:#fff;bottom:0;color:black;display:none;left:52%;overflow:hidden;position:absolute;right:0;top:0}.remark-notes-area .remark-top-area{height:50px;left:20px;position:absolute;right:10px;top:10px}.remark-notes-area .remark-bottom-area{position:absolute;top:75px;bottom:10px;left:20px;right:10px}.remark-notes-area .remark-bottom-area .remark-toggle{display:block;text-decoration:none;font-family:Helvetica,arial,freesans,clean,sans-serif;height:21px;font-size:.75em;text-transform:uppercase;color:#ccc}.remark-notes-area .remark-bottom-area .remark-notes-current-area{height:70%;position:relative}.remark-notes-area .remark-bottom-area .remark-notes-current-area .remark-notes{clear:both;border-top:1px solid #f5f5f5;position:absolute;top:22px;bottom:0;left:0;right:0;overflow-y:auto;margin-bottom:20px;padding-top:10px}.remark-notes-area .remark-bottom-area .remark-notes-preview-area{height:30%;position:relative}.remark-notes-area .remark-bottom-area .remark-notes-preview-area .remark-notes-preview{border-top:1px solid #f5f5f5;position:absolute;top:22px;bottom:0;left:0;right:0;overflow-y:auto}.remark-notes-area .remark-bottom-area .remark-notes>*:first-child,.remark-notes-area .remark-bottom-area .remark-notes-preview>*:first-child{margin-top:5px}.remark-notes-area .remark-bottom-area .remark-notes>*:last-child,.remark-notes-area .remark-bottom-area .remark-notes-preview>*:last-child{margin-bottom:0}.remark-toolbar{color:#979892;vertical-align:middle}.remark-toolbar .remark-toolbar-link{border:2px solid #d7d8d2;color:#979892;display:inline-block;padding:2px 2px;text-decoration:none;text-align:center;min-width:20px}.remark-toolbar .remark-toolbar-link:hover{border-color:#979892;color:#676862}.remark-toolbar .remark-toolbar-timer{border:2px solid black;border-radius:10px;background:black;color:white;display:inline-block;float:right;padding:5px 10px;font-family:sans-serif;font-weight:bold;font-size:175%;text-decoration:none;text-align:center}.remark-container.remark-presenter-mode .remark-slides-area{top:2%;left:2%;height:47.25%;width:48%}.remark-container.remark-presenter-mode .remark-preview-area{display:block}.remark-container.remark-presenter-mode .remark-notes-area{display:block}.remark-container.remark-blackout-mode:not(.remark-presenter-mode) .remark-backdrop{display:block;opacity:.99}.remark-container.remark-mirrored-mode:not(.remark-presenter-mode) .remark-slides-area{-webkit-transform:scaleX(-1);-moz-transform:scaleX(-1);-ms-transform:scaleX(-1);-o-transform:scaleX(-1)}@media print{.remark-container{overflow:visible;background-color:#fff}.remark-container.remark-presenter-mode .remark-slides-area{top:0;left:0;height:100%;width:681px}.remark-container.remark-presenter-mode .remark-preview-area,.remark-container.remark-presenter-mode .remark-notes-area{display:none}.remark-container.remark-presenter-mode .remark-slide-notes{display:block;margin-left:30px;width:621px}.remark-slide-container{display:block;position:relative}.remark-slide-scaler{-moz-box-shadow:none;-webkit-box-shadow:none;-webkit-transform-origin:initial;box-shadow:none}}@page{margin:0}.hljs-agate{/*! * Agate by Taufik Nurrohman <https://github.com/tovic> * ---------------------------------------------------- * * #ade5fc * #a2fca2 * #c6b4f0 * #d36363 * #fcc28c * #fc9b9b * #ffa * #fff * #333 * #62c8f3 * #888 * */}.hljs-agate .hljs{display:block;overflow-x:auto;padding:.5em;background:#333;color:white}.hljs-agate .hljs-name,.hljs-agate .hljs-strong{font-weight:bold}.hljs-agate .hljs-code,.hljs-agate .hljs-emphasis{font-style:italic}.hljs-agate .hljs-tag{color:#62c8f3}.hljs-agate .hljs-variable,.hljs-agate .hljs-template-variable,.hljs-agate .hljs-selector-id,.hljs-agate .hljs-selector-class{color:#ade5fc}.hljs-agate .hljs-string,.hljs-agate .hljs-bullet{color:#a2fca2}.hljs-agate .hljs-type,.hljs-agate .hljs-title,.hljs-agate .hljs-section,.hljs-agate .hljs-attribute,.hljs-agate .hljs-quote,.hljs-agate .hljs-built_in,.hljs-agate .hljs-builtin-name{color:#ffa}.hljs-agate .hljs-number,.hljs-agate .hljs-symbol,.hljs-agate .hljs-bullet{color:#d36363}.hljs-agate .hljs-keyword,.hljs-agate .hljs-selector-tag,.hljs-agate .hljs-literal{color:#fcc28c}.hljs-agate .hljs-comment,.hljs-agate .hljs-deletion,.hljs-agate .hljs-code{color:#888}.hljs-agate .hljs-regexp,.hljs-agate .hljs-link{color:#c6b4f0}.hljs-agate .hljs-meta{color:#fc9b9b}.hljs-agate .hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-agate .hljs-addition{background-color:#a2fca2;color:#333}.hljs-agate .hljs a{color:inherit}.hljs-agate .hljs a:focus,.hljs-agate .hljs a:hover{color:inherit;text-decoration:underline}.hljs-androidstudio .hljs{color:#a9b7c6;background:#282b2e;display:block;overflow-x:auto;padding:.5em}.hljs-androidstudio .hljs-number,.hljs-androidstudio .hljs-literal,.hljs-androidstudio .hljs-symbol,.hljs-androidstudio .hljs-bullet{color:#6897BB}.hljs-androidstudio .hljs-keyword,.hljs-androidstudio .hljs-selector-tag,.hljs-androidstudio .hljs-deletion{color:#cc7832}.hljs-androidstudio .hljs-variable,.hljs-androidstudio .hljs-template-variable,.hljs-androidstudio .hljs-link{color:#629755}.hljs-androidstudio .hljs-comment,.hljs-androidstudio .hljs-quote{color:#808080}.hljs-androidstudio .hljs-meta{color:#bbb529}.hljs-androidstudio .hljs-string,.hljs-androidstudio .hljs-attribute,.hljs-androidstudio .hljs-addition{color:#6A8759}.hljs-androidstudio .hljs-section,.hljs-androidstudio .hljs-title,.hljs-androidstudio .hljs-type{color:#ffc66d}.hljs-androidstudio .hljs-name,.hljs-androidstudio .hljs-selector-id,.hljs-androidstudio .hljs-selector-class{color:#e8bf6a}.hljs-androidstudio .hljs-emphasis{font-style:italic}.hljs-androidstudio .hljs-strong{font-weight:bold}.hljs-arduino-light .hljs{display:block;overflow-x:auto;padding:.5em;background:#FFFFFF}.hljs-arduino-light .hljs,.hljs-arduino-light .hljs-subst{color:#434f54}.hljs-arduino-light .hljs-keyword,.hljs-arduino-light .hljs-attribute,.hljs-arduino-light .hljs-selector-tag,.hljs-arduino-light .hljs-doctag,.hljs-arduino-light .hljs-name{color:#00979D}.hljs-arduino-light .hljs-built_in,.hljs-arduino-light .hljs-literal,.hljs-arduino-light .hljs-bullet,.hljs-arduino-light .hljs-code,.hljs-arduino-light .hljs-addition{color:#D35400}.hljs-arduino-light .hljs-regexp,.hljs-arduino-light .hljs-symbol,.hljs-arduino-light .hljs-variable,.hljs-arduino-light .hljs-template-variable,.hljs-arduino-light .hljs-link,.hljs-arduino-light .hljs-selector-attr,.hljs-arduino-light .hljs-selector-pseudo{color:#00979D}.hljs-arduino-light .hljs-type,.hljs-arduino-light .hljs-string,.hljs-arduino-light .hljs-selector-id,.hljs-arduino-light .hljs-selector-class,.hljs-arduino-light .hljs-quote,.hljs-arduino-light .hljs-template-tag,.hljs-arduino-light .hljs-deletion{color:#005C5F}.hljs-arduino-light .hljs-title,.hljs-arduino-light .hljs-section{color:#880000;font-weight:bold}.hljs-arduino-light .hljs-comment{color:rgba(149,165,166,0.8)}.hljs-arduino-light .hljs-meta-keyword{color:#728E00}.hljs-arduino-light .hljs-meta{color:#728E00;color:#434f54}.hljs-arduino-light .hljs-emphasis{font-style:italic}.hljs-arduino-light .hljs-strong{font-weight:bold}.hljs-arduino-light .hljs-function{color:#728E00}.hljs-arduino-light .hljs-number{color:#8A7B52}.hljs-arta .hljs{display:block;overflow-x:auto;padding:.5em;background:#222}.hljs-arta .hljs,.hljs-arta .hljs-subst{color:#aaa}.hljs-arta .hljs-section{color:#fff}.hljs-arta .hljs-comment,.hljs-arta .hljs-quote,.hljs-arta .hljs-meta{color:#444}.hljs-arta .hljs-string,.hljs-arta .hljs-symbol,.hljs-arta .hljs-bullet,.hljs-arta .hljs-regexp{color:#ffcc33}.hljs-arta .hljs-number,.hljs-arta .hljs-addition{color:#00cc66}.hljs-arta .hljs-built_in,.hljs-arta .hljs-builtin-name,.hljs-arta .hljs-literal,.hljs-arta .hljs-type,.hljs-arta .hljs-template-variable,.hljs-arta .hljs-attribute,.hljs-arta .hljs-link{color:#32aaee}.hljs-arta .hljs-keyword,.hljs-arta .hljs-selector-tag,.hljs-arta .hljs-name,.hljs-arta .hljs-selector-id,.hljs-arta .hljs-selector-class{color:#6644aa}.hljs-arta .hljs-title,.hljs-arta .hljs-variable,.hljs-arta .hljs-deletion,.hljs-arta .hljs-template-tag{color:#bb1166}.hljs-arta .hljs-section,.hljs-arta .hljs-doctag,.hljs-arta .hljs-strong{font-weight:bold}.hljs-arta .hljs-emphasis{font-style:italic}.hljs-ascetic .hljs{display:block;overflow-x:auto;padding:.5em;background:white;color:black}.hljs-ascetic .hljs-string,.hljs-ascetic .hljs-variable,.hljs-ascetic .hljs-template-variable,.hljs-ascetic .hljs-symbol,.hljs-ascetic .hljs-bullet,.hljs-ascetic .hljs-section,.hljs-ascetic .hljs-addition,.hljs-ascetic .hljs-attribute,.hljs-ascetic .hljs-link{color:#888}.hljs-ascetic .hljs-comment,.hljs-ascetic .hljs-quote,.hljs-ascetic .hljs-meta,.hljs-ascetic .hljs-deletion{color:#ccc}.hljs-ascetic .hljs-keyword,.hljs-ascetic .hljs-selector-tag,.hljs-ascetic .hljs-section,.hljs-ascetic .hljs-name,.hljs-ascetic .hljs-type,.hljs-ascetic .hljs-strong{font-weight:bold}.hljs-ascetic .hljs-emphasis{font-style:italic}.hljs-atelier-cave-dark .hljs-comment,.hljs-atelier-cave-dark .hljs-quote{color:#7e7887}.hljs-atelier-cave-dark .hljs-variable,.hljs-atelier-cave-dark .hljs-template-variable,.hljs-atelier-cave-dark .hljs-attribute,.hljs-atelier-cave-dark .hljs-regexp,.hljs-atelier-cave-dark .hljs-link,.hljs-atelier-cave-dark .hljs-tag,.hljs-atelier-cave-dark .hljs-name,.hljs-atelier-cave-dark .hljs-selector-id,.hljs-atelier-cave-dark .hljs-selector-class{color:#be4678}.hljs-atelier-cave-dark .hljs-number,.hljs-atelier-cave-dark .hljs-meta,.hljs-atelier-cave-dark .hljs-built_in,.hljs-atelier-cave-dark .hljs-builtin-name,.hljs-atelier-cave-dark .hljs-literal,.hljs-atelier-cave-dark .hljs-type,.hljs-atelier-cave-dark .hljs-params{color:#aa573c}.hljs-atelier-cave-dark .hljs-string,.hljs-atelier-cave-dark .hljs-symbol,.hljs-atelier-cave-dark .hljs-bullet{color:#2a9292}.hljs-atelier-cave-dark .hljs-title,.hljs-atelier-cave-dark .hljs-section{color:#576ddb}.hljs-atelier-cave-dark .hljs-keyword,.hljs-atelier-cave-dark .hljs-selector-tag{color:#955ae7}.hljs-atelier-cave-dark .hljs-deletion,.hljs-atelier-cave-dark .hljs-addition{color:#19171c;display:inline-block;width:100%}.hljs-atelier-cave-dark .hljs-deletion{background-color:#be4678}.hljs-atelier-cave-dark .hljs-addition{background-color:#2a9292}.hljs-atelier-cave-dark .hljs{display:block;overflow-x:auto;background:#19171c;color:#8b8792;padding:.5em}.hljs-atelier-cave-dark .hljs-emphasis{font-style:italic}.hljs-atelier-cave-dark .hljs-strong{font-weight:bold}.hljs-atelier-cave-light .hljs-comment,.hljs-atelier-cave-light .hljs-quote{color:#655f6d}.hljs-atelier-cave-light .hljs-variable,.hljs-atelier-cave-light .hljs-template-variable,.hljs-atelier-cave-light .hljs-attribute,.hljs-atelier-cave-light .hljs-tag,.hljs-atelier-cave-light .hljs-name,.hljs-atelier-cave-light .hljs-regexp,.hljs-atelier-cave-light .hljs-link,.hljs-atelier-cave-light .hljs-name,.hljs-atelier-cave-light .hljs-name,.hljs-atelier-cave-light .hljs-selector-id,.hljs-atelier-cave-light .hljs-selector-class{color:#be4678}.hljs-atelier-cave-light .hljs-number,.hljs-atelier-cave-light .hljs-meta,.hljs-atelier-cave-light .hljs-built_in,.hljs-atelier-cave-light .hljs-builtin-name,.hljs-atelier-cave-light .hljs-literal,.hljs-atelier-cave-light .hljs-type,.hljs-atelier-cave-light .hljs-params{color:#aa573c}.hljs-atelier-cave-light .hljs-string,.hljs-atelier-cave-light .hljs-symbol,.hljs-atelier-cave-light .hljs-bullet{color:#2a9292}.hljs-atelier-cave-light .hljs-title,.hljs-atelier-cave-light .hljs-section{color:#576ddb}.hljs-atelier-cave-light .hljs-keyword,.hljs-atelier-cave-light .hljs-selector-tag{color:#955ae7}.hljs-atelier-cave-light .hljs-deletion,.hljs-atelier-cave-light .hljs-addition{color:#19171c;display:inline-block;width:100%}.hljs-atelier-cave-light .hljs-deletion{background-color:#be4678}.hljs-atelier-cave-light .hljs-addition{background-color:#2a9292}.hljs-atelier-cave-light .hljs{display:block;overflow-x:auto;background:#efecf4;color:#585260;padding:.5em}.hljs-atelier-cave-light .hljs-emphasis{font-style:italic}.hljs-atelier-cave-light .hljs-strong{font-weight:bold}.hljs-atelier-dune-dark .hljs-comment,.hljs-atelier-dune-dark .hljs-quote{color:#999580}.hljs-atelier-dune-dark .hljs-variable,.hljs-atelier-dune-dark .hljs-template-variable,.hljs-atelier-dune-dark .hljs-attribute,.hljs-atelier-dune-dark .hljs-tag,.hljs-atelier-dune-dark .hljs-name,.hljs-atelier-dune-dark .hljs-regexp,.hljs-atelier-dune-dark .hljs-link,.hljs-atelier-dune-dark .hljs-name,.hljs-atelier-dune-dark .hljs-selector-id,.hljs-atelier-dune-dark .hljs-selector-class{color:#d73737}.hljs-atelier-dune-dark .hljs-number,.hljs-atelier-dune-dark .hljs-meta,.hljs-atelier-dune-dark .hljs-built_in,.hljs-atelier-dune-dark .hljs-builtin-name,.hljs-atelier-dune-dark .hljs-literal,.hljs-atelier-dune-dark .hljs-type,.hljs-atelier-dune-dark .hljs-params{color:#b65611}.hljs-atelier-dune-dark .hljs-string,.hljs-atelier-dune-dark .hljs-symbol,.hljs-atelier-dune-dark .hljs-bullet{color:#60ac39}.hljs-atelier-dune-dark .hljs-title,.hljs-atelier-dune-dark .hljs-section{color:#6684e1}.hljs-atelier-dune-dark .hljs-keyword,.hljs-atelier-dune-dark .hljs-selector-tag{color:#b854d4}.hljs-atelier-dune-dark .hljs{display:block;overflow-x:auto;background:#20201d;color:#a6a28c;padding:.5em}.hljs-atelier-dune-dark .hljs-emphasis{font-style:italic}.hljs-atelier-dune-dark .hljs-strong{font-weight:bold}.hljs-atelier-dune-light .hljs-comment,.hljs-atelier-dune-light .hljs-quote{color:#7d7a68}.hljs-atelier-dune-light .hljs-variable,.hljs-atelier-dune-light .hljs-template-variable,.hljs-atelier-dune-light .hljs-attribute,.hljs-atelier-dune-light .hljs-tag,.hljs-atelier-dune-light .hljs-name,.hljs-atelier-dune-light .hljs-regexp,.hljs-atelier-dune-light .hljs-link,.hljs-atelier-dune-light .hljs-name,.hljs-atelier-dune-light .hljs-selector-id,.hljs-atelier-dune-light .hljs-selector-class{color:#d73737}.hljs-atelier-dune-light .hljs-number,.hljs-atelier-dune-light .hljs-meta,.hljs-atelier-dune-light .hljs-built_in,.hljs-atelier-dune-light .hljs-builtin-name,.hljs-atelier-dune-light .hljs-literal,.hljs-atelier-dune-light .hljs-type,.hljs-atelier-dune-light .hljs-params{color:#b65611}.hljs-atelier-dune-light .hljs-string,.hljs-atelier-dune-light .hljs-symbol,.hljs-atelier-dune-light .hljs-bullet{color:#60ac39}.hljs-atelier-dune-light .hljs-title,.hljs-atelier-dune-light .hljs-section{color:#6684e1}.hljs-atelier-dune-light .hljs-keyword,.hljs-atelier-dune-light .hljs-selector-tag{color:#b854d4}.hljs-atelier-dune-light .hljs{display:block;overflow-x:auto;background:#fefbec;color:#6e6b5e;padding:.5em}.hljs-atelier-dune-light .hljs-emphasis{font-style:italic}.hljs-atelier-dune-light .hljs-strong{font-weight:bold}.hljs-atelier-estuary-dark .hljs-comment,.hljs-atelier-estuary-dark .hljs-quote{color:#878573}.hljs-atelier-estuary-dark .hljs-variable,.hljs-atelier-estuary-dark .hljs-template-variable,.hljs-atelier-estuary-dark .hljs-attribute,.hljs-atelier-estuary-dark .hljs-tag,.hljs-atelier-estuary-dark .hljs-name,.hljs-atelier-estuary-dark .hljs-regexp,.hljs-atelier-estuary-dark .hljs-link,.hljs-atelier-estuary-dark .hljs-name,.hljs-atelier-estuary-dark .hljs-selector-id,.hljs-atelier-estuary-dark .hljs-selector-class{color:#ba6236}.hljs-atelier-estuary-dark .hljs-number,.hljs-atelier-estuary-dark .hljs-meta,.hljs-atelier-estuary-dark .hljs-built_in,.hljs-atelier-estuary-dark .hljs-builtin-name,.hljs-atelier-estuary-dark .hljs-literal,.hljs-atelier-estuary-dark .hljs-type,.hljs-atelier-estuary-dark .hljs-params{color:#ae7313}.hljs-atelier-estuary-dark .hljs-string,.hljs-atelier-estuary-dark .hljs-symbol,.hljs-atelier-estuary-dark .hljs-bullet{color:#7d9726}.hljs-atelier-estuary-dark .hljs-title,.hljs-atelier-estuary-dark .hljs-section{color:#36a166}.hljs-atelier-estuary-dark .hljs-keyword,.hljs-atelier-estuary-dark .hljs-selector-tag{color:#5f9182}.hljs-atelier-estuary-dark .hljs-deletion,.hljs-atelier-estuary-dark .hljs-addition{color:#22221b;display:inline-block;width:100%}.hljs-atelier-estuary-dark .hljs-deletion{background-color:#ba6236}.hljs-atelier-estuary-dark .hljs-addition{background-color:#7d9726}.hljs-atelier-estuary-dark .hljs{display:block;overflow-x:auto;background:#22221b;color:#929181;padding:.5em}.hljs-atelier-estuary-dark .hljs-emphasis{font-style:italic}.hljs-atelier-estuary-dark .hljs-strong{font-weight:bold}.hljs-atelier-estuary-light .hljs-comment,.hljs-atelier-estuary-light .hljs-quote{color:#6c6b5a}.hljs-atelier-estuary-light .hljs-variable,.hljs-atelier-estuary-light .hljs-template-variable,.hljs-atelier-estuary-light .hljs-attribute,.hljs-atelier-estuary-light .hljs-tag,.hljs-atelier-estuary-light .hljs-name,.hljs-atelier-estuary-light .hljs-regexp,.hljs-atelier-estuary-light .hljs-link,.hljs-atelier-estuary-light .hljs-name,.hljs-atelier-estuary-light .hljs-selector-id,.hljs-atelier-estuary-light .hljs-selector-class{color:#ba6236}.hljs-atelier-estuary-light .hljs-number,.hljs-atelier-estuary-light .hljs-meta,.hljs-atelier-estuary-light .hljs-built_in,.hljs-atelier-estuary-light .hljs-builtin-name,.hljs-atelier-estuary-light .hljs-literal,.hljs-atelier-estuary-light .hljs-type,.hljs-atelier-estuary-light .hljs-params{color:#ae7313}.hljs-atelier-estuary-light .hljs-string,.hljs-atelier-estuary-light .hljs-symbol,.hljs-atelier-estuary-light .hljs-bullet{color:#7d9726}.hljs-atelier-estuary-light .hljs-title,.hljs-atelier-estuary-light .hljs-section{color:#36a166}.hljs-atelier-estuary-light .hljs-keyword,.hljs-atelier-estuary-light .hljs-selector-tag{color:#5f9182}.hljs-atelier-estuary-light .hljs-deletion,.hljs-atelier-estuary-light .hljs-addition{color:#22221b;display:inline-block;width:100%}.hljs-atelier-estuary-light .hljs-deletion{background-color:#ba6236}.hljs-atelier-estuary-light .hljs-addition{background-color:#7d9726}.hljs-atelier-estuary-light .hljs{display:block;overflow-x:auto;background:#f4f3ec;color:#5f5e4e;padding:.5em}.hljs-atelier-estuary-light .hljs-emphasis{font-style:italic}.hljs-atelier-estuary-light .hljs-strong{font-weight:bold}.hljs-atelier-forest-dark .hljs-comment,.hljs-atelier-forest-dark .hljs-quote{color:#9c9491}.hljs-atelier-forest-dark .hljs-variable,.hljs-atelier-forest-dark .hljs-template-variable,.hljs-atelier-forest-dark .hljs-attribute,.hljs-atelier-forest-dark .hljs-tag,.hljs-atelier-forest-dark .hljs-name,.hljs-atelier-forest-dark .hljs-regexp,.hljs-atelier-forest-dark .hljs-link,.hljs-atelier-forest-dark .hljs-name,.hljs-atelier-forest-dark .hljs-selector-id,.hljs-atelier-forest-dark .hljs-selector-class{color:#f22c40}.hljs-atelier-forest-dark .hljs-number,.hljs-atelier-forest-dark .hljs-meta,.hljs-atelier-forest-dark .hljs-built_in,.hljs-atelier-forest-dark .hljs-builtin-name,.hljs-atelier-forest-dark .hljs-literal,.hljs-atelier-forest-dark .hljs-type,.hljs-atelier-forest-dark .hljs-params{color:#df5320}.hljs-atelier-forest-dark .hljs-string,.hljs-atelier-forest-dark .hljs-symbol,.hljs-atelier-forest-dark .hljs-bullet{color:#7b9726}.hljs-atelier-forest-dark .hljs-title,.hljs-atelier-forest-dark .hljs-section{color:#407ee7}.hljs-atelier-forest-dark .hljs-keyword,.hljs-atelier-forest-dark .hljs-selector-tag{color:#6666ea}.hljs-atelier-forest-dark .hljs{display:block;overflow-x:auto;background:#1b1918;color:#a8a19f;padding:.5em}.hljs-atelier-forest-dark .hljs-emphasis{font-style:italic}.hljs-atelier-forest-dark .hljs-strong{font-weight:bold}.hljs-atelier-forest-light .hljs-comment,.hljs-atelier-forest-light .hljs-quote{color:#766e6b}.hljs-atelier-forest-light .hljs-variable,.hljs-atelier-forest-light .hljs-template-variable,.hljs-atelier-forest-light .hljs-attribute,.hljs-atelier-forest-light .hljs-tag,.hljs-atelier-forest-light .hljs-name,.hljs-atelier-forest-light .hljs-regexp,.hljs-atelier-forest-light .hljs-link,.hljs-atelier-forest-light .hljs-name,.hljs-atelier-forest-light .hljs-selector-id,.hljs-atelier-forest-light .hljs-selector-class{color:#f22c40}.hljs-atelier-forest-light .hljs-number,.hljs-atelier-forest-light .hljs-meta,.hljs-atelier-forest-light .hljs-built_in,.hljs-atelier-forest-light .hljs-builtin-name,.hljs-atelier-forest-light .hljs-literal,.hljs-atelier-forest-light .hljs-type,.hljs-atelier-forest-light .hljs-params{color:#df5320}.hljs-atelier-forest-light .hljs-string,.hljs-atelier-forest-light .hljs-symbol,.hljs-atelier-forest-light .hljs-bullet{color:#7b9726}.hljs-atelier-forest-light .hljs-title,.hljs-atelier-forest-light .hljs-section{color:#407ee7}.hljs-atelier-forest-light .hljs-keyword,.hljs-atelier-forest-light .hljs-selector-tag{color:#6666ea}.hljs-atelier-forest-light .hljs{display:block;overflow-x:auto;background:#f1efee;color:#68615e;padding:.5em}.hljs-atelier-forest-light .hljs-emphasis{font-style:italic}.hljs-atelier-forest-light .hljs-strong{font-weight:bold}.hljs-atelier-heath-dark .hljs-comment,.hljs-atelier-heath-dark .hljs-quote{color:#9e8f9e}.hljs-atelier-heath-dark .hljs-variable,.hljs-atelier-heath-dark .hljs-template-variable,.hljs-atelier-heath-dark .hljs-attribute,.hljs-atelier-heath-dark .hljs-tag,.hljs-atelier-heath-dark .hljs-name,.hljs-atelier-heath-dark .hljs-regexp,.hljs-atelier-heath-dark .hljs-link,.hljs-atelier-heath-dark .hljs-name,.hljs-atelier-heath-dark .hljs-selector-id,.hljs-atelier-heath-dark .hljs-selector-class{color:#ca402b}.hljs-atelier-heath-dark .hljs-number,.hljs-atelier-heath-dark .hljs-meta,.hljs-atelier-heath-dark .hljs-built_in,.hljs-atelier-heath-dark .hljs-builtin-name,.hljs-atelier-heath-dark .hljs-literal,.hljs-atelier-heath-dark .hljs-type,.hljs-atelier-heath-dark .hljs-params{color:#a65926}.hljs-atelier-heath-dark .hljs-string,.hljs-atelier-heath-dark .hljs-symbol,.hljs-atelier-heath-dark .hljs-bullet{color:#918b3b}.hljs-atelier-heath-dark .hljs-title,.hljs-atelier-heath-dark .hljs-section{color:#516aec}.hljs-atelier-heath-dark .hljs-keyword,.hljs-atelier-heath-dark .hljs-selector-tag{color:#7b59c0}.hljs-atelier-heath-dark .hljs{display:block;overflow-x:auto;background:#1b181b;color:#ab9bab;padding:.5em}.hljs-atelier-heath-dark .hljs-emphasis{font-style:italic}.hljs-atelier-heath-dark .hljs-strong{font-weight:bold}.hljs-atelier-heath-light .hljs-comment,.hljs-atelier-heath-light .hljs-quote{color:#776977}.hljs-atelier-heath-light .hljs-variable,.hljs-atelier-heath-light .hljs-template-variable,.hljs-atelier-heath-light .hljs-attribute,.hljs-atelier-heath-light .hljs-tag,.hljs-atelier-heath-light .hljs-name,.hljs-atelier-heath-light .hljs-regexp,.hljs-atelier-heath-light .hljs-link,.hljs-atelier-heath-light .hljs-name,.hljs-atelier-heath-light .hljs-selector-id,.hljs-atelier-heath-light .hljs-selector-class{color:#ca402b}.hljs-atelier-heath-light .hljs-number,.hljs-atelier-heath-light .hljs-meta,.hljs-atelier-heath-light .hljs-built_in,.hljs-atelier-heath-light .hljs-builtin-name,.hljs-atelier-heath-light .hljs-literal,.hljs-atelier-heath-light .hljs-type,.hljs-atelier-heath-light .hljs-params{color:#a65926}.hljs-atelier-heath-light .hljs-string,.hljs-atelier-heath-light .hljs-symbol,.hljs-atelier-heath-light .hljs-bullet{color:#918b3b}.hljs-atelier-heath-light .hljs-title,.hljs-atelier-heath-light .hljs-section{color:#516aec}.hljs-atelier-heath-light .hljs-keyword,.hljs-atelier-heath-light .hljs-selector-tag{color:#7b59c0}.hljs-atelier-heath-light .hljs{display:block;overflow-x:auto;background:#f7f3f7;color:#695d69;padding:.5em}.hljs-atelier-heath-light .hljs-emphasis{font-style:italic}.hljs-atelier-heath-light .hljs-strong{font-weight:bold}.hljs-atelier-lakeside-dark .hljs-comment,.hljs-atelier-lakeside-dark .hljs-quote{color:#7195a8}.hljs-atelier-lakeside-dark .hljs-variable,.hljs-atelier-lakeside-dark .hljs-template-variable,.hljs-atelier-lakeside-dark .hljs-attribute,.hljs-atelier-lakeside-dark .hljs-tag,.hljs-atelier-lakeside-dark .hljs-name,.hljs-atelier-lakeside-dark .hljs-regexp,.hljs-atelier-lakeside-dark .hljs-link,.hljs-atelier-lakeside-dark .hljs-name,.hljs-atelier-lakeside-dark .hljs-selector-id,.hljs-atelier-lakeside-dark .hljs-selector-class{color:#d22d72}.hljs-atelier-lakeside-dark .hljs-number,.hljs-atelier-lakeside-dark .hljs-meta,.hljs-atelier-lakeside-dark .hljs-built_in,.hljs-atelier-lakeside-dark .hljs-builtin-name,.hljs-atelier-lakeside-dark .hljs-literal,.hljs-atelier-lakeside-dark .hljs-type,.hljs-atelier-lakeside-dark .hljs-params{color:#935c25}.hljs-atelier-lakeside-dark .hljs-string,.hljs-atelier-lakeside-dark .hljs-symbol,.hljs-atelier-lakeside-dark .hljs-bullet{color:#568c3b}.hljs-atelier-lakeside-dark .hljs-title,.hljs-atelier-lakeside-dark .hljs-section{color:#257fad}.hljs-atelier-lakeside-dark .hljs-keyword,.hljs-atelier-lakeside-dark .hljs-selector-tag{color:#6b6bb8}.hljs-atelier-lakeside-dark .hljs{display:block;overflow-x:auto;background:#161b1d;color:#7ea2b4;padding:.5em}.hljs-atelier-lakeside-dark .hljs-emphasis{font-style:italic}.hljs-atelier-lakeside-dark .hljs-strong{font-weight:bold}.hljs-atelier-lakeside-light .hljs-comment,.hljs-atelier-lakeside-light .hljs-quote{color:#5a7b8c}.hljs-atelier-lakeside-light .hljs-variable,.hljs-atelier-lakeside-light .hljs-template-variable,.hljs-atelier-lakeside-light .hljs-attribute,.hljs-atelier-lakeside-light .hljs-tag,.hljs-atelier-lakeside-light .hljs-name,.hljs-atelier-lakeside-light .hljs-regexp,.hljs-atelier-lakeside-light .hljs-link,.hljs-atelier-lakeside-light .hljs-name,.hljs-atelier-lakeside-light .hljs-selector-id,.hljs-atelier-lakeside-light .hljs-selector-class{color:#d22d72}.hljs-atelier-lakeside-light .hljs-number,.hljs-atelier-lakeside-light .hljs-meta,.hljs-atelier-lakeside-light .hljs-built_in,.hljs-atelier-lakeside-light .hljs-builtin-name,.hljs-atelier-lakeside-light .hljs-literal,.hljs-atelier-lakeside-light .hljs-type,.hljs-atelier-lakeside-light .hljs-params{color:#935c25}.hljs-atelier-lakeside-light .hljs-string,.hljs-atelier-lakeside-light .hljs-symbol,.hljs-atelier-lakeside-light .hljs-bullet{color:#568c3b}.hljs-atelier-lakeside-light .hljs-title,.hljs-atelier-lakeside-light .hljs-section{color:#257fad}.hljs-atelier-lakeside-light .hljs-keyword,.hljs-atelier-lakeside-light .hljs-selector-tag{color:#6b6bb8}.hljs-atelier-lakeside-light .hljs{display:block;overflow-x:auto;background:#ebf8ff;color:#516d7b;padding:.5em}.hljs-atelier-lakeside-light .hljs-emphasis{font-style:italic}.hljs-atelier-lakeside-light .hljs-strong{font-weight:bold}.hljs-atelier-plateau-dark .hljs-comment,.hljs-atelier-plateau-dark .hljs-quote{color:#7e7777}.hljs-atelier-plateau-dark .hljs-variable,.hljs-atelier-plateau-dark .hljs-template-variable,.hljs-atelier-plateau-dark .hljs-attribute,.hljs-atelier-plateau-dark .hljs-tag,.hljs-atelier-plateau-dark .hljs-name,.hljs-atelier-plateau-dark .hljs-regexp,.hljs-atelier-plateau-dark .hljs-link,.hljs-atelier-plateau-dark .hljs-name,.hljs-atelier-plateau-dark .hljs-selector-id,.hljs-atelier-plateau-dark .hljs-selector-class{color:#ca4949}.hljs-atelier-plateau-dark .hljs-number,.hljs-atelier-plateau-dark .hljs-meta,.hljs-atelier-plateau-dark .hljs-built_in,.hljs-atelier-plateau-dark .hljs-builtin-name,.hljs-atelier-plateau-dark .hljs-literal,.hljs-atelier-plateau-dark .hljs-type,.hljs-atelier-plateau-dark .hljs-params{color:#b45a3c}.hljs-atelier-plateau-dark .hljs-string,.hljs-atelier-plateau-dark .hljs-symbol,.hljs-atelier-plateau-dark .hljs-bullet{color:#4b8b8b}.hljs-atelier-plateau-dark .hljs-title,.hljs-atelier-plateau-dark .hljs-section{color:#7272ca}.hljs-atelier-plateau-dark .hljs-keyword,.hljs-atelier-plateau-dark .hljs-selector-tag{color:#8464c4}.hljs-atelier-plateau-dark .hljs-deletion,.hljs-atelier-plateau-dark .hljs-addition{color:#1b1818;display:inline-block;width:100%}.hljs-atelier-plateau-dark .hljs-deletion{background-color:#ca4949}.hljs-atelier-plateau-dark .hljs-addition{background-color:#4b8b8b}.hljs-atelier-plateau-dark .hljs{display:block;overflow-x:auto;background:#1b1818;color:#8a8585;padding:.5em}.hljs-atelier-plateau-dark .hljs-emphasis{font-style:italic}.hljs-atelier-plateau-dark .hljs-strong{font-weight:bold}.hljs-atelier-plateau-light .hljs-comment,.hljs-atelier-plateau-light .hljs-quote{color:#655d5d}.hljs-atelier-plateau-light .hljs-variable,.hljs-atelier-plateau-light .hljs-template-variable,.hljs-atelier-plateau-light .hljs-attribute,.hljs-atelier-plateau-light .hljs-tag,.hljs-atelier-plateau-light .hljs-name,.hljs-atelier-plateau-light .hljs-regexp,.hljs-atelier-plateau-light .hljs-link,.hljs-atelier-plateau-light .hljs-name,.hljs-atelier-plateau-light .hljs-selector-id,.hljs-atelier-plateau-light .hljs-selector-class{color:#ca4949}.hljs-atelier-plateau-light .hljs-number,.hljs-atelier-plateau-light .hljs-meta,.hljs-atelier-plateau-light .hljs-built_in,.hljs-atelier-plateau-light .hljs-builtin-name,.hljs-atelier-plateau-light .hljs-literal,.hljs-atelier-plateau-light .hljs-type,.hljs-atelier-plateau-light .hljs-params{color:#b45a3c}.hljs-atelier-plateau-light .hljs-string,.hljs-atelier-plateau-light .hljs-symbol,.hljs-atelier-plateau-light .hljs-bullet{color:#4b8b8b}.hljs-atelier-plateau-light .hljs-title,.hljs-atelier-plateau-light .hljs-section{color:#7272ca}.hljs-atelier-plateau-light .hljs-keyword,.hljs-atelier-plateau-light .hljs-selector-tag{color:#8464c4}.hljs-atelier-plateau-light .hljs-deletion,.hljs-atelier-plateau-light .hljs-addition{color:#1b1818;display:inline-block;width:100%}.hljs-atelier-plateau-light .hljs-deletion{background-color:#ca4949}.hljs-atelier-plateau-light .hljs-addition{background-color:#4b8b8b}.hljs-atelier-plateau-light .hljs{display:block;overflow-x:auto;background:#f4ecec;color:#585050;padding:.5em}.hljs-atelier-plateau-light .hljs-emphasis{font-style:italic}.hljs-atelier-plateau-light .hljs-strong{font-weight:bold}.hljs-atelier-savanna-dark .hljs-comment,.hljs-atelier-savanna-dark .hljs-quote{color:#78877d}.hljs-atelier-savanna-dark .hljs-variable,.hljs-atelier-savanna-dark .hljs-template-variable,.hljs-atelier-savanna-dark .hljs-attribute,.hljs-atelier-savanna-dark .hljs-tag,.hljs-atelier-savanna-dark .hljs-name,.hljs-atelier-savanna-dark .hljs-regexp,.hljs-atelier-savanna-dark .hljs-link,.hljs-atelier-savanna-dark .hljs-name,.hljs-atelier-savanna-dark .hljs-selector-id,.hljs-atelier-savanna-dark .hljs-selector-class{color:#b16139}.hljs-atelier-savanna-dark .hljs-number,.hljs-atelier-savanna-dark .hljs-meta,.hljs-atelier-savanna-dark .hljs-built_in,.hljs-atelier-savanna-dark .hljs-builtin-name,.hljs-atelier-savanna-dark .hljs-literal,.hljs-atelier-savanna-dark .hljs-type,.hljs-atelier-savanna-dark .hljs-params{color:#9f713c}.hljs-atelier-savanna-dark .hljs-string,.hljs-atelier-savanna-dark .hljs-symbol,.hljs-atelier-savanna-dark .hljs-bullet{color:#489963}.hljs-atelier-savanna-dark .hljs-title,.hljs-atelier-savanna-dark .hljs-section{color:#478c90}.hljs-atelier-savanna-dark .hljs-keyword,.hljs-atelier-savanna-dark .hljs-selector-tag{color:#55859b}.hljs-atelier-savanna-dark .hljs-deletion,.hljs-atelier-savanna-dark .hljs-addition{color:#171c19;display:inline-block;width:100%}.hljs-atelier-savanna-dark .hljs-deletion{background-color:#b16139}.hljs-atelier-savanna-dark .hljs-addition{background-color:#489963}.hljs-atelier-savanna-dark .hljs{display:block;overflow-x:auto;background:#171c19;color:#87928a;padding:.5em}.hljs-atelier-savanna-dark .hljs-emphasis{font-style:italic}.hljs-atelier-savanna-dark .hljs-strong{font-weight:bold}.hljs-atelier-savanna-light .hljs-comment,.hljs-atelier-savanna-light .hljs-quote{color:#5f6d64}.hljs-atelier-savanna-light .hljs-variable,.hljs-atelier-savanna-light .hljs-template-variable,.hljs-atelier-savanna-light .hljs-attribute,.hljs-atelier-savanna-light .hljs-tag,.hljs-atelier-savanna-light .hljs-name,.hljs-atelier-savanna-light .hljs-regexp,.hljs-atelier-savanna-light .hljs-link,.hljs-atelier-savanna-light .hljs-name,.hljs-atelier-savanna-light .hljs-selector-id,.hljs-atelier-savanna-light .hljs-selector-class{color:#b16139}.hljs-atelier-savanna-light .hljs-number,.hljs-atelier-savanna-light .hljs-meta,.hljs-atelier-savanna-light .hljs-built_in,.hljs-atelier-savanna-light .hljs-builtin-name,.hljs-atelier-savanna-light .hljs-literal,.hljs-atelier-savanna-light .hljs-type,.hljs-atelier-savanna-light .hljs-params{color:#9f713c}.hljs-atelier-savanna-light .hljs-string,.hljs-atelier-savanna-light .hljs-symbol,.hljs-atelier-savanna-light .hljs-bullet{color:#489963}.hljs-atelier-savanna-light .hljs-title,.hljs-atelier-savanna-light .hljs-section{color:#478c90}.hljs-atelier-savanna-light .hljs-keyword,.hljs-atelier-savanna-light .hljs-selector-tag{color:#55859b}.hljs-atelier-savanna-light .hljs-deletion,.hljs-atelier-savanna-light .hljs-addition{color:#171c19;display:inline-block;width:100%}.hljs-atelier-savanna-light .hljs-deletion{background-color:#b16139}.hljs-atelier-savanna-light .hljs-addition{background-color:#489963}.hljs-atelier-savanna-light .hljs{display:block;overflow-x:auto;background:#ecf4ee;color:#526057;padding:.5em}.hljs-atelier-savanna-light .hljs-emphasis{font-style:italic}.hljs-atelier-savanna-light .hljs-strong{font-weight:bold}.hljs-atelier-seaside-dark .hljs-comment,.hljs-atelier-seaside-dark .hljs-quote{color:#809980}.hljs-atelier-seaside-dark .hljs-variable,.hljs-atelier-seaside-dark .hljs-template-variable,.hljs-atelier-seaside-dark .hljs-attribute,.hljs-atelier-seaside-dark .hljs-tag,.hljs-atelier-seaside-dark .hljs-name,.hljs-atelier-seaside-dark .hljs-regexp,.hljs-atelier-seaside-dark .hljs-link,.hljs-atelier-seaside-dark .hljs-name,.hljs-atelier-seaside-dark .hljs-selector-id,.hljs-atelier-seaside-dark .hljs-selector-class{color:#e6193c}.hljs-atelier-seaside-dark .hljs-number,.hljs-atelier-seaside-dark .hljs-meta,.hljs-atelier-seaside-dark .hljs-built_in,.hljs-atelier-seaside-dark .hljs-builtin-name,.hljs-atelier-seaside-dark .hljs-literal,.hljs-atelier-seaside-dark .hljs-type,.hljs-atelier-seaside-dark .hljs-params{color:#87711d}.hljs-atelier-seaside-dark .hljs-string,.hljs-atelier-seaside-dark .hljs-symbol,.hljs-atelier-seaside-dark .hljs-bullet{color:#29a329}.hljs-atelier-seaside-dark .hljs-title,.hljs-atelier-seaside-dark .hljs-section{color:#3d62f5}.hljs-atelier-seaside-dark .hljs-keyword,.hljs-atelier-seaside-dark .hljs-selector-tag{color:#ad2bee}.hljs-atelier-seaside-dark .hljs{display:block;overflow-x:auto;background:#131513;color:#8ca68c;padding:.5em}.hljs-atelier-seaside-dark .hljs-emphasis{font-style:italic}.hljs-atelier-seaside-dark .hljs-strong{font-weight:bold}.hljs-atelier-seaside-light .hljs-comment,.hljs-atelier-seaside-light .hljs-quote{color:#687d68}.hljs-atelier-seaside-light .hljs-variable,.hljs-atelier-seaside-light .hljs-template-variable,.hljs-atelier-seaside-light .hljs-attribute,.hljs-atelier-seaside-light .hljs-tag,.hljs-atelier-seaside-light .hljs-name,.hljs-atelier-seaside-light .hljs-regexp,.hljs-atelier-seaside-light .hljs-link,.hljs-atelier-seaside-light .hljs-name,.hljs-atelier-seaside-light .hljs-selector-id,.hljs-atelier-seaside-light .hljs-selector-class{color:#e6193c}.hljs-atelier-seaside-light .hljs-number,.hljs-atelier-seaside-light .hljs-meta,.hljs-atelier-seaside-light .hljs-built_in,.hljs-atelier-seaside-light .hljs-builtin-name,.hljs-atelier-seaside-light .hljs-literal,.hljs-atelier-seaside-light .hljs-type,.hljs-atelier-seaside-light .hljs-params{color:#87711d}.hljs-atelier-seaside-light .hljs-string,.hljs-atelier-seaside-light .hljs-symbol,.hljs-atelier-seaside-light .hljs-bullet{color:#29a329}.hljs-atelier-seaside-light .hljs-title,.hljs-atelier-seaside-light .hljs-section{color:#3d62f5}.hljs-atelier-seaside-light .hljs-keyword,.hljs-atelier-seaside-light .hljs-selector-tag{color:#ad2bee}.hljs-atelier-seaside-light .hljs{display:block;overflow-x:auto;background:#f4fbf4;color:#5e6e5e;padding:.5em}.hljs-atelier-seaside-light .hljs-emphasis{font-style:italic}.hljs-atelier-seaside-light .hljs-strong{font-weight:bold}.hljs-atelier-sulphurpool-dark .hljs-comment,.hljs-atelier-sulphurpool-dark .hljs-quote{color:#898ea4}.hljs-atelier-sulphurpool-dark .hljs-variable,.hljs-atelier-sulphurpool-dark .hljs-template-variable,.hljs-atelier-sulphurpool-dark .hljs-attribute,.hljs-atelier-sulphurpool-dark .hljs-tag,.hljs-atelier-sulphurpool-dark .hljs-name,.hljs-atelier-sulphurpool-dark .hljs-regexp,.hljs-atelier-sulphurpool-dark .hljs-link,.hljs-atelier-sulphurpool-dark .hljs-name,.hljs-atelier-sulphurpool-dark .hljs-selector-id,.hljs-atelier-sulphurpool-dark .hljs-selector-class{color:#c94922}.hljs-atelier-sulphurpool-dark .hljs-number,.hljs-atelier-sulphurpool-dark .hljs-meta,.hljs-atelier-sulphurpool-dark .hljs-built_in,.hljs-atelier-sulphurpool-dark .hljs-builtin-name,.hljs-atelier-sulphurpool-dark .hljs-literal,.hljs-atelier-sulphurpool-dark .hljs-type,.hljs-atelier-sulphurpool-dark .hljs-params{color:#c76b29}.hljs-atelier-sulphurpool-dark .hljs-string,.hljs-atelier-sulphurpool-dark .hljs-symbol,.hljs-atelier-sulphurpool-dark .hljs-bullet{color:#ac9739}.hljs-atelier-sulphurpool-dark .hljs-title,.hljs-atelier-sulphurpool-dark .hljs-section{color:#3d8fd1}.hljs-atelier-sulphurpool-dark .hljs-keyword,.hljs-atelier-sulphurpool-dark .hljs-selector-tag{color:#6679cc}.hljs-atelier-sulphurpool-dark .hljs{display:block;overflow-x:auto;background:#202746;color:#979db4;padding:.5em}.hljs-atelier-sulphurpool-dark .hljs-emphasis{font-style:italic}.hljs-atelier-sulphurpool-dark .hljs-strong{font-weight:bold}.hljs-atelier-sulphurpool-light .hljs-comment,.hljs-atelier-sulphurpool-light .hljs-quote{color:#6b7394}.hljs-atelier-sulphurpool-light .hljs-variable,.hljs-atelier-sulphurpool-light .hljs-template-variable,.hljs-atelier-sulphurpool-light .hljs-attribute,.hljs-atelier-sulphurpool-light .hljs-tag,.hljs-atelier-sulphurpool-light .hljs-name,.hljs-atelier-sulphurpool-light .hljs-regexp,.hljs-atelier-sulphurpool-light .hljs-link,.hljs-atelier-sulphurpool-light .hljs-name,.hljs-atelier-sulphurpool-light .hljs-selector-id,.hljs-atelier-sulphurpool-light .hljs-selector-class{color:#c94922}.hljs-atelier-sulphurpool-light .hljs-number,.hljs-atelier-sulphurpool-light .hljs-meta,.hljs-atelier-sulphurpool-light .hljs-built_in,.hljs-atelier-sulphurpool-light .hljs-builtin-name,.hljs-atelier-sulphurpool-light .hljs-literal,.hljs-atelier-sulphurpool-light .hljs-type,.hljs-atelier-sulphurpool-light .hljs-params{color:#c76b29}.hljs-atelier-sulphurpool-light .hljs-string,.hljs-atelier-sulphurpool-light .hljs-symbol,.hljs-atelier-sulphurpool-light .hljs-bullet{color:#ac9739}.hljs-atelier-sulphurpool-light .hljs-title,.hljs-atelier-sulphurpool-light .hljs-section{color:#3d8fd1}.hljs-atelier-sulphurpool-light .hljs-keyword,.hljs-atelier-sulphurpool-light .hljs-selector-tag{color:#6679cc}.hljs-atelier-sulphurpool-light .hljs{display:block;overflow-x:auto;background:#f5f7ff;color:#5e6687;padding:.5em}.hljs-atelier-sulphurpool-light .hljs-emphasis{font-style:italic}.hljs-atelier-sulphurpool-light .hljs-strong{font-weight:bold}.hljs-atom-one-dark .hljs{display:block;overflow-x:auto;padding:.5em;color:#abb2bf;background:#282c34}.hljs-atom-one-dark .hljs-comment,.hljs-atom-one-dark .hljs-quote{color:#5c6370;font-style:italic}.hljs-atom-one-dark .hljs-doctag,.hljs-atom-one-dark .hljs-keyword,.hljs-atom-one-dark .hljs-formula{color:#c678dd}.hljs-atom-one-dark .hljs-section,.hljs-atom-one-dark .hljs-name,.hljs-atom-one-dark .hljs-selector-tag,.hljs-atom-one-dark .hljs-deletion,.hljs-atom-one-dark .hljs-subst{color:#e06c75}.hljs-atom-one-dark .hljs-literal{color:#56b6c2}.hljs-atom-one-dark .hljs-string,.hljs-atom-one-dark .hljs-regexp,.hljs-atom-one-dark .hljs-addition,.hljs-atom-one-dark .hljs-attribute,.hljs-atom-one-dark .hljs-meta-string{color:#98c379}.hljs-atom-one-dark .hljs-built_in,.hljs-atom-one-dark .hljs-class .hljs-title{color:#e6c07b}.hljs-atom-one-dark .hljs-variable,.hljs-atom-one-dark .hljs-template-variable,.hljs-atom-one-dark .hljs-type,.hljs-atom-one-dark .hljs-selector-class,.hljs-atom-one-dark .hljs-selector-attr,.hljs-atom-one-dark .hljs-selector-pseudo,.hljs-atom-one-dark .hljs-number{color:#d19a66}.hljs-atom-one-dark .hljs-symbol,.hljs-atom-one-dark .hljs-bullet,.hljs-atom-one-dark .hljs-link,.hljs-atom-one-dark .hljs-meta,.hljs-atom-one-dark .hljs-selector-id,.hljs-atom-one-dark .hljs-title{color:#61aeee}.hljs-atom-one-dark .hljs-emphasis{font-style:italic}.hljs-atom-one-dark .hljs-strong{font-weight:bold}.hljs-atom-one-dark .hljs-link{text-decoration:underline}.hljs-atom-one-light .hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-atom-one-light .hljs-comment,.hljs-atom-one-light .hljs-quote{color:#a0a1a7;font-style:italic}.hljs-atom-one-light .hljs-doctag,.hljs-atom-one-light .hljs-keyword,.hljs-atom-one-light .hljs-formula{color:#a626a4}.hljs-atom-one-light .hljs-section,.hljs-atom-one-light .hljs-name,.hljs-atom-one-light .hljs-selector-tag,.hljs-atom-one-light .hljs-deletion,.hljs-atom-one-light .hljs-subst{color:#e45649}.hljs-atom-one-light .hljs-literal{color:#0184bb}.hljs-atom-one-light .hljs-string,.hljs-atom-one-light .hljs-regexp,.hljs-atom-one-light .hljs-addition,.hljs-atom-one-light .hljs-attribute,.hljs-atom-one-light .hljs-meta-string{color:#50a14f}.hljs-atom-one-light .hljs-built_in,.hljs-atom-one-light .hljs-class .hljs-title{color:#c18401}.hljs-atom-one-light .hljs-variable,.hljs-atom-one-light .hljs-template-variable,.hljs-atom-one-light .hljs-type,.hljs-atom-one-light .hljs-selector-class,.hljs-atom-one-light .hljs-selector-attr,.hljs-atom-one-light .hljs-selector-pseudo,.hljs-atom-one-light .hljs-number{color:#986801}.hljs-atom-one-light .hljs-symbol,.hljs-atom-one-light .hljs-bullet,.hljs-atom-one-light .hljs-link,.hljs-atom-one-light .hljs-meta,.hljs-atom-one-light .hljs-selector-id,.hljs-atom-one-light .hljs-title{color:#4078f2}.hljs-atom-one-light .hljs-emphasis{font-style:italic}.hljs-atom-one-light .hljs-strong{font-weight:bold}.hljs-atom-one-light .hljs-link{text-decoration:underline}.hljs-brown-paper .hljs{display:block;overflow-x:auto;padding:.5em;background:#b7a68e url(brown-papersq.png)}.hljs-brown-paper .hljs-keyword,.hljs-brown-paper .hljs-selector-tag,.hljs-brown-paper .hljs-literal{color:#005599;font-weight:bold}.hljs-brown-paper .hljs,.hljs-brown-paper .hljs-subst{color:#363c69}.hljs-brown-paper .hljs-string,.hljs-brown-paper .hljs-title,.hljs-brown-paper .hljs-section,.hljs-brown-paper .hljs-type,.hljs-brown-paper .hljs-attribute,.hljs-brown-paper .hljs-symbol,.hljs-brown-paper .hljs-bullet,.hljs-brown-paper .hljs-built_in,.hljs-brown-paper .hljs-addition,.hljs-brown-paper .hljs-variable,.hljs-brown-paper .hljs-template-tag,.hljs-brown-paper .hljs-template-variable,.hljs-brown-paper .hljs-link,.hljs-brown-paper .hljs-name{color:#2c009f}.hljs-brown-paper .hljs-comment,.hljs-brown-paper .hljs-quote,.hljs-brown-paper .hljs-meta,.hljs-brown-paper .hljs-deletion{color:#802022}.hljs-brown-paper .hljs-keyword,.hljs-brown-paper .hljs-selector-tag,.hljs-brown-paper .hljs-literal,.hljs-brown-paper .hljs-doctag,.hljs-brown-paper .hljs-title,.hljs-brown-paper .hljs-section,.hljs-brown-paper .hljs-type,.hljs-brown-paper .hljs-name,.hljs-brown-paper .hljs-strong{font-weight:bold}.hljs-brown-paper .hljs-emphasis{font-style:italic}.hljs-codepen-embed .hljs{display:block;overflow-x:auto;padding:.5em;background:#222;color:#fff}.hljs-codepen-embed .hljs-comment,.hljs-codepen-embed .hljs-quote{color:#777}.hljs-codepen-embed .hljs-variable,.hljs-codepen-embed .hljs-template-variable,.hljs-codepen-embed .hljs-tag,.hljs-codepen-embed .hljs-regexp,.hljs-codepen-embed .hljs-meta,.hljs-codepen-embed .hljs-number,.hljs-codepen-embed .hljs-built_in,.hljs-codepen-embed .hljs-builtin-name,.hljs-codepen-embed .hljs-literal,.hljs-codepen-embed .hljs-params,.hljs-codepen-embed .hljs-symbol,.hljs-codepen-embed .hljs-bullet,.hljs-codepen-embed .hljs-link,.hljs-codepen-embed .hljs-deletion{color:#ab875d}.hljs-codepen-embed .hljs-section,.hljs-codepen-embed .hljs-title,.hljs-codepen-embed .hljs-name,.hljs-codepen-embed .hljs-selector-id,.hljs-codepen-embed .hljs-selector-class,.hljs-codepen-embed .hljs-type,.hljs-codepen-embed .hljs-attribute{color:#9b869b}.hljs-codepen-embed .hljs-string,.hljs-codepen-embed .hljs-keyword,.hljs-codepen-embed .hljs-selector-tag,.hljs-codepen-embed .hljs-addition{color:#8f9c6c}.hljs-codepen-embed .hljs-emphasis{font-style:italic}.hljs-codepen-embed .hljs-strong{font-weight:bold}.hljs-color-brewer .hljs{display:block;overflow-x:auto;padding:.5em;background:#fff}.hljs-color-brewer .hljs,.hljs-color-brewer .hljs-subst{color:#000}.hljs-color-brewer .hljs-string,.hljs-color-brewer .hljs-meta,.hljs-color-brewer .hljs-symbol,.hljs-color-brewer .hljs-template-tag,.hljs-color-brewer .hljs-template-variable,.hljs-color-brewer .hljs-addition{color:#756bb1}.hljs-color-brewer .hljs-comment,.hljs-color-brewer .hljs-quote{color:#636363}.hljs-color-brewer .hljs-number,.hljs-color-brewer .hljs-regexp,.hljs-color-brewer .hljs-literal,.hljs-color-brewer .hljs-bullet,.hljs-color-brewer .hljs-link{color:#31a354}.hljs-color-brewer .hljs-deletion,.hljs-color-brewer .hljs-variable{color:#88f}.hljs-color-brewer .hljs-keyword,.hljs-color-brewer .hljs-selector-tag,.hljs-color-brewer .hljs-title,.hljs-color-brewer .hljs-section,.hljs-color-brewer .hljs-built_in,.hljs-color-brewer .hljs-doctag,.hljs-color-brewer .hljs-type,.hljs-color-brewer .hljs-tag,.hljs-color-brewer .hljs-name,.hljs-color-brewer .hljs-selector-id,.hljs-color-brewer .hljs-selector-class,.hljs-color-brewer .hljs-strong{color:#3182bd}.hljs-color-brewer .hljs-emphasis{font-style:italic}.hljs-color-brewer .hljs-attribute{color:#e6550d}.hljs-darcula .hljs{display:block;overflow-x:auto;padding:.5em;background:#2b2b2b}.hljs-darcula .hljs{color:#bababa}.hljs-darcula .hljs-strong,.hljs-darcula .hljs-emphasis{color:#a8a8a2}.hljs-darcula .hljs-bullet,.hljs-darcula .hljs-quote,.hljs-darcula .hljs-link,.hljs-darcula .hljs-number,.hljs-darcula .hljs-regexp,.hljs-darcula .hljs-literal{color:#6896ba}.hljs-darcula .hljs-code,.hljs-darcula .hljs-selector-class{color:#a6e22e}.hljs-darcula .hljs-emphasis{font-style:italic}.hljs-darcula .hljs-keyword,.hljs-darcula .hljs-selector-tag,.hljs-darcula .hljs-section,.hljs-darcula .hljs-attribute,.hljs-darcula .hljs-name,.hljs-darcula .hljs-variable{color:#cb7832}.hljs-darcula .hljs-params{color:#b9b9b9}.hljs-darcula .hljs-string{color:#6a8759}.hljs-darcula .hljs-subst,.hljs-darcula .hljs-type,.hljs-darcula .hljs-built_in,.hljs-darcula .hljs-builtin-name,.hljs-darcula .hljs-symbol,.hljs-darcula .hljs-selector-id,.hljs-darcula .hljs-selector-attr,.hljs-darcula .hljs-selector-pseudo,.hljs-darcula .hljs-template-tag,.hljs-darcula .hljs-template-variable,.hljs-darcula .hljs-addition{color:#e0c46c}.hljs-darcula .hljs-comment,.hljs-darcula .hljs-deletion,.hljs-darcula .hljs-meta{color:#7f7f7f}.hljs-dark .hljs{display:block;overflow-x:auto;padding:.5em;background:#444}.hljs-dark .hljs-keyword,.hljs-dark .hljs-selector-tag,.hljs-dark .hljs-literal,.hljs-dark .hljs-section,.hljs-dark .hljs-link{color:white}.hljs-dark .hljs,.hljs-dark .hljs-subst{color:#ddd}.hljs-dark .hljs-string,.hljs-dark .hljs-title,.hljs-dark .hljs-name,.hljs-dark .hljs-type,.hljs-dark .hljs-attribute,.hljs-dark .hljs-symbol,.hljs-dark .hljs-bullet,.hljs-dark .hljs-built_in,.hljs-dark .hljs-addition,.hljs-dark .hljs-variable,.hljs-dark .hljs-template-tag,.hljs-dark .hljs-template-variable{color:#d88}.hljs-dark .hljs-comment,.hljs-dark .hljs-quote,.hljs-dark .hljs-deletion,.hljs-dark .hljs-meta{color:#777}.hljs-dark .hljs-keyword,.hljs-dark .hljs-selector-tag,.hljs-dark .hljs-literal,.hljs-dark .hljs-title,.hljs-dark .hljs-section,.hljs-dark .hljs-doctag,.hljs-dark .hljs-type,.hljs-dark .hljs-name,.hljs-dark .hljs-strong{font-weight:bold}.hljs-dark .hljs-emphasis{font-style:italic}.hljs-darkula{@import url('darcula.css');}.hljs-default .hljs{display:block;overflow-x:auto;padding:.5em;background:#F0F0F0}.hljs-default .hljs,.hljs-default .hljs-subst{color:#444}.hljs-default .hljs-comment{color:#888888}.hljs-default .hljs-keyword,.hljs-default .hljs-attribute,.hljs-default .hljs-selector-tag,.hljs-default .hljs-meta-keyword,.hljs-default .hljs-doctag,.hljs-default .hljs-name{font-weight:bold}.hljs-default .hljs-type,.hljs-default .hljs-string,.hljs-default .hljs-number,.hljs-default .hljs-selector-id,.hljs-default .hljs-selector-class,.hljs-default .hljs-quote,.hljs-default .hljs-template-tag,.hljs-default .hljs-deletion{color:#880000}.hljs-default .hljs-title,.hljs-default .hljs-section{color:#880000;font-weight:bold}.hljs-default .hljs-regexp,.hljs-default .hljs-symbol,.hljs-default .hljs-variable,.hljs-default .hljs-template-variable,.hljs-default .hljs-link,.hljs-default .hljs-selector-attr,.hljs-default .hljs-selector-pseudo{color:#BC6060}.hljs-default .hljs-literal{color:#78A960}.hljs-default .hljs-built_in,.hljs-default .hljs-bullet,.hljs-default .hljs-code,.hljs-default .hljs-addition{color:#397300}.hljs-default .hljs-meta{color:#1f7199}.hljs-default .hljs-meta-string{color:#4d99bf}.hljs-default .hljs-emphasis{font-style:italic}.hljs-default .hljs-strong{font-weight:bold}.hljs-docco .hljs{display:block;overflow-x:auto;padding:.5em;color:#000;background:#f8f8ff}.hljs-docco .hljs-comment,.hljs-docco .hljs-quote{color:#408080;font-style:italic}.hljs-docco .hljs-keyword,.hljs-docco .hljs-selector-tag,.hljs-docco .hljs-literal,.hljs-docco .hljs-subst{color:#954121}.hljs-docco .hljs-number{color:#40a070}.hljs-docco .hljs-string,.hljs-docco .hljs-doctag{color:#219161}.hljs-docco .hljs-selector-id,.hljs-docco .hljs-selector-class,.hljs-docco .hljs-section,.hljs-docco .hljs-type{color:#19469d}.hljs-docco .hljs-params{color:#00f}.hljs-docco .hljs-title{color:#458;font-weight:bold}.hljs-docco .hljs-tag,.hljs-docco .hljs-name,.hljs-docco .hljs-attribute{color:#000080;font-weight:normal}.hljs-docco .hljs-variable,.hljs-docco .hljs-template-variable{color:#008080}.hljs-docco .hljs-regexp,.hljs-docco .hljs-link{color:#b68}.hljs-docco .hljs-symbol,.hljs-docco .hljs-bullet{color:#990073}.hljs-docco .hljs-built_in,.hljs-docco .hljs-builtin-name{color:#0086b3}.hljs-docco .hljs-meta{color:#999;font-weight:bold}.hljs-docco .hljs-deletion{background:#fdd}.hljs-docco .hljs-addition{background:#dfd}.hljs-docco .hljs-emphasis{font-style:italic}.hljs-docco .hljs-strong{font-weight:bold}.hljs-dracula .hljs{display:block;overflow-x:auto;padding:.5em;background:#282a36}.hljs-dracula .hljs-keyword,.hljs-dracula .hljs-selector-tag,.hljs-dracula .hljs-literal,.hljs-dracula .hljs-section,.hljs-dracula .hljs-link{color:#8be9fd}.hljs-dracula .hljs-function .hljs-keyword{color:#ff79c6}.hljs-dracula .hljs,.hljs-dracula .hljs-subst{color:#f8f8f2}.hljs-dracula .hljs-string,.hljs-dracula .hljs-title,.hljs-dracula .hljs-name,.hljs-dracula .hljs-type,.hljs-dracula .hljs-attribute,.hljs-dracula .hljs-symbol,.hljs-dracula .hljs-bullet,.hljs-dracula .hljs-addition,.hljs-dracula .hljs-variable,.hljs-dracula .hljs-template-tag,.hljs-dracula .hljs-template-variable{color:#f1fa8c}.hljs-dracula .hljs-comment,.hljs-dracula .hljs-quote,.hljs-dracula .hljs-deletion,.hljs-dracula .hljs-meta{color:#6272a4}.hljs-dracula .hljs-keyword,.hljs-dracula .hljs-selector-tag,.hljs-dracula .hljs-literal,.hljs-dracula .hljs-title,.hljs-dracula .hljs-section,.hljs-dracula .hljs-doctag,.hljs-dracula .hljs-type,.hljs-dracula .hljs-name,.hljs-dracula .hljs-strong{font-weight:bold}.hljs-dracula .hljs-emphasis{font-style:italic}.hljs-far .hljs{display:block;overflow-x:auto;padding:.5em;background:#000080}.hljs-far .hljs,.hljs-far .hljs-subst{color:#0ff}.hljs-far .hljs-string,.hljs-far .hljs-attribute,.hljs-far .hljs-symbol,.hljs-far .hljs-bullet,.hljs-far .hljs-built_in,.hljs-far .hljs-builtin-name,.hljs-far .hljs-template-tag,.hljs-far .hljs-template-variable,.hljs-far .hljs-addition{color:#ff0}.hljs-far .hljs-keyword,.hljs-far .hljs-selector-tag,.hljs-far .hljs-section,.hljs-far .hljs-type,.hljs-far .hljs-name,.hljs-far .hljs-selector-id,.hljs-far .hljs-selector-class,.hljs-far .hljs-variable{color:#fff}.hljs-far .hljs-comment,.hljs-far .hljs-quote,.hljs-far .hljs-doctag,.hljs-far .hljs-deletion{color:#888}.hljs-far .hljs-number,.hljs-far .hljs-regexp,.hljs-far .hljs-literal,.hljs-far .hljs-link{color:#0f0}.hljs-far .hljs-meta{color:#008080}.hljs-far .hljs-keyword,.hljs-far .hljs-selector-tag,.hljs-far .hljs-title,.hljs-far .hljs-section,.hljs-far .hljs-name,.hljs-far .hljs-strong{font-weight:bold}.hljs-far .hljs-emphasis{font-style:italic}.hljs-foundation .hljs{display:block;overflow-x:auto;padding:.5em;background:#eee;color:black}.hljs-foundation .hljs-link,.hljs-foundation .hljs-emphasis,.hljs-foundation .hljs-attribute,.hljs-foundation .hljs-addition{color:#070}.hljs-foundation .hljs-emphasis{font-style:italic}.hljs-foundation .hljs-strong,.hljs-foundation .hljs-string,.hljs-foundation .hljs-deletion{color:#d14}.hljs-foundation .hljs-strong{font-weight:bold}.hljs-foundation .hljs-quote,.hljs-foundation .hljs-comment{color:#998;font-style:italic}.hljs-foundation .hljs-section,.hljs-foundation .hljs-title{color:#900}.hljs-foundation .hljs-class .hljs-title,.hljs-foundation .hljs-type{color:#458}.hljs-foundation .hljs-variable,.hljs-foundation .hljs-template-variable{color:#336699}.hljs-foundation .hljs-bullet{color:#997700}.hljs-foundation .hljs-meta{color:#3344bb}.hljs-foundation .hljs-code,.hljs-foundation .hljs-number,.hljs-foundation .hljs-literal,.hljs-foundation .hljs-keyword,.hljs-foundation .hljs-selector-tag{color:#099}.hljs-foundation .hljs-regexp{background-color:#fff0ff;color:#880088}.hljs-foundation .hljs-symbol{color:#990073}.hljs-foundation .hljs-tag,.hljs-foundation .hljs-name,.hljs-foundation .hljs-selector-id,.hljs-foundation .hljs-selector-class{color:#007700}.hljs-github-gist .hljs{display:block;background:white;padding:.5em;color:#333333;overflow-x:auto}.hljs-github-gist .hljs-comment,.hljs-github-gist .hljs-meta{color:#969896}.hljs-github-gist .hljs-string,.hljs-github-gist .hljs-variable,.hljs-github-gist .hljs-template-variable,.hljs-github-gist .hljs-strong,.hljs-github-gist .hljs-emphasis,.hljs-github-gist .hljs-quote{color:#df5000}.hljs-github-gist .hljs-keyword,.hljs-github-gist .hljs-selector-tag,.hljs-github-gist .hljs-type{color:#a71d5d}.hljs-github-gist .hljs-literal,.hljs-github-gist .hljs-symbol,.hljs-github-gist .hljs-bullet,.hljs-github-gist .hljs-attribute{color:#0086b3}.hljs-github-gist .hljs-section,.hljs-github-gist .hljs-name{color:#63a35c}.hljs-github-gist .hljs-tag{color:#333333}.hljs-github-gist .hljs-title,.hljs-github-gist .hljs-attr,.hljs-github-gist .hljs-selector-id,.hljs-github-gist .hljs-selector-class,.hljs-github-gist .hljs-selector-attr,.hljs-github-gist .hljs-selector-pseudo{color:#795da3}.hljs-github-gist .hljs-addition{color:#55a532;background-color:#eaffea}.hljs-github-gist .hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-github-gist .hljs-link{text-decoration:underline}.hljs-github .hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-github .hljs-comment,.hljs-github .hljs-quote{color:#998;font-style:italic}.hljs-github .hljs-keyword,.hljs-github .hljs-selector-tag,.hljs-github .hljs-subst{color:#333;font-weight:bold}.hljs-github .hljs-number,.hljs-github .hljs-literal,.hljs-github .hljs-variable,.hljs-github .hljs-template-variable,.hljs-github .hljs-tag .hljs-attr{color:#008080}.hljs-github .hljs-string,.hljs-github .hljs-doctag{color:#d14}.hljs-github .hljs-title,.hljs-github .hljs-section,.hljs-github .hljs-selector-id{color:#900;font-weight:bold}.hljs-github .hljs-subst{font-weight:normal}.hljs-github .hljs-type,.hljs-github .hljs-class .hljs-title{color:#458;font-weight:bold}.hljs-github .hljs-tag,.hljs-github .hljs-name,.hljs-github .hljs-attribute{color:#000080;font-weight:normal}.hljs-github .hljs-regexp,.hljs-github .hljs-link{color:#009926}.hljs-github .hljs-symbol,.hljs-github .hljs-bullet{color:#990073}.hljs-github .hljs-built_in,.hljs-github .hljs-builtin-name{color:#0086b3}.hljs-github .hljs-meta{color:#999;font-weight:bold}.hljs-github .hljs-deletion{background:#fdd}.hljs-github .hljs-addition{background:#dfd}.hljs-github .hljs-emphasis{font-style:italic}.hljs-github .hljs-strong{font-weight:bold}.hljs-googlecode .hljs{display:block;overflow-x:auto;padding:.5em;background:white;color:black}.hljs-googlecode .hljs-comment,.hljs-googlecode .hljs-quote{color:#800}.hljs-googlecode .hljs-keyword,.hljs-googlecode .hljs-selector-tag,.hljs-googlecode .hljs-section,.hljs-googlecode .hljs-title,.hljs-googlecode .hljs-name{color:#008}.hljs-googlecode .hljs-variable,.hljs-googlecode .hljs-template-variable{color:#660}.hljs-googlecode .hljs-string,.hljs-googlecode .hljs-selector-attr,.hljs-googlecode .hljs-selector-pseudo,.hljs-googlecode .hljs-regexp{color:#080}.hljs-googlecode .hljs-literal,.hljs-googlecode .hljs-symbol,.hljs-googlecode .hljs-bullet,.hljs-googlecode .hljs-meta,.hljs-googlecode .hljs-number,.hljs-googlecode .hljs-link{color:#066}.hljs-googlecode .hljs-title,.hljs-googlecode .hljs-doctag,.hljs-googlecode .hljs-type,.hljs-googlecode .hljs-attr,.hljs-googlecode .hljs-built_in,.hljs-googlecode .hljs-builtin-name,.hljs-googlecode .hljs-params{color:#606}.hljs-googlecode .hljs-attribute,.hljs-googlecode .hljs-subst{color:#000}.hljs-googlecode .hljs-formula{background-color:#eee;font-style:italic}.hljs-googlecode .hljs-selector-id,.hljs-googlecode .hljs-selector-class{color:#9B703F}.hljs-googlecode .hljs-addition{background-color:#baeeba}.hljs-googlecode .hljs-deletion{background-color:#ffc8bd}.hljs-googlecode .hljs-doctag,.hljs-googlecode .hljs-strong{font-weight:bold}.hljs-googlecode .hljs-emphasis{font-style:italic}.hljs-grayscale .hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#fff}.hljs-grayscale .hljs-comment,.hljs-grayscale .hljs-quote{color:#777;font-style:italic}.hljs-grayscale .hljs-keyword,.hljs-grayscale .hljs-selector-tag,.hljs-grayscale .hljs-subst{color:#333;font-weight:bold}.hljs-grayscale .hljs-number,.hljs-grayscale .hljs-literal{color:#777}.hljs-grayscale .hljs-string,.hljs-grayscale .hljs-doctag,.hljs-grayscale .hljs-formula{color:#333;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAJ0lEQVQIW2O8e/fufwYGBgZBQUEQxcCIIfDu3Tuwivfv30NUoAsAALHpFMMLqZlPAAAAAElFTkSuQmCC) repeat}.hljs-grayscale .hljs-title,.hljs-grayscale .hljs-section,.hljs-grayscale .hljs-selector-id{color:#000;font-weight:bold}.hljs-grayscale .hljs-subst{font-weight:normal}.hljs-grayscale .hljs-class .hljs-title,.hljs-grayscale .hljs-type,.hljs-grayscale .hljs-name{color:#333;font-weight:bold}.hljs-grayscale .hljs-tag{color:#333}.hljs-grayscale .hljs-regexp{color:#333;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAICAYAAADA+m62AAAAPUlEQVQYV2NkQAN37979r6yszIgujiIAU4RNMVwhuiQ6H6wQl3XI4oy4FMHcCJPHcDS6J2A2EqUQpJhohQDexSef15DBCwAAAABJRU5ErkJggg==) repeat}.hljs-grayscale .hljs-symbol,.hljs-grayscale .hljs-bullet,.hljs-grayscale .hljs-link{color:#000;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAKElEQVQIW2NkQAO7d+/+z4gsBhJwdXVlhAvCBECKwIIwAbhKZBUwBQA6hBpm5efZsgAAAABJRU5ErkJggg==) repeat}.hljs-grayscale .hljs-built_in,.hljs-grayscale .hljs-builtin-name{color:#000;text-decoration:underline}.hljs-grayscale .hljs-meta{color:#999;font-weight:bold}.hljs-grayscale .hljs-deletion{color:#fff;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAADCAYAAABS3WWCAAAAE0lEQVQIW2MMDQ39zzhz5kwIAQAyxweWgUHd1AAAAABJRU5ErkJggg==) repeat}.hljs-grayscale .hljs-addition{color:#000;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAALUlEQVQYV2N89+7dfwYk8P79ewZBQUFkIQZGOiu6e/cuiptQHAPl0NtNxAQBAM97Oejj3Dg7AAAAAElFTkSuQmCC) repeat}.hljs-grayscale .hljs-emphasis{font-style:italic}.hljs-grayscale .hljs-strong{font-weight:bold}.hljs-gruvbox-dark .hljs{display:block;overflow-x:auto;padding:.5em;background:#282828}.hljs-gruvbox-dark .hljs,.hljs-gruvbox-dark .hljs-subst{color:#ebdbb2}.hljs-gruvbox-dark .hljs-deletion,.hljs-gruvbox-dark .hljs-formula,.hljs-gruvbox-dark .hljs-keyword,.hljs-gruvbox-dark .hljs-link,.hljs-gruvbox-dark .hljs-selector-tag{color:#fb4934}.hljs-gruvbox-dark .hljs-built_in,.hljs-gruvbox-dark .hljs-emphasis,.hljs-gruvbox-dark .hljs-name,.hljs-gruvbox-dark .hljs-quote,.hljs-gruvbox-dark .hljs-strong,.hljs-gruvbox-dark .hljs-title,.hljs-gruvbox-dark .hljs-variable{color:#83a598}.hljs-gruvbox-dark .hljs-attr,.hljs-gruvbox-dark .hljs-params,.hljs-gruvbox-dark .hljs-template-tag,.hljs-gruvbox-dark .hljs-type{color:#fabd2f}.hljs-gruvbox-dark .hljs-builtin-name,.hljs-gruvbox-dark .hljs-doctag,.hljs-gruvbox-dark .hljs-literal,.hljs-gruvbox-dark .hljs-number{color:#8f3f71}.hljs-gruvbox-dark .hljs-code,.hljs-gruvbox-dark .hljs-meta,.hljs-gruvbox-dark .hljs-regexp,.hljs-gruvbox-dark .hljs-selector-id,.hljs-gruvbox-dark .hljs-template-variable{color:#fe8019}.hljs-gruvbox-dark .hljs-addition,.hljs-gruvbox-dark .hljs-meta-string,.hljs-gruvbox-dark .hljs-section,.hljs-gruvbox-dark .hljs-selector-attr,.hljs-gruvbox-dark .hljs-selector-class,.hljs-gruvbox-dark .hljs-string,.hljs-gruvbox-dark .hljs-symbol{color:#b8bb26}.hljs-gruvbox-dark .hljs-attribute,.hljs-gruvbox-dark .hljs-bullet,.hljs-gruvbox-dark .hljs-class,.hljs-gruvbox-dark .hljs-function,.hljs-gruvbox-dark .hljs-function .hljs-keyword,.hljs-gruvbox-dark .hljs-meta-keyword,.hljs-gruvbox-dark .hljs-selector-pseudo,.hljs-gruvbox-dark .hljs-tag{color:#8ec07c}.hljs-gruvbox-dark .hljs-comment{color:#928374}.hljs-gruvbox-dark .hljs-link_label,.hljs-gruvbox-dark .hljs-literal,.hljs-gruvbox-dark .hljs-number{color:#d3869b}.hljs-gruvbox-dark .hljs-comment,.hljs-gruvbox-dark .hljs-emphasis{font-style:italic}.hljs-gruvbox-dark .hljs-section,.hljs-gruvbox-dark .hljs-strong,.hljs-gruvbox-dark .hljs-tag{font-weight:bold}.hljs-gruvbox-light .hljs{display:block;overflow-x:auto;padding:.5em;background:#fbf1c7}.hljs-gruvbox-light .hljs,.hljs-gruvbox-light .hljs-subst{color:#3c3836}.hljs-gruvbox-light .hljs-deletion,.hljs-gruvbox-light .hljs-formula,.hljs-gruvbox-light .hljs-keyword,.hljs-gruvbox-light .hljs-link,.hljs-gruvbox-light .hljs-selector-tag{color:#9d0006}.hljs-gruvbox-light .hljs-built_in,.hljs-gruvbox-light .hljs-emphasis,.hljs-gruvbox-light .hljs-name,.hljs-gruvbox-light .hljs-quote,.hljs-gruvbox-light .hljs-strong,.hljs-gruvbox-light .hljs-title,.hljs-gruvbox-light .hljs-variable{color:#076678}.hljs-gruvbox-light .hljs-attr,.hljs-gruvbox-light .hljs-params,.hljs-gruvbox-light .hljs-template-tag,.hljs-gruvbox-light .hljs-type{color:#b57614}.hljs-gruvbox-light .hljs-builtin-name,.hljs-gruvbox-light .hljs-doctag,.hljs-gruvbox-light .hljs-literal,.hljs-gruvbox-light .hljs-number{color:#8f3f71}.hljs-gruvbox-light .hljs-code,.hljs-gruvbox-light .hljs-meta,.hljs-gruvbox-light .hljs-regexp,.hljs-gruvbox-light .hljs-selector-id,.hljs-gruvbox-light .hljs-template-variable{color:#af3a03}.hljs-gruvbox-light .hljs-addition,.hljs-gruvbox-light .hljs-meta-string,.hljs-gruvbox-light .hljs-section,.hljs-gruvbox-light .hljs-selector-attr,.hljs-gruvbox-light .hljs-selector-class,.hljs-gruvbox-light .hljs-string,.hljs-gruvbox-light .hljs-symbol{color:#79740e}.hljs-gruvbox-light .hljs-attribute,.hljs-gruvbox-light .hljs-bullet,.hljs-gruvbox-light .hljs-class,.hljs-gruvbox-light .hljs-function,.hljs-gruvbox-light .hljs-function .hljs-keyword,.hljs-gruvbox-light .hljs-meta-keyword,.hljs-gruvbox-light .hljs-selector-pseudo,.hljs-gruvbox-light .hljs-tag{color:#427b58}.hljs-gruvbox-light .hljs-comment{color:#928374}.hljs-gruvbox-light .hljs-link_label,.hljs-gruvbox-light .hljs-literal,.hljs-gruvbox-light .hljs-number{color:#8f3f71}.hljs-gruvbox-light .hljs-comment,.hljs-gruvbox-light .hljs-emphasis{font-style:italic}.hljs-gruvbox-light .hljs-section,.hljs-gruvbox-light .hljs-strong,.hljs-gruvbox-light .hljs-tag{font-weight:bold}.hljs-hopscotch .hljs-comment,.hljs-hopscotch .hljs-quote{color:#989498}.hljs-hopscotch .hljs-variable,.hljs-hopscotch .hljs-template-variable,.hljs-hopscotch .hljs-attribute,.hljs-hopscotch .hljs-tag,.hljs-hopscotch .hljs-name,.hljs-hopscotch .hljs-selector-id,.hljs-hopscotch .hljs-selector-class,.hljs-hopscotch .hljs-regexp,.hljs-hopscotch .hljs-link,.hljs-hopscotch .hljs-deletion{color:#dd464c}.hljs-hopscotch .hljs-number,.hljs-hopscotch .hljs-built_in,.hljs-hopscotch .hljs-builtin-name,.hljs-hopscotch .hljs-literal,.hljs-hopscotch .hljs-type,.hljs-hopscotch .hljs-params{color:#fd8b19}.hljs-hopscotch .hljs-class .hljs-title{color:#fdcc59}.hljs-hopscotch .hljs-string,.hljs-hopscotch .hljs-symbol,.hljs-hopscotch .hljs-bullet,.hljs-hopscotch .hljs-addition{color:#8fc13e}.hljs-hopscotch .hljs-meta{color:#149b93}.hljs-hopscotch .hljs-function,.hljs-hopscotch .hljs-section,.hljs-hopscotch .hljs-title{color:#1290bf}.hljs-hopscotch .hljs-keyword,.hljs-hopscotch .hljs-selector-tag{color:#c85e7c}.hljs-hopscotch .hljs{display:block;background:#322931;color:#b9b5b8;padding:.5em}.hljs-hopscotch .hljs-emphasis{font-style:italic}.hljs-hopscotch .hljs-strong{font-weight:bold}.hljs-hybrid .hljs{display:block;overflow-x:auto;padding:.5em;background:#1d1f21}.hljs-hybrid .hljs::selection,.hljs-hybrid .hljs span::selection{background:#373b41}.hljs-hybrid .hljs::-moz-selection,.hljs-hybrid .hljs span::-moz-selection{background:#373b41}.hljs-hybrid .hljs{color:#c5c8c6}.hljs-hybrid .hljs-title,.hljs-hybrid .hljs-name{color:#f0c674}.hljs-hybrid .hljs-comment,.hljs-hybrid .hljs-meta,.hljs-hybrid .hljs-meta .hljs-keyword{color:#707880}.hljs-hybrid .hljs-number,.hljs-hybrid .hljs-symbol,.hljs-hybrid .hljs-literal,.hljs-hybrid .hljs-deletion,.hljs-hybrid .hljs-link{color:#cc6666}.hljs-hybrid .hljs-string,.hljs-hybrid .hljs-doctag,.hljs-hybrid .hljs-addition,.hljs-hybrid .hljs-regexp,.hljs-hybrid .hljs-selector-attr,.hljs-hybrid .hljs-selector-pseudo{color:#b5bd68}.hljs-hybrid .hljs-attribute,.hljs-hybrid .hljs-code,.hljs-hybrid .hljs-selector-id{color:#b294bb}.hljs-hybrid .hljs-keyword,.hljs-hybrid .hljs-selector-tag,.hljs-hybrid .hljs-bullet,.hljs-hybrid .hljs-tag{color:#81a2be}.hljs-hybrid .hljs-subst,.hljs-hybrid .hljs-variable,.hljs-hybrid .hljs-template-tag,.hljs-hybrid .hljs-template-variable{color:#8abeb7}.hljs-hybrid .hljs-type,.hljs-hybrid .hljs-built_in,.hljs-hybrid .hljs-builtin-name,.hljs-hybrid .hljs-quote,.hljs-hybrid .hljs-section,.hljs-hybrid .hljs-selector-class{color:#de935f}.hljs-hybrid .hljs-emphasis{font-style:italic}.hljs-hybrid .hljs-strong{font-weight:bold}.hljs-idea .hljs{display:block;overflow-x:auto;padding:.5em;color:#000;background:#fff}.hljs-idea .hljs-subst,.hljs-idea .hljs-title{font-weight:normal;color:#000}.hljs-idea .hljs-comment,.hljs-idea .hljs-quote{color:#808080;font-style:italic}.hljs-idea .hljs-meta{color:#808000}.hljs-idea .hljs-tag{background:#efefef}.hljs-idea .hljs-section,.hljs-idea .hljs-name,.hljs-idea .hljs-literal,.hljs-idea .hljs-keyword,.hljs-idea .hljs-selector-tag,.hljs-idea .hljs-type,.hljs-idea .hljs-selector-id,.hljs-idea .hljs-selector-class{font-weight:bold;color:#000080}.hljs-idea .hljs-attribute,.hljs-idea .hljs-number,.hljs-idea .hljs-regexp,.hljs-idea .hljs-link{font-weight:bold;color:#0000ff}.hljs-idea .hljs-number,.hljs-idea .hljs-regexp,.hljs-idea .hljs-link{font-weight:normal}.hljs-idea .hljs-string{color:#008000;font-weight:bold}.hljs-idea .hljs-symbol,.hljs-idea .hljs-bullet,.hljs-idea .hljs-formula{color:#000;background:#d0eded;font-style:italic}.hljs-idea .hljs-doctag{text-decoration:underline}.hljs-idea .hljs-variable,.hljs-idea .hljs-template-variable{color:#660e7a}.hljs-idea .hljs-addition{background:#baeeba}.hljs-idea .hljs-deletion{background:#ffc8bd}.hljs-idea .hljs-emphasis{font-style:italic}.hljs-idea .hljs-strong{font-weight:bold}.hljs-ir-black .hljs{display:block;overflow-x:auto;padding:.5em;background:#000;color:#f8f8f8}.hljs-ir-black .hljs-comment,.hljs-ir-black .hljs-quote,.hljs-ir-black .hljs-meta{color:#7c7c7c}.hljs-ir-black .hljs-keyword,.hljs-ir-black .hljs-selector-tag,.hljs-ir-black .hljs-tag,.hljs-ir-black .hljs-name{color:#96cbfe}.hljs-ir-black .hljs-attribute,.hljs-ir-black .hljs-selector-id{color:#ffffb6}.hljs-ir-black .hljs-string,.hljs-ir-black .hljs-selector-attr,.hljs-ir-black .hljs-selector-pseudo,.hljs-ir-black .hljs-addition{color:#a8ff60}.hljs-ir-black .hljs-subst{color:#daefa3}.hljs-ir-black .hljs-regexp,.hljs-ir-black .hljs-link{color:#e9c062}.hljs-ir-black .hljs-title,.hljs-ir-black .hljs-section,.hljs-ir-black .hljs-type,.hljs-ir-black .hljs-doctag{color:#ffffb6}.hljs-ir-black .hljs-symbol,.hljs-ir-black .hljs-bullet,.hljs-ir-black .hljs-variable,.hljs-ir-black .hljs-template-variable,.hljs-ir-black .hljs-literal{color:#c6c5fe}.hljs-ir-black .hljs-number,.hljs-ir-black .hljs-deletion{color:#ff73fd}.hljs-ir-black .hljs-emphasis{font-style:italic}.hljs-ir-black .hljs-strong{font-weight:bold}.hljs-kimbie.dark .hljs-comment,.hljs-kimbie.dark .hljs-quote{color:#d6baad}.hljs-kimbie.dark .hljs-variable,.hljs-kimbie.dark .hljs-template-variable,.hljs-kimbie.dark .hljs-tag,.hljs-kimbie.dark .hljs-name,.hljs-kimbie.dark .hljs-selector-id,.hljs-kimbie.dark .hljs-selector-class,.hljs-kimbie.dark .hljs-regexp,.hljs-kimbie.dark .hljs-meta{color:#dc3958}.hljs-kimbie.dark .hljs-number,.hljs-kimbie.dark .hljs-built_in,.hljs-kimbie.dark .hljs-builtin-name,.hljs-kimbie.dark .hljs-literal,.hljs-kimbie.dark .hljs-type,.hljs-kimbie.dark .hljs-params,.hljs-kimbie.dark .hljs-deletion,.hljs-kimbie.dark .hljs-link{color:#f79a32}.hljs-kimbie.dark .hljs-title,.hljs-kimbie.dark .hljs-section,.hljs-kimbie.dark .hljs-attribute{color:#f06431}.hljs-kimbie.dark .hljs-string,.hljs-kimbie.dark .hljs-symbol,.hljs-kimbie.dark .hljs-bullet,.hljs-kimbie.dark .hljs-addition{color:#889b4a}.hljs-kimbie.dark .hljs-keyword,.hljs-kimbie.dark .hljs-selector-tag,.hljs-kimbie.dark .hljs-function{color:#98676a}.hljs-kimbie.dark .hljs{display:block;overflow-x:auto;background:#221a0f;color:#d3af86;padding:.5em}.hljs-kimbie.dark .hljs-emphasis{font-style:italic}.hljs-kimbie.dark .hljs-strong{font-weight:bold}.hljs-kimbie.light .hljs-comment,.hljs-kimbie.light .hljs-quote{color:#a57a4c}.hljs-kimbie.light .hljs-variable,.hljs-kimbie.light .hljs-template-variable,.hljs-kimbie.light .hljs-tag,.hljs-kimbie.light .hljs-name,.hljs-kimbie.light .hljs-selector-id,.hljs-kimbie.light .hljs-selector-class,.hljs-kimbie.light .hljs-regexp,.hljs-kimbie.light .hljs-meta{color:#dc3958}.hljs-kimbie.light .hljs-number,.hljs-kimbie.light .hljs-built_in,.hljs-kimbie.light .hljs-builtin-name,.hljs-kimbie.light .hljs-literal,.hljs-kimbie.light .hljs-type,.hljs-kimbie.light .hljs-params,.hljs-kimbie.light .hljs-deletion,.hljs-kimbie.light .hljs-link{color:#f79a32}.hljs-kimbie.light .hljs-title,.hljs-kimbie.light .hljs-section,.hljs-kimbie.light .hljs-attribute{color:#f06431}.hljs-kimbie.light .hljs-string,.hljs-kimbie.light .hljs-symbol,.hljs-kimbie.light .hljs-bullet,.hljs-kimbie.light .hljs-addition{color:#889b4a}.hljs-kimbie.light .hljs-keyword,.hljs-kimbie.light .hljs-selector-tag,.hljs-kimbie.light .hljs-function{color:#98676a}.hljs-kimbie.light .hljs{display:block;overflow-x:auto;background:#fbebd4;color:#84613d;padding:.5em}.hljs-kimbie.light .hljs-emphasis{font-style:italic}.hljs-kimbie.light .hljs-strong{font-weight:bold}.hljs-magula .hljs{display:block;overflow-x:auto;padding:.5em;background-color:#f4f4f4}.hljs-magula .hljs,.hljs-magula .hljs-subst{color:black}.hljs-magula .hljs-string,.hljs-magula .hljs-title,.hljs-magula .hljs-symbol,.hljs-magula .hljs-bullet,.hljs-magula .hljs-attribute,.hljs-magula .hljs-addition,.hljs-magula .hljs-variable,.hljs-magula .hljs-template-tag,.hljs-magula .hljs-template-variable{color:#050}.hljs-magula .hljs-comment,.hljs-magula .hljs-quote{color:#777}.hljs-magula .hljs-number,.hljs-magula .hljs-regexp,.hljs-magula .hljs-literal,.hljs-magula .hljs-type,.hljs-magula .hljs-link{color:#800}.hljs-magula .hljs-deletion,.hljs-magula .hljs-meta{color:#00e}.hljs-magula .hljs-keyword,.hljs-magula .hljs-selector-tag,.hljs-magula .hljs-doctag,.hljs-magula .hljs-title,.hljs-magula .hljs-section,.hljs-magula .hljs-built_in,.hljs-magula .hljs-tag,.hljs-magula .hljs-name{font-weight:bold;color:navy}.hljs-magula .hljs-emphasis{font-style:italic}.hljs-magula .hljs-strong{font-weight:bold}.hljs-mono-blue .hljs{display:block;overflow-x:auto;padding:.5em;background:#eaeef3}.hljs-mono-blue .hljs{color:#00193a}.hljs-mono-blue .hljs-keyword,.hljs-mono-blue .hljs-selector-tag,.hljs-mono-blue .hljs-title,.hljs-mono-blue .hljs-section,.hljs-mono-blue .hljs-doctag,.hljs-mono-blue .hljs-name,.hljs-mono-blue .hljs-strong{font-weight:bold}.hljs-mono-blue .hljs-comment{color:#738191}.hljs-mono-blue .hljs-string,.hljs-mono-blue .hljs-title,.hljs-mono-blue .hljs-section,.hljs-mono-blue .hljs-built_in,.hljs-mono-blue .hljs-literal,.hljs-mono-blue .hljs-type,.hljs-mono-blue .hljs-addition,.hljs-mono-blue .hljs-tag,.hljs-mono-blue .hljs-quote,.hljs-mono-blue .hljs-name,.hljs-mono-blue .hljs-selector-id,.hljs-mono-blue .hljs-selector-class{color:#0048ab}.hljs-mono-blue .hljs-meta,.hljs-mono-blue .hljs-subst,.hljs-mono-blue .hljs-symbol,.hljs-mono-blue .hljs-regexp,.hljs-mono-blue .hljs-attribute,.hljs-mono-blue .hljs-deletion,.hljs-mono-blue .hljs-variable,.hljs-mono-blue .hljs-template-variable,.hljs-mono-blue .hljs-link,.hljs-mono-blue .hljs-bullet{color:#4c81c9}.hljs-mono-blue .hljs-emphasis{font-style:italic}.hljs-monokai-sublime .hljs{display:block;overflow-x:auto;padding:.5em;background:#23241f}.hljs-monokai-sublime .hljs,.hljs-monokai-sublime .hljs-tag,.hljs-monokai-sublime .hljs-subst{color:#f8f8f2}.hljs-monokai-sublime .hljs-strong,.hljs-monokai-sublime .hljs-emphasis{color:#a8a8a2}.hljs-monokai-sublime .hljs-bullet,.hljs-monokai-sublime .hljs-quote,.hljs-monokai-sublime .hljs-number,.hljs-monokai-sublime .hljs-regexp,.hljs-monokai-sublime .hljs-literal,.hljs-monokai-sublime .hljs-link{color:#ae81ff}.hljs-monokai-sublime .hljs-code,.hljs-monokai-sublime .hljs-title,.hljs-monokai-sublime .hljs-section,.hljs-monokai-sublime .hljs-selector-class{color:#a6e22e}.hljs-monokai-sublime .hljs-strong{font-weight:bold}.hljs-monokai-sublime .hljs-emphasis{font-style:italic}.hljs-monokai-sublime .hljs-keyword,.hljs-monokai-sublime .hljs-selector-tag,.hljs-monokai-sublime .hljs-name,.hljs-monokai-sublime .hljs-attr{color:#f92672}.hljs-monokai-sublime .hljs-symbol,.hljs-monokai-sublime .hljs-attribute{color:#66d9ef}.hljs-monokai-sublime .hljs-params,.hljs-monokai-sublime .hljs-class .hljs-title{color:#f8f8f2}.hljs-monokai-sublime .hljs-string,.hljs-monokai-sublime .hljs-type,.hljs-monokai-sublime .hljs-built_in,.hljs-monokai-sublime .hljs-builtin-name,.hljs-monokai-sublime .hljs-selector-id,.hljs-monokai-sublime .hljs-selector-attr,.hljs-monokai-sublime .hljs-selector-pseudo,.hljs-monokai-sublime .hljs-addition,.hljs-monokai-sublime .hljs-variable,.hljs-monokai-sublime .hljs-template-variable{color:#e6db74}.hljs-monokai-sublime .hljs-comment,.hljs-monokai-sublime .hljs-deletion,.hljs-monokai-sublime .hljs-meta{color:#75715e}.hljs-monokai .hljs{display:block;overflow-x:auto;padding:.5em;background:#272822;color:#ddd}.hljs-monokai .hljs-tag,.hljs-monokai .hljs-keyword,.hljs-monokai .hljs-selector-tag,.hljs-monokai .hljs-literal,.hljs-monokai .hljs-strong,.hljs-monokai .hljs-name{color:#f92672}.hljs-monokai .hljs-code{color:#66d9ef}.hljs-monokai .hljs-class .hljs-title{color:white}.hljs-monokai .hljs-attribute,.hljs-monokai .hljs-symbol,.hljs-monokai .hljs-regexp,.hljs-monokai .hljs-link{color:#bf79db}.hljs-monokai .hljs-string,.hljs-monokai .hljs-bullet,.hljs-monokai .hljs-subst,.hljs-monokai .hljs-title,.hljs-monokai .hljs-section,.hljs-monokai .hljs-emphasis,.hljs-monokai .hljs-type,.hljs-monokai .hljs-built_in,.hljs-monokai .hljs-builtin-name,.hljs-monokai .hljs-selector-attr,.hljs-monokai .hljs-selector-pseudo,.hljs-monokai .hljs-addition,.hljs-monokai .hljs-variable,.hljs-monokai .hljs-template-tag,.hljs-monokai .hljs-template-variable{color:#a6e22e}.hljs-monokai .hljs-comment,.hljs-monokai .hljs-quote,.hljs-monokai .hljs-deletion,.hljs-monokai .hljs-meta{color:#75715e}.hljs-monokai .hljs-keyword,.hljs-monokai .hljs-selector-tag,.hljs-monokai .hljs-literal,.hljs-monokai .hljs-doctag,.hljs-monokai .hljs-title,.hljs-monokai .hljs-section,.hljs-monokai .hljs-type,.hljs-monokai .hljs-selector-id{font-weight:bold}.hljs-obsidian .hljs{display:block;overflow-x:auto;padding:.5em;background:#282b2e}.hljs-obsidian .hljs-keyword,.hljs-obsidian .hljs-selector-tag,.hljs-obsidian .hljs-literal,.hljs-obsidian .hljs-selector-id{color:#93c763}.hljs-obsidian .hljs-number{color:#ffcd22}.hljs-obsidian .hljs{color:#e0e2e4}.hljs-obsidian .hljs-attribute{color:#668bb0}.hljs-obsidian .hljs-code,.hljs-obsidian .hljs-class .hljs-title,.hljs-obsidian .hljs-section{color:white}.hljs-obsidian .hljs-regexp,.hljs-obsidian .hljs-link{color:#d39745}.hljs-obsidian .hljs-meta{color:#557182}.hljs-obsidian .hljs-tag,.hljs-obsidian .hljs-name,.hljs-obsidian .hljs-bullet,.hljs-obsidian .hljs-subst,.hljs-obsidian .hljs-emphasis,.hljs-obsidian .hljs-type,.hljs-obsidian .hljs-built_in,.hljs-obsidian .hljs-selector-attr,.hljs-obsidian .hljs-selector-pseudo,.hljs-obsidian .hljs-addition,.hljs-obsidian .hljs-variable,.hljs-obsidian .hljs-template-tag,.hljs-obsidian .hljs-template-variable{color:#8cbbad}.hljs-obsidian .hljs-string,.hljs-obsidian .hljs-symbol{color:#ec7600}.hljs-obsidian .hljs-comment,.hljs-obsidian .hljs-quote,.hljs-obsidian .hljs-deletion{color:#818e96}.hljs-obsidian .hljs-selector-class{color:#A082BD}.hljs-obsidian .hljs-keyword,.hljs-obsidian .hljs-selector-tag,.hljs-obsidian .hljs-literal,.hljs-obsidian .hljs-doctag,.hljs-obsidian .hljs-title,.hljs-obsidian .hljs-section,.hljs-obsidian .hljs-type,.hljs-obsidian .hljs-name,.hljs-obsidian .hljs-strong{font-weight:bold}.hljs-ocean .hljs-comment,.hljs-ocean .hljs-quote{color:#65737e}.hljs-ocean .hljs-variable,.hljs-ocean .hljs-template-variable,.hljs-ocean .hljs-tag,.hljs-ocean .hljs-name,.hljs-ocean .hljs-selector-id,.hljs-ocean .hljs-selector-class,.hljs-ocean .hljs-regexp,.hljs-ocean .hljs-deletion{color:#bf616a}.hljs-ocean .hljs-number,.hljs-ocean .hljs-built_in,.hljs-ocean .hljs-builtin-name,.hljs-ocean .hljs-literal,.hljs-ocean .hljs-type,.hljs-ocean .hljs-params,.hljs-ocean .hljs-meta,.hljs-ocean .hljs-link{color:#d08770}.hljs-ocean .hljs-attribute{color:#ebcb8b}.hljs-ocean .hljs-string,.hljs-ocean .hljs-symbol,.hljs-ocean .hljs-bullet,.hljs-ocean .hljs-addition{color:#a3be8c}.hljs-ocean .hljs-title,.hljs-ocean .hljs-section{color:#8fa1b3}.hljs-ocean .hljs-keyword,.hljs-ocean .hljs-selector-tag{color:#b48ead}.hljs-ocean .hljs{display:block;overflow-x:auto;background:#2b303b;color:#c0c5ce;padding:.5em}.hljs-ocean .hljs-emphasis{font-style:italic}.hljs-ocean .hljs-strong{font-weight:bold}.hljs-paraiso-dark .hljs-comment,.hljs-paraiso-dark .hljs-quote{color:#8d8687}.hljs-paraiso-dark .hljs-variable,.hljs-paraiso-dark .hljs-template-variable,.hljs-paraiso-dark .hljs-tag,.hljs-paraiso-dark .hljs-name,.hljs-paraiso-dark .hljs-selector-id,.hljs-paraiso-dark .hljs-selector-class,.hljs-paraiso-dark .hljs-regexp,.hljs-paraiso-dark .hljs-link,.hljs-paraiso-dark .hljs-meta{color:#ef6155}.hljs-paraiso-dark .hljs-number,.hljs-paraiso-dark .hljs-built_in,.hljs-paraiso-dark .hljs-builtin-name,.hljs-paraiso-dark .hljs-literal,.hljs-paraiso-dark .hljs-type,.hljs-paraiso-dark .hljs-params,.hljs-paraiso-dark .hljs-deletion{color:#f99b15}.hljs-paraiso-dark .hljs-title,.hljs-paraiso-dark .hljs-section,.hljs-paraiso-dark .hljs-attribute{color:#fec418}.hljs-paraiso-dark .hljs-string,.hljs-paraiso-dark .hljs-symbol,.hljs-paraiso-dark .hljs-bullet,.hljs-paraiso-dark .hljs-addition{color:#48b685}.hljs-paraiso-dark .hljs-keyword,.hljs-paraiso-dark .hljs-selector-tag{color:#815ba4}.hljs-paraiso-dark .hljs{display:block;overflow-x:auto;background:#2f1e2e;color:#a39e9b;padding:.5em}.hljs-paraiso-dark .hljs-emphasis{font-style:italic}.hljs-paraiso-dark .hljs-strong{font-weight:bold}.hljs-paraiso-light .hljs-comment,.hljs-paraiso-light .hljs-quote{color:#776e71}.hljs-paraiso-light .hljs-variable,.hljs-paraiso-light .hljs-template-variable,.hljs-paraiso-light .hljs-tag,.hljs-paraiso-light .hljs-name,.hljs-paraiso-light .hljs-selector-id,.hljs-paraiso-light .hljs-selector-class,.hljs-paraiso-light .hljs-regexp,.hljs-paraiso-light .hljs-link,.hljs-paraiso-light .hljs-meta{color:#ef6155}.hljs-paraiso-light .hljs-number,.hljs-paraiso-light .hljs-built_in,.hljs-paraiso-light .hljs-builtin-name,.hljs-paraiso-light .hljs-literal,.hljs-paraiso-light .hljs-type,.hljs-paraiso-light .hljs-params,.hljs-paraiso-light .hljs-deletion{color:#f99b15}.hljs-paraiso-light .hljs-title,.hljs-paraiso-light .hljs-section,.hljs-paraiso-light .hljs-attribute{color:#fec418}.hljs-paraiso-light .hljs-string,.hljs-paraiso-light .hljs-symbol,.hljs-paraiso-light .hljs-bullet,.hljs-paraiso-light .hljs-addition{color:#48b685}.hljs-paraiso-light .hljs-keyword,.hljs-paraiso-light .hljs-selector-tag{color:#815ba4}.hljs-paraiso-light .hljs{display:block;overflow-x:auto;background:#e7e9db;color:#4f424c;padding:.5em}.hljs-paraiso-light .hljs-emphasis{font-style:italic}.hljs-paraiso-light .hljs-strong{font-weight:bold}.hljs-purebasic .hljs{display:block;overflow-x:auto;padding:.5em;background:#FFFFDF}.hljs-purebasic .hljs,.hljs-purebasic .hljs-type,.hljs-purebasic .hljs-function,.hljs-purebasic .hljs-name,.hljs-purebasic .hljs-number,.hljs-purebasic .hljs-attr,.hljs-purebasic .hljs-params,.hljs-purebasic .hljs-subst{color:#000000}.hljs-purebasic .hljs-comment,.hljs-purebasic .hljs-regexp,.hljs-purebasic .hljs-section,.hljs-purebasic .hljs-selector-pseudo,.hljs-purebasic .hljs-addition{color:#00AAAA}.hljs-purebasic .hljs-title,.hljs-purebasic .hljs-tag,.hljs-purebasic .hljs-variable,.hljs-purebasic .hljs-code{color:#006666}.hljs-purebasic .hljs-keyword,.hljs-purebasic .hljs-class,.hljs-purebasic .hljs-meta-keyword,.hljs-purebasic .hljs-selector-class,.hljs-purebasic .hljs-built_in,.hljs-purebasic .hljs-builtin-name{color:#006666;font-weight:bold}.hljs-purebasic .hljs-string,.hljs-purebasic .hljs-selector-attr{color:#0080FF}.hljs-purebasic .hljs-symbol,.hljs-purebasic .hljs-link,.hljs-purebasic .hljs-deletion,.hljs-purebasic .hljs-attribute{color:#924B72}.hljs-purebasic .hljs-meta,.hljs-purebasic .hljs-literal,.hljs-purebasic .hljs-selector-id{color:#924B72;font-weight:bold}.hljs-purebasic .hljs-strong,.hljs-purebasic .hljs-name{font-weight:bold}.hljs-purebasic .hljs-emphasis{font-style:italic}.hljs-qtcreator_dark .hljs{display:block;overflow-x:auto;padding:.5em;background:#000000}.hljs-qtcreator_dark .hljs,.hljs-qtcreator_dark .hljs-subst,.hljs-qtcreator_dark .hljs-tag,.hljs-qtcreator_dark .hljs-title{color:#aaaaaa}.hljs-qtcreator_dark .hljs-strong,.hljs-qtcreator_dark .hljs-emphasis{color:#a8a8a2}.hljs-qtcreator_dark .hljs-bullet,.hljs-qtcreator_dark .hljs-quote,.hljs-qtcreator_dark .hljs-number,.hljs-qtcreator_dark .hljs-regexp,.hljs-qtcreator_dark .hljs-literal{color:#ff55ff}.hljs-qtcreator_dark .hljs-code .hljs-selector-class{color:#aaaaff}.hljs-qtcreator_dark .hljs-emphasis,.hljs-qtcreator_dark .hljs-stronge,.hljs-qtcreator_dark .hljs-type{font-style:italic}.hljs-qtcreator_dark .hljs-keyword,.hljs-qtcreator_dark .hljs-selector-tag,.hljs-qtcreator_dark .hljs-function,.hljs-qtcreator_dark .hljs-section,.hljs-qtcreator_dark .hljs-symbol,.hljs-qtcreator_dark .hljs-name{color:#ffff55}.hljs-qtcreator_dark .hljs-attribute{color:#ff5555}.hljs-qtcreator_dark .hljs-variable,.hljs-qtcreator_dark .hljs-params,.hljs-qtcreator_dark .hljs-class .hljs-title{color:#8888ff}.hljs-qtcreator_dark .hljs-string,.hljs-qtcreator_dark .hljs-selector-id,.hljs-qtcreator_dark .hljs-selector-attr,.hljs-qtcreator_dark .hljs-selector-pseudo,.hljs-qtcreator_dark .hljs-type,.hljs-qtcreator_dark .hljs-built_in,.hljs-qtcreator_dark .hljs-builtin-name,.hljs-qtcreator_dark .hljs-template-tag,.hljs-qtcreator_dark .hljs-template-variable,.hljs-qtcreator_dark .hljs-addition,.hljs-qtcreator_dark .hljs-link{color:#ff55ff}.hljs-qtcreator_dark .hljs-comment,.hljs-qtcreator_dark .hljs-meta,.hljs-qtcreator_dark .hljs-deletion{color:#55ffff}.hljs-qtcreator_light .hljs{display:block;overflow-x:auto;padding:.5em;background:#ffffff}.hljs-qtcreator_light .hljs,.hljs-qtcreator_light .hljs-subst,.hljs-qtcreator_light .hljs-tag,.hljs-qtcreator_light .hljs-title{color:#000000}.hljs-qtcreator_light .hljs-strong,.hljs-qtcreator_light .hljs-emphasis{color:#000000}.hljs-qtcreator_light .hljs-bullet,.hljs-qtcreator_light .hljs-quote,.hljs-qtcreator_light .hljs-number,.hljs-qtcreator_light .hljs-regexp,.hljs-qtcreator_light .hljs-literal{color:#000080}.hljs-qtcreator_light .hljs-code .hljs-selector-class{color:#800080}.hljs-qtcreator_light .hljs-emphasis,.hljs-qtcreator_light .hljs-stronge,.hljs-qtcreator_light .hljs-type{font-style:italic}.hljs-qtcreator_light .hljs-keyword,.hljs-qtcreator_light .hljs-selector-tag,.hljs-qtcreator_light .hljs-function,.hljs-qtcreator_light .hljs-section,.hljs-qtcreator_light .hljs-symbol,.hljs-qtcreator_light .hljs-name{color:#808000}.hljs-qtcreator_light .hljs-attribute{color:#800000}.hljs-qtcreator_light .hljs-variable,.hljs-qtcreator_light .hljs-params,.hljs-qtcreator_light .hljs-class .hljs-title{color:#0055AF}.hljs-qtcreator_light .hljs-string,.hljs-qtcreator_light .hljs-selector-id,.hljs-qtcreator_light .hljs-selector-attr,.hljs-qtcreator_light .hljs-selector-pseudo,.hljs-qtcreator_light .hljs-type,.hljs-qtcreator_light .hljs-built_in,.hljs-qtcreator_light .hljs-builtin-name,.hljs-qtcreator_light .hljs-template-tag,.hljs-qtcreator_light .hljs-template-variable,.hljs-qtcreator_light .hljs-addition,.hljs-qtcreator_light .hljs-link{color:#008000}.hljs-qtcreator_light .hljs-comment,.hljs-qtcreator_light .hljs-meta,.hljs-qtcreator_light .hljs-deletion{color:#008000}.hljs-railscasts .hljs{display:block;overflow-x:auto;padding:.5em;background:#232323;color:#e6e1dc}.hljs-railscasts .hljs-comment,.hljs-railscasts .hljs-quote{color:#bc9458;font-style:italic}.hljs-railscasts .hljs-keyword,.hljs-railscasts .hljs-selector-tag{color:#c26230}.hljs-railscasts .hljs-string,.hljs-railscasts .hljs-number,.hljs-railscasts .hljs-regexp,.hljs-railscasts .hljs-variable,.hljs-railscasts .hljs-template-variable{color:#a5c261}.hljs-railscasts .hljs-subst{color:#519f50}.hljs-railscasts .hljs-tag,.hljs-railscasts .hljs-name{color:#e8bf6a}.hljs-railscasts .hljs-type{color:#da4939}.hljs-railscasts .hljs-symbol,.hljs-railscasts .hljs-bullet,.hljs-railscasts .hljs-built_in,.hljs-railscasts .hljs-builtin-name,.hljs-railscasts .hljs-attr,.hljs-railscasts .hljs-link{color:#6d9cbe}.hljs-railscasts .hljs-params{color:#d0d0ff}.hljs-railscasts .hljs-attribute{color:#cda869}.hljs-railscasts .hljs-meta{color:#9b859d}.hljs-railscasts .hljs-title,.hljs-railscasts .hljs-section{color:#ffc66d}.hljs-railscasts .hljs-addition{background-color:#144212;color:#e6e1dc;display:inline-block;width:100%}.hljs-railscasts .hljs-deletion{background-color:#600;color:#e6e1dc;display:inline-block;width:100%}.hljs-railscasts .hljs-selector-class{color:#9b703f}.hljs-railscasts .hljs-selector-id{color:#8b98ab}.hljs-railscasts .hljs-emphasis{font-style:italic}.hljs-railscasts .hljs-strong{font-weight:bold}.hljs-railscasts .hljs-link{text-decoration:underline}.hljs-rainbow .hljs{display:block;overflow-x:auto;padding:.5em;background:#474949;color:#d1d9e1}.hljs-rainbow .hljs-comment,.hljs-rainbow .hljs-quote{color:#969896;font-style:italic}.hljs-rainbow .hljs-keyword,.hljs-rainbow .hljs-selector-tag,.hljs-rainbow .hljs-literal,.hljs-rainbow .hljs-type,.hljs-rainbow .hljs-addition{color:#cc99cc}.hljs-rainbow .hljs-number,.hljs-rainbow .hljs-selector-attr,.hljs-rainbow .hljs-selector-pseudo{color:#f99157}.hljs-rainbow .hljs-string,.hljs-rainbow .hljs-doctag,.hljs-rainbow .hljs-regexp{color:#8abeb7}.hljs-rainbow .hljs-title,.hljs-rainbow .hljs-name,.hljs-rainbow .hljs-section,.hljs-rainbow .hljs-built_in{color:#b5bd68}.hljs-rainbow .hljs-variable,.hljs-rainbow .hljs-template-variable,.hljs-rainbow .hljs-selector-id,.hljs-rainbow .hljs-class .hljs-title{color:#ffcc66}.hljs-rainbow .hljs-section,.hljs-rainbow .hljs-name,.hljs-rainbow .hljs-strong{font-weight:bold}.hljs-rainbow .hljs-symbol,.hljs-rainbow .hljs-bullet,.hljs-rainbow .hljs-subst,.hljs-rainbow .hljs-meta,.hljs-rainbow .hljs-link{color:#f99157}.hljs-rainbow .hljs-deletion{color:#dc322f}.hljs-rainbow .hljs-formula{background:#eee8d5}.hljs-rainbow .hljs-attr,.hljs-rainbow .hljs-attribute{color:#81a2be}.hljs-rainbow .hljs-emphasis{font-style:italic}.hljs-school-book .hljs{display:block;overflow-x:auto;padding:15px .5em .5em 30px;font-size:11px;line-height:16px}.hljs-school-book pre{background:#f6f6ae url(school-book.png);border-top:solid 2px #d2e8b9;border-bottom:solid 1px #d2e8b9}.hljs-school-book .hljs-keyword,.hljs-school-book .hljs-selector-tag,.hljs-school-book .hljs-literal{color:#005599;font-weight:bold}.hljs-school-book .hljs,.hljs-school-book .hljs-subst{color:#3e5915}.hljs-school-book .hljs-string,.hljs-school-book .hljs-title,.hljs-school-book .hljs-section,.hljs-school-book .hljs-type,.hljs-school-book .hljs-symbol,.hljs-school-book .hljs-bullet,.hljs-school-book .hljs-attribute,.hljs-school-book .hljs-built_in,.hljs-school-book .hljs-builtin-name,.hljs-school-book .hljs-addition,.hljs-school-book .hljs-variable,.hljs-school-book .hljs-template-tag,.hljs-school-book .hljs-template-variable,.hljs-school-book .hljs-link{color:#2c009f}.hljs-school-book .hljs-comment,.hljs-school-book .hljs-quote,.hljs-school-book .hljs-deletion,.hljs-school-book .hljs-meta{color:#e60415}.hljs-school-book .hljs-keyword,.hljs-school-book .hljs-selector-tag,.hljs-school-book .hljs-literal,.hljs-school-book .hljs-doctag,.hljs-school-book .hljs-title,.hljs-school-book .hljs-section,.hljs-school-book .hljs-type,.hljs-school-book .hljs-name,.hljs-school-book .hljs-selector-id,.hljs-school-book .hljs-strong{font-weight:bold}.hljs-school-book .hljs-emphasis{font-style:italic}.hljs-solarized-dark .hljs{display:block;overflow-x:auto;padding:.5em;background:#002b36;color:#839496}.hljs-solarized-dark .hljs-comment,.hljs-solarized-dark .hljs-quote{color:#586e75}.hljs-solarized-dark .hljs-keyword,.hljs-solarized-dark .hljs-selector-tag,.hljs-solarized-dark .hljs-addition{color:#859900}.hljs-solarized-dark .hljs-number,.hljs-solarized-dark .hljs-string,.hljs-solarized-dark .hljs-meta .hljs-meta-string,.hljs-solarized-dark .hljs-literal,.hljs-solarized-dark .hljs-doctag,.hljs-solarized-dark .hljs-regexp{color:#2aa198}.hljs-solarized-dark .hljs-title,.hljs-solarized-dark .hljs-section,.hljs-solarized-dark .hljs-name,.hljs-solarized-dark .hljs-selector-id,.hljs-solarized-dark .hljs-selector-class{color:#268bd2}.hljs-solarized-dark .hljs-attribute,.hljs-solarized-dark .hljs-attr,.hljs-solarized-dark .hljs-variable,.hljs-solarized-dark .hljs-template-variable,.hljs-solarized-dark .hljs-class .hljs-title,.hljs-solarized-dark .hljs-type{color:#b58900}.hljs-solarized-dark .hljs-symbol,.hljs-solarized-dark .hljs-bullet,.hljs-solarized-dark .hljs-subst,.hljs-solarized-dark .hljs-meta,.hljs-solarized-dark .hljs-meta .hljs-keyword,.hljs-solarized-dark .hljs-selector-attr,.hljs-solarized-dark .hljs-selector-pseudo,.hljs-solarized-dark .hljs-link{color:#cb4b16}.hljs-solarized-dark .hljs-built_in,.hljs-solarized-dark .hljs-deletion{color:#dc322f}.hljs-solarized-dark .hljs-formula{background:#073642}.hljs-solarized-dark .hljs-emphasis{font-style:italic}.hljs-solarized-dark .hljs-strong{font-weight:bold}.hljs-solarized-light .hljs{display:block;overflow-x:auto;padding:.5em;background:#fdf6e3;color:#657b83}.hljs-solarized-light .hljs-comment,.hljs-solarized-light .hljs-quote{color:#93a1a1}.hljs-solarized-light .hljs-keyword,.hljs-solarized-light .hljs-selector-tag,.hljs-solarized-light .hljs-addition{color:#859900}.hljs-solarized-light .hljs-number,.hljs-solarized-light .hljs-string,.hljs-solarized-light .hljs-meta .hljs-meta-string,.hljs-solarized-light .hljs-literal,.hljs-solarized-light .hljs-doctag,.hljs-solarized-light .hljs-regexp{color:#2aa198}.hljs-solarized-light .hljs-title,.hljs-solarized-light .hljs-section,.hljs-solarized-light .hljs-name,.hljs-solarized-light .hljs-selector-id,.hljs-solarized-light .hljs-selector-class{color:#268bd2}.hljs-solarized-light .hljs-attribute,.hljs-solarized-light .hljs-attr,.hljs-solarized-light .hljs-variable,.hljs-solarized-light .hljs-template-variable,.hljs-solarized-light .hljs-class .hljs-title,.hljs-solarized-light .hljs-type{color:#b58900}.hljs-solarized-light .hljs-symbol,.hljs-solarized-light .hljs-bullet,.hljs-solarized-light .hljs-subst,.hljs-solarized-light .hljs-meta,.hljs-solarized-light .hljs-meta .hljs-keyword,.hljs-solarized-light .hljs-selector-attr,.hljs-solarized-light .hljs-selector-pseudo,.hljs-solarized-light .hljs-link{color:#cb4b16}.hljs-solarized-light .hljs-built_in,.hljs-solarized-light .hljs-deletion{color:#dc322f}.hljs-solarized-light .hljs-formula{background:#eee8d5}.hljs-solarized-light .hljs-emphasis{font-style:italic}.hljs-solarized-light .hljs-strong{font-weight:bold}.hljs-sunburst .hljs{display:block;overflow-x:auto;padding:.5em;background:#000;color:#f8f8f8}.hljs-sunburst .hljs-comment,.hljs-sunburst .hljs-quote{color:#aeaeae;font-style:italic}.hljs-sunburst .hljs-keyword,.hljs-sunburst .hljs-selector-tag,.hljs-sunburst .hljs-type{color:#e28964}.hljs-sunburst .hljs-string{color:#65b042}.hljs-sunburst .hljs-subst{color:#daefa3}.hljs-sunburst .hljs-regexp,.hljs-sunburst .hljs-link{color:#e9c062}.hljs-sunburst .hljs-title,.hljs-sunburst .hljs-section,.hljs-sunburst .hljs-tag,.hljs-sunburst .hljs-name{color:#89bdff}.hljs-sunburst .hljs-class .hljs-title,.hljs-sunburst .hljs-doctag{text-decoration:underline}.hljs-sunburst .hljs-symbol,.hljs-sunburst .hljs-bullet,.hljs-sunburst .hljs-number{color:#3387cc}.hljs-sunburst .hljs-params,.hljs-sunburst .hljs-variable,.hljs-sunburst .hljs-template-variable{color:#3e87e3}.hljs-sunburst .hljs-attribute{color:#cda869}.hljs-sunburst .hljs-meta{color:#8996a8}.hljs-sunburst .hljs-formula{background-color:#0e2231;color:#f8f8f8;font-style:italic}.hljs-sunburst .hljs-addition{background-color:#253b22;color:#f8f8f8}.hljs-sunburst .hljs-deletion{background-color:#420e09;color:#f8f8f8}.hljs-sunburst .hljs-selector-class{color:#9b703f}.hljs-sunburst .hljs-selector-id{color:#8b98ab}.hljs-sunburst .hljs-emphasis{font-style:italic}.hljs-sunburst .hljs-strong{font-weight:bold}.hljs-tomorrow-night-blue .hljs-comment,.hljs-tomorrow-night-blue .hljs-quote{color:#7285b7}.hljs-tomorrow-night-blue .hljs-variable,.hljs-tomorrow-night-blue .hljs-template-variable,.hljs-tomorrow-night-blue .hljs-tag,.hljs-tomorrow-night-blue .hljs-name,.hljs-tomorrow-night-blue .hljs-selector-id,.hljs-tomorrow-night-blue .hljs-selector-class,.hljs-tomorrow-night-blue .hljs-regexp,.hljs-tomorrow-night-blue .hljs-deletion{color:#ff9da4}.hljs-tomorrow-night-blue .hljs-number,.hljs-tomorrow-night-blue .hljs-built_in,.hljs-tomorrow-night-blue .hljs-builtin-name,.hljs-tomorrow-night-blue .hljs-literal,.hljs-tomorrow-night-blue .hljs-type,.hljs-tomorrow-night-blue .hljs-params,.hljs-tomorrow-night-blue .hljs-meta,.hljs-tomorrow-night-blue .hljs-link{color:#ffc58f}.hljs-tomorrow-night-blue .hljs-attribute{color:#ffeead}.hljs-tomorrow-night-blue .hljs-string,.hljs-tomorrow-night-blue .hljs-symbol,.hljs-tomorrow-night-blue .hljs-bullet,.hljs-tomorrow-night-blue .hljs-addition{color:#d1f1a9}.hljs-tomorrow-night-blue .hljs-title,.hljs-tomorrow-night-blue .hljs-section{color:#bbdaff}.hljs-tomorrow-night-blue .hljs-keyword,.hljs-tomorrow-night-blue .hljs-selector-tag{color:#ebbbff}.hljs-tomorrow-night-blue .hljs{display:block;overflow-x:auto;background:#002451;color:white;padding:.5em}.hljs-tomorrow-night-blue .hljs-emphasis{font-style:italic}.hljs-tomorrow-night-blue .hljs-strong{font-weight:bold}.hljs-tomorrow-night-bright .hljs-comment,.hljs-tomorrow-night-bright .hljs-quote{color:#969896}.hljs-tomorrow-night-bright .hljs-variable,.hljs-tomorrow-night-bright .hljs-template-variable,.hljs-tomorrow-night-bright .hljs-tag,.hljs-tomorrow-night-bright .hljs-name,.hljs-tomorrow-night-bright .hljs-selector-id,.hljs-tomorrow-night-bright .hljs-selector-class,.hljs-tomorrow-night-bright .hljs-regexp,.hljs-tomorrow-night-bright .hljs-deletion{color:#d54e53}.hljs-tomorrow-night-bright .hljs-number,.hljs-tomorrow-night-bright .hljs-built_in,.hljs-tomorrow-night-bright .hljs-builtin-name,.hljs-tomorrow-night-bright .hljs-literal,.hljs-tomorrow-night-bright .hljs-type,.hljs-tomorrow-night-bright .hljs-params,.hljs-tomorrow-night-bright .hljs-meta,.hljs-tomorrow-night-bright .hljs-link{color:#e78c45}.hljs-tomorrow-night-bright .hljs-attribute{color:#e7c547}.hljs-tomorrow-night-bright .hljs-string,.hljs-tomorrow-night-bright .hljs-symbol,.hljs-tomorrow-night-bright .hljs-bullet,.hljs-tomorrow-night-bright .hljs-addition{color:#b9ca4a}.hljs-tomorrow-night-bright .hljs-title,.hljs-tomorrow-night-bright .hljs-section{color:#7aa6da}.hljs-tomorrow-night-bright .hljs-keyword,.hljs-tomorrow-night-bright .hljs-selector-tag{color:#c397d8}.hljs-tomorrow-night-bright .hljs{display:block;overflow-x:auto;background:black;color:#eaeaea;padding:.5em}.hljs-tomorrow-night-bright .hljs-emphasis{font-style:italic}.hljs-tomorrow-night-bright .hljs-strong{font-weight:bold}.hljs-tomorrow-night-eighties .hljs-comment,.hljs-tomorrow-night-eighties .hljs-quote{color:#999999}.hljs-tomorrow-night-eighties .hljs-variable,.hljs-tomorrow-night-eighties .hljs-template-variable,.hljs-tomorrow-night-eighties .hljs-tag,.hljs-tomorrow-night-eighties .hljs-name,.hljs-tomorrow-night-eighties .hljs-selector-id,.hljs-tomorrow-night-eighties .hljs-selector-class,.hljs-tomorrow-night-eighties .hljs-regexp,.hljs-tomorrow-night-eighties .hljs-deletion{color:#f2777a}.hljs-tomorrow-night-eighties .hljs-number,.hljs-tomorrow-night-eighties .hljs-built_in,.hljs-tomorrow-night-eighties .hljs-builtin-name,.hljs-tomorrow-night-eighties .hljs-literal,.hljs-tomorrow-night-eighties .hljs-type,.hljs-tomorrow-night-eighties .hljs-params,.hljs-tomorrow-night-eighties .hljs-meta,.hljs-tomorrow-night-eighties .hljs-link{color:#f99157}.hljs-tomorrow-night-eighties .hljs-attribute{color:#ffcc66}.hljs-tomorrow-night-eighties .hljs-string,.hljs-tomorrow-night-eighties .hljs-symbol,.hljs-tomorrow-night-eighties .hljs-bullet,.hljs-tomorrow-night-eighties .hljs-addition{color:#99cc99}.hljs-tomorrow-night-eighties .hljs-title,.hljs-tomorrow-night-eighties .hljs-section{color:#6699cc}.hljs-tomorrow-night-eighties .hljs-keyword,.hljs-tomorrow-night-eighties .hljs-selector-tag{color:#cc99cc}.hljs-tomorrow-night-eighties .hljs{display:block;overflow-x:auto;background:#2d2d2d;color:#cccccc;padding:.5em}.hljs-tomorrow-night-eighties .hljs-emphasis{font-style:italic}.hljs-tomorrow-night-eighties .hljs-strong{font-weight:bold}.hljs-tomorrow-night .hljs-comment,.hljs-tomorrow-night .hljs-quote{color:#969896}.hljs-tomorrow-night .hljs-variable,.hljs-tomorrow-night .hljs-template-variable,.hljs-tomorrow-night .hljs-tag,.hljs-tomorrow-night .hljs-name,.hljs-tomorrow-night .hljs-selector-id,.hljs-tomorrow-night .hljs-selector-class,.hljs-tomorrow-night .hljs-regexp,.hljs-tomorrow-night .hljs-deletion{color:#cc6666}.hljs-tomorrow-night .hljs-number,.hljs-tomorrow-night .hljs-built_in,.hljs-tomorrow-night .hljs-builtin-name,.hljs-tomorrow-night .hljs-literal,.hljs-tomorrow-night .hljs-type,.hljs-tomorrow-night .hljs-params,.hljs-tomorrow-night .hljs-meta,.hljs-tomorrow-night .hljs-link{color:#de935f}.hljs-tomorrow-night .hljs-attribute{color:#f0c674}.hljs-tomorrow-night .hljs-string,.hljs-tomorrow-night .hljs-symbol,.hljs-tomorrow-night .hljs-bullet,.hljs-tomorrow-night .hljs-addition{color:#b5bd68}.hljs-tomorrow-night .hljs-title,.hljs-tomorrow-night .hljs-section{color:#81a2be}.hljs-tomorrow-night .hljs-keyword,.hljs-tomorrow-night .hljs-selector-tag{color:#b294bb}.hljs-tomorrow-night .hljs{display:block;overflow-x:auto;background:#1d1f21;color:#c5c8c6;padding:.5em}.hljs-tomorrow-night .hljs-emphasis{font-style:italic}.hljs-tomorrow-night .hljs-strong{font-weight:bold}.hljs-tomorrow .hljs-comment,.hljs-tomorrow .hljs-quote{color:#8e908c}.hljs-tomorrow .hljs-variable,.hljs-tomorrow .hljs-template-variable,.hljs-tomorrow .hljs-tag,.hljs-tomorrow .hljs-name,.hljs-tomorrow .hljs-selector-id,.hljs-tomorrow .hljs-selector-class,.hljs-tomorrow .hljs-regexp,.hljs-tomorrow .hljs-deletion{color:#c82829}.hljs-tomorrow .hljs-number,.hljs-tomorrow .hljs-built_in,.hljs-tomorrow .hljs-builtin-name,.hljs-tomorrow .hljs-literal,.hljs-tomorrow .hljs-type,.hljs-tomorrow .hljs-params,.hljs-tomorrow .hljs-meta,.hljs-tomorrow .hljs-link{color:#f5871f}.hljs-tomorrow .hljs-attribute{color:#eab700}.hljs-tomorrow .hljs-string,.hljs-tomorrow .hljs-symbol,.hljs-tomorrow .hljs-bullet,.hljs-tomorrow .hljs-addition{color:#718c00}.hljs-tomorrow .hljs-title,.hljs-tomorrow .hljs-section{color:#4271ae}.hljs-tomorrow .hljs-keyword,.hljs-tomorrow .hljs-selector-tag{color:#8959a8}.hljs-tomorrow .hljs{display:block;overflow-x:auto;background:white;color:#4d4d4c;padding:.5em}.hljs-tomorrow .hljs-emphasis{font-style:italic}.hljs-tomorrow .hljs-strong{font-weight:bold}.hljs-vs .hljs{display:block;overflow-x:auto;padding:.5em;background:white;color:black}.hljs-vs .hljs-comment,.hljs-vs .hljs-quote,.hljs-vs .hljs-variable{color:#008000}.hljs-vs .hljs-keyword,.hljs-vs .hljs-selector-tag,.hljs-vs .hljs-built_in,.hljs-vs .hljs-name,.hljs-vs .hljs-tag{color:#00f}.hljs-vs .hljs-string,.hljs-vs .hljs-title,.hljs-vs .hljs-section,.hljs-vs .hljs-attribute,.hljs-vs .hljs-literal,.hljs-vs .hljs-template-tag,.hljs-vs .hljs-template-variable,.hljs-vs .hljs-type,.hljs-vs .hljs-addition{color:#a31515}.hljs-vs .hljs-deletion,.hljs-vs .hljs-selector-attr,.hljs-vs .hljs-selector-pseudo,.hljs-vs .hljs-meta{color:#2b91af}.hljs-vs .hljs-doctag{color:#808080}.hljs-vs .hljs-attr{color:#f00}.hljs-vs .hljs-symbol,.hljs-vs .hljs-bullet,.hljs-vs .hljs-link{color:#00b0e8}.hljs-vs .hljs-emphasis{font-style:italic}.hljs-vs .hljs-strong{font-weight:bold}.hljs-xcode .hljs{display:block;overflow-x:auto;padding:.5em;background:#fff;color:black}.hljs-xcode .hljs-comment,.hljs-xcode .hljs-quote{color:#006a00}.hljs-xcode .hljs-keyword,.hljs-xcode .hljs-selector-tag,.hljs-xcode .hljs-literal{color:#aa0d91}.hljs-xcode .hljs-name{color:#008}.hljs-xcode .hljs-variable,.hljs-xcode .hljs-template-variable{color:#660}.hljs-xcode .hljs-string{color:#c41a16}.hljs-xcode .hljs-regexp,.hljs-xcode .hljs-link{color:#080}.hljs-xcode .hljs-title,.hljs-xcode .hljs-tag,.hljs-xcode .hljs-symbol,.hljs-xcode .hljs-bullet,.hljs-xcode .hljs-number,.hljs-xcode .hljs-meta{color:#1c00cf}.hljs-xcode .hljs-section,.hljs-xcode .hljs-class .hljs-title,.hljs-xcode .hljs-type,.hljs-xcode .hljs-attr,.hljs-xcode .hljs-built_in,.hljs-xcode .hljs-builtin-name,.hljs-xcode .hljs-params{color:#5c2699}.hljs-xcode .hljs-attribute,.hljs-xcode .hljs-subst{color:#000}.hljs-xcode .hljs-formula{background-color:#eee;font-style:italic}.hljs-xcode .hljs-addition{background-color:#baeeba}.hljs-xcode .hljs-deletion{background-color:#ffc8bd}.hljs-xcode .hljs-selector-id,.hljs-xcode .hljs-selector-class{color:#9b703f}.hljs-xcode .hljs-doctag,.hljs-xcode .hljs-strong{font-weight:bold}.hljs-xcode .hljs-emphasis{font-style:italic}.hljs-xt256 .hljs{display:block;overflow-x:auto;color:#eaeaea;background:#000;padding:.5}.hljs-xt256 .hljs-subst{color:#eaeaea}.hljs-xt256 .hljs-emphasis{font-style:italic}.hljs-xt256 .hljs-strong{font-weight:bold}.hljs-xt256 .hljs-builtin-name,.hljs-xt256 .hljs-type{color:#eaeaea}.hljs-xt256 .hljs-params{color:#da0000}.hljs-xt256 .hljs-literal,.hljs-xt256 .hljs-number,.hljs-xt256 .hljs-name{color:#ff0000;font-weight:bolder}.hljs-xt256 .hljs-comment{color:#969896}.hljs-xt256 .hljs-selector-id,.hljs-xt256 .hljs-quote{color:#00ffff}.hljs-xt256 .hljs-template-variable,.hljs-xt256 .hljs-variable,.hljs-xt256 .hljs-title{color:#00ffff;font-weight:bold}.hljs-xt256 .hljs-selector-class,.hljs-xt256 .hljs-keyword,.hljs-xt256 .hljs-symbol{color:#fff000}.hljs-xt256 .hljs-string,.hljs-xt256 .hljs-bullet{color:#00ff00}.hljs-xt256 .hljs-tag,.hljs-xt256 .hljs-section{color:#000fff}.hljs-xt256 .hljs-selector-tag{color:#000fff;font-weight:bold}.hljs-xt256 .hljs-attribute,.hljs-xt256 .hljs-built_in,.hljs-xt256 .hljs-regexp,.hljs-xt256 .hljs-link{color:#ff00ff}.hljs-xt256 .hljs-meta{color:#fff;font-weight:bolder}.hljs-zenburn .hljs{display:block;overflow-x:auto;padding:.5em;background:#3f3f3f;color:#dcdcdc}.hljs-zenburn .hljs-keyword,.hljs-zenburn .hljs-selector-tag,.hljs-zenburn .hljs-tag{color:#e3ceab}.hljs-zenburn .hljs-template-tag{color:#dcdcdc}.hljs-zenburn .hljs-number{color:#8cd0d3}.hljs-zenburn .hljs-variable,.hljs-zenburn .hljs-template-variable,.hljs-zenburn .hljs-attribute{color:#efdcbc}.hljs-zenburn .hljs-literal{color:#efefaf}.hljs-zenburn .hljs-subst{color:#8f8f8f}.hljs-zenburn .hljs-title,.hljs-zenburn .hljs-name,.hljs-zenburn .hljs-selector-id,.hljs-zenburn .hljs-selector-class,.hljs-zenburn .hljs-section,.hljs-zenburn .hljs-type{color:#efef8f}.hljs-zenburn .hljs-symbol,.hljs-zenburn .hljs-bullet,.hljs-zenburn .hljs-link{color:#dca3a3}.hljs-zenburn .hljs-deletion,.hljs-zenburn .hljs-string,.hljs-zenburn .hljs-built_in,.hljs-zenburn .hljs-builtin-name{color:#cc9393}.hljs-zenburn .hljs-addition,.hljs-zenburn .hljs-comment,.hljs-zenburn .hljs-quote,.hljs-zenburn .hljs-meta{color:#7f9f7f}.hljs-zenburn .hljs-emphasis{font-style:italic}.hljs-zenburn .hljs-strong{font-weight:bold}</style>
    <title>Kubernetes Administrator Training </title>
    
    <link rel="stylesheet" href="./Kubernetes Administrator Training_files/workshop.css">
  </head>
  <body class="remark-container">
    <!--
    <div style="position: absolute; left: 20%; right: 20%; top: 30%;">
      <h1 style="font-size: 3em;">Loading ...</h1>
      The slides should show up here. If they don't, it might be
      because you are accessing this file directly from your filesystem.
      It needs to be served from a web server. You can try this:
      <pre>
        docker-compose up -d
        open http://localhost:8888/workshop.html # on MacOS
        xdg-open http://localhost:8888/workshop.html # on Linux
      </pre>
      Once the slides are loaded, this notice disappears when you
      go full screen (e.g. by hitting "f").
    </div>
    -->
    <textarea id="source" style="display: none;">class: title, self-paced

Kubernetes&lt;br/&gt;Administrator&lt;br/&gt;Training&lt;br/&gt;

.nav[*Self-paced version*]

.debug[
```

```

These slides have been built from commit: e0ccfb1


[shared/title.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/title.md)]
---

class: title, in-person

Kubernetes&lt;br/&gt;Administrator&lt;br/&gt;Training&lt;br/&gt;&lt;br/&gt;&lt;/br&gt;

.footnote[
**Be kind to the WiFi!**&lt;br/&gt;
&lt;!-- *Use the 5G network.* --&gt;
*Don't use your hotspot.*&lt;br/&gt;
*Don't stream videos or download big files during the workshop[.](https://www.youtube.com/watch?v=h16zyxiwDLY)*&lt;br/&gt;
*Thank you!*

**Slides: http://wwrk-2019-06.container.training/**
]

.debug[[shared/title.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/title.md)]
---
## Intros

- Hello! We are:

   - .emoji[👷🏻‍♀️] AJ ([@s0ulshake](https://twitter.com/s0ulshake), Travis CI)

   - .emoji[🐳] Jérôme ([@jpetazzo](https://twitter.com/jpetazzo), Tiny Shell Script LLC)

- Feel free to interrupt for questions at any time

- *Especially when you see full screen container pictures!*

- Live feedback, questions, help: [Slack](https://wework.slack.com/messages/CK6PD2EUF/)

  (Let's make sure right now that we all are on that channel!)

.debug[[logistics.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/logistics.md)]
---

## Logistics

Training schedule for the 4 days:

|||
|-------------------|--------------------|
|  9:00am           | Start of training
| 10:30am → 11:00am | Break
| 12:30pm → 1:30pm  | Lunch
| 3:00pm → 3:30pm   | Break
| 5:00pm            | End of training

- Lunch will be catered

- During the breaks, the instructors will be available for Q&amp;A

- Make sure to hydrate / caffeinate / stretch out your limbs :)
.debug[[logistics.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/logistics.md)]
---
## A brief introduction

- This was initially written by [Jérôme Petazzoni](https://twitter.com/jpetazzo) to support in-person,
  instructor-led workshops and tutorials
  
- Credit is also due to [multiple contributors](https://github.com/jpetazzo/container.training/graphs/contributors) — thank you!

- You can also follow along on your own, at your own pace

- We included as much information as possible in these slides

- We recommend having a mentor to help you ...

- ... Or be comfortable spending some time reading the Kubernetes [documentation](https://kubernetes.io/docs/) ...

- ... And looking for answers on [StackOverflow](http://stackoverflow.com/questions/tagged/kubernetes) and other outlets

.debug[[k8s/intro.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/intro.md)]
---

class: self-paced

## Hands on, you shall practice

- Nobody ever became a Jedi by spending their lives reading Wookiepedia

- Likewise, it will take more than merely *reading* these slides
  to make you an expert

- These slides include *tons* of exercises and examples

- They assume that you have access to a Kubernetes cluster

- If you are attending a workshop or tutorial:
  &lt;br/&gt;you will be given specific instructions to access your cluster

- If you are doing this on your own:
  &lt;br/&gt;the first chapter will give you various options to get your own cluster

.debug[[k8s/intro.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/intro.md)]
---
## About these slides

- All the content is available in a public GitHub repository:

  https://github.com/jpetazzo/container.training

- You can get updated "builds" of the slides there:

  http://container.training/

&lt;!--
.exercise[
```open https://github.com/jpetazzo/container.training```
```open http://container.training/```
]
--&gt;

--

- Typos? Mistakes? Questions? Feel free to hover over the bottom of the slide ...

.footnote[.emoji[👇] Try it! The source file will be shown and you can view it on GitHub and fork and edit it.]

&lt;!--
.exercise[
```open https://github.com/jpetazzo/container.training/tree/master/slides/common/about-slides.md```
]
--&gt;

.debug[[shared/about-slides.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/about-slides.md)]
---

class: extra-details

## Extra details

- This slide has a little magnifying glass in the top left corner

- This magnifying glass indicates slides that provide extra details

- Feel free to skip them if:

  - you are in a hurry

  - you are new to this and want to avoid cognitive overload

  - you want only the most essential information

- You can review these slides another time if you want, they'll be waiting for you ☺

.debug[[shared/about-slides.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/about-slides.md)]
---

name: toc-chapter-1

## Chapter 1

- [Pre-requirements](#toc-pre-requirements)

- [Our sample application](#toc-our-sample-application)

- [Kubernetes concepts](#toc-kubernetes-concepts)

- [Declarative vs imperative](#toc-declarative-vs-imperative)

- [Kubernetes network model](#toc-kubernetes-network-model)

.debug[(auto-generated TOC)]
---
name: toc-chapter-2

## Chapter 2

- [First contact with `kubectl`](#toc-first-contact-with-kubectl)

- [Setting up Kubernetes](#toc-setting-up-kubernetes)

- [Running our first containers on Kubernetes](#toc-running-our-first-containers-on-kubernetes)

.debug[(auto-generated TOC)]
---
name: toc-chapter-3

## Chapter 3

- [Exposing containers](#toc-exposing-containers)

- [Shipping images with a registry](#toc-shipping-images-with-a-registry)

- [Running our application on Kubernetes](#toc-running-our-application-on-kubernetes)

- [Scaling our demo app](#toc-scaling-our-demo-app)

- [Daemon sets](#toc-daemon-sets)

- [Labels and selectors](#toc-labels-and-selectors)

.debug[(auto-generated TOC)]
---
name: toc-chapter-4

## Chapter 4

- [Rolling updates](#toc-rolling-updates)

- [Healthchecks](#toc-healthchecks)

- [Owners and dependents (extra material)](#toc-owners-and-dependents-extra-material)

.debug[(auto-generated TOC)]
---
name: toc-chapter-5

## Chapter 5

- [Accessing the API with `kubectl proxy`](#toc-accessing-the-api-with-kubectl-proxy)

- [Controlling the cluster remotely](#toc-controlling-the-cluster-remotely)

- [Accessing internal services](#toc-accessing-internal-services)

- [The Kubernetes dashboard](#toc-the-kubernetes-dashboard)

- [Security implications of `kubectl apply`](#toc-security-implications-of-kubectl-apply)

- [Exposing HTTP services with Ingress resources](#toc-exposing-http-services-with-ingress-resources)

.debug[(auto-generated TOC)]
---
name: toc-chapter-6

## Chapter 6

- [Volumes](#toc-volumes)

- [Managing configuration](#toc-managing-configuration)

- [Accessing logs from the CLI](#toc-accessing-logs-from-the-cli)

- [Centralized logging](#toc-centralized-logging)

.debug[(auto-generated TOC)]
---
name: toc-chapter-7

## Chapter 7

- [Namespaces](#toc-namespaces)

- [Kustomize](#toc-kustomize)

- [Managing stacks with Helm](#toc-managing-stacks-with-helm)

- [Collecting metrics with Prometheus](#toc-collecting-metrics-with-prometheus)

.debug[(auto-generated TOC)]
---
name: toc-chapter-8

## Chapter 8

- [Resource Limits](#toc-resource-limits)

- [Defining min, max, and default resources](#toc-defining-min-max-and-default-resources)

- [Namespace quotas](#toc-namespace-quotas)

- [Limiting resources in practice](#toc-limiting-resources-in-practice)

- [Checking pod and node resource usage](#toc-checking-pod-and-node-resource-usage)

- [Cluster sizing](#toc-cluster-sizing)

- [The Horizontal Pod Autoscaler](#toc-the-horizontal-pod-autoscaler)

.debug[(auto-generated TOC)]
---
name: toc-chapter-9

## Chapter 9

- [Additional lab environments](#toc-additional-lab-environments)

- [Kubernetes architecture deep dive](#toc-kubernetes-architecture-deep-dive)

- [The Kubernetes API](#toc-the-kubernetes-api)

- [Other control plane components](#toc-other-control-plane-components)

- [Building our own cluster](#toc-building-our-own-cluster)

.debug[(auto-generated TOC)]
---
name: toc-chapter-10

## Chapter 10

- [Adding nodes to the cluster](#toc-adding-nodes-to-the-cluster)

- [The Container Network Interface](#toc-the-container-network-interface)

- [Interconnecting clusters](#toc-interconnecting-clusters)

.debug[(auto-generated TOC)]
---
name: toc-chapter-11

## Chapter 11

- [Installing a managed cluster](#toc-installing-a-managed-cluster)

- [Kubernetes distributions and installers](#toc-kubernetes-distributions-and-installers)

- [Static pods](#toc-static-pods)

.debug[(auto-generated TOC)]
---
name: toc-chapter-12

## Chapter 12

- [API server availability](#toc-api-server-availability)

- [Upgrading clusters](#toc-upgrading-clusters)

- [Backing up clusters](#toc-backing-up-clusters)

- [The Cloud Controller Manager](#toc-the-cloud-controller-manager)

.debug[(auto-generated TOC)]
---
name: toc-chapter-13

## Chapter 13

- [Authentication and authorization](#toc-authentication-and-authorization)

- [The CSR API](#toc-the-csr-api)

- [OpenID Connect](#toc-openid-connect)

.debug[(auto-generated TOC)]
---
name: toc-chapter-14

## Chapter 14

- [Securing the control plane](#toc-securing-the-control-plane)

- [TLS bootstrap (extra material)](#toc-tls-bootstrap-extra-material)

- [Network policies](#toc-network-policies)

- [Pod Security Policies](#toc-pod-security-policies)

.debug[(auto-generated TOC)]
---
name: toc-chapter-15

## Chapter 15

- [Extending the Kubernetes API](#toc-extending-the-kubernetes-api)

- [Operators](#toc-operators)

.debug[(auto-generated TOC)]
---
name: toc-chapter-16

## Chapter 16

- [Stateful sets](#toc-stateful-sets)

- [Running a Consul cluster](#toc-running-a-consul-cluster)

- [Local Persistent Volumes](#toc-local-persistent-volumes)

- [Highly available Persistent Volumes](#toc-highly-available-persistent-volumes)

.debug[(auto-generated TOC)]
---
name: toc-chapter-17

## Chapter 17

- [What's next?](#toc-whats-next)

- [Links and resources](#toc-links-and-resources)

.debug[(auto-generated TOC)]



.debug[[shared/toc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/toc.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg)]

---

name: toc-pre-requirements
class: title

Pre-requirements

.nav[
[Previous section](#toc-)
|
[Back to table of contents](#toc-chapter-1)
|
[Next section](#toc-our-sample-application)
]

.debug[(automatically generated title slide)]

---
# Pre-requirements

- Be comfortable with the UNIX command line

  - navigating directories

  - editing files

  - a little bit of bash-fu (environment variables, loops)

- Some Docker knowledge

  - `docker run`, `docker ps`, `docker build`

  - ideally, you know how to write a Dockerfile and build it
    &lt;br/&gt;
    (even if it's a `FROM` line and a couple of `RUN` commands)

- It's totally OK if you are not a Docker expert!

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: title

*Tell me and I forget.*
&lt;br/&gt;
*Teach me and I remember.*
&lt;br/&gt;
*Involve me and I learn.*

Misattributed to Benjamin Franklin

[(Probably inspired by Chinese Confucian philosopher Xunzi)](https://www.barrypopik.com/index.php/new_york_city/entry/tell_me_and_i_forget_teach_me_and_i_may_remember_involve_me_and_i_will_lear/)

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

## Hands-on sections

- The whole workshop is hands-on

- We are going to build, ship, and run containers!

- You are invited to reproduce all the demos

- All hands-on sections are clearly identified, like the gray rectangle below

.exercise[

- This is the stuff you're supposed to do!

- Go to http://wwrk-2019-06.container.training/ to view these slides

- Join the chat room: [Slack](https://wework.slack.com/messages/CK6PD2EUF/)

&lt;!-- ```open http://wwrk-2019-06.container.training/``` --&gt;

]

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: in-person

## Where are we going to run our containers?

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: in-person, pic

![You get a cluster](images/you-get-a-cluster.jpg)

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: in-person

## You get a cluster of cloud VMs

- Each person gets a private cluster of cloud VMs (not shared with anybody else)

- They'll remain up for the duration of the workshop

- You should have a little card with login+password+IP addresses

- You can automatically SSH from one VM to another

- The nodes have aliases: `node1`, `node2`, etc.

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: in-person

## Why don't we run containers locally?

- Installing this stuff can be hard on some machines

  (32 bits CPU or OS... Laptops without administrator access... etc.)

- *"The whole team downloaded all these container images from the WiFi!
  &lt;br/&gt;... and it went great!"* (Literally no-one ever)

- All you need is a computer (or even a phone or tablet!), with:

  - an internet connection

  - a web browser

  - an SSH client

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: in-person

## SSH clients

- On Linux, OS X, FreeBSD... you are probably all set

- On Windows, get one of these:

  - [putty](http://www.putty.org/)
  - Microsoft [Win32 OpenSSH](https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH)
  - [Git BASH](https://git-for-windows.github.io/)
  - [MobaXterm](http://mobaxterm.mobatek.net/)

- On Android, [JuiceSSH](https://juicessh.com/)
  ([Play Store](https://play.google.com/store/apps/details?id=com.sonelli.juicessh))
  works pretty well

- Nice-to-have: [Mosh](https://mosh.org/) instead of SSH, if your internet connection tends to lose packets

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: in-person, extra-details

## What is this Mosh thing?

*You don't have to use Mosh or even know about it to follow along.
&lt;br/&gt;
We're just telling you about it because some of us think it's cool!*

- Mosh is "the mobile shell"

- It is essentially SSH over UDP, with roaming features

- It retransmits packets quickly, so it works great even on lossy connections

  (Like hotel or conference WiFi)

- It has intelligent local echo, so it works great even in high-latency connections

  (Like hotel or conference WiFi)

- It supports transparent roaming when your client IP address changes

  (Like when you hop from hotel to conference WiFi)

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---

class: in-person, extra-details

## Using Mosh

- To install it: `(apt|yum|brew) install mosh`

- It has been pre-installed on the VMs that we are using

- To connect to a remote machine: `mosh user@host`

  (It is going to establish an SSH connection, then hand off to UDP)

- It requires UDP ports to be open

  (By default, it uses a UDP port between 60000 and 61000)

.debug[[shared/prereqs.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md)]
---
class: in-person

## Connecting to our lab environment

.exercise[

- Log into the first VM (`node1`) with your SSH client

&lt;!--
```bash
for N in $(awk '/\Wnode/{print $2}' /etc/hosts); do
  ssh -o StrictHostKeyChecking=no $N true
done
```

```bash
### FIXME find a way to reset the cluster, maybe?
```
--&gt;

- Check that you can SSH (without password) to `node2`:
  ```bash
  ssh node2
  ```
- Type `exit` or `^D` to come back to `node1`

&lt;!-- ```bash exit``` --&gt;

]

If anything goes wrong — ask for help!

.debug[[shared/connecting.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md)]
---

## Doing or re-doing the workshop on your own?

- Use something like
  [Play-With-Docker](http://play-with-docker.com/) or
  [Play-With-Kubernetes](https://training.play-with-kubernetes.com/)

  Zero setup effort; but environment are short-lived and
  might have limited resources

- Create your own cluster (local or cloud VMs)

  Small setup effort; small cost; flexible environments

- Create a bunch of clusters for you and your friends
    ([instructions](https://github.com/jpetazzo/container.training/tree/master/prepare-vms))

  Bigger setup effort; ideal for group training

.debug[[shared/connecting.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md)]
---

class: self-paced

## Get your own Docker nodes

- If you already have some Docker nodes: great!

- If not: let's get some thanks to Play-With-Docker

.exercise[

- Go to http://www.play-with-docker.com/

- Log in

- Create your first node

&lt;!-- ```open http://www.play-with-docker.com/``` --&gt;

]

You will need a Docker ID to use Play-With-Docker.

(Creating a Docker ID is free.)

.debug[[shared/connecting.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md)]
---

## We will (mostly) interact with node1 only

*These remarks apply only when using multiple nodes, of course.*

- Unless instructed, **all commands must be run from the first VM, `node1`**

- We will only check out/copy the code on `node1`

- During normal operations, we do not need access to the other nodes

- If we had to troubleshoot issues, we would use a combination of:

  - SSH (to access system logs, daemon status...)

  - Docker API (to check running containers and container engine status)

.debug[[shared/connecting.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md)]
---

## Terminals

Once in a while, the instructions will say:
&lt;br/&gt;"Open a new terminal."

There are multiple ways to do this:

- create a new window or tab on your machine, and SSH into the VM;

- use screen or tmux on the VM and open a new window from there.

You are welcome to use the method that you feel the most comfortable with.

.debug[[shared/connecting.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md)]
---

## Tmux cheatsheet

[Tmux](https://en.wikipedia.org/wiki/Tmux) is a terminal multiplexer like `screen`.

*You don't have to use it or even know about it to follow along.
&lt;br/&gt;
But some of us like to use it to switch between terminals.
&lt;br/&gt;
It has been preinstalled on your workshop nodes.*

- Ctrl-b c → creates a new window
- Ctrl-b n → go to next window
- Ctrl-b p → go to previous window
- Ctrl-b " → split window top/bottom
- Ctrl-b % → split window left/right
- Ctrl-b Alt-1 → rearrange windows in columns
- Ctrl-b Alt-2 → rearrange windows in rows
- Ctrl-b arrows → navigate to other windows
- Ctrl-b d → detach session
- tmux attach → reattach to session

.debug[[shared/connecting.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md)]
---
## Versions installed

- Kubernetes 1.14.2
- Docker Engine 18.09.6
- Docker Compose 1.21.1

&lt;!-- ##VERSION## --&gt;

.exercise[

- Check all installed versions:
  ```bash
  kubectl version
  docker version
  docker-compose -v
  ```

]

.debug[[k8s/versions-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/versions-k8s.md)]
---

class: extra-details

## Kubernetes and Docker compatibility

- Kubernetes 1.14 validates Docker Engine versions [up to 18.09](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.14.md#external-dependencies)
  &lt;br/&gt;
  (the latest version when Kubernetes 1.14 was released)

- Kubernetes 1.13 only validates Docker Engine versions [up to 18.06](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md#external-dependencies)

- Is it a problem if I use Kubernetes with a "too recent" Docker Engine?

--

class: extra-details

- No!

- "Validates" = continuous integration builds with very extensive (and expensive) testing

- The Docker API is versioned, and offers strong backward-compatibility

  (If a client uses e.g. API v1.25, the Docker Engine will keep behaving the same way)

.debug[[k8s/versions-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/versions-k8s.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/ShippingContainerSFBay.jpg)]

---

name: toc-our-sample-application
class: title

Our sample application

.nav[
[Previous section](#toc-pre-requirements)
|
[Back to table of contents](#toc-chapter-1)
|
[Next section](#toc-kubernetes-concepts)
]

.debug[(automatically generated title slide)]

---
# Our sample application

- We will clone the GitHub repository onto our `node1`

- The repository also contains scripts and tools that we will use through the workshop

.exercise[

&lt;!--
```bash
cd ~
if [ -d container.training ]; then
  mv container.training container.training.$RANDOM
fi
```
--&gt;

- Clone the repository on `node1`:
  ```bash
  git clone https://github.com/jpetazzo/container.training
  ```

]

(You can also fork the repository on GitHub and clone your fork if you prefer that.)

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## Downloading and running the application

Let's start this before we look around, as downloading will take a little time...

.exercise[

- Go to the `dockercoins` directory, in the cloned repo:
  ```bash
  cd ~/container.training/dockercoins
  ```

- Use Compose to build and run all containers:
  ```bash
  docker-compose up
  ```

&lt;!--
```longwait units of work done```
--&gt;

]

Compose tells Docker to build all container images (pulling
the corresponding base images), then starts all containers,
and displays aggregated logs.

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## What's this application?

--

- It is a DockerCoin miner! .emoji[💰🐳📦🚢]

--

- No, you can't buy coffee with DockerCoins

--

- How DockerCoins works:

  - generate a few random bytes

  - hash these bytes

  - increment a counter (to keep track of speed)

  - repeat forever!

--

- DockerCoins is *not* a cryptocurrency

  (the only common points are "randomness", "hashing", and "coins" in the name)

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## DockerCoins in the microservices era

- DockerCoins is made of 5 services:

  - `rng` = web service generating random bytes

  - `hasher` = web service computing hash of POSTed data

  - `worker` = background process calling `rng` and `hasher`

  - `webui` = web interface to watch progress

  - `redis` = data store (holds a counter updated by `worker`)

- These 5 services are visible in the application's Compose file,
  [docker-compose.yml](
  https://github.com/jpetazzo/container.training/blob/master/dockercoins/docker-compose.yml)

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## How DockerCoins works

- `worker` invokes web service `rng` to generate random bytes

- `worker` invokes web service `hasher` to hash these bytes

- `worker` does this in an infinite loop

- every second, `worker` updates `redis` to indicate how many loops were done

- `webui` queries `redis`, and computes and exposes "hashing speed" in our browser

*(See diagram on next slide!)*

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

class: pic

![Diagram showing the 5 containers of the applications](images/dockercoins-diagram.svg)

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## Service discovery in container-land

How does each service find out the address of the other ones?

--

- We do not hard-code IP addresses in the code

- We do not hard-code FQDNs in the code, either

- We just connect to a service name, and container-magic does the rest

  (And by container-magic, we mean "a crafty, dynamic, embedded DNS server")

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## Example in `worker/worker.py`

```python
redis = Redis("`redis`")


def get_random_bytes():
    r = requests.get("http://`rng`/32")
    return r.content


def hash_bytes(data):
    r = requests.post("http://`hasher`/",
                      data=data,
                      headers={"Content-Type": "application/octet-stream"})
```

(Full source code available [here](
https://github.com/jpetazzo/container.training/blob/8279a3bce9398f7c1a53bdd95187c53eda4e6435/dockercoins/worker/worker.py#L17
))

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

class: extra-details

## Links, naming, and service discovery

- Containers can have network aliases (resolvable through DNS)

- Compose file version 2+ makes each container reachable through its service name

- Compose file version 1 required "links" sections to accomplish this

- Network aliases are automatically namespaced

  - you can have multiple apps declaring and using a service named `database`

  - containers in the blue app will resolve `database` to the IP of the blue database

  - containers in the green app will resolve `database` to the IP of the green database

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## Show me the code!

- You can check the GitHub repository with all the materials of this workshop:
  &lt;br/&gt;https://github.com/jpetazzo/container.training

- The application is in the [dockercoins](
  https://github.com/jpetazzo/container.training/tree/master/dockercoins)
  subdirectory

- The Compose file ([docker-compose.yml](
  https://github.com/jpetazzo/container.training/blob/master/dockercoins/docker-compose.yml))
  lists all 5 services

- `redis` is using an official image from the Docker Hub

- `hasher`, `rng`, `worker`, `webui` are each built from a Dockerfile

- Each service's Dockerfile and source code is in its own directory

  (`hasher` is in the [hasher](https://github.com/jpetazzo/container.training/blob/master/dockercoins/hasher/) directory,
  `rng` is in the [rng](https://github.com/jpetazzo/container.training/blob/master/dockercoins/rng/)
  directory, etc.)

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

class: extra-details

## Compose file format version

*This is relevant only if you have used Compose before 2016...*

- Compose 1.6 introduced support for a new Compose file format (aka "v2")

- Services are no longer at the top level, but under a `services` section

- There has to be a `version` key at the top level, with value `"2"` (as a string, not an integer)

- Containers are placed on a dedicated network, making links unnecessary

- There are other minor differences, but upgrade is easy and straightforward

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## Our application at work

- On the left-hand side, the "rainbow strip" shows the container names

- On the right-hand side, we see the output of our containers

- We can see the `worker` service making requests to `rng` and `hasher`

- For `rng` and `hasher`, we see HTTP access logs

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## Connecting to the web UI

- "Logs are exciting and fun!" (No-one, ever)

- The `webui` container exposes a web dashboard; let's view it

.exercise[

- With a web browser, connect to `node1` on port 8000

- Remember: the `nodeX` aliases are valid only on the nodes themselves

- In your browser, you need to enter the IP address of your node

&lt;!-- ```open http://node1:8000``` --&gt;

]

A drawing area should show up, and after a few seconds, a blue
graph will appear.

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

class: self-paced, extra-details

## If the graph doesn't load

If you just see a `Page not found` error, it might be because your
Docker Engine is running on a different machine. This can be the case if:

- you are using the Docker Toolbox

- you are using a VM (local or remote) created with Docker Machine

- you are controlling a remote Docker Engine

When you run DockerCoins in development mode, the web UI static files
are mapped to the container using a volume. Alas, volumes can only
work on a local environment, or when using Docker Desktop for Mac or Windows.

How to fix this?

Stop the app with `^C`, edit `dockercoins.yml`, comment out the `volumes` section, and try again.

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

class: extra-details

## Why does the speed seem irregular?

- It *looks like* the speed is approximately 4 hashes/second

- Or more precisely: 4 hashes/second, with regular dips down to zero

- Why?

--

class: extra-details

- The app actually has a constant, steady speed: 3.33 hashes/second
  &lt;br/&gt;
  (which corresponds to 1 hash every 0.3 seconds, for *reasons*)

- Yes, and?

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

class: extra-details

## The reason why this graph is *not awesome*

- The worker doesn't update the counter after every loop, but up to once per second

- The speed is computed by the browser, checking the counter about once per second

- Between two consecutive updates, the counter will increase either by 4, or by 0

- The perceived speed will therefore be 4 - 4 - 4 - 0 - 4 - 4 - 0 etc.

- What can we conclude from this?

--

class: extra-details

- "I'm clearly incapable of writing good frontend code!" 😀 — Jérôme

.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---

## Stopping the application

- If we interrupt Compose (with `^C`), it will politely ask the Docker Engine to stop the app

- The Docker Engine will send a `TERM` signal to the containers

- If the containers do not exit in a timely manner, the Engine sends a `KILL` signal

.exercise[

- Stop the application by hitting `^C`

&lt;!--
```keys ^C```
--&gt;

]

--

Some containers exit immediately, others take longer.

The containers that do not handle `SIGTERM` end up being killed after a 10s timeout. If we are very impatient, we can hit `^C` a second time!


.debug[[shared/sampleapp.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md)]
---
## Clean up

- Before moving on, let's remove those containers

.exercise[

- Tell Compose to remove everything:
  ```bash
  docker-compose down
  ```

]

.debug[[shared/composedown.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/composedown.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/aerial-view-of-containers.jpg)]

---

name: toc-kubernetes-concepts
class: title

Kubernetes concepts

.nav[
[Previous section](#toc-our-sample-application)
|
[Back to table of contents](#toc-chapter-1)
|
[Next section](#toc-declarative-vs-imperative)
]

.debug[(automatically generated title slide)]

---
# Kubernetes concepts

- Kubernetes is a container management system

- It runs and manages containerized applications on a cluster

--

- What does that really mean?

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Basic things we can ask Kubernetes to do

--

- Start 5 containers using image `atseashop/api:v1.3`

--

- Place an internal load balancer in front of these containers

--

- Start 10 containers using image `atseashop/webfront:v1.3`

--

- Place a public load balancer in front of these containers

--

- It's Black Friday (or Christmas), traffic spikes, grow our cluster and add containers

--

- New release! Replace my containers with the new image `atseashop/webfront:v1.4`

--

- Keep processing requests during the upgrade; update my containers one at a time

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Other things that Kubernetes can do for us

- Basic autoscaling

- Blue/green deployment, canary deployment

- Long running services, but also batch (one-off) jobs

- Overcommit our cluster and *evict* low-priority jobs

- Run services with *stateful* data (databases etc.)

- Fine-grained access control defining *what* can be done by *whom* on *which* resources

- Integrating third party services (*service catalog*)

- Automating complex tasks (*operators*)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Kubernetes architecture

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: pic

![haha only kidding](images/k8s-arch1.png)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Kubernetes architecture

- Ha ha ha ha

- OK, I was trying to scare you, it's much simpler than that ❤️

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: pic

![that one is more like the real thing](images/k8s-arch2.png)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Credits

- The first schema is a Kubernetes cluster with storage backed by multi-path iSCSI

  (Courtesy of [Yongbok Kim](https://www.yongbok.net/blog/))

- The second one is a simplified representation of a Kubernetes cluster

  (Courtesy of [Imesh Gunaratne](https://medium.com/containermind/a-reference-architecture-for-deploying-wso2-middleware-on-kubernetes-d4dee7601e8e))

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Kubernetes architecture: the nodes

- The nodes executing our containers run a collection of services:

  - a container Engine (typically Docker)

  - kubelet (the "node agent")

  - kube-proxy (a necessary but not sufficient network component)

- Nodes were formerly called "minions"

  (You might see that word in older articles or documentation)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Kubernetes architecture: the control plane

- The Kubernetes logic (its "brains") is a collection of services:

  - the API server (our point of entry to everything!)

  - core services like the scheduler and controller manager

  - `etcd` (a highly available key/value store; the "database" of Kubernetes)

- Together, these services form the control plane of our cluster

- The control plane is also called the "master"

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: pic

![One of the best Kubernetes architecture diagrams available](images/k8s-arch4-thanks-luxas.png)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: extra-details

## Running the control plane on special nodes

- It is common to reserve a dedicated node for the control plane

  (Except for single-node development clusters, like when using minikube)

- This node is then called a "master"

  (Yes, this is ambiguous: is the "master" a node, or the whole control plane?)

- Normal applications are restricted from running on this node

  (By using a mechanism called ["taints"](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/))

- When high availability is required, each service of the control plane must be resilient

- The control plane is then replicated on multiple nodes

  (This is sometimes called a "multi-master" setup)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: extra-details

## Running the control plane outside containers

- The services of the control plane can run in or out of containers

- For instance: since `etcd` is a critical service, some people
  deploy it directly on a dedicated cluster (without containers)

  (This is illustrated on the first "super complicated" schema)

- In some hosted Kubernetes offerings (e.g. AKS, GKE, EKS), the control plane is invisible

  (We only "see" a Kubernetes API endpoint)

- In that case, there is no "master node"

*For this reason, it is more accurate to say "control plane" rather than "master."*

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: extra-details

## Do we need to run Docker at all?

No!

--

- By default, Kubernetes uses the Docker Engine to run containers

- We could also use `rkt` ("Rocket") from CoreOS

- Or leverage other pluggable runtimes through the *Container Runtime Interface*

  (like CRI-O, or containerd)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: extra-details

## Do we need to run Docker at all?

Yes!

--

- In this workshop, we run our app on a single node first

- We will need to build images and ship them around

- We can do these things without Docker
  &lt;br/&gt;
  (and get diagnosed with NIH¹ syndrome)

- Docker is still the most stable container engine today
  &lt;br/&gt;
  (but other options are maturing very quickly)

.footnote[¹[Not Invented Here](https://en.wikipedia.org/wiki/Not_invented_here)]

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: extra-details

## Do we need to run Docker at all?

- On our development environments, CI pipelines ... :

  *Yes, almost certainly*

- On our production servers:

  *Yes (today)*

  *Probably not (in the future)*

.footnote[More information about CRI [on the Kubernetes blog](https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes)]

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Interacting with Kubernetes

- We will interact with our Kubernetes cluster through the Kubernetes API

- The Kubernetes API is (mostly) RESTful

- It allows us to create, read, update, delete *resources*

- A few common resource types are:

  - node (a machine — physical or virtual — in our cluster)

  - pod (group of containers running together on a node)

  - service (stable network endpoint to connect to one or multiple containers)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: pic

![Node, pod, container](images/k8s-arch3-thanks-weave.png)

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

## Credits

- The first diagram is courtesy of Lucas Käldström, in [this presentation](https://speakerdeck.com/luxas/kubeadm-cluster-creation-internals-from-self-hosting-to-upgradability-and-ha)

  - it's one of the best Kubernetes architecture diagrams available!

- The second diagram is courtesy of Weave Works

  - a *pod* can have multiple containers working together

  - IP addresses are associated with *pods*, not with individual containers

Both diagrams used with permission.

.debug[[k8s/concepts-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/blue-containers.jpg)]

---

name: toc-declarative-vs-imperative
class: title

Declarative vs imperative

.nav[
[Previous section](#toc-kubernetes-concepts)
|
[Back to table of contents](#toc-chapter-1)
|
[Next section](#toc-kubernetes-network-model)
]

.debug[(automatically generated title slide)]

---
# Declarative vs imperative

- Our container orchestrator puts a very strong emphasis on being *declarative*

- Declarative:

  *I would like a cup of tea.*

- Imperative:

  *Boil some water. Pour it in a teapot. Add tea leaves. Steep for a while. Serve in a cup.*

--

- Declarative seems simpler at first ... 

--

- ... As long as you know how to brew tea

.debug[[shared/declarative.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/declarative.md)]
---

## Declarative vs imperative

- What declarative would really be:

  *I want a cup of tea, obtained by pouring an infusion¹ of tea leaves in a cup.*

--

  *¹An infusion is obtained by letting the object steep a few minutes in hot² water.*

--

  *²Hot liquid is obtained by pouring it in an appropriate container³ and setting it on a stove.*

--

  *³Ah, finally, containers! Something we know about. Let's get to work, shall we?*

--

.footnote[Did you know there was an [ISO standard](https://en.wikipedia.org/wiki/ISO_3103)
specifying how to brew tea?]

.debug[[shared/declarative.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/declarative.md)]
---

## Declarative vs imperative

- Imperative systems:

  - simpler

  - if a task is interrupted, we have to restart from scratch

- Declarative systems:

  - if a task is interrupted (or if we show up to the party half-way through),
    we can figure out what's missing and do only what's necessary

  - we need to be able to *observe* the system

  - ... and compute a "diff" between *what we have* and *what we want*

.debug[[shared/declarative.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/declarative.md)]
---
## Declarative vs imperative in Kubernetes

- With Kubernetes, we cannot say: "run this container"

- All we can do is write a *spec* and push it to the API server

  (by creating a resource like e.g. a Pod or a Deployment)

- The API server will validate that spec (and reject it if it's invalid)

- Then it will store it in etcd

- A *controller* will "notice" that spec and act upon it

.debug[[k8s/declarative.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/declarative.md)]
---

## Reconciling state

- Watch for the `spec` fields in the YAML files later!

- The *spec* describes *how we want the thing to be*

- Kubernetes will *reconcile* the current state with the spec
  &lt;br/&gt;(technically, this is done by a number of *controllers*)

- When we want to change some resource, we update the *spec*

- Kubernetes will then *converge* that resource

.debug[[k8s/declarative.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/declarative.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/chinook-helicopter-container.jpg)]

---

name: toc-kubernetes-network-model
class: title

Kubernetes network model

.nav[
[Previous section](#toc-declarative-vs-imperative)
|
[Back to table of contents](#toc-chapter-1)
|
[Next section](#toc-first-contact-with-kubectl)
]

.debug[(automatically generated title slide)]

---
# Kubernetes network model

- TL,DR:

  *Our cluster (nodes and pods) is one big flat IP network.*

--

- In detail:

 - all nodes must be able to reach each other, without NAT

 - all pods must be able to reach each other, without NAT

 - pods and nodes must be able to reach each other, without NAT

 - each pod is aware of its IP address (no NAT)

 - pod IP addresses are assigned by the network implementation

- Kubernetes doesn't mandate any particular implementation

.debug[[k8s/kubenet.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md)]
---

## Kubernetes network model: the good

- Everything can reach everything

- No address translation

- No port translation

- No new protocol

- The network implementation can decide how to allocate addresses

- IP addresses don't have to be "portable" from a node to another

  (We can use e.g. a subnet per node and use a simple routed topology)

- The specification is simple enough to allow many various implementations

.debug[[k8s/kubenet.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md)]
---

## Kubernetes network model: the less good

- Everything can reach everything

  - if you want security, you need to add network policies

  - the network implementation that you use needs to support them

- There are literally dozens of implementations out there

  (15 are listed in the Kubernetes documentation)

- Pods have level 3 (IP) connectivity, but *services* are level 4 (TCP or UDP)

  (Services map to a single UDP or TCP port; no port ranges or arbitrary IP packets)

- `kube-proxy` is on the data path when connecting to a pod or container,
  &lt;br/&gt;and it's not particularly fast (relies on userland proxying or iptables)

.debug[[k8s/kubenet.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md)]
---

## Kubernetes network model: in practice

- The nodes that we are using have been set up to use [Weave](https://github.com/weaveworks/weave)

- We don't endorse Weave in a particular way, it just Works For Us

- Don't worry about the warning about `kube-proxy` performance

- Unless you:

  - routinely saturate 10G network interfaces
  - count packet rates in millions per second
  - run high-traffic VOIP or gaming platforms
  - do weird things that involve millions of simultaneous connections
    &lt;br/&gt;(in which case you're already familiar with kernel tuning)

- If necessary, there are alternatives to `kube-proxy`; e.g.
  [`kube-router`](https://www.kube-router.io)

.debug[[k8s/kubenet.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md)]
---

class: extra-details

## The Container Network Interface (CNI)

- Most Kubernetes clusters use CNI "plugins" to implement networking

- When a pod is created, Kubernetes delegates the network setup to these plugins

  (it can be a single plugin, or a combination of plugins, each doing one task)

- Typically, CNI plugins will:

  - allocate an IP address (by calling an IPAM plugin)

  - add a network interface into the pod's network namespace

  - configure the interface as well as required routes etc.

.debug[[k8s/kubenet.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md)]
---

class: extra-details

## Multiple moving parts

- The "pod-to-pod network" or "pod network":

  - provides communication between pods and nodes

  - is generally implemented with CNI plugins

- The "pod-to-service network":

  - provides internal communication and load balancing

  - is generally implemented with kube-proxy (or e.g. kube-router)

- Network policies:

  - provide firewalling and isolation

  - can be bundled with the "pod network" or provided by another component

.debug[[k8s/kubenet.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md)]
---

class: extra-details

## Even more moving parts

- Inbound traffic can be handled by multiple components:

  - something like kube-proxy or kube-router (for NodePort services)

  - load balancers (ideally, connected to the pod network)

- It is possible to use multiple pod networks in parallel

  (with "meta-plugins" like CNI-Genie or Multus)

- Some solutions can fill multiple roles

  (e.g. kube-router can be set up to provide the pod network and/or network policies and/or replace kube-proxy)

.debug[[k8s/kubenet.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-cranes.jpg)]

---

name: toc-first-contact-with-kubectl
class: title

First contact with `kubectl`

.nav[
[Previous section](#toc-kubernetes-network-model)
|
[Back to table of contents](#toc-chapter-2)
|
[Next section](#toc-setting-up-kubernetes)
]

.debug[(automatically generated title slide)]

---
# First contact with `kubectl`

- `kubectl` is (almost) the only tool we'll need to talk to Kubernetes

- It is a rich CLI tool around the Kubernetes API

  (Everything you can do with `kubectl`, you can do directly with the API)

- On our machines, there is a `~/.kube/config` file with:

  - the Kubernetes API address

  - the path to our TLS certificates used to authenticate

- You can also use the `--kubeconfig` flag to pass a config file

- Or directly `--server`, `--user`, etc.

- `kubectl` can be pronounced "Cube C T L", "Cube cuttle", "Cube cuddle"...

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## `kubectl get`

- Let's look at our `Node` resources with `kubectl get`!

.exercise[

- Look at the composition of our cluster:
  ```bash
  kubectl get node
  ```

- These commands are equivalent:
  ```bash
  kubectl get no
  kubectl get node
  kubectl get nodes
  ```

]

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Obtaining machine-readable output

- `kubectl get` can output JSON, YAML, or be directly formatted

.exercise[

- Give us more info about the nodes:
  ```bash
  kubectl get nodes -o wide
  ```

- Let's have some YAML:
  ```bash
  kubectl get no -o yaml
  ```
  See that `kind: List` at the end? It's the type of our result!

]

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## (Ab)using `kubectl` and `jq`

- It's super easy to build custom reports

.exercise[

- Show the capacity of all our nodes as a stream of JSON objects:
  ```bash
    kubectl get nodes -o json | 
            jq ".items[] | {name:.metadata.name} + .status.capacity"
  ```

]

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: extra-details

## Exploring types and definitions

- We can list all available resource types by running `kubectl api-resources`
  &lt;br/&gt;
  (In Kubernetes 1.10 and prior, this command used to be `kubectl get`)

- We can view the definition for a resource type with:
  ```bash
  kubectl explain type
  ```

- We can view the definition of a field in a resource, for instance:
  ```bash
  kubectl explain node.spec
  ```

- Or get the full definition of all fields and sub-fields:
  ```bash
  kubectl explain node --recursive
  ```

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: extra-details

## Introspection vs. documentation

- We can access the same information by reading the [API documentation](https://kubernetes.io/docs/reference/#api-reference)

- The API documentation is usually easier to read, but:

  - it won't show custom types (like Custom Resource Definitions)

  - we need to make sure that we look at the correct version

- `kubectl api-resources` and `kubectl explain` perform *introspection*

  (they communicate with the API server and obtain the exact type definitions)

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Type names

- The most common resource names have three forms:

  - singular (e.g. `node`, `service`, `deployment`)

  - plural (e.g. `nodes`, `services`, `deployments`)

  - short (e.g. `no`, `svc`, `deploy`)

- Some resources do not have a short name

- `Endpoints` only have a plural form

  (because even a single `Endpoints` resource is actually a list of endpoints)

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Viewing details

- We can use `kubectl get -o yaml` to see all available details

- However, YAML output is often simultaneously too much and not enough

- For instance, `kubectl get node node1 -o yaml` is:

  - too much information (e.g.: list of images available on this node)

  - not enough information (e.g.: doesn't show pods running on this node)

  - difficult to read for a human operator

- For a comprehensive overview, we can use `kubectl describe` instead

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## `kubectl describe`

- `kubectl describe` needs a resource type and (optionally) a resource name

- It is possible to provide a resource name *prefix*

  (all matching objects will be displayed)

- `kubectl describe` will retrieve some extra information about the resource

.exercise[

- Look at the information available for `node1` with one of the following commands:
  ```bash
  kubectl describe node/node1
  kubectl describe node node1
  ```

]

(We should notice a bunch of control plane pods.)

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Services

- A *service* is a stable endpoint to connect to "something"

  (In the initial proposal, they were called "portals")

.exercise[

- List the services on our cluster with one of these commands:
  ```bash
  kubectl get services
  kubectl get svc
  ```

]

--

There is already one service on our cluster: the Kubernetes API itself.

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## ClusterIP services

- A `ClusterIP` service is internal, available from the cluster only

- This is useful for introspection from within containers

.exercise[

- Try to connect to the API:
  ```bash
  curl -k https://`10.96.0.1`
  ```
  
  - `-k` is used to skip certificate verification

  - Make sure to replace 10.96.0.1 with the CLUSTER-IP shown by `kubectl get svc`

]

--

The error that we see is expected: the Kubernetes API requires authentication.

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Listing running containers

- Containers are manipulated through *pods*

- A pod is a group of containers:

 - running together (on the same node)

 - sharing resources (RAM, CPU; but also network, volumes)

.exercise[

- List pods on our cluster:
  ```bash
  kubectl get pods
  ```

]

--

*Where are the pods that we saw just a moment earlier?!?*

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Namespaces

- Namespaces allow us to segregate resources

.exercise[

- List the namespaces on our cluster with one of these commands:
  ```bash
  kubectl get namespaces
  kubectl get namespace
  kubectl get ns
  ```

]

--

*You know what ... This `kube-system` thing looks suspicious.*

*In fact, I'm pretty sure it showed up earlier, when we did:*

`kubectl describe node node1`

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Accessing namespaces

- By default, `kubectl` uses the `default` namespace

- We can see resources in all namespaces with `--all-namespaces`

.exercise[

- List the pods in all namespaces:
  ```bash
  kubectl get pods --all-namespaces
  ```

- Since Kubernetes 1.14, we can also use `-A` as a shorter version:
  ```bash
  kubectl get pods -A
  ```

]

*Here are our system pods!*

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## What are all these control plane pods?

- `etcd` is our etcd server

- `kube-apiserver` is the API server

- `kube-controller-manager` and `kube-scheduler` are other control plane components

- `coredns` provides DNS-based service discovery ([replacing kube-dns as of 1.11](https://kubernetes.io/blog/2018/07/10/coredns-ga-for-kubernetes-cluster-dns/))

- `kube-proxy` is the (per-node) component managing port mappings and such

- `weave` is the (per-node) component managing the network overlay

- the `READY` column indicates the number of containers in each pod

  (1 for most pods, but `weave` has 2, for instance)

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Scoping another namespace

- We can also look at a different namespace (other than `default`)

.exercise[

- List only the pods in the `kube-system` namespace:
  ```bash
  kubectl get pods --namespace=kube-system
  kubectl get pods -n kube-system
  ```

]

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

## Namespaces and other `kubectl` commands

- We can use `-n`/`--namespace` with almost every `kubectl` command

- Example:

  - `kubectl create --namespace=X` to create something in namespace X

- We can use `-A`/`--all-namespaces` with most commands that manipulate multiple objects

- Examples:

  - `kubectl delete` can delete resources across multiple namespaces

  - `kubectl label` can add/remove/update labels across multiple namespaces

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: extra-details

## What about `kube-public`?

.exercise[

- List the pods in the `kube-public` namespace:
  ```bash
  kubectl -n kube-public get pods
  ```

]

Nothing!

`kube-public` is created by kubeadm &amp; [used for security bootstrapping](https://kubernetes.io/blog/2017/01/stronger-foundation-for-creating-and-managing-kubernetes-clusters).

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: extra-details

## Exploring `kube-public`

- The only interesting object in `kube-public` is a ConfigMap named `cluster-info`

.exercise[

- List ConfigMap objects:
  ```bash
  kubectl -n kube-public get configmaps
  ```

- Inspect `cluster-info`:
  ```bash
  kubectl -n kube-public get configmap cluster-info -o yaml
  ```

]

Note the `selfLink` URI: `/api/v1/namespaces/kube-public/configmaps/cluster-info`

We can use that!

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: extra-details

## Accessing `cluster-info`

- Earlier, when trying to access the API server, we got a `Forbidden` message

- But `cluster-info` is readable by everyone (even without authentication)

.exercise[

- Retrieve `cluster-info`:
  ```bash
  curl -k https://10.96.0.1/api/v1/namespaces/kube-public/configmaps/cluster-info
  ```

]

- We were able to access `cluster-info` (without auth)

- It contains a `kubeconfig` file

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: extra-details

## Retrieving `kubeconfig`

- We can easily extract the `kubeconfig` file from this ConfigMap

.exercise[

- Display the content of `kubeconfig`:
  ```bash
    curl -sk https://10.96.0.1/api/v1/namespaces/kube-public/configmaps/cluster-info \
         | jq -r .data.kubeconfig
  ```

]

- This file holds the canonical address of the API server, and the public key of the CA

- This file *does not* hold client keys or tokens

- This is not sensitive information, but allows us to establish trust

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: extra-details

## What about `kube-node-lease`?

- Starting with Kubernetes 1.14, there is a `kube-node-lease` namespace

  (or in Kubernetes 1.13 if the NodeLease feature gate is enabled)

- That namespace contains one Lease object per node

- *Node leases* are a new way to implement node heartbeats

  (i.e. node regularly pinging the control plane to say "I'm alive!")

- For more details, see [KEP-0009] or the [node controller documentation]

[KEP-0009]: https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/0009-node-heartbeat.md
[node controller documentation]: https://kubernetes.io/docs/concepts/architecture/nodes/#node-controller

.debug[[k8s/kubectlget.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-housing.jpg)]

---

name: toc-setting-up-kubernetes
class: title

Setting up Kubernetes

.nav[
[Previous section](#toc-first-contact-with-kubectl)
|
[Back to table of contents](#toc-chapter-2)
|
[Next section](#toc-running-our-first-containers-on-kubernetes)
]

.debug[(automatically generated title slide)]

---
# Setting up Kubernetes

- How did we set up these Kubernetes clusters that we're using?

--

&lt;!-- ##VERSION## --&gt;

- We used `kubeadm` on freshly installed VM instances running Ubuntu LTS

    1. Install Docker

    2. Install Kubernetes packages

    3. Run `kubeadm init` on the first node (it deploys the control plane on that node)

    4. Set up Weave (the overlay network)
       &lt;br/&gt;
       (that step is just one `kubectl apply` command; discussed later)

    5. Run `kubeadm join` on the other nodes (with the token produced by `kubeadm init`)

    6. Copy the configuration file generated by `kubeadm init`

- Check the [prepare VMs README](https://github.com/jpetazzo/container.training/blob/master/prepare-vms/README.md) for more details

.debug[[k8s/setup-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md)]
---

## `kubeadm` drawbacks

- Doesn't set up Docker or any other container engine

- Doesn't set up the overlay network

- Doesn't set up multi-master (no high availability)

--

  (At least ... not yet! Though it's [experimental in 1.12](https://kubernetes.io/docs/setup/independent/high-availability/).)

--

- "It's still twice as many steps as setting up a Swarm cluster 😕" -- Jérôme

.debug[[k8s/setup-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md)]
---

## Other deployment options

- [AKS](https://azure.microsoft.com/services/kubernetes-service/):
  managed Kubernetes on Azure

- [GKE](https://cloud.google.com/kubernetes-engine/):
  managed Kubernetes on Google Cloud

- [EKS](https://aws.amazon.com/eks/),
  [eksctl](https://eksctl.io/):
  managed Kubernetes on AWS

- [kops](https://github.com/kubernetes/kops):
  customizable deployments on AWS, Digital Ocean, GCE (beta), vSphere (alpha)

- [minikube](https://kubernetes.io/docs/setup/minikube/),
  [kubespawn](https://github.com/kinvolk/kube-spawn),
  [Docker Desktop](https://docs.docker.com/docker-for-mac/kubernetes/):
  for local development

- [kubicorn](https://github.com/kubicorn/kubicorn),
  the [Cluster API](https://blogs.vmware.com/cloudnative/2019/03/14/what-and-why-of-cluster-api/):
  deploy your clusters declaratively, "the Kubernetes way"

.debug[[k8s/setup-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md)]
---

## Even more deployment options

- If you like Ansible:
  [kubespray](https://github.com/kubernetes-incubator/kubespray)

- If you like Terraform:
  [typhoon](https://github.com/poseidon/typhoon)

- If you like Terraform and Puppet:
  [tarmak](https://github.com/jetstack/tarmak)

- You can also learn how to install every component manually, with
  the excellent tutorial [Kubernetes The Hard Way](https://github.com/kelseyhightower/kubernetes-the-hard-way)

  *Kubernetes The Hard Way is optimized for learning, which means taking the long route to ensure you understand each task required to bootstrap a Kubernetes cluster.*

- There are also many commercial options available!

- For a longer list, check the Kubernetes documentation:
  &lt;br/&gt;
  it has a great guide to [pick the right solution](https://kubernetes.io/docs/setup/pick-right-solution/) to set up Kubernetes.

.debug[[k8s/setup-k8s.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/containers-by-the-water.jpg)]

---

name: toc-running-our-first-containers-on-kubernetes
class: title

Running our first containers on Kubernetes

.nav[
[Previous section](#toc-setting-up-kubernetes)
|
[Back to table of contents](#toc-chapter-2)
|
[Next section](#toc-exposing-containers)
]

.debug[(automatically generated title slide)]

---
# Running our first containers on Kubernetes

- First things first: we cannot run a container

--

- We are going to run a pod, and in that pod there will be a single container

--

- In that container in the pod, we are going to run a simple `ping` command

- Then we are going to start additional copies of the pod

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Starting a simple pod with `kubectl run`

- We need to specify at least a *name* and the image we want to use

.exercise[

- Let's ping `1.1.1.1`, Cloudflare's 
  [public DNS resolver](https://blog.cloudflare.com/announcing-1111/):
  ```bash
  kubectl run pingpong --image alpine ping 1.1.1.1
  ```

&lt;!-- ```hide kubectl wait deploy/pingpong --for condition=available``` --&gt;

]

--

(Starting with Kubernetes 1.12, we get a message telling us that
`kubectl run` is deprecated. Let's ignore it for now.)

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Behind the scenes of `kubectl run`

- Let's look at the resources that were created by `kubectl run`

.exercise[

- List most resource types:
  ```bash
  kubectl get all
  ```

]

--

We should see the following things:
- `deployment.apps/pingpong` (the *deployment* that we just created)
- `replicaset.apps/pingpong-xxxxxxxxxx` (a *replica set* created by the deployment)
- `pod/pingpong-xxxxxxxxxx-yyyyy` (a *pod* created by the replica set)

Note: as of 1.10.1, resource types are displayed in more detail.

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## What are these different things?

- A *deployment* is a high-level construct

  - allows scaling, rolling updates, rollbacks

  - multiple deployments can be used together to implement a
    [canary deployment](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments)

  - delegates pods management to *replica sets*

- A *replica set* is a low-level construct

  - makes sure that a given number of identical pods are running

  - allows scaling

  - rarely used directly

- A *replication controller* is the (deprecated) predecessor of a replica set

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Our `pingpong` deployment

- `kubectl run` created a *deployment*, `deployment.apps/pingpong`

```
NAME                       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/pingpong   1         1         1            1           10m
```

- That deployment created a *replica set*, `replicaset.apps/pingpong-xxxxxxxxxx`

```
NAME                                  DESIRED   CURRENT   READY     AGE
replicaset.apps/pingpong-7c8bbcd9bc   1         1         1         10m
```

- That replica set created a *pod*, `pod/pingpong-xxxxxxxxxx-yyyyy`

```
NAME                            READY     STATUS    RESTARTS   AGE
pod/pingpong-7c8bbcd9bc-6c9qz   1/1       Running   0          10m
```

- We'll see later how these folks play together for:

  - scaling, high availability, rolling updates

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Viewing container output

- Let's use the `kubectl logs` command

- We will pass either a *pod name*, or a *type/name*

  (E.g. if we specify a deployment or replica set, it will get the first pod in it)

- Unless specified otherwise, it will only show logs of the first container in the pod

  (Good thing there's only one in ours!)

.exercise[

- View the result of our `ping` command:
  ```bash
  kubectl logs deploy/pingpong
  ```

]

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Streaming logs in real time

- Just like `docker logs`, `kubectl logs` supports convenient options:

  - `-f`/`--follow` to stream logs in real time (à la `tail -f`)

  - `--tail` to indicate how many lines you want to see (from the end)

  - `--since` to get logs only after a given timestamp

.exercise[

- View the latest logs of our `ping` command:
  ```bash
  kubectl logs deploy/pingpong --tail 1 --follow
  ```

&lt;!--
```wait seq=3```
```keys ^C```
--&gt;

]

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Scaling our application

- We can create additional copies of our container (I mean, our pod) with `kubectl scale`

.exercise[

- Scale our `pingpong` deployment:
  ```bash
  kubectl scale deploy/pingpong --replicas 3
  ```

- Note that this command does exactly the same thing:
  ```bash
  kubectl scale deployment pingpong --replicas 3
  ```

]

Note: what if we tried to scale `replicaset.apps/pingpong-xxxxxxxxxx`?

We could! But the *deployment* would notice it right away, and scale back to the initial level.

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Resilience

- The *deployment* `pingpong` watches its *replica set*

- The *replica set* ensures that the right number of *pods* are running

- What happens if pods disappear?

.exercise[

- In a separate window, list pods, and keep watching them:
  ```bash
  kubectl get pods -w
  ```

&lt;!--
```wait Running```
```keys ^C```
```hide kubectl wait deploy pingpong --for condition=available```
```keys kubectl delete pod ping```
```copypaste pong-..........-.....```
--&gt;

- Destroy a pod:
  ```
  kubectl delete pod pingpong-xxxxxxxxxx-yyyyy
  ```
]

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## What if we wanted something different?

- What if we wanted to start a "one-shot" container that *doesn't* get restarted?

- We could use `kubectl run --restart=OnFailure` or `kubectl run --restart=Never`

- These commands would create *jobs* or *pods* instead of *deployments*

- Under the hood, `kubectl run` invokes "generators" to create resource descriptions

- We could also write these resource descriptions ourselves (typically in YAML),
  &lt;br/&gt;and create them on the cluster with `kubectl apply -f` (discussed later)

- With `kubectl run --schedule=...`, we can also create *cronjobs*

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## What about that deprecation warning?

- As we can see from the previous slide, `kubectl run` can do many things

- The exact type of resource created is not obvious

- To make things more explicit, it is better to use `kubectl create`:

  - `kubectl create deployment` to create a deployment

  - `kubectl create job` to create a job

  - `kubectl create cronjob` to run a job periodically
    &lt;br/&gt;(since Kubernetes 1.14)

- Eventually, `kubectl run` will be used only to start one-shot pods

  (see https://github.com/kubernetes/kubernetes/pull/68132)

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Various ways of creating resources

- `kubectl run` 

  - easy way to get started
  - versatile

- `kubectl create &lt;resource&gt;` 

  - explicit, but lacks some features
  - can't create a CronJob before Kubernetes 1.14
  - can't pass command-line arguments to deployments

- `kubectl create -f foo.yaml` or `kubectl apply -f foo.yaml`

  - all features are available
  - requires writing YAML

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Viewing logs of multiple pods

- When we specify a deployment name, only one single pod's logs are shown

- We can view the logs of multiple pods by specifying a *selector*

- A selector is a logic expression using *labels*

- Conveniently, when you `kubectl run somename`, the associated objects have a `run=somename` label

.exercise[

- View the last line of log from all pods with the `run=pingpong` label:
  ```bash
  kubectl logs -l run=pingpong --tail 1
  ```

]

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

### Streaming logs of multiple pods

- Can we stream the logs of all our `pingpong` pods?

.exercise[

- Combine `-l` and `-f` flags:
  ```bash
  kubectl logs -l run=pingpong --tail 1 -f
  ```

&lt;!--
```wait seq=```
```keys ^C```
--&gt;

]

*Note: combining `-l` and `-f` is only possible since Kubernetes 1.14!*

*Let's try to understand why ...*

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

class: extra-details

### Streaming logs of many pods

- Let's see what happens if we try to stream the logs for more than 5 pods

.exercise[

- Scale up our deployment:
  ```bash
  kubectl scale deployment pingpong --replicas=8
  ```

- Stream the logs:
  ```bash
  kubectl logs -l run=pingpong --tail 1 -f
  ```

]

We see a message like the following one:
```
error: you are attempting to follow 8 log streams,
but maximum allowed concurency is 5,
use --max-log-requests to increase the limit
```

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

class: extra-details

## Why can't we stream the logs of many pods?

- `kubectl` opens one connection to the API server per pod

- For each pod, the API server opens one extra connection to the corresponding kubelet

- If there are 1000 pods in our deployment, that's 1000 inbound + 1000 outbound connections on the API server

- This could easily put a lot of stress on the API server

- Prior Kubernetes 1.14, it was decided to *not* allow multiple connections

- From Kubernetes 1.14, it is allowed, but limited to 5 connections

  (this can be changed with `--max-log-requests`)

- For more details about the rationale, see
  [PR #67573](https://github.com/kubernetes/kubernetes/pull/67573)

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Shortcomings of `kubectl logs`

- We don't see which pod sent which log line

- If pods are restarted / replaced, the log stream stops

- If new pods are added, we don't see their logs

- To stream the logs of multiple pods, we need to write a selector

- There are external tools to address these shortcomings

  (e.g.: [Stern](https://github.com/wercker/stern))

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

class: extra-details

## `kubectl logs -l ... --tail N`

- If we run this with Kubernetes 1.12, the last command shows multiple lines

- This is a regression when `--tail` is used together with `-l`/`--selector`

- It always shows the last 10 lines of output for each container

  (instead of the number of lines specified on the command line)

- The problem was fixed in Kubernetes 1.13

*See [#70554](https://github.com/kubernetes/kubernetes/issues/70554) for details.*

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---

## Aren't we flooding 1.1.1.1?

- If you're wondering this, good question!

- Don't worry, though:

  *APNIC's research group held the IP addresses 1.1.1.1 and 1.0.0.1. While the addresses were valid, so many people had entered them into various random systems that they were continuously overwhelmed by a flood of garbage traffic. APNIC wanted to study this garbage traffic but any time they'd tried to announce the IPs, the flood would overwhelm any conventional network.*

  (Source: https://blog.cloudflare.com/announcing-1111/)

- It's very unlikely that our concerted pings manage to produce
  even a modest blip at Cloudflare's NOC!

.debug[[k8s/kubectlrun.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md)]
---
## 19,000 words

They say, "a picture is worth one thousand words."

The following 19 slides show what really happens when we run:

```bash
kubectl run web --image=nginx --replicas=3
```

.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/01.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/02.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/03.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/04.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/05.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/06.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/07.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/08.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/09.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/10.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/11.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/12.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/13.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/14.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/15.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/16.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/17.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/18.svg)
.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---
class: pic
![](images/kubectl-run-slideshow/19.svg)

.debug[[k8s/deploymentslideshow.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/distillery-containers.jpg)]

---

name: toc-exposing-containers
class: title

Exposing containers

.nav[
[Previous section](#toc-running-our-first-containers-on-kubernetes)
|
[Back to table of contents](#toc-chapter-3)
|
[Next section](#toc-shipping-images-with-a-registry)
]

.debug[(automatically generated title slide)]

---
# Exposing containers

- `kubectl expose` creates a *service* for existing pods

- A *service* is a stable address for a pod (or a bunch of pods)

- If we want to connect to our pod(s), we need to create a *service*

- Once a service is created, CoreDNS will allow us to resolve it by name

  (i.e. after creating service `hello`, the name `hello` will resolve to something)

- There are different types of services, detailed on the following slides:

  `ClusterIP`, `NodePort`, `LoadBalancer`, `ExternalName`

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## Basic service types

- `ClusterIP` (default type)

  - a virtual IP address is allocated for the service (in an internal, private range)
  - this IP address is reachable only from within the cluster (nodes and pods)
  - our code can connect to the service using the original port number

- `NodePort`

  - a port is allocated for the service (by default, in the 30000-32768 range)
  - that port is made available *on all our nodes* and anybody can connect to it
  - our code must be changed to connect to that new port number

These service types are always available.

Under the hood: `kube-proxy` is using a userland proxy and a bunch of `iptables` rules.

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## More service types

- `LoadBalancer`

  - an external load balancer is allocated for the service
  - the load balancer is configured accordingly
    &lt;br/&gt;(e.g.: a `NodePort` service is created, and the load balancer sends traffic to that port)
  - available only when the underlying infrastructure provides some "load balancer as a service"
    &lt;br/&gt;(e.g. AWS, Azure, GCE, OpenStack...)

- `ExternalName`

  - the DNS entry managed by CoreDNS will just be a `CNAME` to a provided record
  - no port, no IP address, no nothing else is allocated

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## Running containers with open ports

- Since `ping` doesn't have anything to connect to, we'll have to run something else

- We could use the `nginx` official image, but ...

  ... we wouldn't be able to tell the backends from each other!

- We are going to use `jpetazzo/httpenv`, a tiny HTTP server written in Go

- `jpetazzo/httpenv` listens on port 8888

- It serves its environment variables in JSON format

- The environment variables will include `HOSTNAME`, which will be the pod name

  (and therefore, will be different on each backend)

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## Creating a deployment for our HTTP server

- We *could* do `kubectl run httpenv --image=jpetazzo/httpenv` ...

- But since `kubectl run` is being deprecated, let's see how to use `kubectl create` instead

.exercise[

- In another window, watch the pods (to see when they are created):
  ```bash
  kubectl get pods -w
  ```

&lt;!-- ```keys ^C``` --&gt;

- Create a deployment for this very lightweight HTTP server:
  ```bash
  kubectl create deployment httpenv --image=jpetazzo/httpenv
  ```

- Scale it to 10 replicas:
  ```bash
  kubectl scale deployment httpenv --replicas=10
  ```

]

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## Exposing our deployment

- We'll create a default `ClusterIP` service

.exercise[

- Expose the HTTP port of our server:
  ```bash
  kubectl expose deployment httpenv --port 8888
  ```

- Look up which IP address was allocated:
  ```bash
  kubectl get service
  ```

]

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## Services are layer 4 constructs

- You can assign IP addresses to services, but they are still *layer 4*

  (i.e. a service is not an IP address; it's an IP address + protocol + port)

- This is caused by the current implementation of `kube-proxy`

  (it relies on mechanisms that don't support layer 3)

- As a result: you *have to* indicate the port number for your service
    
- Running services with arbitrary port (or port ranges) requires hacks

  (e.g. host networking mode)

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## Testing our service

- We will now send a few HTTP requests to our pods

.exercise[

- Let's obtain the IP address that was allocated for our service, *programmatically:*
  ```bash
  IP=$(kubectl get svc httpenv -o go-template --template '{{ .spec.clusterIP }}')
  ```

&lt;!--
```hide kubectl wait deploy httpenv --for condition=available```
--&gt;

- Send a few requests:
  ```bash
  curl http://$IP:8888/
  ```

- Too much output? Filter it with `jq`:
  ```bash
  curl -s http://$IP:8888/ | jq .HOSTNAME
  ```

]

--

Try it a few times! Our requests are load balanced across multiple pods.

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

class: extra-details

## If we don't need a load balancer

- Sometimes, we want to access our scaled services directly:

  - if we want to save a tiny little bit of latency (typically less than 1ms)

  - if we need to connect over arbitrary ports (instead of a few fixed ones)

  - if we need to communicate over another protocol than UDP or TCP

  - if we want to decide how to balance the requests client-side

  - ...

- In that case, we can use a "headless service"

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

class: extra-details

## Headless services

- A headless service is obtained by setting the `clusterIP` field to `None`

  (Either with `--cluster-ip=None`, or by providing a custom YAML)

- As a result, the service doesn't have a virtual IP address

- Since there is no virtual IP address, there is no load balancer either

- CoreDNS will return the pods' IP addresses as multiple `A` records

- This gives us an easy way to discover all the replicas for a deployment

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

class: extra-details

## Services and endpoints

- A service has a number of "endpoints"

- Each endpoint is a host + port where the service is available

- The endpoints are maintained and updated automatically by Kubernetes

.exercise[

- Check the endpoints that Kubernetes has associated with our `httpenv` service:
  ```bash
  kubectl describe service httpenv
  ```

]

In the output, there will be a line starting with `Endpoints:`.

That line will list a bunch of addresses in `host:port` format.

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

class: extra-details

## Viewing endpoint details

- When we have many endpoints, our display commands truncate the list
  ```bash
  kubectl get endpoints
  ```

- If we want to see the full list, we can use one of the following commands:
  ```bash
  kubectl describe endpoints httpenv
  kubectl get endpoints httpenv -o yaml
  ```

- These commands will show us a list of IP addresses

- These IP addresses should match the addresses of the corresponding pods:
  ```bash
  kubectl get pods -l app=httpenv -o wide
  ```

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

class: extra-details

## `endpoints` not `endpoint`

- `endpoints` is the only resource that cannot be singular

```bash
$ kubectl get endpoint
error: the server doesn't have a resource type "endpoint"
```

- This is because the type itself is plural (unlike every other resource)

- There is no `endpoint` object: `type Endpoints struct`

- The type doesn't represent a single endpoint, but a list of endpoints

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

## Exposing services to the outside world

- The default type (ClusterIP) only works for internal traffic

- If we want to accept external traffic, we can use one of these:

  - NodePort (expose a service on a TCP port between 30000-32768)

  - LoadBalancer (provision a cloud load balancer for our service)

  - ExternalIP (use one node's external IP address)

  - Ingress (a special mechanism for HTTP services)

*We'll see NodePorts and Ingresses more in detail later.*

.debug[[k8s/kubectlexpose.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/lots-of-containers.jpg)]

---

name: toc-shipping-images-with-a-registry
class: title

Shipping images with a registry

.nav[
[Previous section](#toc-exposing-containers)
|
[Back to table of contents](#toc-chapter-3)
|
[Next section](#toc-running-our-application-on-kubernetes)
]

.debug[(automatically generated title slide)]

---
# Shipping images with a registry

- Initially, our app was running on a single node

- We could *build* and *run* in the same place

- Therefore, we did not need to *ship* anything

- Now that we want to run on a cluster, things are different

- The easiest way to ship container images is to use a registry

.debug[[k8s/shippingimages.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md)]
---

## How Docker registries work (a reminder)

- What happens when we execute `docker run alpine` ?

- If the Engine needs to pull the `alpine` image, it expands it into `library/alpine`

- `library/alpine` is expanded into `index.docker.io/library/alpine`

- The Engine communicates with `index.docker.io` to retrieve `library/alpine:latest`

- To use something else than `index.docker.io`, we specify it in the image name

- Examples:
  ```bash
  docker pull gcr.io/google-containers/alpine-with-bash:1.0

  docker build -t registry.mycompany.io:5000/myimage:awesome .
  docker push registry.mycompany.io:5000/myimage:awesome
  ```

.debug[[k8s/shippingimages.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md)]
---

## Running DockerCoins on Kubernetes

- Create one deployment for each component

  (hasher, redis, rng, webui, worker)

- Expose deployments that need to accept connections

  (hasher, redis, rng, webui)

- For redis, we can use the official redis image

- For the 4 others, we need to build images and push them to some registry

.debug[[k8s/shippingimages.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md)]
---

## Building and shipping images

- There are *many* options!

- Manually:

  - build locally (with `docker build` or otherwise)

  - push to the registry

- Automatically:

  - build and test locally

  - when ready, commit and push a code repository

  - the code repository notifies an automated build system

  - that system gets the code, builds it, pushes the image to the registry

.debug[[k8s/shippingimages.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md)]
---

## Which registry do we want to use?

- There are SAAS products like Docker Hub, Quay ...

- Each major cloud provider has an option as well

  (ACR on Azure, ECR on AWS, GCR on Google Cloud...)

- There are also commercial products to run our own registry

  (Docker EE, Quay...)

- And open source options, too!

- When picking a registry, pay attention to its build system

  (when it has one)

.debug[[k8s/shippingimages.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md)]
---
## Using images from the Docker Hub

- For everyone's convenience, we took care of building DockerCoins images

- We pushed these images to the DockerHub, under the [dockercoins](https://hub.docker.com/u/dockercoins) user

- These images are *tagged* with a version number, `v0.1`

- The full image names are therefore:

  - `dockercoins/hasher:v0.1`

  - `dockercoins/rng:v0.1`

  - `dockercoins/webui:v0.1`

  - `dockercoins/worker:v0.1`

.debug[[k8s/buildshiprun-dockerhub.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/buildshiprun-dockerhub.md)]
---

## Setting `$REGISTRY` and `$TAG`

- In the upcoming exercises and labs, we use a couple of environment variables:

  - `$REGISTRY` as a prefix to all image names

  - `$TAG` as the image version tag

- For example, the worker image is `$REGISTRY/worker:$TAG`

- If you copy-paste the commands in these exercises:

  **make sure that you set `$REGISTRY` and `$TAG` first!**

- For example:
  ```
  export REGISTRY=dockercoins TAG=v0.1
  ```

  (this will expand `$REGISTRY/worker:$TAG` to `dockercoins/worker:v0.1`)

.debug[[k8s/buildshiprun-dockerhub.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/buildshiprun-dockerhub.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/plastic-containers.JPG)]

---

name: toc-running-our-application-on-kubernetes
class: title

Running our application on Kubernetes

.nav[
[Previous section](#toc-shipping-images-with-a-registry)
|
[Back to table of contents](#toc-chapter-3)
|
[Next section](#toc-scaling-our-demo-app)
]

.debug[(automatically generated title slide)]

---
# Running our application on Kubernetes

- We can now deploy our code (as well as a redis instance)

.exercise[

- Deploy `redis`:
  ```bash
  kubectl create deployment redis --image=redis
  ```

- Deploy everything else:
  ```bash
    set -u
    for SERVICE in hasher rng webui worker; do
      kubectl create deployment $SERVICE --image=$REGISTRY/$SERVICE:$TAG
    done
  ```

]

.debug[[k8s/ourapponkube.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md)]
---

## Is this working?

- After waiting for the deployment to complete, let's look at the logs!

  (Hint: use `kubectl get deploy -w` to watch deployment events)

.exercise[

&lt;!-- ```hide
kubectl wait deploy/rng --for condition=available
kubectl wait deploy/worker --for condition=available
``` --&gt;

- Look at some logs:
  ```bash
  kubectl logs deploy/rng
  kubectl logs deploy/worker
  ```

]

--

🤔 `rng` is fine ... But not `worker`.

--

💡 Oh right! We forgot to `expose`.

.debug[[k8s/ourapponkube.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md)]
---

## Connecting containers together

- Three deployments need to be reachable by others: `hasher`, `redis`, `rng`

- `worker` doesn't need to be exposed

- `webui` will be dealt with later

.exercise[

- Expose each deployment, specifying the right port:
  ```bash
  kubectl expose deployment redis --port 6379
  kubectl expose deployment rng --port 80
  kubectl expose deployment hasher --port 80
  ```

]

.debug[[k8s/ourapponkube.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md)]
---

## Is this working yet?

- The `worker` has an infinite loop, that retries 10 seconds after an error

.exercise[

- Stream the worker's logs:
  ```bash
  kubectl logs deploy/worker --follow
  ```

  (Give it about 10 seconds to recover)

&lt;!--
```wait units of work done, updating hash counter```
```keys ^C```
--&gt;

]

--

We should now see the `worker`, well, working happily.

.debug[[k8s/ourapponkube.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md)]
---

## Exposing services for external access

- Now we would like to access the Web UI

- We will expose it with a `NodePort`

  (just like we did for the registry)

.exercise[

- Create a `NodePort` service for the Web UI:
  ```bash
  kubectl expose deploy/webui --type=NodePort --port=80
  ```

- Check the port that was allocated:
  ```bash
  kubectl get svc
  ```

]

.debug[[k8s/ourapponkube.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md)]
---

## Accessing the web UI

- We can now connect to *any node*, on the allocated node port, to view the web UI

.exercise[

- Open the web UI in your browser (http://node-ip-address:3xxxx/)

&lt;!-- ```open http://node1:3xxxx/``` --&gt;

]

--

Yes, this may take a little while to update. *(Narrator: it was DNS.)*

--

*Alright, we're back to where we started, when we were running on a single node!*

.debug[[k8s/ourapponkube.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-1.jpg)]

---

name: toc-scaling-our-demo-app
class: title

Scaling our demo app

.nav[
[Previous section](#toc-running-our-application-on-kubernetes)
|
[Back to table of contents](#toc-chapter-3)
|
[Next section](#toc-daemon-sets)
]

.debug[(automatically generated title slide)]

---
# Scaling our demo app

- Our ultimate goal is to get more DockerCoins

  (i.e. increase the number of loops per second shown on the web UI)

- Let's look at the architecture again:

  ![DockerCoins architecture](images/dockercoins-diagram.svg)

- The loop is done in the worker;
  perhaps we could try adding more workers?

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

## Adding another worker

- All we have to do is scale the `worker` Deployment

.exercise[

- Open two new terminals to check what's going on with pods and deployments:
  ```bash
  kubectl get pods -w
  kubectl get deployments -w
  ```

&lt;!--
```wait RESTARTS```
```keys ^C```
```wait AVAILABLE```
```keys ^C```
--&gt;

- Now, create more `worker` replicas:
  ```bash
  kubectl scale deployment worker --replicas=2
  ```

]

After a few seconds, the graph in the web UI should show up.

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

## Adding more workers

- If 2 workers give us 2x speed, what about 3 workers?

.exercise[

- Scale the `worker` Deployment further:
  ```bash
  kubectl scale deployment worker --replicas=3
  ```

]

The graph in the web UI should go up again.

(This is looking great! We're gonna be RICH!)

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

## Adding even more workers

- Let's see if 10 workers give us 10x speed!

.exercise[

- Scale the `worker` Deployment to a bigger number:
  ```bash
  kubectl scale deployment worker --replicas=10
  ```

]

--

The graph will peak at 10 hashes/second.

(We can add as many workers as we want: we will never go past 10 hashes/second.)

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

class: extra-details

## Didn't we briefly exceed 10 hashes/second?

- It may *look like it*, because the web UI shows instant speed

- The instant speed can briefly exceed 10 hashes/second

- The average speed cannot

- The instant speed can be biased because of how it's computed

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

class: extra-details

## Why instant speed is misleading

- The instant speed is computed client-side by the web UI

- The web UI checks the hash counter once per second
  &lt;br/&gt;
  (and does a classic (h2-h1)/(t2-t1) speed computation)

- The counter is updated once per second by the workers

- These timings are not exact
  &lt;br/&gt;
  (e.g. the web UI check interval is client-side JavaScript)

- Sometimes, between two web UI counter measurements,
  &lt;br/&gt;
  the workers are able to update the counter *twice*

- During that cycle, the instant speed will appear to be much bigger
  &lt;br/&gt;
  (but it will be compensated by lower instant speed before and after)

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

## Why are we stuck at 10 hashes per second?

- If this was high-quality, production code, we would have instrumentation

  (Datadog, Honeycomb, New Relic, statsd, Sumologic, ...)

- It's not!

- Perhaps we could benchmark our web services?

  (with tools like `ab`, or even simpler, `httping`)

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

## Benchmarking our web services

- We want to check `hasher` and `rng`

- We are going to use `httping`

- It's just like `ping`, but using HTTP `GET` requests

  (it measures how long it takes to perform one `GET` request)

- It's used like this:
  ```
  httping [-c count] http://host:port/path
  ```

- Or even simpler:
  ```
  httping ip.ad.dr.ess
  ```

- We will use `httping` on the ClusterIP addresses of our services

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

## Obtaining ClusterIP addresses

- We can simply check the output of `kubectl get services`

- Or do it programmatically, as in the example below

.exercise[

- Retrieve the IP addresses:
  ```bash
  HASHER=$(kubectl get svc hasher -o go-template={{.spec.clusterIP}})
  RNG=$(kubectl get svc rng -o go-template={{.spec.clusterIP}})
  ```

]

Now we can access the IP addresses of our services through `$HASHER` and `$RNG`.

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---

## Checking `hasher` and `rng` response times

.exercise[

- Check the response times for both services:
  ```bash
  httping -c 3 $HASHER
  httping -c 3 $RNG
  ```

]

- `hasher` is fine (it should take a few milliseconds to reply)

- `rng` is not (it should take about 700 milliseconds if there are 10 workers)

- Something is wrong with `rng`, but ... what?

.debug[[k8s/scalingdockercoins.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md)]
---
## Let's draw hasty conclusions

- The bottleneck seems to be `rng`

- *What if* we don't have enough entropy and can't generate enough random numbers?

- We need to scale out the `rng` service on multiple machines!

Note: this is a fiction! We have enough entropy. But we need a pretext to scale out.

(In fact, the code of `rng` uses `/dev/urandom`, which never runs out of entropy...
&lt;br/&gt;
...and is [just as good as `/dev/random`](http://www.slideshare.net/PacSecJP/filippo-plain-simple-reality-of-entropy).)

.debug[[shared/hastyconclusions.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/hastyconclusions.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-2.jpg)]

---

name: toc-daemon-sets
class: title

Daemon sets

.nav[
[Previous section](#toc-scaling-our-demo-app)
|
[Back to table of contents](#toc-chapter-3)
|
[Next section](#toc-labels-and-selectors)
]

.debug[(automatically generated title slide)]

---
# Daemon sets

- We want to scale `rng` in a way that is different from how we scaled `worker`

- We want one (and exactly one) instance of `rng` per node

- What if we just scale up `deploy/rng` to the number of nodes?

  - nothing guarantees that the `rng` containers will be distributed evenly

  - if we add nodes later, they will not automatically run a copy of `rng`

  - if we remove (or reboot) a node, one `rng` container will restart elsewhere

- Instead of a `deployment`, we will use a `daemonset`

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Daemon sets in practice

- Daemon sets are great for cluster-wide, per-node processes:

  - `kube-proxy`

  - `weave` (our overlay network)

  - monitoring agents

  - hardware management tools (e.g. SCSI/FC HBA agents)

  - etc.

- They can also be restricted to run [only on some nodes](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#running-pods-on-only-some-nodes)

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Creating a daemon set

&lt;!-- ##VERSION## --&gt;

- Unfortunately, as of Kubernetes 1.14, the CLI cannot create daemon sets

--

- More precisely: it doesn't have a subcommand to create a daemon set

--

- But any kind of resource can always be created by providing a YAML description:
  ```bash
  kubectl apply -f foo.yaml
  ```

--

- How do we create the YAML file for our daemon set?

--

  - option 1: [read the docs](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#create-a-daemonset)

--

  - option 2: `vi` our way out of it

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Creating the YAML file for our daemon set

- Let's start with the YAML file for the current `rng` resource

.exercise[

- Dump the `rng` resource in YAML:
  ```bash
  kubectl get deploy/rng -o yaml &gt;rng.yml
  ```

- Edit `rng.yml`

]

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## "Casting" a resource to another

- What if we just changed the `kind` field?

  (It can't be that easy, right?)

.exercise[

- Change `kind: Deployment` to `kind: DaemonSet`

&lt;!--
```bash vim rng.yml```
```wait kind: Deployment```
```keys /Deployment```
```keys ^J```
```keys cwDaemonSet```
```keys ^[``` ]
```keys :wq```
```keys ^J```
--&gt;

- Save, quit

- Try to create our new resource:
  ```
  kubectl apply -f rng.yml
  ```

]

--

We all knew this couldn't be that easy, right!

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Understanding the problem

- The core of the error is:
  ```
  error validating data:
  [ValidationError(DaemonSet.spec):
  unknown field "replicas" in io.k8s.api.extensions.v1beta1.DaemonSetSpec,
  ...
  ```

--

- *Obviously,* it doesn't make sense to specify a number of replicas for a daemon set

--

- Workaround: fix the YAML

  - remove the `replicas` field
  - remove the `strategy` field (which defines the rollout mechanism for a deployment)
  - remove the `progressDeadlineSeconds` field (also used by the rollout mechanism)
  - remove the `status: {}` line at the end

--

- Or, we could also ...

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Use the `--force`, Luke

- We could also tell Kubernetes to ignore these errors and try anyway

- The `--force` flag's actual name is `--validate=false`

.exercise[

- Try to load our YAML file and ignore errors:
  ```bash
  kubectl apply -f rng.yml --validate=false
  ```

]

--

🎩✨🐇

--

Wait ... Now, can it be *that* easy?

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Checking what we've done

- Did we transform our `deployment` into a `daemonset`?

.exercise[

- Look at the resources that we have now:
  ```bash
  kubectl get all
  ```

]

--

We have two resources called `rng`:

- the *deployment* that was existing before

- the *daemon set* that we just created

We also have one too many pods.
&lt;br/&gt;
(The pod corresponding to the *deployment* still exists.)

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## `deploy/rng` and `ds/rng`

- You can have different resource types with the same name

  (i.e. a *deployment* and a *daemon set* both named `rng`)

- We still have the old `rng` *deployment*

  ```
NAME                       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/rng        1         1         1            1           18m
  ```

- But now we have the new `rng` *daemon set* as well

  ```
NAME                DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE  NODE SELECTOR  AGE
daemonset.apps/rng  2        2        2      2           2          &lt;none&gt;         9s
  ```

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Too many pods

- If we check with `kubectl get pods`, we see:

  - *one pod* for the deployment (named `rng-xxxxxxxxxx-yyyyy`)

  - *one pod per node* for the daemon set (named `rng-zzzzz`)

  ```
  NAME                        READY     STATUS    RESTARTS   AGE
  rng-54f57d4d49-7pt82        1/1       Running   0          11m
  rng-b85tm                   1/1       Running   0          25s
  rng-hfbrr                   1/1       Running   0          25s
  [...]
  ```

--

The daemon set created one pod per node, except on the master node.

The master node has [taints](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/) preventing pods from running there.

(To schedule a pod on this node anyway, the pod will require appropriate [tolerations](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/).)

.footnote[(Off by one? We don't run these pods on the node hosting the control plane.)]

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Is this working?

- Look at the web UI

--

- The graph should now go above 10 hashes per second!

--

- It looks like the newly created pods are serving traffic correctly

- How and why did this happen?

  (We didn't do anything special to add them to the `rng` service load balancer!)

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/two-containers-on-a-truck.jpg)]

---

name: toc-labels-and-selectors
class: title

Labels and selectors

.nav[
[Previous section](#toc-daemon-sets)
|
[Back to table of contents](#toc-chapter-3)
|
[Next section](#toc-rolling-updates)
]

.debug[(automatically generated title slide)]

---

# Labels and selectors

- The `rng` *service* is load balancing requests to a set of pods

- That set of pods is defined by the *selector* of the `rng` service

.exercise[

- Check the *selector* in the `rng` service definition:
  ```bash
  kubectl describe service rng
  ```

]

- The selector is `app=rng`

- It means "all the pods having the label `app=rng`"

  (They can have additional labels as well, that's OK!)

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Selector evaluation

- We can use selectors with many `kubectl` commands

- For instance, with `kubectl get`, `kubectl logs`, `kubectl delete` ... and more

.exercise[

- Get the list of pods matching selector `app=rng`:
  ```bash
  kubectl get pods -l app=rng
  kubectl get pods --selector app=rng
  ```

]

But ... why do these pods (in particular, the *new* ones) have this `app=rng` label?

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Where do labels come from?

- When we create a deployment with `kubectl create deployment rng`,
  &lt;br/&gt;this deployment gets the label `app=rng`

- The replica sets created by this deployment also get the label `app=rng`

- The pods created by these replica sets also get the label `app=rng`

- When we created the daemon set from the deployment, we re-used the same spec

- Therefore, the pods created by the daemon set get the same labels

.footnote[Note: when we use `kubectl run stuff`, the label is `run=stuff` instead.]

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Updating load balancer configuration

- We would like to remove a pod from the load balancer

- What would happen if we removed that pod, with `kubectl delete pod ...`?

--

  It would be re-created immediately (by the replica set or the daemon set)

--

- What would happen if we removed the `app=rng` label from that pod?

--

  It would *also* be re-created immediately

--

  Why?!?

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Selectors for replica sets and daemon sets

- The "mission" of a replica set is:

  "Make sure that there is the right number of pods matching this spec!"

- The "mission" of a daemon set is:

  "Make sure that there is a pod matching this spec on each node!"

--

- *In fact,* replica sets and daemon sets do not check pod specifications

- They merely have a *selector*, and they look for pods matching that selector

- Yes, we can fool them by manually creating pods with the "right" labels

- Bottom line: if we remove our `app=rng` label ...

 ... The pod "disappears" for its parent, which re-creates another pod to replace it

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

class: extra-details

## Isolation of replica sets and daemon sets

- Since both the `rng` daemon set and the `rng` replica set use `app=rng` ...

  ... Why don't they "find" each other's pods?

--

- *Replica sets* have a more specific selector, visible with `kubectl describe`

  (It looks like `app=rng,pod-template-hash=abcd1234`)

- *Daemon sets* also have a more specific selector, but it's invisible

  (It looks like `app=rng,controller-revision-hash=abcd1234`)

- As a result, each controller only "sees" the pods it manages

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Removing a pod from the load balancer

- Currently, the `rng` service is defined by the `app=rng` selector

- The only way to remove a pod is to remove or change the `app` label

- ... But that will cause another pod to be created instead!

- What's the solution?

--

- We need to change the selector of the `rng` service!

- Let's add another label to that selector (e.g. `enabled=yes`) 

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Complex selectors

- If a selector specifies multiple labels, they are understood as a logical *AND*

  (In other words: the pods must match all the labels)

- Kubernetes has support for advanced, set-based selectors

  (But these cannot be used with services, at least not yet!)

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## The plan

1. Add the label `enabled=yes` to all our `rng` pods

2. Update the selector for the `rng` service to also include `enabled=yes`

3. Toggle traffic to a pod by manually adding/removing the `enabled` label

4. Profit!

*Note: if we swap steps 1 and 2, it will cause a short
service disruption, because there will be a period of time
during which the service selector won't match any pod.
During that time, requests to the service will time out.
By doing things in the order above, we guarantee that there won't
be any interruption.*

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Adding labels to pods

- We want to add the label `enabled=yes` to all pods that have `app=rng`

- We could edit each pod one by one with `kubectl edit` ...

- ... Or we could use `kubectl label` to label them all

- `kubectl label` can use selectors itself

.exercise[

- Add `enabled=yes` to all pods that have `app=rng`:
  ```bash
  kubectl label pods -l app=rng enabled=yes
  ```

]

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Updating the service selector

- We need to edit the service specification

- Reminder: in the service definition, we will see `app: rng` in two places

  - the label of the service itself (we don't need to touch that one)

  - the selector of the service (that's the one we want to change)

.exercise[

- Update the service to add `enabled: yes` to its selector:
  ```bash
  kubectl edit service rng
  ```

&lt;!--
```wait Please edit the object below```
```keys /app: rng```
```keys ^J```
```keys noenabled: yes```
```keys ^[``` ]
```keys :wq```
```keys ^J```
--&gt;

]

--

... And then we get *the weirdest error ever.* Why?

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## When the YAML parser is being too smart

- YAML parsers try to help us:

  - `xyz` is the string `"xyz"`

  - `42` is the integer `42`

  - `yes` is the boolean value `true`

- If we want the string `"42"` or the string `"yes"`, we have to quote them

- So we have to use `enabled: "yes"`

.footnote[For a good laugh: if we had used "ja", "oui", "si" ... as the value, it would have worked!]

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Updating the service selector, take 2

.exercise[

- Update the service to add `enabled: "yes"` to its selector:
  ```bash
  kubectl edit service rng
  ```

&lt;!--
```wait Please edit the object below```
```keys /app: rng```
```keys ^J```
```keys noenabled: "yes"```
```keys ^[``` ]
```keys :wq```
```keys ^J```
--&gt;

]

This time it should work!

If we did everything correctly, the web UI shouldn't show any change.

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Updating labels

- We want to disable the pod that was created by the deployment

- All we have to do, is remove the `enabled` label from that pod

- To identify that pod, we can use its name

- ... Or rely on the fact that it's the only one with a `pod-template-hash` label

- Good to know:

  - `kubectl label ... foo=` doesn't remove a label (it sets it to an empty string)

  - to remove label `foo`, use `kubectl label ... foo-`

  - to change an existing label, we would need to add `--overwrite`

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Removing a pod from the load balancer

.exercise[

- In one window, check the logs of that pod:
  ```bash
  POD=$(kubectl get pod -l app=rng,pod-template-hash -o name)
  kubectl logs --tail 1 --follow $POD

  ```
  (We should see a steady stream of HTTP logs)

- In another window, remove the label from the pod:
  ```bash
  kubectl label pod -l app=rng,pod-template-hash enabled-
  ```
  (The stream of HTTP logs should stop immediately)

]

There might be a slight change in the web UI (since we removed a bit
of capacity from the `rng` service). If we remove more pods,
the effect should be more visible.

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

class: extra-details

## Updating the daemon set

- If we scale up our cluster by adding new nodes, the daemon set will create more pods

- These pods won't have the `enabled=yes` label

- If we want these pods to have that label, we need to edit the daemon set spec

- We can do that with e.g. `kubectl edit daemonset rng`

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

class: extra-details

## We've put resources in your resources

- Reminder: a daemon set is a resource that creates more resources!

- There is a difference between:

  - the label(s) of a resource (in the `metadata` block in the beginning)

  - the selector of a resource (in the `spec` block)

  - the label(s) of the resource(s) created by the first resource (in the `template` block)

- We would need to update the selector and the template

  (metadata labels are not mandatory)

- The template must match the selector

  (i.e. the resource will refuse to create resources that it will not select)

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Labels and debugging

- When a pod is misbehaving, we can delete it: another one will be recreated

- But we can also change its labels

- It will be removed from the load balancer (it won't receive traffic anymore)

- Another pod will be recreated immediately

- But the problematic pod is still here, and we can inspect and debug it

- We can even re-add it to the rotation if necessary

  (Very useful to troubleshoot intermittent and elusive bugs)

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

## Labels and advanced rollout control

- Conversely, we can add pods matching a service's selector

- These pods will then receive requests and serve traffic

- Examples:

  - one-shot pod with all debug flags enabled, to collect logs

  - pods created automatically, but added to rotation in a second step
    &lt;br/&gt;
    (by setting their label accordingly)

- This gives us building blocks for canary and blue/green deployments

.debug[[k8s/daemonset.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/wall-of-containers.jpeg)]

---

name: toc-rolling-updates
class: title

Rolling updates

.nav[
[Previous section](#toc-labels-and-selectors)
|
[Back to table of contents](#toc-chapter-4)
|
[Next section](#toc-healthchecks)
]

.debug[(automatically generated title slide)]

---
# Rolling updates

- By default (without rolling updates), when a scaled resource is updated:

  - new pods are created

  - old pods are terminated

  - ... all at the same time

  - if something goes wrong, ¯\\\_(ツ)\_/¯

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Rolling updates

- With rolling updates, when a resource is updated, it happens progressively

- Two parameters determine the pace of the rollout: `maxUnavailable` and `maxSurge`

- They can be specified in absolute number of pods, or percentage of the `replicas` count

- At any given time ...

  - there will always be at least `replicas`-`maxUnavailable` pods available

  - there will never be more than `replicas`+`maxSurge` pods in total

  - there will therefore be up to `maxUnavailable`+`maxSurge` pods being updated

- We have the possibility of rolling back to the previous version
  &lt;br/&gt;(if the update fails or is unsatisfactory in any way)

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Checking current rollout parameters

- Recall how we build custom reports with `kubectl` and `jq`:

.exercise[

- Show the rollout plan for our deployments:
  ```bash
    kubectl get deploy -o json |
            jq ".items[] | {name:.metadata.name} + .spec.strategy.rollingUpdate"
  ```

]

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Rolling updates in practice

- As of Kubernetes 1.8, we can do rolling updates with:

  `deployments`, `daemonsets`, `statefulsets`

- Editing one of these resources will automatically result in a rolling update

- Rolling updates can be monitored with the `kubectl rollout` subcommand

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Building a new version of the `worker` service

.warning[
Only run these commands if you have built and pushed DockerCoins to a local registry.
&lt;br/&gt;
If you are using images from the Docker Hub (`dockercoins/worker:v0.1`), skip this.
]

.exercise[

- Go to the `stacks` directory (`~/container.training/stacks`)

- Edit `dockercoins/worker/worker.py`; update the first `sleep` line to sleep 1 second

- Build a new tag and push it to the registry:
  ```bash
  #export REGISTRY=localhost:3xxxx
  export TAG=v0.2
  docker-compose -f dockercoins.yml build
  docker-compose -f dockercoins.yml push
  ```

]

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Rolling out the new `worker` service

.exercise[

- Let's monitor what's going on by opening a few terminals, and run:
  ```bash
  kubectl get pods -w
  kubectl get replicasets -w
  kubectl get deployments -w
  ```

&lt;!--
```wait NAME```
```keys ^C```
--&gt;

- Update `worker` either with `kubectl edit`, or by running:
  ```bash
  kubectl set image deploy worker worker=$REGISTRY/worker:$TAG
  ```

]

--

That rollout should be pretty quick. What shows in the web UI?

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Give it some time

- At first, it looks like nothing is happening (the graph remains at the same level)

- According to `kubectl get deploy -w`, the `deployment` was updated really quickly

- But `kubectl get pods -w` tells a different story

- The old `pods` are still here, and they stay in `Terminating` state for a while

- Eventually, they are terminated; and then the graph decreases significantly

- This delay is due to the fact that our worker doesn't handle signals

- Kubernetes sends a "polite" shutdown request to the worker, which ignores it

- After a grace period, Kubernetes gets impatient and kills the container

  (The grace period is 30 seconds, but [can be changed](https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods) if needed)

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Rolling out something invalid

- What happens if we make a mistake?

.exercise[

- Update `worker` by specifying a non-existent image:
  ```bash
  export TAG=v0.3
  kubectl set image deploy worker worker=$REGISTRY/worker:$TAG
  ```

- Check what's going on:
  ```bash
  kubectl rollout status deploy worker
  ```

&lt;!--
```wait Waiting for deployment```
```keys ^C```
--&gt;

]

--

Our rollout is stuck. However, the app is not dead.

(After a minute, it will stabilize to be 20-25% slower.)

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## What's going on with our rollout?

- Why is our app a bit slower?

- Because `MaxUnavailable=25%`

  ... So the rollout terminated 2 replicas out of 10 available

- Okay, but why do we see 5 new replicas being rolled out?

- Because `MaxSurge=25%`

  ... So in addition to replacing 2 replicas, the rollout is also starting 3 more

- It rounded down the number of MaxUnavailable pods conservatively,
  &lt;br/&gt;
  but the total number of pods being rolled out is allowed to be 25+25=50%

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

class: extra-details

## The nitty-gritty details

- We start with 10 pods running for the `worker` deployment

- Current settings: MaxUnavailable=25% and MaxSurge=25%

- When we start the rollout:

  - two replicas are taken down (as per MaxUnavailable=25%)
  - two others are created (with the new version) to replace them
  - three others are created (with the new version) per MaxSurge=25%)

- Now we have 8 replicas up and running, and 5 being deployed

- Our rollout is stuck at this point!

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Checking the dashboard during the bad rollout

If you didn't deploy the Kubernetes dashboard earlier, just skip this slide.

.exercise[

- Check which port the dashboard is on:
  ```bash
  kubectl -n kube-system get svc socat
  ```

]

Note the `3xxxx` port.

.exercise[

- Connect to http://oneofournodes:3xxxx/

&lt;!-- ```open https://node1:3xxxx/``` --&gt;

]

--

- We have failures in Deployments, Pods, and Replica Sets

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Recovering from a bad rollout

- We could push some `v0.3` image

  (the pod retry logic will eventually catch it and the rollout will proceed)

- Or we could invoke a manual rollback

.exercise[

&lt;!--
```keys
^C
```
--&gt;

- Cancel the deployment and wait for the dust to settle:
  ```bash
  kubectl rollout undo deploy worker
  kubectl rollout status deploy worker
  ```

]

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Changing rollout parameters

- We want to:

  - revert to `v0.1`
  - be conservative on availability (always have desired number of available workers)
  - go slow on rollout speed (update only one pod at a time) 
  - give some time to our workers to "warm up" before starting more

The corresponding changes can be expressed in the following YAML snippet:

.small[
```yaml
spec:
  template:
    spec:
      containers:
      - name: worker
        image: $REGISTRY/worker:v0.1
  strategy:
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  minReadySeconds: 10
```
]

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

## Applying changes through a YAML patch

- We could use `kubectl edit deployment worker`

- But we could also use `kubectl patch` with the exact YAML shown before

.exercise[

.small[

- Apply all our changes and wait for them to take effect:
  ```bash
  kubectl patch deployment worker -p "
    spec:
      template:
        spec:
          containers:
          - name: worker
            image: $REGISTRY/worker:v0.1
      strategy:
        rollingUpdate:
          maxUnavailable: 0
          maxSurge: 1
      minReadySeconds: 10
    "
  kubectl rollout status deployment worker
  kubectl get deploy -o json worker |
          jq "{name:.metadata.name} + .spec.strategy.rollingUpdate"
  ```
  ] 

]

.debug[[k8s/rollout.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg)]

---

name: toc-healthchecks
class: title

Healthchecks

.nav[
[Previous section](#toc-rolling-updates)
|
[Back to table of contents](#toc-chapter-4)
|
[Next section](#toc-owners-and-dependents-extra-material)
]

.debug[(automatically generated title slide)]

---
# Healthchecks

- Kubernetes provides two kinds of healthchecks: liveness and readiness

- Healthchecks are *probes* that apply to *containers* (not to pods)

- Each container can have two (optional) probes:

  - liveness = is this container dead or alive?

  - readiness = is this container ready to serve traffic?

- Different probes are available (HTTP, TCP, program execution)

- Let's see the difference and how to use them!

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## Liveness probe

- Indicates if the container is dead or alive

- A dead container cannot come back to life

- If the liveness probe fails, the container is killed

  (to make really sure that it's really dead; no zombies or undeads!)

- What happens next depends on the pod's `restartPolicy`:

  - `Never`: the container is not restarted

  - `OnFailure` or `Always`: the container is restarted

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## When to use a liveness probe

- To indicate failures that can't be recovered

  - deadlocks (causing all requests to time out)

  - internal corruption (causing all requests to error)

- If the liveness probe fails *N* consecutive times, the container is killed

- *N* is the `failureThreshold` (3 by default)

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## Readiness probe

- Indicates if the container is ready to serve traffic

- If a container becomes "unready" (let's say busy!) it might be ready again soon

- If the readiness probe fails:

  - the container is *not* killed

  - if the pod is a member of a service, it is temporarily removed

  - it is re-added as soon as the readiness probe passes again

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## When to use a readiness probe

- To indicate temporary failures

  - the application can only service *N* parallel connections

  - the runtime is busy doing garbage collection or initial data load

- The container is marked as "not ready" after `failureThreshold` failed attempts

  (3 by default)

- It is marked again as "ready" after `successThreshold` successful attempts

  (1 by default)

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## Different types of probes

- HTTP request

  - specify URL of the request (and optional headers)

  - any status code between 200 and 399 indicates success

- TCP connection

  - the probe succeeds if the TCP port is open

- arbitrary exec

  - a command is executed in the container

  - exit status of zero indicates success

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## Benefits of using probes

- Rolling updates proceed when containers are *actually ready*

  (as opposed to merely started)

- Containers in a broken state get killed and restarted

  (instead of serving errors or timeouts)

- Overloaded backends get removed from load balancer rotation

  (thus improving response times across the board)

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## Example: HTTP probe

Here is a pod template for the `rng` web service of the DockerCoins app:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: rng-with-liveness
spec:
  containers:
  - name: rng
    image: dockercoins/rng:v0.1
    livenessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 1
```

If the backend serves an error, or takes longer than 1s, 3 times in a row, it gets killed.

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## Example: exec probe

Here is a pod template for a Redis server:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: redis-with-liveness
spec:
  containers:
  - name: redis
    image: redis
    livenessProbe:
      exec:
        command: ["redis-cli", "ping"]
```

If the Redis process becomes unresponsive, it will be killed.

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---

## Details about liveness and readiness probes

- Probes are executed at intervals of `periodSeconds` (default: 10)

- The timeout for a probe is set with `timeoutSeconds` (default: 1)

- A probe is considered successful after `successThreshold` successes (default: 1)

- A probe is considered failing after `failureThreshold` failures (default: 3)

- If a probe is not defined, it's as if there was an "always successful" probe

.debug[[k8s/healthchecks.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md)]
---
## Questions to ask before adding healthchecks

- Do we want liveness, readiness, both?

  (sometimes, we can use the same check, but with different failure thresholds)

- Do we have existing HTTP endpoints that we can use?

- Do we need to add new endpoints, or perhaps use something else?

- Are our healthchecks likely to use resources and/or slow down the app?

- Do they depend on additional services?

  (this can be particularly tricky, see next slide)

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Healthchecks and dependencies

- A good healthcheck should always indicate the health of the service itself

- It should not be affected by the state of the service's dependencies

- Example: a web server requiring a database connection to operate

  (make sure that the healthcheck can report "OK" even if the database is down;
  &lt;br/&gt;
  because it won't help us to restart the web server if the issue is with the DB!)

- Example: a microservice calling other microservices

- Example: a worker process

  (these will generally require minor code changes to report health)

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Adding healthchecks to an app

- Let's add healthchecks to DockerCoins!

- We will examine the questions of the previous slide

- Then we will review each component individually to add healthchecks

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Liveness, readiness, or both?

- To answer that question, we need to see the app run for a while

- Do we get temporary, recoverable glitches?

  → then use readiness

- Or do we get hard lock-ups requiring a restart?

  → then use liveness

- In the case of DockerCoins, we don't know yet!

- Let's pick liveness

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Do we have HTTP endpoints that we can use?

- Each of the 3 web services (hasher, rng, webui) has a trivial route on `/`

- These routes:

  - don't seem to perform anything complex or expensive

  - don't seem to call other services

- Perfect!

  (See next slides for individual details)

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

- [hasher.rb](https://github.com/jpetazzo/container.training/blob/master/dockercoins/hasher/hasher.rb)
  ```ruby
    get '/' do
      "HASHER running on #{Socket.gethostname}\n"
    end
  ```

- [rng.py](https://github.com/jpetazzo/container.training/blob/master/dockercoins/rng/rng.py)
  ```python
    @app.route("/")
    def index():
      return "RNG running on {}\n".format(hostname)
  ```

- [webui.js](https://github.com/jpetazzo/container.training/blob/master/dockercoins/webui/webui.js)
  ```javascript
    app.get('/', function (req, res) {
      res.redirect('/index.html');
    });
  ```

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Running DockerCoins

- We will run DockerCoins in a new, separate namespace

- We will use a set of YAML manifests and pre-built images

- We will add our new liveness probe to the YAML of the `rng` DaemonSet

- Then, we will deploy the application

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Creating a new namespace

- This will make sure that we don't collide / conflict with previous exercises

.exercise[

- Create the yellow namespace:
  ```bash
  kubectl create namespace yellow
  ```

- Switch to that namespace:
  ```bash
  kns yellow
  ```

]

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Retrieving DockerCoins manifests

- All the manifests that we need are on a convenient repository:

  https://github.com/jpetazzo/kubercoins

.exercise[

- Clone that repository:
  ```bash
  cd ~
  git clone https://github.com/jpetazzo/kubercoins
  ```

- Change directory to the repository:
  ```bash
  cd kubercoins
  ```

]

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## A simple HTTP liveness probe

This is what our liveness probe should look like:

```yaml
containers:
- name: ...
image: ...
livenessProbe:
  httpGet:
    path: /
    port: 80
  initialDelaySeconds: 30
  periodSeconds: 5
```

This will give 30 seconds to the service to start. (Way more than necessary!)
&lt;br/&gt;
It will run the probe every 5 seconds.
&lt;br/&gt;
It will use the default timeout (1 second).
&lt;br/&gt;
It will use the default failure threshold (3 failed attempts = dead).
&lt;br/&gt;
It will use the default success threshold (1 successful attempt = alive).

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Adding the liveness probe

- Let's add the liveness probe, then deploy DockerCoins

.exercise[

- Edit `rng-daemonset.yaml` and add the liveness probe
  ```bash
  vim rng-daemonset.yaml
  ```

- Load the YAML for all the resources of DockerCoins:
  ```bash
  kubectl apply -f .
  ```

]

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Testing the liveness probe

- The rng service needs 100ms to process a request

  (because it is single-threaded and sleeps 0.1s in each request)

- The probe timeout is set to 1 second

- If we send more than 10 requests per second per backend, it will break

- Let's generate traffic and see what happens!

.exercise[

- Get the ClusterIP address of the rng service:
  ```bash
  kubectl get svc rng
  ```

]

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Monitoring the rng service

- Each command below will show us what's happening on a different level

.exercise[

- In one window, monitor cluster events:
  ```bash
  kubectl get events -w
  ```

- In another window, monitor the response time of rng:
  ```bash
  httping `&lt;ClusterIP&gt;`
  ```

- In another window, monitor pods status:
  ```bash
  kubectl get pods -w
  ```

]

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Generating traffic

- Let's use `ab` to send concurrent requests to rng

.exercise[

- In yet another window, generate traffic:
  ```bash
  ab -c 10 -n 1000 http://`&lt;ClusterIP&gt;`/1
  ```

- Experiment with higher values of `-c` and see what happens

]

- The `-c` parameter indicates the number of concurrent requests

- The final `/1` is important to generate actual traffic

  (otherwise we would use the ping endpoint, which doesn't sleep 0.1s per request)

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Discussion

- Above a given threshold, the liveness probe starts failing

  (about 10 concurrent requests per backend should be plenty enough)

- When the liveness probe fails 3 times in a row, the container is restarted

- During the restart, there is *less* capacity available

- ... Meaning that the other backends are likely to timeout as well

- ... Eventually causing all backends to be restarted

- ... And each fresh backend gets restarted, too

- This goes on until the load goes down, or we add capacity

*This wouldn't be a good healthcheck in a real application!*

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Better healthchecks

- We need to make sure that the healthcheck doesn't trip when
  performance degrades due to external pressure

- Using a readiness check would have lesser effects

  (but it still would be an imperfect solution)

- A possible combination:

  - readiness check with a short timeout / low failure threshold

  - liveness check with a longer timeout / higher failure treshold

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Healthchecks for redis

- A liveness probe is enough

  (it's not useful to remove a backend from rotation when it's the only one)

- We could use an exec probe running `redis-cli ping`

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

class: extra-details

## Exec probes and zombies

- When using exec probes, we should make sure that we have a *zombie reaper*

  🤔🧐🧟 Wait, what?

- When a process terminates, its parent must call `wait()`/`waitpid()`

  (this is how the parent process retrieves the child's exit status)

- In the meantime, the process is in *zombie* state

  (the process state will show as `Z` in `ps`, `top` ...)

- When a process is killed, its children are *orphaned* and attached to PID 1

- PID 1 has the responsibility if *reaping* these processes when they terminate

- OK, but how does that affect us?

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

class: extra-details

## PID 1 in containers

- On ordinary systems, PID 1 (`/sbin/init`) has logic to reap processes

- In containers, PID 1 is typically our application process

  (e.g. Apache, the JVM, NGINX, Redis ...)

- These *do not* take care of reaping orphans

- If we use exec probes, we need to add a process reaper

- We can add [tini](https://github.com/krallin/tini) to our images

- Or [share the PID namespace between containers of a pod](https://kubernetes.io/docs/tasks/configure-pod-container/share-process-namespace/)

  (and have gcr.io/pause take care of the reaping)

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

## Healthchecks for worker

- Readiness isn't useful

  (because worker isn't a backend for a service)

- Liveness may help us to restart a broken worker, but how can we check it?

- Embedding an HTTP server is an option

  (but it has a high potential for unwanted side-effects and false positives)

- Using a "lease" file can be relatively easy:

  - touch a file during each iteration of the main loop

  - check the timestamp of that file from an exec probe

- Writing logs (and checking them from the probe) also works

.debug[[k8s/healthchecks-more.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/ShippingContainerSFBay.jpg)]

---

name: toc-owners-and-dependents-extra-material
class: title

Owners and dependents (extra material)

.nav[
[Previous section](#toc-healthchecks)
|
[Back to table of contents](#toc-chapter-4)
|
[Next section](#toc-accessing-the-api-with-kubectl-proxy)
]

.debug[(automatically generated title slide)]

---
# Owners and dependents (extra material)

- Some objects are created by other objects

  (example: pods created by replica sets, themselves created by deployments)

- When an *owner* object is deleted, its *dependents* are deleted

  (this is the default behavior; it can be changed)

- We can delete a dependent directly if we want

  (but generally, the owner will recreate another right away)

- An object can have multiple owners

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

## Finding out the owners of an object

- The owners are recorded in the field `ownerReferences` in the `metadata` block

.exercise[

- Let's create a deployment running `nginx`:
  ```bash
  kubectl create deployment yanginx --image=nginx
  ```

- Scale it to a few replicas:
  ```bash
  kubectl scale deployment yanginx --replicas=3
  ```

- Once it's up, check the corresponding pods:
  ```bash
  kubectl get pods -l app=yanginx -o yaml | head -n 25
  ```

]

These pods are owned by a ReplicaSet named yanginx-xxxxxxxxxx.

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

## Listing objects with their owners

- This is a good opportunity to try the `custom-columns` output!

.exercise[

- Show all pods with their owners:
  ```bash
  kubectl get pod -o custom-columns=\
  NAME:.metadata.name,\
  OWNER-KIND:.metadata.ownerReferences[0].kind,\
  OWNER-NAME:.metadata.ownerReferences[0].name
  ```

]

Note: the `custom-columns` option should be one long option (without spaces),
so the lines should not be indented (otherwise the indentation will insert spaces).

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

## Deletion policy

- When deleting an object through the API, three policies are available:

  - foreground (API call returns after all dependents are deleted)

  - background (API call returns immediately; dependents are scheduled for deletion)

  - orphan (the dependents are not deleted)

- When deleting an object with `kubectl`, this is selected with `--cascade`:

  - `--cascade=true` deletes all dependent objects (default)

  - `--cascade=false` orphans dependent objects

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

## What happens when an object is deleted

- It is removed from the list of owners of its dependents

- If, for one of these dependents, the list of owners becomes empty ...

  - if the policy is "orphan", the object stays

  - otherwise, the object is deleted

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

## Orphaning pods

- We are going to delete the Deployment and Replica Set that we created

- ... without deleting the corresponding pods!

.exercise[

- Delete the Deployment:
  ```bash
  kubectl delete deployment -l app=yanginx --cascade=false
  ```

- Delete the Replica Set:
  ```bash
  kubectl delete replicaset -l app=yanginx --cascade=false
  ```

- Check that the pods are still here:
  ```bash
  kubectl get pods
  ```

]

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

class: extra-details

## When and why would we have orphans?

- If we remove an owner and explicitly instruct the API to orphan dependents

  (like on the previous slide)

- If we change the labels on a dependent, so that it's not selected anymore

  (e.g. change the `app: yanginx` in the pods of the previous example)

- If a deployment tool that we're using does these things for us

- If there is a serious problem within API machinery or other components

  (i.e. "this should not happen")

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

## Finding orphan objects

- We're going to output all pods in JSON format

- Then we will use `jq` to keep only the ones *without* an owner

- And we will display their name

.exercise[

- List all pods that *do not* have an owner:
  ```bash
  kubectl get pod -o json | jq -r "
          .items[]
          | select(.metadata.ownerReferences|not)
          | .metadata.name"
  ```

]

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

## Deleting orphan pods

- Now that we can list orphan pods, deleting them is easy

.exercise[

- Add `| xargs kubectl delete pod` to the previous command:
  ```bash
  kubectl get pod -o json | jq -r "
          .items[]
          | select(.metadata.ownerReferences|not)
          | .metadata.name" | xargs kubectl delete pod
  ```

]

As always, the [documentation](https://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/) has useful extra information and pointers.

.debug[[k8s/owners-and-dependents.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/aerial-view-of-containers.jpg)]

---

name: toc-accessing-the-api-with-kubectl-proxy
class: title

Accessing the API with `kubectl proxy`

.nav[
[Previous section](#toc-owners-and-dependents-extra-material)
|
[Back to table of contents](#toc-chapter-5)
|
[Next section](#toc-controlling-the-cluster-remotely)
]

.debug[(automatically generated title slide)]

---
# Accessing the API with `kubectl proxy`

- The API requires us to authenticate.red[¹]

- There are many authentication methods available, including:

  - TLS client certificates
    &lt;br/&gt;
    (that's what we've used so far)

  - HTTP basic password authentication
    &lt;br/&gt;
    (from a static file; not recommended)

  - various token mechanisms
    &lt;br/&gt;
    (detailed in the [documentation](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#authentication-strategies))

.red[¹]OK, we lied. If you don't authenticate, you are considered to
be user `system:anonymous`, which doesn't have any access rights by default.

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## Accessing the API directly

- Let's see what happens if we try to access the API directly with `curl`

.exercise[

- Retrieve the ClusterIP allocated to the `kubernetes` service:
  ```bash
  kubectl get svc kubernetes
  ```

- Replace the IP below and try to connect with `curl`:
  ```bash
  curl -k https://`10.96.0.1`/
  ```

]

The API will tell us that user `system:anonymous` cannot access this path.

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## Authenticating to the API

If we wanted to talk to the API, we would need to:

- extract our TLS key and certificate information from `~/.kube/config`

  (the information is in PEM format, encoded in base64)

- use that information to present our certificate when connecting

  (for instance, with `openssl s_client -key ... -cert ... -connect ...`)

- figure out exactly which credentials to use

  (once we start juggling multiple clusters)

- change that whole process if we're using another authentication method

🤔 There has to be a better way!

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## Using `kubectl proxy` for authentication

- `kubectl proxy` runs a proxy in the foreground

- This proxy lets us access the Kubernetes API without authentication

  (`kubectl proxy` adds our credentials on the fly to the requests)

- This proxy lets us access the Kubernetes API over plain HTTP

- This is a great tool to learn and experiment with the Kubernetes API

- ... And for serious uses as well (suitable for one-shot scripts)

- For unattended use, it's better to create a [service account](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## Trying `kubectl proxy`

- Let's start `kubectl proxy` and then do a simple request with `curl`!

.exercise[

- Start `kubectl proxy` in the background:
  ```bash
  kubectl proxy &amp;
  ```

- Access the API's default route:
  ```bash
  curl localhost:8001
  ```

&lt;!--
```wait /version```
```keys ^J```
--&gt;

- Terminate the proxy:
  ```bash
  kill %1
  ```

]

The output is a list of available API routes.

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## `kubectl proxy` is intended for local use

- By default, the proxy listens on port 8001

  (But this can be changed, or we can tell `kubectl proxy` to pick a port)

- By default, the proxy binds to `127.0.0.1`

  (Making it unreachable from other machines, for security reasons)

- By default, the proxy only accepts connections from:

  `^localhost$,^127\.0\.0\.1$,^\[::1\]$`

- This is great when running `kubectl proxy` locally

- Not-so-great when you want to connect to the proxy from a remote machine

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## Running `kubectl proxy` on a remote machine

- If we wanted to connect to the proxy from another machine, we would need to:

  - bind to `INADDR_ANY` instead of `127.0.0.1`

  - accept connections from any address

- This is achieved with:
  ```
  kubectl proxy --port=8888 --address=0.0.0.0 --accept-hosts=.*
  ```

.warning[Do not do this on a real cluster: it opens full unauthenticated access!]

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## Security considerations

- Running `kubectl proxy` openly is a huge security risk

- It is slightly better to run the proxy where you need it

  (and copy credentials, e.g. `~/.kube/config`, to that place)

- It is even better to use a limited account with reduced permissions

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

## Good to know ...

- `kubectl proxy` also gives access to all internal services

- Specifically, services are exposed as such:
  ```
  /api/v1/namespaces/&lt;namespace&gt;/services/&lt;service&gt;/proxy
  ```

- We can use `kubectl proxy` to access an internal service in a pinch

  (or, for non HTTP services, `kubectl port-forward`)

- This is not very useful when running `kubectl` directly on the cluster

  (since we could connect to the services directly anyway)

- But it is very powerful as soon as you run `kubectl` from a remote machine

.debug[[k8s/kubectlproxy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/blue-containers.jpg)]

---

name: toc-controlling-the-cluster-remotely
class: title

Controlling the cluster remotely

.nav[
[Previous section](#toc-accessing-the-api-with-kubectl-proxy)
|
[Back to table of contents](#toc-chapter-5)
|
[Next section](#toc-accessing-internal-services)
]

.debug[(automatically generated title slide)]

---
# Controlling the cluster remotely

- All the operations that we do with `kubectl` can be done remotely

- In this section, we are going to use `kubectl` from our local machine

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

## Requirements

.warning[The exercises in this chapter should be done *on your local machine*.]

- `kubectl` is officially available on Linux, macOS, Windows

  (and unofficially anywhere we can build and run Go binaries)

- You may skip these exercises if you are following along from:

  - a tablet or phone

  - a web-based terminal

  - an environment where you can't install and run new binaries

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

## Installing `kubectl`

- If you already have `kubectl` on your local machine, you can skip this

.exercise[

&lt;!-- ##VERSION## --&gt;

- Download the `kubectl` binary from one of these links:

  [Linux](https://storage.googleapis.com/kubernetes-release/release/v1.14.2/bin/linux/amd64/kubectl)
  |
  [macOS](https://storage.googleapis.com/kubernetes-release/release/v1.14.2/bin/darwin/amd64/kubectl)
  |
  [Windows](https://storage.googleapis.com/kubernetes-release/release/v1.14.2/bin/windows/amd64/kubectl.exe)

- On Linux and macOS, make the binary executable with `chmod +x kubectl`

  (And remember to run it with `./kubectl` or move it to your `$PATH`)

]

Note: if you are following along with a different platform (e.g. Linux on an architecture different from amd64, or with a phone or tablet), installing `kubectl` might be more complicated (or even impossible) so feel free to skip this section.

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

## Testing `kubectl`

- Check that `kubectl` works correctly

  (before even trying to connect to a remote cluster!)

.exercise[

- Ask `kubectl` to show its version number:
  ```bash
  kubectl version --client
  ```

]

The output should look like this:
```
Client Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.0",
GitCommit:"641856db18352033a0d96dbc99153fa3b27298e5", GitTreeState:"clean",
BuildDate:"2019-03-25T15:53:57Z", GoVersion:"go1.12.1", Compiler:"gc",
Platform:"linux/amd64"}
```

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

## Preserving the existing `~/.kube/config`

- If you already have a `~/.kube/config` file, rename it

  (we are going to overwrite it in the following slides!)

- If you never used `kubectl` on your machine before: nothing to do!

.exercise[

- Make a copy of `~/.kube/config`; if you are using macOS or Linux, you can do:
  ```bash
  cp ~/.kube/config ~/.kube/config.before.training
  ```

- If you are using Windows, you will need to adapt this command

]

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

## Copying the configuration file from `node1`

- The `~/.kube/config` file that is on `node1` contains all the credentials we need

- Let's copy it over!

.exercise[

- Copy the file from `node1`; if you are using macOS or Linux, you can do:
  ```
  scp `USER`@`X.X.X.X`:.kube/config ~/.kube/config
  # Make sure to replace X.X.X.X with the IP address of node1,
  # and USER with the user name used to log into node1!
  ```

- If you are using Windows, adapt these instructions to your SSH client

]

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

## Updating the server address

- There is a good chance that we need to update the server address

- To know if it is necessary, run `kubectl config view`

- Look for the `server:` address:

  - if it matches the public IP address of `node1`, you're good!

  - if it is anything else (especially a private IP address), update it!

- To update the server address, run:
  ```bash
  kubectl config set-cluster kubernetes --server=https://`X.X.X.X`:6443
  # Make sure to replace X.X.X.X with the IP address of node1!
  ```

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

class: extra-details

## What if we get a certificate error?

- Generally, the Kubernetes API uses a certificate that is valid for:

  - `kubernetes`
  - `kubernetes.default`
  - `kubernetes.default.svc`
  - `kubernetes.default.svc.cluster.local`
  - the ClusterIP address of the `kubernetes` service
  - the hostname of the node hosting the control plane (e.g. `node1`)
  - the IP address of the node hosting the control plane

- On most clouds, the IP address of the node is an internal IP address

- ... And we are going to connect over the external IP address

- ... And that external IP address was not used when creating the certificate!

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

class: extra-details

## Working around the certificate error

- We need to tell `kubectl` to skip TLS verification

  (only do this with testing clusters, never in production!)

- The following command will do the trick:
  ```bash
  kubectl config set-cluster kubernetes --insecure-skip-tls-verify
  ```

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

## Checking that we can connect to the cluster

- We can now run a couple of trivial commands to check that all is well

.exercise[

- Check the versions of the local client and remote server:
  ```bash
  kubectl version
  ```

- View the nodes of the cluster:
  ```bash
  kubectl get nodes
  ```

]

We can now utilize the cluster exactly as we did before, except that it's remote.

.debug[[k8s/localkubeconfig.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/chinook-helicopter-container.jpg)]

---

name: toc-accessing-internal-services
class: title

Accessing internal services

.nav[
[Previous section](#toc-controlling-the-cluster-remotely)
|
[Back to table of contents](#toc-chapter-5)
|
[Next section](#toc-the-kubernetes-dashboard)
]

.debug[(automatically generated title slide)]

---
# Accessing internal services

- When we are logged in on a cluster node, we can access internal services

  (by virtue of the Kubernetes network model: all nodes can reach all pods and services)

- When we are accessing a remote cluster, things are different

  (generally, our local machine won't have access to the cluster's internal subnet)

- How can we temporarily access a service without exposing it to everyone?

--

- `kubectl proxy`: gives us access to the API, which includes a proxy for HTTP resources

- `kubectl port-forward`: allows forwarding of TCP ports to arbitrary pods, services, ...

.debug[[k8s/accessinternal.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md)]
---

## Suspension of disbelief

The exercises in this section assume that we have set up `kubectl` on our
local machine in order to access a remote cluster.

We will therefore show how to access services and pods of the remote cluster,
from our local machine.

You can also run these exercises directly on the cluster (if you haven't
installed and set up `kubectl` locally).

Running commands locally will be less useful
(since you could access services and pods directly),
but keep in mind that these commands will work anywhere as long as you have
installed and set up `kubectl` to communicate with your cluster.

.debug[[k8s/accessinternal.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md)]
---

## `kubectl proxy` in theory

- Running `kubectl proxy` gives us access to the entire Kubernetes API

- The API includes routes to proxy HTTP traffic

- These routes look like the following:

  `/api/v1/namespaces/&lt;namespace&gt;/services/&lt;service&gt;/proxy`

- We just add the URI to the end of the request, for instance:

  `/api/v1/namespaces/&lt;namespace&gt;/services/&lt;service&gt;/proxy/index.html`

- We can access `services` and `pods` this way

.debug[[k8s/accessinternal.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md)]
---

## `kubectl proxy` in practice

- Let's access the `webui` service through `kubectl proxy`

.exercise[

- Run an API proxy in the background:
  ```bash
  kubectl proxy &amp;
  ```

- Access the `webui` service:
  ```bash
  curl localhost:8001/api/v1/namespaces/default/services/webui/proxy/index.html
  ```

- Terminate the proxy:
  ```bash
  kill %1
  ```

]

.debug[[k8s/accessinternal.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md)]
---

## `kubectl port-forward` in theory

- What if we want to access a TCP service?

- We can use `kubectl port-forward` instead

- It will create a TCP relay to forward connections to a specific port

  (of a pod, service, deployment...)

- The syntax is:

  `kubectl port-forward service/name_of_service local_port:remote_port`

- If only one port number is specified, it is used for both local and remote ports

.debug[[k8s/accessinternal.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md)]
---

## `kubectl port-forward` in practice

- Let's access our remote Redis server

.exercise[

- Forward connections from local port 10000 to remote port 6379:
  ```bash
  kubectl port-forward svc/redis 10000:6379 &amp;
  ```

- Connect to the Redis server:
  ```bash
  telnet localhost 10000
  ```

- Issue a few commands, e.g. `INFO server` then `QUIT`

&lt;!--
```wait Connected to localhost```
```keys INFO server```
```keys ^J```
```keys QUIT```
```keys ^J```
--&gt;

- Terminate the port forwarder:
  ```bash
  kill %1
  ```

]

.debug[[k8s/accessinternal.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-cranes.jpg)]

---

name: toc-the-kubernetes-dashboard
class: title

The Kubernetes dashboard

.nav[
[Previous section](#toc-accessing-internal-services)
|
[Back to table of contents](#toc-chapter-5)
|
[Next section](#toc-security-implications-of-kubectl-apply)
]

.debug[(automatically generated title slide)]

---
# The Kubernetes dashboard

- Kubernetes resources can also be viewed with a web dashboard

- That dashboard is usually exposed over HTTPS

  (this requires obtaining a proper TLS certificate)

- Dashboard users need to authenticate

- We are going to take a *dangerous* shortcut

.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

## The insecure method

- We could (and should) use [Let's Encrypt](https://letsencrypt.org/) ...

- ... but we don't want to deal with TLS certificates

- We could (and should) learn how authentication and authorization work ...

- ... but we will use a guest account with admin access instead

.footnote[.warning[Yes, this will open our cluster to all kinds of shenanigans. Don't do this at home.]]

.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

## Running a very insecure dashboard

- We are going to deploy that dashboard with *one single command*

- This command will create all the necessary resources

  (the dashboard itself, the HTTP wrapper, the admin/guest account)

- All these resources are defined in a YAML file

- All we have to do is load that YAML file with with `kubectl apply -f`

.exercise[

- Create all the dashboard resources, with the following command:
  ```bash
  kubectl apply -f ~/container.training/k8s/insecure-dashboard.yaml
  ```

]

.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

## Connecting to the dashboard

.exercise[

- Check which port the dashboard is on:
  ```bash
  kubectl get svc dashboard
  ```

]

You'll want the `3xxxx` port.


.exercise[

- Connect to http://oneofournodes:3xxxx/

&lt;!-- ```open http://node1:3xxxx/``` --&gt;

]

The dashboard will then ask you which authentication you want to use.

.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

## Dashboard authentication

- We have three authentication options at this point:

  - token (associated with a role that has appropriate permissions)

  - kubeconfig (e.g. using the `~/.kube/config` file from `node1`)

  - "skip" (use the dashboard "service account")

- Let's use "skip": we're logged in!

--

.warning[By the way, we just added a backdoor to our Kubernetes cluster!]

.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

## Running the Kubernetes dashboard securely

- The steps that we just showed you are *for educational purposes only!*

- If you do that on your production cluster, people [can and will abuse it](https://redlock.io/blog/cryptojacking-tesla)

- For an in-depth discussion about securing the dashboard,
  &lt;br/&gt;
  check [this excellent post on Heptio's blog](https://blog.heptio.com/on-securing-the-kubernetes-dashboard-16b09b1b7aca)

.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-housing.jpg)]

---

name: toc-security-implications-of-kubectl-apply
class: title

Security implications of `kubectl apply`

.nav[
[Previous section](#toc-the-kubernetes-dashboard)
|
[Back to table of contents](#toc-chapter-5)
|
[Next section](#toc-exposing-http-services-with-ingress-resources)
]

.debug[(automatically generated title slide)]

---

# Security implications of `kubectl apply`

- When we do `kubectl apply -f &lt;URL&gt;`, we create arbitrary resources

- Resources can be evil; imagine a `deployment` that ...

--

  - starts bitcoin miners on the whole cluster

--

  - hides in a non-default namespace

--

  - bind-mounts our nodes' filesystem

--

  - inserts SSH keys in the root account (on the node)

--

  - encrypts our data and ransoms it

--

  - ☠️☠️☠️

.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

## `kubectl apply` is the new `curl | sh`

- `curl | sh` is convenient

- It's safe if you use HTTPS URLs from trusted sources

--

- `kubectl apply -f` is convenient

- It's safe if you use HTTPS URLs from trusted sources

- Example: the official setup instructions for most pod networks

--

- It introduces new failure modes

  (for instance, if you try to apply YAML from a link that's no longer valid)


.debug[[k8s/dashboard.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/containers-by-the-water.jpg)]

---

name: toc-exposing-http-services-with-ingress-resources
class: title

Exposing HTTP services with Ingress resources

.nav[
[Previous section](#toc-security-implications-of-kubectl-apply)
|
[Back to table of contents](#toc-chapter-5)
|
[Next section](#toc-volumes)
]

.debug[(automatically generated title slide)]

---
# Exposing HTTP services with Ingress resources

- *Services* give us a way to access a pod or a set of pods

- Services can be exposed to the outside world:

  - with type `NodePort` (on a port &gt;30000)

  - with type `LoadBalancer` (allocating an external load balancer)

- What about HTTP services?

  - how can we expose `webui`, `rng`, `hasher`?

  - the Kubernetes dashboard?

  - a new version of `webui`?

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Exposing HTTP services

- If we use `NodePort` services, clients have to specify port numbers

  (i.e. http://xxxxx:31234 instead of just http://xxxxx)

- `LoadBalancer` services are nice, but:

  - they are not available in all environments

  - they often carry an additional cost (e.g. they provision an ELB)

  - they require one extra step for DNS integration
    &lt;br/&gt;
    (waiting for the `LoadBalancer` to be provisioned; then adding it to DNS)

- We could build our own reverse proxy

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Building a custom reverse proxy

- There are many options available:

  Apache, HAProxy, Hipache, NGINX, Traefik, ...

  (look at [jpetazzo/aiguillage](https://github.com/jpetazzo/aiguillage) for a minimal reverse proxy configuration using NGINX)

- Most of these options require us to update/edit configuration files after each change

- Some of them can pick up virtual hosts and backends from a configuration store

- Wouldn't it be nice if this configuration could be managed with the Kubernetes API?

--

- Enter.red[¹] *Ingress* resources!

.footnote[.red[¹] Pun maybe intended.]

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Ingress resources

- Kubernetes API resource (`kubectl get ingress`/`ingresses`/`ing`)

- Designed to expose HTTP services

- Basic features:

  - load balancing
  - SSL termination
  - name-based virtual hosting

- Can also route to different services depending on:

  - URI path (e.g. `/api`→`api-service`, `/static`→`assets-service`)
  - Client headers, including cookies (for A/B testing, canary deployment...)
  - and more!

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Principle of operation

- Step 1: deploy an *ingress controller*

  - ingress controller = load balancer + control loop

  - the control loop watches over ingress resources, and configures the LB accordingly

- Step 2: set up DNS

  - associate DNS entries with the load balancer address

- Step 3: create *ingress resources*

  - the ingress controller picks up these resources and configures the LB

- Step 4: profit!

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Ingress in action

- We will deploy the Traefik ingress controller

  - this is an arbitrary choice

  - maybe motivated by the fact that Traefik releases are named after cheeses

- For DNS, we will use [nip.io](http://nip.io/)

  - `*.1.2.3.4.nip.io` resolves to `1.2.3.4`

- We will create ingress resources for various HTTP services

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Deploying pods listening on port 80

- We want our ingress load balancer to be available on port 80

- We could do that with a `LoadBalancer` service

  ... but it requires support from the underlying infrastructure

- We could use pods specifying `hostPort: 80` 

  ... but with most CNI plugins, this [doesn't work or requires additional setup](https://github.com/kubernetes/kubernetes/issues/23920)

- We could use a `NodePort` service

  ... but that requires [changing the `--service-node-port-range` flag in the API server](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/)

- Last resort: the `hostNetwork` mode

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Without `hostNetwork`

- Normally, each pod gets its own *network namespace*

  (sometimes called sandbox or network sandbox)

- An IP address is assigned to the pod

- This IP address is routed/connected to the cluster network

- All containers of that pod are sharing that network namespace

  (and therefore using the same IP address)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## With `hostNetwork: true`

- No network namespace gets created

- The pod is using the network namespace of the host

- It "sees" (and can use) the interfaces (and IP addresses) of the host

- The pod can receive outside traffic directly, on any port

- Downside: with most network plugins, network policies won't work for that pod

  - most network policies work at the IP address level

  - filtering that pod = filtering traffic from the node

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Running Traefik

- The [Traefik documentation](https://docs.traefik.io/user-guide/kubernetes/#deploy-trfik-using-a-deployment-or-daemonset) tells us to pick between Deployment and Daemon Set

- We are going to use a Daemon Set so that each node can accept connections

- We will do two minor changes to the [YAML provided by Traefik](https://github.com/containous/traefik/blob/v1.7/examples/k8s/traefik-ds.yaml):

  - enable `hostNetwork`

  - add a *toleration* so that Traefik also runs on `node1`

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Taints and tolerations

- A *taint* is an attribute added to a node

- It prevents pods from running on the node

- ... Unless they have a matching *toleration*

- When deploying with `kubeadm`:

  - a taint is placed on the node dedicated to the control plane

  - the pods running the control plane have a matching toleration

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

class: extra-details

## Checking taints on our nodes

.exercise[

- Check our nodes specs:
  ```bash
  kubectl get node node1 -o json | jq .spec
  kubectl get node node2 -o json | jq .spec
  ```

]

We should see a result only for `node1` (the one with the control plane):

```json
  "taints": [
    {
      "effect": "NoSchedule",
      "key": "node-role.kubernetes.io/master"
    }
  ]
```

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

class: extra-details

## Understanding a taint

- The `key` can be interpreted as:

  - a reservation for a special set of pods
    &lt;br/&gt;
    (here, this means "this node is reserved for the control plane")

  - an error condition on the node
    &lt;br/&gt;
    (for instance: "disk full," do not start new pods here!)

- The `effect` can be:

  - `NoSchedule` (don't run new pods here)

  - `PreferNoSchedule` (try not to run new pods here)

  - `NoExecute` (don't run new pods and evict running pods)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

class: extra-details

## Checking tolerations on the control plane

.exercise[

- Check tolerations for CoreDNS:
  ```bash
  kubectl -n kube-system get deployments coredns -o json |
          jq .spec.template.spec.tolerations
  ```

]

The result should include:
```json
  {
    "effect": "NoSchedule",
    "key": "node-role.kubernetes.io/master"
  }
```

It means: "bypass the exact taint that we saw earlier on `node1`."

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

class: extra-details

## Special tolerations

.exercise[

- Check tolerations on `kube-proxy`:
  ```bash
  kubectl -n kube-system get ds kube-proxy -o json | 
          jq .spec.template.spec.tolerations
  ```

]

The result should include:
```json
  {
    "operator": "Exists"
  }
```

This one is a special case that means "ignore all taints and run anyway."

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Running Traefik on our cluster

- We provide a YAML file (`k8s/traefik.yaml`) which is essentially the sum of:

  - [Traefik's Daemon Set resources](https://github.com/containous/traefik/blob/v1.7/examples/k8s/traefik-ds.yaml) (patched with `hostNetwork` and tolerations)

  - [Traefik's RBAC rules](https://github.com/containous/traefik/blob/v1.7/examples/k8s/traefik-rbac.yaml) allowing it to watch necessary API objects

.exercise[

- Apply the YAML:
  ```bash
  kubectl apply -f ~/container.training/k8s/traefik.yaml
  ```

]

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Checking that Traefik runs correctly

- If Traefik started correctly, we now have a web server listening on each node

.exercise[

- Check that Traefik is serving 80/tcp:
  ```bash
  curl localhost
  ```

]

We should get a `404 page not found` error.

This is normal: we haven't provided any ingress rule yet.

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Setting up DNS

- To make our lives easier, we will use [nip.io](http://nip.io)

- Check out `http://cheddar.A.B.C.D.nip.io`

  (replacing A.B.C.D with the IP address of `node1`)

- We should get the same `404 page not found` error

  (meaning that our DNS is "set up properly", so to speak!)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Traefik web UI

- Traefik provides a web dashboard

- With the current install method, it's listening on port 8080

.exercise[

- Go to `http://node1:8080` (replacing `node1` with its IP address)

&lt;!-- ```open http://node1:8080``` --&gt;

]

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Setting up host-based routing ingress rules

- We are going to use `errm/cheese` images

  (there are [3 tags available](https://hub.docker.com/r/errm/cheese/tags/): wensleydale, cheddar, stilton)

- These images contain a simple static HTTP server sending a picture of cheese

- We will run 3 deployments (one for each cheese)

- We will create 3 services (one for each deployment)

- Then we will create 3 ingress rules (one for each service)

- We will route `&lt;name-of-cheese&gt;.A.B.C.D.nip.io` to the corresponding deployment

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Running cheesy web servers

.exercise[

- Run all three deployments:
  ```bash
  kubectl create deployment cheddar --image=errm/cheese:cheddar
  kubectl create deployment stilton --image=errm/cheese:stilton
  kubectl create deployment wensleydale --image=errm/cheese:wensleydale
  ```

- Create a service for each of them:
  ```bash
  kubectl expose deployment cheddar --port=80
  kubectl expose deployment stilton --port=80
  kubectl expose deployment wensleydale --port=80
  ```

]

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## What does an ingress resource look like?

Here is a minimal host-based ingress resource:

```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: cheddar
spec:
  rules:
  - host: cheddar.`A.B.C.D`.nip.io
    http:
      paths:
      - path: /
        backend:
          serviceName: cheddar
          servicePort: 80

```

(It is in `k8s/ingress.yaml`.)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Creating our first ingress resources

.exercise[

- Edit the file `~/container.training/k8s/ingress.yaml`

- Replace A.B.C.D with the IP address of `node1`

- Apply the file

- Open http://cheddar.A.B.C.D.nip.io

]

(An image of a piece of cheese should show up.)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Creating the other ingress resources

.exercise[

- Edit the file `~/container.training/k8s/ingress.yaml`

- Replace `cheddar` with `stilton` (in `name`, `host`, `serviceName`)

- Apply the file

- Check that `stilton.A.B.C.D.nip.io` works correctly

- Repeat for `wensleydale`

]

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Using multiple ingress controllers

- You can have multiple ingress controllers active simultaneously

  (e.g. Traefik and NGINX)

- You can even have multiple instances of the same controller

  (e.g. one for internal, another for external traffic)

- The `kubernetes.io/ingress.class` annotation can be used to tell which one to use

- It's OK if multiple ingress controllers configure the same resource

  (it just means that the service will be accessible through multiple paths)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Ingress: the good

- The traffic flows directly from the ingress load balancer to the backends

  - it doesn't need to go through the `ClusterIP`

  - in fact, we don't even need a `ClusterIP` (we can use a headless service)

- The load balancer can be outside of Kubernetes

  (as long as it has access to the cluster subnet)

- This allows the use of external (hardware, physical machines...) load balancers

- Annotations can encode special features

  (rate-limiting, A/B testing, session stickiness, etc.)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

## Ingress: the bad

- Aforementioned "special features" are not standardized yet

- Some controllers will support them; some won't

- Even relatively common features (stripping a path prefix) can differ:

  - [traefik.ingress.kubernetes.io/rule-type: PathPrefixStrip](https://docs.traefik.io/user-guide/kubernetes/#path-based-routing)

  - [ingress.kubernetes.io/rewrite-target: /](https://github.com/kubernetes/contrib/tree/master/ingress/controllers/nginx/examples/rewrite)

- This should eventually stabilize

  (remember that ingresses are currently `apiVersion: extensions/v1beta1`)

.debug[[k8s/ingress.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/distillery-containers.jpg)]

---

name: toc-volumes
class: title

Volumes

.nav[
[Previous section](#toc-exposing-http-services-with-ingress-resources)
|
[Back to table of contents](#toc-chapter-6)
|
[Next section](#toc-managing-configuration)
]

.debug[(automatically generated title slide)]

---
# Volumes

- Volumes are special directories that are mounted in containers

- Volumes can have many different purposes:

  - share files and directories between containers running on the same machine

  - share files and directories between containers and their host

  - centralize configuration information in Kubernetes and expose it to containers

  - manage credentials and secrets and expose them securely to containers

  - store persistent data for stateful services

  - access storage systems (like Ceph, EBS, NFS, Portworx, and many others)

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

class: extra-details

## Kubernetes volumes vs. Docker volumes

- Kubernetes and Docker volumes are very similar

  (the [Kubernetes documentation](https://kubernetes.io/docs/concepts/storage/volumes/) says otherwise ...
  &lt;br/&gt;
  but it refers to Docker 1.7, which was released in 2015!)

- Docker volumes allow us to share data between containers running on the same host

- Kubernetes volumes allow us to share data between containers in the same pod

- Both Docker and Kubernetes volumes enable access to storage systems

- Kubernetes volumes are also used to expose configuration and secrets

- Docker has specific concepts for configuration and secrets
  &lt;br/&gt;
  (but under the hood, the technical implementation is similar)

- If you're not familiar with Docker volumes, you can safely ignore this slide!

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## Volumes ≠ Persistent Volumes

- Volumes and Persistent Volumes are related, but very different!

- *Volumes*:

  - appear in Pod specifications (see next slide)

  - do not exist as API resources (**cannot** do `kubectl get volumes`)

- *Persistent Volumes*:

  - are API resources (**can** do `kubectl get persistentvolumes`)

  - correspond to concrete volumes (e.g. on a SAN, EBS, etc.)

  - cannot be associated with a Pod directly; but through a Persistent Volume Claim

  - won't be discussed further in this section

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## A simple volume example

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-with-volume
spec:
  volumes:
  - name: www
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: www
      mountPath: /usr/share/nginx/html/
```

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## A simple volume example, explained

- We define a standalone `Pod` named `nginx-with-volume`

- In that pod, there is a volume named `www`

- No type is specified, so it will default to `emptyDir`

  (as the name implies, it will be initialized as an empty directory at pod creation)

- In that pod, there is also a container named `nginx`

- That container mounts the volume `www` to path `/usr/share/nginx/html/`

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## A volume shared between two containers

.small[
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-with-volume
spec:
  volumes:
  - name: www
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: www
      mountPath: /usr/share/nginx/html/
  - name: git
    image: alpine
    command: [ "sh", "-c", "apk add --no-cache git &amp;&amp; git clone https://github.com/octocat/Spoon-Knife /www" ]
    volumeMounts:
    - name: www
      mountPath: /www/
  restartPolicy: OnFailure
```
]

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## Sharing a volume, explained

- We added another container to the pod

- That container mounts the `www` volume on a different path (`/www`)

- It uses the `alpine` image

- When started, it installs `git` and clones the `octocat/Spoon-Knife` repository

  (that repository contains a tiny HTML website)

- As a result, NGINX now serves this website

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## Sharing a volume, in action

- Let's try it!

.exercise[

- Create the pod by applying the YAML file:
  ```bash
  kubectl apply -f ~/container.training/k8s/nginx-with-volume.yaml
  ```

- Check the IP address that was allocated to our pod:
  ```bash
  kubectl get pod nginx-with-volume -o wide
  IP=$(kubectl get pod nginx-with-volume -o json | jq -r .status.podIP)
  ```

- Access the web server:
  ```bash
  curl $IP
  ```

]

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## The devil is in the details

- The default `restartPolicy` is `Always`

- This would cause our `git` container to run again ... and again ... and again

  (with an exponential back-off delay, as explained [in the documentation](https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy))

- That's why we specified `restartPolicy: OnFailure`

- There is a short period of time during which the website is not available

  (because the `git` container hasn't done its job yet)

- This could be avoided by using [Init Containers](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/)

  (we will see a live example in a few sections)

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

## Volume lifecycle

- The lifecycle of a volume is linked to the pod's lifecycle

- This means that a volume is created when the pod is created

- This is mostly relevant for `emptyDir` volumes

  (other volumes, like remote storage, are not "created" but rather "attached" )

- A volume survives across container restarts

- A volume is destroyed (or, for remote storage, detached) when the pod is destroyed

.debug[[k8s/volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/lots-of-containers.jpg)]

---

name: toc-managing-configuration
class: title

Managing configuration

.nav[
[Previous section](#toc-volumes)
|
[Back to table of contents](#toc-chapter-6)
|
[Next section](#toc-accessing-logs-from-the-cli)
]

.debug[(automatically generated title slide)]

---
# Managing configuration

- Some applications need to be configured (obviously!)

- There are many ways for our code to pick up configuration:

  - command-line arguments

  - environment variables

  - configuration files

  - configuration servers (getting configuration from a database, an API...)

  - ... and more (because programmers can be very creative!)

- How can we do these things with containers and Kubernetes?

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Passing configuration to containers

- There are many ways to pass configuration to code running in a container:

  - baking it into a custom image

  - command-line arguments

  - environment variables

  - injecting configuration files

  - exposing it over the Kubernetes API

  - configuration servers

- Let's review these different strategies!

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Baking custom images

- Put the configuration in the image

  (it can be in a configuration file, but also `ENV` or `CMD` actions)

- It's easy! It's simple!

- Unfortunately, it also has downsides:

  - multiplication of images

  - different images for dev, staging, prod ...

  - minor reconfigurations require a whole build/push/pull cycle

- Avoid doing it unless you don't have the time to figure out other options

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Command-line arguments

- Pass options to `args` array in the container specification

- Example ([source](https://github.com/coreos/pods/blob/master/kubernetes.yaml#L29)): 
  ```yaml
      args: 
        - "--data-dir=/var/lib/etcd"
        - "--advertise-client-urls=http://127.0.0.1:2379"
        - "--listen-client-urls=http://127.0.0.1:2379"
        - "--listen-peer-urls=http://127.0.0.1:2380"
        - "--name=etcd"
  ```

- The options can be passed directly to the program that we run ...

  ... or to a wrapper script that will use them to e.g. generate a config file

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Command-line arguments, pros &amp; cons

- Works great when options are passed directly to the running program

  (otherwise, a wrapper script can work around the issue)

- Works great when there aren't too many parameters

  (to avoid a 20-lines `args` array)

- Requires documentation and/or understanding of the underlying program

  ("which parameters and flags do I need, again?")

- Well-suited for mandatory parameters (without default values)

- Not ideal when we need to pass a real configuration file anyway

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Environment variables

- Pass options through the `env` map in the container specification

- Example:
  ```yaml
      env:
      - name: ADMIN_PORT
        value: "8080"
      - name: ADMIN_AUTH
        value: Basic
      - name: ADMIN_CRED
        value: "admin:0pensesame!"
  ```

.warning[`value` must be a string! Make sure that numbers and fancy strings are quoted.]

🤔 Why this weird `{name: xxx, value: yyy}` scheme? It will be revealed soon!

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## The downward API

- In the previous example, environment variables have fixed values

- We can also use a mechanism called the *downward API*

- The downward API allows exposing pod or container information

  - either through special files (we won't show that for now)

  - or through environment variables

- The value of these environment variables is computed when the container is started

- Remember: environment variables won't (can't) change after container start

- Let's see a few concrete examples!

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Exposing the pod's namespace

```yaml
    - name: MY_POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
```

- Useful to generate FQDN of services

  (in some contexts, a short name is not enough)

- For instance, the two commands should be equivalent:
  ```
  curl api-backend
  curl api-backend.$MY_POD_NAMESPACE.svc.cluster.local
  ```

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Exposing the pod's IP address

```yaml
    - name: MY_POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
```

- Useful if we need to know our IP address

  (we could also read it from `eth0`, but this is more solid)

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Exposing the container's resource limits

```yaml
    - name: MY_MEM_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: test-container
          resource: limits.memory
```

- Useful for runtimes where memory is garbage collected

- Example: the JVM

  (the memory available to the JVM should be set with the `-Xmx ` flag)

- Best practice: set a memory limit, and pass it to the runtime

  (see [this blog post](https://very-serio.us/2017/12/05/running-jvms-in-kubernetes/) for a detailed example)

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## More about the downward API

- [This documentation page](https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/) tells more about these environment variables

- And [this one](https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/) explains the other way to use the downward API

  (through files that get created in the container filesystem)

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Environment variables, pros and cons

- Works great when the running program expects these variables

- Works great for optional parameters with reasonable defaults

  (since the container image can provide these defaults)

- Sort of auto-documented

  (we can see which environment variables are defined in the image, and their values)

- Can be (ab)used with longer values ...

- ... You *can* put an entire Tomcat configuration file in an environment ...

- ... But *should* you?

(Do it if you really need to, we're not judging! But we'll see better ways.)

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Injecting configuration files

- Sometimes, there is no way around it: we need to inject a full config file

- Kubernetes provides a mechanism for that purpose: `configmaps`

- A configmap is a Kubernetes resource that exists in a namespace

- Conceptually, it's a key/value map

  (values are arbitrary strings)

- We can think about them in (at least) two different ways:

  - as holding entire configuration file(s)

  - as holding individual configuration parameters

*Note: to hold sensitive information, we can use "Secrets", which
are another type of resource behaving very much like configmaps.
We'll cover them just after!*

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Configmaps storing entire files

- In this case, each key/value pair corresponds to a configuration file

- Key = name of the file

- Value = content of the file

- There can be one key/value pair, or as many as necessary

  (for complex apps with multiple configuration files)

- Examples:
  ```
  # Create a configmap with a single key, "app.conf"
  kubectl create configmap my-app-config --from-file=app.conf
  # Create a configmap with a single key, "app.conf" but another file
  kubectl create configmap my-app-config --from-file=app.conf=app-prod.conf
  # Create a configmap with multiple keys (one per file in the config.d directory)
  kubectl create configmap my-app-config --from-file=config.d/
  ```

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Configmaps storing individual parameters

- In this case, each key/value pair corresponds to a parameter

- Key = name of the parameter

- Value = value of the parameter

- Examples:
  ```
  # Create a configmap with two keys
  kubectl create cm my-app-config \
      --from-literal=foreground=red \
      --from-literal=background=blue
  
  # Create a configmap from a file containing key=val pairs
  kubectl create cm my-app-config \
      --from-env-file=app.conf
  ```

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Exposing configmaps to containers

- Configmaps can be exposed as plain files in the filesystem of a container

  - this is achieved by declaring a volume and mounting it in the container

  - this is particularly effective for configmaps containing whole files

- Configmaps can be exposed as environment variables in the container

  - this is achieved with the downward API

  - this is particularly effective for configmaps containing individual parameters

- Let's see how to do both!

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Passing a configuration file with a configmap

- We will start a load balancer powered by HAProxy

- We will use the [official `haproxy` image](https://hub.docker.com/_/haproxy/)

- It expects to find its configuration in `/usr/local/etc/haproxy/haproxy.cfg`

- We will provide a simple HAproxy configuration, `k8s/haproxy.cfg`

- It listens on port 80, and load balances connections between IBM and Google

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Creating the configmap

.exercise[

- Go to the `k8s` directory in the repository:
  ```bash
  cd ~/container.training/k8s
  ```

- Create a configmap named `haproxy` and holding the configuration file:
  ```bash
  kubectl create configmap haproxy --from-file=haproxy.cfg
  ```

- Check what our configmap looks like:
  ```bash
  kubectl get configmap haproxy -o yaml
  ```

]

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Using the configmap

We are going to use the following pod definition:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: haproxy
spec:
  volumes:
  - name: config
    configMap:
      name: haproxy
  containers:
  - name: haproxy
    image: haproxy
    volumeMounts:
    - name: config
      mountPath: /usr/local/etc/haproxy/
```

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Using the configmap

- The resource definition from the previous slide is in `k8s/haproxy.yaml`

.exercise[

- Create the HAProxy pod:
  ```bash
  kubectl apply -f ~/container.training/k8s/haproxy.yaml
  ```

&lt;!-- ```hide kubectl wait pod haproxy --for condition=ready``` --&gt;

- Check the IP address allocated to the pod:
  ```bash
  kubectl get pod haproxy -o wide
  IP=$(kubectl get pod haproxy -o json | jq -r .status.podIP)
  ```

]

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Testing our load balancer

- The load balancer will send:

  - half of the connections to Google

  - the other half to IBM

.exercise[

- Access the load balancer a few times:
  ```bash
  curl $IP
  curl $IP
  curl $IP
  ```

]

We should see connections served by Google, and others served by IBM.
&lt;br/&gt;
(Each server sends us a redirect page. Look at the URL that they send us to!)

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Exposing configmaps with the downward API

- We are going to run a Docker registry on a custom port

- By default, the registry listens on port 5000

- This can be changed by setting environment variable `REGISTRY_HTTP_ADDR`

- We are going to store the port number in a configmap

- Then we will expose that configmap as a container environment variable

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Creating the configmap

.exercise[

- Our configmap will have a single key, `http.addr`:
  ```bash
  kubectl create configmap registry --from-literal=http.addr=0.0.0.0:80
  ```

- Check our configmap:
  ```bash
  kubectl get configmap registry -o yaml
  ```

]

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Using the configmap

We are going to use the following pod definition:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: registry
spec:
  containers:
  - name: registry
    image: registry
    env:
    - name: REGISTRY_HTTP_ADDR
      valueFrom:
        configMapKeyRef:
          name: registry
          key: http.addr
```

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Using the configmap

- The resource definition from the previous slide is in `k8s/registry.yaml`

.exercise[

- Create the registry pod:
  ```bash
  kubectl apply -f ~/container.training/k8s/registry.yaml
  ```

&lt;!-- ```hide kubectl wait pod registry --for condition=ready``` --&gt;

- Check the IP address allocated to the pod:
  ```bash
  kubectl get pod registry -o wide
  IP=$(kubectl get pod registry -o json | jq -r .status.podIP)
  ```

- Confirm that the registry is available on port 80:
  ```bash
  curl $IP/v2/_catalog
  ```

]

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Passwords, tokens, sensitive information

- For sensitive information, there is another special resource: *Secrets*

- Secrets and Configmaps work almost the same way

  (we'll expose the differences on the next slide)

- The *intent* is different, though:

  *"You should use secrets for things which are actually secret like API keys, 
  credentials, etc., and use config map for not-secret configuration data."*

  *"In the future there will likely be some differentiators for secrets like rotation or support for backing the secret API w/ HSMs, etc."*

  (Source: [the author of both features](https://stackoverflow.com/a/36925553/580281
))

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

## Differences between configmaps and secrets
 
- Secrets are base64-encoded when shown with `kubectl get secrets -o yaml`

  - keep in mind that this is just *encoding*, not *encryption*

  - it is very easy to [automatically extract and decode secrets](https://medium.com/@mveritym/decoding-kubernetes-secrets-60deed7a96a3)

- [Secrets can be encrypted at rest](https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/)

- With RBAC, we can authorize a user to access configmaps, but not secrets

  (since they are two different kinds of resources)

.debug[[k8s/configuration.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/plastic-containers.JPG)]

---

name: toc-accessing-logs-from-the-cli
class: title

Accessing logs from the CLI

.nav[
[Previous section](#toc-managing-configuration)
|
[Back to table of contents](#toc-chapter-6)
|
[Next section](#toc-centralized-logging)
]

.debug[(automatically generated title slide)]

---
# Accessing logs from the CLI

- The `kubectl logs` commands has limitations:

  - it cannot stream logs from multiple pods at a time

  - when showing logs from multiple pods, it mixes them all together

- We are going to see how to do it better

.debug[[k8s/logs-cli.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md)]
---

## Doing it manually

- We *could* (if we were so inclined), write a program or script that would:

  - take a selector as an argument

  - enumerate all pods matching that selector (with `kubectl get -l ...`)

  - fork one `kubectl logs --follow ...` command per container

  - annotate the logs (the output of each `kubectl logs ...` process) with their origin

  - preserve ordering by using `kubectl logs --timestamps ...` and merge the output

--

- We *could* do it, but thankfully, others did it for us already!

.debug[[k8s/logs-cli.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md)]
---

## Stern

[Stern](https://github.com/wercker/stern) is an open source project
by [Wercker](http://www.wercker.com/).

From the README:

*Stern allows you to tail multiple pods on Kubernetes and multiple containers within the pod. Each result is color coded for quicker debugging.*

*The query is a regular expression so the pod name can easily be filtered and you don't need to specify the exact id (for instance omitting the deployment id). If a pod is deleted it gets removed from tail and if a new pod is added it automatically gets tailed.*

Exactly what we need!

.debug[[k8s/logs-cli.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md)]
---

## Installing Stern

- Run `stern` (without arguments) to check if it's installed:

  ```
  $ stern
  Tail multiple pods and containers from Kubernetes

  Usage:
    stern pod-query [flags]
  ```

- If it is not installed, the easiest method is to download a [binary release](https://github.com/wercker/stern/releases)

- The following commands will install Stern on a Linux Intel 64 bit machine:
  ```bash
  sudo curl -L -o /usr/local/bin/stern \
       https://github.com/wercker/stern/releases/download/1.10.0/stern_linux_amd64
  sudo chmod +x /usr/local/bin/stern
  ```

&lt;!-- ##VERSION## --&gt;

.debug[[k8s/logs-cli.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md)]
---

## Using Stern

- There are two ways to specify the pods for which we want to see the logs:

  - `-l` followed by a selector expression (like with many `kubectl` commands)

  - with a "pod query", i.e. a regex used to match pod names

- These two ways can be combined if necessary

.exercise[

- View the logs for all the rng containers:
  ```bash
  stern rng
  ```

&lt;!--
```wait HTTP/1.1```
```keys ^C```
--&gt;

]

.debug[[k8s/logs-cli.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md)]
---

## Stern convenient options

- The `--tail N` flag shows the last `N` lines for each container

  (Instead of showing the logs since the creation of the container)

- The `-t` / `--timestamps` flag shows timestamps

- The `--all-namespaces` flag is self-explanatory

.exercise[

- View what's up with the `weave` system containers:
  ```bash
  stern --tail 1 --timestamps --all-namespaces weave
  ```

&lt;!--
```wait weave-npc```
```keys ^C```
--&gt;

]

.debug[[k8s/logs-cli.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md)]
---

## Using Stern with a selector

- When specifying a selector, we can omit the value for a label

- This will match all objects having that label (regardless of the value)

- Everything created with `kubectl run` has a label `run`

- We can use that property to view the logs of all the pods created with `kubectl run`

- Similarly, everything created with `kubectl create deployment` has a label `app`

.exercise[

- View the logs for all the things started with `kubectl create deployment`:
  ```bash
  stern -l app
  ```

&lt;!--
```wait units of work```
```keys ^C```
--&gt;

]

.debug[[k8s/logs-cli.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-1.jpg)]

---

name: toc-centralized-logging
class: title

Centralized logging

.nav[
[Previous section](#toc-accessing-logs-from-the-cli)
|
[Back to table of contents](#toc-chapter-6)
|
[Next section](#toc-namespaces)
]

.debug[(automatically generated title slide)]

---
# Centralized logging

- Using `kubectl` or `stern` is simple; but it has drawbacks:

  - when a node goes down, its logs are not available anymore

  - we can only dump or stream logs; we want to search/index/count...

- We want to send all our logs to a single place

- We want to parse them (e.g. for HTTP logs) and index them

- We want a nice web dashboard

--

- We are going to deploy an EFK stack

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

## What is EFK?

- EFK is three components:

  - ElasticSearch (to store and index log entries)

  - Fluentd (to get container logs, process them, and put them in ElasticSearch)

  - Kibana (to view/search log entries with a nice UI)

- The only component that we need to access from outside the cluster will be Kibana

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

## Deploying EFK on our cluster

- We are going to use a YAML file describing all the required resources

.exercise[

- Load the YAML file into our cluster:
  ```bash
  kubectl apply -f ~/container.training/k8s/efk.yaml
  ```

]

If we [look at the YAML file](https://github.com/jpetazzo/container.training/blob/master/k8s/efk.yaml), we see that
it creates a daemon set, two deployments, two services,
and a few roles and role bindings (to give fluentd the required permissions).

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

## The itinerary of a log line (before Fluentd)

- A container writes a line on stdout or stderr

- Both are typically piped to the container engine (Docker or otherwise)

- The container engine reads the line, and sends it to a logging driver

- The timestamp and stream (stdout or stderr) is added to the log line

- With the default configuration for Kubernetes, the line is written to a JSON file

  (`/var/log/containers/pod-name_namespace_container-id.log`)

- That file is read when we invoke `kubectl logs`; we can access it directly too

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

## The itinerary of a log line (with Fluentd)

- Fluentd runs on each node (thanks to a daemon set)

- It binds-mounts `/var/log/containers` from the host (to access these files)

- It continuously scans this directory for new files; reads them; parses them

- Each log line becomes a JSON object, fully annotated with extra information:
  &lt;br/&gt;container id, pod name, Kubernetes labels ...

- These JSON objects are stored in ElasticSearch

- ElasticSearch indexes the JSON objects

- We can access the logs through Kibana (and perform searches, counts, etc.)

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

## Accessing Kibana

- Kibana offers a web interface that is relatively straightforward

- Let's check it out!

.exercise[

- Check which `NodePort` was allocated to Kibana:
  ```bash
  kubectl get svc kibana
  ```

- With our web browser, connect to Kibana

]

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

## Using Kibana

*Note: this is not a Kibana workshop! So this section is deliberately very terse.*

- The first time you connect to Kibana, you must "configure an index pattern"

- Just use the one that is suggested, `@timestamp`.red[*]

- Then click "Discover" (in the top-left corner)

- You should see container logs

- Advice: in the left column, select a few fields to display, e.g.:

  `kubernetes.host`, `kubernetes.pod_name`, `stream`, `log`

.red[*]If you don't see `@timestamp`, it's probably because no logs exist yet.
&lt;br/&gt;Wait a bit, and double-check the logging pipeline!

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

## Caveat emptor

We are using EFK because it is relatively straightforward
to deploy on Kubernetes, without having to redeploy or reconfigure
our cluster. But it doesn't mean that it will always be the best
option for your use-case. If you are running Kubernetes in the
cloud, you might consider using the cloud provider's logging
infrastructure (if it can be integrated with Kubernetes).

The deployment method that we will use here has been simplified:
there is only one ElasticSearch node. In a real deployment, you
might use a cluster, both for performance and reliability reasons.
But this is outside of the scope of this chapter.

The YAML file that we used creates all the resources in the
`default` namespace, for simplicity. In a real scenario, you will
create the resources in the `kube-system` namespace or in a dedicated namespace.

.debug[[k8s/logs-centralized.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-2.jpg)]

---

name: toc-namespaces
class: title

Namespaces

.nav[
[Previous section](#toc-centralized-logging)
|
[Back to table of contents](#toc-chapter-7)
|
[Next section](#toc-kustomize)
]

.debug[(automatically generated title slide)]

---
# Namespaces

- We would like to deploy another copy of DockerCoins on our cluster

- We could rename all our deployments and services:

  hasher → hasher2, redis → redis2, rng → rng2, etc.

- That would require updating the code

- There has to be a better way!

--

- As hinted by the title of this section, we will use *namespaces*

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Identifying a resource

- We cannot have two resources with the same name

  (or can we...?)

--

- We cannot have two resources *of the same kind* with the same name

  (but it's OK to have an `rng` service, an `rng` deployment, and an `rng` daemon set)

--

- We cannot have two resources of the same kind with the same name *in the same namespace*

  (but it's OK to have e.g. two `rng` services in different namespaces)

--

- Except for resources that exist at the *cluster scope*

  (these do not belong to a namespace)

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Uniquely identifying a resource

- For *namespaced* resources:

  the tuple *(kind, name, namespace)* needs to be unique

- For resources at the *cluster scope*:

  the tuple *(kind, name)* needs to be unique

.exercise[

- List resource types again, and check the NAMESPACED column:
  ```bash
  kubectl api-resources
  ```

]

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Pre-existing namespaces

- If we deploy a cluster with `kubeadm`, we have three or four namespaces:

  - `default` (for our applications)

  - `kube-system` (for the control plane)

  - `kube-public` (contains one ConfigMap for cluster discovery)

  - `kube-node-lease` (in Kubernetes 1.14 and later; contains Lease objects)

- If we deploy differently, we may have different namespaces

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Creating namespaces

- Let's see two identical methods to create a namespace

.exercise[

- We can use `kubectl create namespace`:
  ```bash
  kubectl create namespace blue
  ```

- Or we can construct a very minimal YAML snippet:
  ```bash
	kubectl apply -f- &lt;&lt;EOF
	apiVersion: v1
	kind: Namespace
	metadata:
	  name: blue
	EOF
  ```

]

- Some tools like Helm will create namespaces automatically when needed

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Using namespaces

- We can pass a `-n` or `--namespace` flag to most `kubectl` commands:
  ```bash
  kubectl -n blue get svc
  ```

- We can also change our current *context*

- A context is a *(user, cluster, namespace)* tuple

- We can manipulate contexts with the `kubectl config` command

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Viewing existing contexts

- On our training environments, at this point, there should be only one context

.exercise[

- View existing contexts to see the cluster name and the current user:
  ```bash
  kubectl config get-contexts
  ```

]

- The current context (the only one!) is tagged with a `*`

- What are NAME, CLUSTER, AUTHINFO, and NAMESPACE?

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## What's in a context

- NAME is an arbitrary string to identify the context

- CLUSTER is a reference to a cluster

  (i.e. API endpoint URL, and optional certificate)

- AUTHINFO is a reference to the authentication information to use

  (i.e. a TLS client certificate, token, or otherwise)

- NAMESPACE is the namespace

  (empty string = `default`)

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Switching contexts

- We want to use a different namespace

- Solution 1: update the current context

  *This is appropriate if we need to change just one thing (e.g. namespace or authentication).*

- Solution 2: create a new context and switch to it

  *This is appropriate if we need to change multiple things and switch back and forth.*

- Let's go with solution 1!

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Updating a context

- This is done through `kubectl config set-context`

- We can update a context by passing its name, or the current context with `--current`

.exercise[

- Update the current context to use the `blue` namespace:
  ```bash
  kubectl config set-context --current --namespace=blue
  ```

- Check the result:
  ```bash
  kubectl config get-contexts
  ```

]

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Using our new namespace

- Let's check that we are in our new namespace, then deploy a new copy of Dockercoins

.exercise[

- Verify that the new context is empty:
  ```bash
  kubectl get all
  ```

]

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Deploying DockerCoins with YAML files

- The GitHub repository `jpetazzo/kubercoins` contains everything we need!

.exercise[

- Clone the kubercoins repository:
  ```bash
  cd ~
  git clone https://github.com/jpetazzo/kubercoins
  ```

- Create all the DockerCoins resources:
  ```bash
  kubectl create -f kubercoins
  ```

]

If the argument behind `-f` is a directory, all the files in that directory are processed. 

The subdirectories are *not* processed, unless we also add the `-R` flag.

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Viewing the deployed app

- Let's see if this worked correctly!

.exercise[

- Retrieve the port number allocated to the `webui` service:
  ```bash
  kubectl get svc webui
  ```

- Point our browser to http://X.X.X.X:3xxxx

]

If the graph shows up but stays at zero, give it a minute or two!

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Namespaces and isolation

- Namespaces *do not* provide isolation

- A pod in the `green` namespace can communicate with a pod in the `blue` namespace

- A pod in the `default` namespace can communicate with a pod in the `kube-system` namespace

- CoreDNS uses a different subdomain for each namespace

- Example: from any pod in the cluster, you can connect to the Kubernetes API with:

  `https://kubernetes.default.svc.cluster.local:443/`

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Isolating pods

- Actual isolation is implemented with *network policies*

- Network policies are resources (like deployments, services, namespaces...)

- Network policies specify which flows are allowed:

  - between pods

  - from pods to the outside world

  - and vice-versa

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Switch back to the default namespace

- Let's make sure that we don't run future exercises in the `blue` namespace

.exercise[

- Switch back to the original context:
  ```bash
  kubectl config set-context --current --namespace=
  ```

]

Note: we could have used `--namespace=default` for the same result.

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## Switching namespaces more easily

- We can also use a little helper tool called `kubens`:

  ```bash
  # Switch to namespace foo
  kubens foo
  # Switch back to the previous namespace
  kubens -
  ```

- On our clusters, `kubens` is called `kns` instead

  (so that it's even fewer keystrokes to switch namespaces)

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

##  `kubens` and `kubectx`

- With `kubens`, we can switch quickly between namespaces

- With `kubectx`, we can switch quickly between contexts

- Both tools are simple shell scripts available from https://github.com/ahmetb/kubectx

- On our clusters, they are installed as `kns` and `kctx`

  (for brevity and to avoid completion clashes between `kubectx` and `kubectl`)

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

## `kube-ps1`

- It's easy to lose track of our current cluster / context / namespace

- `kube-ps1` makes it easy to track these, by showing them in our shell prompt

- It's a simple shell script available from https://github.com/jonmosco/kube-ps1

- On our clusters, `kube-ps1` is installed and included in `PS1`:
  ```
  [123.45.67.89] `(kubernetes-admin@kubernetes:default)` docker@node1 ~
  ```
  (The highlighted part is `context:namespace`, managed by `kube-ps1`)

- Highly recommended if you work across multiple contexts or namespaces!

.debug[[k8s/namespaces.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/two-containers-on-a-truck.jpg)]

---

name: toc-kustomize
class: title

Kustomize

.nav[
[Previous section](#toc-namespaces)
|
[Back to table of contents](#toc-chapter-7)
|
[Next section](#toc-managing-stacks-with-helm)
]

.debug[(automatically generated title slide)]

---
# Kustomize

- Kustomize lets us transform YAML files representing Kubernetes resources

- The original YAML files are valid resource files

  (e.g. they can be loaded with `kubectl apply -f`)

- They are left untouched by Kustomize

- Kustomize lets us define *overlays* that extend or change the resource files

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Differences with Helm

- Helm charts use placeholders `{{ like.this }}`

- Kustomize "bases" are standard Kubernetes YAML

- It is possible to use an existing set of YAML as a Kustomize base

- As a result, writing a Helm chart is more work ...

- ... But Helm charts are also more powerful; e.g. they can:

  - use flags to conditionally include resources or blocks

  - check if a given Kubernetes API group is supported

  - [and much more](https://helm.sh/docs/chart_template_guide/)

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Kustomize concepts

- Kustomize needs a `kustomization.yaml` file

- That file can be a *base* or a *variant*

- If it's a *base*:

  - it lists YAML resource files to use

- If it's a *variant* (or *overlay*):

  - it refers to (at least) one *base*

  - and some *patches*

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## An easy way to get started with Kustomize

- We are going to use [Replicated Ship](https://www.replicated.com/ship/) to experiment with Kustomize

- The [Replicated Ship CLI](https://github.com/replicatedhq/ship/releases) has been installed on our clusters

- Replicated Ship has multiple workflows; here is what we will do:

  - initialize a Kustomize overlay from a remote GitHub repository

  - customize some values using the web UI provided by Ship

  - look at the resulting files and apply them to the cluster

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Getting started with Ship

- We need to run `ship init` in a new directory

- `ship init` requires a URL to a remote repository containing Kubernetes YAML

- It will clone that repository and start a web UI

- Later, it can watch that repository and/or update from it

- We will use the [jpetazzo/kubercoins](https://github.com/jpetazzo/kubercoins) repository

  (it contains all the DockerCoins resources as YAML files)

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## `ship init`

.exercise[

- Change to a new directory:
  ```bash
  mkdir ~/kustomcoins
  cd ~/kustomcoins
  ```

- Run `ship init` with the kustomcoins repository:
  ```bash
  ship init https://github.com/jpetazzo/kubercoins
  ```

]

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Access the web UI

- `ship init` tells us to connect on `localhost:8800`

- We need to replace `localhost` with the address of our node

  (since we run on a remote machine)

- Follow the steps in the web UI, and change one parameter

  (e.g. set the number of replicas in the worker Deployment)

- Complete the web workflow, and go back to the CLI

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Inspect the results

- Look at the content of our directory

- `base` contains the kubercoins repository + a `kustomization.yaml` file

- `overlays/ship` contains the Kustomize overlay referencing the base + our patch(es)

- `rendered.yaml` is a YAML bundle containing the patched application

- `.ship` contains a state file used by Ship

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Using the results

- We can `kubectl apply -f rendered.yaml`

  (on any version of Kubernetes)

- Starting with Kubernetes 1.14, we can apply the overlay directly with:
  ```bash
  kubectl apply -k overlays/ship
  ```

- But let's not do that for now!

- We will create a new copy of DockerCoins in another namespace

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Deploy DockerCoins with Kustomize

.exercise[

- Create a new namespace:
  ```bash
  kubectl create namespace kustomcoins
  ```

- Deploy DockerCoins:
  ```bash
  kubectl apply -f rendered.yaml --namespace=kustomcoins
  ```

- Or, with Kubernetes 1.14, you can also do this:
  ```bash
  kubectl apply -k overlays/ship --namespace=kustomcoins
  ```

]

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

## Checking our new copy of DockerCoins

- We can check the worker logs, or the web UI

.exercise[

- Retrieve the NodePort number of the web UI:
  ```bash
  kubectl get service webui --namespace=kustomcoins
  ```

- Open it in a web browser

- Look at the worker logs:
  ```bash
  kubectl logs deploy/worker --tail=10 --follow --namespace=kustomcoins
  ```

]

Note: it might take a minute or two for the worker to start.

.debug[[k8s/kustomize.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/wall-of-containers.jpeg)]

---

name: toc-managing-stacks-with-helm
class: title

Managing stacks with Helm

.nav[
[Previous section](#toc-kustomize)
|
[Back to table of contents](#toc-chapter-7)
|
[Next section](#toc-collecting-metrics-with-prometheus)
]

.debug[(automatically generated title slide)]

---
# Managing stacks with Helm

- We created our first resources with `kubectl run`, `kubectl expose` ...

- We have also created resources by loading YAML files with `kubectl apply -f`

- For larger stacks, managing thousands of lines of YAML is unreasonable

- These YAML bundles need to be customized with variable parameters

  (E.g.: number of replicas, image version to use ...)

- It would be nice to have an organized, versioned collection of bundles

- It would be nice to be able to upgrade/rollback these bundles carefully

- [Helm](https://helm.sh/) is an open source project offering all these things!

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## Helm concepts

- `helm` is a CLI tool

- `tiller` is its companion server-side component

- A "chart" is an archive containing templatized YAML bundles

- Charts are versioned

- Charts can be stored on private or public repositories

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## Installing Helm

- If the `helm` CLI is not installed in your environment, install it

.exercise[

- Check if `helm` is installed:
  ```bash
  helm
  ```

- If it's not installed, run the following command:
  ```bash
  curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash
  ```

]

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## Installing Tiller

- Tiller is composed of a *service* and a *deployment* in the `kube-system` namespace

- They can be managed (installed, upgraded...) with the `helm` CLI

.exercise[

- Deploy Tiller:
  ```bash
  helm init
  ```

]

If Tiller was already installed, don't worry: this won't break it.

At the end of the install process, you will see:

```
Happy Helming!
```

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## Fix account permissions

- Helm permission model requires us to tweak permissions

- In a more realistic deployment, you might create per-user or per-team
  service accounts, roles, and role bindings

.exercise[

- Grant `cluster-admin` role to `kube-system:default` service account:
  ```bash
  kubectl create clusterrolebinding add-on-cluster-admin \
      --clusterrole=cluster-admin --serviceaccount=kube-system:default
  ```

]

(Defining the exact roles and permissions on your cluster requires
a deeper knowledge of Kubernetes' RBAC model. The command above is
fine for personal and development clusters.)

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## View available charts

- A public repo is pre-configured when installing Helm

- We can view available charts with `helm search` (and an optional keyword)

.exercise[

- View all available charts:
  ```bash
  helm search
  ```

- View charts related to `prometheus`:
  ```bash
  helm search prometheus
  ```

]

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## Install a chart

- Most charts use `LoadBalancer` service types by default

- Most charts require persistent volumes to store data

- We need to relax these requirements a bit

.exercise[

- Install the Prometheus metrics collector on our cluster:
  ```bash
  helm install stable/prometheus \
         --set server.service.type=NodePort \
         --set server.persistentVolume.enabled=false
  ```

]

Where do these `--set` options come from?

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## Inspecting a chart

- `helm inspect` shows details about a chart (including available options)

.exercise[

- See the metadata and all available options for `stable/prometheus`:
  ```bash
  helm inspect stable/prometheus
  ```

]

The chart's metadata includes a URL to the project's home page.

(Sometimes it conveniently points to the documentation for the chart.)

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

## Viewing installed charts

- Helm keeps track of what we've installed

.exercise[

- List installed Helm charts:
  ```bash
  helm list
  ```

]

.debug[[k8s/helm.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg)]

---

name: toc-collecting-metrics-with-prometheus
class: title

Collecting metrics with Prometheus

.nav[
[Previous section](#toc-managing-stacks-with-helm)
|
[Back to table of contents](#toc-chapter-7)
|
[Next section](#toc-resource-limits)
]

.debug[(automatically generated title slide)]

---
# Collecting metrics with Prometheus

- Prometheus is an open-source monitoring system including:

  - multiple *service discovery* backends to figure out which metrics to collect

  - a *scraper* to collect these metrics

  - an efficient *time series database* to store these metrics

  - a specific query language (PromQL) to query these time series

  - an *alert manager* to notify us according to metrics values or trends

- We are going to use it to collect and query some metrics on our Kubernetes cluster

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Why Prometheus?

- We don't endorse Prometheus more or less than any other system

- It's relatively well integrated within the Cloud Native ecosystem

- It can be self-hosted (this is useful for tutorials like this)

- It can be used for deployments of varying complexity:

  - one binary and 10 lines of configuration to get started

  - all the way to thousands of nodes and millions of metrics

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Exposing metrics to Prometheus

- Prometheus obtains metrics and their values by querying *exporters*

- An exporter serves metrics over HTTP, in plain text

- This is what the *node exporter* looks like:

  http://demo.robustperception.io:9100/metrics

- Prometheus itself exposes its own internal metrics, too:

  http://demo.robustperception.io:9090/metrics

- If you want to expose custom metrics to Prometheus:

  - serve a text page like these, and you're good to go

  - libraries are available in various languages to help with quantiles etc.

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## How Prometheus gets these metrics

- The *Prometheus server* will *scrape* URLs like these at regular intervals

  (by default: every minute; can be more/less frequent)

- If you're worried about parsing overhead: exporters can also use protobuf

- The list of URLs to scrape (the *scrape targets*) is defined in configuration

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Defining scrape targets

This is maybe the simplest configuration file for Prometheus:
```yaml
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

- In this configuration, Prometheus collects its own internal metrics

- A typical configuration file will have multiple `scrape_configs`

- In this configuration, the list of targets is fixed

- A typical configuration file will use dynamic service discovery

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Service discovery

This configuration file will leverage existing DNS `A` records:
```yaml
scrape_configs:
  - ...
  - job_name: 'node'
    dns_sd_configs:
      - names: ['api-backends.dc-paris-2.enix.io']
        type: 'A'
        port: 9100
```

- In this configuration, Prometheus resolves the provided name(s)

  (here, `api-backends.dc-paris-2.enix.io`)

- Each resulting IP address is added as a target on port 9100

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Dynamic service discovery

- In the DNS example, the names are re-resolved at regular intervals

- As DNS records are created/updated/removed, scrape targets change as well

- Existing data (previously collected metrics) is not deleted

- Other service discovery backends work in a similar fashion

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Other service discovery mechanisms

- Prometheus can connect to e.g. a cloud API to list instances

- Or to the Kubernetes API to list nodes, pods, services ...

- Or a service like Consul, Zookeeper, etcd, to list applications

- The resulting configurations files are *way more complex*

  (but don't worry, we won't need to write them ourselves)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Time series database

- We could wonder, "why do we need a specialized database?"

- One metrics data point = metrics ID + timestamp + value

- With a classic SQL or noSQL data store, that's at least 160 bits of data + indexes

- Prometheus is way more efficient, without sacrificing performance

  (it will even be gentler on the I/O subsystem since it needs to write less)

- Would you like to know more? Check this video:

  [Storage in Prometheus 2.0](https://www.youtube.com/watch?v=C4YV-9CrawA) by [Goutham V](https://twitter.com/putadent) at DC17EU

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Checking if Prometheus is installed

- Before trying to install Prometheus, let's check if it's already there

.exercise[

- Look for services with a label `app=prometheus` across all namespaces:
  ```bash
  kubectl get services --selector=app=prometheus --all-namespaces
  ```

]

If we see a `NodePort` service called `prometheus-server`, we're good!

(We can then skip to "Connecting to the Prometheus web UI".)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Running Prometheus on our cluster

We need to:

- Run the Prometheus server in a pod

  (using e.g. a Deployment to ensure that it keeps running)

- Expose the Prometheus server web UI (e.g. with a NodePort)

- Run the *node exporter* on each node (with a Daemon Set)

- Setup a Service Account so that Prometheus can query the Kubernetes API

- Configure the Prometheus server

  (storing the configuration in a Config Map for easy updates)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Helm charts to the rescue

- To make our lives easier, we are going to use a Helm chart

- The Helm chart will take care of all the steps explained above

  (including some extra features that we don't need, but won't hurt)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Step 1: install Helm

- If we already installed Helm earlier, these commands won't break anything

.exercice[

- Install Tiller (Helm's server-side component) on our cluster:
  ```bash
  helm init
  ```

- Give Tiller permission to deploy things on our cluster:
  ```bash
  kubectl create clusterrolebinding add-on-cluster-admin \
      --clusterrole=cluster-admin --serviceaccount=kube-system:default
  ```

]

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Step 2: install Prometheus

- Skip this if we already installed Prometheus earlier

  (in doubt, check with `helm list`)

.exercice[

- Install Prometheus on our cluster:
  ```bash
    helm upgrade prometheus stable/prometheus \
        --install \
        --namespace kube-system \
        --set server.service.type=NodePort \
        --set server.service.nodePort=30090 \
        --set server.persistentVolume.enabled=false \
        --set alertmanager.enabled=false
  ```

]

Curious about all these flags? They're explained in the next slide.

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

class: extra-details

## Explaining all the Helm flags

- `helm upgrade prometheus` → upgrade release "prometheus" to the latest version ...

  (a "release" is a unique name given to an app deployed with Helm)

- `stable/prometheus` → ... of the chart `prometheus` in repo `stable`

- `--install` → if the app doesn't exist, create it

- `--namespace kube-system` → put it in that specific namespace

- And set the following *values* when rendering the chart's templates:

  - `server.service.type=NodePort` → expose the Prometheus server with a NodePort
  - `server.service.nodePort=30090` → set the specific NodePort number to use
  - `server.persistentVolume.enabled=false` → do not use a PersistentVolumeClaim
  - `alertmanager.enabled=false` → disable the alert manager entirely

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Connecting to the Prometheus web UI

- Let's connect to the web UI and see what we can do

.exercise[

- Figure out the NodePort that was allocated to the Prometheus server:
  ```bash
  kubectl get svc --all-namespaces | grep prometheus-server
  ```

- With your browser, connect to that port

]

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Querying some metrics

- This is easy ... if you are familiar with PromQL

.exercise[

- Click on "Graph", and in "expression", paste the following:
  ```
    sum by (instance) (
      irate(
        container_cpu_usage_seconds_total{
          pod_name=~"worker.*"
          }[5m]
      )
    )
  ```

]

- Click on the blue "Execute" button and on the "Graph" tab just below

- We see the cumulated CPU usage of worker pods for each node
  &lt;br/&gt;
  (if we just deployed Prometheus, there won't be much data to see, though)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Getting started with PromQL

- We can't learn PromQL in just 5 minutes

- But we can cover the basics to get an idea of what is possible

  (and have some keywords and pointers)

- We are going to break down the query above

  (building it one step at a time)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Graphing one metric across all tags

This query will show us CPU usage across all containers:
```
container_cpu_usage_seconds_total
```

- The suffix of the metrics name tells us:

  - the unit (seconds of CPU)

  - that it's the total used since the container creation

- Since it's a "total," it is an increasing quantity

  (we need to compute the derivative if we want e.g. CPU % over time)

- We see that the metrics retrieved have *tags* attached to them

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Selecting metrics with tags

This query will show us only metrics for worker containers:
```
container_cpu_usage_seconds_total{pod_name=~"worker.*"}
```

- The `=~` operator allows regex matching

- We select all the pods with a name starting with `worker`

  (it would be better to use labels to select pods; more on that later)

- The result is a smaller set of containers

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Transforming counters in rates

This query will show us CPU usage % instead of total seconds used:
```
100*irate(container_cpu_usage_seconds_total{pod_name=~"worker.*"}[5m])
```

- The [`irate`](https://prometheus.io/docs/prometheus/latest/querying/functions/#irate) operator computes the "per-second instant rate of increase"

  - `rate` is similar but allows decreasing counters and negative values

  - with `irate`, if a counter goes back to zero, we don't get a negative spike

- The `[5m]` tells how far to look back if there is a gap in the data

- And we multiply with `100*` to get CPU % usage

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Aggregation operators

This query sums the CPU usage per node:
```
sum by (instance) (
  irate(container_cpu_usage_seconds_total{pod_name=~"worker.*"}[5m])
)
```

- `instance` corresponds to the node on which the container is running

- `sum by (instance) (...)` computes the sum for each instance

- Note: all the other tags are collapsed

  (in other words, the resulting graph only shows the `instance` tag)

- PromQL supports many more [aggregation operators](https://prometheus.io/docs/prometheus/latest/querying/operators/#aggregation-operators)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## What kind of metrics can we collect?

- Node metrics (related to physical or virtual machines)

- Container metrics (resource usage per container)

- Databases, message queues, load balancers, ...

  (check out this [list of exporters](https://prometheus.io/docs/instrumenting/exporters/)!)

- Instrumentation (=deluxe `printf` for our code)

- Business metrics (customers served, revenue, ...)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

class: extra-details

## Node metrics

- CPU, RAM, disk usage on the whole node

- Total number of processes running, and their states

- Number of open files, sockets, and their states

- I/O activity (disk, network), per operation or volume

- Physical/hardware (when applicable): temperature, fan speed ...

- ... and much more!

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

class: extra-details

## Container metrics

- Similar to node metrics, but not totally identical

- RAM breakdown will be different

  - active vs inactive memory
  - some memory is *shared* between containers, and accounted specially

- I/O activity is also harder to track

  - async writes can cause deferred "charges"
  - some page-ins are also shared between containers

For details about container metrics, see:
&lt;br/&gt;
http://jpetazzo.github.io/2013/10/08/docker-containers-metrics/

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

class: extra-details

## Application metrics

- Arbitrary metrics related to your application and business

- System performance: request latency, error rate ...

- Volume information: number of rows in database, message queue size ...

- Business data: inventory, items sold, revenue ...

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

class: extra-details

## Detecting scrape targets

- Prometheus can leverage Kubernetes service discovery

  (with proper configuration)

- Services or pods can be annotated with:

  - `prometheus.io/scrape: true` to enable scraping
  - `prometheus.io/port: 9090` to indicate the port number
  - `prometheus.io/path: /metrics` to indicate the URI (`/metrics` by default)

- Prometheus will detect and scrape these (without needing a restart or reload)

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Querying labels

- What if we want to get metrics for containers belonging to a pod tagged `worker`?

- The cAdvisor exporter does not give us Kubernetes labels

- Kubernetes labels are exposed through another exporter

- We can see Kubernetes labels through metrics `kube_pod_labels`

  (each container appears as a time series with constant value of `1`)

- Prometheus *kind of* supports "joins" between time series

- But only if the names of the tags match exactly

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## Unfortunately ...

- The cAdvisor exporter uses tag `pod_name` for the name of a pod

- The Kubernetes service endpoints exporter uses tag `pod` instead

- See [this blog post](https://www.robustperception.io/exposing-the-software-version-to-prometheus) or [this other one](https://www.weave.works/blog/aggregating-pod-resource-cpu-memory-usage-arbitrary-labels-prometheus/) to see how to perform "joins"

- Alas, Prometheus cannot "join" time series with different labels

  (see [Prometheus issue #2204](https://github.com/prometheus/prometheus/issues/2204) for the rationale)

- There is a workaround involving relabeling, but it's "not cheap"

  - see [this comment](https://github.com/prometheus/prometheus/issues/2204#issuecomment-261515520) for an overview

  - or [this blog post](https://5pi.de/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/) for a complete description of the process

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

## In practice

- Grafana is a beautiful (and useful) frontend to display all kinds of graphs

- Not everyone needs to know Prometheus, PromQL, Grafana, etc.

- But in a team, it is valuable to have at least one person who know them

- That person can set up queries and dashboards for the rest of the team

- It's a little bit likeknowing how to optimize SQL queries, Dockerfiles ...

  Don't panic if you don't know these tools!

  ... But make sure at least one person in your team is on it 💯

.debug[[k8s/prometheus.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/ShippingContainerSFBay.jpg)]

---

name: toc-resource-limits
class: title

Resource Limits

.nav[
[Previous section](#toc-collecting-metrics-with-prometheus)
|
[Back to table of contents](#toc-chapter-8)
|
[Next section](#toc-defining-min-max-and-default-resources)
]

.debug[(automatically generated title slide)]

---
# Resource Limits

- We can attach resource indications to our pods

  (or rather: to the *containers* in our pods)

- We can specify *limits* and/or *requests*

- We can specify quantities of CPU and/or memory

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## CPU vs memory

- CPU is a *compressible resource*

  (it can be preempted immediately without adverse effect)

- Memory is an *incompressible resource*

  (it needs to be swapped out to be reclaimed; and this is costly)

- As a result, exceeding limits will have different consequences for CPU and memory

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Exceeding CPU limits

- CPU can be reclaimed instantaneously

  (in fact, it is preempted hundreds of times per second, at each context switch)

- If a container uses too much CPU, it can be throttled

  (it will be scheduled less often)

- The processes in that container will run slower

  (or rather: they will not run faster)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Exceeding memory limits

- Memory needs to be swapped out before being reclaimed

- "Swapping" means writing memory pages to disk, which is very slow

- On a classic system, a process that swaps can get 1000x slower

  (because disk I/O is 1000x slower than memory I/O)

- Exceeding the memory limit (even by a small amount) can reduce performance *a lot*

- Kubernetes *does not support swap* (more on that later!)

- Exceeding the memory limit will cause the container to be killed



.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Limits vs requests

- Limits are "hard limits" (they can't be exceeded)

  - a container exceeding its memory limit is killed

  - a container exceeding its CPU limit is throttled

- Requests are used for scheduling purposes

  - a container using *less* than what it requested will never be killed or throttled

  - the scheduler uses the requested sizes to determine placement

  - the resources requested by all pods on a node will never exceed the node size

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Pod quality of service

Each pod is assigned a QoS class (visible in `status.qosClass`).

- If limits = requests:

  - as long as the container uses less than the limit, it won't be affected

  - if all containers in a pod have *(limits=requests)*, QoS is "Guaranteed"

- If requests &lt; limits:

  - as long as the container uses less than the request, it won't be affected

  - otherwise, it might be killed / evicted if the node gets overloaded

  - if at least one container has *(requests&lt;limits)*, QoS is "Burstable"

- If a pod doesn't have any request nor limit, QoS is "BestEffort"

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Quality of service impact

- When a node is overloaded, BestEffort pods are killed first

- Then, Burstable pods that exceed their limits

- Burstable and Guaranteed pods below their limits are never killed

  (except if their node fails)

- If we only use Guaranteed pods, no pod should ever be killed

  (as long as they stay within their limits)

(Pod QoS is also explained in [this page](https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/) of the Kubernetes documentation and in [this blog post](https://medium.com/google-cloud/quality-of-service-class-qos-in-kubernetes-bb76a89eb2c6).)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Where is my swap?

- The semantics of memory and swap limits on Linux cgroups are complex

- In particular, it's not possible to disable swap for a cgroup

  (the closest option is to [reduce "swappiness"](https://unix.stackexchange.com/questions/77939/turning-off-swapping-for-only-one-process-with-cgroups))

- The architects of Kubernetes wanted to ensure that Guaranteed pods never swap

- The only solution was to disable swap entirely

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Alternative point of view

- Swap enables paging¹ of anonymous² memory

- Even when swap is disabled, Linux will still page memory for:

  - executables, libraries

  - mapped files

- Disabling swap *will reduce performance and available resources*

- For a good time, read [kubernetes/kubernetes#53533](https://github.com/kubernetes/kubernetes/issues/53533)

- Also read this [excellent blog post about swap](https://jvns.ca/blog/2017/02/17/mystery-swap/)

¹Paging: reading/writing memory pages from/to disk to reclaim physical memory

²Anonymous memory: memory that is not backed by files or blocks

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Enabling swap anyway

- If you don't care that pods are swapping, you can enable swap

- You will need to add the flag `--fail-swap-on=false` to kubelet

  (otherwise, it won't start!)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Specifying resources

- Resource requests are expressed at the *container* level

- CPU is expressed in "virtual CPUs"

  (corresponding to the virtual CPUs offered by some cloud providers)

- CPU can be expressed with a decimal value, or even a "milli" suffix

  (so 100m = 0.1)

- Memory is expressed in bytes

- Memory can be expressed with k, M, G, T, ki, Mi, Gi, Ti suffixes

  (corresponding to 10^3, 10^6, 10^9, 10^12, 2^10, 2^20, 2^30, 2^40)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Specifying resources in practice

This is what the spec of a Pod with resources will look like:

```yaml
containers:
- name: httpenv
  image: jpetazzo/httpenv
  resources:
    limits:
      memory: "100Mi"
      cpu: "100m"
    requests:
      memory: "100Mi"
      cpu: "10m"
```

This set of resources makes sure that this service won't be killed (as long as it stays below 100 MB of RAM), but allows its CPU usage to be throttled if necessary.

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Default values

- If we specify a limit without a request: 

  the request is set to the limit

- If we specify a request without a limit: 

  there will be no limit

  (which means that the limit will be the size of the node)

- If we don't specify anything:

  the request is zero and the limit is the size of the node

*Unless there are default values defined for our namespace!*

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## We need default resource values

- If we do not set resource values at all:

  - the limit is "the size of the node"

  - the request is zero

- This is generally *not* what we want

  - a container without a limit can use up all the resources of a node

  - if the request is zero, the scheduler can't make a smart placement decision

- To address this, we can set default values for resources

- This is done with a LimitRange object

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/aerial-view-of-containers.jpg)]

---

name: toc-defining-min-max-and-default-resources
class: title

Defining min, max, and default resources

.nav[
[Previous section](#toc-resource-limits)
|
[Back to table of contents](#toc-chapter-8)
|
[Next section](#toc-namespace-quotas)
]

.debug[(automatically generated title slide)]

---

# Defining min, max, and default resources

- We can create LimitRange objects to indicate any combination of:

  - min and/or max resources allowed per pod

  - default resource *limits*

  - default resource *requests*

  - maximal burst ratio (*limit/request*)

- LimitRange objects are namespaced

- They apply to their namespace only

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## LimitRange example

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: my-very-detailed-limitrange
spec:
  limits:
  - type: Container
    min:
      cpu: "100m"
    max:
      cpu: "2000m"
      memory: "1Gi"
    default:
      cpu: "500m"
      memory: "250Mi"
    defaultRequest:
      cpu: "500m"
```

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Example explanation

The YAML on the previous slide shows an example LimitRange object specifying very detailed limits on CPU usage,
and providing defaults on RAM usage.

Note the `type: Container` line: in the future,
it might also be possible to specify limits
per Pod, but it's not [officially documented yet](https://github.com/kubernetes/website/issues/9585).

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## LimitRange details

- LimitRange restrictions are enforced only when a Pod is created

  (they don't apply retroactively)

- They don't prevent creation of e.g. an invalid Deployment or DaemonSet

  (but the pods will not be created as long as the LimitRange is in effect)

- If there are multiple LimitRange restrictions, they all apply together

  (which means that it's possible to specify conflicting LimitRanges,
  &lt;br/&gt;preventing any Pod from being created)

- If a LimitRange specifies a `max` for a resource but no `default`,
  &lt;br/&gt;that `max` value becomes the `default` limit too

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/blue-containers.jpg)]

---

name: toc-namespace-quotas
class: title

Namespace quotas

.nav[
[Previous section](#toc-defining-min-max-and-default-resources)
|
[Back to table of contents](#toc-chapter-8)
|
[Next section](#toc-limiting-resources-in-practice)
]

.debug[(automatically generated title slide)]

---

# Namespace quotas

- We can also set quotas per namespace

- Quotas apply to the total usage in a namespace

  (e.g. total CPU limits of all pods in a given namespace)

- Quotas can apply to resource limits and/or requests

  (like the CPU and memory limits that we saw earlier)

- Quotas can also apply to other resources:

  - "extended" resources (like GPUs)

  - storage size

  - number of objects (number of pods, services...)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Creating a quota for a namespace

- Quotas are enforced by creating a ResourceQuota object

- ResourceQuota objects are namespaced, and apply to their namespace only

- We can have multiple ResourceQuota objects in the same namespace

- The most restrictive values are used

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Limiting total CPU/memory usage

- The following YAML specifies an upper bound for *limits* and *requests*:
  ```yaml
    apiVersion: v1
    kind: ResourceQuota
    metadata:
      name: a-little-bit-of-compute
    spec:
      hard:
        requests.cpu: "10"
        requests.memory: 10Gi
        limits.cpu: "20"
        limits.memory: 20Gi
  ```

These quotas will apply to the namespace where the ResourceQuota is created.

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Limiting number of objects

- The following YAML specifies how many objects of specific types can be created:
  ```yaml
    apiVersion: v1
    kind: ResourceQuota
    metadata:
      name: quota-for-objects
    spec:
      hard:
        pods: 100
        services: 10
        secrets: 10
        configmaps: 10
        persistentvolumeclaims: 20
        services.nodeports: 0
        services.loadbalancers: 0
        count/roles.rbac.authorization.k8s.io: 10
  ```

(The `count/` syntax allows limiting arbitrary objects, including CRDs.)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## YAML vs CLI

- Quotas can be created with a YAML definition

- ... Or with the `kubectl create quota` command

- Example:
  ```bash
  kubectl create quota sparta --hard=pods=300,limits.memory=300Gi
  ```

- With both YAML and CLI form, the values are always under the `hard` section

  (there is no `soft` quota)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Viewing current usage

When a ResourceQuota is created, we can see how much of it is used:

```
kubectl describe resourcequota my-resource-quota

Name:                            my-resource-quota
Namespace:                       default
Resource                         Used  Hard
--------                         ----  ----
pods                             12    100
services                         1     5
services.loadbalancers           0     0
services.nodeports               0     0
```

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Advanced quotas and PriorityClass

- Since Kubernetes 1.12, it is possible to create PriorityClass objects

- Pods can be assigned a PriorityClass

- Quotas can be linked to a PriorityClass

- This allows us to reserve resources for pods within a namespace

- For more details, check [this documentation page](https://kubernetes.io/docs/concepts/policy/resource-quotas/#resource-quota-per-priorityclass)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/chinook-helicopter-container.jpg)]

---

name: toc-limiting-resources-in-practice
class: title

Limiting resources in practice

.nav[
[Previous section](#toc-namespace-quotas)
|
[Back to table of contents](#toc-chapter-8)
|
[Next section](#toc-checking-pod-and-node-resource-usage)
]

.debug[(automatically generated title slide)]

---

# Limiting resources in practice

- We have at least three mechanisms:

  - requests and limits per Pod

  - LimitRange per namespace

  - ResourceQuota per namespace

- Let's see a simple recommendation to get started with resource limits

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Set a LimitRange

- In each namespace, create a LimitRange object

- Set a small default CPU request and CPU limit

  (e.g. "100m")

- Set a default memory request and limit depending on your most common workload

  - for Java, Ruby: start with "1G"

  - for Go, Python, PHP, Node: start with "250M"

- Set upper bounds slightly below your expected node size

  (80-90% of your node size, with at least a 500M memory buffer)

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Set a ResourceQuota

- In each namespace, create a ResourceQuota object

- Set generous CPU and memory limits

  (e.g. half the cluster size if the cluster hosts multiple apps)

- Set generous objects limits

  - these limits should not be here to constrain your users

  - they should catch a runaway process creating many resources

  - example: a custom controller creating many pods

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

## Observe, refine, iterate

- Observe the resource usage of your pods

  (we will see how in the next chapter)

- Adjust individual pod limits

- If you see trends: adjust the LimitRange

  (rather than adjusting every individual set of pod limits)

- Observe the resource usage of your namespaces

  (with `kubectl describe resourcequota ...`)

- Rinse and repeat regularly

.debug[[k8s/resource-limits.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-cranes.jpg)]

---

name: toc-checking-pod-and-node-resource-usage
class: title

Checking pod and node resource usage

.nav[
[Previous section](#toc-limiting-resources-in-practice)
|
[Back to table of contents](#toc-chapter-8)
|
[Next section](#toc-cluster-sizing)
]

.debug[(automatically generated title slide)]

---
# Checking pod and node resource usage

- Since Kubernetes 1.8, metrics are collected by the [core metrics pipeline](https://v1-13.docs.kubernetes.io/docs/tasks/debug-application-cluster/core-metrics-pipeline/)

- The core metrics pipeline is:

  - optional (Kubernetes can function without it)

  - necessary for some features (like the Horizontal Pod Autoscaler)

  - exposed through the Kubernetes API using the [aggregation layer](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/)

  - usually implemented by the "metrics server"

.debug[[k8s/metrics-server.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md)]
---

## How to know if the metrics server is running?

- The easiest way to know is to run `kubectl top`

.exercise[

- Check if the core metrics pipeline is available:
  ```bash
  kubectl top nodes
  ```

]

If it shows our nodes and their CPU and memory load, we're good!

.debug[[k8s/metrics-server.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md)]
---

## Installing metrics server

- The metrics server doesn't have any particular requirements

  (it doesn't need persistence, as it doesn't *store* metrics)

- It has its own repository, [kubernetes-incubator/metrics-server](https://github.com/kubernetes-incubator/metrics-server])

- The repository comes with [YAML files for deployment](https://github.com/kubernetes-incubator/metrics-server/tree/master/deploy/1.8%2B)

- These files may not work on some clusters

  (e.g. if your node names are not in DNS)

- The container.training repository has a [metrics-server.yaml](https://github.com/jpetazzo/container.training/blob/master/k8s/metrics-server.yaml#L90) file to help with that

  (we can `kubectl apply -f` that file if needed)

.debug[[k8s/metrics-server.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md)]
---

## Showing container resource usage

- Once the metrics server is running, we can check container resource usage

.exercise[

- Show resource usage across all containers:
  ```bash
  kuebectl top pods --containers --all-namespaces
  ```
]

- We can also use selectors (`-l app=...`)

.debug[[k8s/metrics-server.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-housing.jpg)]

---

name: toc-cluster-sizing
class: title

Cluster sizing

.nav[
[Previous section](#toc-checking-pod-and-node-resource-usage)
|
[Back to table of contents](#toc-chapter-8)
|
[Next section](#toc-the-horizontal-pod-autoscaler)
]

.debug[(automatically generated title slide)]

---
# Cluster sizing

- What happens when the cluster gets full?

- How can we scale up the cluster?

- Can we do it automatically?

- What are other methods to address capacity planning?

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## When are we out of resources?

- kubelet monitors node resources:

  - memory

  - node disk usage (typically the root filesystem of the node)

  - image disk usage (where container images and RW layers are stored)

- For each resource, we can provide two thresholds:

  - a hard threshold (if it's met, it provokes immediate action)

  - a soft threshold (provokes action only after a grace period)

- Resource thresholds and grace periods are configurable

  (by passing kubelet command-line flags)

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## What happens then?

- If disk usage is too high:

  - kubelet will try to remove terminated pods

  - then, it will try to *evict* pods

- If memory usage is too high:

  - it will try to evict pods

- The node is marked as "under pressure"

- This temporarily prevents new pods from being scheduled on the node

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## Which pods get evicted?

- kubelet looks at the pods' QoS and PriorityClass

- First, pods with BestEffort QoS are considered

- Then, pods with Burstable QoS exceeding their *requests*

  (but only if the exceeding resource is the one that is low on the node)

- Finally, pods with Guaranteed QoS, and Burstable pods within their requests

- Within each group, pods are sorted by PriorityClass

- If there are pods with the same PriorityClass, they are sorted by usage excess

  (i.e. the pods whose usage exceeds their requests the most are evicted first)

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

class: extra-details

## Eviction of Guaranteed pods

- *Normally*, pods with Guaranteed QoS should not be evicted

- A chunk of resources is reserved for node processes (like kubelet)

- It is expected that these processes won't use more than this reservation

- If they do use more resources anyway, all bets are off!

- If this happens, kubelet must evict Guaranteed pods to preserve node stability

  (or Burstable pods that are still within their requested usage)

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## What happens to evicted pods?

- The pod is terminated

- It is marked as `Failed` at the API level

- If the pod was created by a controller, the controller will recreate it

- The pod will be recreated on another node, *if there are resources available!*

- For more details about the eviction process, see:

  - [this documentation page](https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/) about resource pressure and pod eviction,

  - [this other documentation page](https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/) about pod priority and preemption.

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## What if there are no resources available?

- Sometimes, a pod cannot be scheduled anywhere:

  - all the nodes are under pressure,

  - or the pod requests more resources than are available

- The pod then remains in `Pending` state until the situation improves

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## Cluster scaling

- One way to improve the situation is to add new nodes

- This can be done automatically with the [Cluster Autoscaler](https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler)

- The autoscaler will automatically scale up:

  - if there are pods that failed to be scheduled

- The autoscaler will automatically scale down:

  - if nodes have a low utilization for an extended period of time

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## Restrictions, gotchas ...

- The Cluster Autoscaler only supports a few cloud infrastructures

  (see [here](https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider) for a list)

- The Cluster Autoscaler cannot scale down nodes that have pods using:

  - local storage

  - affinity/anti-affinity rules preventing them from being rescheduled

  - a restrictive PodDisruptionBudget

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

## Other way to do capacity planning

- "Running Kubernetes without nodes"

- Systems like [Virtual Kubelet](https://virtual-kubelet.io/) or Kiyot can run pods using on-demand resources

  - Virtual Kubelet can leverage e.g. ACI or Fargate to run pods

  - Kiyot runs pods in ad-hoc EC2 instances (1 instance per pod)

- Economic advantage (no wasted capacity)

- Security advantage (stronger isolation between pods)

Check [this blog post](http://jpetazzo.github.io/2019/02/13/running-kubernetes-without-nodes-with-kiyot/) for more details.

.debug[[k8s/cluster-sizing.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/containers-by-the-water.jpg)]

---

name: toc-the-horizontal-pod-autoscaler
class: title

The Horizontal Pod Autoscaler

.nav[
[Previous section](#toc-cluster-sizing)
|
[Back to table of contents](#toc-chapter-8)
|
[Next section](#toc-additional-lab-environments)
]

.debug[(automatically generated title slide)]

---
# The Horizontal Pod Autoscaler

- What is the Horizontal Pod Autoscaler, or HPA?

- It is a controller that can perform *horizontal* scaling automatically

- Horizontal scaling = changing the number of replicas

  (adding / removing pods)

- Vertical scaling = changing the size of individual replicas

  (increasing / reducing CPU and RAM per pod)

- Cluster scaling = changing the size of the cluster

  (adding / removing nodes)

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Principle of operation

- Each HPA resource (or "policy") specifies:

  - which object to monitor and scale (e.g. a Deployment, ReplicaSet...)

  - min/max scaling ranges (the max is a safety limit!)

  - a target resource usage (e.g. the default is CPU=80%)

- The HPA continuously monitors the CPU usage for the related object

- It computes how many pods should be running:

  `TargetNumOfPods = ceil(sum(CurrentPodsCPUUtilization) / Target)`

- It scales the related object up/down to this target number of pods

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Pre-requirements

- The metrics server needs to be running

  (i.e. we need to be able to see pod metrics with `kubectl top pods`)

- The pods that we want to autoscale need to have resource requests

  (because the target CPU% is not absolute, but relative to the request)

- The latter actually makes a lot of sense:

  - if a Pod doesn't have a CPU request, it might be using 10% of CPU ...

  - ... but only because there is no CPU time available!

  - this makes sure that we won't add pods to nodes that are already resource-starved

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Testing the HPA

- We will start a CPU-intensive web service

- We will send some traffic to that service

- We will create an HPA policy

- The HPA will automatically scale up the service for us

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## A CPU-intensive web service

- Let's use `jpetazzo/busyhttp`

  (it is a web server that will use 1s of CPU for each HTTP request)

.exercise[

- Deploy the web server:
  ```bash
  kubectl create deployment busyhttp --image=jpetazzo/busyhttp
  ```

- Expose it with a ClusterIP service:
  ```bash
  kubectl expose deployment busyhttp --port=80
  ```

- Get the ClusterIP allocated to the service:
  ```bash
  kubectl get svc busyhttp
  ```

]

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Monitor what's going on

- Let's start a bunch of commands to watch what is happening

.exercise[

- Monitor pod CPU usage:
  ```bash
  watch kubectl top pods
  ```

- Monitor service latency:
  ```bash
  httping http://`ClusterIP`/
  ```

- Monitor cluster events:
  ```bash
  kubectl get events -w
  ```

]

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Send traffic to the service

- We will use `ab` (Apache Bench) to send traffic

.exercise[

- Send a lot of requests to the service, with a concurrency level of 3:
  ```bash
  ab -c 3 -n 100000 http://`ClusterIP`/
  ```

]

The latency (reported by `httping`) should increase above 3s.

The CPU utilization should increase to 100%.

(The server is single-threaded and won't go above 100%.)

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Create an HPA policy

- There is a helper command to do that for us: `kubectl autoscale`

.exercise[

- Create the HPA policy for the `busyhttp` deployment:
  ```bash
  kubectl autoscale deployment busyhttp --max=10
  ```

]

By default, it will assume a target of 80% CPU usage.

This can also be set with `--cpu-percent=`.

--

*The autoscaler doesn't seem to work. Why?*

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## What did we miss?

- The events stream gives us a hint, but to be honest, it's not very clear:

  `missing request for cpu`

- We forgot to specify a resource request for our Deployment!

- The HPA target is not an absolute CPU%

- It is relative to the CPU requested by the pod

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Adding a CPU request

- Let's edit the deployment and add a CPU request

- Since our server can use up to 1 core, let's request 1 core

.exercise[

- Edit the Deployment definition:
  ```bash
  kubectl edit deployment busyhttp
  ```

- In the `containers` list, add the following block:
  ```yaml
    resources:
      requests:
        cpu: "1"
  ```

]

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## Results

- After saving and quitting, a rolling update happens

  (if `ab` or `httping` exits, make sure to restart it)

- It will take a minute or two for the HPA to kick in:

  - the HPA runs every 30 seconds by default

  - it needs to gather metrics from the metrics server first

- If we scale further up (or down), the HPA will react after a few minutes:

  - it won't scale up if it already scaled in the last 3 minutes

  - it won't scale down if it already scaled in the last 5 minutes

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

## What about other metrics?

- The HPA in API group `autoscaling/v1` only supports CPU scaling

- The HPA in API group `autoscaling/v2beta2` supports metrics from various API groups:

  - metrics.k8s.io, aka metrics server (per-Pod CPU and RAM)

  - custom.metrics.k8s.io, custom metrics per Pod

  - external.metrics.k8s.io, external metrics (not associated to Pods)

- Kubernetes doesn't implement any of these API groups

- Using these metrics requires to [register additional APIs](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis)

- The metrics provided by metrics server are standard; everything else is custom

- For more details, see [this great blog post](https://medium.com/uptime-99/kubernetes-hpa-autoscaling-with-custom-and-external-metrics-da7f41ff7846) or [this talk](https://www.youtube.com/watch?v=gSiGFH4ZnS8)

.debug[[k8s/horizontal-pod-autoscaler.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/distillery-containers.jpg)]

---

name: toc-additional-lab-environments
class: title

Additional lab environments

.nav[
[Previous section](#toc-the-horizontal-pod-autoscaler)
|
[Back to table of contents](#toc-chapter-9)
|
[Next section](#toc-kubernetes-architecture-deep-dive)
]

.debug[(automatically generated title slide)]

---
# Additional lab environments

- We will now use new sets of VMs

- Look out for new individual card with connection information!

.debug[[k8s/prereqs-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prereqs-admin.md)]
---

## Doing or re-doing this on your own?

- We are using basic cloud VMs with Ubuntu LTS

- Kubernetes [packages] or [binaries] have been installed

  (depending on what we want to accomplish in the lab)

- We disabled IP address checks

  - we want to route pod traffic directly between nodes

  - most cloud providers will treat pod IP addresses as invalid

  - ... and filter them out; so we disable that filter

[packages]: https://kubernetes.io/docs/setup/independent/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl

[binaries]: https://kubernetes.io/docs/setup/release/notes/#server-binaries

.debug[[k8s/prereqs-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prereqs-admin.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/lots-of-containers.jpg)]

---

name: toc-kubernetes-architecture-deep-dive
class: title

Kubernetes architecture deep dive

.nav[
[Previous section](#toc-additional-lab-environments)
|
[Back to table of contents](#toc-chapter-9)
|
[Next section](#toc-the-kubernetes-api)
]

.debug[(automatically generated title slide)]

---
# Kubernetes architecture deep dive

We can arbitrarily split Kubernetes in two parts:

- the *nodes*, a set of machines that run our containerized workloads;

- the *control plane*, a set of processes implementing the Kubernetes APIs.

Kubernetes also relies on underlying infrastructure:

- servers, network connectivity (obviously!),

- optional components like storage systems, load balancers ...

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Control plane location

The control plane can run:

- in containers, on the same nodes that run other application workloads

  (example: Minikube; 1 node runs everything)

- on a dedicated node

  (example: a cluster installed with kubeadm)

- on a dedicated set of nodes

  (example: Kubernetes The Hard Way; kops)

- outside of the cluster

  (example: most managed clusters like AKS, EKS, GKE)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

class: pic

![Kubernetes architecture diagram: control plane and nodes](images/k8s-arch2.png)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## What runs on a node

- Our containerized workloads

- A container engine like Docker, CRI-O, containerd...

  (in theory, the choice doesn't matter, as the engine is abstracted by Kubernetes)

- kubelet: an agent connecting the node to the cluster

  (it connects to the API server, registers the node, receives instructions)

- kube-proxy: a component used for internal cluster communication

  (note that this is *not* an overlay network or a CNI plugin!)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## What's in the control plane

- Everything is stored in etcd

  (it's the only stateful component)

- Everyone communicates exclusively through the API server:

  - we (users) interact with the cluster through the API server

  - the nodes register and get their instructions through the API server

  - the other control plane components also register with the API server

- API server is the only component that reads/writes from/to etcd

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Communication protocols: API server

- The API server exposes a REST API

  (except for some calls, e.g. to attach interactively to a container)

- Almost all requests and responses are JSON following a strict format

- For performance, the requests and responses can also be done over protobuf

  (see this [design proposal](https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/protobuf.md) for details)

- In practice, protobuf is used for all internal communication

  (between control plane components, and with kubelet)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Communication protocols: on the nodes

The kubelet agent uses a number of special-purpose protocols and interfaces, including:

- CRI (Container Runtime Interface)

  - used for communication with the container engine
  - abstracts the differences between container engines
  - based on gRPC+protobuf

- [CNI (Container Network Interface)](https://github.com/containernetworking/cni/blob/master/SPEC.md)

  - used for communication with network plugins
  - network plugins are implemented as executable programs invoked by kubelet
  - network plugins provide IPAM
  - network plugins set up network interfaces in pods

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

class: pic

![Kubernetes architecture diagram: communication between components](images/k8s-arch4-thanks-luxas.png)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/plastic-containers.JPG)]

---

name: toc-the-kubernetes-api
class: title

The Kubernetes API

.nav[
[Previous section](#toc-kubernetes-architecture-deep-dive)
|
[Back to table of contents](#toc-chapter-9)
|
[Next section](#toc-other-control-plane-components)
]

.debug[(automatically generated title slide)]

---

# The Kubernetes API

[
*The Kubernetes API server is a "dumb server" which offers storage, versioning, validation, update, and watch semantics on API resources.*
](
https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/protobuf.md#proposal-and-motivation
)

([Clayton Coleman](https://twitter.com/smarterclayton), Kubernetes Architect and Maintainer)

What does that mean?

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## The Kubernetes API is declarative

- We cannot tell the API, "run a pod"

- We can tell the API, "here is the definition for pod X"

- The API server will store that definition (in etcd)

- *Controllers* will then wake up and create a pod matching the definition

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## The core features of the Kubernetes API

- We can create, read, update, and delete objects

- We can also *watch* objects

  (be notified when an object changes, or when an object of a given type is created)

- Objects are strongly typed

- Types are *validated* and *versioned*

- Storage and watch operations are provided by etcd

  (note: the [k3s](https://k3s.io/) project allows us to use sqlite instead of etcd)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Let's experiment a bit!

- For the exercises in this section, connect to the first node of the `test` cluster

.exercise[

- SSH to the first node of the test cluster

- Check that the cluster is operational:
  ```bash
  kubectl get nodes
  ```

- All nodes should be `Ready`

]

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Create

- Let's create a simple object

.exercise[

- Create a namespace with the following command:
  ```bash
    kubectl create -f- &lt;&lt;EOF
    apiVersion: v1
    kind: Namespace
    metadata:
      name: hello
    EOF
  ```

]

This is equivalent to `kubectl create namespace hello`.

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Read

- Let's retrieve the object we just created

.exercise[

- Read back our object:
  ```bash
  kubectl get namespace hello -o yaml
  ```

]

We see a lot of data that wasn't here when we created the object.

Some data was automatically added to the object (like `spec.finalizers`).

Some data is dynamic (typically, the content of `status`.)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## API requests and responses

- Almost every Kubernetes API payload (requests and responses) has the same format:
  ```yaml
    apiVersion: xxx
    kind: yyy
    metadata:
      name: zzz
      (more metadata fields here)
    (more fields here)
  ```

- The fields shown above are mandatory, except for some special cases

  (e.g.: in lists of resources, the list itself doesn't have a `metadata.name`)

- We show YAML for convenience, but the API uses JSON

  (with optional protobuf encoding)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

class: extra-details

## API versions

- The `apiVersion` field corresponds to an *API group*

- It can be either `v1` (aka "core" group or "legacy group"), or `group/versions`; e.g.:

  - `apps/v1`
  - `rbac.authorization.k8s.io/v1`
  - `extensions/v1beta1`

- It does not indicate which version of Kubernetes we're talking about

- It *indirectly* indicates the version of the `kind`

  (which fields exist, their format, which ones are mandatory...)

- A single resource type (`kind`) is rarely versioned alone

  (e.g.: the `batch` API group contains `jobs` and `cronjobs`)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Update

- Let's update our namespace object

- There are many ways to do that, including:

  - `kubectl apply` (and provide an updated YAML file)
  - `kubectl edit`
  - `kubectl patch`
  - many helpers, like `kubectl label`, or `kubectl set`

- In each case, `kubectl` will:

  - get the current definition of the object
  - compute changes
  - submit the changes (with `PATCH` requests)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Adding a label

- For demonstration purposes, let's add a label to the namespace

- The easiest way is to use `kubectl label`

.exercise[

- In one terminal, watch namespaces:
  ```bash
  kubectl get namespaces --show-labels -w
  ```

- In the other, update our namespace:
  ```bash
  kubectl label namespaces hello color=purple
  ```

]

We demonstrated *update* and *watch* semantics.

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## What's special about *watch*?

- The API server itself doesn't do anything: it's just a fancy object store

- All the actual logic in Kubernetes is implemented with *controllers*

- A *controller* watches a set of resources, and takes action when they change

- Examples:

  - when a Pod object is created, it gets scheduled and started

  - when a Pod belonging to a ReplicaSet terminates, it gets replaced

  - when a Deployment object is updated, it can trigger a rolling update

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-1.jpg)]

---

name: toc-other-control-plane-components
class: title

Other control plane components

.nav[
[Previous section](#toc-the-kubernetes-api)
|
[Back to table of contents](#toc-chapter-9)
|
[Next section](#toc-building-our-own-cluster)
]

.debug[(automatically generated title slide)]

---

# Other control plane components

- API server ✔️

- etcd ✔️

- Controller manager

- Scheduler

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Controller manager

- This is a collection of loops watching all kinds of objects

- That's where the actual logic of Kubernetes lives

- When we create a Deployment (e.g. with `kubectl run web --image=nginx`),

  - we create a Deployment object

  - the Deployment controller notices it, and creates a ReplicaSet

  - the ReplicaSet controller notices the ReplicaSet, and creates a Pod

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

## Scheduler

- When a pod is created, it is in `Pending` state

- The scheduler (or rather: *a scheduler*) must bind it to a node

  - Kubernetes comes with an efficient scheduler with many features

  - if we have special requirements, we can add another scheduler
    &lt;br/&gt;
    (example: this [demo scheduler](https://github.com/kelseyhightower/scheduler) uses the cost of nodes, stored in node annotations)

- A pod might stay in `Pending` state for a long time:

  - if the cluster is full

  - if the pod has special constraints that can't be met

  - if the scheduler is not running (!)

.debug[[k8s/architecture.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-2.jpg)]

---

name: toc-building-our-own-cluster
class: title

Building our own cluster

.nav[
[Previous section](#toc-other-control-plane-components)
|
[Back to table of contents](#toc-chapter-9)
|
[Next section](#toc-adding-nodes-to-the-cluster)
]

.debug[(automatically generated title slide)]

---
# Building our own cluster

- Let's build our own cluster!

  *Perfection is attained not when there is nothing left to add, but when there is nothing left to take away. (Antoine de Saint-Exupery)*

- Our goal is to build a minimal cluster allowing us to:

  - create a Deployment (with `kubectl run` or `kubectl create deployment`)
  - expose it with a Service
  - connect to that service


- "Minimal" here means:

  - smaller number of components
  - smaller number of command-line flags
  - smaller number of configuration files

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Non-goals

- For now, we don't care about security

- For now, we don't care about scalability

- For now, we don't care about high availability

- All we care about is *simplicity*

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Our environment

- We will use the machine indicated as `dmuc1`

  (this stands for "Dessine Moi Un Cluster" or "Draw Me A Sheep",
  &lt;br/&gt;in homage to Saint-Exupery's "The Little Prince")

- This machine:

  - runs Ubuntu LTS

  - has Kubernetes, Docker, and etcd binaries installed

  - but nothing is running

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Checking our environment

- Let's make sure we have everything we need first

.exercise[

- Log into the `dmuc1` machine

- Get root:
  ```bash
  sudo -i
  ```

- Check available versions:
  ```bash
  etcd -version
  kube-apiserver --version
  dockerd --version
  ```

]

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## The plan

1. Start API server

2. Interact with it (create Deployment and Service)

3. See what's broken

4. Fix it and go back to step 2 until it works!

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Dealing with multiple processes

- We are going to start many processes

- Depending on what you're comfortable with, you can:

  - open multiple windows and multiple SSH connections

  - use a terminal multiplexer like screen or tmux

  - put processes in the background with `&amp;`
    &lt;br/&gt;(warning: log output might get confusing to read!)

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting API server

.exercise[

- Try to start the API server:
  ```bash
  kube-apiserver
  # It will fail with "--etcd-servers must be specified"
  ```

]

Since the API server stores everything in etcd,
it cannot start without it.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting etcd

.exercise[

- Try to start etcd:
  ```bash
  etcd
  ```

]

Success!

Note the last line of output:
```
serving insecure client requests on 127.0.0.1:2379, this is strongly discouraged!
```

*Sure, that's discouraged. But thanks for telling us the address!*

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting API server (for real)

- Try again, passing the `--etcd-servers` argument

- That argument should be a comma-separated list of URLs

.exercise[

- Start API server:
  ```bash
  kube-apiserver --etcd-servers http://127.0.0.1:2379
  ```

]

Success!

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Interacting with API server

- Let's try a few "classic" commands

.exercise[

- List nodes:
  ```bash
  kubectl get nodes
  ```

- List services:
  ```bash
  kubectl get services
  ```

]

So far, so good.

Note: the API server automatically created the `kubernetes` service entry.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

class: extra-details

## What about `kubeconfig`?

- We didn't need to create a `kubeconfig` file

- By default, the API server is listening on `localhost:8080`

  (without requiring authentication)

- By default, `kubectl` connects to `localhost:8080`

  (without providing authentication)

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Creating a Deployment

- Let's run a web server!

.exercise[

- Create a Deployment with NGINX:
  ```bash
  kubectl create deployment web --image=nginx
  ```

]

Success?

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Checking our Deployment status

.exercise[

- Look at pods, deployments, etc.:
  ```bash
  kubectl get all
  ```

]

Our Deployment is in a bad shape:
```
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/web   0/1     0            0           2m26s
```

And, there is no ReplicaSet, and no Pod.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## What's going on?

- We stored the definition of our Deployment in etcd

  (through the API server)

- But there is no *controller* to do the rest of the work

- We need to start the *controller manager*

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting the controller manager

.exercise[

- Try to start the controller manager:
  ```bash
  kube-controller-manager
  ```

]

The final error message is:
```
invalid configuration: no configuration has been provided
```

But the logs include another useful piece of information:
```
Neither --kubeconfig nor --master was specified.
Using the inClusterConfig.  This might not work.
```

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Reminder: everyone talks to API server

- The controller manager needs to connect to the API server

- It *does not* have a convenient `localhost:8080` default

- We can pass the connection information in two ways:

  - `--master` and a host:port combination (easy)

  - `--kubeconfig` and a `kubeconfig` file

- For simplicity, we'll use the first option

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting the controller manager (for real)

.exercise[

- Start the controller manager:
  ```bash
  kube-controller-manager --master http://localhost:8080
  ```

]

Success!

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Checking our Deployment status

.exercise[

- Check all our resources again:
  ```bash
  kubectl get all
  ```

]

We now have a ReplicaSet.

But we still don't have a Pod.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## What's going on?

In the controller manager logs, we should see something like this:
```
E0404 15:46:25.753376   22847 replica_set.go:450] Sync "default/web-5bc9bd5b8d"
failed with `No API token found for service account "default"`, retry after the
token is automatically created and added to the service account
```

- The service account `default` was automatically added to our Deployment

  (and to its pods)

- The service account `default` exists

- But it doesn't have an associated token

  (the token is a secret; creating it requires signature; therefore a CA)

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Solving the missing token issue

There are many ways to solve that issue.

We are going to list a few (to get an idea of what's happening behind the scenes).

Of course, we don't need to perform *all* the solutions mentioned here.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Option 1: disable service accounts

- Restart the API server with
  `--disable-admission-plugins=ServiceAccount`

- The API server will no longer add a service account automatically

- Our pods will be created without a service account

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Option 2: do not mount the (missing) token

- Add `automountServiceAccountToken: false` to the Deployment spec

  *or*

- Add `automountServiceAccountToken: false` to the default ServiceAccount

- The ReplicaSet controller will no longer create pods referencing the (missing) token

.exercise[

- Programmatically change the `default` ServiceAccount:
  ```bash
  kubectl patch sa default -p "automountServiceAccountToken: false"
  ```

]

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Option 3: set up service accounts properly

- This is the most complex option!

- Generate a key pair

- Pass the private key to the controller manager

  (to generate and sign tokens)

- Pass the public key to the API server

  (to verify these tokens)

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Continuing without service account token

- Once we patch the default service account, the ReplicaSet can create a Pod

.exercise[

- Check that we now have a pod:
  ```bash
  kubectl get all
  ```

]

Note: we might have to wait a bit for the ReplicaSet controller to retry.

If we're impatient, we can restart the controller manager.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## What's next?

- Our pod exists, but it is in `Pending` state

- Remember, we don't have a node so far

  (`kubectl get nodes` shows an empty list)

- We need to:

  - start a container engine

  - start kubelet

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting a container engine

- We're going to use Docker (because it's the default option)

.exercise[

- Start the Docker Engine:
  ```bash
  dockerd
  ```

]

Success!

Feel free to check that it actually works with e.g.:
```bash
docker run alpine echo hello world
```

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting kubelet

- If we start kubelet without arguments, it *will* start

- But it will not join the cluster!

- It will start in *standalone* mode

- Just like with the controller manager, we need to tell kubelet where the API server is

- Alas, kubelet doesn't have a simple `--master` option

- We have to use `--kubeconfig`

- We need to write a `kubeconfig` file for kubelet

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Writing a kubeconfig file

- We can copy/paste a bunch of YAML

- Or we can generate the file with `kubectl`

.exercise[

- Create the file `kubeconfig.kubelet` with `kubectl`:
  ```bash
    kubectl --kubeconfig kubeconfig.kubelet config \
            set-cluster localhost --server http://localhost:8080
    kubectl --kubeconfig kubeconfig.kubelet config \
            set-context localhost --cluster localhost
    kubectl --kubeconfig kubeconfig.kubelet config \
            use-context localhost
  ```

]

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## All Kubernetes clients can use `kubeconfig`

- The `kubeconfig.kubelet` file has the same format as e.g. `~/.kubeconfig`

- All Kubernetes clients can use a similar file

- The `kubectl config` commands can be used to manipulate these files

- This highlights that kubelet is a "normal" client of the API server

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Our `kubeconfig.kubelet` file

The file that we generated looks like the one below.

That one has been slightly simplified (removing extraneous fields), but it is still valid.

```yaml
apiVersion: v1
kind: Config
current-context: localhost
contexts:
- name: localhost
  context:
    cluster: localhost
clusters:
- name: localhost
  cluster:
    server: http://localhost:8080
```

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting kubelet

.exercise[

- Start kubelet with that `kubeconfig.kubelet` file:
  ```bash
  kubelet --kubeconfig kubeconfig.kubelet
  ```

]

Success!

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Looking at our 1-node cluster

- Let's check that our node registered correctly

.exercise[

- List the nodes in our cluster:
  ```bash
  kubectl get nodes
  ```

]

Our node should show up.

Its name will be its hostname (it should be `dmuc1`).

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Are we there yet?

- Let's check if our pod is running

.exercise[

- List all resources:
  ```bash
  kubectl get all
  ```

]

--

Our pod is still `Pending`. 🤔

--

Which is normal: it needs to be *scheduled*.

(i.e., something needs to decide which node it should go on.)

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Scheduling our pod

- Why do we need a scheduling decision, since we have only one node?

- The node might be full, unavailable; the pod might have constraints ...

- The easiest way to schedule our pod is to start the scheduler

  (we could also schedule it manually)

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting the scheduler

- The scheduler also needs to know how to connect to the API server

- Just like for controller manager, we can use `--kubeconfig` or `--master`

.exercise[

- Start the scheduler:
  ```bash
  kube-scheduler --master http://localhost:8080
  ```

]

- Our pod should now start correctly

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Checking the status of our pod

- Our pod will go through a short `ContainerCreating` phase

- Then it will be `Running`

.exercise[

- Check pod status:
  ```bash
  kubectl get pods
  ```

]

Success!

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

class: extra-details

## Scheduling a pod manually

- We can schedule a pod in `Pending` state by creating a Binding, e.g.:
  ```bash
    kubectl create -f- &lt;&lt;EOF
    apiVersion: v1
    kind: Binding
    metadata:
      name: name-of-the-pod
    target:
      apiVersion: v1
      kind: Node
      name: name-of-the-node
    EOF
  ```

- This is actually how the scheduler works!

- It watches pods, makes scheduling decisions, and creates Binding objects

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Connecting to our pod

- Let's check that our pod correctly runs NGINX

.exercise[

- Check our pod's IP address:
  ```bash
  kubectl get pods -o wide
  ```

- Send some HTTP request to the pod:
  ```bash
  curl `X.X.X.X`
  ```

]

We should see the `Welcome to nginx!` page.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Exposing our Deployment

- We can now create a Service associated with this Deployment

.exercise[

- Expose the Deployment's port 80:
  ```bash
  kubectl expose deployment web --port=80
  ```

- Check the Service's ClusterIP, and try connecting:
  ```bash
  kubectl get service web
  curl http://`X.X.X.X`
  ```

]

--

This won't work. We need kube-proxy to enable internal communication.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Starting kube-proxy

- kube-proxy also needs to connect to the API server

- It can work with the `--master` flag

  (although that will be deprecated in the future)

.exercise[

- Start kube-proxy:
  ```bash
  kube-proxy --master http://localhost:8080
  ```

]

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

## Connecting to our Service

- Now that kube-proxy is running, we should be able to connect

.exercise[

- Check the Service's ClusterIP again, and retry connecting:
  ```bash
  kubectl get service web
  curl http://`X.X.X.X`
  ```

]

Success!

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

class: extra-details

## How kube-proxy works

- kube-proxy watches Service resources

- When a Service is created or updated, kube-proxy creates iptables rules

.exercise[

- Check out the `OUTPUT` chain in the `nat` table:
  ```bash
  iptables -t nat -L OUTPUT
  ```

- Traffic is sent to `KUBE-SERVICES`; check that too:
  ```bash
  iptables -t nat -L KUBE-SERVICES
  ```

]

For each Service, there is an entry in that chain.

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

class: extra-details

## Diving into iptables

- The last command showed a chain named `KUBE-SVC-...` corresponding to our service

.exercise[

- Check that `KUBE-SVC-...` chain:
  ```bash
  iptables -t nat -L `KUBE-SVC-...`
  ```

- It should show a jump to a `KUBE-SEP-...` chains; check it out too:
  ```bash
  iptables -t nat -L `KUBE-SEP-...`
  ```

]

This is a `DNAT` rule to rewrite the destination address of the connection to our pod.

This is how kube-proxy works!

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

class: extra-details

## kube-router, IPVS

- With recent versions of Kubernetes, it is possible to tell kube-proxy to use IPVS

- IPVS is a more powerful load balancing framework

  (remember: iptables was primarily designed for firewalling, not load balancing!)

- It is also possible to replace kube-proxy with kube-router

- kube-router uses IPVS by default

- kube-router can also perform other functions

  (e.g., we can use it as a CNI plugin to provide pod connectivity)

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

class: extra-details

## What about the `kubernetes` service?

- If we try to connect, it won't work

  (by default, it should be `10.0.0.1`)

- If we look at the Endpoints for this service, we will see one endpoint:

  `host-address:6443`

- By default, the API server expects to be running directly on the nodes

  (it could be as a bare process, or in a container/pod using the host network)

- ... And it expects to be listening on port 6443 with TLS

.debug[[k8s/dmuc.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/two-containers-on-a-truck.jpg)]

---

name: toc-adding-nodes-to-the-cluster
class: title

Adding nodes to the cluster

.nav[
[Previous section](#toc-building-our-own-cluster)
|
[Back to table of contents](#toc-chapter-10)
|
[Next section](#toc-the-container-network-interface)
]

.debug[(automatically generated title slide)]

---
# Adding nodes to the cluster

- So far, our cluster has only 1 node

- Let's see what it takes to add more nodes

- We are going to use another set of machines: `kubenet`

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## The environment

- We have 3 identical machines: `kubenet1`, `kubenet2`, `kubenet3`

- The Docker Engine is installed (and running) on these machines

- The Kubernetes packages are installed, but nothing is running

- We will use `kubenet1` to run the control plane

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## The plan

- Start the control plane on `kubenet1`

- Join the 3 nodes to the cluster

- Deploy and scale a simple web server

.exercise[

- Log into `kubenet1`

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Running the control plane

- We will use a Compose file to start the control plane components

.exercise[

- Clone the repository containing the workshop materials:
  ```bash
  git clone https://github.com/jpetazzo/container.training
  ```

- Go to the `compose/simple-k8s-control-plane` directory:
  ```bash
  cd container.training/compose/simple-k8s-control-plane
  ```

- Start the control plane:
  ```bash
  docker-compose up
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Checking the control plane status

- Before moving on, verify that the control plane works

.exercise[

- Show control plane component statuses:
  ```bash
  kubectl get componentstatuses
  kubectl get cs
  ```

- Show the (empty) list of nodes:
  ```bash
  kubectl get nodes
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

class: extra-details

## Differences from `dmuc`

- Our new control plane listens on `0.0.0.0` instead of the default `127.0.0.1`

- The ServiceAccount admission plugin is disabled

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Joining the nodes

- We need to generate a `kubeconfig` file for kubelet

- This time, we need to put the IP address of `kubenet1`

  (instead of `localhost` or `127.0.0.1`)

.exercise[

- Generate the `kubeconfig` file:
  ```bash
    kubectl --kubeconfig ~/kubeconfig config \
            set-cluster kubenet --server http://`X.X.X.X`:8080
    kubectl --kubeconfig ~/kubeconfig config \
            set-context kubenet --cluster kubenet
    kubectl --kubeconfig ~/kubeconfig config\
            use-context kubenet
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Distributing the `kubeconfig` file

- We need that `kubeconfig` file on the other nodes, too

.exercise[

- Copy `kubeconfig` to the other nodes:
  ```bash
    for N in 2 3; do
    	scp ~/kubeconfig kubenet$N:
    done
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Starting kubelet

- Reminder: kubelet needs to run as root; don't forget `sudo`!

.exercise[

- Join the first node:
   ```bash
   sudo kubelet --kubeconfig ~/kubeconfig
   ```

- Open more terminals and join the other nodes to the cluster:
  ```bash
  ssh kubenet2 sudo kubelet --kubeconfig ~/kubeconfig
  ssh kubenet3 sudo kubelet --kubeconfig ~/kubeconfig
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Checking cluster status

- We should now see all 3 nodes

- At first, their `STATUS` will be `NotReady`

- They will move to `Ready` state after approximately 10 seconds

.exercise[

- Check the list of nodes:
  ```bash
  kubectl get nodes
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Deploy a web server

- Let's create a Deployment and scale it

  (so that we have multiple pods on multiple nodes)

.exercise[

- Create a Deployment running NGINX:
  ```bash
  kubectl create deployment web --image=nginx
  ```

- Scale it:
  ```bash
  kubectl scale deployment web --replicas=5
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Check our pods

- The pods will be scheduled to the nodes

- The nodes will pull the `nginx` image, and start the pods

- What are the IP addresses of our pods?

.exercise[

- Check the IP addresses of our pods
  ```bash
  kubectl get pods -o wide
  ```

]

--

🤔 Something's not right ... Some pods have the same IP address!

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## What's going on?

- On a normal cluster, kubelet is configured to set up pod networking with CNI plugins

- This requires:

  - installing CNI plugins

  - writing CNI configuration files

  - running kubelet with `--network-plugin=cni`

- Without the `--network-plugin` flag, kubelet defaults to "no-op" networking

- It lets the container engine use a default network

  (in that case, we end up with the default Docker bridge)

- Our pods are running on independent, disconnected, host-local networks

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Using network plugins

- We need to set up a better network

- Before diving into CNI, we will use the `kubenet` plugin

- This plugin creates a `cbr0` bridge and connects the containers to that bridge

- This plugin allocates IP addresses from a range:

  - either specified to kubelet (e.g. with `--pod-cidr`)

  - or stored in the node's `spec.podCIDR` field

.footnote[See [here] for more details about this `kubenet` plugin.]

[here]: https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/#kubenet

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## What `kubenet` does and *does not* do

- It allocates IP addresses to pods *locally*

  (each node has its own local subnet)

- It connects the pods to a *local* bridge

  (pods on the same node can communicate together; not with other nodes)

- It doesn't set up routing or tunneling

  (we get pods on separated networks; we need to connect them somehow)

- It doesn't allocate subnets to nodes

  (this can be done manually, or by the controller manager) 

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Setting up routing or tunneling

- *On each node*, we will add routes to the other nodes' pod network

- Of course, this is not convenient or scalable!

- We will see better techniques to do this; but for now, hang on!

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Allocating subnets to nodes

- There are multiple options:

  - passing the subnet to kubelet with the `--pod-cidr` flag

  - manually setting `spec.podCIDR` on each node

  - allocating node CIDRs automatically with the controller manager

- The last option would be implemented by adding these flags to controller manager:
  ```
  --allocate-node-cidrs=true --cluster-cidr=&lt;cidr&gt; 
  ```

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

class: extra-details

## The pod CIDR field is not mandatory

- `kubenet` needs the pod CIDR, but other plugins don't need it

  (e.g. because they allocate addresses in multiple pools, or a single big one)

- The pod CIDR field may eventually be deprecated and replaced by an annotation

  (see [kubernetes/kubernetes#57130](https://github.com/kubernetes/kubernetes/issues/57130))

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Restarting kubelet wih pod CIDR

- We need to stop and restart all our kubelets

- We will add the `--network-plugin` and `--pod-cidr` flags

- We all have a "cluster number" (let's call that `C`)

- We will use pod CIDR `10.C.N.0/24` (where `N` is the node number: 1, 2, 3)

.exercise[

- Stop all the kubelets (Ctrl-C is fine)

- Restart them all, adding `--network-plugin=kubenet --pod-cidr 10.C.N.0/24`

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## What happens to our pods?

- When we stop (or kill) kubelet, the containers keep running

- When kubelet starts again, it detects the containers

.exercise[

- Check that our pods are still here:
  ```bash
  kubectl get pods -o wide
  ```

]

🤔 But our pods still use local IP addresses!

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Recreating the pods

- The IP address of a pod cannot change

- kubelet doesn't automatically kill/restart containers with "invalid" addresses
  &lt;br/&gt;
  (in fact, from kubelet's point of view, there is no such thing as an "invalid" address)

- We must delete our pods and recreate them

.exercise[

- Delete all the pods, and let the ReplicaSet recreate them:
  ```bash
  kubectl delete pods --all
  ```

- Wait for the pods to be up again:
  ```bash
  kubectl get pods -o wide -w
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Adding kube-proxy

- Let's start kube-proxy to provide internal load balancing

- Then see if we can create a Service and use it to contact our pods

.exercise[

- Start kube-proxy:
  ```bash
  sudo kube-proxy --kubeconfig ~/kubeconfig
  ```

- Expose our Deployment:
  ```bash
  kubectl expose deployment web --port=80
  ```

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Test internal load balancing

.exercise[

- Retrieve the ClusterIP address:
  ```bash
  kubectl get svc web
  ```

- Send a few requests to the ClusterIP address (with `curl`)

]

--

Sometimes it works, sometimes it doesn't. Why?

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Routing traffic

- Our pods have new, distinct IP addresses

- But they are on host-local, isolated networks

- If we try to ping a pod on a different node, it won't work

- kube-proxy merely rewrites the destination IP address

- But we need that IP address to be reachable in the first place

- How do we fix this?

  (hint: check the title of this slide!)

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Important warning

- The technique that we are about to use doesn't work everywhere

- It only works if:

  - all the nodes are directly connected to each other (at layer 2)

  - the underlying network allows the IP addresses of our pods

- If we are on physical machines connected by a switch: OK

- If we are on virtual machines in a public cloud: NOT OK

  - on AWS, we need to disable "source and destination checks" on our instances

  - on OpenStack, we need to disable "port security" on our network ports

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Routing basics

- We need to tell *each* node:

  "The subnet 10.C.N.0/24 is located on node N" (for all values of N)

- This is how we add a route on Linux:
  ```bash
  ip route add 10.C.N.0/24 via W.X.Y.Z
  ```

  (where `W.X.Y.Z` is the internal IP address of node N)

- We can see the internal IP addresses of our nodes with:
  ```bash
  kubectl get nodes -o wide
  ```
.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## Setting up routing

.exercise[

- Create all the routes on all the nodes

- Check that you can ping all the pods from one of the nodes

- Check that you can `curl` the ClusterIP of the Service successfully

]

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

## What's next?

- We did a lot of manual operations:

  - allocating subnets to nodes

  - adding command-line flags to kubelet

  - updating the routing tables on our nodes

- We want to automate all these steps

- We want something that works on all networks

.debug[[k8s/multinode.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/wall-of-containers.jpeg)]

---

name: toc-the-container-network-interface
class: title

The Container Network Interface

.nav[
[Previous section](#toc-adding-nodes-to-the-cluster)
|
[Back to table of contents](#toc-chapter-10)
|
[Next section](#toc-interconnecting-clusters)
]

.debug[(automatically generated title slide)]

---
# The Container Network Interface

- Allows us to decouple network configuration from Kubernetes

- Implemented by *plugins*

- Plugins are executables that will be invoked by kubelet

- Plugins are responsible for:

  - allocating IP addresses for containers

  - configuring the network for containers

- Plugins can be combined and chained when it makes sense

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Combining plugins

- Interface could be created by e.g. `vlan` or `bridge` plugin

- IP address could be allocated by e.g. `dhcp` or `host-local` plugin

- Interface parameters (MTU, sysctls) could be tweaked by the `tuning` plugin

The reference plugins are available [here].

Look in each plugin's directory for its documentation.

[here]: https://github.com/containernetworking/plugins/tree/master/plugins

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## How does kubelet know which plugins to use?

- The plugin (or list of plugins) is set in the CNI configuration

- The CNI configuration is a *single file* in `/etc/cni/net.d`

- If there are multiple files in that directory, the first one is used

  (in lexicographic order)

- That path can be changed with the `--cni-conf-dir` flag of kubelet

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## CNI configuration in practice

- When we set up the "pod network" (like Calico, Weave...) it ships a CNI configuration

  (and sometimes, custom CNI plugins)

- Very often, that configuration (and plugins) is installed automatically

  (by a DaemonSet featuring an initContainer with hostPath volumes)

- Examples:

  - Calico [CNI config](https://github.com/projectcalico/calico/blob/1372b56e3bfebe2b9c9cbf8105d6a14764f44159/v2.6/getting-started/kubernetes/installation/hosted/calico.yaml#L25)
    and [volume](https://github.com/projectcalico/calico/blob/1372b56e3bfebe2b9c9cbf8105d6a14764f44159/v2.6/getting-started/kubernetes/installation/hosted/calico.yaml#L219)

  - kube-router [CNI config](https://github.com/cloudnativelabs/kube-router/blob/c2f893f64fd60cf6d2b6d3fee7191266c0fc0fe5/daemonset/generic-kuberouter.yaml#L10)
    and [volume](https://github.com/cloudnativelabs/kube-router/blob/c2f893f64fd60cf6d2b6d3fee7191266c0fc0fe5/daemonset/generic-kuberouter.yaml#L73)

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Conf vs conflist

- There are two slightly different configuration formats

- Basic configuration format:

  - holds configuration for a single plugin
  - typically has a `.conf` name suffix
  - has a `type` string field in the top-most structure
  - [examples](https://github.com/containernetworking/cni/blob/master/SPEC.md#example-configurations)

- Configuration list format:

  - can hold configuration for multiple (chained) plugins
  - typically has a `.conflist` name suffix
  - has a `plugins` list field in the top-most structure
  - [examples](https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration-lists)

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

class: extra-details

## How plugins are invoked

- Parameters are given through environment variables, including:

  - CNI_COMMAND: desired operation (ADD, DEL, CHECK, or VERSION)

  - CNI_CONTAINERID: container ID

  - CNI_NETNS: path to network namespace file

  - CNI_IFNAME: what the network interface should be named

- The network configuration must be provided to the plugin on stdin

  (this avoids race conditions that could happen by passing a file path)

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## In practice: kube-router

- We are going to set up a new cluster

- For this new cluster, we will use kube-router

- kube-router will provide the "pod network"

  (connectivity with pods)

- kube-router will also provide internal service connectivity

  (replacing kube-proxy)

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## How kube-router works

- Very simple architecture

- Does not introduce new CNI plugins

  (uses the `bridge` plugin, with `host-local` for IPAM)

- Pod traffic is routed between nodes

  (no tunnel, no new protocol)

- Internal service connectivity is implemented with IPVS

- Can provide pod network and/or internal service connectivity

- kube-router daemon runs on every node

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## What kube-router does

- Connect to the API server

- Obtain the local node's `podCIDR`

- Inject it into the CNI configuration file

  (we'll use `/etc/cni/net.d/10-kuberouter.conflist`)

- Obtain the addresses of all nodes

- Establish a *full mesh* BGP peering with the other nodes

- Exchange routes over BGP

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## What's BGP?

- BGP (Border Gateway Protocol) is the protocol used between internet routers

- It [scales](https://www.cidr-report.org/as2.0/)
  pretty [well](https://www.cidr-report.org/cgi-bin/plota?file=%2fvar%2fdata%2fbgp%2fas2.0%2fbgp-active%2etxt&amp;descr=Active%20BGP%20entries%20%28FIB%29&amp;ylabel=Active%20BGP%20entries%20%28FIB%29&amp;with=step)
  (it is used to announce the 700k CIDR prefixes of the internet)

- It is spoken by many hardware routers from many vendors

- It also has many software implementations (Quagga, Bird, FRR...)

- Experienced network folks generally know it (and appreciate it)

- It also used by Calico (another popular network system for Kubernetes)

- Using BGP allows us to interconnect our "pod network" with other systems

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## The plan

- We'll work in a new cluster (named `kuberouter`)

- We will run a simple control plane (like before)

- ... But this time, the controller manager will allocate `podCIDR` subnets

- We will start kube-router with a DaemonSet

- This DaemonSet will start one instance of kube-router on each node

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Logging into the new cluster

.exercise[

- Log into node `kuberouter1`

- Clone the workshop repository:
  ```bash
  git clone https://github.com/jpetazzo/container.training
  ```

- Move to this directory:
  ```bash
  cd container.training/compose/kube-router-k8s-control-plane
  ```

]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Our control plane

- We will use a Compose file to start the control plane

- It is similar to the one we used with the `kubenet` cluster

- The API server is started with `--allow-privileged`

  (because we will start kube-router in privileged pods)

- The controller manager is started with extra flags too:

  `--allocate-node-cidrs` and `--cluster-cidr`

- We need to edit the Compose file to set the Cluster CIDR

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Starting the control plane

- Our cluster CIDR will be `10.C.0.0/16`

  (where `C` is our cluster number)

.exercise[

- Edit the Compose file to set the Cluster CIDR:
  ```bash
  vim docker-compose.yaml
  ```

- Start the control plane:
  ```bash
  docker-compose up
  ```

]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## The kube-router DaemonSet

- In the same directory, there is a `kuberouter.yaml` file

- It contains the definition for a DaemonSet and a ConfigMap

- Before we load it, we also need to edit it

- We need to indicate the address of the API server

  (because kube-router needs to connect to it to retrieve node information)

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Creating the DaemonSet

- The address of the API server will be `http://A.B.C.D:8080`

  (where `A.B.C.D` is the address of `kuberouter1`, running the control plane)

.exercise[

- Edit the YAML file to set the API server address:
  ```bash
  vim kuberouter.yaml
  ```

- Create the DaemonSet:
  ```bash
  kubectl create -f kuberouter.yaml
  ```

]

Note: the DaemonSet won't create any pods (yet) since there are no nodes (yet).

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Generating the kubeconfig for kubelet

- This is similar to what we did for the `kubenet` cluster

.exercise[

- Generate the kubeconfig file (replacing `X.X.X.X` with the address of `kuberouter1`):
  ```bash
    kubectl --kubeconfig ~/kubeconfig config \
            set-cluster kubenet --server http://`X.X.X.X`:8080
    kubectl --kubeconfig ~/kubeconfig config \
            set-context kubenet --cluster kubenet
    kubectl --kubeconfig ~/kubeconfig config\
            use-context kubenet
  ```

]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Distributing kubeconfig

- We need to copy that kubeconfig file to the other nodes

.exercise[

- Copy `kubeconfig` to the other nodes:
  ```bash
    for N in 2 3; do
    	scp ~/kubeconfig kuberouter$N:
    done
  ```

]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Starting kubelet

- We don't need the `--pod-cidr` option anymore

  (the controller manager will allocate these automatically)

- We need to pass `--network-plugin=cni`

.exercise[

- Join the first node:
   ```bash
   sudo kubelet --kubeconfig ~/kubeconfig --network-plugin=cni
   ```

- Open more terminals and join the other nodes:
  ```bash
  ssh kuberouter2 sudo kubelet --kubeconfig ~/kubeconfig --network-plugin=cni
  ssh kuberouter3 sudo kubelet --kubeconfig ~/kubeconfig --network-plugin=cni
  ```

]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Setting up a test

- Let's create a Deployment and expose it with a Service

.exercise[

- Create a Deployment running a web server:
  ```bash
  kubectl create deployment web --image=jpetazzo/httpenv
  ```

- Scale it so that it spans multiple nodes:
  ```bash
  kubectl scale deployment web --replicas=5
  ```

- Expose it with a Service:
  ```bash
  kubectl expose deployment web --port=8888
  ```

]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Checking that everything works

.exercise[

- Get the ClusterIP address for the service:
  ```bash
  kubectl get svc web
  ```

- Send a few requests there:
  ```bash
  curl `X.X.X.X`:8888
  ```

]

Note that if you send multiple requests, they are load-balanced in a round robin manner.

This shows that we are using IPVS (vs. iptables, which picked random endpoints).

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Troubleshooting

- What if we need to check that everything is working properly?

.exercise[

- Check the IP addresses of our pods:
  ```bash
  kubectl get pods -o wide
  ```

- Check our routing table:
  ```bash
  route -n
  ip route
  ```

]

We should see the local pod CIDR connected to `kube-bridge`, and the other nodes' pod CIDRs having individual routes, with each node being the gateway.

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## More troubleshooting

- We can also look at the output of the kube-router pods

  (with `kubectl logs`)

- kube-router also comes with a special shell that gives lots of useful info

  (we can access it with `kubectl exec`)

- But with the current setup of the cluster, these options may not work!

- Why?

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Trying `kubectl logs` / `kubectl exec`

.exercise[

- Try to show the logs of a kube-router pod:
  ```bash
  kubectl -n kube-system logs ds/kube-router
  ```

- Or try to exec into one of the kube-router pods:
  ```bash
  kubectl -n kube-system exec kuber-router-xxxxx bash
  ```

]

These commands will give an error message that includes:
```
dial tcp: lookup kuberouterX on 127.0.0.11:53: no such host
```

What does that mean?

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Internal name resolution

- To execute these commands, the API server needs to connect to kubelet

- By default, it creates a connection using the kubelet's name

  (e.g. `http://kuberouter1:...`)

- This requires our nodes names to be in DNS

- We can change that by setting a flag on the API server:

  `--kubelet-preferred-address-types=InternalIP`

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Another way to check the logs

- We can also ask the logs directly to the container engine

- First, get the container ID, with `docker ps` or like this:
  ```bash
  CID=$(docker ps
        --filter label=io.kubernetes.pod.namespace=kube-system
        --filter label=io.kubernetes.container.name=kube-router)
  ```

- Then view the logs:
  ```bash
  docker logs $CID
  ```

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

class: extra-details

## Other ways to distribute routing tables

- We don't need kube-router and BGP to distribute routes

- The list of nodes (and associated `podCIDR` subnets) is available through the API

- This shell snippet generates the commands to add all required routes on a node:

```bash
NODES=$(kubectl get nodes -o name | cut -d/ -f2)
for DESTNODE in $NODES; do
  if [ "$DESTNODE" != "$HOSTNAME" ]; then
    echo $(kubectl get node $DESTNODE -o go-template="
      route add -net {{.spec.podCIDR}} gw {{(index .status.addresses 0).address}}")
  fi
done
```

- This could be useful for embedded platforms with very limited resources

  (or lab environments for learning purposes)

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg)]

---

name: toc-interconnecting-clusters
class: title

Interconnecting clusters

.nav[
[Previous section](#toc-the-container-network-interface)
|
[Back to table of contents](#toc-chapter-10)
|
[Next section](#toc-installing-a-managed-cluster)
]

.debug[(automatically generated title slide)]

---

# Interconnecting clusters

- We assigned different Cluster CIDRs to each cluster

- This allows us to connect our clusters together

- We will leverage kube-router BGP abilities for that

- We will *peer* each kube-router instance with a *route reflector*

- As a result, we will be able to ping each other's pods

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Disclaimers

- There are many methods to interconnect clusters

- Depending on your network implementation, you will use different methods

- The method shown here only works for nodes with direct layer 2 connection

- We will often need to use tunnels or other network techniques

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## The plan

- Someone will start the *route reflector*

  (typically, that will be the person presenting these slides!)

- We will update our kube-router configuration

- We will add a *peering* with the route reflector

  (instructing kube-router to connect to it and exchange route information)

- We should see the routes to other clusters on our nodes

  (in the output of e.g. `route -n` or `ip route show`)

- We should be able to ping pods of other nodes

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Starting the route reflector

- Only do this if you are doing this on your own

- There is a Compose file in the `compose/frr-route-reflector` directory

- Before continuing, make sure that you have the IP address of the route reflector

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Configuring kube-router

- This can be done in two ways:

  - with command-line flags to the `kube-router` process

  - with annotations to Node objects

- We will use the command-line flags

  (because it will automatically propagate to all nodes)

.footnote[Note: with Calico, this is achieved by creating a BGPPeer CRD.]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Updating kube-router configuration

- We need to pass two command-line flags to the kube-router process

.exercise[

- Edit the `kuberouter.yaml` file

- Add the following flags to the kube-router arguments:
  ```
  - "--peer-router-ips=`X.X.X.X`"
  - "--peer-router-asns=64512"
  ```
  (Replace `X.X.X.X` with the route reflector address)

- Update the DaemonSet definition:
  ```bash
  kubectl apply -f kuberouter.yaml
  ```

]

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Restarting kube-router

- The DaemonSet will not update the pods automatically

  (it is using the default `updateStrategy`, which is `OnDelete`)

- We will therefore delete the pods

  (they will be recreated with the updated definition)

.exercise[

- Delete all the kube-router pods:
  ```bash
  kubectl delete pods -n kube-system -l k8s-app=kube-router
  ```

]

Note: the other `updateStrategy` for a DaemonSet is RollingUpdate.
&lt;br/&gt;
For critical services, we might want to precisely control the update process.

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## Checking peering status

- We can see informative messages in the output of kube-router:
  ```
  time="2019-04-07T15:53:56Z" level=info msg="Peer Up"
  Key=X.X.X.X State=BGP_FSM_OPENCONFIRM Topic=Peer
  ```

- We should see the routes of the other clusters show up

- For debugging purposes, the reflector also exports a route to 1.0.0.2/32

- That route will show up like this:
  ```
  1.0.0.2     172.31.X.Y    255.255.255.255 UGH   0      0        0 eth0
  ```

- We should be able to ping the pods of other clusters!

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

## If we wanted to do more ...

- kube-router can also export ClusterIP addresses

  (by adding the flag `--advertise-cluster-ip`)

- They are exported individually (as /32)

- This would allow us to easily access other clusters' services

  (without having to resolve the individual addresses of pods)

- Even better if it's combined with DNS integration

  (to facilitate name → ClusterIP resolution)

.debug[[k8s/cni.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/ShippingContainerSFBay.jpg)]

---

name: toc-installing-a-managed-cluster
class: title

Installing a managed cluster

.nav[
[Previous section](#toc-interconnecting-clusters)
|
[Back to table of contents](#toc-chapter-11)
|
[Next section](#toc-kubernetes-distributions-and-installers)
]

.debug[(automatically generated title slide)]

---
# Installing a managed cluster

*"The easiest way to install Kubernetes is to get someone
else to do it for you."
&lt;br/&gt;
([Jérôme Petazzoni](https://twitter.com/jpetazzo))*

- Let's see a few options to install managed clusters!

- This is not an exhaustive list

  (the goal is to show the actual steps to get started)

- All the options mentioned here require an account
with a cloud provider

- ... And a credit card

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## EKS (the hard way)

- [Read the doc](https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html)

- Create service roles, VPCs, and a bunch of other oddities

- Try to figure out why it doesn't work

- Start over, following an [official AWS blog post](https://aws.amazon.com/blogs/aws/amazon-eks-now-generally-available/)

- Try to find the missing Cloud Formation template

--

.footnote[(╯°□°)╯︵ ┻━┻]

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## EKS (the easy way)

- Install `eksctl`

- Set the usual environment variables

  ([AWS_DEFAULT_REGION](https://docs.aws.amazon.com/general/latest/gr/rande.html#eks_region), AWS_ACCESS_KEY, AWS_SECRET_ACCESS_KEY)

- Create the cluster:
  ```bash
  eksctl create cluster
  ```

- Wait 15-20 minutes (yes, it's sloooooooooooooooooow)

- Add cluster add-ons

  (by default, it doesn't come with metrics-server, logging, etc.)

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## EKS (cleanup)

- Delete the cluster:
  ```bash
  eksctl delete cluster &lt;clustername&gt;
  ```

- If you need to find the name of the cluster:
  ```bash
  eksctl get clusters
  ```

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## GKE (initial setup)

- Install `gcloud`

- Login:
  ```bash
  gcloud auth init
  ```

- Create a "project":
  ```bash
  gcloud projects create my-gke-project
  gcloud config set project my-gke-project
  ```

- Pick a [region](https://cloud.google.com/compute/docs/regions-zones/)

  (example: `europe-west1`, `us-west1`, ...)

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## GKE (create cluster)

- Create the cluster:
  ```bash
  gcloud container clusters create my-gke-cluster --region us-west1 --num-nodes=2
  ```

  (without `--num-nodes` you might exhaust your IP address quota!)

- The first time you try to create a cluster in a given project, you get an error

  - you need to enable the Kubernetes Engine API
  - the error message gives you a link
  - follow the link and enable the API (and billing)
    &lt;br/&gt;(it's just a couple of clicks and it's instantaneous)

- Wait a couple of minutes (yes, it's faaaaaaaaast)

- The cluster comes with many add-ons

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## GKE (cleanup)

- List clusters (if you forgot its name):
  ```bash
  gcloud container clusters list
  ```

- Delete the cluster:
  ```bash
  gcloud container clusters delete my-gke-cluster --region us-west1
  ```

- Delete the project (optional):
  ```bash
  gcloud projects delete my-gke-project
  ```

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## AKS (initial setup)

- Install the Azure CLI

- Login:
  ```bash
  az login
  ```

- Select a [region](https://azure.microsoft.com/en-us/global-infrastructure/services/?products=kubernetes-service\®ions=all
)

- Create a "resource group":
  ```bash
  az group create --name my-aks-group --location westeurope
  ```

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## AKS (create cluster)

- Create the cluster:
  ```bash
  az aks create --resource-group my-aks-group --name my-aks-cluster
  ```

- Wait about 5-10 minutes

- Add credentials to `kubeconfig`:
  ```bash
  az aks get-credentials --resource-group my-aks-group --name my-aks-cluster
  ```

- The cluster has a lot of goodies pre-installed

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## AKS (cleanup)

- Delete the cluster:
  ```bash
  az aks delete --resource-group my-aks-group --name my-aks-cluster
  ```

- Delete the resource group:
  ```bash
  az group delete --resource-group my-aks-group
  ```

- Note: delete actions can take a while too!

  (5-10 minutes as well)

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## Digital Ocean (initial setup)

- Install `doctl`

- Generate API token (in web console)

- Set up the CLI authentication:
  ```bash
  doctl auth init
  ```
  (It will ask you for the API token)

- Check the list of regions and pick one:
  ```bash
  doctl compute region list
  ```
  (If you don't specify the region later, it will use `nyc1`)

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## Digital Ocean (create cluster)

- Create the cluster:
  ```bash
  doctl kubernetes cluster create my-do-cluster [--region xxx1]
  ```

- Wait 5 minutes

- Update `kubeconfig`:
  ```bash
  kubectl config use-context do-xxx1-my-do-cluster
  ```

- The cluster comes with some goodies (like Cilium) but no metrics server

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## Digital Ocean (cleanup)

- List clusters (if you forgot its name):
  ```bash
  doctl kubernetes cluster list
  ```

- Delete the cluster:
  ```bash
  doctl kubernetes cluster delete my-do-cluster
  ```

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

## More options

- Alibaba Cloud

- [IBM Cloud](https://console.bluemix.net/docs/containers/cs_cli_install.html#cs_cli_install)

- OVH

- Scaleway (private beta)

- ...

.debug[[k8s/setup-managed.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/aerial-view-of-containers.jpg)]

---

name: toc-kubernetes-distributions-and-installers
class: title

Kubernetes distributions and installers

.nav[
[Previous section](#toc-installing-a-managed-cluster)
|
[Back to table of contents](#toc-chapter-11)
|
[Next section](#toc-static-pods)
]

.debug[(automatically generated title slide)]

---
# Kubernetes distributions and installers

- There are [countless](https://kubernetes.io/docs/setup/pick-right-solution/) distributions available

- We can't review them all

- We're just going to explore a few options

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

## kops

- Deploys Kubernetes using cloud infrastructure

  (supports AWS, GCE, Digital Ocean ...)

- Leverages special cloud features when possible

  (e.g. Auto Scaling Groups ...)

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

## kubeadm

- Provisions Kubernetes nodes on top of existing machines

- `kubeadm init` to provision a single-node control plane

- `kubeadm join` to join a node to the cluster

- Supports HA control plane [with some extra steps](https://kubernetes.io/docs/setup/independent/high-availability/) 

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

## Kubespray

- Based on Ansible

- Works on bare metal and cloud infrastructure

  (good for hybrid deployments)

- The expert says: ultra flexible; slow; complex

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

## RKE (Rancher Kubernetes Engine)

- Opinionated installer with low requirements

- Requires a set of machines with Docker + SSH access

- Supports highly available etcd and control plane

- The expert says: fast; maintenance can be tricky

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

## Terraform + kubeadm

- Sometimes it is necessary to build a custom solution

- Example use case: 

  - deploying Kubernetes on OpenStack

  - ... with highly available control plane

  - ... and Cloud Controller Manager integration

- Solution: Terraform + kubeadm (kubeadm driven by remote-exec)

  - [GitHub repository](https://github.com/enix/terraform-openstack-kubernetes)

  - [Blog post (in French)](https://enix.io/fr/blog/deployer-kubernetes-1-13-sur-openstack-grace-a-terraform/)

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

## And many more ...

- Docker Enterprise Edition

- Pivotal Container Service (PKS)

- Tectonic by CoreOS

- etc.

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

## Bottom line

- Each distribution / installer has pros and cons

- Before picking one, we should sort out our priorities:

  - cloud, on-premises, hybrid?

  - integration with existing network/storage architecture or equipment?

  - are we storing very sensitive data, like finance, health, military?

  - how many clusters are we deploying (and maintaining): 2, 10, 50?

  - which team will be responsible for deployment and maintenance?
    &lt;br/&gt;(do they need training?)

  - etc.

.debug[[k8s/setup-selfhosted.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/blue-containers.jpg)]

---

name: toc-static-pods
class: title

Static pods

.nav[
[Previous section](#toc-kubernetes-distributions-and-installers)
|
[Back to table of contents](#toc-chapter-11)
|
[Next section](#toc-api-server-availability)
]

.debug[(automatically generated title slide)]

---
# Static pods

- Hosting the Kubernetes control plane on Kubernetes has advantages:

  - we can use Kubernetes' replication and scaling features for the control plane

  - we can leverage rolling updates to upgrade the control plane

- However, there is a catch:

  - deploying on Kubernetes requires the API to be available

  - the API won't be available until the control plane is deployed

- How can we get out of that chicken-and-egg problem?

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## A possible approach

- Since each component of the control plane can be replicated ...

- We could set up the control plane outside of the cluster

- Then, once the cluster is fully operational, create replicas running on the cluster

- Finally, remove the replicas that are running outside of the cluster

*What could possibly go wrong?*

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## Sawing off the branch you're sitting on

- What if anything goes wrong?

  (During the setup or at a later point)

- Worst case scenario, we might need to:

  - set up a new control plane (outside of the cluster)
  
  - restore a backup from the old control plane
  
  - move the new control plane to the cluster (again)

- This doesn't sound like a great experience

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## Static pods to the rescue

- Pods are started by kubelet (an agent running on every node)

- To know which pods it should run, the kubelet queries the API server

- The kubelet can also get a list of *static pods* from:

  - a directory containing one (or multiple) *manifests*, and/or
  
  - a URL (serving a *manifest*)

- These "manifests" are basically YAML definitions

  (As produced by `kubectl get pod my-little-pod -o yaml`)

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## Static pods are dynamic

- Kubelet will periodically reload the manifests

- It will start/stop pods accordingly

  (i.e. it is not necessary to restart the kubelet after updating the manifests)

- When connected to the Kubernetes API, the kubelet will create *mirror pods*

- Mirror pods are copies of the static pods

  (so they can be seen with e.g. `kubectl get pods`)

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## Bootstrapping a cluster with static pods

- We can run control plane components with these static pods

- They can start without requiring access to the API server

- Once they are up and running, the API becomes available

- These pods are then visible through the API

  (We cannot upgrade them from the API, though)

*This is how kubeadm has initialized our clusters.*

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## Static pods vs normal pods

- The API only gives us a read-only access to static pods

- We can `kubectl delete` a static pod ...

  ... But the kubelet will re-mirror it immediately

- Static pods can be selected just like other pods

  (So they can receive service traffic)

- A service can select a mixture of static and other pods

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## From static pods to normal pods

- Once the control plane is up and running, it can be used to create normal pods

- We can then set up a copy of the control plane in normal pods

- Then the static pods can be removed

- The scheduler and the controller manager use leader election

  (Only one is active at a time; removing an instance is seamless)

- Each instance of the API server adds itself to the `kubernetes` service

- Etcd will typically require more work!

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## From normal pods back to static pods

- Alright, but what if the control plane is down and we need to fix it?

- We restart it using static pods!

- This can be done automatically with the [Pod Checkpointer]

- The Pod Checkpointer automatically generates manifests of running pods

- The manifests are used to restart these pods if API contact is lost

  (More details in the [Pod Checkpointer] documentation page)

- This technique is used by [bootkube]

[Pod Checkpointer]: https://github.com/kubernetes-incubator/bootkube/blob/master/cmd/checkpoint/README.md
[bootkube]: https://github.com/kubernetes-incubator/bootkube

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## Where should the control plane run?

*Is it better to run the control plane in static pods, or normal pods?*

- If I'm a *user* of the cluster: I don't care, it makes no difference to me

- What if I'm an *admin*, i.e. the person who installs, upgrades, repairs... the cluster?

- If I'm using a managed Kubernetes cluster (AKS, EKS, GKE...) it's not my problem

  (I'm not the one setting up and managing the control plane)

- If I already picked a tool (kubeadm, kops...) to set up my cluster, the tool decides for me

- What if I haven't picked a tool yet, or if I'm installing from scratch?

  - static pods = easier to set up, easier to troubleshoot, less risk of outage

  - normal pods = easier to upgrade, easier to move (if nodes need to be shut down)

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

## Static pods in action

- On our clusters, the `staticPodPath` is `/etc/kubernetes/manifests`

.exercise[

- Have a look at this directory:
  ```bash
  ls -l /etc/kubernetes/manifests
  ```

]

We should see YAML files corresponding to the pods of the control plane.

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

class: static-pods-exercise

## Running a static pod

- We are going to add a pod manifest to the directory, and kubelet will run it

.exercise[

- Copy a manifest to the directory:
  ```bash
  sudo cp ~/container.training/k8s/just-a-pod.yaml /etc/kubernetes/manifests
  ```

- Check that it's running:
  ```bash
  kubectl get pods
  ```

]

The output should include a pod named `hello-node1`.

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

class: static-pods-exercise

## Remarks

In the manifest, the pod was named `hello`.

```yaml
apiVersion: v1
Kind: Pod
metadata:
  name: hello
  namespace: default
spec:
  containers:
  - name: hello
    image: nginx
```

The `-node1` suffix was added automatically by kubelet.

If we delete the pod (with `kubectl delete`), it will be recreated immediately.

To delete the pod, we need to delete (or move) the manifest file.

.debug[[k8s/staticpods.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/chinook-helicopter-container.jpg)]

---

name: toc-api-server-availability
class: title

API server availability

.nav[
[Previous section](#toc-static-pods)
|
[Back to table of contents](#toc-chapter-12)
|
[Next section](#toc-upgrading-clusters)
]

.debug[(automatically generated title slide)]

---
# API server availability

- When we set up a node, we need the address of the API server:

  - for kubelet

  - for kube-proxy

  - sometimes for the pod network system (like kube-router)

- How do we ensure the availability of that endpoint?

  (what if the node running the API server goes down?)

.debug[[k8s/apilb.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md)]
---

## Option 1: external load balancer

- Set up an external load balancer

- Point kubelet (and other components) to that load balancer

- Put the node(s) running the API server behind that load balancer

- Update the load balancer if/when an API server node needs to be replaced

- On cloud infrastructures, some mechanisms provide automation for this

  (e.g. on AWS, an Elastic Load Balancer + Auto Scaling Group)

- [Example in Kubernetes The Hard Way](https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/08-bootstrapping-kubernetes-controllers.md#the-kubernetes-frontend-load-balancer)

.debug[[k8s/apilb.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md)]
---

## Option 2: local load balancer

- Set up a load balancer (like NGINX, HAProxy...) on *each* node

- Configure that load balancer to send traffic to the API server node(s)

- Point kubelet (and other components) to `localhost`

- Update the load balancer configuration when API server nodes are updated

.debug[[k8s/apilb.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md)]
---

## Updating the local load balancer config

- Distribute the updated configuration (push)

- Or regularly check for updates (pull)

- The latter requires an external, highly available store
 
  (it could be an object store, an HTTP server, or even DNS...)

- Updates can be facilitated by a DaemonSet

  (but remember that it can't be used when installing a new node!)

.debug[[k8s/apilb.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md)]
---

## Option 3: DNS records

- Put all the API server nodes behind a round-robin DNS

- Point kubelet (and other components) to that name

- Update the records when needed

- Note: this option is not officially supported

  (but since kubelet supports reconnection anyway, it *should* work)

.debug[[k8s/apilb.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md)]
---

## Option 4: ....................

- Many managed clusters expose a high-availability API endpoint

  (and you don't have to worry about it)

- You can also use HA mechanisms that you're familiar with

  (e.g. virtual IPs)

- Tunnels are also fine

  (e.g. [k3s](https://k3s.io/) uses a tunnel to allow each node to contact the API server)

.debug[[k8s/apilb.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-cranes.jpg)]

---

name: toc-upgrading-clusters
class: title

Upgrading clusters

.nav[
[Previous section](#toc-api-server-availability)
|
[Back to table of contents](#toc-chapter-12)
|
[Next section](#toc-backing-up-clusters)
]

.debug[(automatically generated title slide)]

---
# Upgrading clusters

- It's *recommended* to run consistent versions across a cluster

  (mostly to have feature parity and latest security updates)

- It's not *mandatory*

  (otherwise, cluster upgrades would be a nightmare!)

- Components can be upgraded one at a time without problems

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Checking what we're running

- It's easy to check the version for the API server

.exercise[

- Log into node `test1`

- Check the version of kubectl and of the API server:
  ```bash
  kubectl version
  ```

]

- In a HA setup with multiple API servers, they can have different versions

- Running the command above multiple times can return different values

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Node versions

- It's also easy to check the version of kubelet

.exercise[

- Check node versions (includes kubelet, kernel, container engine):
  ```bash
  kubectl get nodes -o wide
  ```

]

- Different nodes can run different kubelet versions

- Different nodes can run different kernel versions

- Different nodes can run different container engines

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Control plane versions

- If the control plane is self-hosted (running in pods), we can check it

.exercise[

- Show image versions for all pods in `kube-system` namespace:
  ```bash
    kubectl --namespace=kube-system get pods -o json \
            | jq -r '
              .items[]
              | [.spec.nodeName, .metadata.name]
                + 
                (.spec.containers[].image | split(":"))
              | @tsv
              ' \
            | column -t
  ```

]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## What version are we running anyway?

- When I say, "I'm running Kubernetes 1.11", is that the version of:

  - kubectl

  - API server

  - kubelet

  - controller manager

  - something else?

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Other versions that are important

- etcd

- kube-dns or CoreDNS

- CNI plugin(s)

- Network controller, network policy controller

- Container engine

- Linux kernel

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## General guidelines

- To update a component, use whatever was used to install it

- If it's a distro package, update that distro package

- If it's a container or pod, update that container or pod

- If you used configuration management, update with that

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Know where your binaries come from

- Sometimes, we need to upgrade *quickly*

  (when a vulnerability is announced and patched)

- If we are using an installer, we should:

  - make sure it's using upstream packages

  - or make sure that whatever packages it uses are current

  - make sure we can tell it to pin specific component versions

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## In practice

- We are going to update a few cluster components

- We will change the kubelet version on one node

- We will change the version of the API server

- We will work with cluster `test` (nodes `test1`, `test2`, `test3`)

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Updating kubelet

- These nodes have been installed using the official Kubernetes packages

- We can therefore use `apt` or `apt-get`

.exercise[

- Log into node `test3`

- View available versions for package `kubelet`:
  ```bash
  apt show kubelet -a | grep ^Version
  ```

- Upgrade kubelet:
  ```bash
  apt install kubelet=1.14.2-00
  ```

]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Checking what we've done

.exercise[

- Log into node `test1`

- Check node versions:
  ```bash
  kubectl get nodes -o wide
  ```

- Create a deployment and scale it to make sure that the node still works

]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Updating the API server

- This cluster has been deployed with kubeadm

- The control plane runs in *static pods*

- These pods are started automatically by kubelet

  (even when kubelet can't contact the API server)

- They are defined in YAML files in `/etc/kubernetes/manifests`

  (this path is set by a kubelet command-line flag)

- kubelet automatically updates the pods when the files are changed

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Changing the API server version

- We will edit the YAML file to use a different image version

.exercise[

- Log into node `test1`

- Check API server version:
  ```bash
  kubectl version
  ```

- Edit the API server pod manifest:
  ```bash
  sudo vim /etc/kubernetes/manifests/kube-apiserver.yaml
  ```

- Look for the `image:` line, and update it to e.g. `v1.14.0`

]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Checking what we've done

- The API server will be briefly unavailable while kubelet restarts it

.exercise[

- Check the API server version:
  ```bash
  kubectl version
  ```

]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Updating the whole control plane

- As an example, we'll use kubeadm to upgrade the entire control plane

  (note: this is possible only because the cluster was installed with kubeadm)

.exercise[

- Check what will be upgraded:
  ```bash
  sudo kubeadm upgrade plan
  ```

  (Note: kubeadm is confused by our manual upgrade of the API server.
  &lt;br/&gt;It thinks the cluster is running 1.14.0!)

&lt;!-- ##VERSION## --&gt;

- Perform the upgrade:
  ```bash
  sudo kubeadm upgrade apply v1.14.2
  ```

]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Updating kubelets

- After updating the control plane, we need to update each kubelet

- This requires to run a special command on each node, to download the config

  (this config is generated by kubeadm)

.exercise[

- Download the configuration on each node, and upgrade kubelet:
  ```bash
    for N in 1 2 3; do
    	ssh node$N sudo kubeadm upgrade node config --kubelet-version v1.14.2
  	  ssh node $N sudo apt install kubelet=1.14.2-00
    done
  ```
]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

## Checking what we've done

- All our nodes should now be updated to version 1.14.2

.exercise[

- Check nodes versions:
  ```bash
  kubectl get nodes -o wide
  ```

]

.debug[[k8s/cluster-upgrade.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-housing.jpg)]

---

name: toc-backing-up-clusters
class: title

Backing up clusters

.nav[
[Previous section](#toc-upgrading-clusters)
|
[Back to table of contents](#toc-chapter-12)
|
[Next section](#toc-the-cloud-controller-manager)
]

.debug[(automatically generated title slide)]

---
# Backing up clusters

- Backups can have multiple purposes:

  - disaster recovery (servers or storage are destroyed or unreachable)

  - error recovery (human or process has altered or corrupted data)

  - cloning environments (for testing, validation ...)

- Let's see the strategies and tools available with Kubernetes!

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Important

- Kubernetes helps us with disaster recovery

  (it gives us replication primitives)

- Kubernetes helps us to clone / replicate environments

  (all resources can be described with manifests)

- Kubernetes *does not* help us with error recovery

- We still need to backup / snapshot our data:

  - with database backups (mysqldump, pgdump, etc.)

  - and/or snapshots at the storage layer

  - and/or traditional full disk backups

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## In a perfect world ...

- The deployment of our Kubernetes clusters is automated

  (recreating a cluster takes less than a minute of human time)

- All the resources (Deployments, Services...) on our clusters are under version control

  (never use `kubectl run`; always apply YAML files coming from a repository)

- Stateful components are either:

  - stored on systems with regular snapshots

  - backed up regularly to an external, durable storage

  - outside of Kubernetes

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Kubernetes cluster deployment

- If our deployment system isn't fully automated, it should at least be documented

- Litmus test: how long does it take to deploy a cluster ...

  - for a senior engineer?

  - for a new hire?

- Does it require external intervention?

  (e.g. provisioning servers, signing TLS certs ...)

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Plan B

- Full machine backups of the control plane can help

- If the control plane is in pods (or containers), pay attention to storage drivers

  (if the backup mechanism is not container-aware, the backups can take way more resources than they should, or even be unusable!)

- If the previous sentence worries you:

  **automate the deployment of your clusters!**

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Managing our Kubernetes resources

- Ideal scenario:

  - never create a resource directly on a cluster

  - push to a code repository

  - a special branch (`production` or even `master`) gets automatically deployed

- Some folks call this "GitOps"

  (it's the logical evolution of configuration management and infrastructure as code)

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## GitOps in theory

- What do we keep in version control?

- For very simple scenarios: source code, Dockerfiles, scripts

- For real applications: add resources (as YAML files)

- For applications deployed multiple times: Helm, Kustomize ...

  (staging and production count as "multiple times")

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## GitOps tooling

- Various tools exist (Weave Flux, GitKube...)

- These tools are still very young

- You still need to write YAML for all your resources

- There is no tool to:

  - list *all* resources in a namespace

  - get resource YAML in a canonical form

  - diff YAML descriptions with current state

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## GitOps in practice

- Start describing your resources with YAML

- Leverage a tool like Kustomize or Helm

- Make sure that you can easily deploy to a new namespace

  (or even better: to a new cluster)

- When tooling matures, you will be ready

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Plan B

- What if we can't describe everything with YAML?

- What if we manually create resources and forget to commit them to source control?

- What about global resources, that don't live in a namespace?

- How can we be sure that we saved *everything*?

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Backing up etcd

- All objects are saved in etcd

- etcd data should be relatively small

  (and therefore, quick and easy to back up)

- Two options to back up etcd:

  - snapshot the data directory

  - use `etcdctl snapshot`

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Making an etcd snapshot

- The basic command is simple:
  ```bash
  etcdctl snapshot save &lt;filename&gt;
  ```

- But we also need to specify:

  - an environment variable to specify that we want etcdctl v3

  - the address of the server to back up

  - the path to the key, certificate, and CA certificate
    &lt;br/&gt;(if our etcd uses TLS certificates)

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Snapshotting etcd on kubeadm

- The following command will work on clusters deployed with kubeadm

  (and maybe others)

- It should be executed on a master node

```bash
docker run --rm --net host -v $PWD:/vol \
    -v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd:ro \
    -e ETCDCTL_API=3 k8s.gcr.io/etcd:3.3.10 \
    etcdctl --endpoints=https://[127.0.0.1]:2379 \
            --cacert=/etc/kubernetes/pki/etcd/ca.crt \
            --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
            --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \
            snapshot save /vol/snapshot
```

- It will create a file named `snapshot` in the current directory

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## How can we remember all these flags?

- Look at the static pod manifest for etcd

  (in `/etc/kubernetes/manifests`)

- The healthcheck probe is calling `etcdctl` with all the right flags 
  😉👍✌️

- Exercise: write the YAML for a batch job to perform the backup

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Restoring an etcd snapshot

- ~~Execute exactly the same command, but replacing `save` with `restore`~~

  (Believe it or not, doing that will *not* do anything useful!)

- The `restore` command does *not* load a snapshot into a running etcd server

- The `restore` command creates a new data directory from the snapshot

  (it's an offline operation; it doesn't interact with an etcd server)

- It will create a new data directory in a temporary container

  (leaving the running etcd node untouched)

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## When using kubeadm

1. Create a new data directory from the snapshot:
   ```bash
   sudo rm -rf /var/lib/etcd
   docker run --rm -v /var/lib:/var/lib -v $PWD:/vol \
          -e ETCDCTL_API=3 k8s.gcr.io/etcd:3.3.10 \
          etcdctl snapshot restore /vol/snapshot --data-dir=/var/lib/etcd
   ```

2. Provision the control plane, using that data directory:
   ```bash
   sudo kubeadm init \
        --ignore-preflight-errors=DirAvailable--var-lib-etcd
   ```

3. Rejoin the other nodes

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## The fine print

- This only saves etcd state

- It **does not** save persistent volumes and local node data

- Some critical components (like the pod network) might need to be reset

- As a result, our pods might have to be recreated, too

- If we have proper liveness checks, this should happen automatically

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## More information about etcd backups

- [Kubernetes documentation](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#built-in-snapshot) about etcd backups

- [etcd documentation](https://coreos.com/etcd/docs/latest/op-guide/recovery.html#snapshotting-the-keyspace) about snapshots and restore

- [A good blog post by elastisys](https://elastisys.com/2018/12/10/backup-kubernetes-how-and-why/) explaining how to restore a snapshot

- [Another good blog post by consol labs](https://labs.consol.de/kubernetes/2018/05/25/kubeadm-backup.html) on the same topic

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Don't forget ...

- Also back up the TLS information

  (at the very least: CA key and cert; API server key and cert)

- With clusters provisioned by kubeadm, this is in `/etc/kubernetes/pki`

- If you don't:

  - you will still be able to restore etcd state and bring everything back up

  - you will need to redistribute user certificates

.warning[**TLS information is highly sensitive! 
&lt;br/&gt;Anyone who has it has full access to your cluster!**]

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Stateful services

- It's totally fine to keep your production databases outside of Kubernetes

  *Especially if you have only one database server!*

- Feel free to put development and staging databases on Kubernetes

  (as long as they don't hold important data)

- Using Kubernetes for stateful services makes sense if you have *many*

  (because then you can leverage Kubernetes automation)

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## Snapshotting persistent volumes

- Option 1: snapshot volumes out of band

  (with the API/CLI/GUI of our SAN/cloud/...)

- Option 2: storage system integration

  (e.g. [Portworx](https://docs.portworx.com/portworx-install-with-kubernetes/storage-operations/create-snapshots/) can [create snapshots through annotations](https://docs.portworx.com/portworx-install-with-kubernetes/storage-operations/create-snapshots/snaps-annotations/#taking-periodic-snapshots-on-a-running-pod))

- Option 3: [snapshots through Kubernetes API](https://kubernetes.io/blog/2018/10/09/introducing-volume-snapshot-alpha-for-kubernetes/)

  (now in alpha for a few storage providers: GCE, OpenSDS, Ceph, Portworx)

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

## More backup tools

- [Stash](https://appscode.com/products/stash/)

  back up Kubernetes persistent volumes

- [ReShifter](https://github.com/mhausenblas/reshifter)

  cluster state management

- ~~Heptio Ark~~ [Velero](https://github.com/heptio/velero)

  full cluster backup

- [kube-backup](https://github.com/pieterlange/kube-backup)

  simple scripts to save resource YAML to a git repository

.debug[[k8s/cluster-backup.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/containers-by-the-water.jpg)]

---

name: toc-the-cloud-controller-manager
class: title

The Cloud Controller Manager

.nav[
[Previous section](#toc-backing-up-clusters)
|
[Back to table of contents](#toc-chapter-12)
|
[Next section](#toc-authentication-and-authorization)
]

.debug[(automatically generated title slide)]

---
# The Cloud Controller Manager

- Kubernetes has many features that are cloud-specific

  (e.g. providing cloud load balancers when a Service of type LoadBalancer is created)

- These features were initially implemented in API server and controller manager

- Since Kubernetes 1.6, these features are available through a separate process:

  the *Cloud Controller Manager*

- The CCM is optional, but if we run in a cloud, we probably want it!

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

## Cloud Controller Manager duties

- Creating and updating cloud load balancers

- Configuring routing tables in the cloud network (specific to GCE)

- Updating node labels to indicate region, zone, instance type ...

- Obtain node name, internal and external addresses from cloud metadata service

- Deleting nodes from Kubernetes when they're deleted in the cloud

- Managing *some* volumes (e.g. ELBs, AzureDisks ...)

  (Eventually, volumes will be managed by the CSI)

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

## In-tree vs. out-of-tree

- A number of cloud providers are supported "in-tree"

  (in the main kubernetes/kubernetes repository on GitHub)

- More cloud providers are supported "out-of-tree"

  (with code in different repositories)

- There is an [ongoing effort](https://github.com/kubernetes/kubernetes/tree/master/pkg/cloudprovider) to move everything to out-of-tree providers

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

## In-tree providers

The following providers are actively maintained:

- Amazon Web Services
- Azure
- Google Compute Engine
- IBM Cloud
- OpenStack
- VMware vSphere

These ones are less actively maintained:

- Apache CloudStack
- oVirt
- VMware Photon

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

## Out-of-tree providers

The list includes the following providers:

- DigitalOcean

- keepalived (not exactly a cloud; provides VIPs for load balancers)

- Linode

- Oracle Cloud Infrastructure

(And possibly others; there is no central registry for these.)

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

## Cloud Controller Manager in practice

- Write a configuration file

  (typically `/etc/kubernetes/cloud.conf`)

- Run the CCM process

  (on self-hosted clusters, this can be a DaemonSet selecting the control plane nodes)

- Start kubelet with `--cloud-provider=external`

- When using managed clusters, this is done automatically

- There is very little documentation to write the configuration file

  (except for OpenStack)

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

## Bootstrapping challenges

- When a node joins the cluster, it needs to obtain a signed TLS certificate

- That certificate must contain the node's addresses

- These addresses are provided by the Cloud Controller Manager

  (at least the external address)

- To get these addresses, the node needs to communicate with the control plane

- ... Which means joining the cluster

(The problem didn't occur when cloud-specific code was running in kubelet: kubelet could obtain the required information directly from the cloud provider's metadata service.)

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

## More information about CCM

- CCM configuration and operation is highly specific to each cloud provider

  (which is why this section remains very generic)

- The Kubernetes documentation has *some* information:

  - [architecture and diagrams](https://kubernetes.io/docs/concepts/architecture/cloud-controller/)

  - [configuration](https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/) (mainly for OpenStack)

  - [deployment](https://kubernetes.io/docs/tasks/administer-cluster/running-cloud-controller/)

.debug[[k8s/cloud-controller-manager.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/distillery-containers.jpg)]

---

name: toc-authentication-and-authorization
class: title

Authentication and authorization

.nav[
[Previous section](#toc-the-cloud-controller-manager)
|
[Back to table of contents](#toc-chapter-13)
|
[Next section](#toc-the-csr-api)
]

.debug[(automatically generated title slide)]

---
# Authentication and authorization

*And first, a little refresher!*

- Authentication = verifying the identity of a person

  On a UNIX system, we can authenticate with login+password, SSH keys ...

- Authorization = listing what they are allowed to do

  On a UNIX system, this can include file permissions, sudoer entries ...

- Sometimes abbreviated as "authn" and "authz"

- In good modular systems, these things are decoupled

   (so we can e.g. change a password or SSH key without having to reset access rights)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Authentication in Kubernetes

- When the API server receives a request, it tries to authenticate it

  (it examines headers, certificates ... anything available)

- Many authentication methods are available and can be used simultaneously

  (we will see them on the next slide)

- It's the job of the authentication method to produce:

  - the user name
  - the user ID
  - a list of groups

- The API server doesn't interpret these; it'll be the job of *authorizers*

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Authentication methods

- TLS client certificates

  (that's what we've been doing with `kubectl` so far)

- Bearer tokens

  (a secret token in the HTTP headers of the request)

- [HTTP basic auth](https://en.wikipedia.org/wiki/Basic_access_authentication)

  (carrying user and password in a HTTP header)

- Authentication proxy

  (sitting in front of the API and setting trusted headers)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Anonymous requests

- If any authentication method *rejects* a request, it's denied

  (`401 Unauthorized` HTTP code)

- If a request is neither rejected nor accepted by anyone, it's anonymous

  - the user name is `system:anonymous`

  - the list of groups is `[system:unauthenticated]`

- By default, the anonymous user can't do anything

  (that's what you get if you just `curl` the Kubernetes API)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Authentication with TLS certificates

- This is enabled in most Kubernetes deployments

- The user name is derived from the `CN` in the client certificates

- The groups are derived from the `O` fields in the client certificate

- From the point of view of the Kubernetes API, users do not exist

  (i.e. they are not stored in etcd or anywhere else)

- Users can be created (and given membership to groups) independently of the API

- The Kubernetes API can be set up to use your custom CA to validate client certs

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Viewing our admin certificate

- Let's inspect the certificate we've been using all this time!

.exercise[

- This command will show the `CN` and `O` fields for our certificate:
  ```bash
  kubectl config view \
          --raw \
          -o json \
          | jq -r .users[0].user[\"client-certificate-data\"] \
          | openssl base64 -d -A \
          | openssl x509 -text \
          | grep Subject:
  ```

]

Let's break down that command together! 😅

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Breaking down the command

- `kubectl config view` shows the Kubernetes user configuration
- `--raw` includes certificate information (which shows as REDACTED otherwise)
- `-o json` outputs the information in JSON format
- `| jq ...` extracts the field with the user certificate (in base64)
- `| openssl base64 -d -A` decodes the base64 format (now we have a PEM file)
- `| openssl x509 -text` parses the certificate and outputs it as plain text
- `| grep Subject:` shows us the line that interests us

→ We are user `kubernetes-admin`, in group `system:masters`.

(We will see later how and why this gives us the permissions that we have.)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## User certificates in practice

- The Kubernetes API server does not support certificate revocation

  (see issue [#18982](https://github.com/kubernetes/kubernetes/issues/18982))

- As a result, we don't have an easy way to terminate someone's access

  (if their key is compromised, or they leave the organization)

- Option 1: re-create a new CA and re-issue everyone's certificates 
  &lt;br/&gt;
  → Maybe OK if we only have a few users; no way otherwise

- Option 2: don't use groups; grant permissions to individual users
  &lt;br/&gt;
  → Inconvenient if we have many users and teams; error-prone

- Option 3: issue short-lived certificates (e.g. 24 hours) and renew them often
  &lt;br/&gt;
  → This can be facilitated by e.g. Vault or by the Kubernetes CSR API

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Authentication with tokens

- Tokens are passed as HTTP headers:

  `Authorization: Bearer and-then-here-comes-the-token`

- Tokens can be validated through a number of different methods:

  - static tokens hard-coded in a file on the API server

  - [bootstrap tokens](https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/) (special case to create a cluster or join nodes)

  - [OpenID Connect tokens](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens) (to delegate authentication to compatible OAuth2 providers)

  - service accounts (these deserve more details, coming right up!)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Service accounts

- A service account is a user that exists in the Kubernetes API

  (it is visible with e.g. `kubectl get serviceaccounts`)

- Service accounts can therefore be created / updated dynamically

  (they don't require hand-editing a file and restarting the API server)

- A service account is associated with a set of secrets

  (the kind that you can view with `kubectl get secrets`)

- Service accounts are generally used to grant permissions to applications, services ...

  (as opposed to humans)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Token authentication in practice

- We are going to list existing service accounts

- Then we will extract the token for a given service account

- And we will use that token to authenticate with the API

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Listing service accounts

.exercise[

- The resource name is `serviceaccount` or `sa` in short:
  ```bash
  kubectl get sa
  ```

]

There should be just one service account in the default namespace: `default`.

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Finding the secret

.exercise[

- List the secrets for the `default` service account:
  ```bash
  kubectl get sa default -o yaml
  SECRET=$(kubectl get sa default -o json | jq -r .secrets[0].name)
  ```

]

It should be named `default-token-XXXXX`.

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Extracting the token

- The token is stored in the secret, wrapped with base64 encoding

.exercise[

- View the secret:
  ```bash
  kubectl get secret $SECRET -o yaml
  ```

- Extract the token and decode it:
  ```bash
  TOKEN=$(kubectl get secret $SECRET -o json \
          | jq -r .data.token | openssl base64 -d -A)
  ```

]

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Using the token

- Let's send a request to the API, without and with the token

.exercise[

- Find the ClusterIP for the `kubernetes` service:
  ```bash
  kubectl get svc kubernetes
  API=$(kubectl get svc kubernetes -o json | jq -r .spec.clusterIP)
  ```

- Connect without the token:
  ```bash
  curl -k https://$API
  ```

- Connect with the token:
  ```bash
  curl -k -H "Authorization: Bearer $TOKEN" https://$API
  ```

]

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Results

- In both cases, we will get a "Forbidden" error

- Without authentication, the user is `system:anonymous`

- With authentication, it is shown as `system:serviceaccount:default:default`

- The API "sees" us as a different user

- But neither user has any right, so we can't do nothin'

- Let's change that!

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Authorization in Kubernetes

- There are multiple ways to grant permissions in Kubernetes, called [authorizers](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#authorization-modules):

  - [Node Authorization](https://kubernetes.io/docs/reference/access-authn-authz/node/) (used internally by kubelet; we can ignore it)

  - [Attribute-based access control](https://kubernetes.io/docs/reference/access-authn-authz/abac/) (powerful but complex and static; ignore it too)

  - [Webhook](https://kubernetes.io/docs/reference/access-authn-authz/webhook/) (each API request is submitted to an external service for approval)

  - [Role-based access control](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) (associates permissions to users dynamically)

- The one we want is the last one, generally abbreviated as RBAC

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Role-based access control

- RBAC allows to specify fine-grained permissions

- Permissions are expressed as *rules*

- A rule is a combination of:

  - [verbs](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) like create, get, list, update, delete ...

  - resources (as in "API resource", like pods, nodes, services ...)

  - resource names (to specify e.g. one specific pod instead of all pods)

  - in some case, [subresources](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#referring-to-resources) (e.g. logs are subresources of pods)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## From rules to roles to rolebindings

- A *role* is an API object containing a list of *rules*

  Example: role "external-load-balancer-configurator" can:
  - [list, get] resources [endpoints, services, pods]
  - [update] resources [services]

- A *rolebinding* associates a role with a user

  Example: rolebinding "external-load-balancer-configurator":
  - associates user "external-load-balancer-configurator"
  - with role "external-load-balancer-configurator"

- Yes, there can be users, roles, and rolebindings with the same name

- It's a good idea for 1-1-1 bindings; not so much for 1-N ones

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Cluster-scope permissions

- API resources Role and RoleBinding are for objects within a namespace

- We can also define API resources ClusterRole and ClusterRoleBinding

- These are a superset, allowing to:

  - specify actions on cluster-wide objects (like nodes)

  - operate across all namespaces

- We can create Role and RoleBinding resources within a namespaces

- ClusterRole and ClusterRoleBinding resources are global

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Pods and service accounts

- A pod can be associated to a service account

  - by default, it is associated to the `default` service account

  - as we've seen earlier, this service account has no permission anyway

- The associated token is exposed into the pod's filesystem

  (in `/var/run/secrets/kubernetes.io/serviceaccount/token`)

- Standard Kubernetes tooling (like `kubectl`) will look for it there

- So Kubernetes tools running in a pod will automatically use the service account

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## In practice

- We are going to create a service account

- We will use a default cluster role (`view`)

- We will bind together this role and this service account

- Then we will run a pod using that service account

- In this pod, we will install `kubectl` and check our permissions

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Creating a service account

- We will call the new service account `viewer`

  (note that nothing prevents us from calling it `view`, like the role)

.exercise[

- Create the new service account:
  ```bash
  kubectl create serviceaccount viewer
  ```

- List service accounts now:
  ```bash
  kubectl get serviceaccounts
  ```

]

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Binding a role to the service account

- Binding a role = creating a *rolebinding* object

- We will call that object `viewercanview`

  (but again, we could call it `view`)

.exercise[

- Create the new role binding:
  ```bash
  kubectl create rolebinding viewercanview \
          --clusterrole=view \
          --serviceaccount=default:viewer
  ```

]

It's important to note a couple of details in these flags ...

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Roles vs Cluster Roles

- We used `--clusterrole=view`

- What would have happened if we had used `--role=view`?

  - we would have bound the role `view` from the local namespace
    &lt;br/&gt;(instead of the cluster role `view`)

  - the command would have worked fine (no error)

  - but later, our API requests would have been denied

- This is a deliberate design decision

  (we can reference roles that don't exist, and create/update them later)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Users vs Service Accounts

- We used `--serviceaccount=default:viewer`

- What would have happened if we had used `--user=default:viewer`?

  - we would have bound the role to a user instead of a service account

  - again, the command would have worked fine (no error)

  - ... but our API requests would have been denied later

- What's about the `default:` prefix?

  - that's the namespace of the service account

  - yes, it could be inferred from context, but ... `kubectl` requires it

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Testing

- We will run an `alpine` pod and install `kubectl` there

.exercise[

- Run a one-time pod:
  ```bash
  kubectl run eyepod --rm -ti --restart=Never \
          --serviceaccount=viewer \
          --image alpine
  ```

- Install `curl`, then use it to install `kubectl`:
  ```bash
  apk add --no-cache curl
  URLBASE=https://storage.googleapis.com/kubernetes-release/release
  KUBEVER=$(curl -s $URLBASE/stable.txt)
  curl -LO $URLBASE/$KUBEVER/bin/linux/amd64/kubectl
  chmod +x kubectl
  ```

]

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Running `kubectl` in the pod

- We'll try to use our `view` permissions, then to create an object

.exercise[

- Check that we can, indeed, view things:
  ```bash
  ./kubectl get all
  ```

- But that we can't create things:
  ```
  ./kubectl create deployment testrbac --image=nginx
  ```

- Exit the container with `exit` or `^D`

&lt;!-- ```keys ^D``` --&gt;

]

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

## Testing directly with `kubectl`

- We can also check for permission with `kubectl auth can-i`:
  ```bash
  kubectl auth can-i list nodes
  kubectl auth can-i create pods
  kubectl auth can-i get pod/name-of-pod
  kubectl auth can-i get /url-fragment-of-api-request/
  kubectl auth can-i '*' services
  ```

- And we can check permissions on behalf of other users:
  ```bash
  kubectl auth can-i list nodes \
          --as some-user
  kubectl auth can-i list nodes \
          --as system:serviceaccount:&lt;namespace&gt;:&lt;name-of-service-account&gt;
  ```

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Where does this `view` role come from?

- Kubernetes defines a number of ClusterRoles intended to be bound to users

- `cluster-admin` can do *everything* (think `root` on UNIX)

- `admin` can do *almost everything* (except e.g. changing resource quotas and limits)

- `edit` is similar to `admin`, but cannot view or edit permissions

- `view` has read-only access to most resources, except permissions and secrets

*In many situations, these roles will be all you need.*

*You can also customize them if needed!*

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Customizing the default roles

- If you need to *add* permissions to these default roles (or others),
  &lt;br/&gt;
  you can do it through the [ClusterRole Aggregation](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#aggregated-clusterroles) mechanism

- This happens by creating a ClusterRole with the following labels:
  ```yaml
    metadata:
      labels:
        rbac.authorization.k8s.io/aggregate-to-admin: "true"
        rbac.authorization.k8s.io/aggregate-to-edit: "true"
        rbac.authorization.k8s.io/aggregate-to-view: "true"
  ```

- This ClusterRole permissions will be added to `admin`/`edit`/`view` respectively

- This is particulary useful when using CustomResourceDefinitions

  (since Kubernetes cannot guess which resources are sensitive and which ones aren't)

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Where do our permissions come from?

- When interacting with the Kubernetes API, we are using a client certificate

- We saw previously that this client certificate contained:

  `CN=kubernetes-admin` and `O=system:masters`

- Let's look for these in existing ClusterRoleBindings:
  ```bash
  kubectl get clusterrolebindings -o yaml | 
    grep -e kubernetes-admin -e system:masters
  ```

  (`system:masters` should show up, but not `kubernetes-admin`.)

- Where does this match come from?

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## The `system:masters` group

- If we eyeball the output of `kubectl get clusterrolebindings -o yaml`, we'll find out!

- It is in the `cluster-admin` binding:
  ```bash
  kubectl describe clusterrolebinding cluster-admin
  ```

- This binding associates `system:masters` to the cluster role `cluster-admin`

- And the `cluster-admin` is, basically, `root`:
  ```bash
  kubectl describe clusterrole cluster-admin
  ```

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: extra-details

## Figuring out who can do what

- For auditing purposes, sometimes we want to know who can perform an action

- Here is a proof-of-concept tool by Aqua Security, doing exactly that:

  https://github.com/aquasecurity/kubectl-who-can

- This is one way to install it:
  ```bash
  docker run --rm -v /usr/local/bin:/go/bin golang \
         go get -v github.com/aquasecurity/kubectl-who-can
  ```

- This is one way to use it:
  ```bash
  kubectl-who-can create pods
  ```

.debug[[k8s/authn-authz.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/lots-of-containers.jpg)]

---

name: toc-the-csr-api
class: title

The CSR API

.nav[
[Previous section](#toc-authentication-and-authorization)
|
[Back to table of contents](#toc-chapter-13)
|
[Next section](#toc-openid-connect)
]

.debug[(automatically generated title slide)]

---
# The CSR API

- The Kubernetes API exposes CSR resources

- We can use these resources to issue TLS certificates

- First, we will go through a quick reminder about TLS certificates

- Then, we will see how to obtain a certificate for a user

- We will use that certificate to authenticate with the cluster

- Finally, we will grant some privileges to that user

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Reminder about TLS

- TLS (Transport Layer Security) is a protocol providing:

  - encryption (to prevent eavesdropping)

  - authentication (using public key cryptography)

- When we access an https:// URL, the server authenticates itself

  (it proves its identity to us; as if it were "showing its ID")

- But we can also have mutual TLS authentication (mTLS)

  (client proves its identity to server; server proves its identity to client)

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Authentication with certificates

- To authenticate, someone (client or server) needs:

  - a *private key* (that remains known only to them)

  - a *public key* (that they can distribute)

  - a *certificate* (associating the public key with an identity)

- A message encrypted with the private key can only be decrypted with the public key

  (and vice versa)

- If I use someone's public key to encrypt / decrypt their messages,
  &lt;br/&gt;
  I can be certain that I am talking to them / they are talking to me

- The certificate proves that I have the correct public key for them

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Certificate generation workflow

This is what I do if I want to obtain a certificate.

1. Create public and private key.

2. Create a Certificate Signing Request (CSR).

   (The CSR contains the identity that I claim and an expiration date.)

3. Send that CSR to the Certificate Authority (CA).

4. The CA verifies that I can claim the identity in the CSR.

5. The CA generates my certificate and gives it to me.

The CA (or anyone else) never needs to know my private key.

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## The CSR API

- The Kubernetes API has a CertificateSigningRequest resource type

  (we can list them with e.g. `kubectl get csr`)

- We can create a CSR object

  (= upload a CSR to the Kubernetes API)

- Then, using the Kubernetes API, we can approve / deny the request

- If we approve the request, the Kubernetes API generates a certificate

- The certificate gets attached to the CSR object and can be retrieved

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Using the CSR API

- We will show how to use the CSR API to obtain user certificates

- This will be a rather complex demo

- ... And yet, we will take a few shortcuts to simplify it

  (but it will illustrate the general idea)

- The demo also won't be automated

  (we would have to write extra code to make it fully functional)

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## General idea

- We will create a Namespace named "users"

- Each user will get a ServiceAccount in that Namespace

- That ServiceAccount will give read/write access to *one* CSR object

- Users will use that ServiceAccount's token to submit a CSR

- We will approve the CSR (or not)

- Users can then retrieve their certificate from their CSR object

- ... And use that certificate for subsequent interactions

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Resource naming

For a user named `jean.doe`, we will have:

- ServiceAccount `jean.doe` in Namespace `users`

- CertificateSigningRequest `users:jean.doe`

- ClusterRole `users:jean.doe` giving read/write access to that CSR

- ClusterRoleBinding `users:jean.doe` binding ClusterRole and ServiceAccount

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Creating the user's resources

.warning[If you want to use another name than `jean.doe`, update the YAML file!]

.exercise[

- Create the global namespace for all users:
  ```bash
  kubectl create namespace users
  ```

- Create the ServiceAccount, ClusterRole, ClusterRoleBinding for `jean.doe`:
  ```bash
  kubectl apply -f ~/container.training/k8s/users:jean.doe.yaml
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Extracting the user's token

- Let's obtain the user's token and give it to them

  (the token will be their password)

.exercise[

- List the user's secrets:
  ```bash
  kubectl --namespace=users describe serviceaccount jean.doe
  ```

- Show the user's token:
  ```bash
  kubectl --namespace=users describe secret `jean.doe-token-xxxxx`
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Configure `kubectl` to use the token

- Let's create a new context that will use that token to access the API

.exercise[

- Add a new identity to our kubeconfig file:
  ```bash
  kubectl config set-credentials token:jean.doe --token=...
  ```

- Add a new context using that identity:
  ```bash
  kubectl config set-context jean.doe --user=token:jean.doe --cluster=kubernetes
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Access the API with the token

- Let's check that our access rights are set properly

.exercise[

- Try to access any resource:
  ```bash
  kubectl get pods
  ```
  (This should tell us "Forbidden")

- Try to access "our" CertificateSigningRequest:
  ```bash
  kubectl get csr users:jean.doe
  ```
  (This should tell us "NotFound")

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Create a key and a CSR

- There are many tools to generate TLS keys and CSRs

- Let's use OpenSSL; it's not the best one, but it's installed everywhere

  (many people prefer cfssl, easyrsa, or other tools; that's fine too!)
 
.exercise[

- Generate the key and certificate signing request:
  ```bash
    openssl req -newkey rsa:2048 -nodes -keyout key.pem \
                -new -subj /CN=jean.doe/O=devs/ -out csr.pem
  ```

]

The command above generates:

- a 2048-bit RSA key, without DES encryption, stored in key.pem
- a CSR for the name `jean.doe` in group `devs`

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Inside the Kubernetes CSR object

- The Kubernetes CSR object is a thin wrapper around the CSR PEM file

- The PEM file needs to be encoded to base64 on a single line

  (we will use `base64 -w0` for that purpose)

- The Kubernetes CSR object also needs to list the right "usages"

  (these are flags indicating how the certificate can be used)

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Sending the CSR to Kubernetes

.exercise[

- Generate and create the CSR resource:
  ```bash
    kubectl apply -f - &lt;&lt;EOF
    apiVersion: certificates.k8s.io/v1beta1
    kind: CertificateSigningRequest
    metadata:
      name: users:jean.doe
    spec:
      request: $(base64 -w0 &lt; csr.pem)
      usages:
      - digital signature
      - key encipherment
      - client auth
    EOF
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Adjusting certificate expiration

- By default, the CSR API generates certificates valid 1 year

- We want to generate short-lived certificates, so we will lower that to 1 hour

- Fow now, this is configured [through an experimental controller manager flag](https://github.com/kubernetes/kubernetes/issues/67324)

.exercise[

- Edit the static pod definition for the controller manager:
  ```bash
  sudo vim /etc/kubernetes/manifests/kube-controller-manager.yaml
  ```

- In the list of flags, add the following line:
  ```bash
  - --experimental-cluster-signing-duration=1h
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Verifying and approving the CSR

- Let's inspect the CSR, and if it is valid, approve it

.exercise[

- Switch back to `cluster-admin`:
  ```bash
  kctx -
  ```

- Inspect the CSR:
  ```bash
  kubectl describe csr users:jean.doe
  ```

- Approve it:
  ```bash
  kubectl certificate approve users:jean.doe
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Obtaining the certificate

.exercise[

- Switch back to the user's identity:
  ```bash
  kctx -
  ```

- Retrieve the certificate from the CSR:
  ```bash
  kubectl get csr users:jean.doe \
          -o jsonpath={.status.certificate} \
          | base64 -d &gt; cert.pem
  ```

- Inspect the certificate:
  ```bash
  openssl x509 -in cert.pem -text -noout
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Using the certificate

.exercise[

- Add the key and certificate to kubeconfig:
  ```bash
  kubectl config set-credentials cert:jean.doe --embed-certs \
          --client-certificate=cert.pem --client-key=key.pem
  ```

- Update the user's context to use the key and cert to authenticate:
  ```bash
  kubectl config set-context jean.doe --user cert:jean.doe
  ```

- Confirm that we are seen as `jean.doe` (but don't have permissions):
  ```bash
  kubectl get pods
  ```

]

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## What's missing?

We shown, step by step, a method to issue short-lived certificates for users.

To be usable in real environments, we would need to add:

- a kubectl helper to automatically generate the CSR and obtain the cert

  (and transparently renew the cert when needed)

- a Kubernetes controller to automatically validate and approve CSRs

  (checking that the subject and groups are valid)

- a way for the users to know the groups to add to their CSR

  (e.g.: annotations on their ServiceAccount + read access to the ServiceAccount)

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

## Is this realistic?

- Larger organizations typically integrate with their own directory

- The general principle, however, is the same:

  - users have long-term credentials (password, token, ...)

  - they use these credentials to obtain other, short-lived credentials

- This provides enhanced security:

  - the long-term credentials can use long passphrases, 2FA, HSM ...

  - the short-term credentials are more convenient to use

  - we get strong security *and* convenience

- Systems like Vault also have certificate issuance mechanisms

.debug[[k8s/csr-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/plastic-containers.JPG)]

---

name: toc-openid-connect
class: title

OpenID Connect

.nav[
[Previous section](#toc-the-csr-api)
|
[Back to table of contents](#toc-chapter-13)
|
[Next section](#toc-securing-the-control-plane)
]

.debug[(automatically generated title slide)]

---
# OpenID Connect

- The Kubernetes API server can perform authentication with OpenID connect

- This requires an *OpenID provider*

  (external authorization server using the OAuth 2.0 protocol)

- We can use a third-party provider (e.g. Google) or run our own (e.g. Dex)

- We are going to give an overview of the protocol

- We will show it in action (in a simplified scenario)

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Workflow overview

- We want to access our resources (a Kubernetes cluster)

- We authenticate with the OpenID provider

  - we can do this directly (e.g. by going to https://accounts.google.com)

  - or maybe a kubectl plugin can open a browser page on our behalf

- After authenticating us, the OpenID provider gives us:

  - an *id token* (a short-lived signed JSON Web Token, see next slide)

  - a *refresh token* (to renew the previous one when needed)

- We can now issue requests to the Kubernetes API with the *id token*

- The API server will verify that token's content to authenticate us

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## JSON Web Tokens

- A JSON Web Token (JWT) has three parts:

  - a header specifying algorithms and token type

  - a payload (indicating who issued the token, for whom, which purposes...)

  - a signature generated by the issuer (the issuer = the OpenID provider)

- Anyone can verify a JWT without contacting the issuer

  (except to obtain the issuer's public key)

- Pro tip: we can inspect a JWT with https://jwt.io/

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## How the Kubernetes API uses JWT

- Server side

  - enable OIDC authentication

  - indicate which issuer (provider) should be allowed

  - indicate which audience (or "client id") should be allowed

  - if necessary, map or prefix user and group names

- Client side

  - obtain JWT as described earlier

  - pass JWT as authentication token

  - renew JWT when needed (using the refresh token)

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Demo time!

- We will use [Google Accounts](https://accounts.google.com) as our OpenID provider

- We will use the [Google OAuth Playground](https://developers.google.com/oauthplayground) as the "audience" or "client id"

- We will obtain a JWT through Google Accounts and the OAuth Playground

- We will enable OIDC in the Kubernetes API server

- We will use the JWT to authenticate

.footnote[If you can't or won't use a Google Account, you can try to adapt to another provider.]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Checking the API server logs

- The API server logs will be particularly useful in this section

  (they will indicate e.g. why a specific token is rejected)

- Let's keep an eye on the API server output!

.exercise[

- Tail the logs of the API server:
  ```bash
  kubectl logs kube-apiserver-node1 --follow --namespace=kube-system
  ```

]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Authenticate with the OpenID provider

- We will use the Google OAuth Playground for convenience

- In a real scenario, we would need our own OAuth client instead of the playground

  (even if we were still using Google as the OpenID provider)

.exercise[

- Open the Google OAuth Playground:
  ```
  https://developers.google.com/oauthplayground/
  ```

- Enter our own custom scope in the text field:
  ```
  https://www.googleapis.com/auth/userinfo.email
  ```

- Click on "Authorize APIs" and allow the playground to access our email address

]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Obtain our JSON Web Token

- The previous step gave us an "authorization code"

- We will use it to obtain tokens

.exercise[

- Click on "Exchange authorization code for tokens"

]

- The JWT is the very long `id_token` that shows up on the right hand side

  (it is a base64-encoded JSON object, and should therefore start with `eyJ`)

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Using our JSON Web Token

- We need to create a context (in kubeconfig) for our token

  (if we just add the token or use `kubectl --token`, our certificate will still be used)

.exercise[

- Create a new authentication section in kubeconfig:
  ```bash
  kubectl config set-credentials myjwt --token=eyJ...
  ```

- Try to use it:
  ```bash
  kubectl --user=myjwt get nodes
  ```

]

We should get an `Unauthorized` response, since we haven't enabled OpenID Connect in the API server yet. We should also see `invalid bearer token` in the API server log output.

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Enabling OpenID Connect

- We need to add a few flags to the API server configuration

- These two are mandatory:

  `--oidc-issuer-url` → URL of the OpenID provider

  `--oidc-client-id` → app requesting the authentication
  &lt;br/&gt;(in our case, that's the ID for the Google OAuth Playground)

- This one is optional:

  `--oidc-username-claim` → which field should be used as user name
  &lt;br/&gt;(we will use the user's email address instead of an opaque ID)

- See the [API server documentation](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#configuring-the-api-server
) for more details about all available flags

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Updating the API server configuration

- The instructions below will work for clusters deployed with kubeadm

  (or where the control plane is deployed in static pods)

- If your cluster is different, you will need to adapt them

.exercise[

- Edit `/etc/kubernetes/manifests/kube-apiserver.yaml`

- Add the following lines to the list of command-line flags:
  ```yaml
  - --oidc-issuer-url=https://accounts.google.com
  - --oidc-client-id=407408718192.apps.googleusercontent.com
  - --oidc-username-claim=email
  ```
]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Restarting the API server

- The kubelet monitors the files in `/etc/kubernetes/manifests`

- When we save the pod manifest, kubelet will restart the corresponding pod

  (using the updated command line flags)

.exercise[

- After making the changes described on the previous slide, save the file

- Issue a simple command (like `kubectl version`) until the API server is back up

  (it might take between a few seconds and one minute for the API server to restart)

- Restart the `kubectl logs` command to view the logs of the API server

]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Using our JSON Web Token

- Now that the API server is set up to recognize our token, try again!

.exercise[

- Try an API command with our token:
  ```bash
  kubectl --user=myjwt get nodes
  kubectl --user=myjwt get pods
  ```

]

We should see a message like:
```
Error from server (Forbidden): nodes is forbidden: User "jean.doe@gmail.com"
cannot list resource "nodes" in API group "" at the cluster scope
```

→ We were successfully *authenticated*, but not *authorized*.

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## Authorizing our user

- As an extra step, let's grant read access to our user

- We will use the pre-defined ClusterRole `view`

.exercise[

- Create a ClusterRoleBinding allowing us read access to the cluster:
  ```bash
    kubectl create clusterrolebinding i-can-view \
            --user=`jean.doe@gmail.com` --clusterrole=view
  ```

- Confirm that we can now list pods with our token:
   ```bash
  kubectl --user=myjwt get pods
  ```

]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

## From demo to production

.warning[This was a very simplified demo! In a real deployment...]

- We wouldn't use the Google OAuth Playground

- We *probably* wouldn't even use Google at all

  (it doesn't seem to provide a way to include groups!)

- Some popular alternatives:

  - [Dex](https://github.com/dexidp/dex),
    [Keycloak](https://www.keycloak.org/)
    (self-hosted)

  - [Okta](https://developer.okta.com/docs/how-to/creating-token-with-groups-claim/#step-five-decode-the-jwt-to-verify)
    (SaaS)

- We would use a helper (like the [kubelogin](https://github.com/int128/kubelogin) plugin) to automatically obtain tokens

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

class: extra-details

## Service Account tokens

- The tokens used by Service Accounts are JWT tokens as well

- They are signed and verified using a special service account key pair

.exercise[

- Extract the token of a service account in the current namespace:
  ```bash
  kubectl get secrets -o jsonpath={..token} | base64 -d
  ```

- Copy-paste the token to a verification service like https://jwt.io 

- Notice that it says "Invalid Signature"

]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

class: extra-details

## Verifying Service Account tokens

- JSON Web Tokens embed the URL of the "issuer" (=OpenID provider)

- The issuer provides its public key through a well-known discovery endpoint

  (similar to https://accounts.google.com/.well-known/openid-configuration)

- There is no such endpoint for the Service Account key pair

- But we can provide the public key ourselves for verification

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

class: extra-details

## Verifying a Service Account token

- On clusters provisioned with kubeadm, the Service Account key pair is:

  `/etc/kubernetes/pki/sa.key` (used by the controller manager to generate tokens)

  `/etc/kubernetes/pki/sa.pub` (used by the API server to validate the same tokens)

.exercise[

- Display the public key used to sign Service Account tokens:
  ```bash
  sudo cat /etc/kubernetes/pki/sa.pub
  ```

- Copy-paste the key in the "verify signature" area on https://jwt.io

- It should now say "Signature Verified"

]

.debug[[k8s/openid-connect.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-1.jpg)]

---

name: toc-securing-the-control-plane
class: title

Securing the control plane

.nav[
[Previous section](#toc-openid-connect)
|
[Back to table of contents](#toc-chapter-14)
|
[Next section](#toc-tls-bootstrap-extra-material)
]

.debug[(automatically generated title slide)]

---
# Securing the control plane

- Many components accept connections (and requests) from others:

  - API server

  - etcd

  - kubelet

- We must secure these connections:

  - to deny unauthorized requests

  - to prevent eavesdropping secrets, tokens, and other sensitive information

- Disabling authentication and/or authorization is **strongly discouraged**

  (but it's possible to do it, e.g. for learning / troubleshooting purposes)

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Authentication and authorization

- Authentication (checking "who you are") is done with mutual TLS

 (both the client and the server need to hold a valid certificate)

- Authorization (checking "what you can do") is done in different ways

  - the API server implements a sophisticated permission logic (with RBAC)
  
  - some services will defer authorization to the API server (through webhooks)

  - some services require a certificate signed by a particular CA / sub-CA

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## In practice

- We will review the various communication channels in the control plane

- We will describe how they are secured

- When TLS certificates are used, we will indicate:

  - which CA signs them

  - what their subject (CN) should be, when applicable

- We will indicate how to configure security (client- and server-side)

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## etcd peers

- Replication and coordination of etcd happens on a dedicated port

  (typically port 2380; the default port for normal client connections is 2379)

- Authentication uses TLS certificates with a separate sub-CA

  (otherwise, anyone with a Kubernetes client certificate could access etcd!)

- The etcd command line flags involved are:

   `--peer-client-cert-auth=true` to activate it

   `--peer-cert-file`, `--peer-key-file`, `--peer-trusted-ca-file`

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## etcd clients

- The only¹ thing that connects to etcd is the API server

- Authentication uses TLS certificates with a separate sub-CA

  (for the same reasons as for etcd inter-peer authentication)

- The etcd command line flags involved are:

  `--client-cert-auth=true` to activate it

  `--trusted-ca-file`, `--cert-file`, `--key-file`

- The API server command line flags involved are:

  `--etcd-cafile`, `--etcd-certfile`, `--etcd-keyfile`

.footnote[¹Technically, there is also the etcd healthcheck. Let's ignore it for now.]

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## API server clients

- The API server has a sophisticated authentication and authorization system

- For connections coming from other components of the control plane:

  - authentication uses certificates (trusting the certificates' subject or CN)

  - authorization uses whatever mechanism is enabled (most oftentimes, RBAC)

- The relevant API server flags are:

  `--client-ca-file`, `--tls-cert-file`, `--tls-private-key-file`

- Each component connecting to the API server takes a `--kubeconfig` flag

  (to specify a kubeconfig file containing the CA cert, client key, and client cert)

- Yes, that kubeconfig file follows the same format as our `~/.kube/config` file!

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Kubelet and API server

- Communication between kubelet and API server can be established both ways

- Kubelet → API server:

  - kubelet registers itself ("hi, I'm node42, do you have work for me?")

  - connection is kept open and re-established if it breaks

  - that's how the kubelet knows which pods to start/stop

- API server → kubelet:

  - used to retrieve logs, exec, attach to containers

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Kubelet → API server

- Kubelet is started with `--kubeconfig` with API server information

- The client certificate of the kubelet will typically have:

  `CN=system:node:&lt;nodename&gt;` and groups `O=system:nodes`

- Nothing special on the API server side

  (it will authenticate like any other client)

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## API server → kubelet

- Kubelet is started with the flag `--client-ca-file`

  (typically using the same CA as the API server)

- API server will use a dedicated key pair when contacting kubelet

  (specified with `--kubelet-client-certificate` and `--kubelet-client-key`)

- Authorization uses webhooks

  (enabled with `--authorization-mode=Webhook` on kubelet)

- The webhook server is the API server itself

  (the kubelet sends back a request to the API server to ask, "can this person do that?")

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Scheduler

- The scheduler connects to the API server like an ordinary client

- The certificate of the scheduler will have `CN=system:kube-scheduler`

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Controller manager

- The controller manager is also a normal client to the API server

- Its certificate will have `CN=system:kube-controller-manager`

- If we use the CSR API, the controller manager needs the CA cert and key

  (passed with flags `--cluster-signing-cert-file` and `--cluster-signing-key-file`)

- We usually want the controller manager to generate tokens for service accounts

- These tokens deserve some details (on the next slide!)

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Service account tokens

- Each time we create a service account, the controller manager generates a token

- These tokens are JWT tokens, signed with a particular key

- These tokens are used for authentication with the API server

  (and therefore, the API server needs to be able to verify their integrity)

- This uses another keypair:

  - the private key (used for signature) is passed to the controller manager
    &lt;br/&gt;(using flags `--service-account-private-key-file` and `--root-ca-file`)

  - the public key (used for verification) is passed to the API server
    &lt;br/&gt;(using flag `--service-account-key-file`)

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## kube-proxy

- kube-proxy is "yet another API server client"

- In many clusters, it runs as a Daemon Set

- In that case, it will have its own Service Account and associated permissions

- It will authenticate using the token of that Service Account

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Webhooks

- We mentioned webhooks earlier; how does that really work?

- The Kubernetes API has special resource types to check permissions

- One of them is SubjectAccessReview

- To check if a particular user can do a particular action on a particular resource:

  - we prepare a SubjectAccessReview object

  - we send that object to the API server

  - the API server responds with allow/deny (and optional explanations)

- Using webhooks for authorization = sending SAR to authorize each request

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

## Subject Access Review

Here is an example showing how to check if `jean.doe` can `get` some `pods` in `kube-system`:

```bash
kubectl -v9 create -f- &lt;&lt;EOF
apiVersion: authorization.k8s.io/v1beta1
kind: SubjectAccessReview
spec:
  user: jean.doe
  group:
  - foo
  - bar
  resourceAttributes:
    #group: blah.k8s.io
    namespace: kube-system
    resource: pods
    verb: get
    #name: web-xyz1234567-pqr89
EOF
```

.debug[[k8s/control-plane-auth.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/train-of-containers-2.jpg)]

---

name: toc-tls-bootstrap-extra-material
class: title

TLS bootstrap (extra material)

.nav[
[Previous section](#toc-securing-the-control-plane)
|
[Back to table of contents](#toc-chapter-14)
|
[Next section](#toc-network-policies)
]

.debug[(automatically generated title slide)]

---
# TLS bootstrap (extra material)

- kubelet needs TLS keys and certificates to communicate with the control plane

- How do we generate this information?

- How do we make it available to kubelet?

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Option 1: push

- When we want to provision a node:

  - generate its keys, certificate, and sign centrally

  - push the files to the node

- OK for "traditional", on-premises deployments

- Not OK for cloud deployments with auto-scaling

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Option 2: poll + push

- Discover nodes when they are created

  (e.g. with cloud API)

- When we detect a new node, push TLS material to the node

  (like in option 1)

- It works, but:

  - discovery code is specific to each provider

  - relies heavily on the cloud provider API

  - doesn't work on-premises

  - doesn't scale

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Option 3: bootstrap tokens + CSR API

- Since Kubernetes 1.4, the Kubernetes API supports CSR

  (Certificate Signing Requests)

- This is similar to the protocol used to obtain e.g. HTTPS certificates:

  - subject (here, kubelet) generates TLS keys and CSR

  - subject submits CSR to CA

  - CA validates (or not) the CSR

  - CA sends back signed certificate to subject

- This is combined with *bootstrap tokens*

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Bootstrap tokens

- A [bootstrap token](https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/) is an API access token

  - it is a Secret with type `bootstrap.kubernetes.io/token`

  - it is 6 public characters (ID) + 16 secret characters
    &lt;br/&gt;(example: `whd3pq.d1ushuf6ccisjacu`)

  - it gives access to groups `system:bootstrap:&lt;ID&gt;` and `system:bootstrappers`
   
   - additional groups can be specified in the Secret

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Bootstrap tokens with kubeadm

- kubeadm automatically creates a bootstrap token

  (it is shown at the end of `kubeadm init`)

- That token adds the group `system:bootstrappers:kubeadm:default-node-token`

- kubeadm also creates a ClusterRoleBinding `kubeadm:kubelet-bootstrap`
  &lt;br/&gt;binding `...:default-node-token` to ClusterRole `system:node-bootstrapper`

- That ClusterRole gives create/get/list/watch permissions on the CSR API

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Bootstrap tokens in practice

- Let's list our bootstrap tokens on a cluster created with kubeadm

.exercise[

- Log into node `test1`

- View bootstrap tokens:
  ```bash
  sudo kubeadm token list
  ```

]

- Tokens are short-lived

- We can create new tokens with `kubeadm` if necessary

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

class: extra-details

## Retrieving bootstrap tokens with kubectl

- Bootstrap tokens are Secrets with type `bootstrap.kubernetes.io/token`

- Token ID and secret are in data fields `token-id` and `token-secret`

- In Secrets, data fields are encoded with Base64

- This "very simple" command will show us the tokens:

```
kubectl -n kube-system get secrets -o json | 
        jq -r '.items[] 
        | select(.type=="bootstrap.kubernetes.io/token")
        | ( .data["token-id"] + "Lg==" + .data["token-secret"] + "Cg==")
        ' | base64 -d
```

(On recent versions of `jq`, you can simplify by using filter `@base64d`.)

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

class: extra-details

## Using a bootstrap token

- The token we need to use has the form `abcdef.1234567890abcdef`

.exercise[

- Check that it is accepted by the API server:
  ```bash
  curl -k -H "Authorization: Bearer abcdef.1234567890abcdef"
  ```

- We should see that we are *authenticated* but not *authorized*:
  ```
  User \"system:bootstrap:abcdef\" cannot get path \"/\""
  ```

- Check that we can access the CSR API:
  ```bash
  curl -k -H "Authorization: Bearer abcdef.1234567890abcdef" \
       https://10.96.0.1/apis/certificates.k8s.io/v1beta1/certificatesigningrequests
  ```

]

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## The cluster-info ConfigMap

- Before we can talk to the API, we need:

  - the API server address (obviously!)

  - the cluster CA certificate

- That information is stored in a public ConfigMap

.exercise[

- Retrieve that ConfigMap:
  ```bash
  curl -k https://10.96.0.1/api/v1/namespaces/kube-public/configmaps/cluster-info
  ```

]

*Extracting the kubeconfig file is left as an exercise for the reader.*

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

class: extra-details

## Signature of the config-map

- You might have noticed a few `jws-kubeconfig-...` fields

- These are config-map signatures

  (so that the client can protect against MITM attacks)

- These are JWS signatures using HMAC-SHA256

  (see [here](https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#configmap-signing) for more details)

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Putting it all together

This is the TLS bootstrap mechanism, step by step.

- The node uses the cluster-info ConfigMap to get the cluster CA certificate

- The node generates its keys and CSR

- Using the bootstrap token, the node creates a CertificateSigningRequest object

- The node watches the CSR object

- The CSR object is accepted (automatically or by an admin)

- The node gets notified, and retrieves the certificate

- The node can now join the cluster

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## Bottom line

- If you paid attention, we still need a way to:

  - either safely get the bootstrap token to the nodes

  - or disable auto-approval and manually approve the nodes when they join

- The goal of the TLS bootstrap mechanism is *not* to solve this

  (in terms of information knowledge, it's fundamentally impossible!)

- But it reduces the differences between environments, infrastructures, providers ...

- It gives a mechanism that is easier to use, and flexible enough, for most scenarios

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

## More information

- As always, the Kubernetes documentation has extra details:

  - [TLS management](https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/)

  - [Authenticating with bootstrap tokens](https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/)

  - [TLS bootstrapping](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)

  - [kubeadm token](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-token/) command

  - [kubeadm join](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/) command (has details about [the join workflow](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/#join-workflow))

.debug[[k8s/bootstrap.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/two-containers-on-a-truck.jpg)]

---

name: toc-network-policies
class: title

Network policies

.nav[
[Previous section](#toc-tls-bootstrap-extra-material)
|
[Back to table of contents](#toc-chapter-14)
|
[Next section](#toc-pod-security-policies)
]

.debug[(automatically generated title slide)]

---
# Network policies

- Namespaces help us to *organize* resources

- Namespaces do not provide isolation

- By default, every pod can contact every other pod

- By default, every service accepts traffic from anyone

- If we want this to be different, we need *network policies*

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## What's a network policy?

A network policy is defined by the following things.

- A *pod selector* indicating which pods it applies to

  e.g.: "all pods in namespace `blue` with the label `zone=internal`"

- A list of *ingress rules* indicating which inbound traffic is allowed

  e.g.: "TCP connections to ports 8000 and 8080 coming from pods with label `zone=dmz`,
  and from the external subnet 4.42.6.0/24, except 4.42.6.5"

- A list of *egress rules* indicating which outbound traffic is allowed

A network policy can provide ingress rules, egress rules, or both.

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## How do network policies apply?

- A pod can be "selected" by any number of network policies

- If a pod isn't selected by any network policy, then its traffic is unrestricted

  (In other words: in the absence of network policies, all traffic is allowed)

- If a pod is selected by at least one network policy, then all traffic is blocked ...

  ... unless it is explicitly allowed by one of these network policies

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

class: extra-details

## Traffic filtering is flow-oriented

- Network policies deal with *connections*, not individual packets

- Example: to allow HTTP (80/tcp) connections to pod A, you only need an ingress rule

  (You do not need a matching egress rule to allow response traffic to go through)

- This also applies for UDP traffic

  (Allowing DNS traffic can be done with a single rule)

- Network policy implementations use stateful connection tracking

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Pod-to-pod traffic

- Connections from pod A to pod B have to be allowed by both pods:

  - pod A has to be unrestricted, or allow the connection as an *egress* rule

  - pod B has to be unrestricted, or allow the connection as an *ingress* rule

- As a consequence: if a network policy restricts traffic going from/to a pod,
  &lt;br/&gt;
  the restriction cannot be overridden by a network policy selecting another pod

- This prevents an entity managing network policies in namespace A
  (but without permission to do so in namespace B)
  from adding network policies giving them access to namespace B

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## The rationale for network policies

- In network security, it is generally considered better to "deny all, then allow selectively"

  (The other approach, "allow all, then block selectively" makes it too easy to leave holes)

- As soon as one network policy selects a pod, the pod enters this "deny all" logic

- Further network policies can open additional access

- Good network policies should be scoped as precisely as possible

- In particular: make sure that the selector is not too broad

  (Otherwise, you end up affecting pods that were otherwise well secured)

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Our first network policy

This is our game plan:

- run a web server in a pod

- create a network policy to block all access to the web server

- create another network policy to allow access only from specific pods

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Running our test web server

.exercise[

- Let's use the `nginx` image:
  ```bash
  kubectl create deployment testweb --image=nginx
  ```

- Find out the IP address of the pod with one of these two commands:
  ```bash
  kubectl get pods -o wide -l app=testweb
  IP=$(kubectl get pods -l app=testweb -o json | jq -r .items[0].status.podIP)
  ```

- Check that we can connect to the server:
  ```bash
  curl $IP
  ```
]

The `curl` command should show us the "Welcome to nginx!" page.

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Adding a very restrictive network policy

- The policy will select pods with the label `app=testweb`

- It will specify an empty list of ingress rules (matching nothing)

.exercise[

- Apply the policy in this YAML file:
  ```bash
    kubectl apply -f ~/container.training/k8s/netpol-deny-all-for-testweb.yaml
  ```

- Check if we can still access the server:
  ```bash
  curl $IP
  ```

]

The `curl` command should now time out.

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Looking at the network policy

This is the file that we applied:

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: deny-all-for-testweb
spec:
  podSelector:
    matchLabels:
      app: testweb
  ingress: []
```

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Allowing connections only from specific pods

- We want to allow traffic from pods with the label `run=testcurl`

- Reminder: this label is automatically applied when we do `kubectl run testcurl ...`

.exercise[

- Apply another policy:
  ```bash
  kubectl apply -f ~/container.training/k8s/netpol-allow-testcurl-for-testweb.yaml
  ```

]

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Looking at the network policy

This is the second file that we applied:

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-testcurl-for-testweb
spec:
  podSelector:
    matchLabels:
      app: testweb
  ingress:
  - from:
    - podSelector:
        matchLabels:
          run: testcurl
```

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Testing the network policy

- Let's create pods with, and without, the required label

.exercise[

- Try to connect to testweb from a pod with the `run=testcurl` label:
  ```bash
  kubectl run testcurl --rm -i --image=centos -- curl -m3 $IP
  ```

- Try to connect to testweb with a different label:
  ```bash
  kubectl run testkurl --rm -i --image=centos -- curl -m3 $IP
  ```

]

The first command will work (and show the "Welcome to nginx!" page).

The second command will fail and time out after 3 seconds.

(The timeout is obtained with the `-m3` option.)

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## An important warning

- Some network plugins only have partial support for network policies

- For instance, Weave added support for egress rules [in version 2.4](https://github.com/weaveworks/weave/pull/3313) (released in July 2018)

- But only recently added support for ipBlock [in version 2.5](https://github.com/weaveworks/weave/pull/3367) (released in Nov 2018)

- Unsupported features might be silently ignored

  (Making you believe that you are secure, when you're not)

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Network policies, pods, and services

- Network policies apply to *pods*

- A *service* can select multiple pods

  (And load balance traffic across them)

- It is possible that we can connect to some pods, but not some others

  (Because of how network policies have been defined for these pods)

- In that case, connections to the service will randomly pass or fail

  (Depending on whether the connection was sent to a pod that we have access to or not)

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Network policies and namespaces

- A good strategy is to isolate a namespace, so that:

  - all the pods in the namespace can communicate together

  - other namespaces cannot access the pods

  - external access has to be enabled explicitly

- Let's see what this would look like for the DockerCoins app!

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Network policies for DockerCoins

- We are going to apply two policies

- The first policy will prevent traffic from other namespaces

- The second policy will allow traffic to the `webui` pods

- That's all we need for that app!

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Blocking traffic from other namespaces

This policy selects all pods in the current namespace.

It allows traffic only from pods in the current namespace.

(An empty `podSelector` means "all pods".)

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: deny-from-other-namespaces
spec:
  podSelector: {}
  ingress:
  - from:
    - podSelector: {}
```

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Allowing traffic to `webui` pods

This policy selects all pods with label `app=webui`.

It allows traffic from any source.

(An empty `from` fields means "all sources".)

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-webui
spec:
  podSelector:
    matchLabels:
      app: webui
  ingress:
  - from: []
```

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Applying both network policies

- Both network policies are declared in the file `k8s/netpol-dockercoins.yaml`

.exercise[

- Apply the network policies:
  ```bash
  kubectl apply -f ~/container.training/k8s/netpol-dockercoins.yaml
  ```

- Check that we can still access the web UI from outside
  &lt;br/&gt;
  (and that the app is still working correctly!)

- Check that we can't connect anymore to `rng` or `hasher` through their ClusterIP

]

Note: using `kubectl proxy` or `kubectl port-forward` allows us to connect
regardless of existing network policies. This allows us to debug and
troubleshoot easily, without having to poke holes in our firewall.

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Cleaning up our network policies

- The network policies that we have installed block all traffic to the default namespace

- We should remove them, otherwise further exercises will fail!

.exercise[

- Remove all network policies:
  ```bash
  kubectl delete networkpolicies --all
  ```

]

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Protecting the control plane

- Should we add network policies to block unauthorized access to the control plane?

  (etcd, API server, etc.)

--

- At first, it seems like a good idea ...

--

- But it *shouldn't* be necessary:

  - not all network plugins support network policies

  - the control plane is secured by other methods (mutual TLS, mostly)

  - the code running in our pods can reasonably expect to contact the API
    &lt;br/&gt;
    (and it can do so safely thanks to the API permission model)

- If we block access to the control plane, we might disrupt legitimate code

- ... Without necessarily improving security

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

## Further resources

- As always, the [Kubernetes documentation](https://kubernetes.io/docs/concepts/services-networking/network-policies/) is a good starting point

- The API documentation has a lot of detail about the format of various objects:

  - [NetworkPolicy](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#networkpolicy-v1-networking-k8s-io)

  - [NetworkPolicySpec](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#networkpolicyspec-v1-networking-k8s-io)

  - [NetworkPolicyIngressRule](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#networkpolicyingressrule-v1-networking-k8s-io)

  - etc.

- And two resources by [Ahmet Alp Balkan](https://ahmet.im/):

  - a [very good talk about network policies](https://www.youtube.com/watch?list=PLj6h78yzYM2P-3-xqvmWaZbbI1sW-ulZb&amp;v=3gGpMmYeEO8) at KubeCon North America 2017

  - a repository of [ready-to-use recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes) for network policies

.debug[[k8s/netpol.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/wall-of-containers.jpeg)]

---

name: toc-pod-security-policies
class: title

Pod Security Policies

.nav[
[Previous section](#toc-network-policies)
|
[Back to table of contents](#toc-chapter-14)
|
[Next section](#toc-extending-the-kubernetes-api)
]

.debug[(automatically generated title slide)]

---
# Pod Security Policies

- By default, our pods and containers can do *everything*

  (including taking over the entire cluster)

- We are going to show an example of a malicious pod

- Then we will explain how to avoid this with PodSecurityPolicies

- We will illustrate this by creating a non-privileged user limited to a namespace

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Setting up a namespace

- Let's create a new namespace called "green"

.exercise[

- Create the "green" namespace:
  ```bash
  kubectl create namespace green
  ```

- Change to that namespace:
  ```bash
  kns green
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Using limited credentials

- When a namespace is created, a `default` ServiceAccount is added

- By default, this ServiceAccount doesn't have any access rights

- We will use this ServiceAccount as our non-privileged user

- We will obtain this ServiceAccount's token and add it to a context

- Then we will give basic access rights to this ServiceAccount

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Obtaining the ServiceAccount's token

- The token is stored in a Secret

- The Secret is listed in the ServiceAccount

.exercise[

- Obtain the name of the Secret from the ServiceAccount::
  ```bash
  SECRET=$(kubectl get sa default -o jsonpath={.secrets[0].name})
  ```

- Extract the token from the Secret object:
  ```bash
  TOKEN=$(kubectl get secrets $SECRET -o jsonpath={.data.token}
          | base64 -d)
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

class: extra-details

## Inspecting a Kubernetes token

- Kubernetes tokens are JSON Web Tokens

  (as defined by [RFC 7519](https://tools.ietf.org/html/rfc7519))

- We can view their content (and even verify them) easily

.exercise[

- Display the token that we obtained:
  ```bash
  echo $TOKEN
  ```

- Copy paste the token in the verification form on https://jwt.io

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Authenticating using the ServiceAccount token

- Let's create a new *context* accessing our cluster with that token

.exercise[

- First, add the token credentials to our kubeconfig file:
  ```bash
  kubectl config set-credentials green --token=$TOKEN
  ```

- Then, create a new context using these credentials:
  ```bash
  kubectl config set-context green --user=green --cluster=kubernetes
  ```

- Check the results:
  ```bash
  kubectl config get-contexts
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Using the new context

- Normally, this context doesn't let us access *anything* (yet)

.exercise[

- Change to the new context with one of these two commands:
  ```bash
  kctx green
  kubectl config use-context green
  ```

- Also change to the green namespace in that context:
  ```bash
  kns green
  ```

- Confirm that we don't have access to anything:
  ```bash
  kubectl get all
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Giving basic access rights

- Let's bind the ClusterRole `edit` to our ServiceAccount

- To allow access only to the namespace, we use a RoleBinding

  (instead of a ClusterRoleBinding, which would give global access)

.exercise[

- Switch back to `cluster-admin`:
  ```bash
  kctx -
  ```

- Create the Role Binding:
  ```bash
  kubectl create rolebinding green --clusterrole=edit --serviceaccount=green:default
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Verifying access rights

- Let's switch back to the `green` context and check that we have rights

.exercise[

- Switch back to `green`:
  ```bash
  kctx green
  ```

- Check our permissions:
  ```bash
  kubectl get all
  ```

]

We should see an empty list.

(Better than a series of permission errors!)

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Creating a basic Deployment

- Just to demonstrate that everything works correctly, deploy NGINX

.exercise[

- Create a Deployment using the official NGINX image:
  ```bash
  kubectl create deployment web --image=nginx
  ```

- Confirm that the Deployment, ReplicaSet, and Pod exist, and Pod is running:
  ```bash
  kubectl get all
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## One example of malicious pods

- We will now show an escalation technique in action

- We will deploy a DaemonSet that adds our SSH key to the root account

  (on *each* node of the cluster)

- The Pods of the DaemonSet will do so by mounting `/root` from the host

.exercise[

- Check the file `k8s/hacktheplanet.yaml` with a text editor:
  ```bash
  vim ~/container.training/k8s/hacktheplanet.yaml
  ```

- If you would like, change the SSH key (by changing the GitHub user name)

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Deploying the malicious pods

- Let's deploy our "exploit"!

.exercise[

- Create the DaemonSet:
  ```bash
  kubectl create -f ~/container.training/k8s/hacktheplanet.yaml
  ```

- Check that the pods are running:
  ```bash
  kubectl get pods
  ```

- Confirm that the SSH key was added to the node's root account:
  ```bash
  sudo cat /root/.ssh/authorized_keys
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Cleaning up

- Before setting up our PodSecurityPolicies, clean up that namespace

.exercise[

- Remove the DaemonSet:
  ```bash
  kubectl delete daemonset hacktheplanet
  ```

- Remove the Deployment:
  ```bash
  kubectl delete deployment web
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Pod Security Policies in theory

- To use PSPs, we need to activate their specific *admission controller*

- That admission controller will intercept each pod creation attempt

- It will look at:

  - *who/what* is creating the pod

  - which PodSecurityPolicies they can use

  - which PodSecurityPolicies can be used by the Pod's ServiceAccount

- Then it will compare the Pod with each PodSecurityPolicy one by one

- If a PodSecurityPolicy accepts all the parameters of the Pod, it is created

- Otherwise, the Pod creation is denied and it won't even show up in `kubectl get pods`

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Pod Security Policies fine print

- With RBAC, using a PSP corresponds to the verb `use` on the PSP

  (that makes sense, right?)

- If no PSP is defined, no Pod can be created

  (even by cluster admins)

- Pods that are already running are *not* affected

- If we create a Pod directly, it can use a PSP to which *we* have access

- If the Pod is created by e.g. a ReplicaSet or DaemonSet, it's different:
 
  - the ReplicaSet / DaemonSet controllers don't have access to *our* policies

  - therefore, we need to give access to the PSP to the Pod's ServiceAccount

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Pod Security Policies in practice

- We are going to enable the PodSecurityPolicy admission controller

- At that point, we won't be able to create any more pods (!)

- Then we will create a couple of PodSecurityPolicies

- ... And associated ClusterRoles (giving `use` access to the policies)

- Then we will create RoleBindings to grant these roles to ServiceAccounts

- We will verify that we can't run our "exploit" anymore

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Enabling Pod Security Policies

- To enable Pod Security Policies, we need to enable their *admission plugin*

- This is done by adding a flag to the API server

- On clusters deployed with `kubeadm`, the control plane runs in static pods

- These pods are defined in YAML files located in `/etc/kubernetes/manifests`

- Kubelet watches this directory

- Each time a file is added/removed there, kubelet creates/deletes the corresponding pod

- Updating a file causes the pod to be deleted and recreated

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Updating the API server flags

- Let's edit the manifest for the API server pod

.exercise[

- Have a look at the static pods:
  ```bash
  ls -l /etc/kubernetes/manifest
  ```

- Edit the one corresponding to the API server:
  ```bash
  sudo vim /etc/kubernetes/manifests/kube-apiserver.yaml
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Adding the PSP admission plugin

- There should already be a line with `--enable-admission-plugins=...`

- Let's add `PodSecurityPolicy` on that line

.exercise[

- Locate the line with `--enable-admission-plugins=`

- Add `PodSecurityPolicy`

  (It should read `--enable-admission-plugins=NodeRestriction,PodSecurityPolicy`)

- Save, quit

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Waiting for the API server to restart

- The kubelet detects that the file was modified

- It kills the API server pod, and starts a new one

- During that time, the API server is unavailable

.exercise[

- Wait until the API server is available again

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Check that the admission plugin is active

- Normally, we can't create any Pod at this point

.exercise[

- Try to create a Pod directly:
  ```bash
  kubectl run testpsp1 --image=nginx --restart=Never
  ```

- Try to create a Deployment:
  ```bash
  kubectl run testpsp2 --image=nginx
  ```

- Look at existing resources:
  ```bash
  kubectl get all
  ```

]

We can get hints at what's happening by looking at the ReplicaSet and Events.

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Introducing our Pod Security Policies

- We will create two policies:

  - privileged (allows everything)

  - restricted (blocks some unsafe mechanisms)

- For each policy, we also need an associated ClusterRole granting *use*

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Creating our Pod Security Policies

- We have a couple of files, each defining a PSP and associated ClusterRole:

  - k8s/psp-privileged.yaml: policy `privileged`, role `psp:privileged`
  - k8s/psp-restricted.yaml: policy `restricted`, role `psp:restricted`

.exercise[

- Create both policies and their associated ClusterRoles:
  ```bash
  kubectl create -f ~/container.training/k8s/psp-restricted.yaml
  kubectl create -f ~/container.training/k8s/psp-privileged.yaml
  ```
]

- The privileged policy comes from [the Kubernetes documentation](https://kubernetes.io/docs/concepts/policy/pod-security-policy/#example-policies)

- The restricted policy is inspired by that same documentation page

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Binding the restricted policy

- Let's bind the role `psp:restricted` to ServiceAccount `green:default`

  (aka the default ServiceAccount in the green Namespace)

.exercise[

- Create the following RoleBinding:
  ```bash
    kubectl create rolebinding psp:restricted \
            --clusterrole=psp:restricted \
            --serviceaccount=green:default
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Trying it out

- Let's switch to the `green` context, and try to create resources

.exercise[

- Switch to the `green` context:
  ```bash
  kctx green
  ```

- Create a simple Deployment:
  ```bash
  kubectl create deployment web --image=nginx
  ```

- Look at the Pods that have been created:
  ```bash
  kubectl get all
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## Trying to hack the cluster

- Let's create the same DaemonSet we used earlier

.exercise[

- Create a hostile DaemonSet:
  ```bash
  kubectl create -f ~/container.training/k8s/hacktheplanet.yaml
  ```

- Look at the state of the namespace:
  ```bash
  kubectl get all
  ```

]

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

class: extra-details

## What's in our restricted policy?

- The restricted PSP is similar to the one provided in the docs, but:

  - it allows containers to run as root

  - it doesn't drop capabilities

- Many containers run as root by default, and would require additional tweaks

- Many containers use e.g. `chown`, which requires a specific capability

  (that's the case for the NGINX official image, for instance)

- We still block: hostPath, privileged containers, and much more!

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

class: extra-details

## The case of static pods

- If we list the pods in the `kube-system` namespace, `kube-apiserver` is missing

- However, the API server is obviously running

  (otherwise, `kubectl get pods --namespace=kube-system` wouldn't work)

- The API server Pod is created directly by kubelet

  (without going through the PSP admission plugin)

- Then, kubelet creates a "mirror pod" representing that Pod in etcd

- That "mirror pod" creation goes through the PSP admission plugin

- And it gets blocked!

- This can be fixed by binding `psp:privileged` to group `system:nodes`

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

## .warning[Before moving on...]

- Our cluster is currently broken

  (we can't create pods in namespaces kube-system, default, ...)

- We need to either:

  - disable the PSP admission plugin

  - allow use of PSP to relevant users and groups

- For instance, we could:

  - bind `psp:restricted` to the group `system:authenticated`

  - bind `psp:privileged` to the ServiceAccount `kube-system:default`

.debug[[k8s/podsecuritypolicy.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg)]

---

name: toc-extending-the-kubernetes-api
class: title

Extending the Kubernetes API

.nav[
[Previous section](#toc-pod-security-policies)
|
[Back to table of contents](#toc-chapter-15)
|
[Next section](#toc-operators)
]

.debug[(automatically generated title slide)]

---
# Extending the Kubernetes API

There are multiple ways to extend the Kubernetes API.

We are going to cover:

- Custom Resource Definitions (CRDs)

- Admission Webhooks

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Revisiting the API server

- The Kubernetes API server is a central point of the control plane

  (everything connects to it: controller manager, scheduler, kubelets)

- Almost everything in Kubernetes is materialized by a resource

- Resources have a type (or "kind")

  (similar to strongly typed languages)

- We can see existing types with `kubectl api-resources`

- We can list resources of a given type with `kubectl get &lt;type&gt;`

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Creating new types

- We can create new types with Custom Resource Definitions (CRDs)

- CRDs are created dynamically

  (without recompiling or restarting the API server)

- CRDs themselves are resources:

  - we can create a new type with `kubectl create` and some YAML

  - we can see all our custom types with `kubectl get crds`

- After we create a CRD, the new type works just like built-in types

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## What can we do with CRDs?

There are many possibilities!

- *Operators* encapsulate complex sets of resources

  (e.g.: a PostgreSQL replicated cluster; an etcd cluster...
  &lt;br/&gt;
  see [awesome operators](https://github.com/operator-framework/awesome-operators) and
  [OperatorHub](https://operatorhub.io/) to find more)

- Custom use-cases like [gitkube](https://gitkube.sh/)

  - creates a new custom type, `Remote`, exposing a git+ssh server

  - deploy by pushing YAML or Helm charts to that remote

- Replacing built-in types with CRDs

  (see [this lightning talk by Tim Hockin](https://www.youtube.com/watch?v=ji0FWzFwNhA&amp;index=2&amp;list=PLj6h78yzYM2PZf9eA7bhWnIh_mK1vyOfU))

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Little details

- By default, CRDs are not *validated*

  (we can put anything we want in the `spec`)

- When creating a CRD, we can pass an OpenAPI v3 schema (BETA!)

  (which will then be used to validate resources)

- Generally, when creating a CRD, we also want to run a *controller*

  (otherwise nothing will happen when we create resources of that type) 

- The controller will typically *watch* our custom resources

  (and take action when they are created/updated)

*
Examples:
[YAML to install the gitkube CRD](https://storage.googleapis.com/gitkube/gitkube-setup-stable.yaml),
[YAML to install a redis operator CRD](https://github.com/amaizfinance/redis-operator/blob/master/deploy/crds/k8s_v1alpha1_redis_crd.yaml)
*

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Service catalog

- *Service catalog* is another extension mechanism

- It's not extending the Kubernetes API strictly speaking

  (but it still provides new features!)

- It doesn't create new types; it uses:

  - ClusterServiceBroker
  - ClusterServiceClass
  - ClusterServicePlan
  - ServiceInstance
  - ServiceBinding 

- It uses the Open service broker API

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Admission controllers

- When a Pod is created, it is associated to a ServiceAccount

  (even if we did not specify one explicitly)

- That ServiceAccount was added on the fly by an *admission controller*

  (specifically, a *mutating admission controller*)

- Admission controllers sit on the API request path

  (see the cool diagram on next slide, courtesy of Banzai Cloud)

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

class: pic

![API request lifecycle](images/api-request-lifecycle.png)

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Admission controllers

- *Validating* admission controllers can accept/reject the API call

- *Mutating* admission controllers can modify the API request payload

- Both types can also trigger additional actions

  (e.g. automatically create a Namespace if it doesn't exist)

- There are a number of built-in admission controllers

  (see [documentation](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do) for a list)

- But we can also define our own!

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Admission Webhooks

- We can setup *admission webhooks* to extend the behavior of the API server

- The API server will submit incoming API requests to these webhooks

- These webhooks can be *validating* or *mutating*

- Webhooks can be setup dynamically (without restarting the API server)

- To setup a dynamic admission webhook, we create a special resource:

  a `ValidatingWebhookConfiguration` or a `MutatingWebhookConfiguration`

- These resources are created and managed like other resources

  (i.e. `kubectl create`, `kubectl get` ...)

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Webhook Configuration

- A ValidatingWebhookConfiguration or MutatingWebhookConfiguration contains:

  - the address of the webhook

  - the authentication information to use with the webhook

  - a list of rules

- The rules indicate for which objects and actions the webhook is triggered

  (to avoid e.g. triggering webhooks when setting up webhooks)

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## (Ab)using the API server

- If we need to store something "safely" (as in: in etcd), we can use CRDs

- This gives us primitives to read/write/list objects (and optionally validate them)

- The Kubernetes API server can run on its own

  (without the scheduler, controller manager, and kubelets)

- By loading CRDs, we can have it manage totally different objects

  (unrelated to containers, clusters, etc.)

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

## Documentation

- [Custom Resource Definitions: when to use them](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/)

- [Custom Resources Definitions: how to use them](https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/)

- [Service Catalog](https://kubernetes.io/docs/concepts/extend-kubernetes/service-catalog/)

- [Built-in Admission Controllers](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/)

- [Dynamic Admission Controllers](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/)

.debug[[k8s/extending-api.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/ShippingContainerSFBay.jpg)]

---

name: toc-operators
class: title

Operators

.nav[
[Previous section](#toc-extending-the-kubernetes-api)
|
[Back to table of contents](#toc-chapter-15)
|
[Next section](#toc-stateful-sets)
]

.debug[(automatically generated title slide)]

---
# Operators

- Operators are one of the many ways to extend Kubernetes

- We will define operators

- We will see how they work

- We will install a specific operator (for ElasticSearch)

- We will use it to provision an ElasticSearch cluster

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## What are operators?

*An operator represents **human operational knowledge in software,**
&lt;br/&gt;
to reliably manage an application.
— [CoreOS](https://coreos.com/blog/introducing-operators.html)*

Examples:

- Deploying and configuring replication with MySQL, PostgreSQL ...

- Setting up Elasticsearch, Kafka, RabbitMQ, Zookeeper ...

- Reacting to failures when intervention is needed

- Scaling up and down these systems

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## What are they made from?

- Operators combine two things:

  - Custom Resource Definitions

  - controller code watching the corresponding resources and acting upon them

- A given operator can define one or multiple CRDs

- The controller code (control loop) typically runs within the cluster

  (running as a Deployment with 1 replica is a common scenario)

- But it could also run elsewhere

  (nothing mandates that the code run on the cluster, as long as it has API access)

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Why use operators?

- Kubernetes gives us Deployments, StatefulSets, Services ...

- These mechanisms give us building blocks to deploy applications

- They work great for services that are made of *N* identical containers

  (like stateless ones)

- They also work great for some stateful applications like Consul, etcd ...

  (with the help of highly persistent volumes)

- They're not enough for complex services:

  - where different containers have different roles

  - where extra steps have to be taken when scaling or replacing containers

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Use-cases for operators

- Systems with primary/secondary replication

  Examples: MariaDB, MySQL, PostgreSQL, Redis ...

- Systems where different groups of nodes have different roles

  Examples: ElasticSearch, MongoDB ...

- Systems with complex dependencies (that are themselves managed with operators)

  Examples: Flink or Kafka, which both depend on Zookeeper

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## More use-cases

- Representing and managing external resources

  (Example: [AWS Service Operator](https://operatorhub.io/operator/alpha/aws-service-operator.v0.0.1))

- Managing complex cluster add-ons

  (Example: [Istio operator](https://operatorhub.io/operator/beta/istio-operator.0.1.6))

- Deploying and managing our applications' lifecycles

  (more on that later)

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## How operators work

- An operator creates one or more CRDs

  (i.e., it creates new "Kinds" of resources on our cluster)

- The operator also runs a *controller* that will watch its resources

- Each time we create/update/delete a resource, the controller is notified

  (we could write our own cheap controller with `kubectl get --watch`)

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## One operator in action

- We will install the UPMC Enterprises ElasticSearch operator

- This operator requires PersistentVolumes

- We will install Rancher's [local path storage provisioner](https://github.com/rancher/local-path-provisioner) to automatically create these

- Then, we will create an ElasticSearch resource

- The operator will detect that resource and provision the cluster

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Installing a Persistent Volume provisioner

(This step can be skipped if you already have a dynamic volume provisioner.)

- This provisioner creates Persistent Volumes backed by `hostPath`

  (local directories on our nodes)

- It doesn't require anything special ...

- ... But losing a node = losing the volumes on that node!

.exercise[

- Install the local path storage provisioner:
  ```bash
  kubectl apply -f ~/container.training/k8s/local-path-storage.yaml
  ```

]

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Making sure we have a default StorageClass

- The ElasticSearch operator will create StatefulSets

- These StatefulSets will instantiate PersistentVolumeClaims

- These PVCs need to be explicitly associated with a StorageClass

- Or we need to tag a StorageClass to be used as the default one

.exercise[

- List StorageClasses:
  ```bash
  kubectl get storageclasses
  ```

]

We should see the `local-path` StorageClass.

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Setting a default StorageClass

- This is done by adding an annotation to the StorageClass:

  `storageclass.kubernetes.io/is-default-class: true`

.exercise[

- Tag the StorageClass so that it's the default one:
  ```bash
  kubectl annotate storageclass local-path \
            storageclass.kubernetes.io/is-default-class=true
  ```

- Check the result:
  ```bash
  kubectl get storageclasses
  ```

]

Now, the StorageClass should have `(default)` next to its name.

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Install the ElasticSearch operator

- The operator needs:

  - a Deployment for its controller
  - a ServiceAccount, ClusterRole, ClusterRoleBinding for permissions
  - a Namespace

- We have grouped all the definitions for these resources in a YAML file

.exercise[

- Install the operator:
  ```bash
  kubectl apply -f ~/container.training/k8s/elasticsearch-operator.yaml
  ```

]

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Wait for the operator to be ready

- Some operators require to create their CRDs separately

- This operator will create its CRD itself

  (i.e. the CRD is not listed in the YAML that we applied earlier)

.exercise[

- Wait until the `elasticsearchclusters` CRD shows up:
  ```bash
  kubectl get crds
  ```

]

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Create an ElasticSearch resource

- We can now create a resource with `kind: ElasticsearchCluster`

- The YAML for that resource will specify all the desired parameters:

  - how many nodes do we want of each type (client, master, data)
  - image to use
  - add-ons (kibana, cerebro, ...)
  - whether to use TLS or not
  - etc.

.exercise[

- Create our ElasticSearch cluster:
  ```bash
  kubectl apply -f ~/container.training/k8s/elasticsearch-cluster.yaml
  ```

]

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Operator in action

- Over the next minutes, the operator will create:

  - StatefulSets (one for master nodes, one for data nodes)

  - Deployments (for client nodes; and for add-ons like cerebro and kibana)

  - Services (for all these pods)

.exercise[

- Wait for all the StatefulSets to be fully up and running:
  ```bash
  kubectl get statefulsets -w
  ```

]

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Connecting to our cluster

- Since connecting directly to the ElasticSearch API is a bit raw,
  &lt;br/&gt;we'll connect to the cerebro frontend instead

.exercise[

- Edit the cerebro service to change its type from ClusterIP to NodePort:
  ```bash
  kubectl patch svc cerebro-es -p "spec: { type: NodePort }"
  ```

- Retrieve the NodePort that was allocated:
  ```bash
  kubectl get svc cerebreo-es
  ```

- Connect to that port with a browser

]

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## (Bonus) Setup filebeat

- Let's send some data to our brand new ElasticSearch cluster!

- We'll deploy a filebeat DaemonSet to collect node logs

.exercise[

- Deploy filebeat:
  ```bash
  kubectl apply -f ~/container.training/k8s/filebeat.yaml
  ```

]

We should see at least one index being created in cerebro.

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## (Bonus) Access log data with kibana

- Let's expose kibana (by making kibana-es a NodePort too)

- Then access kibana

- We'll need to configure kibana indexes

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Deploying our apps with operators

- It is very simple to deploy with `kubectl run` / `kubectl expose`

- We can unlock more features by writing YAML and using `kubectl apply`

- Kustomize or Helm let us deploy in multiple environments

  (and adjust/tweak parameters in each environment)

- We can also use an operator to deploy our application

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Pros and cons of deploying with operators

- The app definition and configuration is persisted in the Kubernetes API

- Multiple instances of the app can be manipulated with `kubectl get`

- We can add labels, annotations to the app instances

- Our controller can execute custom code for any lifecycle event

- However, we need to write this controller

- We need to be careful about changes

  (what happens when the resource `spec` is updated?)

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---

## Operators are not magic

- Look at the ElasticSearch resource definition

  (`~/container.training/k8s/elasticsearch-cluster.yaml`)

- What should happen if we flip the `use-tls` flag? Twice?

- What should happen if we remove / re-add the kibana or cerebro sections?

- What should happen if we change the number of nodes?

- What if we want different images or parameters for the different nodes?

*Operators can be very powerful, iff we know exactly the scenarios that they can handle.*

.debug[[k8s/operators.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md)]
---
## Operator design (extra material)

- Writing a quick-and-dirty operator, or a POC/MVP, is easy

- Writing a robust operator is hard

- We will describe the general idea

- We will identify some of the associated challenges

- We will list a few tools that can help us

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Top-down vs. bottom-up

- Both approaches are possible

- Let's see what they entail, and their respective pros and cons

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Top-down approach

- Start with high-level design (see next slide)

- Pros:

  - can yield cleaner design that will be more robust

- Cons:

  - must be able to anticipate all the events that might happen

  - design will be better only to the extend of what we anticipated

  - hard to anticipate if we don't have production experience

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## High-level design

- What are we solving?

  (e.g.: geographic databases backed by PostGIS with Redis caches)

- What are our use-cases, stories?

  (e.g.: adding/resizing caches and read replicas; load balancing queries)

- What kind of outage do we want to address?

  (e.g.: loss of individual node, pod, volume)

- What are our *non-features*, the things we don't want to address?

  (e.g.: loss of datacenter/zone; differentiating between read and write queries;
  &lt;br/&gt;
  cache invalidation; upgrading to newer major versions of Redis, PostGIS, PostgreSQL)

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Low-level design

- What Custom Resource Definitions do we need?

  (one, many?)

- How will we store configuration information?

  (part of the CRD spec fields, annotations, other?)

- Do we need to store state? If so, where?

  - state that is small and doesn't change much can be stored via the Kubernetes API
    &lt;br/&gt;
    (e.g.: leader information, configuration, credentials)

  - things that are big and/or change a lot should go elsewhere
    &lt;br/&gt;
    (e.g.: metrics, bigger configuration file like GeoIP)

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

class: extra-details

## What can we store via the Kubernetes API?

- The API server stores most Kubernetes resources into etcd

- Etcd is designed for reliability, not for performance

- If our storage needs exceed what etcd can offer, we need to use something else:

  - either directly

  - or by extending the API server
    &lt;br/&gt;(for instance by using the agregation layer, like [metrics server](https://github.com/kubernetes-incubator/metrics-server) does)

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Bottom-up approach

- Start with existing Kubernetes resources (Deployment, Stateful Set...)

- Run the system in production

- Add scripts, automation, to facilitate day-to-day operations

- Turn the scripts into an operator

- Pros: simpler to get started; reflects actual use-cases

- Cons: can result in convoluted designs requiring extensive refactor

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## General idea

- Our operator will watch its CRDs *and associated resources*

- Drawing state diagrams and finite state automata helps a lot

- It's OK if some transitions lead to a big catch-all "human intervention"

- Over time, we will learn about new failure modes and add to these diagrams

- It's OK to start with CRD creation / deletion and prevent any modification

  (that's the easy POC/MVP we were talking about)

- *Presentation* and *validation* will help our users

  (more on that later)

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Challenges

- Reacting to infrastructure disruption can seem hard at first

- Kubernetes gives us a lot of primitives to help:

  - Pods and Persistent Volumes will *eventually* recover

  - Stateful Sets give us easy ways to "add N copies" of a thing

- The real challenges come with configuration changes

  (i.e., what to do when our users update our CRDs)

- Keep in mind that [some] of the [largest] cloud [outages] haven't been caused by [natural catastrophes], or even code bugs, but by configuration changes

[some]: https://www.datacenterdynamics.com/news/gcp-outage-mainone-leaked-google-cloudflare-ip-addresses-china-telecom/
[largest]: https://aws.amazon.com/message/41926/
[outages]: https://aws.amazon.com/message/65648/
[natural catastrophes]: https://www.datacenterknowledge.com/amazon/aws-says-it-s-never-seen-whole-data-center-go-down

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Configuration changes

- It is helpful to analyze and understand how Kubernetes controllers work:

  - watch resource for modifications

  - compare desired state (CRD) and current state

  - issue actions to converge state

- Configuration changes will probably require *another* state diagram or FSA

- Again, it's OK to have transitions labeled as "unsupported"

  (i.e. reject some modifications because we can't execute them)

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Tools

- CoreOS / RedHat Operator Framework

  [GitHub](https://github.com/operator-framework)
  |
  [Blog](https://developers.redhat.com/blog/2018/12/18/introduction-to-the-kubernetes-operator-framework/)
  |
  [Intro talk](https://www.youtube.com/watch?v=8k_ayO1VRXE)
  |
  [Deep dive talk](https://www.youtube.com/watch?v=fu7ecA2rXmc)

- Zalando Kubernetes Operator Pythonic Framework (KOPF)

  [GitHub](https://github.com/zalando-incubator/kopf)
  |
  [Docs](https://kopf.readthedocs.io/)
  |
  [Step-by-step tutorial](https://kopf.readthedocs.io/en/stable/walkthrough/problem/)

- Mesosphere Kubernetes Universal Declarative Operator (KUDO)

  [GitHub](https://github.com/kudobuilder/kudo)
  |
  [Blog](https://mesosphere.com/blog/announcing-maestro-a-declarative-no-code-approach-to-kubernetes-day-2-operators/)
  |
  [Docs](https://kudo.dev/)
  |
  [Zookeeper example](https://github.com/kudobuilder/frameworks/tree/master/repo/stable/zookeeper)

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Validation

- By default, a CRD is "free form"

  (we can put pretty much anything we want in it)

- When creating a CRD, we can provide an OpenAPI v3 schema
  ([Example](https://github.com/amaizfinance/redis-operator/blob/master/deploy/crds/k8s_v1alpha1_redis_crd.yaml#L34))

- The API server will then validate resources created/edited with this schema

- If we need a stronger validation, we can use a Validating Admission Webhook:

  - run an [admission webhook server](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#write-an-admission-webhook-server) to receive validation requests

  - register the webhook by creating a [ValidatingWebhookConfiguration](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#configure-admission-webhooks-on-the-fly)

  - each time the API server receives a request matching the configuration,
    &lt;br/&gt;the request is sent to our server for validation

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Presentation

- By default, `kubectl get mycustomresource` won't display much information

  (just the name and age of each resource)

- When creating a CRD, we can specify additional columns to print
  ([Example](https://github.com/amaizfinance/redis-operator/blob/master/deploy/crds/k8s_v1alpha1_redis_crd.yaml#L6),
  [Docs](https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#additional-printer-columns))

- By default, `kubectl describe mycustomresource` will also be generic

- `kubectl describe` can show events related to our custom resources

  (for that, we need to create Event resources, and fill the `involvedObject` field)

- For scalable resources, we can define a `scale` sub-resource

- This will enable the use of `kubectl scale` and other scaling-related operations

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## About scaling

- It is possible to use the HPA (Horizontal Pod Autoscaler) with CRDs

- But it is not always desirable

- The HPA works very well for homogenous, stateless workloads

- For other workloads, your mileage may vary

- Some systems can scale across multiple dimensions

  (for instance: increase number of replicas, or number of shards?)

- If autoscaling is desired, the operator will have to take complex decisions

  (example: Zalando's Elasticsearch Operator ([Video](https://www.youtube.com/watch?v=lprE0J0kAq0)))

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Versioning

- As our operator evolves over time, we may have to change the CRD

  (add, remove, change fields)

- Like every other resource in Kubernetes, [custom resources are versioned](https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definition-versioning/
)

- When creating a CRD, we need to specify a *list* of versions

- Versions can be marked as `stored` and/or `served`

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Stored version

- Exactly one version has to be marked as the `stored` version

- As the name implies, it is the one that will be stored in etcd

- Resources in storage are never converted automatically

  (we need to read and re-write them ourselves)

- Yes, this means that we can have different versions in etcd at any time

- Our code needs to handle all the versions that still exist in storage

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Served versions

- By default, the Kubernetes API will serve resources "as-is"

  (using their stored version)

- It will assume that all versions are compatible storage-wise

  (i.e. that the spec and fields are compatible between versions)

- We can provide [conversion webhooks](https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definition-versioning/#webhook-conversion) to "translate" requests

  (the alternative is to upgrade all stored resources and stop serving old versions)

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Operator reliability

- Remember that the operator itself must be resilient

  (e.g.: the node running it can fail)

- Our operator must be able to restart and recover gracefully

- Do not store state locally

  (unless we can reconstruct that state when we restart)

- As indicated earlier, we can use the Kubernetes API to store data:

  - in the custom resources themselves

  - in other resources' annotations

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

## Beyond CRDs

- CRDs cannot use custom storage (e.g. for time series data)

- CRDs cannot support arbitrary subresources (like logs or exec for Pods)

- CRDs cannot support protobuf (for faster, more efficient communication)

- If we need these things, we can use the [aggregation layer](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/) instead

- The aggregation layer proxies all requests below a specific path to another server

  (this is used e.g. by the metrics server)

- [This documentation page](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#choosing-a-method-for-adding-custom-resources) compares the features of CRDs and API aggregation

.debug[[k8s/operators-design.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/aerial-view-of-containers.jpg)]

---

name: toc-stateful-sets
class: title

Stateful sets

.nav[
[Previous section](#toc-operators)
|
[Back to table of contents](#toc-chapter-16)
|
[Next section](#toc-running-a-consul-cluster)
]

.debug[(automatically generated title slide)]

---
# Stateful sets

- Stateful sets are a type of resource in the Kubernetes API

  (like pods, deployments, services...)

- They offer mechanisms to deploy scaled stateful applications

- At a first glance, they look like *deployments*:

  - a stateful set defines a pod spec and a number of replicas *R*

  - it will make sure that *R* copies of the pod are running

  - that number can be changed while the stateful set is running

  - updating the pod spec will cause a rolling update to happen

- But they also have some significant differences

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Stateful sets unique features

- Pods in a stateful set are numbered (from 0 to *R-1*) and ordered

- They are started and updated in order (from 0 to *R-1*)

- A pod is started (or updated) only when the previous one is ready

- They are stopped in reverse order (from *R-1* to 0)

- Each pod know its identity (i.e. which number it is in the set)

- Each pod can discover the IP address of the others easily

- The pods can persist data on attached volumes

🤔 Wait a minute ... Can't we already attach volumes to pods and deployments?

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Revisiting volumes

- [Volumes](https://kubernetes.io/docs/concepts/storage/volumes/) are used for many purposes:

  - sharing data between containers in a pod

  - exposing configuration information and secrets to containers

  - accessing storage systems

- Let's see examples of the latter usage

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Volumes types

- There are many [types of volumes](https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes) available:

  - public cloud storage (GCEPersistentDisk, AWSElasticBlockStore, AzureDisk...)

  - private cloud storage (Cinder, VsphereVolume...)

  - traditional storage systems (NFS, iSCSI, FC...)

  - distributed storage (Ceph, Glusterfs, Portworx...)

- Using a persistent volume requires:

  - creating the volume out-of-band (outside of the Kubernetes API)

  - referencing the volume in the pod description, with all its parameters

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Using a cloud volume

Here is a pod definition using an AWS EBS volume (that has to be created first):

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-using-my-ebs-volume
spec:
  containers:
  - image: ...
    name: container-using-my-ebs-volume
    volumeMounts:
    - mountPath: /my-ebs
      name: my-ebs-volume
  volumes:
  - name: my-ebs-volume
    awsElasticBlockStore:
      volumeID: vol-049df61146c4d7901
      fsType: ext4
```

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Using an NFS volume

Here is another example using a volume on an NFS server:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-using-my-nfs-volume
spec:
  containers:
  - image: ...
    name: container-using-my-nfs-volume
    volumeMounts:
    - mountPath: /my-nfs
      name: my-nfs-volume
  volumes:
  - name: my-nfs-volume
      nfs:
        server: 192.168.0.55
        path: "/exports/assets"
```

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Shortcomings of volumes

- Their lifecycle (creation, deletion...) is managed outside of the Kubernetes API

  (we can't just use `kubectl apply/create/delete/...` to manage them)

- If a Deployment uses a volume, all replicas end up using the same volume

- That volume must then support concurrent access

  - some volumes do (e.g. NFS servers support multiple read/write access)

  - some volumes support concurrent reads

  - some volumes support concurrent access for colocated pods

- What we really need is a way for each replica to have its own volume

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Persistent Volume Claims

- To abstract the different types of storage, a pod can use a special volume type

- This type is a *Persistent Volume Claim*

- A Persistent Volume Claim (PVC) is a resource type

  (visible with `kubectl get persistentvolumeclaims` or `kubectl get pvc`)

- A PVC is not a volume; it is a *request for a volume*

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Persistent Volume Claims in practice

- Using a Persistent Volume Claim is a two-step process:

  - creating the claim

  - using the claim in a pod (as if it were any other kind of volume)

- A PVC starts by being Unbound (without an associated volume)

- Once it is associated with a Persistent Volume, it becomes Bound

- A Pod referring an unbound PVC will not start

  (but as soon as the PVC is bound, the Pod can start)

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Binding PV and PVC

- A Kubernetes controller continuously watches PV and PVC objects

- When it notices an unbound PVC, it tries to find a satisfactory PV

  ("satisfactory" in terms of size and other characteristics; see next slide)

- If no PV fits the PVC, a PV can be created dynamically

  (this requires to configure a *dynamic provisioner*, more on that later)

- Otherwise, the PVC remains unbound indefinitely

  (until we manually create a PV or setup dynamic provisioning)

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## What's in a Persistent Volume Claim?

- At the very least, the claim should indicate:

  - the size of the volume (e.g. "5 GiB")

  - the access mode (e.g. "read-write by a single pod")

- Optionally, it can also specify a Storage Class

- The Storage Class indicates:

  - which storage system to use (e.g. Portworx, EBS...)

  - extra parameters for that storage system

    e.g.: "replicate the data 3 times, and use SSD media"

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## What's a Storage Class?

- A Storage Class is yet another Kubernetes API resource

  (visible with e.g. `kubectl get storageclass` or `kubectl get sc`)

- It indicates which *provisioner* to use

  (which controller will create the actual volume)

- And arbitrary parameters for that provisioner

  (replication levels, type of disk ... anything relevant!)

- Storage Classes are required if we want to use [dynamic provisioning](https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/)

  (but we can also create volumes manually, and ignore Storage Classes)

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Defining a Persistent Volume Claim

Here is a minimal PVC:

```yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
   name: my-claim
spec:
   accessModes:
     - ReadWriteOnce
   resources:
     requests:
       storage: 1Gi
```

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Using a Persistent Volume Claim

Here is a Pod definition like the ones shown earlier, but using a PVC:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-using-a-claim
spec:
  containers:
  - image: ...
    name: container-using-a-claim
    volumeMounts:
    - mountPath: /my-vol
      name: my-volume
  volumes:
  - name: my-volume
    persistentVolumeClaim:
      claimName: my-claim
```

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Persistent Volume Claims and Stateful sets

- The pods in a stateful set can define a `volumeClaimTemplate`

- A `volumeClaimTemplate` will dynamically create one Persistent Volume Claim per pod

- Each pod will therefore have its own volume

- These volumes are numbered (like the pods)

- When updating the stateful set (e.g. image upgrade), each pod keeps its volume

- When pods get rescheduled (e.g. node failure), they keep their volume

  (this requires a storage system that is not node-local)

- These volumes are not automatically deleted

  (when the stateful set is scaled down or deleted)

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Stateful set recap

- A Stateful sets manages a number of identical pods

  (like a Deployment)

- These pods are numbered, and started/upgraded/stopped in a specific order

- These pods are aware of their number

  (e.g., #0 can decide to be the primary, and #1 can be secondary)

- These pods can find the IP addresses of the other pods in the set

  (through a *headless service*)

- These pods can each have their own persistent storage

  (Deployments cannot do that)

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/blue-containers.jpg)]

---

name: toc-running-a-consul-cluster
class: title

Running a Consul cluster

.nav[
[Previous section](#toc-stateful-sets)
|
[Back to table of contents](#toc-chapter-16)
|
[Next section](#toc-local-persistent-volumes)
]

.debug[(automatically generated title slide)]

---

# Running a Consul cluster

- Here is a good use-case for Stateful sets!

- We are going to deploy a Consul cluster with 3 nodes

- Consul is a highly-available key/value store

  (like etcd or Zookeeper)

- One easy way to bootstrap a cluster is to tell each node:

  - the addresses of other nodes

  - how many nodes are expected (to know when quorum is reached)

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Bootstrapping a Consul cluster

*After reading the Consul documentation carefully (and/or asking around),
we figure out the minimal command-line to run our Consul cluster.*

```
consul agent -data=dir=/consul/data -client=0.0.0.0 -server -ui \
       -bootstrap-expect=3 \
       -retry-join=`X.X.X.X` \
       -retry-join=`Y.Y.Y.Y`
```

- Replace X.X.X.X and Y.Y.Y.Y with the addresses of other nodes

- The same command-line can be used on all nodes (convenient!)

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Cloud Auto-join

- Since version 1.4.0, Consul can use the Kubernetes API to find its peers

- This is called [Cloud Auto-join]

- Instead of passing an IP address, we need to pass a parameter like this:

  ```
  consul agent -retry-join "provider=k8s label_selector=\"app=consul\""
  ```

- Consul needs to be able to talk to the Kubernetes API

- We can provide a `kubeconfig` file

- If Consul runs in a pod, it will use the *service account* of the pod

[Cloud Auto-join]: https://www.consul.io/docs/agent/cloud-auto-join.html#kubernetes-k8s-

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Setting up Cloud auto-join

- We need to create a service account for Consul

- We need to create a role that can `list` and `get` pods

- We need to bind that role to the service account

- And of course, we need to make sure that Consul pods use that service account

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Putting it all together

- The file `k8s/consul.yaml` defines the required resources

  (service account, cluster role, cluster role binding, service, stateful set)

- It has a few extra touches:

  - a `podAntiAffinity` prevents two pods from running on the same node

  - a `preStop` hook makes the pod leave the cluster when shutdown gracefully

This was inspired by this [excellent tutorial](https://github.com/kelseyhightower/consul-on-kubernetes) by Kelsey Hightower.
Some features from the original tutorial (TLS authentication between
nodes and encryption of gossip traffic) were removed for simplicity.

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Running our Consul cluster

- We'll use the provided YAML file

.exercise[

- Create the stateful set and associated service:
  ```bash
  kubectl apply -f ~/container.training/k8s/consul.yaml
  ```

- Check the logs as the pods come up one after another:
  ```bash
  stern consul
  ```

&lt;!--
```wait Synced node info```
```keys ^C```
--&gt;

- Check the health of the cluster:
  ```bash
  kubectl exec consul-0 consul members
  ```

]

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Caveats

- We haven't used a `volumeClaimTemplate` here

- That's because we don't have a storage provider yet

  (except if you're running this on your own and your cluster has one)

- What happens if we lose a pod?

  - a new pod gets rescheduled (with an empty state)

  - the new pod tries to connect to the two others

  - it will be accepted (after 1-2 minutes of instability)

  - and it will retrieve the data from the other pods

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

## Failure modes

- What happens if we lose two pods?

  - manual repair will be required

  - we will need to instruct the remaining one to act solo

  - then rejoin new pods

- What happens if we lose three pods? (aka all of them)

  - we lose all the data (ouch)

- If we run Consul without persistent storage, backups are a good idea!

.debug[[k8s/statefulsets.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/chinook-helicopter-container.jpg)]

---

name: toc-local-persistent-volumes
class: title

Local Persistent Volumes

.nav[
[Previous section](#toc-running-a-consul-cluster)
|
[Back to table of contents](#toc-chapter-16)
|
[Next section](#toc-highly-available-persistent-volumes)
]

.debug[(automatically generated title slide)]

---
# Local Persistent Volumes

- We want to run that Consul cluster *and* actually persist data

- But we don't have a distributed storage system

- We are going to use local volumes instead

  (similar conceptually to `hostPath` volumes)

- We can use local volumes without installing extra plugins

- However, they are tied to a node

- If that node goes down, the volume becomes unavailable

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## With or without dynamic provisioning

- We will deploy a Consul cluster *with* persistence

- That cluster's StatefulSet will create PVCs

- These PVCs will remain unbound¹, until we will create local volumes manually

  (we will basically do the job of the dynamic provisioner)

- Then, we will see how to automate that with a dynamic provisioner

.footnote[¹Unbound = without an associated Persistent Volume.]

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## If we have a dynamic provisioner ...

- The labs in this section assume that we *do not* have a dynamic provisioner

- If we do have one, we need to disable it

.exercise[

- Check if we have a dynamic provisioner:
  ```bash
  kubectl get storageclass
  ```

- If the output contains a line with `(default)`, run this command:
  ```bash
  kubectl annotate sc storageclass.kubernetes.io/is-default-class- --all
  ```

- Check again that it is no longer marked as `(default)`

]

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Work in a separate namespace

- To avoid conflicts with existing resources, let's create and use a new namespace

.exercise[

- Create a new namespace:
  ```bash
  kubectl create namespace orange
  ```

- Switch to that namespace:
  ```bash
  kns orange
  ```

]

.warning[Make sure to call that namespace `orange`: it is hardcoded in the YAML files.]

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Deploying Consul

- We will use a slightly different YAML file

- The only differences between that file and the previous one are:

  - `volumeClaimTemplate` defined in the Stateful Set spec

  - the corresponding `volumeMounts` in the Pod spec

  - the namespace `orange` used for discovery of Pods

.exercise[

- Apply the persistent Consul YAML file:
  ```bash
  kubectl apply -f ~/container.training/k8s/persistent-consul.yaml
  ```

]

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Observing the situation

- Let's look at Persistent Volume Claims and Pods

.exercise[

- Check that we now have an unbound Persistent Volume Claim:
  ```bash
  kubectl get pvc
  ```

- We don't have any Persistent Volume:
  ```bash
  kubectl get pv
  ```

- The Pod `consul-0` is not scheduled yet:
  ```bash
  kubectl get pods -o wide
  ```

]

*Hint: leave these commands running with `-w` in different windows.*

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Explanations

- In a Stateful Set, the Pods are started one by one

- `consul-1` won't be created until `consul-0` is running

- `consul-0` has a dependency on an unbound Persistent Volume Claim

- The scheduler won't schedule the Pod until the PVC is bound

  (because the PVC might be bound to a volume that is only available on a subset of nodes; for instance EBS are tied to an availability zone)

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Creating Persistent Volumes

- Let's create 3 local directories (`/mnt/consul`) on node2, node3, node4

- Then create 3 Persistent Volumes corresponding to these directories

.exercise[

- Create the local directories:
  ```bash
    for NODE in node2 node3 node4; do
      ssh $NODE sudo mkdir -p /mnt/consul
    done
  ```

- Create the PV objects:
  ```bash
  kubectl apply -f ~/container.training/k8s/volumes-for-consul.yaml
  ```

]

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Check our Consul cluster

- The PVs that we created will be automatically matched with the PVCs

- Once a PVC is bound, its pod can start normally

- Once the pod `consul-0` has started, `consul-1` can be created, etc.

- Eventually, our Consul cluster is up, and backend by "persistent" volumes

.exercise[

- Check that our Consul clusters has 3 members indeed:
  ```bash
  kubectl exec consul-0 consul members
  ```

]

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Devil is in the details (1/2)

- The size of the Persistent Volumes is bogus

  (it is used when matching PVs and PVCs together, but there is no actual quota or limit)

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Devil is in the details (2/2)

- This specific example worked because we had exactly 1 free PV per node:

  - if we had created multiple PVs per node ...

  - we could have ended with two PVCs bound to PVs on the same node ...

  - which would have required two pods to be on the same node ...

  - which is forbidden by the anti-affinity constraints in the StatefulSet

- To avoid that, we need to associated the PVs with a Storage Class that has:
  ```yaml
  volumeBindingMode: WaitForFirstConsumer
  ```
  (this means that a PVC will be bound to a PV only after being used by a Pod)

- See [this blog post](https://kubernetes.io/blog/2018/04/13/local-persistent-volumes-beta/) for more details

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Bulk provisioning

- It's not practical to manually create directories and PVs for each app

- We *could* pre-provision a number of PVs across our fleet

- We could even automate that with a Daemon Set:

  - creating a number of directories on each node

  - creating the corresponding PV objects

- We also need to recycle volumes

- ... This can quickly get out of hand

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Dynamic provisioning

- We could also write our own provisioner, which would:

  - watch the PVCs across all namespaces

  - when a PVC is created, create a corresponding PV on a node

- Or we could use one of the dynamic provisioners for local persistent volumes

  (for instance the [Rancher local path provisioner](https://github.com/rancher/local-path-provisioner))

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

## Strategies for local persistent volumes

- Remember, when a node goes down, the volumes on that node become unavailable

- High availability will require another layer of replication

  (like what we've just seen with Consul; or primary/secondary; etc)

- Pre-provisioning PVs makes sense for machines with local storage

  (e.g. cloud instance storage; or storage directly attached to a physical machine)

- Dynamic provisioning makes sense for large number of applications

  (when we can't or won't dedicate a whole disk to a volume)

- It's possible to mix both (using distinct Storage Classes)

.debug[[k8s/local-persistent-volumes.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-cranes.jpg)]

---

name: toc-highly-available-persistent-volumes
class: title

Highly available Persistent Volumes

.nav[
[Previous section](#toc-local-persistent-volumes)
|
[Back to table of contents](#toc-chapter-16)
|
[Next section](#toc-whats-next)
]

.debug[(automatically generated title slide)]

---
# Highly available Persistent Volumes

- How can we achieve true durability?

- How can we store data that would survive the loss of a node?

--

- We need to use Persistent Volumes backed by highly available storage systems

- There are many ways to achieve that:

  - leveraging our cloud's storage APIs

  - using NAS/SAN systems or file servers

  - distributed storage systems

--

- We are going to see one distributed storage system in action

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Our test scenario

- We will set up a distributed storage system on our cluster

- We will use it to deploy a SQL database (PostgreSQL)

- We will insert some test data in the database

- We will disrupt the node running the database

- We will see how it recovers

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Portworx

- Portworx is a *commercial* persistent storage solution for containers

- It works with Kubernetes, but also Mesos, Swarm ...

- It provides [hyper-converged](https://en.wikipedia.org/wiki/Hyper-converged_infrastructure) storage

  (=storage is provided by regular compute nodes)

- We're going to use it here because it can be deployed on any Kubernetes cluster

  (it doesn't require any particular infrastructure)

- We don't endorse or support Portworx in any particular way

  (but we appreciate that it's super easy to install!)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## A useful reminder

- We're installing Portworx because we need a storage system

- If you are using AKS, EKS, GKE ... you already have a storage system

  (but you might want another one, e.g. to leverage local storage)

- If you have setup Kubernetes yourself, there are other solutions available too

  - on premises, you can use a good old SAN/NAS

  - on a private cloud like OpenStack, you can use e.g. Cinder

  - everywhere, you can use other systems, e.g. Gluster, StorageOS

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Portworx requirements

- Kubernetes cluster ✔️

- Optional key/value store (etcd or Consul) ❌

- At least one available block device ❌

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## The key-value store

- In the current version of Portworx (1.4) it is recommended to use etcd or Consul

- But Portworx also has beta support for an embedded key/value store

- For simplicity, we are going to use the latter option

  (but if we have deployed Consul or etcd, we can use that, too)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## One available block device

- Block device = disk or partition on a disk

- We can see block devices with `lsblk`

  (or `cat /proc/partitions` if we're old school like that!)

- If we don't have a spare disk or partition, we can use a *loop device*

- A loop device is a block device actually backed by a file

- These are frequently used to mount ISO (CD/DVD) images or VM disk images

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Setting up a loop device

- We are going to create a 10 GB (empty) file on each node

- Then make a loop device from it, to be used by Portworx

.exercise[

- Create a 10 GB file on each node:
  ```bash
  for N in $(seq 1 4); do ssh node$N sudo truncate --size 10G /portworx.blk; done
  ```
  (If SSH asks to confirm host keys, enter `yes` each time.)

- Associate the file to a loop device on each node:
  ```bash
  for N in $(seq 1 4); do ssh node$N sudo losetup /dev/loop4 /portworx.blk; done
  ```

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Installing Portworx

- To install Portworx, we need to go to https://install.portworx.com/

- This website will ask us a bunch of questions about our cluster

- Then, it will generate a YAML file that we should apply to our cluster

--

- Or, we can just apply that YAML file directly (it's in `k8s/portworx.yaml`)

.exercise[

- Install Portworx:
  ```bash
  kubectl apply -f ~/container.training/k8s/portworx.yaml
  ```

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

class: extra-details

## Generating a custom YAML file

If you want to generate a YAML file tailored to your own needs, the easiest
way is to use https://install.portworx.com/.

FYI, this is how we obtained the YAML file used earlier:
```
KBVER=$(kubectl version -o json | jq -r .serverVersion.gitVersion)
BLKDEV=/dev/loop4
curl https://install.portworx.com/1.4/?kbver=$KBVER&amp;b=true&amp;s=$BLKDEV&amp;c=px-workshop&amp;stork=true&amp;lh=true
```
If you want to use an external key/value store, add one of the following:
```
&amp;k=etcd://`XXX`:2379
&amp;k=consul://`XXX`:8500
```
... where `XXX` is the name or address of your etcd or Consul server.

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Waiting for Portworx to be ready

- The installation process will take a few minutes

.exercise[

- Check out the logs:
  ```bash
  stern -n kube-system portworx
  ```

- Wait until it gets quiet

  (you should see `portworx service is healthy`, too)

&lt;!--
```longwait PX node status reports portworx service is healthy```
```keys ^C```
--&gt;

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Dynamic provisioning of persistent volumes

- We are going to run PostgreSQL in a Stateful set

- The Stateful set will specify a `volumeClaimTemplate`

- That `volumeClaimTemplate` will create Persistent Volume Claims

- Kubernetes' [dynamic provisioning](https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/) will satisfy these Persistent Volume Claims

  (by creating Persistent Volumes and binding them to the claims)

- The Persistent Volumes are then available for the PostgreSQL pods

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Storage Classes

- It's possible that multiple storage systems are available

- Or, that a storage system offers multiple tiers of storage

  (SSD vs. magnetic; mirrored or not; etc.)

- We need to tell Kubernetes *which* system and tier to use

- This is achieved by creating a Storage Class

- A `volumeClaimTemplate` can indicate which Storage Class to use

- It is also possible to mark a Storage Class as "default"

  (it will be used if a `volumeClaimTemplate` doesn't specify one)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Our default Storage Class

This is our Storage Class (in `k8s/storage-class.yaml`):

```yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1beta1
metadata:
  name: portworx-replicated
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: kubernetes.io/portworx-volume
parameters:
 repl: "2"
 priority_io: "high"
```

- It says "use Portworx to create volumes"

- It tells Portworx to "keep 2 replicas of these volumes"

- It marks the Storage Class as being the default one

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Creating our Storage Class

- Let's apply that YAML file!

.exercise[

- Create the Storage Class:
  ```bash
  kubectl apply -f ~/container.training/k8s/storage-class.yaml
  ```

- Check that it is now available:
  ```bash
  kubectl get sc
  ```

]

It should show as `portworx-replicated (default)`.

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Our Postgres Stateful set

- The next slide shows `k8s/postgres.yaml`

- It defines a Stateful set

- With a `volumeClaimTemplate` requesting a 1 GB volume

- That volume will be mounted to `/var/lib/postgresql/data`

- There is another little detail: we enable the `stork` scheduler

- The `stork` scheduler is optional (it's specific to Portworx)

- It helps the Kubernetes scheduler to colocate the pod with its volume

  (see [this blog post](https://portworx.com/stork-storage-orchestration-kubernetes/) for more details about that)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

.small[
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  serviceName: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      schedulerName: stork
      containers:
      - name: postgres
        image: postgres:10.5
        volumeMounts:
        - mountPath: /var/lib/postgresql/data
          name: postgres
  volumeClaimTemplates:
  - metadata:
      name: postgres
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 1Gi
```
]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Creating the Stateful set

- Before applying the YAML, watch what's going on with `kubectl get events -w`

.exercise[

- Apply that YAML:
  ```bash
  kubectl apply -f ~/container.training/k8s/postgres.yaml
  ```

&lt;!-- ```hide kubectl wait pod postgres-0 --for condition=ready``` --&gt;

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Testing our PostgreSQL pod

- We will use `kubectl exec` to get a shell in the pod

- Good to know: we need to use the `postgres` user in the pod

.exercise[

- Get a shell in the pod, as the `postgres` user:
  ```bash
  kubectl exec -ti postgres-0 su postgres
  ```

&lt;!--
autopilot prompt detection expects $ or # at the beginning of the line.
```wait postgres@postgres```
```keys PS1="\u@\h:\w\n\$ "```
```keys ^J```
--&gt;

- Check that default databases have been created correctly:
  ```bash
  psql -l
  ```

]

(This should show us 3 lines: postgres, template0, and template1.)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Inserting data in PostgreSQL

- We will create a database and populate it with `pgbench`

.exercise[

- Create a database named `demo`:
  ```bash
  createdb demo
  ```

- Populate it with `pgbench`:
  ```bash
  pgbench -i -s 10 demo
  ```

]

- The `-i` flag means "create tables"

- The `-s 10` flag means "create 10 x 100,000 rows"

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Checking how much data we have now

- The `pgbench` tool inserts rows in table `pgbench_accounts`

.exercise[

- Check that the `demo` base exists:
  ```bash
  psql -l
  ```

- Check how many rows we have in `pgbench_accounts`:
  ```bash
  psql demo -c "select count(*) from pgbench_accounts"
  ```

&lt;!-- ```keys ^D``` --&gt;

]

(We should see a count of 1,000,000 rows.)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Find out which node is hosting the database

- We can find that information with `kubectl get pods -o wide`

.exercise[

- Check the node running the database:
  ```bash
  kubectl get pod postgres-0 -o wide
  ```

]

We are going to disrupt that node.

--

By "disrupt" we mean: "disconnect it from the network".

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Disconnect the node

- We will use `iptables` to block all traffic exiting the node

  (except SSH traffic, so we can repair the node later if needed)

.exercise[

- SSH to the node to disrupt:
  ```bash
  ssh `nodeX`
  ```

- Allow SSH traffic leaving the node, but block all other traffic:
  ```bash
  sudo iptables -I OUTPUT -p tcp --sport 22 -j ACCEPT
  sudo iptables -I OUTPUT 2 -j DROP
  ```

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Check that the node is disconnected

.exercise[

- Check that the node can't communicate with other nodes:
  ```
  ping node1
  ```

- Logout to go back on `node1`

&lt;!-- ```keys ^D``` --&gt;

- Watch the events unfolding with `kubectl get events -w` and `kubectl get pods -w`

]

- It will take some time for Kubernetes to mark the node as unhealthy

- Then it will attempt to reschedule the pod to another node

- In about a minute, our pod should be up and running again

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Check that our data is still available

- We are going to reconnect to the (new) pod and check

.exercise[

- Get a shell on the pod:
  ```bash
  kubectl exec -ti postgres-0 su postgres
  ```

&lt;!--
```wait postgres@postgres```
```keys PS1="\u@\h:\w\n\$ "```
```keys ^J```
--&gt;

- Check the number of rows in the `pgbench_accounts` table:
  ```bash
  psql demo -c "select count(*) from pgbench_accounts"
  ```

&lt;!-- ```keys ^D``` --&gt;

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Double-check that the pod has really moved

- Just to make sure the system is not bluffing!

.exercise[

- Look at which node the pod is now running on
  ```bash
  kubectl get pod postgres-0 -o wide
  ```

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Re-enable the node

- Let's fix the node that we disconnected from the network

.exercise[

- SSH to the node:
  ```bash
  ssh `nodeX`
  ```

- Remove the iptables rule blocking traffic:
  ```bash
  sudo iptables -D OUTPUT 2
  ```

]

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

class: extra-details

## A few words about this PostgreSQL setup

- In a real deployment, you would want to set a password

- This can be done by creating a `secret`:
  ```
  kubectl create secret generic postgres \
          --from-literal=password=$(base64 /dev/urandom | head -c16)
  ```

- And then passing that secret to the container:
  ```yaml
  env:
  - name: POSTGRES_PASSWORD
    valueFrom:
      secretKeyRef:
        name: postgres
        key: password
  ```

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

class: extra-details

## Troubleshooting Portworx

- If we need to see what's going on with Portworx:
  ```
  PXPOD=$(kubectl -n kube-system get pod -l name=portworx -o json | 
  	      jq -r .items[0].metadata.name)
  kubectl -n kube-system exec $PXPOD -- /opt/pwx/bin/pxctl status
  ```

- We can also connect to Lighthouse (a web UI)

  - check the port with `kubectl -n kube-system get svc px-lighthouse`

  - connect to that port

  - the default login/password is `admin/Password1`

  - then specify `portworx-service` as the endpoint

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

class: extra-details

## Removing Portworx

- Portworx provides a storage driver

- It needs to place itself "above" the Kubelet

  (it installs itself straight on the nodes)

- To remove it, we need to do more than just deleting its Kubernetes resources

- It is done by applying a special label:
  ```
  kubectl label nodes --all px/enabled=remove --overwrite
  ```

- Then removing a bunch of local files:
  ```
  sudo chattr -i /etc/pwx/.private.json
  sudo rm -rf /etc/pwx /opt/pwx
  ```

  (on each node where Portworx was running)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

class: extra-details

## Dynamic provisioning without a provider

- What if we want to use Stateful sets without a storage provider?

- We will have to create volumes manually

  (by creating Persistent Volume objects)

- These volumes will be automatically bound with matching Persistent Volume Claims

- We can use local volumes (essentially bind mounts of host directories)

- Of course, these volumes won't be available in case of node failure

- Check [this blog post](https://kubernetes.io/blog/2018/04/13/local-persistent-volumes-beta/) for more information and gotchas

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

## Acknowledgements

The Portworx installation tutorial, and the PostgreSQL example,
were inspired by [Portworx examples on Katacoda](https://katacoda.com/portworx/scenarios/), in particular:

- [installing Portworx on Kubernetes](https://www.katacoda.com/portworx/scenarios/deploy-px-k8s)

  (with adapatations to use a loop device and an embedded key/value store)

- [persistent volumes on Kubernetes using Portworx](https://www.katacoda.com/portworx/scenarios/px-k8s-vol-basic)

  (with adapatations to specify a default Storage Class)

- [HA PostgreSQL on Kubernetes with Portworx](https://www.katacoda.com/portworx/scenarios/px-k8s-postgres-all-in-one)

  (with adaptations to use a Stateful Set and simplify PostgreSQL's setup)

.debug[[k8s/portworx.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/container-housing.jpg)]

---

name: toc-whats-next
class: title

What's next?

.nav[
[Previous section](#toc-highly-available-persistent-volumes)
|
[Back to table of contents](#toc-chapter-17)
|
[Next section](#toc-links-and-resources)
]

.debug[(automatically generated title slide)]

---
# What's next?

- Congratulations!

- We learned a lot about Kubernetes, its internals, its advanced concepts

--

- That was just the easy part

- The hard challenges will revolve around *culture* and *people*

--

- ... What does that mean?

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Running an app involves many steps

- Write the app

- Tests, QA ...

- Ship *something* (more on that later)

- Provision resources (e.g. VMs, clusters)

- Deploy the *something* on the resources

- Manage, maintain, monitor the resources

- Manage, maintain, monitor the app

- And much more

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Who does what?

- The old "devs vs ops" division has changed

- In some organizations, "ops" are now called "SRE" or "platform" teams

  (and they have very different sets of skills)

- Do you know which team is responsible for each item on the list on the previous page?

- Acknowledge that a lot of tasks are outsourced

  (e.g. if we add "buy / rack / provision machines" in that list)

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## What do we ship?

- Some organizations embrace "you build it, you run it"

- When "build" and "run" are owned by different teams, where's the line?

- What does the "build" team ship to the "run" team?

- Let's see a few options, and what they imply

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Shipping code

- Team "build" ships code

  (hopefully in a repository, identified by a commit hash)

- Team "run" containerizes that code

✔️ no extra work for developers

❌ very little advantage of using containers

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Shipping container images

- Team "build" ships container images

  (hopefully built automatically from a source repository)

- Team "run" uses theses images to create e.g. Kubernetes resources

✔️ universal artefact (support all languages uniformly)

✔️ easy to start a single component (good for monoliths)

❌ complex applications will require a lot of extra work

❌ adding/removing components in the stack also requires extra work

❌ complex applications will run very differently between dev and prod

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Shipping Compose files

(Or another kind of dev-centric manifest)

- Team "build" ships a manifest that works on a single node

  (as well as images, or ways to build them)

- Team "run" adapts that manifest to work on a cluster

✔️ all teams can start the stack in a reliable, deterministic manner

❌ adding/removing components still requires *some* work (but less than before)

❌ there will be *some* differences between dev and prod

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Shipping Kubernetes manifests

- Team "build" ships ready-to-run manifests

  (YAML, Helm charts, Kustomize ...)

- Team "run" adjusts some parameters and monitors the application 

✔️ parity between dev and prod environments

✔️ "run" team can focus on SLAs, SLOs, and overall quality

❌ requires *a lot* of extra work (and new skills) from the "build" team

❌ Kubernetes is not a very convenient development platform (at least, not yet)

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## What's the right answer?

- It depends on our teams

  - existing skills (do they know how to do it?)

  - availability (do they have the time to do it?)

  - potential skills (can they learn to do it?)

- It depends on our culture

  - owning "run" often implies being on call

  - do we reward on-call duty without encouraging hero syndrome?

  - do we give resources (time, money) to people to learn?

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

class: extra-details

## Tools to develop on Kubernetes

*If we decide to make Kubernetes the primary development platform, here
are a few tools that can help us.*

- Docker Desktop

- Draft

- Minikube

- Skaffold

- Tilt

- ...

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Where do we run?

- Managed vs. self-hosted

- Cloud vs. on-premises

- If cloud: public vs. private

- Which vendor / distribution to pick?

- Which versions / features to enable?

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

## Some guidelines

- Start small

- Outsource what we don't know

- Start simple, and stay simple as long as possible

  (try to stay away from complex features that we don't need)

- Automate

  (regularly check that we can successfully redeploy by following scripts)

- Transfer knowledge

  (make sure everyone is on the same page / same level)

- Iterate!

.debug[[k8s/lastwords-admin.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/containers-by-the-water.jpg)]

---

name: toc-links-and-resources
class: title

Links and resources

.nav[
[Previous section](#toc-whats-next)
|
[Back to table of contents](#toc-chapter-17)
|
[Next section](#toc-)
]

.debug[(automatically generated title slide)]

---
# Links and resources

All things Kubernetes:

- [Kubernetes Community](https://kubernetes.io/community/) - Slack, Google Groups, meetups
- [Kubernetes on StackOverflow](https://stackoverflow.com/questions/tagged/kubernetes)
- [Play With Kubernetes Hands-On Labs](https://medium.com/@marcosnils/introducing-pwk-play-with-k8s-159fcfeb787b)

All things Docker:

- [Docker documentation](http://docs.docker.com/)
- [Docker Hub](https://hub.docker.com)
- [Docker on StackOverflow](https://stackoverflow.com/questions/tagged/docker)
- [Play With Docker Hands-On Labs](http://training.play-with-docker.com/)

Everything else:

- [Local meetups](https://www.meetup.com/)

.footnote[These slides (and future updates) are on → http://container.training/]

.debug[[k8s/links.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/links.md)]
---
class: title, self-paced

Thank you!

.debug[[shared/thankyou.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/thankyou.md)]
---

class: title, in-person

That's all, folks! &lt;br/&gt; Questions?

![end](images/end.jpg)

.debug[[shared/thankyou.md](https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/thankyou.md)]</textarea>
    <script src="./Kubernetes Administrator Training_files/remark.min.js.download" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create({
        ratio: '16:9',
        highlightSpans: true,
        excludedClasses: ["self-paced"]
      });
    </script><div class="remark-notes-area">
  <div class="remark-top-area">
    <div class="remark-toolbar">
      <a class="remark-toolbar-link" href="https://wwrk-2019-06.container.training/#increase">+</a>
      <a class="remark-toolbar-link" href="https://wwrk-2019-06.container.training/#decrease">-</a>
      <span class="remark-toolbar-timer">0:02:09</span>
    </div>
  </div>
  <div class="remark-bottom-area">
    <div class="remark-notes-current-area">
      <div class="remark-toggle">Notes for current slide</div>
      <div class="remark-notes"></div>
    </div>
    <div class="remark-notes-preview-area">
      <div class="remark-toggle">Notes for next slide</div>
      <div class="remark-notes-preview"></div>
    </div>
  </div>
</div>
<div class="remark-slides-area"><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content title in-person hljs-default"><p>Kubernetes<br>Administrator<br>Training<br><br><br></p>
<div class="footnote"><p><strong>Be kind to the WiFi!</strong><br>
<!-- *Use the 5G network.* -->
<em>Don't use your hotspot.</em><br>
<em>Don't stream videos or download big files during the workshop<a href="https://www.youtube.com/watch?v=h16zyxiwDLY">.</a></em><br>
<em>Thank you!</em></p>
<p><strong>Slides: <a href="http://wwrk-2019-06.container.training/">http://wwrk-2019-06.container.training/</a></strong></p>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/title.md">shared/title.md</a></span></p><div class="remark-slide-number">1 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="intros">Intros</h2>
<ul>
<li><p>Hello! We are:</p>
<ul>
<li><p><span class="emoji">👷🏻‍♀️</span> AJ (<a href="https://twitter.com/s0ulshake">@s0ulshake</a>, Travis CI)</p>
</li>
<li><p><span class="emoji">🐳</span> Jérôme (<a href="https://twitter.com/jpetazzo">@jpetazzo</a>, Tiny Shell Script LLC)</p>
</li>
</ul>
</li>
<li><p>Feel free to interrupt for questions at any time</p>
</li>
<li><p><em>Especially when you see full screen container pictures!</em></p>
</li>
<li><p>Live feedback, questions, help: <a href="https://wework.slack.com/messages/CK6PD2EUF/">Slack</a></p>
<p>(Let's make sure right now that we all are on that channel!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/logistics.md">logistics.md</a></span></p><div class="remark-slide-number">2 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="logistics">Logistics</h2>
<p>Training schedule for the 4 days:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>9:00am</td>
<td>Start of training</td>
</tr>
<tr>
<td>10:30am → 11:00am</td>
<td>Break</td>
</tr>
<tr>
<td>12:30pm → 1:30pm</td>
<td>Lunch</td>
</tr>
<tr>
<td>3:00pm → 3:30pm</td>
<td>Break</td>
</tr>
<tr>
<td>5:00pm</td>
<td>End of training</td>
</tr>
</tbody>
</table>
<ul>
<li><p>Lunch will be catered</p>
</li>
<li><p>During the breaks, the instructors will be available for Q&amp;A</p>
</li>
<li><p>Make sure to hydrate / caffeinate / stretch out your limbs :)
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/logistics.md">logistics.md</a></span></p>
</li>
</ul><div class="remark-slide-number">3 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-brief-introduction">A brief introduction</h2>
<ul>
<li><p>This was initially written by <a href="https://twitter.com/jpetazzo">Jérôme Petazzoni</a> to support in-person,
instructor-led workshops and tutorials</p>
</li>
<li><p>Credit is also due to <a href="https://github.com/jpetazzo/container.training/graphs/contributors">multiple contributors</a> — thank you!</p>
</li>
<li><p>You can also follow along on your own, at your own pace</p>
</li>
<li><p>We included as much information as possible in these slides</p>
</li>
<li><p>We recommend having a mentor to help you ...</p>
</li>
<li><p>... Or be comfortable spending some time reading the Kubernetes <a href="https://kubernetes.io/docs/">documentation</a> ...</p>
</li>
<li><p>... And looking for answers on <a href="http://stackoverflow.com/questions/tagged/kubernetes">StackOverflow</a> and other outlets</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/intro.md">k8s/intro.md</a></span></p><div class="remark-slide-number">4 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="about-these-slides">About these slides</h2>
<ul>
<li><p>All the content is available in a public GitHub repository:</p>
<p><a href="https://github.com/jpetazzo/container.training">https://github.com/jpetazzo/container.training</a></p>
</li>
<li><p>You can get updated "builds" of the slides there:</p>
<p><a href="http://container.training/">http://container.training/</a></p>
</li>
</ul>
<!--
<div class="exercise"><p><code>open https://github.com/jpetazzo/container.training</code>
<code>open http://container.training/</code></p>
</div>
--><div class="remark-slide-number">5 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="about-these-slides">About these slides</h2>
<ul>
<li><p>All the content is available in a public GitHub repository:</p>
<p><a href="https://github.com/jpetazzo/container.training">https://github.com/jpetazzo/container.training</a></p>
</li>
<li><p>You can get updated "builds" of the slides there:</p>
<p><a href="http://container.training/">http://container.training/</a></p>
</li>
</ul>
<!--
<div class="exercise"><p><code>open https://github.com/jpetazzo/container.training</code>
<code>open http://container.training/</code></p>
</div>
-->

<ul>
<li>Typos? Mistakes? Questions? Feel free to hover over the bottom of the slide ...</li>
</ul>
<p><span class="footnote"><span class="emoji">👇</span> Try it! The source file will be shown and you can view it on GitHub and fork and edit it.</span></p>
<!--
<div class="exercise"><p><code>open https://github.com/jpetazzo/container.training/tree/master/slides/common/about-slides.md</code></p>
</div>
-->

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/about-slides.md">shared/about-slides.md</a></span></p><div class="remark-slide-number">6 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="extra-details">Extra details</h2>
<ul>
<li><p>This slide has a little magnifying glass in the top left corner</p>
</li>
<li><p>This magnifying glass indicates slides that provide extra details</p>
</li>
<li><p>Feel free to skip them if:</p>
<ul>
<li><p>you are in a hurry</p>
</li>
<li><p>you are new to this and want to avoid cognitive overload</p>
</li>
<li><p>you want only the most essential information</p>
</li>
</ul>
</li>
<li><p>You can review these slides another time if you want, they'll be waiting for you ☺</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/about-slides.md">shared/about-slides.md</a></span></p><div class="remark-slide-number">7 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-1" class="remark-slide-content hljs-default"><h2 id="chapter-1">Chapter 1</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-pre-requirements">Pre-requirements</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-our-sample-application">Our sample application</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-concepts">Kubernetes concepts</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-declarative-vs-imperative">Declarative vs imperative</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-network-model">Kubernetes network model</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">8 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-2" class="remark-slide-content hljs-default"><h2 id="chapter-2">Chapter 2</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-first-contact-with-kubectl">First contact with <code class="remark-inline-code">kubectl</code></a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-setting-up-kubernetes">Setting up Kubernetes</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-running-our-first-containers-on-kubernetes">Running our first containers on Kubernetes</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">9 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-3" class="remark-slide-content hljs-default"><h2 id="chapter-3">Chapter 3</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-exposing-containers">Exposing containers</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-shipping-images-with-a-registry">Shipping images with a registry</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-running-our-application-on-kubernetes">Running our application on Kubernetes</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-scaling-our-demo-app">Scaling our demo app</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-daemon-sets">Daemon sets</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-labels-and-selectors">Labels and selectors</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">10 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-4" class="remark-slide-content hljs-default"><h2 id="chapter-4">Chapter 4</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-rolling-updates">Rolling updates</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-healthchecks">Healthchecks</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-owners-and-dependents-extra-material">Owners and dependents (extra material)</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">11 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-5" class="remark-slide-content hljs-default"><h2 id="chapter-5">Chapter 5</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-accessing-the-api-with-kubectl-proxy">Accessing the API with <code class="remark-inline-code">kubectl proxy</code></a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-controlling-the-cluster-remotely">Controlling the cluster remotely</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-accessing-internal-services">Accessing internal services</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-the-kubernetes-dashboard">The Kubernetes dashboard</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-security-implications-of-kubectl-apply">Security implications of <code class="remark-inline-code">kubectl apply</code></a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-exposing-http-services-with-ingress-resources">Exposing HTTP services with Ingress resources</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">12 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-6" class="remark-slide-content hljs-default"><h2 id="chapter-6">Chapter 6</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-volumes">Volumes</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-managing-configuration">Managing configuration</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-accessing-logs-from-the-cli">Accessing logs from the CLI</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-centralized-logging">Centralized logging</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">13 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-7" class="remark-slide-content hljs-default"><h2 id="chapter-7">Chapter 7</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-namespaces">Namespaces</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-kustomize">Kustomize</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-managing-stacks-with-helm">Managing stacks with Helm</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-collecting-metrics-with-prometheus">Collecting metrics with Prometheus</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">14 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-8" class="remark-slide-content hljs-default"><h2 id="chapter-8">Chapter 8</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-resource-limits">Resource Limits</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-defining-min-max-and-default-resources">Defining min, max, and default resources</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-namespace-quotas">Namespace quotas</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-limiting-resources-in-practice">Limiting resources in practice</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-checking-pod-and-node-resource-usage">Checking pod and node resource usage</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-cluster-sizing">Cluster sizing</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-the-horizontal-pod-autoscaler">The Horizontal Pod Autoscaler</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">15 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-9" class="remark-slide-content hljs-default"><h2 id="chapter-9">Chapter 9</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-additional-lab-environments">Additional lab environments</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-architecture-deep-dive">Kubernetes architecture deep dive</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-the-kubernetes-api">The Kubernetes API</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-other-control-plane-components">Other control plane components</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-building-our-own-cluster">Building our own cluster</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">16 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-10" class="remark-slide-content hljs-default"><h2 id="chapter-10">Chapter 10</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-adding-nodes-to-the-cluster">Adding nodes to the cluster</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-the-container-network-interface">The Container Network Interface</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-interconnecting-clusters">Interconnecting clusters</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">17 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-11" class="remark-slide-content hljs-default"><h2 id="chapter-11">Chapter 11</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-installing-a-managed-cluster">Installing a managed cluster</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-distributions-and-installers">Kubernetes distributions and installers</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-static-pods">Static pods</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">18 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-12" class="remark-slide-content hljs-default"><h2 id="chapter-12">Chapter 12</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-api-server-availability">API server availability</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-upgrading-clusters">Upgrading clusters</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-backing-up-clusters">Backing up clusters</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-the-cloud-controller-manager">The Cloud Controller Manager</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">19 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-13" class="remark-slide-content hljs-default"><h2 id="chapter-13">Chapter 13</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-authentication-and-authorization">Authentication and authorization</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-the-csr-api">The CSR API</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-openid-connect">OpenID Connect</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">20 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-14" class="remark-slide-content hljs-default"><h2 id="chapter-14">Chapter 14</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-securing-the-control-plane">Securing the control plane</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-tls-bootstrap-extra-material">TLS bootstrap (extra material)</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-network-policies">Network policies</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-pod-security-policies">Pod Security Policies</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">21 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-15" class="remark-slide-content hljs-default"><h2 id="chapter-15">Chapter 15</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-extending-the-kubernetes-api">Extending the Kubernetes API</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-operators">Operators</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">22 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-16" class="remark-slide-content hljs-default"><h2 id="chapter-16">Chapter 16</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-stateful-sets">Stateful sets</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-running-a-consul-cluster">Running a Consul cluster</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-local-persistent-volumes">Local Persistent Volumes</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-highly-available-persistent-volumes">Highly available Persistent Volumes</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p><div class="remark-slide-number">23 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-chapter-17" class="remark-slide-content hljs-default"><h2 id="chapter-17">Chapter 17</h2>
<ul>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-whats-next">What's next?</a></p>
</li>
<li><p><a href="https://wwrk-2019-06.container.training/#toc-links-and-resources">Links and resources</a></p>
</li>
</ul>
<p><span class="debug">(auto-generated TOC)</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/toc.md">shared/toc.md</a></span></p><div class="remark-slide-number">24 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">25 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-pre-requirements" class="remark-slide-content title hljs-default"><p>Pre-requirements</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-1">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-our-sample-application">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">26 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="pre-requirements">Pre-requirements</h1>
<ul>
<li><p>Be comfortable with the UNIX command line</p>
<ul>
<li><p>navigating directories</p>
</li>
<li><p>editing files</p>
</li>
<li><p>a little bit of bash-fu (environment variables, loops)</p>
</li>
</ul>
</li>
<li><p>Some Docker knowledge</p>
<ul>
<li><p><code class="remark-inline-code">docker run</code>, <code class="remark-inline-code">docker ps</code>, <code class="remark-inline-code">docker build</code></p>
</li>
<li><p>ideally, you know how to write a Dockerfile and build it
<br>
(even if it's a <code class="remark-inline-code">FROM</code> line and a couple of <code class="remark-inline-code">RUN</code> commands)</p>
</li>
</ul>
</li>
<li><p>It's totally OK if you are not a Docker expert!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">27 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content title hljs-default"><p><em>Tell me and I forget.</em>
<br>
<em>Teach me and I remember.</em>
<br>
<em>Involve me and I learn.</em></p>
<p>Misattributed to Benjamin Franklin</p>
<p><a href="https://www.barrypopik.com/index.php/new_york_city/entry/tell_me_and_i_forget_teach_me_and_i_may_remember_involve_me_and_i_will_lear/">(Probably inspired by Chinese Confucian philosopher Xunzi)</a></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">28 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="hands-on-sections">Hands-on sections</h2>
<ul>
<li><p>The whole workshop is hands-on</p>
</li>
<li><p>We are going to build, ship, and run containers!</p>
</li>
<li><p>You are invited to reproduce all the demos</p>
</li>
<li><p>All hands-on sections are clearly identified, like the gray rectangle below</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>This is the stuff you're supposed to do!</p>
</li>
<li><p>Go to <a href="http://wwrk-2019-06.container.training/">http://wwrk-2019-06.container.training/</a> to view these slides</p>
</li>
<li><p>Join the chat room: <a href="https://wework.slack.com/messages/CK6PD2EUF/">Slack</a></p>
</li>
</ul>
<!-- ```open http://wwrk-2019-06.container.training/``` -->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">29 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person hljs-default"><h2 id="where-are-we-going-to-run-our-containers-">Where are we going to run our containers?</h2>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">30 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/you-get-a-cluster.jpg" alt="You get a cluster"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">31 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person hljs-default"><h2 id="you-get-a-cluster-of-cloud-vms">You get a cluster of cloud VMs</h2>
<ul>
<li><p>Each person gets a private cluster of cloud VMs (not shared with anybody else)</p>
</li>
<li><p>They'll remain up for the duration of the workshop</p>
</li>
<li><p>You should have a little card with login+password+IP addresses</p>
</li>
<li><p>You can automatically SSH from one VM to another</p>
</li>
<li><p>The nodes have aliases: <code class="remark-inline-code">node1</code>, <code class="remark-inline-code">node2</code>, etc.</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">32 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person hljs-default"><h2 id="why-don-t-we-run-containers-locally-">Why don't we run containers locally?</h2>
<ul>
<li><p>Installing this stuff can be hard on some machines</p>
<p>(32 bits CPU or OS... Laptops without administrator access... etc.)</p>
</li>
<li><p><em>"The whole team downloaded all these container images from the WiFi!
<br>... and it went great!"</em> (Literally no-one ever)</p>
</li>
<li><p>All you need is a computer (or even a phone or tablet!), with:</p>
<ul>
<li><p>an internet connection</p>
</li>
<li><p>a web browser</p>
</li>
<li><p>an SSH client</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">33 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person hljs-default"><h2 id="ssh-clients">SSH clients</h2>
<ul>
<li><p>On Linux, OS X, FreeBSD... you are probably all set</p>
</li>
<li><p>On Windows, get one of these:</p>
<ul>
<li><a href="http://www.putty.org/">putty</a></li>
<li>Microsoft <a href="https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH">Win32 OpenSSH</a></li>
<li><a href="https://git-for-windows.github.io/">Git BASH</a></li>
<li><a href="http://mobaxterm.mobatek.net/">MobaXterm</a></li>
</ul>
</li>
<li><p>On Android, <a href="https://juicessh.com/">JuiceSSH</a>
(<a href="https://play.google.com/store/apps/details?id=com.sonelli.juicessh">Play Store</a>)
works pretty well</p>
</li>
<li><p>Nice-to-have: <a href="https://mosh.org/">Mosh</a> instead of SSH, if your internet connection tends to lose packets</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">34 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person extra-details hljs-default"><h2 id="what-is-this-mosh-thing-">What is this Mosh thing?</h2>
<p><em>You don't have to use Mosh or even know about it to follow along.
<br>
We're just telling you about it because some of us think it's cool!</em></p>
<ul>
<li><p>Mosh is "the mobile shell"</p>
</li>
<li><p>It is essentially SSH over UDP, with roaming features</p>
</li>
<li><p>It retransmits packets quickly, so it works great even on lossy connections</p>
<p>(Like hotel or conference WiFi)</p>
</li>
<li><p>It has intelligent local echo, so it works great even in high-latency connections</p>
<p>(Like hotel or conference WiFi)</p>
</li>
<li><p>It supports transparent roaming when your client IP address changes</p>
<p>(Like when you hop from hotel to conference WiFi)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">35 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person extra-details hljs-default"><h2 id="using-mosh">Using Mosh</h2>
<ul>
<li><p>To install it: <code class="remark-inline-code">(apt|yum|brew) install mosh</code></p>
</li>
<li><p>It has been pre-installed on the VMs that we are using</p>
</li>
<li><p>To connect to a remote machine: <code class="remark-inline-code">mosh user@host</code></p>
<p>(It is going to establish an SSH connection, then hand off to UDP)</p>
</li>
<li><p>It requires UDP ports to be open</p>
<p>(By default, it uses a UDP port between 60000 and 61000)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/prereqs.md">shared/prereqs.md</a></span></p><div class="remark-slide-number">36 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content in-person hljs-default"><h2 id="connecting-to-our-lab-environment">Connecting to our lab environment</h2>
<div class="exercise"><ul>
<li>Log into the first VM (<code class="remark-inline-code">node1</code>) with your SSH client</li>
</ul>
<!--
```bash
for N in $(awk '/\Wnode/{print $2}' /etc/hosts); do
  ssh -o StrictHostKeyChecking=no $N true
done
```

```bash
### FIXME find a way to reset the cluster, maybe?
```
-->

<ul>
<li>Check that you can SSH (without password) to <code class="remark-inline-code">node2</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">ssh node2</div></code></pre>
</li>
<li>Type <code class="remark-inline-code">exit</code> or <code class="remark-inline-code">^D</code> to come back to <code class="remark-inline-code">node1</code></li>
</ul>
<!-- ```bash exit``` -->

</div>

<p>If anything goes wrong — ask for help!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md">shared/connecting.md</a></span></p><div class="remark-slide-number">37 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="doing-or-re-doing-the-workshop-on-your-own-">Doing or re-doing the workshop on your own?</h2>
<ul>
<li><p>Use something like
<a href="http://play-with-docker.com/">Play-With-Docker</a> or
<a href="https://training.play-with-kubernetes.com/">Play-With-Kubernetes</a></p>
<p>Zero setup effort; but environment are short-lived and
might have limited resources</p>
</li>
<li><p>Create your own cluster (local or cloud VMs)</p>
<p>Small setup effort; small cost; flexible environments</p>
</li>
<li><p>Create a bunch of clusters for you and your friends
(<a href="https://github.com/jpetazzo/container.training/tree/master/prepare-vms">instructions</a>)</p>
<p>Bigger setup effort; ideal for group training</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md">shared/connecting.md</a></span></p><div class="remark-slide-number">38 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="we-will-mostly-interact-with-node1-only">We will (mostly) interact with node1 only</h2>
<p><em>These remarks apply only when using multiple nodes, of course.</em></p>
<ul>
<li><p>Unless instructed, <strong>all commands must be run from the first VM, <code class="remark-inline-code">node1</code></strong></p>
</li>
<li><p>We will only check out/copy the code on <code class="remark-inline-code">node1</code></p>
</li>
<li><p>During normal operations, we do not need access to the other nodes</p>
</li>
<li><p>If we had to troubleshoot issues, we would use a combination of:</p>
<ul>
<li><p>SSH (to access system logs, daemon status...)</p>
</li>
<li><p>Docker API (to check running containers and container engine status)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md">shared/connecting.md</a></span></p><div class="remark-slide-number">39 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="terminals">Terminals</h2>
<p>Once in a while, the instructions will say:
<br>"Open a new terminal."</p>
<p>There are multiple ways to do this:</p>
<ul>
<li><p>create a new window or tab on your machine, and SSH into the VM;</p>
</li>
<li><p>use screen or tmux on the VM and open a new window from there.</p>
</li>
</ul>
<p>You are welcome to use the method that you feel the most comfortable with.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md">shared/connecting.md</a></span></p><div class="remark-slide-number">40 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="tmux-cheatsheet">Tmux cheatsheet</h2>
<p><a href="https://en.wikipedia.org/wiki/Tmux">Tmux</a> is a terminal multiplexer like <code class="remark-inline-code">screen</code>.</p>
<p><em>You don't have to use it or even know about it to follow along.
<br>
But some of us like to use it to switch between terminals.
<br>
It has been preinstalled on your workshop nodes.</em></p>
<ul>
<li>Ctrl-b c → creates a new window</li>
<li>Ctrl-b n → go to next window</li>
<li>Ctrl-b p → go to previous window</li>
<li>Ctrl-b " → split window top/bottom</li>
<li>Ctrl-b % → split window left/right</li>
<li>Ctrl-b Alt-1 → rearrange windows in columns</li>
<li>Ctrl-b Alt-2 → rearrange windows in rows</li>
<li>Ctrl-b arrows → navigate to other windows</li>
<li>Ctrl-b d → detach session</li>
<li>tmux attach → reattach to session</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/connecting.md">shared/connecting.md</a></span></p><div class="remark-slide-number">41 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="versions-installed">Versions installed</h2>
<ul>
<li>Kubernetes 1.14.2</li>
<li>Docker Engine 18.09.6</li>
<li>Docker Compose 1.21.1</li>
</ul>
<!-- ##VERSION## -->

<div class="exercise"><ul>
<li>Check all installed versions:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl version</div><div class="remark-code-line">docker version</div><div class="remark-code-line">docker-compose -v</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/versions-k8s.md">k8s/versions-k8s.md</a></span></p><div class="remark-slide-number">42 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="kubernetes-and-docker-compatibility">Kubernetes and Docker compatibility</h2>
<ul>
<li><p>Kubernetes 1.14 validates Docker Engine versions <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.14.md#external-dependencies">up to 18.09</a>
<br>
(the latest version when Kubernetes 1.14 was released)</p>
</li>
<li><p>Kubernetes 1.13 only validates Docker Engine versions <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md#external-dependencies">up to 18.06</a></p>
</li>
<li><p>Is it a problem if I use Kubernetes with a "too recent" Docker Engine?</p>
</li>
</ul><div class="remark-slide-number">43 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content extra-details extra-details hljs-default"><h2 id="kubernetes-and-docker-compatibility">Kubernetes and Docker compatibility</h2>
<ul>
<li><p>Kubernetes 1.14 validates Docker Engine versions <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.14.md#external-dependencies">up to 18.09</a>
<br>
(the latest version when Kubernetes 1.14 was released)</p>
</li>
<li><p>Kubernetes 1.13 only validates Docker Engine versions <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md#external-dependencies">up to 18.06</a></p>
</li>
<li><p>Is it a problem if I use Kubernetes with a "too recent" Docker Engine?</p>
</li>
</ul>
<ul>
<li><p>No!</p>
</li>
<li><p>"Validates" = continuous integration builds with very extensive (and expensive) testing</p>
</li>
<li><p>The Docker API is versioned, and offers strong backward-compatibility</p>
<p>(If a client uses e.g. API v1.25, the Docker Engine will keep behaving the same way)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/versions-k8s.md">k8s/versions-k8s.md</a></span></p><div class="remark-slide-number">44 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/ShippingContainerSFBay.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">45 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-our-sample-application" class="remark-slide-content title hljs-default"><p>Our sample application</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-pre-requirements">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-1">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-kubernetes-concepts">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">46 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="our-sample-application">Our sample application</h1>
<ul>
<li><p>We will clone the GitHub repository onto our <code class="remark-inline-code">node1</code></p>
</li>
<li><p>The repository also contains scripts and tools that we will use through the workshop</p>
</li>
</ul>
<div class="exercise"><!--
```bash
cd ~
if [ -d container.training ]; then
  mv container.training container.training.$RANDOM
fi
```
-->

<ul>
<li>Clone the repository on <code class="remark-inline-code">node1</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">git <span class="hljs-built_in">clone</span> https://github.com/jpetazzo/container.training</div></code></pre>
</li>
</ul>
</div>

<p>(You can also fork the repository on GitHub and clone your fork if you prefer that.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">47 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="downloading-and-running-the-application">Downloading and running the application</h2>
<p>Let's start this before we look around, as downloading will take a little time...</p>
<div class="exercise"><ul>
<li><p>Go to the <code class="remark-inline-code">dockercoins</code> directory, in the cloned repo:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">cd</span> ~/container.training/dockercoins</div></code></pre>
</li>
<li><p>Use Compose to build and run all containers:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker-compose up</div></code></pre>
</li>
</ul>
<!--
```longwait units of work done```
-->

</div>

<p>Compose tells Docker to build all container images (pulling
the corresponding base images), then starts all containers,
and displays aggregated logs.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">48 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-this-application-">What's this application?</h2><div class="remark-slide-number">49 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="what-s-this-application-">What's this application?</h2>
<ul>
<li>It is a DockerCoin miner! <span class="emoji">💰🐳📦🚢</span></li>
</ul><div class="remark-slide-number">50 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="what-s-this-application-">What's this application?</h2>
<ul>
<li><p>It is a DockerCoin miner! <span class="emoji">💰🐳📦🚢</span></p>
</li>
<li><p>No, you can't buy coffee with DockerCoins</p>
</li>
</ul><div class="remark-slide-number">51 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="what-s-this-application-">What's this application?</h2>
<ul>
<li><p>It is a DockerCoin miner! <span class="emoji">💰🐳📦🚢</span></p>
</li>
<li><p>No, you can't buy coffee with DockerCoins</p>
</li>
<li><p>How DockerCoins works:</p>
<ul>
<li><p>generate a few random bytes</p>
</li>
<li><p>hash these bytes</p>
</li>
<li><p>increment a counter (to keep track of speed)</p>
</li>
<li><p>repeat forever!</p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">52 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="what-s-this-application-">What's this application?</h2>
<ul>
<li><p>It is a DockerCoin miner! <span class="emoji">💰🐳📦🚢</span></p>
</li>
<li><p>No, you can't buy coffee with DockerCoins</p>
</li>
<li><p>How DockerCoins works:</p>
<ul>
<li><p>generate a few random bytes</p>
</li>
<li><p>hash these bytes</p>
</li>
<li><p>increment a counter (to keep track of speed)</p>
</li>
<li><p>repeat forever!</p>
</li>
</ul>
</li>
<li><p>DockerCoins is <em>not</em> a cryptocurrency</p>
<p>(the only common points are "randomness", "hashing", and "coins" in the name)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">53 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="dockercoins-in-the-microservices-era">DockerCoins in the microservices era</h2>
<ul>
<li><p>DockerCoins is made of 5 services:</p>
<ul>
<li><p><code class="remark-inline-code">rng</code> = web service generating random bytes</p>
</li>
<li><p><code class="remark-inline-code">hasher</code> = web service computing hash of POSTed data</p>
</li>
<li><p><code class="remark-inline-code">worker</code> = background process calling <code class="remark-inline-code">rng</code> and <code class="remark-inline-code">hasher</code></p>
</li>
<li><p><code class="remark-inline-code">webui</code> = web interface to watch progress</p>
</li>
<li><p><code class="remark-inline-code">redis</code> = data store (holds a counter updated by <code class="remark-inline-code">worker</code>)</p>
</li>
</ul>
</li>
<li><p>These 5 services are visible in the application's Compose file,
<a href="https://github.com/jpetazzo/container.training/blob/master/dockercoins/docker-compose.yml">docker-compose.yml</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">54 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-dockercoins-works">How DockerCoins works</h2>
<ul>
<li><p><code class="remark-inline-code">worker</code> invokes web service <code class="remark-inline-code">rng</code> to generate random bytes</p>
</li>
<li><p><code class="remark-inline-code">worker</code> invokes web service <code class="remark-inline-code">hasher</code> to hash these bytes</p>
</li>
<li><p><code class="remark-inline-code">worker</code> does this in an infinite loop</p>
</li>
<li><p>every second, <code class="remark-inline-code">worker</code> updates <code class="remark-inline-code">redis</code> to indicate how many loops were done</p>
</li>
<li><p><code class="remark-inline-code">webui</code> queries <code class="remark-inline-code">redis</code>, and computes and exposes "hashing speed" in our browser</p>
</li>
</ul>
<p><em>(See diagram on next slide!)</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">55 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/dockercoins-diagram.svg" alt="Diagram showing the 5 containers of the applications"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">56 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="service-discovery-in-container-land">Service discovery in container-land</h2>
<p>How does each service find out the address of the other ones?</p><div class="remark-slide-number">57 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="service-discovery-in-container-land">Service discovery in container-land</h2>
<p>How does each service find out the address of the other ones?</p>
<ul>
<li><p>We do not hard-code IP addresses in the code</p>
</li>
<li><p>We do not hard-code FQDNs in the code, either</p>
</li>
<li><p>We just connect to a service name, and container-magic does the rest</p>
<p>(And by container-magic, we mean "a crafty, dynamic, embedded DNS server")</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">58 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="example-in-worker-worker-py-">Example in <code class="remark-inline-code">worker/worker.py</code></h2>
<pre><code class="python hljs remark-code"><div class="remark-code-line">redis = Redis(<span class="hljs-string">"<span class="remark-code-span-highlighted">redis</span>"</span>)</div><div class="remark-code-line"></div><div class="remark-code-line"></div><div class="remark-code-line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_random_bytes</span><span class="hljs-params">()</span>:</span></div><div class="remark-code-line">    r = requests.get(<span class="hljs-string">"http://<span class="remark-code-span-highlighted">rng</span>/32"</span>)</div><div class="remark-code-line">    <span class="hljs-keyword">return</span> r.content</div><div class="remark-code-line"></div><div class="remark-code-line"></div><div class="remark-code-line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hash_bytes</span><span class="hljs-params">(data)</span>:</span></div><div class="remark-code-line">    r = requests.post(<span class="hljs-string">"http://<span class="remark-code-span-highlighted">hasher</span>/"</span>,</div><div class="remark-code-line">                      data=data,</div><div class="remark-code-line">                      headers={<span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/octet-stream"</span>})</div></code></pre>
<p>(Full source code available <a href="https://github.com/jpetazzo/container.training/blob/8279a3bce9398f7c1a53bdd95187c53eda4e6435/dockercoins/worker/worker.py#L17">here</a>)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">59 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="links-naming-and-service-discovery">Links, naming, and service discovery</h2>
<ul>
<li><p>Containers can have network aliases (resolvable through DNS)</p>
</li>
<li><p>Compose file version 2+ makes each container reachable through its service name</p>
</li>
<li><p>Compose file version 1 required "links" sections to accomplish this</p>
</li>
<li><p>Network aliases are automatically namespaced</p>
<ul>
<li><p>you can have multiple apps declaring and using a service named <code class="remark-inline-code">database</code></p>
</li>
<li><p>containers in the blue app will resolve <code class="remark-inline-code">database</code> to the IP of the blue database</p>
</li>
<li><p>containers in the green app will resolve <code class="remark-inline-code">database</code> to the IP of the green database</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">60 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="show-me-the-code-">Show me the code!</h2>
<ul>
<li><p>You can check the GitHub repository with all the materials of this workshop:
<br><a href="https://github.com/jpetazzo/container.training">https://github.com/jpetazzo/container.training</a></p>
</li>
<li><p>The application is in the <a href="https://github.com/jpetazzo/container.training/tree/master/dockercoins">dockercoins</a>
subdirectory</p>
</li>
<li><p>The Compose file (<a href="https://github.com/jpetazzo/container.training/blob/master/dockercoins/docker-compose.yml">docker-compose.yml</a>)
lists all 5 services</p>
</li>
<li><p><code class="remark-inline-code">redis</code> is using an official image from the Docker Hub</p>
</li>
<li><p><code class="remark-inline-code">hasher</code>, <code class="remark-inline-code">rng</code>, <code class="remark-inline-code">worker</code>, <code class="remark-inline-code">webui</code> are each built from a Dockerfile</p>
</li>
<li><p>Each service's Dockerfile and source code is in its own directory</p>
<p>(<code class="remark-inline-code">hasher</code> is in the <a href="https://github.com/jpetazzo/container.training/blob/master/dockercoins/hasher/">hasher</a> directory,
<code class="remark-inline-code">rng</code> is in the <a href="https://github.com/jpetazzo/container.training/blob/master/dockercoins/rng/">rng</a>
directory, etc.)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">61 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="compose-file-format-version">Compose file format version</h2>
<p><em>This is relevant only if you have used Compose before 2016...</em></p>
<ul>
<li><p>Compose 1.6 introduced support for a new Compose file format (aka "v2")</p>
</li>
<li><p>Services are no longer at the top level, but under a <code class="remark-inline-code">services</code> section</p>
</li>
<li><p>There has to be a <code class="remark-inline-code">version</code> key at the top level, with value <code class="remark-inline-code">"2"</code> (as a string, not an integer)</p>
</li>
<li><p>Containers are placed on a dedicated network, making links unnecessary</p>
</li>
<li><p>There are other minor differences, but upgrade is easy and straightforward</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">62 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-application-at-work">Our application at work</h2>
<ul>
<li><p>On the left-hand side, the "rainbow strip" shows the container names</p>
</li>
<li><p>On the right-hand side, we see the output of our containers</p>
</li>
<li><p>We can see the <code class="remark-inline-code">worker</code> service making requests to <code class="remark-inline-code">rng</code> and <code class="remark-inline-code">hasher</code></p>
</li>
<li><p>For <code class="remark-inline-code">rng</code> and <code class="remark-inline-code">hasher</code>, we see HTTP access logs</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">63 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="connecting-to-the-web-ui">Connecting to the web UI</h2>
<ul>
<li><p>"Logs are exciting and fun!" (No-one, ever)</p>
</li>
<li><p>The <code class="remark-inline-code">webui</code> container exposes a web dashboard; let's view it</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>With a web browser, connect to <code class="remark-inline-code">node1</code> on port 8000</p>
</li>
<li><p>Remember: the <code class="remark-inline-code">nodeX</code> aliases are valid only on the nodes themselves</p>
</li>
<li><p>In your browser, you need to enter the IP address of your node</p>
</li>
</ul>
<!-- ```open http://node1:8000``` -->

</div>

<p>A drawing area should show up, and after a few seconds, a blue
graph will appear.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">64 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="why-does-the-speed-seem-irregular-">Why does the speed seem irregular?</h2>
<ul>
<li><p>It <em>looks like</em> the speed is approximately 4 hashes/second</p>
</li>
<li><p>Or more precisely: 4 hashes/second, with regular dips down to zero</p>
</li>
<li><p>Why?</p>
</li>
</ul><div class="remark-slide-number">65 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content extra-details extra-details hljs-default"><h2 id="why-does-the-speed-seem-irregular-">Why does the speed seem irregular?</h2>
<ul>
<li><p>It <em>looks like</em> the speed is approximately 4 hashes/second</p>
</li>
<li><p>Or more precisely: 4 hashes/second, with regular dips down to zero</p>
</li>
<li><p>Why?</p>
</li>
</ul>
<ul>
<li><p>The app actually has a constant, steady speed: 3.33 hashes/second
<br>
(which corresponds to 1 hash every 0.3 seconds, for <em>reasons</em>)</p>
</li>
<li><p>Yes, and?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">66 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="the-reason-why-this-graph-is-not-awesome-">The reason why this graph is <em>not awesome</em></h2>
<ul>
<li><p>The worker doesn't update the counter after every loop, but up to once per second</p>
</li>
<li><p>The speed is computed by the browser, checking the counter about once per second</p>
</li>
<li><p>Between two consecutive updates, the counter will increase either by 4, or by 0</p>
</li>
<li><p>The perceived speed will therefore be 4 - 4 - 4 - 0 - 4 - 4 - 0 etc.</p>
</li>
<li><p>What can we conclude from this?</p>
</li>
</ul><div class="remark-slide-number">67 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content extra-details extra-details hljs-default"><h2 id="the-reason-why-this-graph-is-not-awesome-">The reason why this graph is <em>not awesome</em></h2>
<ul>
<li><p>The worker doesn't update the counter after every loop, but up to once per second</p>
</li>
<li><p>The speed is computed by the browser, checking the counter about once per second</p>
</li>
<li><p>Between two consecutive updates, the counter will increase either by 4, or by 0</p>
</li>
<li><p>The perceived speed will therefore be 4 - 4 - 4 - 0 - 4 - 4 - 0 etc.</p>
</li>
<li><p>What can we conclude from this?</p>
</li>
</ul>
<ul>
<li>"I'm clearly incapable of writing good frontend code!" 😀 — Jérôme</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">68 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="stopping-the-application">Stopping the application</h2>
<ul>
<li><p>If we interrupt Compose (with <code class="remark-inline-code">^C</code>), it will politely ask the Docker Engine to stop the app</p>
</li>
<li><p>The Docker Engine will send a <code class="remark-inline-code">TERM</code> signal to the containers</p>
</li>
<li><p>If the containers do not exit in a timely manner, the Engine sends a <code class="remark-inline-code">KILL</code> signal</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Stop the application by hitting <code class="remark-inline-code">^C</code></li>
</ul>
<!--
```keys ^C```
-->

</div><div class="remark-slide-number">69 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="stopping-the-application">Stopping the application</h2>
<ul>
<li><p>If we interrupt Compose (with <code class="remark-inline-code">^C</code>), it will politely ask the Docker Engine to stop the app</p>
</li>
<li><p>The Docker Engine will send a <code class="remark-inline-code">TERM</code> signal to the containers</p>
</li>
<li><p>If the containers do not exit in a timely manner, the Engine sends a <code class="remark-inline-code">KILL</code> signal</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Stop the application by hitting <code class="remark-inline-code">^C</code></li>
</ul>
<!--
```keys ^C```
-->

</div>

<p>Some containers exit immediately, others take longer.</p>
<p>The containers that do not handle <code class="remark-inline-code">SIGTERM</code> end up being killed after a 10s timeout. If we are very impatient, we can hit <code class="remark-inline-code">^C</code> a second time!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/sampleapp.md">shared/sampleapp.md</a></span></p><div class="remark-slide-number">70 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="clean-up">Clean up</h2>
<ul>
<li>Before moving on, let's remove those containers</li>
</ul>
<div class="exercise"><ul>
<li>Tell Compose to remove everything:<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker-compose down</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/composedown.md">shared/composedown.md</a></span></p><div class="remark-slide-number">71 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/aerial-view-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">72 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-kubernetes-concepts" class="remark-slide-content title hljs-default"><p>Kubernetes concepts</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-our-sample-application">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-1">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-declarative-vs-imperative">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">73 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="kubernetes-concepts">Kubernetes concepts</h1>
<ul>
<li><p>Kubernetes is a container management system</p>
</li>
<li><p>It runs and manages containerized applications on a cluster</p>
</li>
</ul><div class="remark-slide-number">74 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="kubernetes-concepts">Kubernetes concepts</h1>
<ul>
<li><p>Kubernetes is a container management system</p>
</li>
<li><p>It runs and manages containerized applications on a cluster</p>
</li>
<li><p>What does that really mean?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">75 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2><div class="remark-slide-number">76 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2>
<ul>
<li>Start 5 containers using image <code class="remark-inline-code">atseashop/api:v1.3</code></li>
</ul><div class="remark-slide-number">77 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2>
<ul>
<li><p>Start 5 containers using image <code class="remark-inline-code">atseashop/api:v1.3</code></p>
</li>
<li><p>Place an internal load balancer in front of these containers</p>
</li>
</ul><div class="remark-slide-number">78 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2>
<ul>
<li><p>Start 5 containers using image <code class="remark-inline-code">atseashop/api:v1.3</code></p>
</li>
<li><p>Place an internal load balancer in front of these containers</p>
</li>
<li><p>Start 10 containers using image <code class="remark-inline-code">atseashop/webfront:v1.3</code></p>
</li>
</ul><div class="remark-slide-number">79 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2>
<ul>
<li><p>Start 5 containers using image <code class="remark-inline-code">atseashop/api:v1.3</code></p>
</li>
<li><p>Place an internal load balancer in front of these containers</p>
</li>
<li><p>Start 10 containers using image <code class="remark-inline-code">atseashop/webfront:v1.3</code></p>
</li>
<li><p>Place a public load balancer in front of these containers</p>
</li>
</ul><div class="remark-slide-number">80 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2>
<ul>
<li><p>Start 5 containers using image <code class="remark-inline-code">atseashop/api:v1.3</code></p>
</li>
<li><p>Place an internal load balancer in front of these containers</p>
</li>
<li><p>Start 10 containers using image <code class="remark-inline-code">atseashop/webfront:v1.3</code></p>
</li>
<li><p>Place a public load balancer in front of these containers</p>
</li>
<li><p>It's Black Friday (or Christmas), traffic spikes, grow our cluster and add containers</p>
</li>
</ul><div class="remark-slide-number">81 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2>
<ul>
<li><p>Start 5 containers using image <code class="remark-inline-code">atseashop/api:v1.3</code></p>
</li>
<li><p>Place an internal load balancer in front of these containers</p>
</li>
<li><p>Start 10 containers using image <code class="remark-inline-code">atseashop/webfront:v1.3</code></p>
</li>
<li><p>Place a public load balancer in front of these containers</p>
</li>
<li><p>It's Black Friday (or Christmas), traffic spikes, grow our cluster and add containers</p>
</li>
<li><p>New release! Replace my containers with the new image <code class="remark-inline-code">atseashop/webfront:v1.4</code></p>
</li>
</ul><div class="remark-slide-number">82 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="basic-things-we-can-ask-kubernetes-to-do">Basic things we can ask Kubernetes to do</h2>
<ul>
<li><p>Start 5 containers using image <code class="remark-inline-code">atseashop/api:v1.3</code></p>
</li>
<li><p>Place an internal load balancer in front of these containers</p>
</li>
<li><p>Start 10 containers using image <code class="remark-inline-code">atseashop/webfront:v1.3</code></p>
</li>
<li><p>Place a public load balancer in front of these containers</p>
</li>
<li><p>It's Black Friday (or Christmas), traffic spikes, grow our cluster and add containers</p>
</li>
<li><p>New release! Replace my containers with the new image <code class="remark-inline-code">atseashop/webfront:v1.4</code></p>
</li>
<li><p>Keep processing requests during the upgrade; update my containers one at a time</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">83 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="other-things-that-kubernetes-can-do-for-us">Other things that Kubernetes can do for us</h2>
<ul>
<li><p>Basic autoscaling</p>
</li>
<li><p>Blue/green deployment, canary deployment</p>
</li>
<li><p>Long running services, but also batch (one-off) jobs</p>
</li>
<li><p>Overcommit our cluster and <em>evict</em> low-priority jobs</p>
</li>
<li><p>Run services with <em>stateful</em> data (databases etc.)</p>
</li>
<li><p>Fine-grained access control defining <em>what</em> can be done by <em>whom</em> on <em>which</em> resources</p>
</li>
<li><p>Integrating third party services (<em>service catalog</em>)</p>
</li>
<li><p>Automating complex tasks (<em>operators</em>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">84 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-architecture">Kubernetes architecture</h2>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">85 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/k8s-arch1.png" alt="haha only kidding"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">86 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-architecture">Kubernetes architecture</h2>
<ul>
<li><p>Ha ha ha ha</p>
</li>
<li><p>OK, I was trying to scare you, it's much simpler than that ❤️</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">87 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/k8s-arch2.png" alt="that one is more like the real thing"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">88 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="credits">Credits</h2>
<ul>
<li><p>The first schema is a Kubernetes cluster with storage backed by multi-path iSCSI</p>
<p>(Courtesy of <a href="https://www.yongbok.net/blog/">Yongbok Kim</a>)</p>
</li>
<li><p>The second one is a simplified representation of a Kubernetes cluster</p>
<p>(Courtesy of <a href="https://medium.com/containermind/a-reference-architecture-for-deploying-wso2-middleware-on-kubernetes-d4dee7601e8e">Imesh Gunaratne</a>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">89 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-architecture-the-nodes">Kubernetes architecture: the nodes</h2>
<ul>
<li><p>The nodes executing our containers run a collection of services:</p>
<ul>
<li><p>a container Engine (typically Docker)</p>
</li>
<li><p>kubelet (the "node agent")</p>
</li>
<li><p>kube-proxy (a necessary but not sufficient network component)</p>
</li>
</ul>
</li>
<li><p>Nodes were formerly called "minions"</p>
<p>(You might see that word in older articles or documentation)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">90 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-architecture-the-control-plane">Kubernetes architecture: the control plane</h2>
<ul>
<li><p>The Kubernetes logic (its "brains") is a collection of services:</p>
<ul>
<li><p>the API server (our point of entry to everything!)</p>
</li>
<li><p>core services like the scheduler and controller manager</p>
</li>
<li><p><code class="remark-inline-code">etcd</code> (a highly available key/value store; the "database" of Kubernetes)</p>
</li>
</ul>
</li>
<li><p>Together, these services form the control plane of our cluster</p>
</li>
<li><p>The control plane is also called the "master"</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">91 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/k8s-arch4-thanks-luxas.png" alt="One of the best Kubernetes architecture diagrams available"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">92 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="running-the-control-plane-on-special-nodes">Running the control plane on special nodes</h2>
<ul>
<li><p>It is common to reserve a dedicated node for the control plane</p>
<p>(Except for single-node development clusters, like when using minikube)</p>
</li>
<li><p>This node is then called a "master"</p>
<p>(Yes, this is ambiguous: is the "master" a node, or the whole control plane?)</p>
</li>
<li><p>Normal applications are restricted from running on this node</p>
<p>(By using a mechanism called <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/">"taints"</a>)</p>
</li>
<li><p>When high availability is required, each service of the control plane must be resilient</p>
</li>
<li><p>The control plane is then replicated on multiple nodes</p>
<p>(This is sometimes called a "multi-master" setup)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">93 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="running-the-control-plane-outside-containers">Running the control plane outside containers</h2>
<ul>
<li><p>The services of the control plane can run in or out of containers</p>
</li>
<li><p>For instance: since <code class="remark-inline-code">etcd</code> is a critical service, some people
deploy it directly on a dedicated cluster (without containers)</p>
<p>(This is illustrated on the first "super complicated" schema)</p>
</li>
<li><p>In some hosted Kubernetes offerings (e.g. AKS, GKE, EKS), the control plane is invisible</p>
<p>(We only "see" a Kubernetes API endpoint)</p>
</li>
<li><p>In that case, there is no "master node"</p>
</li>
</ul>
<p><em>For this reason, it is more accurate to say "control plane" rather than "master."</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">94 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="do-we-need-to-run-docker-at-all-">Do we need to run Docker at all?</h2>
<p>No!</p><div class="remark-slide-number">95 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content extra-details hljs-default"><h2 id="do-we-need-to-run-docker-at-all-">Do we need to run Docker at all?</h2>
<p>No!</p>
<ul>
<li><p>By default, Kubernetes uses the Docker Engine to run containers</p>
</li>
<li><p>We could also use <code class="remark-inline-code">rkt</code> ("Rocket") from CoreOS</p>
</li>
<li><p>Or leverage other pluggable runtimes through the <em>Container Runtime Interface</em></p>
<p>(like CRI-O, or containerd)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">96 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="do-we-need-to-run-docker-at-all-">Do we need to run Docker at all?</h2>
<p>Yes!</p><div class="remark-slide-number">97 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content extra-details hljs-default"><h2 id="do-we-need-to-run-docker-at-all-">Do we need to run Docker at all?</h2>
<p>Yes!</p>
<ul>
<li><p>In this workshop, we run our app on a single node first</p>
</li>
<li><p>We will need to build images and ship them around</p>
</li>
<li><p>We can do these things without Docker
<br>
(and get diagnosed with NIH¹ syndrome)</p>
</li>
<li><p>Docker is still the most stable container engine today
<br>
(but other options are maturing very quickly)</p>
</li>
</ul>
<p><span class="footnote">¹<a href="https://en.wikipedia.org/wiki/Not_invented_here">Not Invented Here</a></span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">98 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="do-we-need-to-run-docker-at-all-">Do we need to run Docker at all?</h2>
<ul>
<li><p>On our development environments, CI pipelines ... :</p>
<p><em>Yes, almost certainly</em></p>
</li>
<li><p>On our production servers:</p>
<p><em>Yes (today)</em></p>
<p><em>Probably not (in the future)</em></p>
</li>
</ul>
<p><span class="footnote">More information about CRI <a href="https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes">on the Kubernetes blog</a></span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">99 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="interacting-with-kubernetes">Interacting with Kubernetes</h2>
<ul>
<li><p>We will interact with our Kubernetes cluster through the Kubernetes API</p>
</li>
<li><p>The Kubernetes API is (mostly) RESTful</p>
</li>
<li><p>It allows us to create, read, update, delete <em>resources</em></p>
</li>
<li><p>A few common resource types are:</p>
<ul>
<li><p>node (a machine — physical or virtual — in our cluster)</p>
</li>
<li><p>pod (group of containers running together on a node)</p>
</li>
<li><p>service (stable network endpoint to connect to one or multiple containers)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">100 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/k8s-arch3-thanks-weave.png" alt="Node, pod, container"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">101 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="credits">Credits</h2>
<ul>
<li><p>The first diagram is courtesy of Lucas Käldström, in <a href="https://speakerdeck.com/luxas/kubeadm-cluster-creation-internals-from-self-hosting-to-upgradability-and-ha">this presentation</a></p>
<ul>
<li>it's one of the best Kubernetes architecture diagrams available!</li>
</ul>
</li>
<li><p>The second diagram is courtesy of Weave Works</p>
<ul>
<li><p>a <em>pod</em> can have multiple containers working together</p>
</li>
<li><p>IP addresses are associated with <em>pods</em>, not with individual containers</p>
</li>
</ul>
</li>
</ul>
<p>Both diagrams used with permission.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/concepts-k8s.md">k8s/concepts-k8s.md</a></span></p><div class="remark-slide-number">102 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/blue-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">103 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-declarative-vs-imperative" class="remark-slide-content title hljs-default"><p>Declarative vs imperative</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-concepts">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-1">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-kubernetes-network-model">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">104 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="declarative-vs-imperative">Declarative vs imperative</h1>
<ul>
<li><p>Our container orchestrator puts a very strong emphasis on being <em>declarative</em></p>
</li>
<li><p>Declarative:</p>
<p><em>I would like a cup of tea.</em></p>
</li>
<li><p>Imperative:</p>
<p><em>Boil some water. Pour it in a teapot. Add tea leaves. Steep for a while. Serve in a cup.</em></p>
</li>
</ul><div class="remark-slide-number">105 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="declarative-vs-imperative">Declarative vs imperative</h1>
<ul>
<li><p>Our container orchestrator puts a very strong emphasis on being <em>declarative</em></p>
</li>
<li><p>Declarative:</p>
<p><em>I would like a cup of tea.</em></p>
</li>
<li><p>Imperative:</p>
<p><em>Boil some water. Pour it in a teapot. Add tea leaves. Steep for a while. Serve in a cup.</em></p>
</li>
<li><p>Declarative seems simpler at first ... </p>
</li>
</ul><div class="remark-slide-number">106 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="declarative-vs-imperative">Declarative vs imperative</h1>
<ul>
<li><p>Our container orchestrator puts a very strong emphasis on being <em>declarative</em></p>
</li>
<li><p>Declarative:</p>
<p><em>I would like a cup of tea.</em></p>
</li>
<li><p>Imperative:</p>
<p><em>Boil some water. Pour it in a teapot. Add tea leaves. Steep for a while. Serve in a cup.</em></p>
</li>
<li><p>Declarative seems simpler at first ... </p>
</li>
<li><p>... As long as you know how to brew tea</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/declarative.md">shared/declarative.md</a></span></p><div class="remark-slide-number">107 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="declarative-vs-imperative">Declarative vs imperative</h2>
<ul>
<li><p>What declarative would really be:</p>
<p><em>I want a cup of tea, obtained by pouring an infusion¹ of tea leaves in a cup.</em></p>
</li>
</ul><div class="remark-slide-number">108 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="declarative-vs-imperative">Declarative vs imperative</h2>
<ul>
<li><p>What declarative would really be:</p>
<p><em>I want a cup of tea, obtained by pouring an infusion¹ of tea leaves in a cup.</em></p>
<p><em>¹An infusion is obtained by letting the object steep a few minutes in hot² water.</em></p>
</li>
</ul><div class="remark-slide-number">109 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="declarative-vs-imperative">Declarative vs imperative</h2>
<ul>
<li><p>What declarative would really be:</p>
<p><em>I want a cup of tea, obtained by pouring an infusion¹ of tea leaves in a cup.</em></p>
<p><em>¹An infusion is obtained by letting the object steep a few minutes in hot² water.</em></p>
<p><em>²Hot liquid is obtained by pouring it in an appropriate container³ and setting it on a stove.</em></p>
</li>
</ul><div class="remark-slide-number">110 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="declarative-vs-imperative">Declarative vs imperative</h2>
<ul>
<li><p>What declarative would really be:</p>
<p><em>I want a cup of tea, obtained by pouring an infusion¹ of tea leaves in a cup.</em></p>
<p><em>¹An infusion is obtained by letting the object steep a few minutes in hot² water.</em></p>
<p><em>²Hot liquid is obtained by pouring it in an appropriate container³ and setting it on a stove.</em></p>
<p><em>³Ah, finally, containers! Something we know about. Let's get to work, shall we?</em></p>
</li>
</ul><div class="remark-slide-number">111 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="declarative-vs-imperative">Declarative vs imperative</h2>
<ul>
<li><p>What declarative would really be:</p>
<p><em>I want a cup of tea, obtained by pouring an infusion¹ of tea leaves in a cup.</em></p>
<p><em>¹An infusion is obtained by letting the object steep a few minutes in hot² water.</em></p>
<p><em>²Hot liquid is obtained by pouring it in an appropriate container³ and setting it on a stove.</em></p>
<p><em>³Ah, finally, containers! Something we know about. Let's get to work, shall we?</em></p>
</li>
</ul>
<div class="footnote"><p>Did you know there was an <a href="https://en.wikipedia.org/wiki/ISO_3103">ISO standard</a>
specifying how to brew tea?</p>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/declarative.md">shared/declarative.md</a></span></p><div class="remark-slide-number">112 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="declarative-vs-imperative">Declarative vs imperative</h2>
<ul>
<li><p>Imperative systems:</p>
<ul>
<li><p>simpler</p>
</li>
<li><p>if a task is interrupted, we have to restart from scratch</p>
</li>
</ul>
</li>
<li><p>Declarative systems:</p>
<ul>
<li><p>if a task is interrupted (or if we show up to the party half-way through),
we can figure out what's missing and do only what's necessary</p>
</li>
<li><p>we need to be able to <em>observe</em> the system</p>
</li>
<li><p>... and compute a "diff" between <em>what we have</em> and <em>what we want</em></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/declarative.md">shared/declarative.md</a></span></p><div class="remark-slide-number">113 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="declarative-vs-imperative-in-kubernetes">Declarative vs imperative in Kubernetes</h2>
<ul>
<li><p>With Kubernetes, we cannot say: "run this container"</p>
</li>
<li><p>All we can do is write a <em>spec</em> and push it to the API server</p>
<p>(by creating a resource like e.g. a Pod or a Deployment)</p>
</li>
<li><p>The API server will validate that spec (and reject it if it's invalid)</p>
</li>
<li><p>Then it will store it in etcd</p>
</li>
<li><p>A <em>controller</em> will "notice" that spec and act upon it</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/declarative.md">k8s/declarative.md</a></span></p><div class="remark-slide-number">114 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="reconciling-state">Reconciling state</h2>
<ul>
<li><p>Watch for the <code class="remark-inline-code">spec</code> fields in the YAML files later!</p>
</li>
<li><p>The <em>spec</em> describes <em>how we want the thing to be</em></p>
</li>
<li><p>Kubernetes will <em>reconcile</em> the current state with the spec
<br>(technically, this is done by a number of <em>controllers</em>)</p>
</li>
<li><p>When we want to change some resource, we update the <em>spec</em></p>
</li>
<li><p>Kubernetes will then <em>converge</em> that resource</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/declarative.md">k8s/declarative.md</a></span></p><div class="remark-slide-number">115 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/chinook-helicopter-container.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">116 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-kubernetes-network-model" class="remark-slide-content title hljs-default"><p>Kubernetes network model</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-declarative-vs-imperative">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-1">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-first-contact-with-kubectl">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">117 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="kubernetes-network-model">Kubernetes network model</h1>
<ul>
<li><p>TL,DR:</p>
<p><em>Our cluster (nodes and pods) is one big flat IP network.</em></p>
</li>
</ul><div class="remark-slide-number">118 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="kubernetes-network-model">Kubernetes network model</h1>
<ul>
<li><p>TL,DR:</p>
<p><em>Our cluster (nodes and pods) is one big flat IP network.</em></p>
</li>
<li><p>In detail:</p>
<ul>
<li><p>all nodes must be able to reach each other, without NAT</p>
</li>
<li><p>all pods must be able to reach each other, without NAT</p>
</li>
<li><p>pods and nodes must be able to reach each other, without NAT</p>
</li>
<li><p>each pod is aware of its IP address (no NAT)</p>
</li>
<li><p>pod IP addresses are assigned by the network implementation</p>
</li>
</ul>
</li>
<li><p>Kubernetes doesn't mandate any particular implementation</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md">k8s/kubenet.md</a></span></p><div class="remark-slide-number">119 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-network-model-the-good">Kubernetes network model: the good</h2>
<ul>
<li><p>Everything can reach everything</p>
</li>
<li><p>No address translation</p>
</li>
<li><p>No port translation</p>
</li>
<li><p>No new protocol</p>
</li>
<li><p>The network implementation can decide how to allocate addresses</p>
</li>
<li><p>IP addresses don't have to be "portable" from a node to another</p>
<p>(We can use e.g. a subnet per node and use a simple routed topology)</p>
</li>
<li><p>The specification is simple enough to allow many various implementations</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md">k8s/kubenet.md</a></span></p><div class="remark-slide-number">120 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-network-model-the-less-good">Kubernetes network model: the less good</h2>
<ul>
<li><p>Everything can reach everything</p>
<ul>
<li><p>if you want security, you need to add network policies</p>
</li>
<li><p>the network implementation that you use needs to support them</p>
</li>
</ul>
</li>
<li><p>There are literally dozens of implementations out there</p>
<p>(15 are listed in the Kubernetes documentation)</p>
</li>
<li><p>Pods have level 3 (IP) connectivity, but <em>services</em> are level 4 (TCP or UDP)</p>
<p>(Services map to a single UDP or TCP port; no port ranges or arbitrary IP packets)</p>
</li>
<li><p><code class="remark-inline-code">kube-proxy</code> is on the data path when connecting to a pod or container,
<br>and it's not particularly fast (relies on userland proxying or iptables)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md">k8s/kubenet.md</a></span></p><div class="remark-slide-number">121 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-network-model-in-practice">Kubernetes network model: in practice</h2>
<ul>
<li><p>The nodes that we are using have been set up to use <a href="https://github.com/weaveworks/weave">Weave</a></p>
</li>
<li><p>We don't endorse Weave in a particular way, it just Works For Us</p>
</li>
<li><p>Don't worry about the warning about <code class="remark-inline-code">kube-proxy</code> performance</p>
</li>
<li><p>Unless you:</p>
<ul>
<li>routinely saturate 10G network interfaces</li>
<li>count packet rates in millions per second</li>
<li>run high-traffic VOIP or gaming platforms</li>
<li>do weird things that involve millions of simultaneous connections
<br>(in which case you're already familiar with kernel tuning)</li>
</ul>
</li>
<li><p>If necessary, there are alternatives to <code class="remark-inline-code">kube-proxy</code>; e.g.
<a href="https://www.kube-router.io/"><code class="remark-inline-code">kube-router</code></a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md">k8s/kubenet.md</a></span></p><div class="remark-slide-number">122 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="the-container-network-interface-cni-">The Container Network Interface (CNI)</h2>
<ul>
<li><p>Most Kubernetes clusters use CNI "plugins" to implement networking</p>
</li>
<li><p>When a pod is created, Kubernetes delegates the network setup to these plugins</p>
<p>(it can be a single plugin, or a combination of plugins, each doing one task)</p>
</li>
<li><p>Typically, CNI plugins will:</p>
<ul>
<li><p>allocate an IP address (by calling an IPAM plugin)</p>
</li>
<li><p>add a network interface into the pod's network namespace</p>
</li>
<li><p>configure the interface as well as required routes etc.</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md">k8s/kubenet.md</a></span></p><div class="remark-slide-number">123 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="multiple-moving-parts">Multiple moving parts</h2>
<ul>
<li><p>The "pod-to-pod network" or "pod network":</p>
<ul>
<li><p>provides communication between pods and nodes</p>
</li>
<li><p>is generally implemented with CNI plugins</p>
</li>
</ul>
</li>
<li><p>The "pod-to-service network":</p>
<ul>
<li><p>provides internal communication and load balancing</p>
</li>
<li><p>is generally implemented with kube-proxy (or e.g. kube-router)</p>
</li>
</ul>
</li>
<li><p>Network policies:</p>
<ul>
<li><p>provide firewalling and isolation</p>
</li>
<li><p>can be bundled with the "pod network" or provided by another component</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md">k8s/kubenet.md</a></span></p><div class="remark-slide-number">124 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="even-more-moving-parts">Even more moving parts</h2>
<ul>
<li><p>Inbound traffic can be handled by multiple components:</p>
<ul>
<li><p>something like kube-proxy or kube-router (for NodePort services)</p>
</li>
<li><p>load balancers (ideally, connected to the pod network)</p>
</li>
</ul>
</li>
<li><p>It is possible to use multiple pod networks in parallel</p>
<p>(with "meta-plugins" like CNI-Genie or Multus)</p>
</li>
<li><p>Some solutions can fill multiple roles</p>
<p>(e.g. kube-router can be set up to provide the pod network and/or network policies and/or replace kube-proxy)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubenet.md">k8s/kubenet.md</a></span></p><div class="remark-slide-number">125 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-cranes.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">126 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-first-contact-with-kubectl" class="remark-slide-content title hljs-default"><p>First contact with <code class="remark-inline-code">kubectl</code></p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-network-model">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-2">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-setting-up-kubernetes">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">127 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="first-contact-with-kubectl-">First contact with <code class="remark-inline-code">kubectl</code></h1>
<ul>
<li><p><code class="remark-inline-code">kubectl</code> is (almost) the only tool we'll need to talk to Kubernetes</p>
</li>
<li><p>It is a rich CLI tool around the Kubernetes API</p>
<p>(Everything you can do with <code class="remark-inline-code">kubectl</code>, you can do directly with the API)</p>
</li>
<li><p>On our machines, there is a <code class="remark-inline-code">~/.kube/config</code> file with:</p>
<ul>
<li><p>the Kubernetes API address</p>
</li>
<li><p>the path to our TLS certificates used to authenticate</p>
</li>
</ul>
</li>
<li><p>You can also use the <code class="remark-inline-code">--kubeconfig</code> flag to pass a config file</p>
</li>
<li><p>Or directly <code class="remark-inline-code">--server</code>, <code class="remark-inline-code">--user</code>, etc.</p>
</li>
<li><p><code class="remark-inline-code">kubectl</code> can be pronounced "Cube C T L", "Cube cuttle", "Cube cuddle"...</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">128 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-get-"><code class="remark-inline-code">kubectl get</code></h2>
<ul>
<li>Let's look at our <code class="remark-inline-code">Node</code> resources with <code class="remark-inline-code">kubectl get</code>!</li>
</ul>
<div class="exercise"><ul>
<li><p>Look at the composition of our cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get node</div></code></pre>
</li>
<li><p>These commands are equivalent:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get no</div><div class="remark-code-line">kubectl get node</div><div class="remark-code-line">kubectl get nodes</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">129 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="obtaining-machine-readable-output">Obtaining machine-readable output</h2>
<ul>
<li><code class="remark-inline-code">kubectl get</code> can output JSON, YAML, or be directly formatted</li>
</ul>
<div class="exercise"><ul>
<li><p>Give us more info about the nodes:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes -o wide</div></code></pre>
</li>
<li><p>Let's have some YAML:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get no -o yaml</div></code></pre>
<p>See that <code class="remark-inline-code">kind: List</code> at the end? It's the type of our result!</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">130 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-ab-using-kubectl-and-jq-">(Ab)using <code class="remark-inline-code">kubectl</code> and <code class="remark-inline-code">jq</code></h2>
<ul>
<li>It's super easy to build custom reports</li>
</ul>
<div class="exercise"><ul>
<li>Show the capacity of all our nodes as a stream of JSON objects:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes -o json | </div><div class="remark-code-line">        jq <span class="hljs-string">".items[] | {name:.metadata.name} + .status.capacity"</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">131 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="exploring-types-and-definitions">Exploring types and definitions</h2>
<ul>
<li><p>We can list all available resource types by running <code class="remark-inline-code">kubectl api-resources</code>
<br>
(In Kubernetes 1.10 and prior, this command used to be <code class="remark-inline-code">kubectl get</code>)</p>
</li>
<li><p>We can view the definition for a resource type with:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl explain <span class="hljs-built_in">type</span></div></code></pre>
</li>
<li><p>We can view the definition of a field in a resource, for instance:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl explain node.spec</div></code></pre>
</li>
<li><p>Or get the full definition of all fields and sub-fields:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl explain node --recursive</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">132 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="introspection-vs-documentation">Introspection vs. documentation</h2>
<ul>
<li><p>We can access the same information by reading the <a href="https://kubernetes.io/docs/reference/#api-reference">API documentation</a></p>
</li>
<li><p>The API documentation is usually easier to read, but:</p>
<ul>
<li><p>it won't show custom types (like Custom Resource Definitions)</p>
</li>
<li><p>we need to make sure that we look at the correct version</p>
</li>
</ul>
</li>
<li><p><code class="remark-inline-code">kubectl api-resources</code> and <code class="remark-inline-code">kubectl explain</code> perform <em>introspection</em></p>
<p>(they communicate with the API server and obtain the exact type definitions)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">133 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="type-names">Type names</h2>
<ul>
<li><p>The most common resource names have three forms:</p>
<ul>
<li><p>singular (e.g. <code class="remark-inline-code">node</code>, <code class="remark-inline-code">service</code>, <code class="remark-inline-code">deployment</code>)</p>
</li>
<li><p>plural (e.g. <code class="remark-inline-code">nodes</code>, <code class="remark-inline-code">services</code>, <code class="remark-inline-code">deployments</code>)</p>
</li>
<li><p>short (e.g. <code class="remark-inline-code">no</code>, <code class="remark-inline-code">svc</code>, <code class="remark-inline-code">deploy</code>)</p>
</li>
</ul>
</li>
<li><p>Some resources do not have a short name</p>
</li>
<li><p><code class="remark-inline-code">Endpoints</code> only have a plural form</p>
<p>(because even a single <code class="remark-inline-code">Endpoints</code> resource is actually a list of endpoints)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">134 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="viewing-details">Viewing details</h2>
<ul>
<li><p>We can use <code class="remark-inline-code">kubectl get -o yaml</code> to see all available details</p>
</li>
<li><p>However, YAML output is often simultaneously too much and not enough</p>
</li>
<li><p>For instance, <code class="remark-inline-code">kubectl get node node1 -o yaml</code> is:</p>
<ul>
<li><p>too much information (e.g.: list of images available on this node)</p>
</li>
<li><p>not enough information (e.g.: doesn't show pods running on this node)</p>
</li>
<li><p>difficult to read for a human operator</p>
</li>
</ul>
</li>
<li><p>For a comprehensive overview, we can use <code class="remark-inline-code">kubectl describe</code> instead</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">135 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-describe-"><code class="remark-inline-code">kubectl describe</code></h2>
<ul>
<li><p><code class="remark-inline-code">kubectl describe</code> needs a resource type and (optionally) a resource name</p>
</li>
<li><p>It is possible to provide a resource name <em>prefix</em></p>
<p>(all matching objects will be displayed)</p>
</li>
<li><p><code class="remark-inline-code">kubectl describe</code> will retrieve some extra information about the resource</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Look at the information available for <code class="remark-inline-code">node1</code> with one of the following commands:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl describe node/node1</div><div class="remark-code-line">kubectl describe node node1</div></code></pre>
</li>
</ul>
</div>

<p>(We should notice a bunch of control plane pods.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">136 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="services">Services</h2>
<ul>
<li><p>A <em>service</em> is a stable endpoint to connect to "something"</p>
<p>(In the initial proposal, they were called "portals")</p>
</li>
</ul>
<div class="exercise"><ul>
<li>List the services on our cluster with one of these commands:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get services</div><div class="remark-code-line">kubectl get svc</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">137 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="services">Services</h2>
<ul>
<li><p>A <em>service</em> is a stable endpoint to connect to "something"</p>
<p>(In the initial proposal, they were called "portals")</p>
</li>
</ul>
<div class="exercise"><ul>
<li>List the services on our cluster with one of these commands:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get services</div><div class="remark-code-line">kubectl get svc</div></code></pre>
</li>
</ul>
</div>

<p>There is already one service on our cluster: the Kubernetes API itself.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">138 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="clusterip-services">ClusterIP services</h2>
<ul>
<li><p>A <code class="remark-inline-code">ClusterIP</code> service is internal, available from the cluster only</p>
</li>
<li><p>This is useful for introspection from within containers</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Try to connect to the API:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k https://<span class="remark-code-span-highlighted">10.96.0.1</span></div></code></pre>
<ul>
<li><p><code class="remark-inline-code">-k</code> is used to skip certificate verification</p>
</li>
<li><p>Make sure to replace 10.96.0.1 with the CLUSTER-IP shown by <code class="remark-inline-code">kubectl get svc</code></p>
</li>
</ul>
</li>
</ul>
</div><div class="remark-slide-number">139 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="clusterip-services">ClusterIP services</h2>
<ul>
<li><p>A <code class="remark-inline-code">ClusterIP</code> service is internal, available from the cluster only</p>
</li>
<li><p>This is useful for introspection from within containers</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Try to connect to the API:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k https://<span class="remark-code-span-highlighted">10.96.0.1</span></div></code></pre>
<ul>
<li><p><code class="remark-inline-code">-k</code> is used to skip certificate verification</p>
</li>
<li><p>Make sure to replace 10.96.0.1 with the CLUSTER-IP shown by <code class="remark-inline-code">kubectl get svc</code></p>
</li>
</ul>
</li>
</ul>
</div>

<p>The error that we see is expected: the Kubernetes API requires authentication.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">140 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="listing-running-containers">Listing running containers</h2>
<ul>
<li><p>Containers are manipulated through <em>pods</em></p>
</li>
<li><p>A pod is a group of containers:</p>
<ul>
<li><p>running together (on the same node)</p>
</li>
<li><p>sharing resources (RAM, CPU; but also network, volumes)</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>List pods on our cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">141 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="listing-running-containers">Listing running containers</h2>
<ul>
<li><p>Containers are manipulated through <em>pods</em></p>
</li>
<li><p>A pod is a group of containers:</p>
<ul>
<li><p>running together (on the same node)</p>
</li>
<li><p>sharing resources (RAM, CPU; but also network, volumes)</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>List pods on our cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
</li>
</ul>
</div>

<p><em>Where are the pods that we saw just a moment earlier?!?</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">142 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="namespaces">Namespaces</h2>
<ul>
<li>Namespaces allow us to segregate resources</li>
</ul>
<div class="exercise"><ul>
<li>List the namespaces on our cluster with one of these commands:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get namespaces</div><div class="remark-code-line">kubectl get namespace</div><div class="remark-code-line">kubectl get ns</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">143 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="namespaces">Namespaces</h2>
<ul>
<li>Namespaces allow us to segregate resources</li>
</ul>
<div class="exercise"><ul>
<li>List the namespaces on our cluster with one of these commands:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get namespaces</div><div class="remark-code-line">kubectl get namespace</div><div class="remark-code-line">kubectl get ns</div></code></pre>
</li>
</ul>
</div>

<p><em>You know what ... This <code class="remark-inline-code">kube-system</code> thing looks suspicious.</em></p>
<p><em>In fact, I'm pretty sure it showed up earlier, when we did:</em></p>
<p><code class="remark-inline-code">kubectl describe node node1</code></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">144 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="accessing-namespaces">Accessing namespaces</h2>
<ul>
<li><p>By default, <code class="remark-inline-code">kubectl</code> uses the <code class="remark-inline-code">default</code> namespace</p>
</li>
<li><p>We can see resources in all namespaces with <code class="remark-inline-code">--all-namespaces</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>List the pods in all namespaces:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods --all-namespaces</div></code></pre>
</li>
<li><p>Since Kubernetes 1.14, we can also use <code class="remark-inline-code">-A</code> as a shorter version:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -A</div></code></pre>
</li>
</ul>
</div>

<p><em>Here are our system pods!</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">145 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-are-all-these-control-plane-pods-">What are all these control plane pods?</h2>
<ul>
<li><p><code class="remark-inline-code">etcd</code> is our etcd server</p>
</li>
<li><p><code class="remark-inline-code">kube-apiserver</code> is the API server</p>
</li>
<li><p><code class="remark-inline-code">kube-controller-manager</code> and <code class="remark-inline-code">kube-scheduler</code> are other control plane components</p>
</li>
<li><p><code class="remark-inline-code">coredns</code> provides DNS-based service discovery (<a href="https://kubernetes.io/blog/2018/07/10/coredns-ga-for-kubernetes-cluster-dns/">replacing kube-dns as of 1.11</a>)</p>
</li>
<li><p><code class="remark-inline-code">kube-proxy</code> is the (per-node) component managing port mappings and such</p>
</li>
<li><p><code class="remark-inline-code">weave</code> is the (per-node) component managing the network overlay</p>
</li>
<li><p>the <code class="remark-inline-code">READY</code> column indicates the number of containers in each pod</p>
<p>(1 for most pods, but <code class="remark-inline-code">weave</code> has 2, for instance)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">146 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="scoping-another-namespace">Scoping another namespace</h2>
<ul>
<li>We can also look at a different namespace (other than <code class="remark-inline-code">default</code>)</li>
</ul>
<div class="exercise"><ul>
<li>List only the pods in the <code class="remark-inline-code">kube-system</code> namespace:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods --namespace=kube-system</div><div class="remark-code-line">kubectl get pods -n kube-system</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">147 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="namespaces-and-other-kubectl-commands">Namespaces and other <code class="remark-inline-code">kubectl</code> commands</h2>
<ul>
<li><p>We can use <code class="remark-inline-code">-n</code>/<code class="remark-inline-code">--namespace</code> with almost every <code class="remark-inline-code">kubectl</code> command</p>
</li>
<li><p>Example:</p>
<ul>
<li><code class="remark-inline-code">kubectl create --namespace=X</code> to create something in namespace X</li>
</ul>
</li>
<li><p>We can use <code class="remark-inline-code">-A</code>/<code class="remark-inline-code">--all-namespaces</code> with most commands that manipulate multiple objects</p>
</li>
<li><p>Examples:</p>
<ul>
<li><p><code class="remark-inline-code">kubectl delete</code> can delete resources across multiple namespaces</p>
</li>
<li><p><code class="remark-inline-code">kubectl label</code> can add/remove/update labels across multiple namespaces</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">148 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="what-about-kube-public-">What about <code class="remark-inline-code">kube-public</code>?</h2>
<div class="exercise"><ul>
<li>List the pods in the <code class="remark-inline-code">kube-public</code> namespace:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-public get pods</div></code></pre>
</li>
</ul>
</div>

<p>Nothing!</p>
<p><code class="remark-inline-code">kube-public</code> is created by kubeadm &amp; <a href="https://kubernetes.io/blog/2017/01/stronger-foundation-for-creating-and-managing-kubernetes-clusters">used for security bootstrapping</a>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">149 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="exploring-kube-public-">Exploring <code class="remark-inline-code">kube-public</code></h2>
<ul>
<li>The only interesting object in <code class="remark-inline-code">kube-public</code> is a ConfigMap named <code class="remark-inline-code">cluster-info</code></li>
</ul>
<div class="exercise"><ul>
<li><p>List ConfigMap objects:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-public get configmaps</div></code></pre>
</li>
<li><p>Inspect <code class="remark-inline-code">cluster-info</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-public get configmap cluster-info -o yaml</div></code></pre>
</li>
</ul>
</div>

<p>Note the <code class="remark-inline-code">selfLink</code> URI: <code class="remark-inline-code">/api/v1/namespaces/kube-public/configmaps/cluster-info</code></p>
<p>We can use that!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">150 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="accessing-cluster-info-">Accessing <code class="remark-inline-code">cluster-info</code></h2>
<ul>
<li><p>Earlier, when trying to access the API server, we got a <code class="remark-inline-code">Forbidden</code> message</p>
</li>
<li><p>But <code class="remark-inline-code">cluster-info</code> is readable by everyone (even without authentication)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Retrieve <code class="remark-inline-code">cluster-info</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k https://10.96.0.1/api/v1/namespaces/kube-public/configmaps/cluster-info</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>We were able to access <code class="remark-inline-code">cluster-info</code> (without auth)</p>
</li>
<li><p>It contains a <code class="remark-inline-code">kubeconfig</code> file</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">151 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="retrieving-kubeconfig-">Retrieving <code class="remark-inline-code">kubeconfig</code></h2>
<ul>
<li>We can easily extract the <code class="remark-inline-code">kubeconfig</code> file from this ConfigMap</li>
</ul>
<div class="exercise"><ul>
<li>Display the content of <code class="remark-inline-code">kubeconfig</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -sk https://10.96.0.1/api/v1/namespaces/kube-public/configmaps/cluster-info \</div><div class="remark-code-line">     | jq -r .data.kubeconfig</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>This file holds the canonical address of the API server, and the public key of the CA</p>
</li>
<li><p>This file <em>does not</em> hold client keys or tokens</p>
</li>
<li><p>This is not sensitive information, but allows us to establish trust</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p><div class="remark-slide-number">152 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="what-about-kube-node-lease-">What about <code class="remark-inline-code">kube-node-lease</code>?</h2>
<ul>
<li><p>Starting with Kubernetes 1.14, there is a <code class="remark-inline-code">kube-node-lease</code> namespace</p>
<p>(or in Kubernetes 1.13 if the NodeLease feature gate is enabled)</p>
</li>
<li><p>That namespace contains one Lease object per node</p>
</li>
<li><p><em>Node leases</em> are a new way to implement node heartbeats</p>
<p>(i.e. node regularly pinging the control plane to say "I'm alive!")</p>
</li>
<li><p>For more details, see <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/0009-node-heartbeat.md">KEP-0009</a> or the <a href="https://kubernetes.io/docs/concepts/architecture/nodes/#node-controller">node controller documentation</a>
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlget.md">k8s/kubectlget.md</a></span></p>
</li>
</ul><div class="remark-slide-number">153 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-housing.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">154 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-setting-up-kubernetes" class="remark-slide-content title hljs-default"><p>Setting up Kubernetes</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-first-contact-with-kubectl">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-2">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-running-our-first-containers-on-kubernetes">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">155 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="setting-up-kubernetes">Setting up Kubernetes</h1>
<ul>
<li>How did we set up these Kubernetes clusters that we're using?</li>
</ul><div class="remark-slide-number">156 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="setting-up-kubernetes">Setting up Kubernetes</h1>
<ul>
<li>How did we set up these Kubernetes clusters that we're using?</li>
</ul>
<!-- ##VERSION## -->

<ul>
<li><p>We used <code class="remark-inline-code">kubeadm</code> on freshly installed VM instances running Ubuntu LTS</p>
<ol>
<li><p>Install Docker</p>
</li>
<li><p>Install Kubernetes packages</p>
</li>
<li><p>Run <code class="remark-inline-code">kubeadm init</code> on the first node (it deploys the control plane on that node)</p>
</li>
<li><p>Set up Weave (the overlay network)
<br>
(that step is just one <code class="remark-inline-code">kubectl apply</code> command; discussed later)</p>
</li>
<li><p>Run <code class="remark-inline-code">kubeadm join</code> on the other nodes (with the token produced by <code class="remark-inline-code">kubeadm init</code>)</p>
</li>
<li><p>Copy the configuration file generated by <code class="remark-inline-code">kubeadm init</code></p>
</li>
</ol>
</li>
<li><p>Check the <a href="https://github.com/jpetazzo/container.training/blob/master/prepare-vms/README.md">prepare VMs README</a> for more details</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md">k8s/setup-k8s.md</a></span></p><div class="remark-slide-number">157 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubeadm-drawbacks"><code class="remark-inline-code">kubeadm</code> drawbacks</h2>
<ul>
<li><p>Doesn't set up Docker or any other container engine</p>
</li>
<li><p>Doesn't set up the overlay network</p>
</li>
<li><p>Doesn't set up multi-master (no high availability)</p>
</li>
</ul><div class="remark-slide-number">158 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="-kubeadm-drawbacks"><code class="remark-inline-code">kubeadm</code> drawbacks</h2>
<ul>
<li><p>Doesn't set up Docker or any other container engine</p>
</li>
<li><p>Doesn't set up the overlay network</p>
</li>
<li><p>Doesn't set up multi-master (no high availability)</p>
<p>(At least ... not yet! Though it's <a href="https://kubernetes.io/docs/setup/independent/high-availability/">experimental in 1.12</a>.)</p>
</li>
</ul><div class="remark-slide-number">159 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="-kubeadm-drawbacks"><code class="remark-inline-code">kubeadm</code> drawbacks</h2>
<ul>
<li><p>Doesn't set up Docker or any other container engine</p>
</li>
<li><p>Doesn't set up the overlay network</p>
</li>
<li><p>Doesn't set up multi-master (no high availability)</p>
<p>(At least ... not yet! Though it's <a href="https://kubernetes.io/docs/setup/independent/high-availability/">experimental in 1.12</a>.)</p>
</li>
<li><p>"It's still twice as many steps as setting up a Swarm cluster 😕" -- Jérôme</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md">k8s/setup-k8s.md</a></span></p><div class="remark-slide-number">160 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="other-deployment-options">Other deployment options</h2>
<ul>
<li><p><a href="https://azure.microsoft.com/services/kubernetes-service/">AKS</a>:
managed Kubernetes on Azure</p>
</li>
<li><p><a href="https://cloud.google.com/kubernetes-engine/">GKE</a>:
managed Kubernetes on Google Cloud</p>
</li>
<li><p><a href="https://aws.amazon.com/eks/">EKS</a>,
<a href="https://eksctl.io/">eksctl</a>:
managed Kubernetes on AWS</p>
</li>
<li><p><a href="https://github.com/kubernetes/kops">kops</a>:
customizable deployments on AWS, Digital Ocean, GCE (beta), vSphere (alpha)</p>
</li>
<li><p><a href="https://kubernetes.io/docs/setup/minikube/">minikube</a>,
<a href="https://github.com/kinvolk/kube-spawn">kubespawn</a>,
<a href="https://docs.docker.com/docker-for-mac/kubernetes/">Docker Desktop</a>:
for local development</p>
</li>
<li><p><a href="https://github.com/kubicorn/kubicorn">kubicorn</a>,
the <a href="https://blogs.vmware.com/cloudnative/2019/03/14/what-and-why-of-cluster-api/">Cluster API</a>:
deploy your clusters declaratively, "the Kubernetes way"</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md">k8s/setup-k8s.md</a></span></p><div class="remark-slide-number">161 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="even-more-deployment-options">Even more deployment options</h2>
<ul>
<li><p>If you like Ansible:
<a href="https://github.com/kubernetes-incubator/kubespray">kubespray</a></p>
</li>
<li><p>If you like Terraform:
<a href="https://github.com/poseidon/typhoon">typhoon</a></p>
</li>
<li><p>If you like Terraform and Puppet:
<a href="https://github.com/jetstack/tarmak">tarmak</a></p>
</li>
<li><p>You can also learn how to install every component manually, with
the excellent tutorial <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">Kubernetes The Hard Way</a></p>
<p><em>Kubernetes The Hard Way is optimized for learning, which means taking the long route to ensure you understand each task required to bootstrap a Kubernetes cluster.</em></p>
</li>
<li><p>There are also many commercial options available!</p>
</li>
<li><p>For a longer list, check the Kubernetes documentation:
<br>
it has a great guide to <a href="https://kubernetes.io/docs/setup/pick-right-solution/">pick the right solution</a> to set up Kubernetes.</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-k8s.md">k8s/setup-k8s.md</a></span></p><div class="remark-slide-number">162 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/containers-by-the-water.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">163 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-running-our-first-containers-on-kubernetes" class="remark-slide-content title hljs-default"><p>Running our first containers on Kubernetes</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-setting-up-kubernetes">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-2">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-exposing-containers">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">164 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="running-our-first-containers-on-kubernetes">Running our first containers on Kubernetes</h1>
<ul>
<li>First things first: we cannot run a container</li>
</ul><div class="remark-slide-number">165 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="running-our-first-containers-on-kubernetes">Running our first containers on Kubernetes</h1>
<ul>
<li><p>First things first: we cannot run a container</p>
</li>
<li><p>We are going to run a pod, and in that pod there will be a single container</p>
</li>
</ul><div class="remark-slide-number">166 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="running-our-first-containers-on-kubernetes">Running our first containers on Kubernetes</h1>
<ul>
<li><p>First things first: we cannot run a container</p>
</li>
<li><p>We are going to run a pod, and in that pod there will be a single container</p>
</li>
<li><p>In that container in the pod, we are going to run a simple <code class="remark-inline-code">ping</code> command</p>
</li>
<li><p>Then we are going to start additional copies of the pod</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">167 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-a-simple-pod-with-kubectl-run-">Starting a simple pod with <code class="remark-inline-code">kubectl run</code></h2>
<ul>
<li>We need to specify at least a <em>name</em> and the image we want to use</li>
</ul>
<div class="exercise"><ul>
<li>Let's ping <code class="remark-inline-code">1.1.1.1</code>, Cloudflare's 
<a href="https://blog.cloudflare.com/announcing-1111/">public DNS resolver</a>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run pingpong --image alpine ping 1.1.1.1</div></code></pre>
</li>
</ul>
<!-- ```hide kubectl wait deploy/pingpong --for condition=available``` -->

</div><div class="remark-slide-number">168 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="starting-a-simple-pod-with-kubectl-run-">Starting a simple pod with <code class="remark-inline-code">kubectl run</code></h2>
<ul>
<li>We need to specify at least a <em>name</em> and the image we want to use</li>
</ul>
<div class="exercise"><ul>
<li>Let's ping <code class="remark-inline-code">1.1.1.1</code>, Cloudflare's 
<a href="https://blog.cloudflare.com/announcing-1111/">public DNS resolver</a>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run pingpong --image alpine ping 1.1.1.1</div></code></pre>
</li>
</ul>
<!-- ```hide kubectl wait deploy/pingpong --for condition=available``` -->

</div>

<p>(Starting with Kubernetes 1.12, we get a message telling us that
<code class="remark-inline-code">kubectl run</code> is deprecated. Let's ignore it for now.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">169 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="behind-the-scenes-of-kubectl-run-">Behind the scenes of <code class="remark-inline-code">kubectl run</code></h2>
<ul>
<li>Let's look at the resources that were created by <code class="remark-inline-code">kubectl run</code></li>
</ul>
<div class="exercise"><ul>
<li>List most resource types:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">170 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="behind-the-scenes-of-kubectl-run-">Behind the scenes of <code class="remark-inline-code">kubectl run</code></h2>
<ul>
<li>Let's look at the resources that were created by <code class="remark-inline-code">kubectl run</code></li>
</ul>
<div class="exercise"><ul>
<li>List most resource types:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>We should see the following things:</p>
<ul>
<li><code class="remark-inline-code">deployment.apps/pingpong</code> (the <em>deployment</em> that we just created)</li>
<li><code class="remark-inline-code">replicaset.apps/pingpong-xxxxxxxxxx</code> (a <em>replica set</em> created by the deployment)</li>
<li><code class="remark-inline-code">pod/pingpong-xxxxxxxxxx-yyyyy</code> (a <em>pod</em> created by the replica set)</li>
</ul>
<p>Note: as of 1.10.1, resource types are displayed in more detail.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">171 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-are-these-different-things-">What are these different things?</h2>
<ul>
<li><p>A <em>deployment</em> is a high-level construct</p>
<ul>
<li><p>allows scaling, rolling updates, rollbacks</p>
</li>
<li><p>multiple deployments can be used together to implement a
<a href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments">canary deployment</a></p>
</li>
<li><p>delegates pods management to <em>replica sets</em></p>
</li>
</ul>
</li>
<li><p>A <em>replica set</em> is a low-level construct</p>
<ul>
<li><p>makes sure that a given number of identical pods are running</p>
</li>
<li><p>allows scaling</p>
</li>
<li><p>rarely used directly</p>
</li>
</ul>
</li>
<li><p>A <em>replication controller</em> is the (deprecated) predecessor of a replica set</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">172 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-pingpong-deployment">Our <code class="remark-inline-code">pingpong</code> deployment</h2>
<ul>
<li><code class="remark-inline-code">kubectl run</code> created a <em>deployment</em>, <code class="remark-inline-code">deployment.apps/pingpong</code></li>
</ul>
<pre><code class="remark-code"><div class="remark-code-line">NAME                       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</div><div class="remark-code-line">deployment.apps/pingpong   1         1         1            1           10m</div></code></pre><ul>
<li>That deployment created a <em>replica set</em>, <code class="remark-inline-code">replicaset.apps/pingpong-xxxxxxxxxx</code></li>
</ul>
<pre><code class="remark-code"><div class="remark-code-line">NAME                                  DESIRED   CURRENT   READY     AGE</div><div class="remark-code-line">replicaset.apps/pingpong-7c8bbcd9bc   1         1         1         10m</div></code></pre><ul>
<li>That replica set created a <em>pod</em>, <code class="remark-inline-code">pod/pingpong-xxxxxxxxxx-yyyyy</code></li>
</ul>
<pre><code class="remark-code"><div class="remark-code-line">NAME                            READY     STATUS    RESTARTS   AGE</div><div class="remark-code-line">pod/pingpong-7c8bbcd9bc-6c9qz   1/1       Running   0          10m</div></code></pre><ul>
<li><p>We'll see later how these folks play together for:</p>
<ul>
<li>scaling, high availability, rolling updates</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">173 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="viewing-container-output">Viewing container output</h2>
<ul>
<li><p>Let's use the <code class="remark-inline-code">kubectl logs</code> command</p>
</li>
<li><p>We will pass either a <em>pod name</em>, or a <em>type/name</em></p>
<p>(E.g. if we specify a deployment or replica set, it will get the first pod in it)</p>
</li>
<li><p>Unless specified otherwise, it will only show logs of the first container in the pod</p>
<p>(Good thing there's only one in ours!)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>View the result of our <code class="remark-inline-code">ping</code> command:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/pingpong</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">174 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="streaming-logs-in-real-time">Streaming logs in real time</h2>
<ul>
<li><p>Just like <code class="remark-inline-code">docker logs</code>, <code class="remark-inline-code">kubectl logs</code> supports convenient options:</p>
<ul>
<li><p><code class="remark-inline-code">-f</code>/<code class="remark-inline-code">--follow</code> to stream logs in real time (à la <code class="remark-inline-code">tail -f</code>)</p>
</li>
<li><p><code class="remark-inline-code">--tail</code> to indicate how many lines you want to see (from the end)</p>
</li>
<li><p><code class="remark-inline-code">--since</code> to get logs only after a given timestamp</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>View the latest logs of our <code class="remark-inline-code">ping</code> command:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/pingpong --tail 1 --follow</div></code></pre>
</li>
</ul>
<!--
```wait seq=3```
```keys ^C```
-->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">175 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="scaling-our-application">Scaling our application</h2>
<ul>
<li>We can create additional copies of our container (I mean, our pod) with <code class="remark-inline-code">kubectl scale</code></li>
</ul>
<div class="exercise"><ul>
<li><p>Scale our <code class="remark-inline-code">pingpong</code> deployment:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deploy/pingpong --replicas 3</div></code></pre>
</li>
<li><p>Note that this command does exactly the same thing:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment pingpong --replicas 3</div></code></pre>
</li>
</ul>
</div>

<p>Note: what if we tried to scale <code class="remark-inline-code">replicaset.apps/pingpong-xxxxxxxxxx</code>?</p>
<p>We could! But the <em>deployment</em> would notice it right away, and scale back to the initial level.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">176 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="resilience">Resilience</h2>
<ul>
<li><p>The <em>deployment</em> <code class="remark-inline-code">pingpong</code> watches its <em>replica set</em></p>
</li>
<li><p>The <em>replica set</em> ensures that the right number of <em>pods</em> are running</p>
</li>
<li><p>What happens if pods disappear?</p>
</li>
</ul>
<div class="exercise"><ul>
<li>In a separate window, list pods, and keep watching them:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -w</div></code></pre>
</li>
</ul>
<!--
```wait Running```
```keys ^C```
```hide kubectl wait deploy pingpong --for condition=available```
```keys kubectl delete pod ping```
```copypaste pong-..........-.....```
-->

<ul>
<li>Destroy a pod:<pre><code class="remark-code"><div class="remark-code-line">kubectl delete pod pingpong-xxxxxxxxxx-yyyyy</div></code></pre></li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">177 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-if-we-wanted-something-different-">What if we wanted something different?</h2>
<ul>
<li><p>What if we wanted to start a "one-shot" container that <em>doesn't</em> get restarted?</p>
</li>
<li><p>We could use <code class="remark-inline-code">kubectl run --restart=OnFailure</code> or <code class="remark-inline-code">kubectl run --restart=Never</code></p>
</li>
<li><p>These commands would create <em>jobs</em> or <em>pods</em> instead of <em>deployments</em></p>
</li>
<li><p>Under the hood, <code class="remark-inline-code">kubectl run</code> invokes "generators" to create resource descriptions</p>
</li>
<li><p>We could also write these resource descriptions ourselves (typically in YAML),
<br>and create them on the cluster with <code class="remark-inline-code">kubectl apply -f</code> (discussed later)</p>
</li>
<li><p>With <code class="remark-inline-code">kubectl run --schedule=...</code>, we can also create <em>cronjobs</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">178 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-about-that-deprecation-warning-">What about that deprecation warning?</h2>
<ul>
<li><p>As we can see from the previous slide, <code class="remark-inline-code">kubectl run</code> can do many things</p>
</li>
<li><p>The exact type of resource created is not obvious</p>
</li>
<li><p>To make things more explicit, it is better to use <code class="remark-inline-code">kubectl create</code>:</p>
<ul>
<li><p><code class="remark-inline-code">kubectl create deployment</code> to create a deployment</p>
</li>
<li><p><code class="remark-inline-code">kubectl create job</code> to create a job</p>
</li>
<li><p><code class="remark-inline-code">kubectl create cronjob</code> to run a job periodically
<br>(since Kubernetes 1.14)</p>
</li>
</ul>
</li>
<li><p>Eventually, <code class="remark-inline-code">kubectl run</code> will be used only to start one-shot pods</p>
<p>(see <a href="https://github.com/kubernetes/kubernetes/pull/68132">https://github.com/kubernetes/kubernetes/pull/68132</a>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">179 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="various-ways-of-creating-resources">Various ways of creating resources</h2>
<ul>
<li><p><code class="remark-inline-code">kubectl run</code> </p>
<ul>
<li>easy way to get started</li>
<li>versatile</li>
</ul>
</li>
<li><p><code class="remark-inline-code">kubectl create &lt;resource&gt;</code> </p>
<ul>
<li>explicit, but lacks some features</li>
<li>can't create a CronJob before Kubernetes 1.14</li>
<li>can't pass command-line arguments to deployments</li>
</ul>
</li>
<li><p><code class="remark-inline-code">kubectl create -f foo.yaml</code> or <code class="remark-inline-code">kubectl apply -f foo.yaml</code></p>
<ul>
<li>all features are available</li>
<li>requires writing YAML</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">180 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="viewing-logs-of-multiple-pods">Viewing logs of multiple pods</h2>
<ul>
<li><p>When we specify a deployment name, only one single pod's logs are shown</p>
</li>
<li><p>We can view the logs of multiple pods by specifying a <em>selector</em></p>
</li>
<li><p>A selector is a logic expression using <em>labels</em></p>
</li>
<li><p>Conveniently, when you <code class="remark-inline-code">kubectl run somename</code>, the associated objects have a <code class="remark-inline-code">run=somename</code> label</p>
</li>
</ul>
<div class="exercise"><ul>
<li>View the last line of log from all pods with the <code class="remark-inline-code">run=pingpong</code> label:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs <span class="hljs-_">-l</span> run=pingpong --tail 1</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">181 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h3 id="streaming-logs-of-multiple-pods">Streaming logs of multiple pods</h3>
<ul>
<li>Can we stream the logs of all our <code class="remark-inline-code">pingpong</code> pods?</li>
</ul>
<div class="exercise"><ul>
<li>Combine <code class="remark-inline-code">-l</code> and <code class="remark-inline-code">-f</code> flags:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs <span class="hljs-_">-l</span> run=pingpong --tail 1 <span class="hljs-_">-f</span></div></code></pre>
</li>
</ul>
<!--
```wait seq=```
```keys ^C```
-->

</div>

<p><em>Note: combining <code class="remark-inline-code">-l</code> and <code class="remark-inline-code">-f</code> is only possible since Kubernetes 1.14!</em></p>
<p><em>Let's try to understand why ...</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">182 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h3 id="streaming-logs-of-many-pods">Streaming logs of many pods</h3>
<ul>
<li>Let's see what happens if we try to stream the logs for more than 5 pods</li>
</ul>
<div class="exercise"><ul>
<li><p>Scale up our deployment:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment pingpong --replicas=8</div></code></pre>
</li>
<li><p>Stream the logs:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs <span class="hljs-_">-l</span> run=pingpong --tail 1 <span class="hljs-_">-f</span></div></code></pre>
</li>
</ul>
</div>

<p>We see a message like the following one:</p>
<pre><code class="remark-code"><div class="remark-code-line">error: you are attempting to follow 8 log streams,</div><div class="remark-code-line">but maximum allowed concurency is 5,</div><div class="remark-code-line">use --max-log-requests to increase the limit</div></code></pre><p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">183 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="why-can-t-we-stream-the-logs-of-many-pods-">Why can't we stream the logs of many pods?</h2>
<ul>
<li><p><code class="remark-inline-code">kubectl</code> opens one connection to the API server per pod</p>
</li>
<li><p>For each pod, the API server opens one extra connection to the corresponding kubelet</p>
</li>
<li><p>If there are 1000 pods in our deployment, that's 1000 inbound + 1000 outbound connections on the API server</p>
</li>
<li><p>This could easily put a lot of stress on the API server</p>
</li>
<li><p>Prior Kubernetes 1.14, it was decided to <em>not</em> allow multiple connections</p>
</li>
<li><p>From Kubernetes 1.14, it is allowed, but limited to 5 connections</p>
<p>(this can be changed with <code class="remark-inline-code">--max-log-requests</code>)</p>
</li>
<li><p>For more details about the rationale, see
<a href="https://github.com/kubernetes/kubernetes/pull/67573">PR #67573</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">184 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="shortcomings-of-kubectl-logs-">Shortcomings of <code class="remark-inline-code">kubectl logs</code></h2>
<ul>
<li><p>We don't see which pod sent which log line</p>
</li>
<li><p>If pods are restarted / replaced, the log stream stops</p>
</li>
<li><p>If new pods are added, we don't see their logs</p>
</li>
<li><p>To stream the logs of multiple pods, we need to write a selector</p>
</li>
<li><p>There are external tools to address these shortcomings</p>
<p>(e.g.: <a href="https://github.com/wercker/stern">Stern</a>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">185 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="-kubectl-logs-l-tail-n-"><code class="remark-inline-code">kubectl logs -l ... --tail N</code></h2>
<ul>
<li><p>If we run this with Kubernetes 1.12, the last command shows multiple lines</p>
</li>
<li><p>This is a regression when <code class="remark-inline-code">--tail</code> is used together with <code class="remark-inline-code">-l</code>/<code class="remark-inline-code">--selector</code></p>
</li>
<li><p>It always shows the last 10 lines of output for each container</p>
<p>(instead of the number of lines specified on the command line)</p>
</li>
<li><p>The problem was fixed in Kubernetes 1.13</p>
</li>
</ul>
<p><em>See <a href="https://github.com/kubernetes/kubernetes/issues/70554">#70554</a> for details.</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">186 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="aren-t-we-flooding-1-1-1-1-">Aren't we flooding 1.1.1.1?</h2>
<ul>
<li><p>If you're wondering this, good question!</p>
</li>
<li><p>Don't worry, though:</p>
<p><em>APNIC's research group held the IP addresses 1.1.1.1 and 1.0.0.1. While the addresses were valid, so many people had entered them into various random systems that they were continuously overwhelmed by a flood of garbage traffic. APNIC wanted to study this garbage traffic but any time they'd tried to announce the IPs, the flood would overwhelm any conventional network.</em></p>
<p>(Source: <a href="https://blog.cloudflare.com/announcing-1111/">https://blog.cloudflare.com/announcing-1111/</a>)</p>
</li>
<li><p>It's very unlikely that our concerted pings manage to produce
even a modest blip at Cloudflare's NOC!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlrun.md">k8s/kubectlrun.md</a></span></p><div class="remark-slide-number">187 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="19-000-words">19,000 words</h2>
<p>They say, "a picture is worth one thousand words."</p>
<p>The following 19 slides show what really happens when we run:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run web --image=nginx --replicas=3</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">188 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/01.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">189 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/02.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">190 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/03.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">191 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/04.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">192 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/05.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">193 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/06.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">194 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/07.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">195 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/08.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">196 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/09.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">197 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/10.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">198 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/11.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">199 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/12.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">200 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/13.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">201 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/14.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">202 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/15.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">203 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/16.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">204 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/17.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">205 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/18.svg" alt="">
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">206 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/19.svg" alt=""></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/deploymentslideshow.md">k8s/deploymentslideshow.md</a></span></p><div class="remark-slide-number">207 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/distillery-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">208 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-exposing-containers" class="remark-slide-content title hljs-default"><p>Exposing containers</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-running-our-first-containers-on-kubernetes">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-3">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-shipping-images-with-a-registry">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">209 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="exposing-containers">Exposing containers</h1>
<ul>
<li><p><code class="remark-inline-code">kubectl expose</code> creates a <em>service</em> for existing pods</p>
</li>
<li><p>A <em>service</em> is a stable address for a pod (or a bunch of pods)</p>
</li>
<li><p>If we want to connect to our pod(s), we need to create a <em>service</em></p>
</li>
<li><p>Once a service is created, CoreDNS will allow us to resolve it by name</p>
<p>(i.e. after creating service <code class="remark-inline-code">hello</code>, the name <code class="remark-inline-code">hello</code> will resolve to something)</p>
</li>
<li><p>There are different types of services, detailed on the following slides:</p>
<p><code class="remark-inline-code">ClusterIP</code>, <code class="remark-inline-code">NodePort</code>, <code class="remark-inline-code">LoadBalancer</code>, <code class="remark-inline-code">ExternalName</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">210 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="basic-service-types">Basic service types</h2>
<ul>
<li><p><code class="remark-inline-code">ClusterIP</code> (default type)</p>
<ul>
<li>a virtual IP address is allocated for the service (in an internal, private range)</li>
<li>this IP address is reachable only from within the cluster (nodes and pods)</li>
<li>our code can connect to the service using the original port number</li>
</ul>
</li>
<li><p><code class="remark-inline-code">NodePort</code></p>
<ul>
<li>a port is allocated for the service (by default, in the 30000-32768 range)</li>
<li>that port is made available <em>on all our nodes</em> and anybody can connect to it</li>
<li>our code must be changed to connect to that new port number</li>
</ul>
</li>
</ul>
<p>These service types are always available.</p>
<p>Under the hood: <code class="remark-inline-code">kube-proxy</code> is using a userland proxy and a bunch of <code class="remark-inline-code">iptables</code> rules.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">211 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-service-types">More service types</h2>
<ul>
<li><p><code class="remark-inline-code">LoadBalancer</code></p>
<ul>
<li>an external load balancer is allocated for the service</li>
<li>the load balancer is configured accordingly
<br>(e.g.: a <code class="remark-inline-code">NodePort</code> service is created, and the load balancer sends traffic to that port)</li>
<li>available only when the underlying infrastructure provides some "load balancer as a service"
<br>(e.g. AWS, Azure, GCE, OpenStack...)</li>
</ul>
</li>
<li><p><code class="remark-inline-code">ExternalName</code></p>
<ul>
<li>the DNS entry managed by CoreDNS will just be a <code class="remark-inline-code">CNAME</code> to a provided record</li>
<li>no port, no IP address, no nothing else is allocated</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">212 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-containers-with-open-ports">Running containers with open ports</h2>
<ul>
<li><p>Since <code class="remark-inline-code">ping</code> doesn't have anything to connect to, we'll have to run something else</p>
</li>
<li><p>We could use the <code class="remark-inline-code">nginx</code> official image, but ...</p>
<p>... we wouldn't be able to tell the backends from each other!</p>
</li>
<li><p>We are going to use <code class="remark-inline-code">jpetazzo/httpenv</code>, a tiny HTTP server written in Go</p>
</li>
<li><p><code class="remark-inline-code">jpetazzo/httpenv</code> listens on port 8888</p>
</li>
<li><p>It serves its environment variables in JSON format</p>
</li>
<li><p>The environment variables will include <code class="remark-inline-code">HOSTNAME</code>, which will be the pod name</p>
<p>(and therefore, will be different on each backend)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">213 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-a-deployment-for-our-http-server">Creating a deployment for our HTTP server</h2>
<ul>
<li><p>We <em>could</em> do <code class="remark-inline-code">kubectl run httpenv --image=jpetazzo/httpenv</code> ...</p>
</li>
<li><p>But since <code class="remark-inline-code">kubectl run</code> is being deprecated, let's see how to use <code class="remark-inline-code">kubectl create</code> instead</p>
</li>
</ul>
<div class="exercise"><ul>
<li>In another window, watch the pods (to see when they are created):<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -w</div></code></pre>
</li>
</ul>
<!-- ```keys ^C``` -->

<ul>
<li><p>Create a deployment for this very lightweight HTTP server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment httpenv --image=jpetazzo/httpenv</div></code></pre>
</li>
<li><p>Scale it to 10 replicas:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment httpenv --replicas=10</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">214 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-our-deployment">Exposing our deployment</h2>
<ul>
<li>We'll create a default <code class="remark-inline-code">ClusterIP</code> service</li>
</ul>
<div class="exercise"><ul>
<li><p>Expose the HTTP port of our server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment httpenv --port 8888</div></code></pre>
</li>
<li><p>Look up which IP address was allocated:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get service</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">215 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="services-are-layer-4-constructs">Services are layer 4 constructs</h2>
<ul>
<li><p>You can assign IP addresses to services, but they are still <em>layer 4</em></p>
<p>(i.e. a service is not an IP address; it's an IP address + protocol + port)</p>
</li>
<li><p>This is caused by the current implementation of <code class="remark-inline-code">kube-proxy</code></p>
<p>(it relies on mechanisms that don't support layer 3)</p>
</li>
<li><p>As a result: you <em>have to</em> indicate the port number for your service</p>
</li>
<li><p>Running services with arbitrary port (or port ranges) requires hacks</p>
<p>(e.g. host networking mode)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">216 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-our-service">Testing our service</h2>
<ul>
<li>We will now send a few HTTP requests to our pods</li>
</ul>
<div class="exercise"><ul>
<li>Let's obtain the IP address that was allocated for our service, <em>programmatically:</em><pre><code class="bash hljs remark-code"><div class="remark-code-line">IP=$(kubectl get svc httpenv -o go-template --template <span class="hljs-string">'{{ .spec.clusterIP }}'</span>)</div></code></pre>
</li>
</ul>
<!--
```hide kubectl wait deploy httpenv --for condition=available```
-->

<ul>
<li><p>Send a few requests:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl http://<span class="hljs-variable">$IP</span>:8888/</div></code></pre>
</li>
<li><p>Too much output? Filter it with <code class="remark-inline-code">jq</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="hljs-_">-s</span> http://<span class="hljs-variable">$IP</span>:8888/ | jq .HOSTNAME</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">217 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="testing-our-service">Testing our service</h2>
<ul>
<li>We will now send a few HTTP requests to our pods</li>
</ul>
<div class="exercise"><ul>
<li>Let's obtain the IP address that was allocated for our service, <em>programmatically:</em><pre><code class="bash hljs remark-code"><div class="remark-code-line">IP=$(kubectl get svc httpenv -o go-template --template <span class="hljs-string">'{{ .spec.clusterIP }}'</span>)</div></code></pre>
</li>
</ul>
<!--
```hide kubectl wait deploy httpenv --for condition=available```
-->

<ul>
<li><p>Send a few requests:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl http://<span class="hljs-variable">$IP</span>:8888/</div></code></pre>
</li>
<li><p>Too much output? Filter it with <code class="remark-inline-code">jq</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="hljs-_">-s</span> http://<span class="hljs-variable">$IP</span>:8888/ | jq .HOSTNAME</div></code></pre>
</li>
</ul>
</div>

<p>Try it a few times! Our requests are load balanced across multiple pods.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">218 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="if-we-don-t-need-a-load-balancer">If we don't need a load balancer</h2>
<ul>
<li><p>Sometimes, we want to access our scaled services directly:</p>
<ul>
<li><p>if we want to save a tiny little bit of latency (typically less than 1ms)</p>
</li>
<li><p>if we need to connect over arbitrary ports (instead of a few fixed ones)</p>
</li>
<li><p>if we need to communicate over another protocol than UDP or TCP</p>
</li>
<li><p>if we want to decide how to balance the requests client-side</p>
</li>
<li><p>...</p>
</li>
</ul>
</li>
<li><p>In that case, we can use a "headless service"</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">219 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="headless-services">Headless services</h2>
<ul>
<li><p>A headless service is obtained by setting the <code class="remark-inline-code">clusterIP</code> field to <code class="remark-inline-code">None</code></p>
<p>(Either with <code class="remark-inline-code">--cluster-ip=None</code>, or by providing a custom YAML)</p>
</li>
<li><p>As a result, the service doesn't have a virtual IP address</p>
</li>
<li><p>Since there is no virtual IP address, there is no load balancer either</p>
</li>
<li><p>CoreDNS will return the pods' IP addresses as multiple <code class="remark-inline-code">A</code> records</p>
</li>
<li><p>This gives us an easy way to discover all the replicas for a deployment</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">220 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="services-and-endpoints">Services and endpoints</h2>
<ul>
<li><p>A service has a number of "endpoints"</p>
</li>
<li><p>Each endpoint is a host + port where the service is available</p>
</li>
<li><p>The endpoints are maintained and updated automatically by Kubernetes</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check the endpoints that Kubernetes has associated with our <code class="remark-inline-code">httpenv</code> service:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl describe service httpenv</div></code></pre>
</li>
</ul>
</div>

<p>In the output, there will be a line starting with <code class="remark-inline-code">Endpoints:</code>.</p>
<p>That line will list a bunch of addresses in <code class="remark-inline-code">host:port</code> format.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">221 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="viewing-endpoint-details">Viewing endpoint details</h2>
<ul>
<li><p>When we have many endpoints, our display commands truncate the list</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get endpoints</div></code></pre>
</li>
<li><p>If we want to see the full list, we can use one of the following commands:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl describe endpoints httpenv</div><div class="remark-code-line">kubectl get endpoints httpenv -o yaml</div></code></pre>
</li>
<li><p>These commands will show us a list of IP addresses</p>
</li>
<li><p>These IP addresses should match the addresses of the corresponding pods:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods <span class="hljs-_">-l</span> app=httpenv -o wide</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">222 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="-endpoints-not-endpoint-"><code class="remark-inline-code">endpoints</code> not <code class="remark-inline-code">endpoint</code></h2>
<ul>
<li><code class="remark-inline-code">endpoints</code> is the only resource that cannot be singular</li>
</ul>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">$ kubectl get endpoint</div><div class="remark-code-line">error: the server doesn<span class="hljs-string">'t have a resource type "endpoint"</span></div></code></pre>
<ul>
<li><p>This is because the type itself is plural (unlike every other resource)</p>
</li>
<li><p>There is no <code class="remark-inline-code">endpoint</code> object: <code class="remark-inline-code">type Endpoints struct</code></p>
</li>
<li><p>The type doesn't represent a single endpoint, but a list of endpoints</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">223 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-services-to-the-outside-world">Exposing services to the outside world</h2>
<ul>
<li><p>The default type (ClusterIP) only works for internal traffic</p>
</li>
<li><p>If we want to accept external traffic, we can use one of these:</p>
<ul>
<li><p>NodePort (expose a service on a TCP port between 30000-32768)</p>
</li>
<li><p>LoadBalancer (provision a cloud load balancer for our service)</p>
</li>
<li><p>ExternalIP (use one node's external IP address)</p>
</li>
<li><p>Ingress (a special mechanism for HTTP services)</p>
</li>
</ul>
</li>
</ul>
<p><em>We'll see NodePorts and Ingresses more in detail later.</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlexpose.md">k8s/kubectlexpose.md</a></span></p><div class="remark-slide-number">224 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/lots-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">225 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-shipping-images-with-a-registry" class="remark-slide-content title hljs-default"><p>Shipping images with a registry</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-exposing-containers">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-3">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-running-our-application-on-kubernetes">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">226 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="shipping-images-with-a-registry">Shipping images with a registry</h1>
<ul>
<li><p>Initially, our app was running on a single node</p>
</li>
<li><p>We could <em>build</em> and <em>run</em> in the same place</p>
</li>
<li><p>Therefore, we did not need to <em>ship</em> anything</p>
</li>
<li><p>Now that we want to run on a cluster, things are different</p>
</li>
<li><p>The easiest way to ship container images is to use a registry</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md">k8s/shippingimages.md</a></span></p><div class="remark-slide-number">227 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-docker-registries-work-a-reminder-">How Docker registries work (a reminder)</h2>
<ul>
<li><p>What happens when we execute <code class="remark-inline-code">docker run alpine</code> ?</p>
</li>
<li><p>If the Engine needs to pull the <code class="remark-inline-code">alpine</code> image, it expands it into <code class="remark-inline-code">library/alpine</code></p>
</li>
<li><p><code class="remark-inline-code">library/alpine</code> is expanded into <code class="remark-inline-code">index.docker.io/library/alpine</code></p>
</li>
<li><p>The Engine communicates with <code class="remark-inline-code">index.docker.io</code> to retrieve <code class="remark-inline-code">library/alpine:latest</code></p>
</li>
<li><p>To use something else than <code class="remark-inline-code">index.docker.io</code>, we specify it in the image name</p>
</li>
<li><p>Examples:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker pull gcr.io/google-containers/alpine-with-bash:1.0</div><div class="remark-code-line"></div><div class="remark-code-line">docker build -t registry.mycompany.io:5000/myimage:awesome .</div><div class="remark-code-line">docker push registry.mycompany.io:5000/myimage:awesome</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md">k8s/shippingimages.md</a></span></p><div class="remark-slide-number">228 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-dockercoins-on-kubernetes">Running DockerCoins on Kubernetes</h2>
<ul>
<li><p>Create one deployment for each component</p>
<p>(hasher, redis, rng, webui, worker)</p>
</li>
<li><p>Expose deployments that need to accept connections</p>
<p>(hasher, redis, rng, webui)</p>
</li>
<li><p>For redis, we can use the official redis image</p>
</li>
<li><p>For the 4 others, we need to build images and push them to some registry</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md">k8s/shippingimages.md</a></span></p><div class="remark-slide-number">229 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="building-and-shipping-images">Building and shipping images</h2>
<ul>
<li><p>There are <em>many</em> options!</p>
</li>
<li><p>Manually:</p>
<ul>
<li><p>build locally (with <code class="remark-inline-code">docker build</code> or otherwise)</p>
</li>
<li><p>push to the registry</p>
</li>
</ul>
</li>
<li><p>Automatically:</p>
<ul>
<li><p>build and test locally</p>
</li>
<li><p>when ready, commit and push a code repository</p>
</li>
<li><p>the code repository notifies an automated build system</p>
</li>
<li><p>that system gets the code, builds it, pushes the image to the registry</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md">k8s/shippingimages.md</a></span></p><div class="remark-slide-number">230 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="which-registry-do-we-want-to-use-">Which registry do we want to use?</h2>
<ul>
<li><p>There are SAAS products like Docker Hub, Quay ...</p>
</li>
<li><p>Each major cloud provider has an option as well</p>
<p>(ACR on Azure, ECR on AWS, GCR on Google Cloud...)</p>
</li>
<li><p>There are also commercial products to run our own registry</p>
<p>(Docker EE, Quay...)</p>
</li>
<li><p>And open source options, too!</p>
</li>
<li><p>When picking a registry, pay attention to its build system</p>
<p>(when it has one)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/shippingimages.md">k8s/shippingimages.md</a></span></p><div class="remark-slide-number">231 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-images-from-the-docker-hub">Using images from the Docker Hub</h2>
<ul>
<li><p>For everyone's convenience, we took care of building DockerCoins images</p>
</li>
<li><p>We pushed these images to the DockerHub, under the <a href="https://hub.docker.com/u/dockercoins">dockercoins</a> user</p>
</li>
<li><p>These images are <em>tagged</em> with a version number, <code class="remark-inline-code">v0.1</code></p>
</li>
<li><p>The full image names are therefore:</p>
<ul>
<li><p><code class="remark-inline-code">dockercoins/hasher:v0.1</code></p>
</li>
<li><p><code class="remark-inline-code">dockercoins/rng:v0.1</code></p>
</li>
<li><p><code class="remark-inline-code">dockercoins/webui:v0.1</code></p>
</li>
<li><p><code class="remark-inline-code">dockercoins/worker:v0.1</code></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/buildshiprun-dockerhub.md">k8s/buildshiprun-dockerhub.md</a></span></p><div class="remark-slide-number">232 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-registry-and-tag-">Setting <code class="remark-inline-code">$REGISTRY</code> and <code class="remark-inline-code">$TAG</code></h2>
<ul>
<li><p>In the upcoming exercises and labs, we use a couple of environment variables:</p>
<ul>
<li><p><code class="remark-inline-code">$REGISTRY</code> as a prefix to all image names</p>
</li>
<li><p><code class="remark-inline-code">$TAG</code> as the image version tag</p>
</li>
</ul>
</li>
<li><p>For example, the worker image is <code class="remark-inline-code">$REGISTRY/worker:$TAG</code></p>
</li>
<li><p>If you copy-paste the commands in these exercises:</p>
<p><strong>make sure that you set <code class="remark-inline-code">$REGISTRY</code> and <code class="remark-inline-code">$TAG</code> first!</strong></p>
</li>
<li><p>For example:</p>
<pre><code class="remark-code"><div class="remark-code-line">export REGISTRY=dockercoins TAG=v0.1</div></code></pre><p>(this will expand <code class="remark-inline-code">$REGISTRY/worker:$TAG</code> to <code class="remark-inline-code">dockercoins/worker:v0.1</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/buildshiprun-dockerhub.md">k8s/buildshiprun-dockerhub.md</a></span></p><div class="remark-slide-number">233 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/plastic-containers.JPG" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">234 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-running-our-application-on-kubernetes" class="remark-slide-content title hljs-default"><p>Running our application on Kubernetes</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-shipping-images-with-a-registry">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-3">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-scaling-our-demo-app">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">235 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="running-our-application-on-kubernetes">Running our application on Kubernetes</h1>
<ul>
<li>We can now deploy our code (as well as a redis instance)</li>
</ul>
<div class="exercise"><ul>
<li><p>Deploy <code class="remark-inline-code">redis</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment redis --image=redis</div></code></pre>
</li>
<li><p>Deploy everything else:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">set</span> -u</div><div class="remark-code-line"><span class="hljs-keyword">for</span> SERVICE <span class="hljs-keyword">in</span> hasher rng webui worker; <span class="hljs-keyword">do</span></div><div class="remark-code-line">  kubectl create deployment <span class="hljs-variable">$SERVICE</span> --image=<span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$SERVICE</span>:<span class="hljs-variable">$TAG</span></div><div class="remark-code-line"><span class="hljs-keyword">done</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md">k8s/ourapponkube.md</a></span></p><div class="remark-slide-number">236 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-">Is this working?</h2>
<ul>
<li><p>After waiting for the deployment to complete, let's look at the logs!</p>
<p>(Hint: use <code class="remark-inline-code">kubectl get deploy -w</code> to watch deployment events)</p>
</li>
</ul>
<div class="exercise"><!-- ```hide
kubectl wait deploy/rng --for condition=available
kubectl wait deploy/worker --for condition=available
``` -->

<ul>
<li>Look at some logs:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/rng</div><div class="remark-code-line">kubectl logs deploy/worker</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">237 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-">Is this working?</h2>
<ul>
<li><p>After waiting for the deployment to complete, let's look at the logs!</p>
<p>(Hint: use <code class="remark-inline-code">kubectl get deploy -w</code> to watch deployment events)</p>
</li>
</ul>
<div class="exercise"><!-- ```hide
kubectl wait deploy/rng --for condition=available
kubectl wait deploy/worker --for condition=available
``` -->

<ul>
<li>Look at some logs:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/rng</div><div class="remark-code-line">kubectl logs deploy/worker</div></code></pre>
</li>
</ul>
</div>

<p>🤔 <code class="remark-inline-code">rng</code> is fine ... But not <code class="remark-inline-code">worker</code>.</p><div class="remark-slide-number">238 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-">Is this working?</h2>
<ul>
<li><p>After waiting for the deployment to complete, let's look at the logs!</p>
<p>(Hint: use <code class="remark-inline-code">kubectl get deploy -w</code> to watch deployment events)</p>
</li>
</ul>
<div class="exercise"><!-- ```hide
kubectl wait deploy/rng --for condition=available
kubectl wait deploy/worker --for condition=available
``` -->

<ul>
<li>Look at some logs:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/rng</div><div class="remark-code-line">kubectl logs deploy/worker</div></code></pre>
</li>
</ul>
</div>

<p>🤔 <code class="remark-inline-code">rng</code> is fine ... But not <code class="remark-inline-code">worker</code>.</p>
<p>💡 Oh right! We forgot to <code class="remark-inline-code">expose</code>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md">k8s/ourapponkube.md</a></span></p><div class="remark-slide-number">239 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="connecting-containers-together">Connecting containers together</h2>
<ul>
<li><p>Three deployments need to be reachable by others: <code class="remark-inline-code">hasher</code>, <code class="remark-inline-code">redis</code>, <code class="remark-inline-code">rng</code></p>
</li>
<li><p><code class="remark-inline-code">worker</code> doesn't need to be exposed</p>
</li>
<li><p><code class="remark-inline-code">webui</code> will be dealt with later</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Expose each deployment, specifying the right port:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment redis --port 6379</div><div class="remark-code-line">kubectl expose deployment rng --port 80</div><div class="remark-code-line">kubectl expose deployment hasher --port 80</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md">k8s/ourapponkube.md</a></span></p><div class="remark-slide-number">240 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-yet-">Is this working yet?</h2>
<ul>
<li>The <code class="remark-inline-code">worker</code> has an infinite loop, that retries 10 seconds after an error</li>
</ul>
<div class="exercise"><ul>
<li><p>Stream the worker's logs:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/worker --follow</div></code></pre>
<p>(Give it about 10 seconds to recover)</p>
</li>
</ul>
<!--
```wait units of work done, updating hash counter```
```keys ^C```
-->

</div><div class="remark-slide-number">241 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-yet-">Is this working yet?</h2>
<ul>
<li>The <code class="remark-inline-code">worker</code> has an infinite loop, that retries 10 seconds after an error</li>
</ul>
<div class="exercise"><ul>
<li><p>Stream the worker's logs:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/worker --follow</div></code></pre>
<p>(Give it about 10 seconds to recover)</p>
</li>
</ul>
<!--
```wait units of work done, updating hash counter```
```keys ^C```
-->

</div>

<p>We should now see the <code class="remark-inline-code">worker</code>, well, working happily.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md">k8s/ourapponkube.md</a></span></p><div class="remark-slide-number">242 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-services-for-external-access">Exposing services for external access</h2>
<ul>
<li><p>Now we would like to access the Web UI</p>
</li>
<li><p>We will expose it with a <code class="remark-inline-code">NodePort</code></p>
<p>(just like we did for the registry)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a <code class="remark-inline-code">NodePort</code> service for the Web UI:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deploy/webui --type=NodePort --port=80</div></code></pre>
</li>
<li><p>Check the port that was allocated:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md">k8s/ourapponkube.md</a></span></p><div class="remark-slide-number">243 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="accessing-the-web-ui">Accessing the web UI</h2>
<ul>
<li>We can now connect to <em>any node</em>, on the allocated node port, to view the web UI</li>
</ul>
<div class="exercise"><ul>
<li>Open the web UI in your browser (<a href="http://node-ip-address:3xxxx/">http://node-ip-address:3xxxx/</a>)</li>
</ul>
<!-- ```open http://node1:3xxxx/``` -->

</div><div class="remark-slide-number">244 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="accessing-the-web-ui">Accessing the web UI</h2>
<ul>
<li>We can now connect to <em>any node</em>, on the allocated node port, to view the web UI</li>
</ul>
<div class="exercise"><ul>
<li>Open the web UI in your browser (<a href="http://node-ip-address:3xxxx/">http://node-ip-address:3xxxx/</a>)</li>
</ul>
<!-- ```open http://node1:3xxxx/``` -->

</div>

<p>Yes, this may take a little while to update. <em>(Narrator: it was DNS.)</em></p><div class="remark-slide-number">245 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="accessing-the-web-ui">Accessing the web UI</h2>
<ul>
<li>We can now connect to <em>any node</em>, on the allocated node port, to view the web UI</li>
</ul>
<div class="exercise"><ul>
<li>Open the web UI in your browser (<a href="http://node-ip-address:3xxxx/">http://node-ip-address:3xxxx/</a>)</li>
</ul>
<!-- ```open http://node1:3xxxx/``` -->

</div>

<p>Yes, this may take a little while to update. <em>(Narrator: it was DNS.)</em></p>
<p><em>Alright, we're back to where we started, when we were running on a single node!</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ourapponkube.md">k8s/ourapponkube.md</a></span></p><div class="remark-slide-number">246 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-1.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">247 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-scaling-our-demo-app" class="remark-slide-content title hljs-default"><p>Scaling our demo app</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-running-our-application-on-kubernetes">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-3">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-daemon-sets">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">248 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="scaling-our-demo-app">Scaling our demo app</h1>
<ul>
<li><p>Our ultimate goal is to get more DockerCoins</p>
<p>(i.e. increase the number of loops per second shown on the web UI)</p>
</li>
<li><p>Let's look at the architecture again:</p>
<p><img src="./Kubernetes Administrator Training_files/dockercoins-diagram.svg" alt="DockerCoins architecture"></p>
</li>
<li><p>The loop is done in the worker;
perhaps we could try adding more workers?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">249 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-another-worker">Adding another worker</h2>
<ul>
<li>All we have to do is scale the <code class="remark-inline-code">worker</code> Deployment</li>
</ul>
<div class="exercise"><ul>
<li>Open two new terminals to check what's going on with pods and deployments:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -w</div><div class="remark-code-line">kubectl get deployments -w</div></code></pre>
</li>
</ul>
<!--
```wait RESTARTS```
```keys ^C```
```wait AVAILABLE```
```keys ^C```
-->

<ul>
<li>Now, create more <code class="remark-inline-code">worker</code> replicas:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment worker --replicas=2</div></code></pre>
</li>
</ul>
</div>

<p>After a few seconds, the graph in the web UI should show up.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">250 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-more-workers">Adding more workers</h2>
<ul>
<li>If 2 workers give us 2x speed, what about 3 workers?</li>
</ul>
<div class="exercise"><ul>
<li>Scale the <code class="remark-inline-code">worker</code> Deployment further:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment worker --replicas=3</div></code></pre>
</li>
</ul>
</div>

<p>The graph in the web UI should go up again.</p>
<p>(This is looking great! We're gonna be RICH!)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">251 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-even-more-workers">Adding even more workers</h2>
<ul>
<li>Let's see if 10 workers give us 10x speed!</li>
</ul>
<div class="exercise"><ul>
<li>Scale the <code class="remark-inline-code">worker</code> Deployment to a bigger number:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment worker --replicas=10</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">252 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="adding-even-more-workers">Adding even more workers</h2>
<ul>
<li>Let's see if 10 workers give us 10x speed!</li>
</ul>
<div class="exercise"><ul>
<li>Scale the <code class="remark-inline-code">worker</code> Deployment to a bigger number:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment worker --replicas=10</div></code></pre>
</li>
</ul>
</div>

<p>The graph will peak at 10 hashes/second.</p>
<p>(We can add as many workers as we want: we will never go past 10 hashes/second.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">253 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="didn-t-we-briefly-exceed-10-hashes-second-">Didn't we briefly exceed 10 hashes/second?</h2>
<ul>
<li><p>It may <em>look like it</em>, because the web UI shows instant speed</p>
</li>
<li><p>The instant speed can briefly exceed 10 hashes/second</p>
</li>
<li><p>The average speed cannot</p>
</li>
<li><p>The instant speed can be biased because of how it's computed</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">254 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="why-instant-speed-is-misleading">Why instant speed is misleading</h2>
<ul>
<li><p>The instant speed is computed client-side by the web UI</p>
</li>
<li><p>The web UI checks the hash counter once per second
<br>
(and does a classic (h2-h1)/(t2-t1) speed computation)</p>
</li>
<li><p>The counter is updated once per second by the workers</p>
</li>
<li><p>These timings are not exact
<br>
(e.g. the web UI check interval is client-side JavaScript)</p>
</li>
<li><p>Sometimes, between two web UI counter measurements,
<br>
the workers are able to update the counter <em>twice</em></p>
</li>
<li><p>During that cycle, the instant speed will appear to be much bigger
<br>
(but it will be compensated by lower instant speed before and after)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">255 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="why-are-we-stuck-at-10-hashes-per-second-">Why are we stuck at 10 hashes per second?</h2>
<ul>
<li><p>If this was high-quality, production code, we would have instrumentation</p>
<p>(Datadog, Honeycomb, New Relic, statsd, Sumologic, ...)</p>
</li>
<li><p>It's not!</p>
</li>
<li><p>Perhaps we could benchmark our web services?</p>
<p>(with tools like <code class="remark-inline-code">ab</code>, or even simpler, <code class="remark-inline-code">httping</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">256 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="benchmarking-our-web-services">Benchmarking our web services</h2>
<ul>
<li><p>We want to check <code class="remark-inline-code">hasher</code> and <code class="remark-inline-code">rng</code></p>
</li>
<li><p>We are going to use <code class="remark-inline-code">httping</code></p>
</li>
<li><p>It's just like <code class="remark-inline-code">ping</code>, but using HTTP <code class="remark-inline-code">GET</code> requests</p>
<p>(it measures how long it takes to perform one <code class="remark-inline-code">GET</code> request)</p>
</li>
<li><p>It's used like this:</p>
<pre><code class="remark-code"><div class="remark-code-line">httping [-c count] http://host:port/path</div></code></pre></li>
<li><p>Or even simpler:</p>
<pre><code class="remark-code"><div class="remark-code-line">httping ip.ad.dr.ess</div></code></pre></li>
<li><p>We will use <code class="remark-inline-code">httping</code> on the ClusterIP addresses of our services</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">257 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="obtaining-clusterip-addresses">Obtaining ClusterIP addresses</h2>
<ul>
<li><p>We can simply check the output of <code class="remark-inline-code">kubectl get services</code></p>
</li>
<li><p>Or do it programmatically, as in the example below</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Retrieve the IP addresses:<pre><code class="bash hljs remark-code"><div class="remark-code-line">HASHER=$(kubectl get svc hasher -o go-template={{.spec.clusterIP}})</div><div class="remark-code-line">RNG=$(kubectl get svc rng -o go-template={{.spec.clusterIP}})</div></code></pre>
</li>
</ul>
</div>

<p>Now we can access the IP addresses of our services through <code class="remark-inline-code">$HASHER</code> and <code class="remark-inline-code">$RNG</code>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">258 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-hasher-and-rng-response-times">Checking <code class="remark-inline-code">hasher</code> and <code class="remark-inline-code">rng</code> response times</h2>
<div class="exercise"><ul>
<li>Check the response times for both services:<pre><code class="bash hljs remark-code"><div class="remark-code-line">httping -c 3 <span class="hljs-variable">$HASHER</span></div><div class="remark-code-line">httping -c 3 <span class="hljs-variable">$RNG</span></div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p><code class="remark-inline-code">hasher</code> is fine (it should take a few milliseconds to reply)</p>
</li>
<li><p><code class="remark-inline-code">rng</code> is not (it should take about 700 milliseconds if there are 10 workers)</p>
</li>
<li><p>Something is wrong with <code class="remark-inline-code">rng</code>, but ... what?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/scalingdockercoins.md">k8s/scalingdockercoins.md</a></span></p><div class="remark-slide-number">259 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="let-s-draw-hasty-conclusions">Let's draw hasty conclusions</h2>
<ul>
<li><p>The bottleneck seems to be <code class="remark-inline-code">rng</code></p>
</li>
<li><p><em>What if</em> we don't have enough entropy and can't generate enough random numbers?</p>
</li>
<li><p>We need to scale out the <code class="remark-inline-code">rng</code> service on multiple machines!</p>
</li>
</ul>
<p>Note: this is a fiction! We have enough entropy. But we need a pretext to scale out.</p>
<p>(In fact, the code of <code class="remark-inline-code">rng</code> uses <code class="remark-inline-code">/dev/urandom</code>, which never runs out of entropy...
<br>
...and is <a href="http://www.slideshare.net/PacSecJP/filippo-plain-simple-reality-of-entropy">just as good as <code class="remark-inline-code">/dev/random</code></a>.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/hastyconclusions.md">shared/hastyconclusions.md</a></span></p><div class="remark-slide-number">260 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-2.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">261 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-daemon-sets" class="remark-slide-content title hljs-default"><p>Daemon sets</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-scaling-our-demo-app">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-3">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-labels-and-selectors">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">262 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="daemon-sets">Daemon sets</h1>
<ul>
<li><p>We want to scale <code class="remark-inline-code">rng</code> in a way that is different from how we scaled <code class="remark-inline-code">worker</code></p>
</li>
<li><p>We want one (and exactly one) instance of <code class="remark-inline-code">rng</code> per node</p>
</li>
<li><p>What if we just scale up <code class="remark-inline-code">deploy/rng</code> to the number of nodes?</p>
<ul>
<li><p>nothing guarantees that the <code class="remark-inline-code">rng</code> containers will be distributed evenly</p>
</li>
<li><p>if we add nodes later, they will not automatically run a copy of <code class="remark-inline-code">rng</code></p>
</li>
<li><p>if we remove (or reboot) a node, one <code class="remark-inline-code">rng</code> container will restart elsewhere</p>
</li>
</ul>
</li>
<li><p>Instead of a <code class="remark-inline-code">deployment</code>, we will use a <code class="remark-inline-code">daemonset</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">263 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="daemon-sets-in-practice">Daemon sets in practice</h2>
<ul>
<li><p>Daemon sets are great for cluster-wide, per-node processes:</p>
<ul>
<li><p><code class="remark-inline-code">kube-proxy</code></p>
</li>
<li><p><code class="remark-inline-code">weave</code> (our overlay network)</p>
</li>
<li><p>monitoring agents</p>
</li>
<li><p>hardware management tools (e.g. SCSI/FC HBA agents)</p>
</li>
<li><p>etc.</p>
</li>
</ul>
</li>
<li><p>They can also be restricted to run <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#running-pods-on-only-some-nodes">only on some nodes</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">264 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-a-daemon-set">Creating a daemon set</h2>
<!-- ##VERSION## -->

<ul>
<li>Unfortunately, as of Kubernetes 1.14, the CLI cannot create daemon sets</li>
</ul><div class="remark-slide-number">265 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="creating-a-daemon-set">Creating a daemon set</h2>
<!-- ##VERSION## -->

<ul>
<li><p>Unfortunately, as of Kubernetes 1.14, the CLI cannot create daemon sets</p>
</li>
<li><p>More precisely: it doesn't have a subcommand to create a daemon set</p>
</li>
</ul><div class="remark-slide-number">266 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="creating-a-daemon-set">Creating a daemon set</h2>
<!-- ##VERSION## -->

<ul>
<li><p>Unfortunately, as of Kubernetes 1.14, the CLI cannot create daemon sets</p>
</li>
<li><p>More precisely: it doesn't have a subcommand to create a daemon set</p>
</li>
<li><p>But any kind of resource can always be created by providing a YAML description:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> foo.yaml</div></code></pre>
</li>
</ul><div class="remark-slide-number">267 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="creating-a-daemon-set">Creating a daemon set</h2>
<!-- ##VERSION## -->

<ul>
<li><p>Unfortunately, as of Kubernetes 1.14, the CLI cannot create daemon sets</p>
</li>
<li><p>More precisely: it doesn't have a subcommand to create a daemon set</p>
</li>
<li><p>But any kind of resource can always be created by providing a YAML description:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> foo.yaml</div></code></pre>
</li>
</ul>
<ul>
<li>How do we create the YAML file for our daemon set?</li>
</ul><div class="remark-slide-number">268 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="creating-a-daemon-set">Creating a daemon set</h2>
<!-- ##VERSION## -->

<ul>
<li><p>Unfortunately, as of Kubernetes 1.14, the CLI cannot create daemon sets</p>
</li>
<li><p>More precisely: it doesn't have a subcommand to create a daemon set</p>
</li>
<li><p>But any kind of resource can always be created by providing a YAML description:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> foo.yaml</div></code></pre>
</li>
</ul>
<ul>
<li><p>How do we create the YAML file for our daemon set?</p>
<ul>
<li>option 1: <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#create-a-daemonset">read the docs</a></li>
</ul>
</li>
</ul><div class="remark-slide-number">269 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="creating-a-daemon-set">Creating a daemon set</h2>
<!-- ##VERSION## -->

<ul>
<li><p>Unfortunately, as of Kubernetes 1.14, the CLI cannot create daemon sets</p>
</li>
<li><p>More precisely: it doesn't have a subcommand to create a daemon set</p>
</li>
<li><p>But any kind of resource can always be created by providing a YAML description:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> foo.yaml</div></code></pre>
</li>
</ul>
<ul>
<li><p>How do we create the YAML file for our daemon set?</p>
<ul>
<li><p>option 1: <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#create-a-daemonset">read the docs</a></p>
</li>
<li><p>option 2: <code class="remark-inline-code">vi</code> our way out of it</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">270 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-the-yaml-file-for-our-daemon-set">Creating the YAML file for our daemon set</h2>
<ul>
<li>Let's start with the YAML file for the current <code class="remark-inline-code">rng</code> resource</li>
</ul>
<div class="exercise"><ul>
<li><p>Dump the <code class="remark-inline-code">rng</code> resource in YAML:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get deploy/rng -o yaml &gt;rng.yml</div></code></pre>
</li>
<li><p>Edit <code class="remark-inline-code">rng.yml</code></p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">271 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-casting-a-resource-to-another">"Casting" a resource to another</h2>
<ul>
<li><p>What if we just changed the <code class="remark-inline-code">kind</code> field?</p>
<p>(It can't be that easy, right?)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Change <code class="remark-inline-code">kind: Deployment</code> to <code class="remark-inline-code">kind: DaemonSet</code></li>
</ul>
<!--
```bash vim rng.yml```
```wait kind: Deployment```
```keys /Deployment```
```keys ^J```
```keys cwDaemonSet```
```keys ^[``` ]
```keys :wq```
```keys ^J```
-->

<ul>
<li><p>Save, quit</p>
</li>
<li><p>Try to create our new resource:</p>
<pre><code class="remark-code"><div class="remark-code-line">kubectl apply -f rng.yml</div></code></pre></li>
</ul>
</div><div class="remark-slide-number">272 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="-casting-a-resource-to-another">"Casting" a resource to another</h2>
<ul>
<li><p>What if we just changed the <code class="remark-inline-code">kind</code> field?</p>
<p>(It can't be that easy, right?)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Change <code class="remark-inline-code">kind: Deployment</code> to <code class="remark-inline-code">kind: DaemonSet</code></li>
</ul>
<!--
```bash vim rng.yml```
```wait kind: Deployment```
```keys /Deployment```
```keys ^J```
```keys cwDaemonSet```
```keys ^[``` ]
```keys :wq```
```keys ^J```
-->

<ul>
<li><p>Save, quit</p>
</li>
<li><p>Try to create our new resource:</p>
<pre><code class="remark-code"><div class="remark-code-line">kubectl apply -f rng.yml</div></code></pre></li>
</ul>
</div>

<p>We all knew this couldn't be that easy, right!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">273 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="understanding-the-problem">Understanding the problem</h2>
<ul>
<li>The core of the error is:<pre><code class="remark-code"><div class="remark-code-line">error validating data:</div><div class="remark-code-line">[ValidationError(DaemonSet.spec):</div><div class="remark-code-line">unknown field "replicas" in io.k8s.api.extensions.v1beta1.DaemonSetSpec,</div><div class="remark-code-line">...</div></code></pre></li>
</ul><div class="remark-slide-number">274 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="understanding-the-problem">Understanding the problem</h2>
<ul>
<li>The core of the error is:<pre><code class="remark-code"><div class="remark-code-line">error validating data:</div><div class="remark-code-line">[ValidationError(DaemonSet.spec):</div><div class="remark-code-line">unknown field "replicas" in io.k8s.api.extensions.v1beta1.DaemonSetSpec,</div><div class="remark-code-line">...</div></code></pre></li>
</ul>
<ul>
<li><em>Obviously,</em> it doesn't make sense to specify a number of replicas for a daemon set</li>
</ul><div class="remark-slide-number">275 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="understanding-the-problem">Understanding the problem</h2>
<ul>
<li>The core of the error is:<pre><code class="remark-code"><div class="remark-code-line">error validating data:</div><div class="remark-code-line">[ValidationError(DaemonSet.spec):</div><div class="remark-code-line">unknown field "replicas" in io.k8s.api.extensions.v1beta1.DaemonSetSpec,</div><div class="remark-code-line">...</div></code></pre></li>
</ul>
<ul>
<li><p><em>Obviously,</em> it doesn't make sense to specify a number of replicas for a daemon set</p>
</li>
<li><p>Workaround: fix the YAML</p>
<ul>
<li>remove the <code class="remark-inline-code">replicas</code> field</li>
<li>remove the <code class="remark-inline-code">strategy</code> field (which defines the rollout mechanism for a deployment)</li>
<li>remove the <code class="remark-inline-code">progressDeadlineSeconds</code> field (also used by the rollout mechanism)</li>
<li>remove the <code class="remark-inline-code">status: {}</code> line at the end</li>
</ul>
</li>
</ul><div class="remark-slide-number">276 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="understanding-the-problem">Understanding the problem</h2>
<ul>
<li>The core of the error is:<pre><code class="remark-code"><div class="remark-code-line">error validating data:</div><div class="remark-code-line">[ValidationError(DaemonSet.spec):</div><div class="remark-code-line">unknown field "replicas" in io.k8s.api.extensions.v1beta1.DaemonSetSpec,</div><div class="remark-code-line">...</div></code></pre></li>
</ul>
<ul>
<li><p><em>Obviously,</em> it doesn't make sense to specify a number of replicas for a daemon set</p>
</li>
<li><p>Workaround: fix the YAML</p>
<ul>
<li>remove the <code class="remark-inline-code">replicas</code> field</li>
<li>remove the <code class="remark-inline-code">strategy</code> field (which defines the rollout mechanism for a deployment)</li>
<li>remove the <code class="remark-inline-code">progressDeadlineSeconds</code> field (also used by the rollout mechanism)</li>
<li>remove the <code class="remark-inline-code">status: {}</code> line at the end</li>
</ul>
</li>
<li><p>Or, we could also ...</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">277 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="use-the-force-luke">Use the <code class="remark-inline-code">--force</code>, Luke</h2>
<ul>
<li><p>We could also tell Kubernetes to ignore these errors and try anyway</p>
</li>
<li><p>The <code class="remark-inline-code">--force</code> flag's actual name is <code class="remark-inline-code">--validate=false</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Try to load our YAML file and ignore errors:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> rng.yml --validate=<span class="hljs-literal">false</span></div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">278 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="use-the-force-luke">Use the <code class="remark-inline-code">--force</code>, Luke</h2>
<ul>
<li><p>We could also tell Kubernetes to ignore these errors and try anyway</p>
</li>
<li><p>The <code class="remark-inline-code">--force</code> flag's actual name is <code class="remark-inline-code">--validate=false</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Try to load our YAML file and ignore errors:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> rng.yml --validate=<span class="hljs-literal">false</span></div></code></pre>
</li>
</ul>
</div>

<p>🎩✨🐇</p><div class="remark-slide-number">279 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="use-the-force-luke">Use the <code class="remark-inline-code">--force</code>, Luke</h2>
<ul>
<li><p>We could also tell Kubernetes to ignore these errors and try anyway</p>
</li>
<li><p>The <code class="remark-inline-code">--force</code> flag's actual name is <code class="remark-inline-code">--validate=false</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Try to load our YAML file and ignore errors:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> rng.yml --validate=<span class="hljs-literal">false</span></div></code></pre>
</li>
</ul>
</div>

<p>🎩✨🐇</p>
<p>Wait ... Now, can it be <em>that</em> easy?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">280 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-what-we-ve-done">Checking what we've done</h2>
<ul>
<li>Did we transform our <code class="remark-inline-code">deployment</code> into a <code class="remark-inline-code">daemonset</code>?</li>
</ul>
<div class="exercise"><ul>
<li>Look at the resources that we have now:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">281 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="checking-what-we-ve-done">Checking what we've done</h2>
<ul>
<li>Did we transform our <code class="remark-inline-code">deployment</code> into a <code class="remark-inline-code">daemonset</code>?</li>
</ul>
<div class="exercise"><ul>
<li>Look at the resources that we have now:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>We have two resources called <code class="remark-inline-code">rng</code>:</p>
<ul>
<li><p>the <em>deployment</em> that was existing before</p>
</li>
<li><p>the <em>daemon set</em> that we just created</p>
</li>
</ul>
<p>We also have one too many pods.
<br>
(The pod corresponding to the <em>deployment</em> still exists.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">282 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-deploy-rng-and-ds-rng-"><code class="remark-inline-code">deploy/rng</code> and <code class="remark-inline-code">ds/rng</code></h2>
<ul>
<li><p>You can have different resource types with the same name</p>
<p>(i.e. a <em>deployment</em> and a <em>daemon set</em> both named <code class="remark-inline-code">rng</code>)</p>
</li>
<li><p>We still have the old <code class="remark-inline-code">rng</code> <em>deployment</em></p>
<pre><code class="remark-code"><div class="remark-code-line">NAME                       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</div><div class="remark-code-line">deployment.apps/rng        1         1         1            1           18m</div></code></pre></li>
<li><p>But now we have the new <code class="remark-inline-code">rng</code> <em>daemon set</em> as well</p>
<pre><code class="remark-code"><div class="remark-code-line">NAME                DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE  NODE SELECTOR  AGE</div><div class="remark-code-line">daemonset.apps/rng  2        2        2      2           2          &lt;none&gt;         9s</div></code></pre></li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">283 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="too-many-pods">Too many pods</h2>
<ul>
<li><p>If we check with <code class="remark-inline-code">kubectl get pods</code>, we see:</p>
<ul>
<li><p><em>one pod</em> for the deployment (named <code class="remark-inline-code">rng-xxxxxxxxxx-yyyyy</code>)</p>
</li>
<li><p><em>one pod per node</em> for the daemon set (named <code class="remark-inline-code">rng-zzzzz</code>)</p>
</li>
</ul>
<pre><code class="remark-code"><div class="remark-code-line">NAME                        READY     STATUS    RESTARTS   AGE</div><div class="remark-code-line">rng-54f57d4d49-7pt82        1/1       Running   0          11m</div><div class="remark-code-line">rng-b85tm                   1/1       Running   0          25s</div><div class="remark-code-line">rng-hfbrr                   1/1       Running   0          25s</div><div class="remark-code-line">[...]</div></code></pre></li>
</ul><div class="remark-slide-number">284 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="too-many-pods">Too many pods</h2>
<ul>
<li><p>If we check with <code class="remark-inline-code">kubectl get pods</code>, we see:</p>
<ul>
<li><p><em>one pod</em> for the deployment (named <code class="remark-inline-code">rng-xxxxxxxxxx-yyyyy</code>)</p>
</li>
<li><p><em>one pod per node</em> for the daemon set (named <code class="remark-inline-code">rng-zzzzz</code>)</p>
</li>
</ul>
<pre><code class="remark-code"><div class="remark-code-line">NAME                        READY     STATUS    RESTARTS   AGE</div><div class="remark-code-line">rng-54f57d4d49-7pt82        1/1       Running   0          11m</div><div class="remark-code-line">rng-b85tm                   1/1       Running   0          25s</div><div class="remark-code-line">rng-hfbrr                   1/1       Running   0          25s</div><div class="remark-code-line">[...]</div></code></pre></li>
</ul>
<p>The daemon set created one pod per node, except on the master node.</p>
<p>The master node has <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/">taints</a> preventing pods from running there.</p>
<p>(To schedule a pod on this node anyway, the pod will require appropriate <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/">tolerations</a>.)</p>
<p><span class="footnote">(Off by one? We don't run these pods on the node hosting the control plane.)</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">285 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-">Is this working?</h2>
<ul>
<li>Look at the web UI</li>
</ul><div class="remark-slide-number">286 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-">Is this working?</h2>
<ul>
<li><p>Look at the web UI</p>
</li>
<li><p>The graph should now go above 10 hashes per second!</p>
</li>
</ul><div class="remark-slide-number">287 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="is-this-working-">Is this working?</h2>
<ul>
<li><p>Look at the web UI</p>
</li>
<li><p>The graph should now go above 10 hashes per second!</p>
</li>
<li><p>It looks like the newly created pods are serving traffic correctly</p>
</li>
<li><p>How and why did this happen?</p>
<p>(We didn't do anything special to add them to the <code class="remark-inline-code">rng</code> service load balancer!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">288 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/two-containers-on-a-truck.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">289 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-labels-and-selectors" class="remark-slide-content title hljs-default"><p>Labels and selectors</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-daemon-sets">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-3">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-rolling-updates">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">290 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="labels-and-selectors">Labels and selectors</h1>
<ul>
<li><p>The <code class="remark-inline-code">rng</code> <em>service</em> is load balancing requests to a set of pods</p>
</li>
<li><p>That set of pods is defined by the <em>selector</em> of the <code class="remark-inline-code">rng</code> service</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check the <em>selector</em> in the <code class="remark-inline-code">rng</code> service definition:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl describe service rng</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>The selector is <code class="remark-inline-code">app=rng</code></p>
</li>
<li><p>It means "all the pods having the label <code class="remark-inline-code">app=rng</code>"</p>
<p>(They can have additional labels as well, that's OK!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">291 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="selector-evaluation">Selector evaluation</h2>
<ul>
<li><p>We can use selectors with many <code class="remark-inline-code">kubectl</code> commands</p>
</li>
<li><p>For instance, with <code class="remark-inline-code">kubectl get</code>, <code class="remark-inline-code">kubectl logs</code>, <code class="remark-inline-code">kubectl delete</code> ... and more</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Get the list of pods matching selector <code class="remark-inline-code">app=rng</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods <span class="hljs-_">-l</span> app=rng</div><div class="remark-code-line">kubectl get pods --selector app=rng</div></code></pre>
</li>
</ul>
</div>

<p>But ... why do these pods (in particular, the <em>new</em> ones) have this <code class="remark-inline-code">app=rng</code> label?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">292 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="where-do-labels-come-from-">Where do labels come from?</h2>
<ul>
<li><p>When we create a deployment with <code class="remark-inline-code">kubectl create deployment rng</code>,
<br>this deployment gets the label <code class="remark-inline-code">app=rng</code></p>
</li>
<li><p>The replica sets created by this deployment also get the label <code class="remark-inline-code">app=rng</code></p>
</li>
<li><p>The pods created by these replica sets also get the label <code class="remark-inline-code">app=rng</code></p>
</li>
<li><p>When we created the daemon set from the deployment, we re-used the same spec</p>
</li>
<li><p>Therefore, the pods created by the daemon set get the same labels</p>
</li>
</ul>
<p><span class="footnote">Note: when we use <code class="remark-inline-code">kubectl run stuff</code>, the label is <code class="remark-inline-code">run=stuff</code> instead.</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">293 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-load-balancer-configuration">Updating load balancer configuration</h2>
<ul>
<li><p>We would like to remove a pod from the load balancer</p>
</li>
<li><p>What would happen if we removed that pod, with <code class="remark-inline-code">kubectl delete pod ...</code>?</p>
</li>
</ul><div class="remark-slide-number">294 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="updating-load-balancer-configuration">Updating load balancer configuration</h2>
<ul>
<li><p>We would like to remove a pod from the load balancer</p>
</li>
<li><p>What would happen if we removed that pod, with <code class="remark-inline-code">kubectl delete pod ...</code>?</p>
<p>It would be re-created immediately (by the replica set or the daemon set)</p>
</li>
</ul><div class="remark-slide-number">295 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="updating-load-balancer-configuration">Updating load balancer configuration</h2>
<ul>
<li><p>We would like to remove a pod from the load balancer</p>
</li>
<li><p>What would happen if we removed that pod, with <code class="remark-inline-code">kubectl delete pod ...</code>?</p>
<p>It would be re-created immediately (by the replica set or the daemon set)</p>
</li>
<li><p>What would happen if we removed the <code class="remark-inline-code">app=rng</code> label from that pod?</p>
</li>
</ul><div class="remark-slide-number">296 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="updating-load-balancer-configuration">Updating load balancer configuration</h2>
<ul>
<li><p>We would like to remove a pod from the load balancer</p>
</li>
<li><p>What would happen if we removed that pod, with <code class="remark-inline-code">kubectl delete pod ...</code>?</p>
<p>It would be re-created immediately (by the replica set or the daemon set)</p>
</li>
<li><p>What would happen if we removed the <code class="remark-inline-code">app=rng</code> label from that pod?</p>
<p>It would <em>also</em> be re-created immediately</p>
</li>
</ul><div class="remark-slide-number">297 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="updating-load-balancer-configuration">Updating load balancer configuration</h2>
<ul>
<li><p>We would like to remove a pod from the load balancer</p>
</li>
<li><p>What would happen if we removed that pod, with <code class="remark-inline-code">kubectl delete pod ...</code>?</p>
<p>It would be re-created immediately (by the replica set or the daemon set)</p>
</li>
<li><p>What would happen if we removed the <code class="remark-inline-code">app=rng</code> label from that pod?</p>
<p>It would <em>also</em> be re-created immediately</p>
<p>Why?!?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">298 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="selectors-for-replica-sets-and-daemon-sets">Selectors for replica sets and daemon sets</h2>
<ul>
<li><p>The "mission" of a replica set is:</p>
<p>"Make sure that there is the right number of pods matching this spec!"</p>
</li>
<li><p>The "mission" of a daemon set is:</p>
<p>"Make sure that there is a pod matching this spec on each node!"</p>
</li>
</ul><div class="remark-slide-number">299 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="selectors-for-replica-sets-and-daemon-sets">Selectors for replica sets and daemon sets</h2>
<ul>
<li><p>The "mission" of a replica set is:</p>
<p>"Make sure that there is the right number of pods matching this spec!"</p>
</li>
<li><p>The "mission" of a daemon set is:</p>
<p>"Make sure that there is a pod matching this spec on each node!"</p>
</li>
<li><p><em>In fact,</em> replica sets and daemon sets do not check pod specifications</p>
</li>
<li><p>They merely have a <em>selector</em>, and they look for pods matching that selector</p>
</li>
<li><p>Yes, we can fool them by manually creating pods with the "right" labels</p>
</li>
<li><p>Bottom line: if we remove our <code class="remark-inline-code">app=rng</code> label ...</p>
<p>... The pod "disappears" for its parent, which re-creates another pod to replace it</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">300 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="isolation-of-replica-sets-and-daemon-sets">Isolation of replica sets and daemon sets</h2>
<ul>
<li><p>Since both the <code class="remark-inline-code">rng</code> daemon set and the <code class="remark-inline-code">rng</code> replica set use <code class="remark-inline-code">app=rng</code> ...</p>
<p>... Why don't they "find" each other's pods?</p>
</li>
</ul><div class="remark-slide-number">301 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content extra-details hljs-default"><h2 id="isolation-of-replica-sets-and-daemon-sets">Isolation of replica sets and daemon sets</h2>
<ul>
<li><p>Since both the <code class="remark-inline-code">rng</code> daemon set and the <code class="remark-inline-code">rng</code> replica set use <code class="remark-inline-code">app=rng</code> ...</p>
<p>... Why don't they "find" each other's pods?</p>
</li>
<li><p><em>Replica sets</em> have a more specific selector, visible with <code class="remark-inline-code">kubectl describe</code></p>
<p>(It looks like <code class="remark-inline-code">app=rng,pod-template-hash=abcd1234</code>)</p>
</li>
<li><p><em>Daemon sets</em> also have a more specific selector, but it's invisible</p>
<p>(It looks like <code class="remark-inline-code">app=rng,controller-revision-hash=abcd1234</code>)</p>
</li>
<li><p>As a result, each controller only "sees" the pods it manages</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">302 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="removing-a-pod-from-the-load-balancer">Removing a pod from the load balancer</h2>
<ul>
<li><p>Currently, the <code class="remark-inline-code">rng</code> service is defined by the <code class="remark-inline-code">app=rng</code> selector</p>
</li>
<li><p>The only way to remove a pod is to remove or change the <code class="remark-inline-code">app</code> label</p>
</li>
<li><p>... But that will cause another pod to be created instead!</p>
</li>
<li><p>What's the solution?</p>
</li>
</ul><div class="remark-slide-number">303 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="removing-a-pod-from-the-load-balancer">Removing a pod from the load balancer</h2>
<ul>
<li><p>Currently, the <code class="remark-inline-code">rng</code> service is defined by the <code class="remark-inline-code">app=rng</code> selector</p>
</li>
<li><p>The only way to remove a pod is to remove or change the <code class="remark-inline-code">app</code> label</p>
</li>
<li><p>... But that will cause another pod to be created instead!</p>
</li>
<li><p>What's the solution?</p>
</li>
<li><p>We need to change the selector of the <code class="remark-inline-code">rng</code> service!</p>
</li>
<li><p>Let's add another label to that selector (e.g. <code class="remark-inline-code">enabled=yes</code>) </p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">304 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="complex-selectors">Complex selectors</h2>
<ul>
<li><p>If a selector specifies multiple labels, they are understood as a logical <em>AND</em></p>
<p>(In other words: the pods must match all the labels)</p>
</li>
<li><p>Kubernetes has support for advanced, set-based selectors</p>
<p>(But these cannot be used with services, at least not yet!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">305 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-plan">The plan</h2>
<ol>
<li><p>Add the label <code class="remark-inline-code">enabled=yes</code> to all our <code class="remark-inline-code">rng</code> pods</p>
</li>
<li><p>Update the selector for the <code class="remark-inline-code">rng</code> service to also include <code class="remark-inline-code">enabled=yes</code></p>
</li>
<li><p>Toggle traffic to a pod by manually adding/removing the <code class="remark-inline-code">enabled</code> label</p>
</li>
<li><p>Profit!</p>
</li>
</ol>
<p><em>Note: if we swap steps 1 and 2, it will cause a short
service disruption, because there will be a period of time
during which the service selector won't match any pod.
During that time, requests to the service will time out.
By doing things in the order above, we guarantee that there won't
be any interruption.</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">306 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-labels-to-pods">Adding labels to pods</h2>
<ul>
<li><p>We want to add the label <code class="remark-inline-code">enabled=yes</code> to all pods that have <code class="remark-inline-code">app=rng</code></p>
</li>
<li><p>We could edit each pod one by one with <code class="remark-inline-code">kubectl edit</code> ...</p>
</li>
<li><p>... Or we could use <code class="remark-inline-code">kubectl label</code> to label them all</p>
</li>
<li><p><code class="remark-inline-code">kubectl label</code> can use selectors itself</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Add <code class="remark-inline-code">enabled=yes</code> to all pods that have <code class="remark-inline-code">app=rng</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl label pods <span class="hljs-_">-l</span> app=rng enabled=yes</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">307 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-service-selector">Updating the service selector</h2>
<ul>
<li><p>We need to edit the service specification</p>
</li>
<li><p>Reminder: in the service definition, we will see <code class="remark-inline-code">app: rng</code> in two places</p>
<ul>
<li><p>the label of the service itself (we don't need to touch that one)</p>
</li>
<li><p>the selector of the service (that's the one we want to change)</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Update the service to add <code class="remark-inline-code">enabled: yes</code> to its selector:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl edit service rng</div></code></pre>
</li>
</ul>
<!--
```wait Please edit the object below```
```keys /app: rng```
```keys ^J```
```keys noenabled: yes```
```keys ^[``` ]
```keys :wq```
```keys ^J```
-->

</div><div class="remark-slide-number">308 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="updating-the-service-selector">Updating the service selector</h2>
<ul>
<li><p>We need to edit the service specification</p>
</li>
<li><p>Reminder: in the service definition, we will see <code class="remark-inline-code">app: rng</code> in two places</p>
<ul>
<li><p>the label of the service itself (we don't need to touch that one)</p>
</li>
<li><p>the selector of the service (that's the one we want to change)</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Update the service to add <code class="remark-inline-code">enabled: yes</code> to its selector:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl edit service rng</div></code></pre>
</li>
</ul>
<!--
```wait Please edit the object below```
```keys /app: rng```
```keys ^J```
```keys noenabled: yes```
```keys ^[``` ]
```keys :wq```
```keys ^J```
-->

</div>

<p>... And then we get <em>the weirdest error ever.</em> Why?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">309 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="when-the-yaml-parser-is-being-too-smart">When the YAML parser is being too smart</h2>
<ul>
<li><p>YAML parsers try to help us:</p>
<ul>
<li><p><code class="remark-inline-code">xyz</code> is the string <code class="remark-inline-code">"xyz"</code></p>
</li>
<li><p><code class="remark-inline-code">42</code> is the integer <code class="remark-inline-code">42</code></p>
</li>
<li><p><code class="remark-inline-code">yes</code> is the boolean value <code class="remark-inline-code">true</code></p>
</li>
</ul>
</li>
<li><p>If we want the string <code class="remark-inline-code">"42"</code> or the string <code class="remark-inline-code">"yes"</code>, we have to quote them</p>
</li>
<li><p>So we have to use <code class="remark-inline-code">enabled: "yes"</code></p>
</li>
</ul>
<p><span class="footnote">For a good laugh: if we had used "ja", "oui", "si" ... as the value, it would have worked!</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">310 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-service-selector-take-2">Updating the service selector, take 2</h2>
<div class="exercise"><ul>
<li>Update the service to add <code class="remark-inline-code">enabled: "yes"</code> to its selector:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl edit service rng</div></code></pre>
</li>
</ul>
<!--
```wait Please edit the object below```
```keys /app: rng```
```keys ^J```
```keys noenabled: "yes"```
```keys ^[``` ]
```keys :wq```
```keys ^J```
-->

</div>

<p>This time it should work!</p>
<p>If we did everything correctly, the web UI shouldn't show any change.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">311 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-labels">Updating labels</h2>
<ul>
<li><p>We want to disable the pod that was created by the deployment</p>
</li>
<li><p>All we have to do, is remove the <code class="remark-inline-code">enabled</code> label from that pod</p>
</li>
<li><p>To identify that pod, we can use its name</p>
</li>
<li><p>... Or rely on the fact that it's the only one with a <code class="remark-inline-code">pod-template-hash</code> label</p>
</li>
<li><p>Good to know:</p>
<ul>
<li><p><code class="remark-inline-code">kubectl label ... foo=</code> doesn't remove a label (it sets it to an empty string)</p>
</li>
<li><p>to remove label <code class="remark-inline-code">foo</code>, use <code class="remark-inline-code">kubectl label ... foo-</code></p>
</li>
<li><p>to change an existing label, we would need to add <code class="remark-inline-code">--overwrite</code></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">312 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="removing-a-pod-from-the-load-balancer">Removing a pod from the load balancer</h2>
<div class="exercise"><ul>
<li><p>In one window, check the logs of that pod:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">POD=$(kubectl get pod <span class="hljs-_">-l</span> app=rng,pod-template-hash -o name)</div><div class="remark-code-line">kubectl logs --tail 1 --follow <span class="hljs-variable">$POD</span></div></code></pre>
<p>(We should see a steady stream of HTTP logs)</p>
</li>
<li><p>In another window, remove the label from the pod:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl label pod <span class="hljs-_">-l</span> app=rng,pod-template-hash enabled-</div></code></pre>
<p>(The stream of HTTP logs should stop immediately)</p>
</li>
</ul>
</div>

<p>There might be a slight change in the web UI (since we removed a bit
of capacity from the <code class="remark-inline-code">rng</code> service). If we remove more pods,
the effect should be more visible.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">313 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="updating-the-daemon-set">Updating the daemon set</h2>
<ul>
<li><p>If we scale up our cluster by adding new nodes, the daemon set will create more pods</p>
</li>
<li><p>These pods won't have the <code class="remark-inline-code">enabled=yes</code> label</p>
</li>
<li><p>If we want these pods to have that label, we need to edit the daemon set spec</p>
</li>
<li><p>We can do that with e.g. <code class="remark-inline-code">kubectl edit daemonset rng</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">314 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="we-ve-put-resources-in-your-resources">We've put resources in your resources</h2>
<ul>
<li><p>Reminder: a daemon set is a resource that creates more resources!</p>
</li>
<li><p>There is a difference between:</p>
<ul>
<li><p>the label(s) of a resource (in the <code class="remark-inline-code">metadata</code> block in the beginning)</p>
</li>
<li><p>the selector of a resource (in the <code class="remark-inline-code">spec</code> block)</p>
</li>
<li><p>the label(s) of the resource(s) created by the first resource (in the <code class="remark-inline-code">template</code> block)</p>
</li>
</ul>
</li>
<li><p>We would need to update the selector and the template</p>
<p>(metadata labels are not mandatory)</p>
</li>
<li><p>The template must match the selector</p>
<p>(i.e. the resource will refuse to create resources that it will not select)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">315 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="labels-and-debugging">Labels and debugging</h2>
<ul>
<li><p>When a pod is misbehaving, we can delete it: another one will be recreated</p>
</li>
<li><p>But we can also change its labels</p>
</li>
<li><p>It will be removed from the load balancer (it won't receive traffic anymore)</p>
</li>
<li><p>Another pod will be recreated immediately</p>
</li>
<li><p>But the problematic pod is still here, and we can inspect and debug it</p>
</li>
<li><p>We can even re-add it to the rotation if necessary</p>
<p>(Very useful to troubleshoot intermittent and elusive bugs)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">316 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="labels-and-advanced-rollout-control">Labels and advanced rollout control</h2>
<ul>
<li><p>Conversely, we can add pods matching a service's selector</p>
</li>
<li><p>These pods will then receive requests and serve traffic</p>
</li>
<li><p>Examples:</p>
<ul>
<li><p>one-shot pod with all debug flags enabled, to collect logs</p>
</li>
<li><p>pods created automatically, but added to rotation in a second step
<br>
(by setting their label accordingly)</p>
</li>
</ul>
</li>
<li><p>This gives us building blocks for canary and blue/green deployments</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/daemonset.md">k8s/daemonset.md</a></span></p><div class="remark-slide-number">317 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/wall-of-containers.jpeg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">318 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-rolling-updates" class="remark-slide-content title hljs-default"><p>Rolling updates</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-labels-and-selectors">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-4">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-healthchecks">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">319 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="rolling-updates">Rolling updates</h1>
<ul>
<li><p>By default (without rolling updates), when a scaled resource is updated:</p>
<ul>
<li><p>new pods are created</p>
</li>
<li><p>old pods are terminated</p>
</li>
<li><p>... all at the same time</p>
</li>
<li><p>if something goes wrong, ¯\_(ツ)_/¯</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">320 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="rolling-updates">Rolling updates</h2>
<ul>
<li><p>With rolling updates, when a resource is updated, it happens progressively</p>
</li>
<li><p>Two parameters determine the pace of the rollout: <code class="remark-inline-code">maxUnavailable</code> and <code class="remark-inline-code">maxSurge</code></p>
</li>
<li><p>They can be specified in absolute number of pods, or percentage of the <code class="remark-inline-code">replicas</code> count</p>
</li>
<li><p>At any given time ...</p>
<ul>
<li><p>there will always be at least <code class="remark-inline-code">replicas</code>-<code class="remark-inline-code">maxUnavailable</code> pods available</p>
</li>
<li><p>there will never be more than <code class="remark-inline-code">replicas</code>+<code class="remark-inline-code">maxSurge</code> pods in total</p>
</li>
<li><p>there will therefore be up to <code class="remark-inline-code">maxUnavailable</code>+<code class="remark-inline-code">maxSurge</code> pods being updated</p>
</li>
</ul>
</li>
<li><p>We have the possibility of rolling back to the previous version
<br>(if the update fails or is unsatisfactory in any way)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">321 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-current-rollout-parameters">Checking current rollout parameters</h2>
<ul>
<li>Recall how we build custom reports with <code class="remark-inline-code">kubectl</code> and <code class="remark-inline-code">jq</code>:</li>
</ul>
<div class="exercise"><ul>
<li>Show the rollout plan for our deployments:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get deploy -o json |</div><div class="remark-code-line">        jq <span class="hljs-string">".items[] | {name:.metadata.name} + .spec.strategy.rollingUpdate"</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">322 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="rolling-updates-in-practice">Rolling updates in practice</h2>
<ul>
<li><p>As of Kubernetes 1.8, we can do rolling updates with:</p>
<p><code class="remark-inline-code">deployments</code>, <code class="remark-inline-code">daemonsets</code>, <code class="remark-inline-code">statefulsets</code></p>
</li>
<li><p>Editing one of these resources will automatically result in a rolling update</p>
</li>
<li><p>Rolling updates can be monitored with the <code class="remark-inline-code">kubectl rollout</code> subcommand</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">323 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="building-a-new-version-of-the-worker-service">Building a new version of the <code class="remark-inline-code">worker</code> service</h2>
<div class="warning"><p>Only run these commands if you have built and pushed DockerCoins to a local registry.
<br>
If you are using images from the Docker Hub (<code class="remark-inline-code">dockercoins/worker:v0.1</code>), skip this.</p>
</div>

<div class="exercise"><ul>
<li><p>Go to the <code class="remark-inline-code">stacks</code> directory (<code class="remark-inline-code">~/container.training/stacks</code>)</p>
</li>
<li><p>Edit <code class="remark-inline-code">dockercoins/worker/worker.py</code>; update the first <code class="remark-inline-code">sleep</code> line to sleep 1 second</p>
</li>
<li><p>Build a new tag and push it to the registry:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-comment">#export REGISTRY=localhost:3xxxx</span></div><div class="remark-code-line"><span class="hljs-built_in">export</span> TAG=v0.2</div><div class="remark-code-line">docker-compose <span class="hljs-_">-f</span> dockercoins.yml build</div><div class="remark-code-line">docker-compose <span class="hljs-_">-f</span> dockercoins.yml push</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">324 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="rolling-out-the-new-worker-service">Rolling out the new <code class="remark-inline-code">worker</code> service</h2>
<div class="exercise"><ul>
<li>Let's monitor what's going on by opening a few terminals, and run:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -w</div><div class="remark-code-line">kubectl get replicasets -w</div><div class="remark-code-line">kubectl get deployments -w</div></code></pre>
</li>
</ul>
<!--
```wait NAME```
```keys ^C```
-->

<ul>
<li>Update <code class="remark-inline-code">worker</code> either with <code class="remark-inline-code">kubectl edit</code>, or by running:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl <span class="hljs-built_in">set</span> image deploy worker worker=<span class="hljs-variable">$REGISTRY</span>/worker:<span class="hljs-variable">$TAG</span></div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">325 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="rolling-out-the-new-worker-service">Rolling out the new <code class="remark-inline-code">worker</code> service</h2>
<div class="exercise"><ul>
<li>Let's monitor what's going on by opening a few terminals, and run:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -w</div><div class="remark-code-line">kubectl get replicasets -w</div><div class="remark-code-line">kubectl get deployments -w</div></code></pre>
</li>
</ul>
<!--
```wait NAME```
```keys ^C```
-->

<ul>
<li>Update <code class="remark-inline-code">worker</code> either with <code class="remark-inline-code">kubectl edit</code>, or by running:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl <span class="hljs-built_in">set</span> image deploy worker worker=<span class="hljs-variable">$REGISTRY</span>/worker:<span class="hljs-variable">$TAG</span></div></code></pre>
</li>
</ul>
</div>

<p>That rollout should be pretty quick. What shows in the web UI?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">326 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="give-it-some-time">Give it some time</h2>
<ul>
<li><p>At first, it looks like nothing is happening (the graph remains at the same level)</p>
</li>
<li><p>According to <code class="remark-inline-code">kubectl get deploy -w</code>, the <code class="remark-inline-code">deployment</code> was updated really quickly</p>
</li>
<li><p>But <code class="remark-inline-code">kubectl get pods -w</code> tells a different story</p>
</li>
<li><p>The old <code class="remark-inline-code">pods</code> are still here, and they stay in <code class="remark-inline-code">Terminating</code> state for a while</p>
</li>
<li><p>Eventually, they are terminated; and then the graph decreases significantly</p>
</li>
<li><p>This delay is due to the fact that our worker doesn't handle signals</p>
</li>
<li><p>Kubernetes sends a "polite" shutdown request to the worker, which ignores it</p>
</li>
<li><p>After a grace period, Kubernetes gets impatient and kills the container</p>
<p>(The grace period is 30 seconds, but <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods">can be changed</a> if needed)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">327 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="rolling-out-something-invalid">Rolling out something invalid</h2>
<ul>
<li>What happens if we make a mistake?</li>
</ul>
<div class="exercise"><ul>
<li><p>Update <code class="remark-inline-code">worker</code> by specifying a non-existent image:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">export</span> TAG=v0.3</div><div class="remark-code-line">kubectl <span class="hljs-built_in">set</span> image deploy worker worker=<span class="hljs-variable">$REGISTRY</span>/worker:<span class="hljs-variable">$TAG</span></div></code></pre>
</li>
<li><p>Check what's going on:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl rollout status deploy worker</div></code></pre>
</li>
</ul>
<!--
```wait Waiting for deployment```
```keys ^C```
-->

</div><div class="remark-slide-number">328 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="rolling-out-something-invalid">Rolling out something invalid</h2>
<ul>
<li>What happens if we make a mistake?</li>
</ul>
<div class="exercise"><ul>
<li><p>Update <code class="remark-inline-code">worker</code> by specifying a non-existent image:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">export</span> TAG=v0.3</div><div class="remark-code-line">kubectl <span class="hljs-built_in">set</span> image deploy worker worker=<span class="hljs-variable">$REGISTRY</span>/worker:<span class="hljs-variable">$TAG</span></div></code></pre>
</li>
<li><p>Check what's going on:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl rollout status deploy worker</div></code></pre>
</li>
</ul>
<!--
```wait Waiting for deployment```
```keys ^C```
-->

</div>

<p>Our rollout is stuck. However, the app is not dead.</p>
<p>(After a minute, it will stabilize to be 20-25% slower.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">329 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-going-on-with-our-rollout-">What's going on with our rollout?</h2>
<ul>
<li><p>Why is our app a bit slower?</p>
</li>
<li><p>Because <code class="remark-inline-code">MaxUnavailable=25%</code></p>
<p>... So the rollout terminated 2 replicas out of 10 available</p>
</li>
<li><p>Okay, but why do we see 5 new replicas being rolled out?</p>
</li>
<li><p>Because <code class="remark-inline-code">MaxSurge=25%</code></p>
<p>... So in addition to replacing 2 replicas, the rollout is also starting 3 more</p>
</li>
<li><p>It rounded down the number of MaxUnavailable pods conservatively,
<br>
but the total number of pods being rolled out is allowed to be 25+25=50%</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">330 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="the-nitty-gritty-details">The nitty-gritty details</h2>
<ul>
<li><p>We start with 10 pods running for the <code class="remark-inline-code">worker</code> deployment</p>
</li>
<li><p>Current settings: MaxUnavailable=25% and MaxSurge=25%</p>
</li>
<li><p>When we start the rollout:</p>
<ul>
<li>two replicas are taken down (as per MaxUnavailable=25%)</li>
<li>two others are created (with the new version) to replace them</li>
<li>three others are created (with the new version) per MaxSurge=25%)</li>
</ul>
</li>
<li><p>Now we have 8 replicas up and running, and 5 being deployed</p>
</li>
<li><p>Our rollout is stuck at this point!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">331 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-the-dashboard-during-the-bad-rollout">Checking the dashboard during the bad rollout</h2>
<p>If you didn't deploy the Kubernetes dashboard earlier, just skip this slide.</p>
<div class="exercise"><ul>
<li>Check which port the dashboard is on:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-system get svc socat</div></code></pre>
</li>
</ul>
</div>

<p>Note the <code class="remark-inline-code">3xxxx</code> port.</p>
<div class="exercise"><ul>
<li>Connect to <a href="http://oneofournodes:3xxxx/">http://oneofournodes:3xxxx/</a></li>
</ul>
<!-- ```open https://node1:3xxxx/``` -->

</div><div class="remark-slide-number">332 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="checking-the-dashboard-during-the-bad-rollout">Checking the dashboard during the bad rollout</h2>
<p>If you didn't deploy the Kubernetes dashboard earlier, just skip this slide.</p>
<div class="exercise"><ul>
<li>Check which port the dashboard is on:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-system get svc socat</div></code></pre>
</li>
</ul>
</div>

<p>Note the <code class="remark-inline-code">3xxxx</code> port.</p>
<div class="exercise"><ul>
<li>Connect to <a href="http://oneofournodes:3xxxx/">http://oneofournodes:3xxxx/</a></li>
</ul>
<!-- ```open https://node1:3xxxx/``` -->

</div>

<ul>
<li>We have failures in Deployments, Pods, and Replica Sets</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">333 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="recovering-from-a-bad-rollout">Recovering from a bad rollout</h2>
<ul>
<li><p>We could push some <code class="remark-inline-code">v0.3</code> image</p>
<p>(the pod retry logic will eventually catch it and the rollout will proceed)</p>
</li>
<li><p>Or we could invoke a manual rollback</p>
</li>
</ul>
<div class="exercise"><!--
```keys
^C
```
-->

<ul>
<li>Cancel the deployment and wait for the dust to settle:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl rollout undo deploy worker</div><div class="remark-code-line">kubectl rollout status deploy worker</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">334 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="changing-rollout-parameters">Changing rollout parameters</h2>
<ul>
<li><p>We want to:</p>
<ul>
<li>revert to <code class="remark-inline-code">v0.1</code></li>
<li>be conservative on availability (always have desired number of available workers)</li>
<li>go slow on rollout speed (update only one pod at a time) </li>
<li>give some time to our workers to "warm up" before starting more</li>
</ul>
</li>
</ul>
<p>The corresponding changes can be expressed in the following YAML snippet:</p>
<div class="small"><pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  template:</span></div><div class="remark-code-line"><span class="hljs-attr">    spec:</span></div><div class="remark-code-line"><span class="hljs-attr">      containers:</span></div><div class="remark-code-line"><span class="hljs-attr">      - name:</span> worker</div><div class="remark-code-line"><span class="hljs-attr">        image:</span> $REGISTRY/worker:v0<span class="hljs-number">.1</span></div><div class="remark-code-line"><span class="hljs-attr">  strategy:</span></div><div class="remark-code-line"><span class="hljs-attr">    rollingUpdate:</span></div><div class="remark-code-line"><span class="hljs-attr">      maxUnavailable:</span> <span class="hljs-number">0</span></div><div class="remark-code-line"><span class="hljs-attr">      maxSurge:</span> <span class="hljs-number">1</span></div><div class="remark-code-line"><span class="hljs-attr">  minReadySeconds:</span> <span class="hljs-number">10</span></div></code></pre>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">335 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="applying-changes-through-a-yaml-patch">Applying changes through a YAML patch</h2>
<ul>
<li><p>We could use <code class="remark-inline-code">kubectl edit deployment worker</code></p>
</li>
<li><p>But we could also use <code class="remark-inline-code">kubectl patch</code> with the exact YAML shown before</p>
</li>
</ul>
<div class="exercise"><div class="small"><ul>
<li>Apply all our changes and wait for them to take effect:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl patch deployment worker -p <span class="hljs-string">"</span></div><div class="remark-code-line">spec:</div><div class="remark-code-line">  template:</div><div class="remark-code-line">    spec:</div><div class="remark-code-line">      containers:</div><div class="remark-code-line">      - name: worker</div><div class="remark-code-line">        image: <span class="hljs-variable">$REGISTRY</span>/worker:v0.1</div><div class="remark-code-line">  strategy:</div><div class="remark-code-line">    rollingUpdate:</div><div class="remark-code-line">      maxUnavailable: 0</div><div class="remark-code-line">      maxSurge: 1</div><div class="remark-code-line">  minReadySeconds: 10</div><div class="remark-code-line">"</div><div class="remark-code-line">kubectl rollout status deployment worker</div><div class="remark-code-line">kubectl get deploy -o json worker |</div><div class="remark-code-line">      jq <span class="hljs-string">"{name:.metadata.name} + .spec.strategy.rollingUpdate"</span></div></code></pre>
</li>
</ul>
</div> 

</div>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/rollout.md">k8s/rollout.md</a></span></p><div class="remark-slide-number">336 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">337 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-healthchecks" class="remark-slide-content title hljs-default"><p>Healthchecks</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-rolling-updates">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-4">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-owners-and-dependents-extra-material">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">338 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="healthchecks">Healthchecks</h1>
<ul>
<li><p>Kubernetes provides two kinds of healthchecks: liveness and readiness</p>
</li>
<li><p>Healthchecks are <em>probes</em> that apply to <em>containers</em> (not to pods)</p>
</li>
<li><p>Each container can have two (optional) probes:</p>
<ul>
<li><p>liveness = is this container dead or alive?</p>
</li>
<li><p>readiness = is this container ready to serve traffic?</p>
</li>
</ul>
</li>
<li><p>Different probes are available (HTTP, TCP, program execution)</p>
</li>
<li><p>Let's see the difference and how to use them!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">339 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="liveness-probe">Liveness probe</h2>
<ul>
<li><p>Indicates if the container is dead or alive</p>
</li>
<li><p>A dead container cannot come back to life</p>
</li>
<li><p>If the liveness probe fails, the container is killed</p>
<p>(to make really sure that it's really dead; no zombies or undeads!)</p>
</li>
<li><p>What happens next depends on the pod's <code class="remark-inline-code">restartPolicy</code>:</p>
<ul>
<li><p><code class="remark-inline-code">Never</code>: the container is not restarted</p>
</li>
<li><p><code class="remark-inline-code">OnFailure</code> or <code class="remark-inline-code">Always</code>: the container is restarted</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">340 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="when-to-use-a-liveness-probe">When to use a liveness probe</h2>
<ul>
<li><p>To indicate failures that can't be recovered</p>
<ul>
<li><p>deadlocks (causing all requests to time out)</p>
</li>
<li><p>internal corruption (causing all requests to error)</p>
</li>
</ul>
</li>
<li><p>If the liveness probe fails <em>N</em> consecutive times, the container is killed</p>
</li>
<li><p><em>N</em> is the <code class="remark-inline-code">failureThreshold</code> (3 by default)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">341 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="readiness-probe">Readiness probe</h2>
<ul>
<li><p>Indicates if the container is ready to serve traffic</p>
</li>
<li><p>If a container becomes "unready" (let's say busy!) it might be ready again soon</p>
</li>
<li><p>If the readiness probe fails:</p>
<ul>
<li><p>the container is <em>not</em> killed</p>
</li>
<li><p>if the pod is a member of a service, it is temporarily removed</p>
</li>
<li><p>it is re-added as soon as the readiness probe passes again</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">342 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="when-to-use-a-readiness-probe">When to use a readiness probe</h2>
<ul>
<li><p>To indicate temporary failures</p>
<ul>
<li><p>the application can only service <em>N</em> parallel connections</p>
</li>
<li><p>the runtime is busy doing garbage collection or initial data load</p>
</li>
</ul>
</li>
<li><p>The container is marked as "not ready" after <code class="remark-inline-code">failureThreshold</code> failed attempts</p>
<p>(3 by default)</p>
</li>
<li><p>It is marked again as "ready" after <code class="remark-inline-code">successThreshold</code> successful attempts</p>
<p>(1 by default)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">343 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="different-types-of-probes">Different types of probes</h2>
<ul>
<li><p>HTTP request</p>
<ul>
<li><p>specify URL of the request (and optional headers)</p>
</li>
<li><p>any status code between 200 and 399 indicates success</p>
</li>
</ul>
</li>
<li><p>TCP connection</p>
<ul>
<li>the probe succeeds if the TCP port is open</li>
</ul>
</li>
<li><p>arbitrary exec</p>
<ul>
<li><p>a command is executed in the container</p>
</li>
<li><p>exit status of zero indicates success</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">344 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="benefits-of-using-probes">Benefits of using probes</h2>
<ul>
<li><p>Rolling updates proceed when containers are <em>actually ready</em></p>
<p>(as opposed to merely started)</p>
</li>
<li><p>Containers in a broken state get killed and restarted</p>
<p>(instead of serving errors or timeouts)</p>
</li>
<li><p>Overloaded backends get removed from load balancer rotation</p>
<p>(thus improving response times across the board)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">345 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="example-http-probe">Example: HTTP probe</h2>
<p>Here is a pod template for the <code class="remark-inline-code">rng</code> web service of the DockerCoins app:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> rng-with-liveness</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> rng</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> dockercoins/rng:v0<span class="hljs-number">.1</span></div><div class="remark-code-line"><span class="hljs-attr">    livenessProbe:</span></div><div class="remark-code-line"><span class="hljs-attr">      httpGet:</span></div><div class="remark-code-line"><span class="hljs-attr">        path:</span> /</div><div class="remark-code-line"><span class="hljs-attr">        port:</span> <span class="hljs-number">80</span></div><div class="remark-code-line"><span class="hljs-attr">      initialDelaySeconds:</span> <span class="hljs-number">10</span></div><div class="remark-code-line"><span class="hljs-attr">      periodSeconds:</span> <span class="hljs-number">1</span></div></code></pre>
<p>If the backend serves an error, or takes longer than 1s, 3 times in a row, it gets killed.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">346 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="example-exec-probe">Example: exec probe</h2>
<p>Here is a pod template for a Redis server:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> redis-with-liveness</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> redis</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> redis</div><div class="remark-code-line"><span class="hljs-attr">    livenessProbe:</span></div><div class="remark-code-line"><span class="hljs-attr">      exec:</span></div><div class="remark-code-line"><span class="hljs-attr">        command:</span> [<span class="hljs-string">"redis-cli"</span>, <span class="hljs-string">"ping"</span>]</div></code></pre>
<p>If the Redis process becomes unresponsive, it will be killed.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">347 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="details-about-liveness-and-readiness-probes">Details about liveness and readiness probes</h2>
<ul>
<li><p>Probes are executed at intervals of <code class="remark-inline-code">periodSeconds</code> (default: 10)</p>
</li>
<li><p>The timeout for a probe is set with <code class="remark-inline-code">timeoutSeconds</code> (default: 1)</p>
</li>
<li><p>A probe is considered successful after <code class="remark-inline-code">successThreshold</code> successes (default: 1)</p>
</li>
<li><p>A probe is considered failing after <code class="remark-inline-code">failureThreshold</code> failures (default: 3)</p>
</li>
<li><p>If a probe is not defined, it's as if there was an "always successful" probe</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks.md">k8s/healthchecks.md</a></span></p><div class="remark-slide-number">348 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="questions-to-ask-before-adding-healthchecks">Questions to ask before adding healthchecks</h2>
<ul>
<li><p>Do we want liveness, readiness, both?</p>
<p>(sometimes, we can use the same check, but with different failure thresholds)</p>
</li>
<li><p>Do we have existing HTTP endpoints that we can use?</p>
</li>
<li><p>Do we need to add new endpoints, or perhaps use something else?</p>
</li>
<li><p>Are our healthchecks likely to use resources and/or slow down the app?</p>
</li>
<li><p>Do they depend on additional services?</p>
<p>(this can be particularly tricky, see next slide)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">349 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="healthchecks-and-dependencies">Healthchecks and dependencies</h2>
<ul>
<li><p>A good healthcheck should always indicate the health of the service itself</p>
</li>
<li><p>It should not be affected by the state of the service's dependencies</p>
</li>
<li><p>Example: a web server requiring a database connection to operate</p>
<p>(make sure that the healthcheck can report "OK" even if the database is down;
<br>
because it won't help us to restart the web server if the issue is with the DB!)</p>
</li>
<li><p>Example: a microservice calling other microservices</p>
</li>
<li><p>Example: a worker process</p>
<p>(these will generally require minor code changes to report health)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">350 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-healthchecks-to-an-app">Adding healthchecks to an app</h2>
<ul>
<li><p>Let's add healthchecks to DockerCoins!</p>
</li>
<li><p>We will examine the questions of the previous slide</p>
</li>
<li><p>Then we will review each component individually to add healthchecks</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">351 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="liveness-readiness-or-both-">Liveness, readiness, or both?</h2>
<ul>
<li><p>To answer that question, we need to see the app run for a while</p>
</li>
<li><p>Do we get temporary, recoverable glitches?</p>
<p>→ then use readiness</p>
</li>
<li><p>Or do we get hard lock-ups requiring a restart?</p>
<p>→ then use liveness</p>
</li>
<li><p>In the case of DockerCoins, we don't know yet!</p>
</li>
<li><p>Let's pick liveness</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">352 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="do-we-have-http-endpoints-that-we-can-use-">Do we have HTTP endpoints that we can use?</h2>
<ul>
<li><p>Each of the 3 web services (hasher, rng, webui) has a trivial route on <code class="remark-inline-code">/</code></p>
</li>
<li><p>These routes:</p>
<ul>
<li><p>don't seem to perform anything complex or expensive</p>
</li>
<li><p>don't seem to call other services</p>
</li>
</ul>
</li>
<li><p>Perfect!</p>
<p>(See next slides for individual details)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">353 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><ul>
<li><p><a href="https://github.com/jpetazzo/container.training/blob/master/dockercoins/hasher/hasher.rb">hasher.rb</a></p>
<pre><code class="ruby hljs remark-code"><div class="remark-code-line">get <span class="hljs-string">'/'</span> <span class="hljs-keyword">do</span></div><div class="remark-code-line">  <span class="hljs-string">"HASHER running on <span class="hljs-subst">#{Socket.gethostname}</span>\n"</span></div><div class="remark-code-line"><span class="hljs-keyword">end</span></div></code></pre>
</li>
<li><p><a href="https://github.com/jpetazzo/container.training/blob/master/dockercoins/rng/rng.py">rng.py</a></p>
<pre><code class="python hljs remark-code"><div class="remark-code-line"><span class="hljs-meta">@app.route("/")</span></div><div class="remark-code-line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span><span class="hljs-params">()</span>:</span></div><div class="remark-code-line">  <span class="hljs-keyword">return</span> <span class="hljs-string">"RNG running on {}\n"</span>.format(hostname)</div></code></pre>
</li>
<li><p><a href="https://github.com/jpetazzo/container.training/blob/master/dockercoins/webui/webui.js">webui.js</a></p>
<pre><code class="javascript hljs remark-code"><div class="remark-code-line">app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{</div><div class="remark-code-line">  res.redirect(<span class="hljs-string">'/index.html'</span>);</div><div class="remark-code-line">});</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">354 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-dockercoins">Running DockerCoins</h2>
<ul>
<li><p>We will run DockerCoins in a new, separate namespace</p>
</li>
<li><p>We will use a set of YAML manifests and pre-built images</p>
</li>
<li><p>We will add our new liveness probe to the YAML of the <code class="remark-inline-code">rng</code> DaemonSet</p>
</li>
<li><p>Then, we will deploy the application</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">355 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-a-new-namespace">Creating a new namespace</h2>
<ul>
<li>This will make sure that we don't collide / conflict with previous exercises</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the yellow namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create namespace yellow</div></code></pre>
</li>
<li><p>Switch to that namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kns yellow</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">356 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="retrieving-dockercoins-manifests">Retrieving DockerCoins manifests</h2>
<ul>
<li><p>All the manifests that we need are on a convenient repository:</p>
<p><a href="https://github.com/jpetazzo/kubercoins">https://github.com/jpetazzo/kubercoins</a></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Clone that repository:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">cd</span> ~</div><div class="remark-code-line">git <span class="hljs-built_in">clone</span> https://github.com/jpetazzo/kubercoins</div></code></pre>
</li>
<li><p>Change directory to the repository:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">cd</span> kubercoins</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">357 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-simple-http-liveness-probe">A simple HTTP liveness probe</h2>
<p>This is what our liveness probe should look like:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">containers:</span></div><div class="remark-code-line"><span class="hljs-attr">- name:</span> ...</div><div class="remark-code-line"><span class="hljs-attr">image:</span> ...</div><div class="remark-code-line"><span class="hljs-attr">livenessProbe:</span></div><div class="remark-code-line"><span class="hljs-attr">  httpGet:</span></div><div class="remark-code-line"><span class="hljs-attr">    path:</span> /</div><div class="remark-code-line"><span class="hljs-attr">    port:</span> <span class="hljs-number">80</span></div><div class="remark-code-line"><span class="hljs-attr">  initialDelaySeconds:</span> <span class="hljs-number">30</span></div><div class="remark-code-line"><span class="hljs-attr">  periodSeconds:</span> <span class="hljs-number">5</span></div></code></pre>
<p>This will give 30 seconds to the service to start. (Way more than necessary!)
<br>
It will run the probe every 5 seconds.
<br>
It will use the default timeout (1 second).
<br>
It will use the default failure threshold (3 failed attempts = dead).
<br>
It will use the default success threshold (1 successful attempt = alive).</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">358 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-the-liveness-probe">Adding the liveness probe</h2>
<ul>
<li>Let's add the liveness probe, then deploy DockerCoins</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit <code class="remark-inline-code">rng-daemonset.yaml</code> and add the liveness probe</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">vim rng-daemonset.yaml</div></code></pre>
</li>
<li><p>Load the YAML for all the resources of DockerCoins:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> .</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">359 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-the-liveness-probe">Testing the liveness probe</h2>
<ul>
<li><p>The rng service needs 100ms to process a request</p>
<p>(because it is single-threaded and sleeps 0.1s in each request)</p>
</li>
<li><p>The probe timeout is set to 1 second</p>
</li>
<li><p>If we send more than 10 requests per second per backend, it will break</p>
</li>
<li><p>Let's generate traffic and see what happens!</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Get the ClusterIP address of the rng service:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc rng</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">360 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="monitoring-the-rng-service">Monitoring the rng service</h2>
<ul>
<li>Each command below will show us what's happening on a different level</li>
</ul>
<div class="exercise"><ul>
<li><p>In one window, monitor cluster events:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get events -w</div></code></pre>
</li>
<li><p>In another window, monitor the response time of rng:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">httping <span class="remark-code-span-highlighted">&lt;ClusterIP&gt;</span></div></code></pre>
</li>
<li><p>In another window, monitor pods status:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -w</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">361 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="generating-traffic">Generating traffic</h2>
<ul>
<li>Let's use <code class="remark-inline-code">ab</code> to send concurrent requests to rng</li>
</ul>
<div class="exercise"><ul>
<li><p>In yet another window, generate traffic:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ab -c 10 -n 1000 http://<span class="remark-code-span-highlighted">&lt;ClusterIP&gt;</span>/1</div></code></pre>
</li>
<li><p>Experiment with higher values of <code class="remark-inline-code">-c</code> and see what happens</p>
</li>
</ul>
</div>

<ul>
<li><p>The <code class="remark-inline-code">-c</code> parameter indicates the number of concurrent requests</p>
</li>
<li><p>The final <code class="remark-inline-code">/1</code> is important to generate actual traffic</p>
<p>(otherwise we would use the ping endpoint, which doesn't sleep 0.1s per request)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">362 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="discussion">Discussion</h2>
<ul>
<li><p>Above a given threshold, the liveness probe starts failing</p>
<p>(about 10 concurrent requests per backend should be plenty enough)</p>
</li>
<li><p>When the liveness probe fails 3 times in a row, the container is restarted</p>
</li>
<li><p>During the restart, there is <em>less</em> capacity available</p>
</li>
<li><p>... Meaning that the other backends are likely to timeout as well</p>
</li>
<li><p>... Eventually causing all backends to be restarted</p>
</li>
<li><p>... And each fresh backend gets restarted, too</p>
</li>
<li><p>This goes on until the load goes down, or we add capacity</p>
</li>
</ul>
<p><em>This wouldn't be a good healthcheck in a real application!</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">363 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="better-healthchecks">Better healthchecks</h2>
<ul>
<li><p>We need to make sure that the healthcheck doesn't trip when
performance degrades due to external pressure</p>
</li>
<li><p>Using a readiness check would have lesser effects</p>
<p>(but it still would be an imperfect solution)</p>
</li>
<li><p>A possible combination:</p>
<ul>
<li><p>readiness check with a short timeout / low failure threshold</p>
</li>
<li><p>liveness check with a longer timeout / higher failure treshold</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">364 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="healthchecks-for-redis">Healthchecks for redis</h2>
<ul>
<li><p>A liveness probe is enough</p>
<p>(it's not useful to remove a backend from rotation when it's the only one)</p>
</li>
<li><p>We could use an exec probe running <code class="remark-inline-code">redis-cli ping</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">365 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="exec-probes-and-zombies">Exec probes and zombies</h2>
<ul>
<li><p>When using exec probes, we should make sure that we have a <em>zombie reaper</em></p>
<p>🤔🧐🧟 Wait, what?</p>
</li>
<li><p>When a process terminates, its parent must call <code class="remark-inline-code">wait()</code>/<code class="remark-inline-code">waitpid()</code></p>
<p>(this is how the parent process retrieves the child's exit status)</p>
</li>
<li><p>In the meantime, the process is in <em>zombie</em> state</p>
<p>(the process state will show as <code class="remark-inline-code">Z</code> in <code class="remark-inline-code">ps</code>, <code class="remark-inline-code">top</code> ...)</p>
</li>
<li><p>When a process is killed, its children are <em>orphaned</em> and attached to PID 1</p>
</li>
<li><p>PID 1 has the responsibility if <em>reaping</em> these processes when they terminate</p>
</li>
<li><p>OK, but how does that affect us?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">366 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="pid-1-in-containers">PID 1 in containers</h2>
<ul>
<li><p>On ordinary systems, PID 1 (<code class="remark-inline-code">/sbin/init</code>) has logic to reap processes</p>
</li>
<li><p>In containers, PID 1 is typically our application process</p>
<p>(e.g. Apache, the JVM, NGINX, Redis ...)</p>
</li>
<li><p>These <em>do not</em> take care of reaping orphans</p>
</li>
<li><p>If we use exec probes, we need to add a process reaper</p>
</li>
<li><p>We can add <a href="https://github.com/krallin/tini">tini</a> to our images</p>
</li>
<li><p>Or <a href="https://kubernetes.io/docs/tasks/configure-pod-container/share-process-namespace/">share the PID namespace between containers of a pod</a></p>
<p>(and have gcr.io/pause take care of the reaping)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">367 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="healthchecks-for-worker">Healthchecks for worker</h2>
<ul>
<li><p>Readiness isn't useful</p>
<p>(because worker isn't a backend for a service)</p>
</li>
<li><p>Liveness may help us to restart a broken worker, but how can we check it?</p>
</li>
<li><p>Embedding an HTTP server is an option</p>
<p>(but it has a high potential for unwanted side-effects and false positives)</p>
</li>
<li><p>Using a "lease" file can be relatively easy:</p>
<ul>
<li><p>touch a file during each iteration of the main loop</p>
</li>
<li><p>check the timestamp of that file from an exec probe</p>
</li>
</ul>
</li>
<li><p>Writing logs (and checking them from the probe) also works</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/healthchecks-more.md">k8s/healthchecks-more.md</a></span></p><div class="remark-slide-number">368 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/ShippingContainerSFBay.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">369 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-owners-and-dependents-extra-material" class="remark-slide-content title hljs-default"><p>Owners and dependents (extra material)</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-healthchecks">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-4">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-accessing-the-api-with-kubectl-proxy">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">370 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="owners-and-dependents-extra-material-">Owners and dependents (extra material)</h1>
<ul>
<li><p>Some objects are created by other objects</p>
<p>(example: pods created by replica sets, themselves created by deployments)</p>
</li>
<li><p>When an <em>owner</em> object is deleted, its <em>dependents</em> are deleted</p>
<p>(this is the default behavior; it can be changed)</p>
</li>
<li><p>We can delete a dependent directly if we want</p>
<p>(but generally, the owner will recreate another right away)</p>
</li>
<li><p>An object can have multiple owners</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">371 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="finding-out-the-owners-of-an-object">Finding out the owners of an object</h2>
<ul>
<li>The owners are recorded in the field <code class="remark-inline-code">ownerReferences</code> in the <code class="remark-inline-code">metadata</code> block</li>
</ul>
<div class="exercise"><ul>
<li><p>Let's create a deployment running <code class="remark-inline-code">nginx</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment yanginx --image=nginx</div></code></pre>
</li>
<li><p>Scale it to a few replicas:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment yanginx --replicas=3</div></code></pre>
</li>
<li><p>Once it's up, check the corresponding pods:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods <span class="hljs-_">-l</span> app=yanginx -o yaml | head -n 25</div></code></pre>
</li>
</ul>
</div>

<p>These pods are owned by a ReplicaSet named yanginx-xxxxxxxxxx.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">372 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="listing-objects-with-their-owners">Listing objects with their owners</h2>
<ul>
<li>This is a good opportunity to try the <code class="remark-inline-code">custom-columns</code> output!</li>
</ul>
<div class="exercise"><ul>
<li>Show all pods with their owners:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod -o custom-columns=\</div><div class="remark-code-line">NAME:.metadata.name,\</div><div class="remark-code-line">OWNER-KIND:.metadata.ownerReferences[0].kind,\</div><div class="remark-code-line">OWNER-NAME:.metadata.ownerReferences[0].name</div></code></pre>
</li>
</ul>
</div>

<p>Note: the <code class="remark-inline-code">custom-columns</code> option should be one long option (without spaces),
so the lines should not be indented (otherwise the indentation will insert spaces).</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">373 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deletion-policy">Deletion policy</h2>
<ul>
<li><p>When deleting an object through the API, three policies are available:</p>
<ul>
<li><p>foreground (API call returns after all dependents are deleted)</p>
</li>
<li><p>background (API call returns immediately; dependents are scheduled for deletion)</p>
</li>
<li><p>orphan (the dependents are not deleted)</p>
</li>
</ul>
</li>
<li><p>When deleting an object with <code class="remark-inline-code">kubectl</code>, this is selected with <code class="remark-inline-code">--cascade</code>:</p>
<ul>
<li><p><code class="remark-inline-code">--cascade=true</code> deletes all dependent objects (default)</p>
</li>
<li><p><code class="remark-inline-code">--cascade=false</code> orphans dependent objects</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">374 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-happens-when-an-object-is-deleted">What happens when an object is deleted</h2>
<ul>
<li><p>It is removed from the list of owners of its dependents</p>
</li>
<li><p>If, for one of these dependents, the list of owners becomes empty ...</p>
<ul>
<li><p>if the policy is "orphan", the object stays</p>
</li>
<li><p>otherwise, the object is deleted</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">375 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="orphaning-pods">Orphaning pods</h2>
<ul>
<li><p>We are going to delete the Deployment and Replica Set that we created</p>
</li>
<li><p>... without deleting the corresponding pods!</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Delete the Deployment:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl delete deployment <span class="hljs-_">-l</span> app=yanginx --cascade=<span class="hljs-literal">false</span></div></code></pre>
</li>
<li><p>Delete the Replica Set:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl delete replicaset <span class="hljs-_">-l</span> app=yanginx --cascade=<span class="hljs-literal">false</span></div></code></pre>
</li>
<li><p>Check that the pods are still here:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">376 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="when-and-why-would-we-have-orphans-">When and why would we have orphans?</h2>
<ul>
<li><p>If we remove an owner and explicitly instruct the API to orphan dependents</p>
<p>(like on the previous slide)</p>
</li>
<li><p>If we change the labels on a dependent, so that it's not selected anymore</p>
<p>(e.g. change the <code class="remark-inline-code">app: yanginx</code> in the pods of the previous example)</p>
</li>
<li><p>If a deployment tool that we're using does these things for us</p>
</li>
<li><p>If there is a serious problem within API machinery or other components</p>
<p>(i.e. "this should not happen")</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">377 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="finding-orphan-objects">Finding orphan objects</h2>
<ul>
<li><p>We're going to output all pods in JSON format</p>
</li>
<li><p>Then we will use <code class="remark-inline-code">jq</code> to keep only the ones <em>without</em> an owner</p>
</li>
<li><p>And we will display their name</p>
</li>
</ul>
<div class="exercise"><ul>
<li>List all pods that <em>do not</em> have an owner:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod -o json | jq -r <span class="hljs-string">"</span></div><div class="remark-code-line">      .items[]</div><div class="remark-code-line">      | select(.metadata.ownerReferences|not)</div><div class="remark-code-line">      | .metadata.name"</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">378 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deleting-orphan-pods">Deleting orphan pods</h2>
<ul>
<li>Now that we can list orphan pods, deleting them is easy</li>
</ul>
<div class="exercise"><ul>
<li>Add <code class="remark-inline-code">| xargs kubectl delete pod</code> to the previous command:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod -o json | jq -r <span class="hljs-string">"</span></div><div class="remark-code-line">      .items[]</div><div class="remark-code-line">      | select(.metadata.ownerReferences|not)</div><div class="remark-code-line">      | .metadata.name" | xargs kubectl delete pod</div></code></pre>
</li>
</ul>
</div>

<p>As always, the <a href="https://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/">documentation</a> has useful extra information and pointers.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/owners-and-dependents.md">k8s/owners-and-dependents.md</a></span></p><div class="remark-slide-number">379 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/aerial-view-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">380 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-accessing-the-api-with-kubectl-proxy" class="remark-slide-content title hljs-default"><p>Accessing the API with <code class="remark-inline-code">kubectl proxy</code></p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-owners-and-dependents-extra-material">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-5">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-controlling-the-cluster-remotely">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">381 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="accessing-the-api-with-kubectl-proxy-">Accessing the API with <code class="remark-inline-code">kubectl proxy</code></h1>
<ul>
<li><p>The API requires us to authenticate<span class="red">¹</span></p>
</li>
<li><p>There are many authentication methods available, including:</p>
<ul>
<li><p>TLS client certificates
<br>
(that's what we've used so far)</p>
</li>
<li><p>HTTP basic password authentication
<br>
(from a static file; not recommended)</p>
</li>
<li><p>various token mechanisms
<br>
(detailed in the <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#authentication-strategies">documentation</a>)</p>
</li>
</ul>
</li>
</ul>
<p><span class="red">¹</span>OK, we lied. If you don't authenticate, you are considered to
be user <code class="remark-inline-code">system:anonymous</code>, which doesn't have any access rights by default.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">382 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="accessing-the-api-directly">Accessing the API directly</h2>
<ul>
<li>Let's see what happens if we try to access the API directly with <code class="remark-inline-code">curl</code></li>
</ul>
<div class="exercise"><ul>
<li><p>Retrieve the ClusterIP allocated to the <code class="remark-inline-code">kubernetes</code> service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc kubernetes</div></code></pre>
</li>
<li><p>Replace the IP below and try to connect with <code class="remark-inline-code">curl</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k https://<span class="remark-code-span-highlighted">10.96.0.1</span>/</div></code></pre>
</li>
</ul>
</div>

<p>The API will tell us that user <code class="remark-inline-code">system:anonymous</code> cannot access this path.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">383 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authenticating-to-the-api">Authenticating to the API</h2>
<p>If we wanted to talk to the API, we would need to:</p>
<ul>
<li><p>extract our TLS key and certificate information from <code class="remark-inline-code">~/.kube/config</code></p>
<p>(the information is in PEM format, encoded in base64)</p>
</li>
<li><p>use that information to present our certificate when connecting</p>
<p>(for instance, with <code class="remark-inline-code">openssl s_client -key ... -cert ... -connect ...</code>)</p>
</li>
<li><p>figure out exactly which credentials to use</p>
<p>(once we start juggling multiple clusters)</p>
</li>
<li><p>change that whole process if we're using another authentication method</p>
</li>
</ul>
<p>🤔 There has to be a better way!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">384 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-kubectl-proxy-for-authentication">Using <code class="remark-inline-code">kubectl proxy</code> for authentication</h2>
<ul>
<li><p><code class="remark-inline-code">kubectl proxy</code> runs a proxy in the foreground</p>
</li>
<li><p>This proxy lets us access the Kubernetes API without authentication</p>
<p>(<code class="remark-inline-code">kubectl proxy</code> adds our credentials on the fly to the requests)</p>
</li>
<li><p>This proxy lets us access the Kubernetes API over plain HTTP</p>
</li>
<li><p>This is a great tool to learn and experiment with the Kubernetes API</p>
</li>
<li><p>... And for serious uses as well (suitable for one-shot scripts)</p>
</li>
<li><p>For unattended use, it's better to create a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">service account</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">385 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="trying-kubectl-proxy-">Trying <code class="remark-inline-code">kubectl proxy</code></h2>
<ul>
<li>Let's start <code class="remark-inline-code">kubectl proxy</code> and then do a simple request with <code class="remark-inline-code">curl</code>!</li>
</ul>
<div class="exercise"><ul>
<li><p>Start <code class="remark-inline-code">kubectl proxy</code> in the background:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl proxy &amp;</div></code></pre>
</li>
<li><p>Access the API's default route:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl localhost:8001</div></code></pre>
</li>
</ul>
<!--
```wait /version```
```keys ^J```
-->

<ul>
<li>Terminate the proxy:<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">kill</span> %1</div></code></pre>
</li>
</ul>
</div>

<p>The output is a list of available API routes.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">386 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-proxy-is-intended-for-local-use"><code class="remark-inline-code">kubectl proxy</code> is intended for local use</h2>
<ul>
<li><p>By default, the proxy listens on port 8001</p>
<p>(But this can be changed, or we can tell <code class="remark-inline-code">kubectl proxy</code> to pick a port)</p>
</li>
<li><p>By default, the proxy binds to <code class="remark-inline-code">127.0.0.1</code></p>
<p>(Making it unreachable from other machines, for security reasons)</p>
</li>
<li><p>By default, the proxy only accepts connections from:</p>
<p><code class="remark-inline-code">^localhost$,^127\.0\.0\.1$,^\[::1\]$</code></p>
</li>
<li><p>This is great when running <code class="remark-inline-code">kubectl proxy</code> locally</p>
</li>
<li><p>Not-so-great when you want to connect to the proxy from a remote machine</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">387 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-kubectl-proxy-on-a-remote-machine">Running <code class="remark-inline-code">kubectl proxy</code> on a remote machine</h2>
<ul>
<li><p>If we wanted to connect to the proxy from another machine, we would need to:</p>
<ul>
<li><p>bind to <code class="remark-inline-code">INADDR_ANY</code> instead of <code class="remark-inline-code">127.0.0.1</code></p>
</li>
<li><p>accept connections from any address</p>
</li>
</ul>
</li>
<li><p>This is achieved with:</p>
<pre><code class="remark-code"><div class="remark-code-line">kubectl proxy --port=8888 --address=0.0.0.0 --accept-hosts=.*</div></code></pre></li>
</ul>
<p><span class="warning">Do not do this on a real cluster: it opens full unauthenticated access!</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">388 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="security-considerations">Security considerations</h2>
<ul>
<li><p>Running <code class="remark-inline-code">kubectl proxy</code> openly is a huge security risk</p>
</li>
<li><p>It is slightly better to run the proxy where you need it</p>
<p>(and copy credentials, e.g. <code class="remark-inline-code">~/.kube/config</code>, to that place)</p>
</li>
<li><p>It is even better to use a limited account with reduced permissions</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">389 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="good-to-know-">Good to know ...</h2>
<ul>
<li><p><code class="remark-inline-code">kubectl proxy</code> also gives access to all internal services</p>
</li>
<li><p>Specifically, services are exposed as such:</p>
<pre><code class="remark-code"><div class="remark-code-line">/api/v1/namespaces/&lt;namespace&gt;/services/&lt;service&gt;/proxy</div></code></pre></li>
<li><p>We can use <code class="remark-inline-code">kubectl proxy</code> to access an internal service in a pinch</p>
<p>(or, for non HTTP services, <code class="remark-inline-code">kubectl port-forward</code>)</p>
</li>
<li><p>This is not very useful when running <code class="remark-inline-code">kubectl</code> directly on the cluster</p>
<p>(since we could connect to the services directly anyway)</p>
</li>
<li><p>But it is very powerful as soon as you run <code class="remark-inline-code">kubectl</code> from a remote machine</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kubectlproxy.md">k8s/kubectlproxy.md</a></span></p><div class="remark-slide-number">390 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/blue-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">391 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-controlling-the-cluster-remotely" class="remark-slide-content title hljs-default"><p>Controlling the cluster remotely</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-accessing-the-api-with-kubectl-proxy">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-5">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-accessing-internal-services">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">392 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="controlling-the-cluster-remotely">Controlling the cluster remotely</h1>
<ul>
<li><p>All the operations that we do with <code class="remark-inline-code">kubectl</code> can be done remotely</p>
</li>
<li><p>In this section, we are going to use <code class="remark-inline-code">kubectl</code> from our local machine</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">393 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="requirements">Requirements</h2>
<p><span class="warning">The exercises in this chapter should be done <em>on your local machine</em>.</span></p>
<ul>
<li><p><code class="remark-inline-code">kubectl</code> is officially available on Linux, macOS, Windows</p>
<p>(and unofficially anywhere we can build and run Go binaries)</p>
</li>
<li><p>You may skip these exercises if you are following along from:</p>
<ul>
<li><p>a tablet or phone</p>
</li>
<li><p>a web-based terminal</p>
</li>
<li><p>an environment where you can't install and run new binaries</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">394 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="installing-kubectl-">Installing <code class="remark-inline-code">kubectl</code></h2>
<ul>
<li>If you already have <code class="remark-inline-code">kubectl</code> on your local machine, you can skip this</li>
</ul>
<div class="exercise"><!-- ##VERSION## -->

<ul>
<li><p>Download the <code class="remark-inline-code">kubectl</code> binary from one of these links:</p>
<p><a href="https://storage.googleapis.com/kubernetes-release/release/v1.14.2/bin/linux/amd64/kubectl">Linux</a>
|
<a href="https://storage.googleapis.com/kubernetes-release/release/v1.14.2/bin/darwin/amd64/kubectl">macOS</a>
|
<a href="https://storage.googleapis.com/kubernetes-release/release/v1.14.2/bin/windows/amd64/kubectl.exe">Windows</a></p>
</li>
<li><p>On Linux and macOS, make the binary executable with <code class="remark-inline-code">chmod +x kubectl</code></p>
<p>(And remember to run it with <code class="remark-inline-code">./kubectl</code> or move it to your <code class="remark-inline-code">$PATH</code>)</p>
</li>
</ul>
</div>

<p>Note: if you are following along with a different platform (e.g. Linux on an architecture different from amd64, or with a phone or tablet), installing <code class="remark-inline-code">kubectl</code> might be more complicated (or even impossible) so feel free to skip this section.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">395 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-kubectl-">Testing <code class="remark-inline-code">kubectl</code></h2>
<ul>
<li><p>Check that <code class="remark-inline-code">kubectl</code> works correctly</p>
<p>(before even trying to connect to a remote cluster!)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Ask <code class="remark-inline-code">kubectl</code> to show its version number:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl version --client</div></code></pre>
</li>
</ul>
</div>

<p>The output should look like this:</p>
<pre><code class="remark-code"><div class="remark-code-line">Client Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.0",</div><div class="remark-code-line">GitCommit:"641856db18352033a0d96dbc99153fa3b27298e5", GitTreeState:"clean",</div><div class="remark-code-line">BuildDate:"2019-03-25T15:53:57Z", GoVersion:"go1.12.1", Compiler:"gc",</div><div class="remark-code-line">Platform:"linux/amd64"}</div></code></pre><p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">396 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="preserving-the-existing-kube-config-">Preserving the existing <code class="remark-inline-code">~/.kube/config</code></h2>
<ul>
<li><p>If you already have a <code class="remark-inline-code">~/.kube/config</code> file, rename it</p>
<p>(we are going to overwrite it in the following slides!)</p>
</li>
<li><p>If you never used <code class="remark-inline-code">kubectl</code> on your machine before: nothing to do!</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Make a copy of <code class="remark-inline-code">~/.kube/config</code>; if you are using macOS or Linux, you can do:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">cp ~/.kube/config ~/.kube/config.before.training</div></code></pre>
</li>
<li><p>If you are using Windows, you will need to adapt this command</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">397 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="copying-the-configuration-file-from-node1-">Copying the configuration file from <code class="remark-inline-code">node1</code></h2>
<ul>
<li><p>The <code class="remark-inline-code">~/.kube/config</code> file that is on <code class="remark-inline-code">node1</code> contains all the credentials we need</p>
</li>
<li><p>Let's copy it over!</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Copy the file from <code class="remark-inline-code">node1</code>; if you are using macOS or Linux, you can do:</p>
<pre><code class="remark-code"><div class="remark-code-line">scp <span class="remark-code-span-highlighted">USER</span>@<span class="remark-code-span-highlighted">X.X.X.X</span>:.kube/config ~/.kube/config</div><div class="remark-code-line"># Make sure to replace X.X.X.X with the IP address of node1,</div><div class="remark-code-line"># and USER with the user name used to log into node1!</div></code></pre></li>
<li><p>If you are using Windows, adapt these instructions to your SSH client</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">398 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-server-address">Updating the server address</h2>
<ul>
<li><p>There is a good chance that we need to update the server address</p>
</li>
<li><p>To know if it is necessary, run <code class="remark-inline-code">kubectl config view</code></p>
</li>
<li><p>Look for the <code class="remark-inline-code">server:</code> address:</p>
<ul>
<li><p>if it matches the public IP address of <code class="remark-inline-code">node1</code>, you're good!</p>
</li>
<li><p>if it is anything else (especially a private IP address), update it!</p>
</li>
</ul>
</li>
<li><p>To update the server address, run:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-cluster kubernetes --server=https://<span class="remark-code-span-highlighted">X.X.X.X</span>:6443</div><div class="remark-code-line"><span class="hljs-comment"># Make sure to replace X.X.X.X with the IP address of node1!</span></div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">399 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="what-if-we-get-a-certificate-error-">What if we get a certificate error?</h2>
<ul>
<li><p>Generally, the Kubernetes API uses a certificate that is valid for:</p>
<ul>
<li><code class="remark-inline-code">kubernetes</code></li>
<li><code class="remark-inline-code">kubernetes.default</code></li>
<li><code class="remark-inline-code">kubernetes.default.svc</code></li>
<li><code class="remark-inline-code">kubernetes.default.svc.cluster.local</code></li>
<li>the ClusterIP address of the <code class="remark-inline-code">kubernetes</code> service</li>
<li>the hostname of the node hosting the control plane (e.g. <code class="remark-inline-code">node1</code>)</li>
<li>the IP address of the node hosting the control plane</li>
</ul>
</li>
<li><p>On most clouds, the IP address of the node is an internal IP address</p>
</li>
<li><p>... And we are going to connect over the external IP address</p>
</li>
<li><p>... And that external IP address was not used when creating the certificate!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">400 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="working-around-the-certificate-error">Working around the certificate error</h2>
<ul>
<li><p>We need to tell <code class="remark-inline-code">kubectl</code> to skip TLS verification</p>
<p>(only do this with testing clusters, never in production!)</p>
</li>
<li><p>The following command will do the trick:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-cluster kubernetes --insecure-skip-tls-verify</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">401 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-that-we-can-connect-to-the-cluster">Checking that we can connect to the cluster</h2>
<ul>
<li>We can now run a couple of trivial commands to check that all is well</li>
</ul>
<div class="exercise"><ul>
<li><p>Check the versions of the local client and remote server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl version</div></code></pre>
</li>
<li><p>View the nodes of the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes</div></code></pre>
</li>
</ul>
</div>

<p>We can now utilize the cluster exactly as we did before, except that it's remote.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/localkubeconfig.md">k8s/localkubeconfig.md</a></span></p><div class="remark-slide-number">402 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/chinook-helicopter-container.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">403 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-accessing-internal-services" class="remark-slide-content title hljs-default"><p>Accessing internal services</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-controlling-the-cluster-remotely">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-5">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-the-kubernetes-dashboard">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">404 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="accessing-internal-services">Accessing internal services</h1>
<ul>
<li><p>When we are logged in on a cluster node, we can access internal services</p>
<p>(by virtue of the Kubernetes network model: all nodes can reach all pods and services)</p>
</li>
<li><p>When we are accessing a remote cluster, things are different</p>
<p>(generally, our local machine won't have access to the cluster's internal subnet)</p>
</li>
<li><p>How can we temporarily access a service without exposing it to everyone?</p>
</li>
</ul><div class="remark-slide-number">405 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="accessing-internal-services">Accessing internal services</h1>
<ul>
<li><p>When we are logged in on a cluster node, we can access internal services</p>
<p>(by virtue of the Kubernetes network model: all nodes can reach all pods and services)</p>
</li>
<li><p>When we are accessing a remote cluster, things are different</p>
<p>(generally, our local machine won't have access to the cluster's internal subnet)</p>
</li>
<li><p>How can we temporarily access a service without exposing it to everyone?</p>
</li>
<li><p><code class="remark-inline-code">kubectl proxy</code>: gives us access to the API, which includes a proxy for HTTP resources</p>
</li>
<li><p><code class="remark-inline-code">kubectl port-forward</code>: allows forwarding of TCP ports to arbitrary pods, services, ...</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md">k8s/accessinternal.md</a></span></p><div class="remark-slide-number">406 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="suspension-of-disbelief">Suspension of disbelief</h2>
<p>The exercises in this section assume that we have set up <code class="remark-inline-code">kubectl</code> on our
local machine in order to access a remote cluster.</p>
<p>We will therefore show how to access services and pods of the remote cluster,
from our local machine.</p>
<p>You can also run these exercises directly on the cluster (if you haven't
installed and set up <code class="remark-inline-code">kubectl</code> locally).</p>
<p>Running commands locally will be less useful
(since you could access services and pods directly),
but keep in mind that these commands will work anywhere as long as you have
installed and set up <code class="remark-inline-code">kubectl</code> to communicate with your cluster.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md">k8s/accessinternal.md</a></span></p><div class="remark-slide-number">407 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-proxy-in-theory"><code class="remark-inline-code">kubectl proxy</code> in theory</h2>
<ul>
<li><p>Running <code class="remark-inline-code">kubectl proxy</code> gives us access to the entire Kubernetes API</p>
</li>
<li><p>The API includes routes to proxy HTTP traffic</p>
</li>
<li><p>These routes look like the following:</p>
<p><code class="remark-inline-code">/api/v1/namespaces/&lt;namespace&gt;/services/&lt;service&gt;/proxy</code></p>
</li>
<li><p>We just add the URI to the end of the request, for instance:</p>
<p><code class="remark-inline-code">/api/v1/namespaces/&lt;namespace&gt;/services/&lt;service&gt;/proxy/index.html</code></p>
</li>
<li><p>We can access <code class="remark-inline-code">services</code> and <code class="remark-inline-code">pods</code> this way</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md">k8s/accessinternal.md</a></span></p><div class="remark-slide-number">408 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-proxy-in-practice"><code class="remark-inline-code">kubectl proxy</code> in practice</h2>
<ul>
<li>Let's access the <code class="remark-inline-code">webui</code> service through <code class="remark-inline-code">kubectl proxy</code></li>
</ul>
<div class="exercise"><ul>
<li><p>Run an API proxy in the background:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl proxy &amp;</div></code></pre>
</li>
<li><p>Access the <code class="remark-inline-code">webui</code> service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl localhost:8001/api/v1/namespaces/default/services/webui/proxy/index.html</div></code></pre>
</li>
<li><p>Terminate the proxy:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">kill</span> %1</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md">k8s/accessinternal.md</a></span></p><div class="remark-slide-number">409 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-port-forward-in-theory"><code class="remark-inline-code">kubectl port-forward</code> in theory</h2>
<ul>
<li><p>What if we want to access a TCP service?</p>
</li>
<li><p>We can use <code class="remark-inline-code">kubectl port-forward</code> instead</p>
</li>
<li><p>It will create a TCP relay to forward connections to a specific port</p>
<p>(of a pod, service, deployment...)</p>
</li>
<li><p>The syntax is:</p>
<p><code class="remark-inline-code">kubectl port-forward service/name_of_service local_port:remote_port</code></p>
</li>
<li><p>If only one port number is specified, it is used for both local and remote ports</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md">k8s/accessinternal.md</a></span></p><div class="remark-slide-number">410 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-port-forward-in-practice"><code class="remark-inline-code">kubectl port-forward</code> in practice</h2>
<ul>
<li>Let's access our remote Redis server</li>
</ul>
<div class="exercise"><ul>
<li><p>Forward connections from local port 10000 to remote port 6379:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl port-forward svc/redis 10000:6379 &amp;</div></code></pre>
</li>
<li><p>Connect to the Redis server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">telnet localhost 10000</div></code></pre>
</li>
<li><p>Issue a few commands, e.g. <code class="remark-inline-code">INFO server</code> then <code class="remark-inline-code">QUIT</code></p>
</li>
</ul>
<!--
```wait Connected to localhost```
```keys INFO server```
```keys ^J```
```keys QUIT```
```keys ^J```
-->

<ul>
<li>Terminate the port forwarder:<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">kill</span> %1</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/accessinternal.md">k8s/accessinternal.md</a></span></p><div class="remark-slide-number">411 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-cranes.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">412 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-the-kubernetes-dashboard" class="remark-slide-content title hljs-default"><p>The Kubernetes dashboard</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-accessing-internal-services">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-5">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-security-implications-of-kubectl-apply">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">413 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="the-kubernetes-dashboard">The Kubernetes dashboard</h1>
<ul>
<li><p>Kubernetes resources can also be viewed with a web dashboard</p>
</li>
<li><p>That dashboard is usually exposed over HTTPS</p>
<p>(this requires obtaining a proper TLS certificate)</p>
</li>
<li><p>Dashboard users need to authenticate</p>
</li>
<li><p>We are going to take a <em>dangerous</em> shortcut</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">414 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-insecure-method">The insecure method</h2>
<ul>
<li><p>We could (and should) use <a href="https://letsencrypt.org/">Let's Encrypt</a> ...</p>
</li>
<li><p>... but we don't want to deal with TLS certificates</p>
</li>
<li><p>We could (and should) learn how authentication and authorization work ...</p>
</li>
<li><p>... but we will use a guest account with admin access instead</p>
</li>
</ul>
<p><span class="footnote"><span class="warning">Yes, this will open our cluster to all kinds of shenanigans. Don't do this at home.</span></span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">415 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-a-very-insecure-dashboard">Running a very insecure dashboard</h2>
<ul>
<li><p>We are going to deploy that dashboard with <em>one single command</em></p>
</li>
<li><p>This command will create all the necessary resources</p>
<p>(the dashboard itself, the HTTP wrapper, the admin/guest account)</p>
</li>
<li><p>All these resources are defined in a YAML file</p>
</li>
<li><p>All we have to do is load that YAML file with with <code class="remark-inline-code">kubectl apply -f</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Create all the dashboard resources, with the following command:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/insecure-dashboard.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">416 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="connecting-to-the-dashboard">Connecting to the dashboard</h2>
<div class="exercise"><ul>
<li>Check which port the dashboard is on:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc dashboard</div></code></pre>
</li>
</ul>
</div>

<p>You'll want the <code class="remark-inline-code">3xxxx</code> port.</p>
<div class="exercise"><ul>
<li>Connect to <a href="http://oneofournodes:3xxxx/">http://oneofournodes:3xxxx/</a></li>
</ul>
<!-- ```open http://node1:3xxxx/``` -->

</div>

<p>The dashboard will then ask you which authentication you want to use.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">417 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="dashboard-authentication">Dashboard authentication</h2>
<ul>
<li><p>We have three authentication options at this point:</p>
<ul>
<li><p>token (associated with a role that has appropriate permissions)</p>
</li>
<li><p>kubeconfig (e.g. using the <code class="remark-inline-code">~/.kube/config</code> file from <code class="remark-inline-code">node1</code>)</p>
</li>
<li><p>"skip" (use the dashboard "service account")</p>
</li>
</ul>
</li>
<li><p>Let's use "skip": we're logged in!</p>
</li>
</ul><div class="remark-slide-number">418 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="dashboard-authentication">Dashboard authentication</h2>
<ul>
<li><p>We have three authentication options at this point:</p>
<ul>
<li><p>token (associated with a role that has appropriate permissions)</p>
</li>
<li><p>kubeconfig (e.g. using the <code class="remark-inline-code">~/.kube/config</code> file from <code class="remark-inline-code">node1</code>)</p>
</li>
<li><p>"skip" (use the dashboard "service account")</p>
</li>
</ul>
</li>
<li><p>Let's use "skip": we're logged in!</p>
</li>
</ul>
<p><span class="warning">By the way, we just added a backdoor to our Kubernetes cluster!</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">419 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-the-kubernetes-dashboard-securely">Running the Kubernetes dashboard securely</h2>
<ul>
<li><p>The steps that we just showed you are <em>for educational purposes only!</em></p>
</li>
<li><p>If you do that on your production cluster, people <a href="https://redlock.io/blog/cryptojacking-tesla">can and will abuse it</a></p>
</li>
<li><p>For an in-depth discussion about securing the dashboard,
<br>
check <a href="https://blog.heptio.com/on-securing-the-kubernetes-dashboard-16b09b1b7aca">this excellent post on Heptio's blog</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">420 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-housing.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">421 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-security-implications-of-kubectl-apply" class="remark-slide-content title hljs-default"><p>Security implications of <code class="remark-inline-code">kubectl apply</code></p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-the-kubernetes-dashboard">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-5">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-exposing-http-services-with-ingress-resources">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">422 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="security-implications-of-kubectl-apply-">Security implications of <code class="remark-inline-code">kubectl apply</code></h1>
<ul>
<li><p>When we do <code class="remark-inline-code">kubectl apply -f &lt;URL&gt;</code>, we create arbitrary resources</p>
</li>
<li><p>Resources can be evil; imagine a <code class="remark-inline-code">deployment</code> that ...</p>
</li>
</ul><div class="remark-slide-number">423 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="security-implications-of-kubectl-apply-">Security implications of <code class="remark-inline-code">kubectl apply</code></h1>
<ul>
<li><p>When we do <code class="remark-inline-code">kubectl apply -f &lt;URL&gt;</code>, we create arbitrary resources</p>
</li>
<li><p>Resources can be evil; imagine a <code class="remark-inline-code">deployment</code> that ...</p>
<ul>
<li>starts bitcoin miners on the whole cluster</li>
</ul>
</li>
</ul><div class="remark-slide-number">424 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="security-implications-of-kubectl-apply-">Security implications of <code class="remark-inline-code">kubectl apply</code></h1>
<ul>
<li><p>When we do <code class="remark-inline-code">kubectl apply -f &lt;URL&gt;</code>, we create arbitrary resources</p>
</li>
<li><p>Resources can be evil; imagine a <code class="remark-inline-code">deployment</code> that ...</p>
<ul>
<li><p>starts bitcoin miners on the whole cluster</p>
</li>
<li><p>hides in a non-default namespace</p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">425 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="security-implications-of-kubectl-apply-">Security implications of <code class="remark-inline-code">kubectl apply</code></h1>
<ul>
<li><p>When we do <code class="remark-inline-code">kubectl apply -f &lt;URL&gt;</code>, we create arbitrary resources</p>
</li>
<li><p>Resources can be evil; imagine a <code class="remark-inline-code">deployment</code> that ...</p>
<ul>
<li><p>starts bitcoin miners on the whole cluster</p>
</li>
<li><p>hides in a non-default namespace</p>
</li>
<li><p>bind-mounts our nodes' filesystem</p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">426 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="security-implications-of-kubectl-apply-">Security implications of <code class="remark-inline-code">kubectl apply</code></h1>
<ul>
<li><p>When we do <code class="remark-inline-code">kubectl apply -f &lt;URL&gt;</code>, we create arbitrary resources</p>
</li>
<li><p>Resources can be evil; imagine a <code class="remark-inline-code">deployment</code> that ...</p>
<ul>
<li><p>starts bitcoin miners on the whole cluster</p>
</li>
<li><p>hides in a non-default namespace</p>
</li>
<li><p>bind-mounts our nodes' filesystem</p>
</li>
<li><p>inserts SSH keys in the root account (on the node)</p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">427 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="security-implications-of-kubectl-apply-">Security implications of <code class="remark-inline-code">kubectl apply</code></h1>
<ul>
<li><p>When we do <code class="remark-inline-code">kubectl apply -f &lt;URL&gt;</code>, we create arbitrary resources</p>
</li>
<li><p>Resources can be evil; imagine a <code class="remark-inline-code">deployment</code> that ...</p>
<ul>
<li><p>starts bitcoin miners on the whole cluster</p>
</li>
<li><p>hides in a non-default namespace</p>
</li>
<li><p>bind-mounts our nodes' filesystem</p>
</li>
<li><p>inserts SSH keys in the root account (on the node)</p>
</li>
<li><p>encrypts our data and ransoms it</p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">428 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="security-implications-of-kubectl-apply-">Security implications of <code class="remark-inline-code">kubectl apply</code></h1>
<ul>
<li><p>When we do <code class="remark-inline-code">kubectl apply -f &lt;URL&gt;</code>, we create arbitrary resources</p>
</li>
<li><p>Resources can be evil; imagine a <code class="remark-inline-code">deployment</code> that ...</p>
<ul>
<li><p>starts bitcoin miners on the whole cluster</p>
</li>
<li><p>hides in a non-default namespace</p>
</li>
<li><p>bind-mounts our nodes' filesystem</p>
</li>
<li><p>inserts SSH keys in the root account (on the node)</p>
</li>
<li><p>encrypts our data and ransoms it</p>
</li>
<li><p>☠️☠️☠️</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">429 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-apply-is-the-new-curl-sh-"><code class="remark-inline-code">kubectl apply</code> is the new <code class="remark-inline-code">curl | sh</code></h2>
<ul>
<li><p><code class="remark-inline-code">curl | sh</code> is convenient</p>
</li>
<li><p>It's safe if you use HTTPS URLs from trusted sources</p>
</li>
</ul><div class="remark-slide-number">430 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-apply-is-the-new-curl-sh-"><code class="remark-inline-code">kubectl apply</code> is the new <code class="remark-inline-code">curl | sh</code></h2>
<ul>
<li><p><code class="remark-inline-code">curl | sh</code> is convenient</p>
</li>
<li><p>It's safe if you use HTTPS URLs from trusted sources</p>
</li>
<li><p><code class="remark-inline-code">kubectl apply -f</code> is convenient</p>
</li>
<li><p>It's safe if you use HTTPS URLs from trusted sources</p>
</li>
<li><p>Example: the official setup instructions for most pod networks</p>
</li>
</ul><div class="remark-slide-number">431 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="-kubectl-apply-is-the-new-curl-sh-"><code class="remark-inline-code">kubectl apply</code> is the new <code class="remark-inline-code">curl | sh</code></h2>
<ul>
<li><p><code class="remark-inline-code">curl | sh</code> is convenient</p>
</li>
<li><p>It's safe if you use HTTPS URLs from trusted sources</p>
</li>
<li><p><code class="remark-inline-code">kubectl apply -f</code> is convenient</p>
</li>
<li><p>It's safe if you use HTTPS URLs from trusted sources</p>
</li>
<li><p>Example: the official setup instructions for most pod networks</p>
</li>
<li><p>It introduces new failure modes</p>
<p>(for instance, if you try to apply YAML from a link that's no longer valid)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dashboard.md">k8s/dashboard.md</a></span></p><div class="remark-slide-number">432 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/containers-by-the-water.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">433 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-exposing-http-services-with-ingress-resources" class="remark-slide-content title hljs-default"><p>Exposing HTTP services with Ingress resources</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-security-implications-of-kubectl-apply">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-5">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-volumes">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">434 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="exposing-http-services-with-ingress-resources">Exposing HTTP services with Ingress resources</h1>
<ul>
<li><p><em>Services</em> give us a way to access a pod or a set of pods</p>
</li>
<li><p>Services can be exposed to the outside world:</p>
<ul>
<li><p>with type <code class="remark-inline-code">NodePort</code> (on a port &gt;30000)</p>
</li>
<li><p>with type <code class="remark-inline-code">LoadBalancer</code> (allocating an external load balancer)</p>
</li>
</ul>
</li>
<li><p>What about HTTP services?</p>
<ul>
<li><p>how can we expose <code class="remark-inline-code">webui</code>, <code class="remark-inline-code">rng</code>, <code class="remark-inline-code">hasher</code>?</p>
</li>
<li><p>the Kubernetes dashboard?</p>
</li>
<li><p>a new version of <code class="remark-inline-code">webui</code>?</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">435 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-http-services">Exposing HTTP services</h2>
<ul>
<li><p>If we use <code class="remark-inline-code">NodePort</code> services, clients have to specify port numbers</p>
<p>(i.e. <a href="http://xxxxx:31234/">http://xxxxx:31234</a> instead of just <a href="http://xxxxx/">http://xxxxx</a>)</p>
</li>
<li><p><code class="remark-inline-code">LoadBalancer</code> services are nice, but:</p>
<ul>
<li><p>they are not available in all environments</p>
</li>
<li><p>they often carry an additional cost (e.g. they provision an ELB)</p>
</li>
<li><p>they require one extra step for DNS integration
<br>
(waiting for the <code class="remark-inline-code">LoadBalancer</code> to be provisioned; then adding it to DNS)</p>
</li>
</ul>
</li>
<li><p>We could build our own reverse proxy</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">436 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="building-a-custom-reverse-proxy">Building a custom reverse proxy</h2>
<ul>
<li><p>There are many options available:</p>
<p>Apache, HAProxy, Hipache, NGINX, Traefik, ...</p>
<p>(look at <a href="https://github.com/jpetazzo/aiguillage">jpetazzo/aiguillage</a> for a minimal reverse proxy configuration using NGINX)</p>
</li>
<li><p>Most of these options require us to update/edit configuration files after each change</p>
</li>
<li><p>Some of them can pick up virtual hosts and backends from a configuration store</p>
</li>
<li><p>Wouldn't it be nice if this configuration could be managed with the Kubernetes API?</p>
</li>
</ul><div class="remark-slide-number">437 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="building-a-custom-reverse-proxy">Building a custom reverse proxy</h2>
<ul>
<li><p>There are many options available:</p>
<p>Apache, HAProxy, Hipache, NGINX, Traefik, ...</p>
<p>(look at <a href="https://github.com/jpetazzo/aiguillage">jpetazzo/aiguillage</a> for a minimal reverse proxy configuration using NGINX)</p>
</li>
<li><p>Most of these options require us to update/edit configuration files after each change</p>
</li>
<li><p>Some of them can pick up virtual hosts and backends from a configuration store</p>
</li>
<li><p>Wouldn't it be nice if this configuration could be managed with the Kubernetes API?</p>
</li>
<li><p>Enter<span class="red">¹</span> <em>Ingress</em> resources!</p>
</li>
</ul>
<p><span class="footnote"><span class="red">¹</span> Pun maybe intended.</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">438 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="ingress-resources">Ingress resources</h2>
<ul>
<li><p>Kubernetes API resource (<code class="remark-inline-code">kubectl get ingress</code>/<code class="remark-inline-code">ingresses</code>/<code class="remark-inline-code">ing</code>)</p>
</li>
<li><p>Designed to expose HTTP services</p>
</li>
<li><p>Basic features:</p>
<ul>
<li>load balancing</li>
<li>SSL termination</li>
<li>name-based virtual hosting</li>
</ul>
</li>
<li><p>Can also route to different services depending on:</p>
<ul>
<li>URI path (e.g. <code class="remark-inline-code">/api</code>→<code class="remark-inline-code">api-service</code>, <code class="remark-inline-code">/static</code>→<code class="remark-inline-code">assets-service</code>)</li>
<li>Client headers, including cookies (for A/B testing, canary deployment...)</li>
<li>and more!</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">439 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="principle-of-operation">Principle of operation</h2>
<ul>
<li><p>Step 1: deploy an <em>ingress controller</em></p>
<ul>
<li><p>ingress controller = load balancer + control loop</p>
</li>
<li><p>the control loop watches over ingress resources, and configures the LB accordingly</p>
</li>
</ul>
</li>
<li><p>Step 2: set up DNS</p>
<ul>
<li>associate DNS entries with the load balancer address</li>
</ul>
</li>
<li><p>Step 3: create <em>ingress resources</em></p>
<ul>
<li>the ingress controller picks up these resources and configures the LB</li>
</ul>
</li>
<li><p>Step 4: profit!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">440 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="ingress-in-action">Ingress in action</h2>
<ul>
<li><p>We will deploy the Traefik ingress controller</p>
<ul>
<li><p>this is an arbitrary choice</p>
</li>
<li><p>maybe motivated by the fact that Traefik releases are named after cheeses</p>
</li>
</ul>
</li>
<li><p>For DNS, we will use <a href="http://nip.io/">nip.io</a></p>
<ul>
<li><code class="remark-inline-code">*.1.2.3.4.nip.io</code> resolves to <code class="remark-inline-code">1.2.3.4</code></li>
</ul>
</li>
<li><p>We will create ingress resources for various HTTP services</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">441 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploying-pods-listening-on-port-80">Deploying pods listening on port 80</h2>
<ul>
<li><p>We want our ingress load balancer to be available on port 80</p>
</li>
<li><p>We could do that with a <code class="remark-inline-code">LoadBalancer</code> service</p>
<p>... but it requires support from the underlying infrastructure</p>
</li>
<li><p>We could use pods specifying <code class="remark-inline-code">hostPort: 80</code> </p>
<p>... but with most CNI plugins, this <a href="https://github.com/kubernetes/kubernetes/issues/23920">doesn't work or requires additional setup</a></p>
</li>
<li><p>We could use a <code class="remark-inline-code">NodePort</code> service</p>
<p>... but that requires <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/">changing the <code class="remark-inline-code">--service-node-port-range</code> flag in the API server</a></p>
</li>
<li><p>Last resort: the <code class="remark-inline-code">hostNetwork</code> mode</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">442 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="without-hostnetwork-">Without <code class="remark-inline-code">hostNetwork</code></h2>
<ul>
<li><p>Normally, each pod gets its own <em>network namespace</em></p>
<p>(sometimes called sandbox or network sandbox)</p>
</li>
<li><p>An IP address is assigned to the pod</p>
</li>
<li><p>This IP address is routed/connected to the cluster network</p>
</li>
<li><p>All containers of that pod are sharing that network namespace</p>
<p>(and therefore using the same IP address)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">443 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="with-hostnetwork-true-">With <code class="remark-inline-code">hostNetwork: true</code></h2>
<ul>
<li><p>No network namespace gets created</p>
</li>
<li><p>The pod is using the network namespace of the host</p>
</li>
<li><p>It "sees" (and can use) the interfaces (and IP addresses) of the host</p>
</li>
<li><p>The pod can receive outside traffic directly, on any port</p>
</li>
<li><p>Downside: with most network plugins, network policies won't work for that pod</p>
<ul>
<li><p>most network policies work at the IP address level</p>
</li>
<li><p>filtering that pod = filtering traffic from the node</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">444 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-traefik">Running Traefik</h2>
<ul>
<li><p>The <a href="https://docs.traefik.io/user-guide/kubernetes/#deploy-trfik-using-a-deployment-or-daemonset">Traefik documentation</a> tells us to pick between Deployment and Daemon Set</p>
</li>
<li><p>We are going to use a Daemon Set so that each node can accept connections</p>
</li>
<li><p>We will do two minor changes to the <a href="https://github.com/containous/traefik/blob/v1.7/examples/k8s/traefik-ds.yaml">YAML provided by Traefik</a>:</p>
<ul>
<li><p>enable <code class="remark-inline-code">hostNetwork</code></p>
</li>
<li><p>add a <em>toleration</em> so that Traefik also runs on <code class="remark-inline-code">node1</code></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">445 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="taints-and-tolerations">Taints and tolerations</h2>
<ul>
<li><p>A <em>taint</em> is an attribute added to a node</p>
</li>
<li><p>It prevents pods from running on the node</p>
</li>
<li><p>... Unless they have a matching <em>toleration</em></p>
</li>
<li><p>When deploying with <code class="remark-inline-code">kubeadm</code>:</p>
<ul>
<li><p>a taint is placed on the node dedicated to the control plane</p>
</li>
<li><p>the pods running the control plane have a matching toleration</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">446 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="checking-taints-on-our-nodes">Checking taints on our nodes</h2>
<div class="exercise"><ul>
<li>Check our nodes specs:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get node node1 -o json | jq .spec</div><div class="remark-code-line">kubectl get node node2 -o json | jq .spec</div></code></pre>
</li>
</ul>
</div>

<p>We should see a result only for <code class="remark-inline-code">node1</code> (the one with the control plane):</p>
<pre><code class="json hljs remark-code"><div class="remark-code-line">  <span class="hljs-string">"taints"</span>: [</div><div class="remark-code-line">    {</div><div class="remark-code-line">      <span class="hljs-attr">"effect"</span>: <span class="hljs-string">"NoSchedule"</span>,</div><div class="remark-code-line">      <span class="hljs-attr">"key"</span>: <span class="hljs-string">"node-role.kubernetes.io/master"</span></div><div class="remark-code-line">    }</div><div class="remark-code-line">  ]</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">447 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="understanding-a-taint">Understanding a taint</h2>
<ul>
<li><p>The <code class="remark-inline-code">key</code> can be interpreted as:</p>
<ul>
<li><p>a reservation for a special set of pods
<br>
(here, this means "this node is reserved for the control plane")</p>
</li>
<li><p>an error condition on the node
<br>
(for instance: "disk full," do not start new pods here!)</p>
</li>
</ul>
</li>
<li><p>The <code class="remark-inline-code">effect</code> can be:</p>
<ul>
<li><p><code class="remark-inline-code">NoSchedule</code> (don't run new pods here)</p>
</li>
<li><p><code class="remark-inline-code">PreferNoSchedule</code> (try not to run new pods here)</p>
</li>
<li><p><code class="remark-inline-code">NoExecute</code> (don't run new pods and evict running pods)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">448 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="checking-tolerations-on-the-control-plane">Checking tolerations on the control plane</h2>
<div class="exercise"><ul>
<li>Check tolerations for CoreDNS:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-system get deployments coredns -o json |</div><div class="remark-code-line">      jq .spec.template.spec.tolerations</div></code></pre>
</li>
</ul>
</div>

<p>The result should include:</p>
<pre><code class="json hljs remark-code"><div class="remark-code-line">  {</div><div class="remark-code-line">    <span class="hljs-attr">"effect"</span>: <span class="hljs-string">"NoSchedule"</span>,</div><div class="remark-code-line">    <span class="hljs-attr">"key"</span>: <span class="hljs-string">"node-role.kubernetes.io/master"</span></div><div class="remark-code-line">  }</div></code></pre>
<p>It means: "bypass the exact taint that we saw earlier on <code class="remark-inline-code">node1</code>."</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">449 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="special-tolerations">Special tolerations</h2>
<div class="exercise"><ul>
<li>Check tolerations on <code class="remark-inline-code">kube-proxy</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-system get ds kube-proxy -o json | </div><div class="remark-code-line">      jq .spec.template.spec.tolerations</div></code></pre>
</li>
</ul>
</div>

<p>The result should include:</p>
<pre><code class="json hljs remark-code"><div class="remark-code-line">  {</div><div class="remark-code-line">    <span class="hljs-attr">"operator"</span>: <span class="hljs-string">"Exists"</span></div><div class="remark-code-line">  }</div></code></pre>
<p>This one is a special case that means "ignore all taints and run anyway."</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">450 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-traefik-on-our-cluster">Running Traefik on our cluster</h2>
<ul>
<li><p>We provide a YAML file (<code class="remark-inline-code">k8s/traefik.yaml</code>) which is essentially the sum of:</p>
<ul>
<li><p><a href="https://github.com/containous/traefik/blob/v1.7/examples/k8s/traefik-ds.yaml">Traefik's Daemon Set resources</a> (patched with <code class="remark-inline-code">hostNetwork</code> and tolerations)</p>
</li>
<li><p><a href="https://github.com/containous/traefik/blob/v1.7/examples/k8s/traefik-rbac.yaml">Traefik's RBAC rules</a> allowing it to watch necessary API objects</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Apply the YAML:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/traefik.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">451 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-that-traefik-runs-correctly">Checking that Traefik runs correctly</h2>
<ul>
<li>If Traefik started correctly, we now have a web server listening on each node</li>
</ul>
<div class="exercise"><ul>
<li>Check that Traefik is serving 80/tcp:<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl localhost</div></code></pre>
</li>
</ul>
</div>

<p>We should get a <code class="remark-inline-code">404 page not found</code> error.</p>
<p>This is normal: we haven't provided any ingress rule yet.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">452 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-dns">Setting up DNS</h2>
<ul>
<li><p>To make our lives easier, we will use <a href="http://nip.io/">nip.io</a></p>
</li>
<li><p>Check out <code class="remark-inline-code">http://cheddar.A.B.C.D.nip.io</code></p>
<p>(replacing A.B.C.D with the IP address of <code class="remark-inline-code">node1</code>)</p>
</li>
<li><p>We should get the same <code class="remark-inline-code">404 page not found</code> error</p>
<p>(meaning that our DNS is "set up properly", so to speak!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">453 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="traefik-web-ui">Traefik web UI</h2>
<ul>
<li><p>Traefik provides a web dashboard</p>
</li>
<li><p>With the current install method, it's listening on port 8080</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Go to <code class="remark-inline-code">http://node1:8080</code> (replacing <code class="remark-inline-code">node1</code> with its IP address)</li>
</ul>
<!-- ```open http://node1:8080``` -->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">454 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-host-based-routing-ingress-rules">Setting up host-based routing ingress rules</h2>
<ul>
<li><p>We are going to use <code class="remark-inline-code">errm/cheese</code> images</p>
<p>(there are <a href="https://hub.docker.com/r/errm/cheese/tags/">3 tags available</a>: wensleydale, cheddar, stilton)</p>
</li>
<li><p>These images contain a simple static HTTP server sending a picture of cheese</p>
</li>
<li><p>We will run 3 deployments (one for each cheese)</p>
</li>
<li><p>We will create 3 services (one for each deployment)</p>
</li>
<li><p>Then we will create 3 ingress rules (one for each service)</p>
</li>
<li><p>We will route <code class="remark-inline-code">&lt;name-of-cheese&gt;.A.B.C.D.nip.io</code> to the corresponding deployment</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">455 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-cheesy-web-servers">Running cheesy web servers</h2>
<div class="exercise"><ul>
<li><p>Run all three deployments:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment cheddar --image=errm/cheese:cheddar</div><div class="remark-code-line">kubectl create deployment stilton --image=errm/cheese:stilton</div><div class="remark-code-line">kubectl create deployment wensleydale --image=errm/cheese:wensleydale</div></code></pre>
</li>
<li><p>Create a service for each of them:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment cheddar --port=80</div><div class="remark-code-line">kubectl expose deployment stilton --port=80</div><div class="remark-code-line">kubectl expose deployment wensleydale --port=80</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">456 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-does-an-ingress-resource-look-like-">What does an ingress resource look like?</h2>
<p>Here is a minimal host-based ingress resource:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> extensions/v1beta1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Ingress</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> cheddar</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  rules:</span></div><div class="remark-code-line"><span class="hljs-attr">  - host:</span> cheddar.<span class="remark-code-span-highlighted">A.B.C.D</span>.nip.io</div><div class="remark-code-line"><span class="hljs-attr">    http:</span></div><div class="remark-code-line"><span class="hljs-attr">      paths:</span></div><div class="remark-code-line"><span class="hljs-attr">      - path:</span> /</div><div class="remark-code-line"><span class="hljs-attr">        backend:</span></div><div class="remark-code-line"><span class="hljs-attr">          serviceName:</span> cheddar</div><div class="remark-code-line"><span class="hljs-attr">          servicePort:</span> <span class="hljs-number">80</span></div></code></pre>
<p>(It is in <code class="remark-inline-code">k8s/ingress.yaml</code>.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">457 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-our-first-ingress-resources">Creating our first ingress resources</h2>
<div class="exercise"><ul>
<li><p>Edit the file <code class="remark-inline-code">~/container.training/k8s/ingress.yaml</code></p>
</li>
<li><p>Replace A.B.C.D with the IP address of <code class="remark-inline-code">node1</code></p>
</li>
<li><p>Apply the file</p>
</li>
<li><p>Open <a href="http://cheddar.a.b.c.d.nip.io/">http://cheddar.A.B.C.D.nip.io</a></p>
</li>
</ul>
</div>

<p>(An image of a piece of cheese should show up.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">458 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-the-other-ingress-resources">Creating the other ingress resources</h2>
<div class="exercise"><ul>
<li><p>Edit the file <code class="remark-inline-code">~/container.training/k8s/ingress.yaml</code></p>
</li>
<li><p>Replace <code class="remark-inline-code">cheddar</code> with <code class="remark-inline-code">stilton</code> (in <code class="remark-inline-code">name</code>, <code class="remark-inline-code">host</code>, <code class="remark-inline-code">serviceName</code>)</p>
</li>
<li><p>Apply the file</p>
</li>
<li><p>Check that <code class="remark-inline-code">stilton.A.B.C.D.nip.io</code> works correctly</p>
</li>
<li><p>Repeat for <code class="remark-inline-code">wensleydale</code></p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">459 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-multiple-ingress-controllers">Using multiple ingress controllers</h2>
<ul>
<li><p>You can have multiple ingress controllers active simultaneously</p>
<p>(e.g. Traefik and NGINX)</p>
</li>
<li><p>You can even have multiple instances of the same controller</p>
<p>(e.g. one for internal, another for external traffic)</p>
</li>
<li><p>The <code class="remark-inline-code">kubernetes.io/ingress.class</code> annotation can be used to tell which one to use</p>
</li>
<li><p>It's OK if multiple ingress controllers configure the same resource</p>
<p>(it just means that the service will be accessible through multiple paths)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">460 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="ingress-the-good">Ingress: the good</h2>
<ul>
<li><p>The traffic flows directly from the ingress load balancer to the backends</p>
<ul>
<li><p>it doesn't need to go through the <code class="remark-inline-code">ClusterIP</code></p>
</li>
<li><p>in fact, we don't even need a <code class="remark-inline-code">ClusterIP</code> (we can use a headless service)</p>
</li>
</ul>
</li>
<li><p>The load balancer can be outside of Kubernetes</p>
<p>(as long as it has access to the cluster subnet)</p>
</li>
<li><p>This allows the use of external (hardware, physical machines...) load balancers</p>
</li>
<li><p>Annotations can encode special features</p>
<p>(rate-limiting, A/B testing, session stickiness, etc.)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">461 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="ingress-the-bad">Ingress: the bad</h2>
<ul>
<li><p>Aforementioned "special features" are not standardized yet</p>
</li>
<li><p>Some controllers will support them; some won't</p>
</li>
<li><p>Even relatively common features (stripping a path prefix) can differ:</p>
<ul>
<li><p><a href="https://docs.traefik.io/user-guide/kubernetes/#path-based-routing">traefik.ingress.kubernetes.io/rule-type: PathPrefixStrip</a></p>
</li>
<li><p><a href="https://github.com/kubernetes/contrib/tree/master/ingress/controllers/nginx/examples/rewrite">ingress.kubernetes.io/rewrite-target: /</a></p>
</li>
</ul>
</li>
<li><p>This should eventually stabilize</p>
<p>(remember that ingresses are currently <code class="remark-inline-code">apiVersion: extensions/v1beta1</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/ingress.md">k8s/ingress.md</a></span></p><div class="remark-slide-number">462 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/distillery-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">463 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-volumes" class="remark-slide-content title hljs-default"><p>Volumes</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-exposing-http-services-with-ingress-resources">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-6">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-managing-configuration">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">464 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="volumes">Volumes</h1>
<ul>
<li><p>Volumes are special directories that are mounted in containers</p>
</li>
<li><p>Volumes can have many different purposes:</p>
<ul>
<li><p>share files and directories between containers running on the same machine</p>
</li>
<li><p>share files and directories between containers and their host</p>
</li>
<li><p>centralize configuration information in Kubernetes and expose it to containers</p>
</li>
<li><p>manage credentials and secrets and expose them securely to containers</p>
</li>
<li><p>store persistent data for stateful services</p>
</li>
<li><p>access storage systems (like Ceph, EBS, NFS, Portworx, and many others)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">465 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="kubernetes-volumes-vs-docker-volumes">Kubernetes volumes vs. Docker volumes</h2>
<ul>
<li><p>Kubernetes and Docker volumes are very similar</p>
<p>(the <a href="https://kubernetes.io/docs/concepts/storage/volumes/">Kubernetes documentation</a> says otherwise ...
<br>
but it refers to Docker 1.7, which was released in 2015!)</p>
</li>
<li><p>Docker volumes allow us to share data between containers running on the same host</p>
</li>
<li><p>Kubernetes volumes allow us to share data between containers in the same pod</p>
</li>
<li><p>Both Docker and Kubernetes volumes enable access to storage systems</p>
</li>
<li><p>Kubernetes volumes are also used to expose configuration and secrets</p>
</li>
<li><p>Docker has specific concepts for configuration and secrets
<br>
(but under the hood, the technical implementation is similar)</p>
</li>
<li><p>If you're not familiar with Docker volumes, you can safely ignore this slide!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">466 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="volumes-persistent-volumes">Volumes ≠ Persistent Volumes</h2>
<ul>
<li><p>Volumes and Persistent Volumes are related, but very different!</p>
</li>
<li><p><em>Volumes</em>:</p>
<ul>
<li><p>appear in Pod specifications (see next slide)</p>
</li>
<li><p>do not exist as API resources (<strong>cannot</strong> do <code class="remark-inline-code">kubectl get volumes</code>)</p>
</li>
</ul>
</li>
<li><p><em>Persistent Volumes</em>:</p>
<ul>
<li><p>are API resources (<strong>can</strong> do <code class="remark-inline-code">kubectl get persistentvolumes</code>)</p>
</li>
<li><p>correspond to concrete volumes (e.g. on a SAN, EBS, etc.)</p>
</li>
<li><p>cannot be associated with a Pod directly; but through a Persistent Volume Claim</p>
</li>
<li><p>won't be discussed further in this section</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">467 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-simple-volume-example">A simple volume example</h2>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> nginx-with-volume</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  volumes:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> www</div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> nginx</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> nginx</div><div class="remark-code-line"><span class="hljs-attr">    volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">    - name:</span> www</div><div class="remark-code-line"><span class="hljs-attr">      mountPath:</span> /usr/share/nginx/html/</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">468 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-simple-volume-example-explained">A simple volume example, explained</h2>
<ul>
<li><p>We define a standalone <code class="remark-inline-code">Pod</code> named <code class="remark-inline-code">nginx-with-volume</code></p>
</li>
<li><p>In that pod, there is a volume named <code class="remark-inline-code">www</code></p>
</li>
<li><p>No type is specified, so it will default to <code class="remark-inline-code">emptyDir</code></p>
<p>(as the name implies, it will be initialized as an empty directory at pod creation)</p>
</li>
<li><p>In that pod, there is also a container named <code class="remark-inline-code">nginx</code></p>
</li>
<li><p>That container mounts the volume <code class="remark-inline-code">www</code> to path <code class="remark-inline-code">/usr/share/nginx/html/</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">469 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-volume-shared-between-two-containers">A volume shared between two containers</h2>
<div class="small"><pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> nginx-with-volume</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  volumes:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> www</div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> nginx</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> nginx</div><div class="remark-code-line"><span class="hljs-attr">    volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">    - name:</span> www</div><div class="remark-code-line"><span class="hljs-attr">      mountPath:</span> /usr/share/nginx/html/</div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> git</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> alpine</div><div class="remark-code-line"><span class="hljs-attr">    command:</span> [ <span class="hljs-string">"sh"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"apk add --no-cache git &amp;&amp; git clone https://github.com/octocat/Spoon-Knife /www"</span> ]</div><div class="remark-code-line"><span class="hljs-attr">    volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">    - name:</span> www</div><div class="remark-code-line"><span class="hljs-attr">      mountPath:</span> /www/</div><div class="remark-code-line"><span class="hljs-attr">  restartPolicy:</span> OnFailure</div></code></pre>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">470 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="sharing-a-volume-explained">Sharing a volume, explained</h2>
<ul>
<li><p>We added another container to the pod</p>
</li>
<li><p>That container mounts the <code class="remark-inline-code">www</code> volume on a different path (<code class="remark-inline-code">/www</code>)</p>
</li>
<li><p>It uses the <code class="remark-inline-code">alpine</code> image</p>
</li>
<li><p>When started, it installs <code class="remark-inline-code">git</code> and clones the <code class="remark-inline-code">octocat/Spoon-Knife</code> repository</p>
<p>(that repository contains a tiny HTML website)</p>
</li>
<li><p>As a result, NGINX now serves this website</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">471 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="sharing-a-volume-in-action">Sharing a volume, in action</h2>
<ul>
<li>Let's try it!</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the pod by applying the YAML file:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/nginx-with-volume.yaml</div></code></pre>
</li>
<li><p>Check the IP address that was allocated to our pod:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod nginx-with-volume -o wide</div><div class="remark-code-line">IP=$(kubectl get pod nginx-with-volume -o json | jq -r .status.podIP)</div></code></pre>
</li>
<li><p>Access the web server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="hljs-variable">$IP</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">472 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-devil-is-in-the-details">The devil is in the details</h2>
<ul>
<li><p>The default <code class="remark-inline-code">restartPolicy</code> is <code class="remark-inline-code">Always</code></p>
</li>
<li><p>This would cause our <code class="remark-inline-code">git</code> container to run again ... and again ... and again</p>
<p>(with an exponential back-off delay, as explained <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">in the documentation</a>)</p>
</li>
<li><p>That's why we specified <code class="remark-inline-code">restartPolicy: OnFailure</code></p>
</li>
<li><p>There is a short period of time during which the website is not available</p>
<p>(because the <code class="remark-inline-code">git</code> container hasn't done its job yet)</p>
</li>
<li><p>This could be avoided by using <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">Init Containers</a></p>
<p>(we will see a live example in a few sections)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">473 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="volume-lifecycle">Volume lifecycle</h2>
<ul>
<li><p>The lifecycle of a volume is linked to the pod's lifecycle</p>
</li>
<li><p>This means that a volume is created when the pod is created</p>
</li>
<li><p>This is mostly relevant for <code class="remark-inline-code">emptyDir</code> volumes</p>
<p>(other volumes, like remote storage, are not "created" but rather "attached" )</p>
</li>
<li><p>A volume survives across container restarts</p>
</li>
<li><p>A volume is destroyed (or, for remote storage, detached) when the pod is destroyed</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/volumes.md">k8s/volumes.md</a></span></p><div class="remark-slide-number">474 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/lots-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">475 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-managing-configuration" class="remark-slide-content title hljs-default"><p>Managing configuration</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-volumes">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-6">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-accessing-logs-from-the-cli">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">476 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="managing-configuration">Managing configuration</h1>
<ul>
<li><p>Some applications need to be configured (obviously!)</p>
</li>
<li><p>There are many ways for our code to pick up configuration:</p>
<ul>
<li><p>command-line arguments</p>
</li>
<li><p>environment variables</p>
</li>
<li><p>configuration files</p>
</li>
<li><p>configuration servers (getting configuration from a database, an API...)</p>
</li>
<li><p>... and more (because programmers can be very creative!)</p>
</li>
</ul>
</li>
<li><p>How can we do these things with containers and Kubernetes?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">477 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="passing-configuration-to-containers">Passing configuration to containers</h2>
<ul>
<li><p>There are many ways to pass configuration to code running in a container:</p>
<ul>
<li><p>baking it into a custom image</p>
</li>
<li><p>command-line arguments</p>
</li>
<li><p>environment variables</p>
</li>
<li><p>injecting configuration files</p>
</li>
<li><p>exposing it over the Kubernetes API</p>
</li>
<li><p>configuration servers</p>
</li>
</ul>
</li>
<li><p>Let's review these different strategies!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">478 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="baking-custom-images">Baking custom images</h2>
<ul>
<li><p>Put the configuration in the image</p>
<p>(it can be in a configuration file, but also <code class="remark-inline-code">ENV</code> or <code class="remark-inline-code">CMD</code> actions)</p>
</li>
<li><p>It's easy! It's simple!</p>
</li>
<li><p>Unfortunately, it also has downsides:</p>
<ul>
<li><p>multiplication of images</p>
</li>
<li><p>different images for dev, staging, prod ...</p>
</li>
<li><p>minor reconfigurations require a whole build/push/pull cycle</p>
</li>
</ul>
</li>
<li><p>Avoid doing it unless you don't have the time to figure out other options</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">479 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="command-line-arguments">Command-line arguments</h2>
<ul>
<li><p>Pass options to <code class="remark-inline-code">args</code> array in the container specification</p>
</li>
<li><p>Example (<a href="https://github.com/coreos/pods/blob/master/kubernetes.yaml#L29">source</a>): </p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">  args:</span> </div><div class="remark-code-line"><span class="hljs-bullet">    -</span> <span class="hljs-string">"--data-dir=/var/lib/etcd"</span></div><div class="remark-code-line"><span class="hljs-bullet">    -</span> <span class="hljs-string">"--advertise-client-urls=http://127.0.0.1:2379"</span></div><div class="remark-code-line"><span class="hljs-bullet">    -</span> <span class="hljs-string">"--listen-client-urls=http://127.0.0.1:2379"</span></div><div class="remark-code-line"><span class="hljs-bullet">    -</span> <span class="hljs-string">"--listen-peer-urls=http://127.0.0.1:2380"</span></div><div class="remark-code-line"><span class="hljs-bullet">    -</span> <span class="hljs-string">"--name=etcd"</span></div></code></pre>
</li>
<li><p>The options can be passed directly to the program that we run ...</p>
<p>... or to a wrapper script that will use them to e.g. generate a config file</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">480 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="command-line-arguments-pros-cons">Command-line arguments, pros &amp; cons</h2>
<ul>
<li><p>Works great when options are passed directly to the running program</p>
<p>(otherwise, a wrapper script can work around the issue)</p>
</li>
<li><p>Works great when there aren't too many parameters</p>
<p>(to avoid a 20-lines <code class="remark-inline-code">args</code> array)</p>
</li>
<li><p>Requires documentation and/or understanding of the underlying program</p>
<p>("which parameters and flags do I need, again?")</p>
</li>
<li><p>Well-suited for mandatory parameters (without default values)</p>
</li>
<li><p>Not ideal when we need to pass a real configuration file anyway</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">481 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="environment-variables">Environment variables</h2>
<ul>
<li><p>Pass options through the <code class="remark-inline-code">env</code> map in the container specification</p>
</li>
<li><p>Example:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">  env:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> ADMIN_PORT</div><div class="remark-code-line"><span class="hljs-attr">    value:</span> <span class="hljs-string">"8080"</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> ADMIN_AUTH</div><div class="remark-code-line"><span class="hljs-attr">    value:</span> Basic</div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> ADMIN_CRED</div><div class="remark-code-line"><span class="hljs-attr">    value:</span> <span class="hljs-string">"admin:0pensesame!"</span></div></code></pre>
</li>
</ul>
<p><span class="warning"><code class="remark-inline-code">value</code> must be a string! Make sure that numbers and fancy strings are quoted.</span></p>
<p>🤔 Why this weird <code class="remark-inline-code">{name: xxx, value: yyy}</code> scheme? It will be revealed soon!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">482 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-downward-api">The downward API</h2>
<ul>
<li><p>In the previous example, environment variables have fixed values</p>
</li>
<li><p>We can also use a mechanism called the <em>downward API</em></p>
</li>
<li><p>The downward API allows exposing pod or container information</p>
<ul>
<li><p>either through special files (we won't show that for now)</p>
</li>
<li><p>or through environment variables</p>
</li>
</ul>
</li>
<li><p>The value of these environment variables is computed when the container is started</p>
</li>
<li><p>Remember: environment variables won't (can't) change after container start</p>
</li>
<li><p>Let's see a few concrete examples!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">483 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-the-pod-s-namespace">Exposing the pod's namespace</h2>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">    - name:</span> MY_POD_NAMESPACE</div><div class="remark-code-line"><span class="hljs-attr">      valueFrom:</span></div><div class="remark-code-line"><span class="hljs-attr">        fieldRef:</span></div><div class="remark-code-line"><span class="hljs-attr">          fieldPath:</span> metadata.namespace</div></code></pre>
<ul>
<li><p>Useful to generate FQDN of services</p>
<p>(in some contexts, a short name is not enough)</p>
</li>
<li><p>For instance, the two commands should be equivalent:</p>
<pre><code class="remark-code"><div class="remark-code-line">curl api-backend</div><div class="remark-code-line">curl api-backend.$MY_POD_NAMESPACE.svc.cluster.local</div></code></pre></li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">484 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-the-pod-s-ip-address">Exposing the pod's IP address</h2>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">    - name:</span> MY_POD_IP</div><div class="remark-code-line"><span class="hljs-attr">      valueFrom:</span></div><div class="remark-code-line"><span class="hljs-attr">        fieldRef:</span></div><div class="remark-code-line"><span class="hljs-attr">          fieldPath:</span> status.podIP</div></code></pre>
<ul>
<li><p>Useful if we need to know our IP address</p>
<p>(we could also read it from <code class="remark-inline-code">eth0</code>, but this is more solid)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">485 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-the-container-s-resource-limits">Exposing the container's resource limits</h2>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">    - name:</span> MY_MEM_LIMIT</div><div class="remark-code-line"><span class="hljs-attr">      valueFrom:</span></div><div class="remark-code-line"><span class="hljs-attr">        resourceFieldRef:</span></div><div class="remark-code-line"><span class="hljs-attr">          containerName:</span> test-container</div><div class="remark-code-line"><span class="hljs-attr">          resource:</span> limits.memory</div></code></pre>
<ul>
<li><p>Useful for runtimes where memory is garbage collected</p>
</li>
<li><p>Example: the JVM</p>
<p>(the memory available to the JVM should be set with the <code class="remark-inline-code">-Xmx</code> flag)</p>
</li>
<li><p>Best practice: set a memory limit, and pass it to the runtime</p>
<p>(see <a href="https://very-serio.us/2017/12/05/running-jvms-in-kubernetes/">this blog post</a> for a detailed example)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">486 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-about-the-downward-api">More about the downward API</h2>
<ul>
<li><p><a href="https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/">This documentation page</a> tells more about these environment variables</p>
</li>
<li><p>And <a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/">this one</a> explains the other way to use the downward API</p>
<p>(through files that get created in the container filesystem)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">487 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="environment-variables-pros-and-cons">Environment variables, pros and cons</h2>
<ul>
<li><p>Works great when the running program expects these variables</p>
</li>
<li><p>Works great for optional parameters with reasonable defaults</p>
<p>(since the container image can provide these defaults)</p>
</li>
<li><p>Sort of auto-documented</p>
<p>(we can see which environment variables are defined in the image, and their values)</p>
</li>
<li><p>Can be (ab)used with longer values ...</p>
</li>
<li><p>... You <em>can</em> put an entire Tomcat configuration file in an environment ...</p>
</li>
<li><p>... But <em>should</em> you?</p>
</li>
</ul>
<p>(Do it if you really need to, we're not judging! But we'll see better ways.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">488 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="injecting-configuration-files">Injecting configuration files</h2>
<ul>
<li><p>Sometimes, there is no way around it: we need to inject a full config file</p>
</li>
<li><p>Kubernetes provides a mechanism for that purpose: <code class="remark-inline-code">configmaps</code></p>
</li>
<li><p>A configmap is a Kubernetes resource that exists in a namespace</p>
</li>
<li><p>Conceptually, it's a key/value map</p>
<p>(values are arbitrary strings)</p>
</li>
<li><p>We can think about them in (at least) two different ways:</p>
<ul>
<li><p>as holding entire configuration file(s)</p>
</li>
<li><p>as holding individual configuration parameters</p>
</li>
</ul>
</li>
</ul>
<p><em>Note: to hold sensitive information, we can use "Secrets", which
are another type of resource behaving very much like configmaps.
We'll cover them just after!</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">489 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="configmaps-storing-entire-files">Configmaps storing entire files</h2>
<ul>
<li><p>In this case, each key/value pair corresponds to a configuration file</p>
</li>
<li><p>Key = name of the file</p>
</li>
<li><p>Value = content of the file</p>
</li>
<li><p>There can be one key/value pair, or as many as necessary</p>
<p>(for complex apps with multiple configuration files)</p>
</li>
<li><p>Examples:</p>
<pre><code class="remark-code"><div class="remark-code-line"># Create a configmap with a single key, "app.conf"</div><div class="remark-code-line">kubectl create configmap my-app-config --from-file=app.conf</div><div class="remark-code-line"># Create a configmap with a single key, "app.conf" but another file</div><div class="remark-code-line">kubectl create configmap my-app-config --from-file=app.conf=app-prod.conf</div><div class="remark-code-line"># Create a configmap with multiple keys (one per file in the config.d directory)</div><div class="remark-code-line">kubectl create configmap my-app-config --from-file=config.d/</div></code></pre></li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">490 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="configmaps-storing-individual-parameters">Configmaps storing individual parameters</h2>
<ul>
<li><p>In this case, each key/value pair corresponds to a parameter</p>
</li>
<li><p>Key = name of the parameter</p>
</li>
<li><p>Value = value of the parameter</p>
</li>
<li><p>Examples:</p>
<pre><code class="remark-code"><div class="remark-code-line"># Create a configmap with two keys</div><div class="remark-code-line">kubectl create cm my-app-config \</div><div class="remark-code-line">  --from-literal=foreground=red \</div><div class="remark-code-line">  --from-literal=background=blue</div><div class="remark-code-line"></div><div class="remark-code-line"># Create a configmap from a file containing key=val pairs</div><div class="remark-code-line">kubectl create cm my-app-config \</div><div class="remark-code-line">  --from-env-file=app.conf</div></code></pre></li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">491 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-configmaps-to-containers">Exposing configmaps to containers</h2>
<ul>
<li><p>Configmaps can be exposed as plain files in the filesystem of a container</p>
<ul>
<li><p>this is achieved by declaring a volume and mounting it in the container</p>
</li>
<li><p>this is particularly effective for configmaps containing whole files</p>
</li>
</ul>
</li>
<li><p>Configmaps can be exposed as environment variables in the container</p>
<ul>
<li><p>this is achieved with the downward API</p>
</li>
<li><p>this is particularly effective for configmaps containing individual parameters</p>
</li>
</ul>
</li>
<li><p>Let's see how to do both!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">492 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="passing-a-configuration-file-with-a-configmap">Passing a configuration file with a configmap</h2>
<ul>
<li><p>We will start a load balancer powered by HAProxy</p>
</li>
<li><p>We will use the <a href="https://hub.docker.com/_/haproxy/">official <code class="remark-inline-code">haproxy</code> image</a></p>
</li>
<li><p>It expects to find its configuration in <code class="remark-inline-code">/usr/local/etc/haproxy/haproxy.cfg</code></p>
</li>
<li><p>We will provide a simple HAproxy configuration, <code class="remark-inline-code">k8s/haproxy.cfg</code></p>
</li>
<li><p>It listens on port 80, and load balances connections between IBM and Google</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">493 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-the-configmap">Creating the configmap</h2>
<div class="exercise"><ul>
<li><p>Go to the <code class="remark-inline-code">k8s</code> directory in the repository:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">cd</span> ~/container.training/k8s</div></code></pre>
</li>
<li><p>Create a configmap named <code class="remark-inline-code">haproxy</code> and holding the configuration file:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create configmap haproxy --from-file=haproxy.cfg</div></code></pre>
</li>
<li><p>Check what our configmap looks like:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get configmap haproxy -o yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">494 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-configmap">Using the configmap</h2>
<p>We are going to use the following pod definition:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> haproxy</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  volumes:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> config</div><div class="remark-code-line"><span class="hljs-attr">    configMap:</span></div><div class="remark-code-line"><span class="hljs-attr">      name:</span> haproxy</div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> haproxy</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> haproxy</div><div class="remark-code-line"><span class="hljs-attr">    volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">    - name:</span> config</div><div class="remark-code-line"><span class="hljs-attr">      mountPath:</span> /usr/local/etc/haproxy/</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">495 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-configmap">Using the configmap</h2>
<ul>
<li>The resource definition from the previous slide is in <code class="remark-inline-code">k8s/haproxy.yaml</code></li>
</ul>
<div class="exercise"><ul>
<li>Create the HAProxy pod:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/haproxy.yaml</div></code></pre>
</li>
</ul>
<!-- ```hide kubectl wait pod haproxy --for condition=ready``` -->

<ul>
<li>Check the IP address allocated to the pod:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod haproxy -o wide</div><div class="remark-code-line">IP=$(kubectl get pod haproxy -o json | jq -r .status.podIP)</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">496 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-our-load-balancer">Testing our load balancer</h2>
<ul>
<li><p>The load balancer will send:</p>
<ul>
<li><p>half of the connections to Google</p>
</li>
<li><p>the other half to IBM</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Access the load balancer a few times:<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="hljs-variable">$IP</span></div><div class="remark-code-line">curl <span class="hljs-variable">$IP</span></div><div class="remark-code-line">curl <span class="hljs-variable">$IP</span></div></code></pre>
</li>
</ul>
</div>

<p>We should see connections served by Google, and others served by IBM.
<br>
(Each server sends us a redirect page. Look at the URL that they send us to!)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">497 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-configmaps-with-the-downward-api">Exposing configmaps with the downward API</h2>
<ul>
<li><p>We are going to run a Docker registry on a custom port</p>
</li>
<li><p>By default, the registry listens on port 5000</p>
</li>
<li><p>This can be changed by setting environment variable <code class="remark-inline-code">REGISTRY_HTTP_ADDR</code></p>
</li>
<li><p>We are going to store the port number in a configmap</p>
</li>
<li><p>Then we will expose that configmap as a container environment variable</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">498 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-the-configmap">Creating the configmap</h2>
<div class="exercise"><ul>
<li><p>Our configmap will have a single key, <code class="remark-inline-code">http.addr</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create configmap registry --from-literal=http.addr=0.0.0.0:80</div></code></pre>
</li>
<li><p>Check our configmap:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get configmap registry -o yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">499 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-configmap">Using the configmap</h2>
<p>We are going to use the following pod definition:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> registry</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> registry</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> registry</div><div class="remark-code-line"><span class="hljs-attr">    env:</span></div><div class="remark-code-line"><span class="hljs-attr">    - name:</span> REGISTRY_HTTP_ADDR</div><div class="remark-code-line"><span class="hljs-attr">      valueFrom:</span></div><div class="remark-code-line"><span class="hljs-attr">        configMapKeyRef:</span></div><div class="remark-code-line"><span class="hljs-attr">          name:</span> registry</div><div class="remark-code-line"><span class="hljs-attr">          key:</span> http.addr</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">500 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-configmap">Using the configmap</h2>
<ul>
<li>The resource definition from the previous slide is in <code class="remark-inline-code">k8s/registry.yaml</code></li>
</ul>
<div class="exercise"><ul>
<li>Create the registry pod:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/registry.yaml</div></code></pre>
</li>
</ul>
<!-- ```hide kubectl wait pod registry --for condition=ready``` -->

<ul>
<li><p>Check the IP address allocated to the pod:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod registry -o wide</div><div class="remark-code-line">IP=$(kubectl get pod registry -o json | jq -r .status.podIP)</div></code></pre>
</li>
<li><p>Confirm that the registry is available on port 80:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="hljs-variable">$IP</span>/v2/_catalog</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">501 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="passwords-tokens-sensitive-information">Passwords, tokens, sensitive information</h2>
<ul>
<li><p>For sensitive information, there is another special resource: <em>Secrets</em></p>
</li>
<li><p>Secrets and Configmaps work almost the same way</p>
<p>(we'll expose the differences on the next slide)</p>
</li>
<li><p>The <em>intent</em> is different, though:</p>
<p><em>"You should use secrets for things which are actually secret like API keys, 
credentials, etc., and use config map for not-secret configuration data."</em></p>
<p><em>"In the future there will likely be some differentiators for secrets like rotation or support for backing the secret API w/ HSMs, etc."</em></p>
<p>(Source: <a href="https://stackoverflow.com/a/36925553/580281">the author of both features</a>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">502 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="differences-between-configmaps-and-secrets">Differences between configmaps and secrets</h2>
<ul>
<li><p>Secrets are base64-encoded when shown with <code class="remark-inline-code">kubectl get secrets -o yaml</code></p>
<ul>
<li><p>keep in mind that this is just <em>encoding</em>, not <em>encryption</em></p>
</li>
<li><p>it is very easy to <a href="https://medium.com/@mveritym/decoding-kubernetes-secrets-60deed7a96a3">automatically extract and decode secrets</a></p>
</li>
</ul>
</li>
<li><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">Secrets can be encrypted at rest</a></p>
</li>
<li><p>With RBAC, we can authorize a user to access configmaps, but not secrets</p>
<p>(since they are two different kinds of resources)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/configuration.md">k8s/configuration.md</a></span></p><div class="remark-slide-number">503 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/plastic-containers.JPG" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">504 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-accessing-logs-from-the-cli" class="remark-slide-content title hljs-default"><p>Accessing logs from the CLI</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-managing-configuration">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-6">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-centralized-logging">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">505 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="accessing-logs-from-the-cli">Accessing logs from the CLI</h1>
<ul>
<li><p>The <code class="remark-inline-code">kubectl logs</code> commands has limitations:</p>
<ul>
<li><p>it cannot stream logs from multiple pods at a time</p>
</li>
<li><p>when showing logs from multiple pods, it mixes them all together</p>
</li>
</ul>
</li>
<li><p>We are going to see how to do it better</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md">k8s/logs-cli.md</a></span></p><div class="remark-slide-number">506 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="doing-it-manually">Doing it manually</h2>
<ul>
<li><p>We <em>could</em> (if we were so inclined), write a program or script that would:</p>
<ul>
<li><p>take a selector as an argument</p>
</li>
<li><p>enumerate all pods matching that selector (with <code class="remark-inline-code">kubectl get -l ...</code>)</p>
</li>
<li><p>fork one <code class="remark-inline-code">kubectl logs --follow ...</code> command per container</p>
</li>
<li><p>annotate the logs (the output of each <code class="remark-inline-code">kubectl logs ...</code> process) with their origin</p>
</li>
<li><p>preserve ordering by using <code class="remark-inline-code">kubectl logs --timestamps ...</code> and merge the output</p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">507 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="doing-it-manually">Doing it manually</h2>
<ul>
<li><p>We <em>could</em> (if we were so inclined), write a program or script that would:</p>
<ul>
<li><p>take a selector as an argument</p>
</li>
<li><p>enumerate all pods matching that selector (with <code class="remark-inline-code">kubectl get -l ...</code>)</p>
</li>
<li><p>fork one <code class="remark-inline-code">kubectl logs --follow ...</code> command per container</p>
</li>
<li><p>annotate the logs (the output of each <code class="remark-inline-code">kubectl logs ...</code> process) with their origin</p>
</li>
<li><p>preserve ordering by using <code class="remark-inline-code">kubectl logs --timestamps ...</code> and merge the output</p>
</li>
</ul>
</li>
<li><p>We <em>could</em> do it, but thankfully, others did it for us already!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md">k8s/logs-cli.md</a></span></p><div class="remark-slide-number">508 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="stern">Stern</h2>
<p><a href="https://github.com/wercker/stern">Stern</a> is an open source project
by <a href="http://www.wercker.com/">Wercker</a>.</p>
<p>From the README:</p>
<p><em>Stern allows you to tail multiple pods on Kubernetes and multiple containers within the pod. Each result is color coded for quicker debugging.</em></p>
<p><em>The query is a regular expression so the pod name can easily be filtered and you don't need to specify the exact id (for instance omitting the deployment id). If a pod is deleted it gets removed from tail and if a new pod is added it automatically gets tailed.</em></p>
<p>Exactly what we need!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md">k8s/logs-cli.md</a></span></p><div class="remark-slide-number">509 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="installing-stern">Installing Stern</h2>
<ul>
<li><p>Run <code class="remark-inline-code">stern</code> (without arguments) to check if it's installed:</p>
<pre><code class="remark-code"><div class="remark-code-line">$ stern</div><div class="remark-code-line">Tail multiple pods and containers from Kubernetes</div><div class="remark-code-line"></div><div class="remark-code-line">Usage:</div><div class="remark-code-line">stern pod-query [flags]</div></code></pre></li>
<li><p>If it is not installed, the easiest method is to download a <a href="https://github.com/wercker/stern/releases">binary release</a></p>
</li>
<li><p>The following commands will install Stern on a Linux Intel 64 bit machine:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo curl -L -o /usr/<span class="hljs-built_in">local</span>/bin/stern \</div><div class="remark-code-line">   https://github.com/wercker/stern/releases/download/1.10.0/stern_linux_amd64</div><div class="remark-code-line">sudo chmod +x /usr/<span class="hljs-built_in">local</span>/bin/stern</div></code></pre>
</li>
</ul>
<!-- ##VERSION## -->

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md">k8s/logs-cli.md</a></span></p><div class="remark-slide-number">510 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-stern">Using Stern</h2>
<ul>
<li><p>There are two ways to specify the pods for which we want to see the logs:</p>
<ul>
<li><p><code class="remark-inline-code">-l</code> followed by a selector expression (like with many <code class="remark-inline-code">kubectl</code> commands)</p>
</li>
<li><p>with a "pod query", i.e. a regex used to match pod names</p>
</li>
</ul>
</li>
<li><p>These two ways can be combined if necessary</p>
</li>
</ul>
<div class="exercise"><ul>
<li>View the logs for all the rng containers:<pre><code class="bash hljs remark-code"><div class="remark-code-line">stern rng</div></code></pre>
</li>
</ul>
<!--
```wait HTTP/1.1```
```keys ^C```
-->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md">k8s/logs-cli.md</a></span></p><div class="remark-slide-number">511 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="stern-convenient-options">Stern convenient options</h2>
<ul>
<li><p>The <code class="remark-inline-code">--tail N</code> flag shows the last <code class="remark-inline-code">N</code> lines for each container</p>
<p>(Instead of showing the logs since the creation of the container)</p>
</li>
<li><p>The <code class="remark-inline-code">-t</code> / <code class="remark-inline-code">--timestamps</code> flag shows timestamps</p>
</li>
<li><p>The <code class="remark-inline-code">--all-namespaces</code> flag is self-explanatory</p>
</li>
</ul>
<div class="exercise"><ul>
<li>View what's up with the <code class="remark-inline-code">weave</code> system containers:<pre><code class="bash hljs remark-code"><div class="remark-code-line">stern --tail 1 --timestamps --all-namespaces weave</div></code></pre>
</li>
</ul>
<!--
```wait weave-npc```
```keys ^C```
-->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md">k8s/logs-cli.md</a></span></p><div class="remark-slide-number">512 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-stern-with-a-selector">Using Stern with a selector</h2>
<ul>
<li><p>When specifying a selector, we can omit the value for a label</p>
</li>
<li><p>This will match all objects having that label (regardless of the value)</p>
</li>
<li><p>Everything created with <code class="remark-inline-code">kubectl run</code> has a label <code class="remark-inline-code">run</code></p>
</li>
<li><p>We can use that property to view the logs of all the pods created with <code class="remark-inline-code">kubectl run</code></p>
</li>
<li><p>Similarly, everything created with <code class="remark-inline-code">kubectl create deployment</code> has a label <code class="remark-inline-code">app</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>View the logs for all the things started with <code class="remark-inline-code">kubectl create deployment</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">stern <span class="hljs-_">-l</span> app</div></code></pre>
</li>
</ul>
<!--
```wait units of work```
```keys ^C```
-->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-cli.md">k8s/logs-cli.md</a></span></p><div class="remark-slide-number">513 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-1.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">514 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-centralized-logging" class="remark-slide-content title hljs-default"><p>Centralized logging</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-accessing-logs-from-the-cli">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-6">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-namespaces">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">515 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="centralized-logging">Centralized logging</h1>
<ul>
<li><p>Using <code class="remark-inline-code">kubectl</code> or <code class="remark-inline-code">stern</code> is simple; but it has drawbacks:</p>
<ul>
<li><p>when a node goes down, its logs are not available anymore</p>
</li>
<li><p>we can only dump or stream logs; we want to search/index/count...</p>
</li>
</ul>
</li>
<li><p>We want to send all our logs to a single place</p>
</li>
<li><p>We want to parse them (e.g. for HTTP logs) and index them</p>
</li>
<li><p>We want a nice web dashboard</p>
</li>
</ul><div class="remark-slide-number">516 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="centralized-logging">Centralized logging</h1>
<ul>
<li><p>Using <code class="remark-inline-code">kubectl</code> or <code class="remark-inline-code">stern</code> is simple; but it has drawbacks:</p>
<ul>
<li><p>when a node goes down, its logs are not available anymore</p>
</li>
<li><p>we can only dump or stream logs; we want to search/index/count...</p>
</li>
</ul>
</li>
<li><p>We want to send all our logs to a single place</p>
</li>
<li><p>We want to parse them (e.g. for HTTP logs) and index them</p>
</li>
<li><p>We want a nice web dashboard</p>
</li>
<li><p>We are going to deploy an EFK stack</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">517 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-is-efk-">What is EFK?</h2>
<ul>
<li><p>EFK is three components:</p>
<ul>
<li><p>ElasticSearch (to store and index log entries)</p>
</li>
<li><p>Fluentd (to get container logs, process them, and put them in ElasticSearch)</p>
</li>
<li><p>Kibana (to view/search log entries with a nice UI)</p>
</li>
</ul>
</li>
<li><p>The only component that we need to access from outside the cluster will be Kibana</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">518 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploying-efk-on-our-cluster">Deploying EFK on our cluster</h2>
<ul>
<li>We are going to use a YAML file describing all the required resources</li>
</ul>
<div class="exercise"><ul>
<li>Load the YAML file into our cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/efk.yaml</div></code></pre>
</li>
</ul>
</div>

<p>If we <a href="https://github.com/jpetazzo/container.training/blob/master/k8s/efk.yaml">look at the YAML file</a>, we see that
it creates a daemon set, two deployments, two services,
and a few roles and role bindings (to give fluentd the required permissions).</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">519 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-itinerary-of-a-log-line-before-fluentd-">The itinerary of a log line (before Fluentd)</h2>
<ul>
<li><p>A container writes a line on stdout or stderr</p>
</li>
<li><p>Both are typically piped to the container engine (Docker or otherwise)</p>
</li>
<li><p>The container engine reads the line, and sends it to a logging driver</p>
</li>
<li><p>The timestamp and stream (stdout or stderr) is added to the log line</p>
</li>
<li><p>With the default configuration for Kubernetes, the line is written to a JSON file</p>
<p>(<code class="remark-inline-code">/var/log/containers/pod-name_namespace_container-id.log</code>)</p>
</li>
<li><p>That file is read when we invoke <code class="remark-inline-code">kubectl logs</code>; we can access it directly too</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">520 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-itinerary-of-a-log-line-with-fluentd-">The itinerary of a log line (with Fluentd)</h2>
<ul>
<li><p>Fluentd runs on each node (thanks to a daemon set)</p>
</li>
<li><p>It binds-mounts <code class="remark-inline-code">/var/log/containers</code> from the host (to access these files)</p>
</li>
<li><p>It continuously scans this directory for new files; reads them; parses them</p>
</li>
<li><p>Each log line becomes a JSON object, fully annotated with extra information:
<br>container id, pod name, Kubernetes labels ...</p>
</li>
<li><p>These JSON objects are stored in ElasticSearch</p>
</li>
<li><p>ElasticSearch indexes the JSON objects</p>
</li>
<li><p>We can access the logs through Kibana (and perform searches, counts, etc.)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">521 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="accessing-kibana">Accessing Kibana</h2>
<ul>
<li><p>Kibana offers a web interface that is relatively straightforward</p>
</li>
<li><p>Let's check it out!</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Check which <code class="remark-inline-code">NodePort</code> was allocated to Kibana:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc kibana</div></code></pre>
</li>
<li><p>With our web browser, connect to Kibana</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">522 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-kibana">Using Kibana</h2>
<p><em>Note: this is not a Kibana workshop! So this section is deliberately very terse.</em></p>
<ul>
<li><p>The first time you connect to Kibana, you must "configure an index pattern"</p>
</li>
<li><p>Just use the one that is suggested, <code class="remark-inline-code">@timestamp</code><span class="red">*</span></p>
</li>
<li><p>Then click "Discover" (in the top-left corner)</p>
</li>
<li><p>You should see container logs</p>
</li>
<li><p>Advice: in the left column, select a few fields to display, e.g.:</p>
<p><code class="remark-inline-code">kubernetes.host</code>, <code class="remark-inline-code">kubernetes.pod_name</code>, <code class="remark-inline-code">stream</code>, <code class="remark-inline-code">log</code></p>
</li>
</ul>
<p><span class="red">*</span>If you don't see <code class="remark-inline-code">@timestamp</code>, it's probably because no logs exist yet.
<br>Wait a bit, and double-check the logging pipeline!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">523 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="caveat-emptor">Caveat emptor</h2>
<p>We are using EFK because it is relatively straightforward
to deploy on Kubernetes, without having to redeploy or reconfigure
our cluster. But it doesn't mean that it will always be the best
option for your use-case. If you are running Kubernetes in the
cloud, you might consider using the cloud provider's logging
infrastructure (if it can be integrated with Kubernetes).</p>
<p>The deployment method that we will use here has been simplified:
there is only one ElasticSearch node. In a real deployment, you
might use a cluster, both for performance and reliability reasons.
But this is outside of the scope of this chapter.</p>
<p>The YAML file that we used creates all the resources in the
<code class="remark-inline-code">default</code> namespace, for simplicity. In a real scenario, you will
create the resources in the <code class="remark-inline-code">kube-system</code> namespace or in a dedicated namespace.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/logs-centralized.md">k8s/logs-centralized.md</a></span></p><div class="remark-slide-number">524 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-2.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">525 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-namespaces" class="remark-slide-content title hljs-default"><p>Namespaces</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-centralized-logging">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-7">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-kustomize">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">526 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="namespaces">Namespaces</h1>
<ul>
<li><p>We would like to deploy another copy of DockerCoins on our cluster</p>
</li>
<li><p>We could rename all our deployments and services:</p>
<p>hasher → hasher2, redis → redis2, rng → rng2, etc.</p>
</li>
<li><p>That would require updating the code</p>
</li>
<li><p>There has to be a better way!</p>
</li>
</ul><div class="remark-slide-number">527 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="namespaces">Namespaces</h1>
<ul>
<li><p>We would like to deploy another copy of DockerCoins on our cluster</p>
</li>
<li><p>We could rename all our deployments and services:</p>
<p>hasher → hasher2, redis → redis2, rng → rng2, etc.</p>
</li>
<li><p>That would require updating the code</p>
</li>
<li><p>There has to be a better way!</p>
</li>
<li><p>As hinted by the title of this section, we will use <em>namespaces</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">528 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="identifying-a-resource">Identifying a resource</h2>
<ul>
<li><p>We cannot have two resources with the same name</p>
<p>(or can we...?)</p>
</li>
</ul><div class="remark-slide-number">529 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="identifying-a-resource">Identifying a resource</h2>
<ul>
<li><p>We cannot have two resources with the same name</p>
<p>(or can we...?)</p>
</li>
<li><p>We cannot have two resources <em>of the same kind</em> with the same name</p>
<p>(but it's OK to have an <code class="remark-inline-code">rng</code> service, an <code class="remark-inline-code">rng</code> deployment, and an <code class="remark-inline-code">rng</code> daemon set)</p>
</li>
</ul><div class="remark-slide-number">530 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="identifying-a-resource">Identifying a resource</h2>
<ul>
<li><p>We cannot have two resources with the same name</p>
<p>(or can we...?)</p>
</li>
<li><p>We cannot have two resources <em>of the same kind</em> with the same name</p>
<p>(but it's OK to have an <code class="remark-inline-code">rng</code> service, an <code class="remark-inline-code">rng</code> deployment, and an <code class="remark-inline-code">rng</code> daemon set)</p>
</li>
<li><p>We cannot have two resources of the same kind with the same name <em>in the same namespace</em></p>
<p>(but it's OK to have e.g. two <code class="remark-inline-code">rng</code> services in different namespaces)</p>
</li>
</ul><div class="remark-slide-number">531 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="identifying-a-resource">Identifying a resource</h2>
<ul>
<li><p>We cannot have two resources with the same name</p>
<p>(or can we...?)</p>
</li>
<li><p>We cannot have two resources <em>of the same kind</em> with the same name</p>
<p>(but it's OK to have an <code class="remark-inline-code">rng</code> service, an <code class="remark-inline-code">rng</code> deployment, and an <code class="remark-inline-code">rng</code> daemon set)</p>
</li>
<li><p>We cannot have two resources of the same kind with the same name <em>in the same namespace</em></p>
<p>(but it's OK to have e.g. two <code class="remark-inline-code">rng</code> services in different namespaces)</p>
</li>
<li><p>Except for resources that exist at the <em>cluster scope</em></p>
<p>(these do not belong to a namespace)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">532 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="uniquely-identifying-a-resource">Uniquely identifying a resource</h2>
<ul>
<li><p>For <em>namespaced</em> resources:</p>
<p>the tuple <em>(kind, name, namespace)</em> needs to be unique</p>
</li>
<li><p>For resources at the <em>cluster scope</em>:</p>
<p>the tuple <em>(kind, name)</em> needs to be unique</p>
</li>
</ul>
<div class="exercise"><ul>
<li>List resource types again, and check the NAMESPACED column:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl api-resources</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">533 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pre-existing-namespaces">Pre-existing namespaces</h2>
<ul>
<li><p>If we deploy a cluster with <code class="remark-inline-code">kubeadm</code>, we have three or four namespaces:</p>
<ul>
<li><p><code class="remark-inline-code">default</code> (for our applications)</p>
</li>
<li><p><code class="remark-inline-code">kube-system</code> (for the control plane)</p>
</li>
<li><p><code class="remark-inline-code">kube-public</code> (contains one ConfigMap for cluster discovery)</p>
</li>
<li><p><code class="remark-inline-code">kube-node-lease</code> (in Kubernetes 1.14 and later; contains Lease objects)</p>
</li>
</ul>
</li>
<li><p>If we deploy differently, we may have different namespaces</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">534 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-namespaces">Creating namespaces</h2>
<ul>
<li>Let's see two identical methods to create a namespace</li>
</ul>
<div class="exercise"><ul>
<li><p>We can use <code class="remark-inline-code">kubectl create namespace</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create namespace blue</div></code></pre>
</li>
<li><p>Or we can construct a very minimal YAML snippet:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span>- &lt;&lt;EOF</div><div class="remark-code-line">apiVersion: v1</div><div class="remark-code-line">kind: Namespace</div><div class="remark-code-line">metadata:</div><div class="remark-code-line">  name: blue</div><div class="remark-code-line">EOF</div></code></pre>
</li>
</ul>
</div>

<ul>
<li>Some tools like Helm will create namespaces automatically when needed</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">535 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-namespaces">Using namespaces</h2>
<ul>
<li><p>We can pass a <code class="remark-inline-code">-n</code> or <code class="remark-inline-code">--namespace</code> flag to most <code class="remark-inline-code">kubectl</code> commands:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n blue get svc</div></code></pre>
</li>
<li><p>We can also change our current <em>context</em></p>
</li>
<li><p>A context is a <em>(user, cluster, namespace)</em> tuple</p>
</li>
<li><p>We can manipulate contexts with the <code class="remark-inline-code">kubectl config</code> command</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">536 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="viewing-existing-contexts">Viewing existing contexts</h2>
<ul>
<li>On our training environments, at this point, there should be only one context</li>
</ul>
<div class="exercise"><ul>
<li>View existing contexts to see the cluster name and the current user:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config get-contexts</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>The current context (the only one!) is tagged with a <code class="remark-inline-code">*</code></p>
</li>
<li><p>What are NAME, CLUSTER, AUTHINFO, and NAMESPACE?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">537 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-in-a-context">What's in a context</h2>
<ul>
<li><p>NAME is an arbitrary string to identify the context</p>
</li>
<li><p>CLUSTER is a reference to a cluster</p>
<p>(i.e. API endpoint URL, and optional certificate)</p>
</li>
<li><p>AUTHINFO is a reference to the authentication information to use</p>
<p>(i.e. a TLS client certificate, token, or otherwise)</p>
</li>
<li><p>NAMESPACE is the namespace</p>
<p>(empty string = <code class="remark-inline-code">default</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">538 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="switching-contexts">Switching contexts</h2>
<ul>
<li><p>We want to use a different namespace</p>
</li>
<li><p>Solution 1: update the current context</p>
<p><em>This is appropriate if we need to change just one thing (e.g. namespace or authentication).</em></p>
</li>
<li><p>Solution 2: create a new context and switch to it</p>
<p><em>This is appropriate if we need to change multiple things and switch back and forth.</em></p>
</li>
<li><p>Let's go with solution 1!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">539 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-a-context">Updating a context</h2>
<ul>
<li><p>This is done through <code class="remark-inline-code">kubectl config set-context</code></p>
</li>
<li><p>We can update a context by passing its name, or the current context with <code class="remark-inline-code">--current</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Update the current context to use the <code class="remark-inline-code">blue</code> namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-context --current --namespace=blue</div></code></pre>
</li>
<li><p>Check the result:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config get-contexts</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">540 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-our-new-namespace">Using our new namespace</h2>
<ul>
<li>Let's check that we are in our new namespace, then deploy a new copy of Dockercoins</li>
</ul>
<div class="exercise"><ul>
<li>Verify that the new context is empty:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">541 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploying-dockercoins-with-yaml-files">Deploying DockerCoins with YAML files</h2>
<ul>
<li>The GitHub repository <code class="remark-inline-code">jpetazzo/kubercoins</code> contains everything we need!</li>
</ul>
<div class="exercise"><ul>
<li><p>Clone the kubercoins repository:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">cd</span> ~</div><div class="remark-code-line">git <span class="hljs-built_in">clone</span> https://github.com/jpetazzo/kubercoins</div></code></pre>
</li>
<li><p>Create all the DockerCoins resources:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span> kubercoins</div></code></pre>
</li>
</ul>
</div>

<p>If the argument behind <code class="remark-inline-code">-f</code> is a directory, all the files in that directory are processed. </p>
<p>The subdirectories are <em>not</em> processed, unless we also add the <code class="remark-inline-code">-R</code> flag.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">542 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="viewing-the-deployed-app">Viewing the deployed app</h2>
<ul>
<li>Let's see if this worked correctly!</li>
</ul>
<div class="exercise"><ul>
<li><p>Retrieve the port number allocated to the <code class="remark-inline-code">webui</code> service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc webui</div></code></pre>
</li>
<li><p>Point our browser to <a href="http://x.x.x.x:3xxxx/">http://X.X.X.X:3xxxx</a></p>
</li>
</ul>
</div>

<p>If the graph shows up but stays at zero, give it a minute or two!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">543 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="namespaces-and-isolation">Namespaces and isolation</h2>
<ul>
<li><p>Namespaces <em>do not</em> provide isolation</p>
</li>
<li><p>A pod in the <code class="remark-inline-code">green</code> namespace can communicate with a pod in the <code class="remark-inline-code">blue</code> namespace</p>
</li>
<li><p>A pod in the <code class="remark-inline-code">default</code> namespace can communicate with a pod in the <code class="remark-inline-code">kube-system</code> namespace</p>
</li>
<li><p>CoreDNS uses a different subdomain for each namespace</p>
</li>
<li><p>Example: from any pod in the cluster, you can connect to the Kubernetes API with:</p>
<p><code class="remark-inline-code">https://kubernetes.default.svc.cluster.local:443/</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">544 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="isolating-pods">Isolating pods</h2>
<ul>
<li><p>Actual isolation is implemented with <em>network policies</em></p>
</li>
<li><p>Network policies are resources (like deployments, services, namespaces...)</p>
</li>
<li><p>Network policies specify which flows are allowed:</p>
<ul>
<li><p>between pods</p>
</li>
<li><p>from pods to the outside world</p>
</li>
<li><p>and vice-versa</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">545 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="switch-back-to-the-default-namespace">Switch back to the default namespace</h2>
<ul>
<li>Let's make sure that we don't run future exercises in the <code class="remark-inline-code">blue</code> namespace</li>
</ul>
<div class="exercise"><ul>
<li>Switch back to the original context:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-context --current --namespace=</div></code></pre>
</li>
</ul>
</div>

<p>Note: we could have used <code class="remark-inline-code">--namespace=default</code> for the same result.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">546 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="switching-namespaces-more-easily">Switching namespaces more easily</h2>
<ul>
<li><p>We can also use a little helper tool called <code class="remark-inline-code">kubens</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-comment"># Switch to namespace foo</span></div><div class="remark-code-line">kubens foo</div><div class="remark-code-line"><span class="hljs-comment"># Switch back to the previous namespace</span></div><div class="remark-code-line">kubens -</div></code></pre>
</li>
<li><p>On our clusters, <code class="remark-inline-code">kubens</code> is called <code class="remark-inline-code">kns</code> instead</p>
<p>(so that it's even fewer keystrokes to switch namespaces)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">547 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kubens-and-kubectx-"><code class="remark-inline-code">kubens</code> and <code class="remark-inline-code">kubectx</code></h2>
<ul>
<li><p>With <code class="remark-inline-code">kubens</code>, we can switch quickly between namespaces</p>
</li>
<li><p>With <code class="remark-inline-code">kubectx</code>, we can switch quickly between contexts</p>
</li>
<li><p>Both tools are simple shell scripts available from <a href="https://github.com/ahmetb/kubectx">https://github.com/ahmetb/kubectx</a></p>
</li>
<li><p>On our clusters, they are installed as <code class="remark-inline-code">kns</code> and <code class="remark-inline-code">kctx</code></p>
<p>(for brevity and to avoid completion clashes between <code class="remark-inline-code">kubectx</code> and <code class="remark-inline-code">kubectl</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">548 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-kube-ps1-"><code class="remark-inline-code">kube-ps1</code></h2>
<ul>
<li><p>It's easy to lose track of our current cluster / context / namespace</p>
</li>
<li><p><code class="remark-inline-code">kube-ps1</code> makes it easy to track these, by showing them in our shell prompt</p>
</li>
<li><p>It's a simple shell script available from <a href="https://github.com/jonmosco/kube-ps1">https://github.com/jonmosco/kube-ps1</a></p>
</li>
<li><p>On our clusters, <code class="remark-inline-code">kube-ps1</code> is installed and included in <code class="remark-inline-code">PS1</code>:</p>
<pre><code class="remark-code"><div class="remark-code-line">[123.45.67.89] <span class="remark-code-span-highlighted">(kubernetes-admin@kubernetes:default)</span> docker@node1 ~</div></code></pre><p>(The highlighted part is <code class="remark-inline-code">context:namespace</code>, managed by <code class="remark-inline-code">kube-ps1</code>)</p>
</li>
<li><p>Highly recommended if you work across multiple contexts or namespaces!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/namespaces.md">k8s/namespaces.md</a></span></p><div class="remark-slide-number">549 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/two-containers-on-a-truck.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">550 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-kustomize" class="remark-slide-content title hljs-default"><p>Kustomize</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-namespaces">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-7">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-managing-stacks-with-helm">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">551 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="kustomize">Kustomize</h1>
<ul>
<li><p>Kustomize lets us transform YAML files representing Kubernetes resources</p>
</li>
<li><p>The original YAML files are valid resource files</p>
<p>(e.g. they can be loaded with <code class="remark-inline-code">kubectl apply -f</code>)</p>
</li>
<li><p>They are left untouched by Kustomize</p>
</li>
<li><p>Kustomize lets us define <em>overlays</em> that extend or change the resource files</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">552 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="differences-with-helm">Differences with Helm</h2>
<ul>
<li><p>Helm charts use placeholders <code class="remark-inline-code">{{ like.this }}</code></p>
</li>
<li><p>Kustomize "bases" are standard Kubernetes YAML</p>
</li>
<li><p>It is possible to use an existing set of YAML as a Kustomize base</p>
</li>
<li><p>As a result, writing a Helm chart is more work ...</p>
</li>
<li><p>... But Helm charts are also more powerful; e.g. they can:</p>
<ul>
<li><p>use flags to conditionally include resources or blocks</p>
</li>
<li><p>check if a given Kubernetes API group is supported</p>
</li>
<li><p><a href="https://helm.sh/docs/chart_template_guide/">and much more</a></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">553 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kustomize-concepts">Kustomize concepts</h2>
<ul>
<li><p>Kustomize needs a <code class="remark-inline-code">kustomization.yaml</code> file</p>
</li>
<li><p>That file can be a <em>base</em> or a <em>variant</em></p>
</li>
<li><p>If it's a <em>base</em>:</p>
<ul>
<li>it lists YAML resource files to use</li>
</ul>
</li>
<li><p>If it's a <em>variant</em> (or <em>overlay</em>):</p>
<ul>
<li><p>it refers to (at least) one <em>base</em></p>
</li>
<li><p>and some <em>patches</em></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">554 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="an-easy-way-to-get-started-with-kustomize">An easy way to get started with Kustomize</h2>
<ul>
<li><p>We are going to use <a href="https://www.replicated.com/ship/">Replicated Ship</a> to experiment with Kustomize</p>
</li>
<li><p>The <a href="https://github.com/replicatedhq/ship/releases">Replicated Ship CLI</a> has been installed on our clusters</p>
</li>
<li><p>Replicated Ship has multiple workflows; here is what we will do:</p>
<ul>
<li><p>initialize a Kustomize overlay from a remote GitHub repository</p>
</li>
<li><p>customize some values using the web UI provided by Ship</p>
</li>
<li><p>look at the resulting files and apply them to the cluster</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">555 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="getting-started-with-ship">Getting started with Ship</h2>
<ul>
<li><p>We need to run <code class="remark-inline-code">ship init</code> in a new directory</p>
</li>
<li><p><code class="remark-inline-code">ship init</code> requires a URL to a remote repository containing Kubernetes YAML</p>
</li>
<li><p>It will clone that repository and start a web UI</p>
</li>
<li><p>Later, it can watch that repository and/or update from it</p>
</li>
<li><p>We will use the <a href="https://github.com/jpetazzo/kubercoins">jpetazzo/kubercoins</a> repository</p>
<p>(it contains all the DockerCoins resources as YAML files)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">556 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-ship-init-"><code class="remark-inline-code">ship init</code></h2>
<div class="exercise"><ul>
<li><p>Change to a new directory:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">mkdir ~/kustomcoins</div><div class="remark-code-line"><span class="hljs-built_in">cd</span> ~/kustomcoins</div></code></pre>
</li>
<li><p>Run <code class="remark-inline-code">ship init</code> with the kustomcoins repository:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ship init https://github.com/jpetazzo/kubercoins</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">557 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="access-the-web-ui">Access the web UI</h2>
<ul>
<li><p><code class="remark-inline-code">ship init</code> tells us to connect on <code class="remark-inline-code">localhost:8800</code></p>
</li>
<li><p>We need to replace <code class="remark-inline-code">localhost</code> with the address of our node</p>
<p>(since we run on a remote machine)</p>
</li>
<li><p>Follow the steps in the web UI, and change one parameter</p>
<p>(e.g. set the number of replicas in the worker Deployment)</p>
</li>
<li><p>Complete the web workflow, and go back to the CLI</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">558 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="inspect-the-results">Inspect the results</h2>
<ul>
<li><p>Look at the content of our directory</p>
</li>
<li><p><code class="remark-inline-code">base</code> contains the kubercoins repository + a <code class="remark-inline-code">kustomization.yaml</code> file</p>
</li>
<li><p><code class="remark-inline-code">overlays/ship</code> contains the Kustomize overlay referencing the base + our patch(es)</p>
</li>
<li><p><code class="remark-inline-code">rendered.yaml</code> is a YAML bundle containing the patched application</p>
</li>
<li><p><code class="remark-inline-code">.ship</code> contains a state file used by Ship</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">559 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-results">Using the results</h2>
<ul>
<li><p>We can <code class="remark-inline-code">kubectl apply -f rendered.yaml</code></p>
<p>(on any version of Kubernetes)</p>
</li>
<li><p>Starting with Kubernetes 1.14, we can apply the overlay directly with:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply -k overlays/ship</div></code></pre>
</li>
<li><p>But let's not do that for now!</p>
</li>
<li><p>We will create a new copy of DockerCoins in another namespace</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">560 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploy-dockercoins-with-kustomize">Deploy DockerCoins with Kustomize</h2>
<div class="exercise"><ul>
<li><p>Create a new namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create namespace kustomcoins</div></code></pre>
</li>
<li><p>Deploy DockerCoins:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> rendered.yaml --namespace=kustomcoins</div></code></pre>
</li>
<li><p>Or, with Kubernetes 1.14, you can also do this:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply -k overlays/ship --namespace=kustomcoins</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">561 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-our-new-copy-of-dockercoins">Checking our new copy of DockerCoins</h2>
<ul>
<li>We can check the worker logs, or the web UI</li>
</ul>
<div class="exercise"><ul>
<li><p>Retrieve the NodePort number of the web UI:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get service webui --namespace=kustomcoins</div></code></pre>
</li>
<li><p>Open it in a web browser</p>
</li>
<li><p>Look at the worker logs:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs deploy/worker --tail=10 --follow --namespace=kustomcoins</div></code></pre>
</li>
</ul>
</div>

<p>Note: it might take a minute or two for the worker to start.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/kustomize.md">k8s/kustomize.md</a></span></p><div class="remark-slide-number">562 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/wall-of-containers.jpeg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">563 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-managing-stacks-with-helm" class="remark-slide-content title hljs-default"><p>Managing stacks with Helm</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-kustomize">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-7">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-collecting-metrics-with-prometheus">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">564 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="managing-stacks-with-helm">Managing stacks with Helm</h1>
<ul>
<li><p>We created our first resources with <code class="remark-inline-code">kubectl run</code>, <code class="remark-inline-code">kubectl expose</code> ...</p>
</li>
<li><p>We have also created resources by loading YAML files with <code class="remark-inline-code">kubectl apply -f</code></p>
</li>
<li><p>For larger stacks, managing thousands of lines of YAML is unreasonable</p>
</li>
<li><p>These YAML bundles need to be customized with variable parameters</p>
<p>(E.g.: number of replicas, image version to use ...)</p>
</li>
<li><p>It would be nice to have an organized, versioned collection of bundles</p>
</li>
<li><p>It would be nice to be able to upgrade/rollback these bundles carefully</p>
</li>
<li><p><a href="https://helm.sh/">Helm</a> is an open source project offering all these things!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">565 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="helm-concepts">Helm concepts</h2>
<ul>
<li><p><code class="remark-inline-code">helm</code> is a CLI tool</p>
</li>
<li><p><code class="remark-inline-code">tiller</code> is its companion server-side component</p>
</li>
<li><p>A "chart" is an archive containing templatized YAML bundles</p>
</li>
<li><p>Charts are versioned</p>
</li>
<li><p>Charts can be stored on private or public repositories</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">566 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="installing-helm">Installing Helm</h2>
<ul>
<li>If the <code class="remark-inline-code">helm</code> CLI is not installed in your environment, install it</li>
</ul>
<div class="exercise"><ul>
<li><p>Check if <code class="remark-inline-code">helm</code> is installed:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm</div></code></pre>
</li>
<li><p>If it's not installed, run the following command:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">567 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="installing-tiller">Installing Tiller</h2>
<ul>
<li><p>Tiller is composed of a <em>service</em> and a <em>deployment</em> in the <code class="remark-inline-code">kube-system</code> namespace</p>
</li>
<li><p>They can be managed (installed, upgraded...) with the <code class="remark-inline-code">helm</code> CLI</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Deploy Tiller:<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm init</div></code></pre>
</li>
</ul>
</div>

<p>If Tiller was already installed, don't worry: this won't break it.</p>
<p>At the end of the install process, you will see:</p>
<pre><code class="remark-code"><div class="remark-code-line">Happy Helming!</div></code></pre><p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">568 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="fix-account-permissions">Fix account permissions</h2>
<ul>
<li><p>Helm permission model requires us to tweak permissions</p>
</li>
<li><p>In a more realistic deployment, you might create per-user or per-team
service accounts, roles, and role bindings</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Grant <code class="remark-inline-code">cluster-admin</code> role to <code class="remark-inline-code">kube-system:default</code> service account:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create clusterrolebinding add-on-cluster-admin \</div><div class="remark-code-line">  --clusterrole=cluster-admin --serviceaccount=kube-system:default</div></code></pre>
</li>
</ul>
</div>

<p>(Defining the exact roles and permissions on your cluster requires
a deeper knowledge of Kubernetes' RBAC model. The command above is
fine for personal and development clusters.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">569 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="view-available-charts">View available charts</h2>
<ul>
<li><p>A public repo is pre-configured when installing Helm</p>
</li>
<li><p>We can view available charts with <code class="remark-inline-code">helm search</code> (and an optional keyword)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>View all available charts:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm search</div></code></pre>
</li>
<li><p>View charts related to <code class="remark-inline-code">prometheus</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm search prometheus</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">570 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="install-a-chart">Install a chart</h2>
<ul>
<li><p>Most charts use <code class="remark-inline-code">LoadBalancer</code> service types by default</p>
</li>
<li><p>Most charts require persistent volumes to store data</p>
</li>
<li><p>We need to relax these requirements a bit</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Install the Prometheus metrics collector on our cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm install stable/prometheus \</div><div class="remark-code-line">     --set server.service.type=NodePort \</div><div class="remark-code-line">     --set server.persistentVolume.enabled=<span class="hljs-literal">false</span></div></code></pre>
</li>
</ul>
</div>

<p>Where do these <code class="remark-inline-code">--set</code> options come from?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">571 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="inspecting-a-chart">Inspecting a chart</h2>
<ul>
<li><code class="remark-inline-code">helm inspect</code> shows details about a chart (including available options)</li>
</ul>
<div class="exercise"><ul>
<li>See the metadata and all available options for <code class="remark-inline-code">stable/prometheus</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm inspect stable/prometheus</div></code></pre>
</li>
</ul>
</div>

<p>The chart's metadata includes a URL to the project's home page.</p>
<p>(Sometimes it conveniently points to the documentation for the chart.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">572 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="viewing-installed-charts">Viewing installed charts</h2>
<ul>
<li>Helm keeps track of what we've installed</li>
</ul>
<div class="exercise"><ul>
<li>List installed Helm charts:<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm list</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/helm.md">k8s/helm.md</a></span></p><div class="remark-slide-number">573 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">574 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-collecting-metrics-with-prometheus" class="remark-slide-content title hljs-default"><p>Collecting metrics with Prometheus</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-managing-stacks-with-helm">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-7">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-resource-limits">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">575 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="collecting-metrics-with-prometheus">Collecting metrics with Prometheus</h1>
<ul>
<li><p>Prometheus is an open-source monitoring system including:</p>
<ul>
<li><p>multiple <em>service discovery</em> backends to figure out which metrics to collect</p>
</li>
<li><p>a <em>scraper</em> to collect these metrics</p>
</li>
<li><p>an efficient <em>time series database</em> to store these metrics</p>
</li>
<li><p>a specific query language (PromQL) to query these time series</p>
</li>
<li><p>an <em>alert manager</em> to notify us according to metrics values or trends</p>
</li>
</ul>
</li>
<li><p>We are going to use it to collect and query some metrics on our Kubernetes cluster</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">576 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="why-prometheus-">Why Prometheus?</h2>
<ul>
<li><p>We don't endorse Prometheus more or less than any other system</p>
</li>
<li><p>It's relatively well integrated within the Cloud Native ecosystem</p>
</li>
<li><p>It can be self-hosted (this is useful for tutorials like this)</p>
</li>
<li><p>It can be used for deployments of varying complexity:</p>
<ul>
<li><p>one binary and 10 lines of configuration to get started</p>
</li>
<li><p>all the way to thousands of nodes and millions of metrics</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">577 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-metrics-to-prometheus">Exposing metrics to Prometheus</h2>
<ul>
<li><p>Prometheus obtains metrics and their values by querying <em>exporters</em></p>
</li>
<li><p>An exporter serves metrics over HTTP, in plain text</p>
</li>
<li><p>This is what the <em>node exporter</em> looks like:</p>
<p><a href="http://demo.robustperception.io:9100/metrics">http://demo.robustperception.io:9100/metrics</a></p>
</li>
<li><p>Prometheus itself exposes its own internal metrics, too:</p>
<p><a href="http://demo.robustperception.io:9090/metrics">http://demo.robustperception.io:9090/metrics</a></p>
</li>
<li><p>If you want to expose custom metrics to Prometheus:</p>
<ul>
<li><p>serve a text page like these, and you're good to go</p>
</li>
<li><p>libraries are available in various languages to help with quantiles etc.</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">578 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-prometheus-gets-these-metrics">How Prometheus gets these metrics</h2>
<ul>
<li><p>The <em>Prometheus server</em> will <em>scrape</em> URLs like these at regular intervals</p>
<p>(by default: every minute; can be more/less frequent)</p>
</li>
<li><p>If you're worried about parsing overhead: exporters can also use protobuf</p>
</li>
<li><p>The list of URLs to scrape (the <em>scrape targets</em>) is defined in configuration</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">579 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="defining-scrape-targets">Defining scrape targets</h2>
<p>This is maybe the simplest configuration file for Prometheus:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">scrape_configs:</span></div><div class="remark-code-line"><span class="hljs-attr">  - job_name:</span> <span class="hljs-string">'prometheus'</span></div><div class="remark-code-line"><span class="hljs-attr">    static_configs:</span></div><div class="remark-code-line"><span class="hljs-attr">      - targets:</span> [<span class="hljs-string">'localhost:9090'</span>]</div></code></pre>
<ul>
<li><p>In this configuration, Prometheus collects its own internal metrics</p>
</li>
<li><p>A typical configuration file will have multiple <code class="remark-inline-code">scrape_configs</code></p>
</li>
<li><p>In this configuration, the list of targets is fixed</p>
</li>
<li><p>A typical configuration file will use dynamic service discovery</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">580 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="service-discovery">Service discovery</h2>
<p>This configuration file will leverage existing DNS <code class="remark-inline-code">A</code> records:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">scrape_configs:</span></div><div class="remark-code-line"><span class="hljs-bullet">  -</span> ...</div><div class="remark-code-line"><span class="hljs-attr">  - job_name:</span> <span class="hljs-string">'node'</span></div><div class="remark-code-line"><span class="hljs-attr">    dns_sd_configs:</span></div><div class="remark-code-line"><span class="hljs-attr">      - names:</span> [<span class="hljs-string">'api-backends.dc-paris-2.enix.io'</span>]</div><div class="remark-code-line"><span class="hljs-attr">        type:</span> <span class="hljs-string">'A'</span></div><div class="remark-code-line"><span class="hljs-attr">        port:</span> <span class="hljs-number">9100</span></div></code></pre>
<ul>
<li><p>In this configuration, Prometheus resolves the provided name(s)</p>
<p>(here, <code class="remark-inline-code">api-backends.dc-paris-2.enix.io</code>)</p>
</li>
<li><p>Each resulting IP address is added as a target on port 9100</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">581 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="dynamic-service-discovery">Dynamic service discovery</h2>
<ul>
<li><p>In the DNS example, the names are re-resolved at regular intervals</p>
</li>
<li><p>As DNS records are created/updated/removed, scrape targets change as well</p>
</li>
<li><p>Existing data (previously collected metrics) is not deleted</p>
</li>
<li><p>Other service discovery backends work in a similar fashion</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">582 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="other-service-discovery-mechanisms">Other service discovery mechanisms</h2>
<ul>
<li><p>Prometheus can connect to e.g. a cloud API to list instances</p>
</li>
<li><p>Or to the Kubernetes API to list nodes, pods, services ...</p>
</li>
<li><p>Or a service like Consul, Zookeeper, etcd, to list applications</p>
</li>
<li><p>The resulting configurations files are <em>way more complex</em></p>
<p>(but don't worry, we won't need to write them ourselves)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">583 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="time-series-database">Time series database</h2>
<ul>
<li><p>We could wonder, "why do we need a specialized database?"</p>
</li>
<li><p>One metrics data point = metrics ID + timestamp + value</p>
</li>
<li><p>With a classic SQL or noSQL data store, that's at least 160 bits of data + indexes</p>
</li>
<li><p>Prometheus is way more efficient, without sacrificing performance</p>
<p>(it will even be gentler on the I/O subsystem since it needs to write less)</p>
</li>
<li><p>Would you like to know more? Check this video:</p>
<p><a href="https://www.youtube.com/watch?v=C4YV-9CrawA">Storage in Prometheus 2.0</a> by <a href="https://twitter.com/putadent">Goutham V</a> at DC17EU</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">584 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-if-prometheus-is-installed">Checking if Prometheus is installed</h2>
<ul>
<li>Before trying to install Prometheus, let's check if it's already there</li>
</ul>
<div class="exercise"><ul>
<li>Look for services with a label <code class="remark-inline-code">app=prometheus</code> across all namespaces:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get services --selector=app=prometheus --all-namespaces</div></code></pre>
</li>
</ul>
</div>

<p>If we see a <code class="remark-inline-code">NodePort</code> service called <code class="remark-inline-code">prometheus-server</code>, we're good!</p>
<p>(We can then skip to "Connecting to the Prometheus web UI".)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">585 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-prometheus-on-our-cluster">Running Prometheus on our cluster</h2>
<p>We need to:</p>
<ul>
<li><p>Run the Prometheus server in a pod</p>
<p>(using e.g. a Deployment to ensure that it keeps running)</p>
</li>
<li><p>Expose the Prometheus server web UI (e.g. with a NodePort)</p>
</li>
<li><p>Run the <em>node exporter</em> on each node (with a Daemon Set)</p>
</li>
<li><p>Setup a Service Account so that Prometheus can query the Kubernetes API</p>
</li>
<li><p>Configure the Prometheus server</p>
<p>(storing the configuration in a Config Map for easy updates)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">586 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="helm-charts-to-the-rescue">Helm charts to the rescue</h2>
<ul>
<li><p>To make our lives easier, we are going to use a Helm chart</p>
</li>
<li><p>The Helm chart will take care of all the steps explained above</p>
<p>(including some extra features that we don't need, but won't hurt)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">587 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="step-1-install-helm">Step 1: install Helm</h2>
<ul>
<li>If we already installed Helm earlier, these commands won't break anything</li>
</ul>
<div class="exercice"><ul>
<li><p>Install Tiller (Helm's server-side component) on our cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm init</div></code></pre>
</li>
<li><p>Give Tiller permission to deploy things on our cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create clusterrolebinding add-on-cluster-admin \</div><div class="remark-code-line">  --clusterrole=cluster-admin --serviceaccount=kube-system:default</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">588 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="step-2-install-prometheus">Step 2: install Prometheus</h2>
<ul>
<li><p>Skip this if we already installed Prometheus earlier</p>
<p>(in doubt, check with <code class="remark-inline-code">helm list</code>)</p>
</li>
</ul>
<div class="exercice"><ul>
<li>Install Prometheus on our cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">helm upgrade prometheus stable/prometheus \</div><div class="remark-code-line">    --install \</div><div class="remark-code-line">    --namespace kube-system \</div><div class="remark-code-line">    --set server.service.type=NodePort \</div><div class="remark-code-line">    --set server.service.nodePort=30090 \</div><div class="remark-code-line">    --set server.persistentVolume.enabled=<span class="hljs-literal">false</span> \</div><div class="remark-code-line">    --set alertmanager.enabled=<span class="hljs-literal">false</span></div></code></pre>
</li>
</ul>
</div>

<p>Curious about all these flags? They're explained in the next slide.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">589 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="explaining-all-the-helm-flags">Explaining all the Helm flags</h2>
<ul>
<li><p><code class="remark-inline-code">helm upgrade prometheus</code> → upgrade release "prometheus" to the latest version ...</p>
<p>(a "release" is a unique name given to an app deployed with Helm)</p>
</li>
<li><p><code class="remark-inline-code">stable/prometheus</code> → ... of the chart <code class="remark-inline-code">prometheus</code> in repo <code class="remark-inline-code">stable</code></p>
</li>
<li><p><code class="remark-inline-code">--install</code> → if the app doesn't exist, create it</p>
</li>
<li><p><code class="remark-inline-code">--namespace kube-system</code> → put it in that specific namespace</p>
</li>
<li><p>And set the following <em>values</em> when rendering the chart's templates:</p>
<ul>
<li><code class="remark-inline-code">server.service.type=NodePort</code> → expose the Prometheus server with a NodePort</li>
<li><code class="remark-inline-code">server.service.nodePort=30090</code> → set the specific NodePort number to use</li>
<li><code class="remark-inline-code">server.persistentVolume.enabled=false</code> → do not use a PersistentVolumeClaim</li>
<li><code class="remark-inline-code">alertmanager.enabled=false</code> → disable the alert manager entirely</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">590 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="connecting-to-the-prometheus-web-ui">Connecting to the Prometheus web UI</h2>
<ul>
<li>Let's connect to the web UI and see what we can do</li>
</ul>
<div class="exercise"><ul>
<li><p>Figure out the NodePort that was allocated to the Prometheus server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc --all-namespaces | grep prometheus-server</div></code></pre>
</li>
<li><p>With your browser, connect to that port</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">591 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="querying-some-metrics">Querying some metrics</h2>
<ul>
<li>This is easy ... if you are familiar with PromQL</li>
</ul>
<div class="exercise"><ul>
<li>Click on "Graph", and in "expression", paste the following:<pre><code class="remark-code"><div class="remark-code-line">sum by (instance) (</div><div class="remark-code-line">  irate(</div><div class="remark-code-line">    container_cpu_usage_seconds_total{</div><div class="remark-code-line">      pod_name=~"worker.*"</div><div class="remark-code-line">      }[5m]</div><div class="remark-code-line">  )</div><div class="remark-code-line">)</div></code></pre></li>
</ul>
</div>

<ul>
<li><p>Click on the blue "Execute" button and on the "Graph" tab just below</p>
</li>
<li><p>We see the cumulated CPU usage of worker pods for each node
<br>
(if we just deployed Prometheus, there won't be much data to see, though)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">592 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="getting-started-with-promql">Getting started with PromQL</h2>
<ul>
<li><p>We can't learn PromQL in just 5 minutes</p>
</li>
<li><p>But we can cover the basics to get an idea of what is possible</p>
<p>(and have some keywords and pointers)</p>
</li>
<li><p>We are going to break down the query above</p>
<p>(building it one step at a time)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">593 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="graphing-one-metric-across-all-tags">Graphing one metric across all tags</h2>
<p>This query will show us CPU usage across all containers:</p>
<pre><code class="remark-code"><div class="remark-code-line">container_cpu_usage_seconds_total</div></code></pre><ul>
<li><p>The suffix of the metrics name tells us:</p>
<ul>
<li><p>the unit (seconds of CPU)</p>
</li>
<li><p>that it's the total used since the container creation</p>
</li>
</ul>
</li>
<li><p>Since it's a "total," it is an increasing quantity</p>
<p>(we need to compute the derivative if we want e.g. CPU % over time)</p>
</li>
<li><p>We see that the metrics retrieved have <em>tags</em> attached to them</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">594 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="selecting-metrics-with-tags">Selecting metrics with tags</h2>
<p>This query will show us only metrics for worker containers:</p>
<pre><code class="remark-code"><div class="remark-code-line">container_cpu_usage_seconds_total{pod_name=~"worker.*"}</div></code></pre><ul>
<li><p>The <code class="remark-inline-code">=~</code> operator allows regex matching</p>
</li>
<li><p>We select all the pods with a name starting with <code class="remark-inline-code">worker</code></p>
<p>(it would be better to use labels to select pods; more on that later)</p>
</li>
<li><p>The result is a smaller set of containers</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">595 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="transforming-counters-in-rates">Transforming counters in rates</h2>
<p>This query will show us CPU usage % instead of total seconds used:</p>
<pre><code class="remark-code"><div class="remark-code-line">100*irate(container_cpu_usage_seconds_total{pod_name=~"worker.*"}[5m])</div></code></pre><ul>
<li><p>The <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#irate"><code class="remark-inline-code">irate</code></a> operator computes the "per-second instant rate of increase"</p>
<ul>
<li><p><code class="remark-inline-code">rate</code> is similar but allows decreasing counters and negative values</p>
</li>
<li><p>with <code class="remark-inline-code">irate</code>, if a counter goes back to zero, we don't get a negative spike</p>
</li>
</ul>
</li>
<li><p>The <code class="remark-inline-code">[5m]</code> tells how far to look back if there is a gap in the data</p>
</li>
<li><p>And we multiply with <code class="remark-inline-code">100*</code> to get CPU % usage</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">596 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="aggregation-operators">Aggregation operators</h2>
<p>This query sums the CPU usage per node:</p>
<pre><code class="remark-code"><div class="remark-code-line">sum by (instance) (</div><div class="remark-code-line">  irate(container_cpu_usage_seconds_total{pod_name=~"worker.*"}[5m])</div><div class="remark-code-line">)</div></code></pre><ul>
<li><p><code class="remark-inline-code">instance</code> corresponds to the node on which the container is running</p>
</li>
<li><p><code class="remark-inline-code">sum by (instance) (...)</code> computes the sum for each instance</p>
</li>
<li><p>Note: all the other tags are collapsed</p>
<p>(in other words, the resulting graph only shows the <code class="remark-inline-code">instance</code> tag)</p>
</li>
<li><p>PromQL supports many more <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/#aggregation-operators">aggregation operators</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">597 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-kind-of-metrics-can-we-collect-">What kind of metrics can we collect?</h2>
<ul>
<li><p>Node metrics (related to physical or virtual machines)</p>
</li>
<li><p>Container metrics (resource usage per container)</p>
</li>
<li><p>Databases, message queues, load balancers, ...</p>
<p>(check out this <a href="https://prometheus.io/docs/instrumenting/exporters/">list of exporters</a>!)</p>
</li>
<li><p>Instrumentation (=deluxe <code class="remark-inline-code">printf</code> for our code)</p>
</li>
<li><p>Business metrics (customers served, revenue, ...)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">598 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container remark-visible"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="node-metrics">Node metrics</h2>
<ul>
<li><p>CPU, RAM, disk usage on the whole node</p>
</li>
<li><p>Total number of processes running, and their states</p>
</li>
<li><p>Number of open files, sockets, and their states</p>
</li>
<li><p>I/O activity (disk, network), per operation or volume</p>
</li>
<li><p>Physical/hardware (when applicable): temperature, fan speed ...</p>
</li>
<li><p>... and much more!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">599 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="container-metrics">Container metrics</h2>
<ul>
<li><p>Similar to node metrics, but not totally identical</p>
</li>
<li><p>RAM breakdown will be different</p>
<ul>
<li>active vs inactive memory</li>
<li>some memory is <em>shared</em> between containers, and accounted specially</li>
</ul>
</li>
<li><p>I/O activity is also harder to track</p>
<ul>
<li>async writes can cause deferred "charges"</li>
<li>some page-ins are also shared between containers</li>
</ul>
</li>
</ul>
<p>For details about container metrics, see:
<br>
<a href="http://jpetazzo.github.io/2013/10/08/docker-containers-metrics/">http://jpetazzo.github.io/2013/10/08/docker-containers-metrics/</a></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">600 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="application-metrics">Application metrics</h2>
<ul>
<li><p>Arbitrary metrics related to your application and business</p>
</li>
<li><p>System performance: request latency, error rate ...</p>
</li>
<li><p>Volume information: number of rows in database, message queue size ...</p>
</li>
<li><p>Business data: inventory, items sold, revenue ...</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">601 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="detecting-scrape-targets">Detecting scrape targets</h2>
<ul>
<li><p>Prometheus can leverage Kubernetes service discovery</p>
<p>(with proper configuration)</p>
</li>
<li><p>Services or pods can be annotated with:</p>
<ul>
<li><code class="remark-inline-code">prometheus.io/scrape: true</code> to enable scraping</li>
<li><code class="remark-inline-code">prometheus.io/port: 9090</code> to indicate the port number</li>
<li><code class="remark-inline-code">prometheus.io/path: /metrics</code> to indicate the URI (<code class="remark-inline-code">/metrics</code> by default)</li>
</ul>
</li>
<li><p>Prometheus will detect and scrape these (without needing a restart or reload)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">602 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="querying-labels">Querying labels</h2>
<ul>
<li><p>What if we want to get metrics for containers belonging to a pod tagged <code class="remark-inline-code">worker</code>?</p>
</li>
<li><p>The cAdvisor exporter does not give us Kubernetes labels</p>
</li>
<li><p>Kubernetes labels are exposed through another exporter</p>
</li>
<li><p>We can see Kubernetes labels through metrics <code class="remark-inline-code">kube_pod_labels</code></p>
<p>(each container appears as a time series with constant value of <code class="remark-inline-code">1</code>)</p>
</li>
<li><p>Prometheus <em>kind of</em> supports "joins" between time series</p>
</li>
<li><p>But only if the names of the tags match exactly</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">603 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="unfortunately-">Unfortunately ...</h2>
<ul>
<li><p>The cAdvisor exporter uses tag <code class="remark-inline-code">pod_name</code> for the name of a pod</p>
</li>
<li><p>The Kubernetes service endpoints exporter uses tag <code class="remark-inline-code">pod</code> instead</p>
</li>
<li><p>See <a href="https://www.robustperception.io/exposing-the-software-version-to-prometheus">this blog post</a> or <a href="https://www.weave.works/blog/aggregating-pod-resource-cpu-memory-usage-arbitrary-labels-prometheus/">this other one</a> to see how to perform "joins"</p>
</li>
<li><p>Alas, Prometheus cannot "join" time series with different labels</p>
<p>(see <a href="https://github.com/prometheus/prometheus/issues/2204">Prometheus issue #2204</a> for the rationale)</p>
</li>
<li><p>There is a workaround involving relabeling, but it's "not cheap"</p>
<ul>
<li><p>see <a href="https://github.com/prometheus/prometheus/issues/2204#issuecomment-261515520">this comment</a> for an overview</p>
</li>
<li><p>or <a href="https://5pi.de/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/">this blog post</a> for a complete description of the process</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">604 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-practice">In practice</h2>
<ul>
<li><p>Grafana is a beautiful (and useful) frontend to display all kinds of graphs</p>
</li>
<li><p>Not everyone needs to know Prometheus, PromQL, Grafana, etc.</p>
</li>
<li><p>But in a team, it is valuable to have at least one person who know them</p>
</li>
<li><p>That person can set up queries and dashboards for the rest of the team</p>
</li>
<li><p>It's a little bit likeknowing how to optimize SQL queries, Dockerfiles ...</p>
<p>Don't panic if you don't know these tools!</p>
<p>... But make sure at least one person in your team is on it 💯</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">605 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/ShippingContainerSFBay.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">606 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-resource-limits" class="remark-slide-content title hljs-default"><p>Resource Limits</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-collecting-metrics-with-prometheus">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-8">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-defining-min-max-and-default-resources">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">607 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="resource-limits">Resource Limits</h1>
<ul>
<li><p>We can attach resource indications to our pods</p>
<p>(or rather: to the <em>containers</em> in our pods)</p>
</li>
<li><p>We can specify <em>limits</em> and/or <em>requests</em></p>
</li>
<li><p>We can specify quantities of CPU and/or memory</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">608 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cpu-vs-memory">CPU vs memory</h2>
<ul>
<li><p>CPU is a <em>compressible resource</em></p>
<p>(it can be preempted immediately without adverse effect)</p>
</li>
<li><p>Memory is an <em>incompressible resource</em></p>
<p>(it needs to be swapped out to be reclaimed; and this is costly)</p>
</li>
<li><p>As a result, exceeding limits will have different consequences for CPU and memory</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">609 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exceeding-cpu-limits">Exceeding CPU limits</h2>
<ul>
<li><p>CPU can be reclaimed instantaneously</p>
<p>(in fact, it is preempted hundreds of times per second, at each context switch)</p>
</li>
<li><p>If a container uses too much CPU, it can be throttled</p>
<p>(it will be scheduled less often)</p>
</li>
<li><p>The processes in that container will run slower</p>
<p>(or rather: they will not run faster)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">610 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exceeding-memory-limits">Exceeding memory limits</h2>
<ul>
<li><p>Memory needs to be swapped out before being reclaimed</p>
</li>
<li><p>"Swapping" means writing memory pages to disk, which is very slow</p>
</li>
<li><p>On a classic system, a process that swaps can get 1000x slower</p>
<p>(because disk I/O is 1000x slower than memory I/O)</p>
</li>
<li><p>Exceeding the memory limit (even by a small amount) can reduce performance <em>a lot</em></p>
</li>
<li><p>Kubernetes <em>does not support swap</em> (more on that later!)</p>
</li>
<li><p>Exceeding the memory limit will cause the container to be killed</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">611 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="limits-vs-requests">Limits vs requests</h2>
<ul>
<li><p>Limits are "hard limits" (they can't be exceeded)</p>
<ul>
<li><p>a container exceeding its memory limit is killed</p>
</li>
<li><p>a container exceeding its CPU limit is throttled</p>
</li>
</ul>
</li>
<li><p>Requests are used for scheduling purposes</p>
<ul>
<li><p>a container using <em>less</em> than what it requested will never be killed or throttled</p>
</li>
<li><p>the scheduler uses the requested sizes to determine placement</p>
</li>
<li><p>the resources requested by all pods on a node will never exceed the node size</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">612 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pod-quality-of-service">Pod quality of service</h2>
<p>Each pod is assigned a QoS class (visible in <code class="remark-inline-code">status.qosClass</code>).</p>
<ul>
<li><p>If limits = requests:</p>
<ul>
<li><p>as long as the container uses less than the limit, it won't be affected</p>
</li>
<li><p>if all containers in a pod have <em>(limits=requests)</em>, QoS is "Guaranteed"</p>
</li>
</ul>
</li>
<li><p>If requests &lt; limits:</p>
<ul>
<li><p>as long as the container uses less than the request, it won't be affected</p>
</li>
<li><p>otherwise, it might be killed / evicted if the node gets overloaded</p>
</li>
<li><p>if at least one container has <em>(requests&lt;limits)</em>, QoS is "Burstable"</p>
</li>
</ul>
</li>
<li><p>If a pod doesn't have any request nor limit, QoS is "BestEffort"</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">613 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="quality-of-service-impact">Quality of service impact</h2>
<ul>
<li><p>When a node is overloaded, BestEffort pods are killed first</p>
</li>
<li><p>Then, Burstable pods that exceed their limits</p>
</li>
<li><p>Burstable and Guaranteed pods below their limits are never killed</p>
<p>(except if their node fails)</p>
</li>
<li><p>If we only use Guaranteed pods, no pod should ever be killed</p>
<p>(as long as they stay within their limits)</p>
</li>
</ul>
<p>(Pod QoS is also explained in <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">this page</a> of the Kubernetes documentation and in <a href="https://medium.com/google-cloud/quality-of-service-class-qos-in-kubernetes-bb76a89eb2c6">this blog post</a>.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">614 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="where-is-my-swap-">Where is my swap?</h2>
<ul>
<li><p>The semantics of memory and swap limits on Linux cgroups are complex</p>
</li>
<li><p>In particular, it's not possible to disable swap for a cgroup</p>
<p>(the closest option is to <a href="https://unix.stackexchange.com/questions/77939/turning-off-swapping-for-only-one-process-with-cgroups">reduce "swappiness"</a>)</p>
</li>
<li><p>The architects of Kubernetes wanted to ensure that Guaranteed pods never swap</p>
</li>
<li><p>The only solution was to disable swap entirely</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">615 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="alternative-point-of-view">Alternative point of view</h2>
<ul>
<li><p>Swap enables paging¹ of anonymous² memory</p>
</li>
<li><p>Even when swap is disabled, Linux will still page memory for:</p>
<ul>
<li><p>executables, libraries</p>
</li>
<li><p>mapped files</p>
</li>
</ul>
</li>
<li><p>Disabling swap <em>will reduce performance and available resources</em></p>
</li>
<li><p>For a good time, read <a href="https://github.com/kubernetes/kubernetes/issues/53533">kubernetes/kubernetes#53533</a></p>
</li>
<li><p>Also read this <a href="https://jvns.ca/blog/2017/02/17/mystery-swap/">excellent blog post about swap</a></p>
</li>
</ul>
<p>¹Paging: reading/writing memory pages from/to disk to reclaim physical memory</p>
<p>²Anonymous memory: memory that is not backed by files or blocks</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">616 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="enabling-swap-anyway">Enabling swap anyway</h2>
<ul>
<li><p>If you don't care that pods are swapping, you can enable swap</p>
</li>
<li><p>You will need to add the flag <code class="remark-inline-code">--fail-swap-on=false</code> to kubelet</p>
<p>(otherwise, it won't start!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">617 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="specifying-resources">Specifying resources</h2>
<ul>
<li><p>Resource requests are expressed at the <em>container</em> level</p>
</li>
<li><p>CPU is expressed in "virtual CPUs"</p>
<p>(corresponding to the virtual CPUs offered by some cloud providers)</p>
</li>
<li><p>CPU can be expressed with a decimal value, or even a "milli" suffix</p>
<p>(so 100m = 0.1)</p>
</li>
<li><p>Memory is expressed in bytes</p>
</li>
<li><p>Memory can be expressed with k, M, G, T, ki, Mi, Gi, Ti suffixes</p>
<p>(corresponding to 10^3, 10^6, 10^9, 10^12, 2^10, 2^20, 2^30, 2^40)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">618 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="specifying-resources-in-practice">Specifying resources in practice</h2>
<p>This is what the spec of a Pod with resources will look like:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">containers:</span></div><div class="remark-code-line"><span class="hljs-attr">- name:</span> httpenv</div><div class="remark-code-line"><span class="hljs-attr">  image:</span> jpetazzo/httpenv</div><div class="remark-code-line"><span class="hljs-attr">  resources:</span></div><div class="remark-code-line"><span class="hljs-attr">    limits:</span></div><div class="remark-code-line"><span class="hljs-attr">      memory:</span> <span class="hljs-string">"100Mi"</span></div><div class="remark-code-line"><span class="hljs-attr">      cpu:</span> <span class="hljs-string">"100m"</span></div><div class="remark-code-line"><span class="hljs-attr">    requests:</span></div><div class="remark-code-line"><span class="hljs-attr">      memory:</span> <span class="hljs-string">"100Mi"</span></div><div class="remark-code-line"><span class="hljs-attr">      cpu:</span> <span class="hljs-string">"10m"</span></div></code></pre>
<p>This set of resources makes sure that this service won't be killed (as long as it stays below 100 MB of RAM), but allows its CPU usage to be throttled if necessary.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">619 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="default-values">Default values</h2>
<ul>
<li><p>If we specify a limit without a request: </p>
<p>the request is set to the limit</p>
</li>
<li><p>If we specify a request without a limit: </p>
<p>there will be no limit</p>
<p>(which means that the limit will be the size of the node)</p>
</li>
<li><p>If we don't specify anything:</p>
<p>the request is zero and the limit is the size of the node</p>
</li>
</ul>
<p><em>Unless there are default values defined for our namespace!</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">620 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="we-need-default-resource-values">We need default resource values</h2>
<ul>
<li><p>If we do not set resource values at all:</p>
<ul>
<li><p>the limit is "the size of the node"</p>
</li>
<li><p>the request is zero</p>
</li>
</ul>
</li>
<li><p>This is generally <em>not</em> what we want</p>
<ul>
<li><p>a container without a limit can use up all the resources of a node</p>
</li>
<li><p>if the request is zero, the scheduler can't make a smart placement decision</p>
</li>
</ul>
</li>
<li><p>To address this, we can set default values for resources</p>
</li>
<li><p>This is done with a LimitRange object</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">621 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/aerial-view-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">622 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-defining-min-max-and-default-resources" class="remark-slide-content title hljs-default"><p>Defining min, max, and default resources</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-resource-limits">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-8">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-namespace-quotas">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">623 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="defining-min-max-and-default-resources">Defining min, max, and default resources</h1>
<ul>
<li><p>We can create LimitRange objects to indicate any combination of:</p>
<ul>
<li><p>min and/or max resources allowed per pod</p>
</li>
<li><p>default resource <em>limits</em></p>
</li>
<li><p>default resource <em>requests</em></p>
</li>
<li><p>maximal burst ratio (<em>limit/request</em>)</p>
</li>
</ul>
</li>
<li><p>LimitRange objects are namespaced</p>
</li>
<li><p>They apply to their namespace only</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">624 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="limitrange-example">LimitRange example</h2>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> LimitRange</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> my-very-detailed-limitrange</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  limits:</span></div><div class="remark-code-line"><span class="hljs-attr">  - type:</span> Container</div><div class="remark-code-line"><span class="hljs-attr">    min:</span></div><div class="remark-code-line"><span class="hljs-attr">      cpu:</span> <span class="hljs-string">"100m"</span></div><div class="remark-code-line"><span class="hljs-attr">    max:</span></div><div class="remark-code-line"><span class="hljs-attr">      cpu:</span> <span class="hljs-string">"2000m"</span></div><div class="remark-code-line"><span class="hljs-attr">      memory:</span> <span class="hljs-string">"1Gi"</span></div><div class="remark-code-line"><span class="hljs-attr">    default:</span></div><div class="remark-code-line"><span class="hljs-attr">      cpu:</span> <span class="hljs-string">"500m"</span></div><div class="remark-code-line"><span class="hljs-attr">      memory:</span> <span class="hljs-string">"250Mi"</span></div><div class="remark-code-line"><span class="hljs-attr">    defaultRequest:</span></div><div class="remark-code-line"><span class="hljs-attr">      cpu:</span> <span class="hljs-string">"500m"</span></div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">625 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="example-explanation">Example explanation</h2>
<p>The YAML on the previous slide shows an example LimitRange object specifying very detailed limits on CPU usage,
and providing defaults on RAM usage.</p>
<p>Note the <code class="remark-inline-code">type: Container</code> line: in the future,
it might also be possible to specify limits
per Pod, but it's not <a href="https://github.com/kubernetes/website/issues/9585">officially documented yet</a>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">626 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="limitrange-details">LimitRange details</h2>
<ul>
<li><p>LimitRange restrictions are enforced only when a Pod is created</p>
<p>(they don't apply retroactively)</p>
</li>
<li><p>They don't prevent creation of e.g. an invalid Deployment or DaemonSet</p>
<p>(but the pods will not be created as long as the LimitRange is in effect)</p>
</li>
<li><p>If there are multiple LimitRange restrictions, they all apply together</p>
<p>(which means that it's possible to specify conflicting LimitRanges,
<br>preventing any Pod from being created)</p>
</li>
<li><p>If a LimitRange specifies a <code class="remark-inline-code">max</code> for a resource but no <code class="remark-inline-code">default</code>,
<br>that <code class="remark-inline-code">max</code> value becomes the <code class="remark-inline-code">default</code> limit too</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">627 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/blue-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">628 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-namespace-quotas" class="remark-slide-content title hljs-default"><p>Namespace quotas</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-defining-min-max-and-default-resources">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-8">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-limiting-resources-in-practice">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">629 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="namespace-quotas">Namespace quotas</h1>
<ul>
<li><p>We can also set quotas per namespace</p>
</li>
<li><p>Quotas apply to the total usage in a namespace</p>
<p>(e.g. total CPU limits of all pods in a given namespace)</p>
</li>
<li><p>Quotas can apply to resource limits and/or requests</p>
<p>(like the CPU and memory limits that we saw earlier)</p>
</li>
<li><p>Quotas can also apply to other resources:</p>
<ul>
<li><p>"extended" resources (like GPUs)</p>
</li>
<li><p>storage size</p>
</li>
<li><p>number of objects (number of pods, services...)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">630 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-a-quota-for-a-namespace">Creating a quota for a namespace</h2>
<ul>
<li><p>Quotas are enforced by creating a ResourceQuota object</p>
</li>
<li><p>ResourceQuota objects are namespaced, and apply to their namespace only</p>
</li>
<li><p>We can have multiple ResourceQuota objects in the same namespace</p>
</li>
<li><p>The most restrictive values are used</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">631 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="limiting-total-cpu-memory-usage">Limiting total CPU/memory usage</h2>
<ul>
<li>The following YAML specifies an upper bound for <em>limits</em> and <em>requests</em>:<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> ResourceQuota</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> a-little-bit-of-compute</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  hard:</span></div><div class="remark-code-line">    requests.cpu: <span class="hljs-string">"10"</span></div><div class="remark-code-line">    requests.memory: <span class="hljs-number">10</span>Gi</div><div class="remark-code-line">    limits.cpu: <span class="hljs-string">"20"</span></div><div class="remark-code-line">    limits.memory: <span class="hljs-number">20</span>Gi</div></code></pre>
</li>
</ul>
<p>These quotas will apply to the namespace where the ResourceQuota is created.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">632 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="limiting-number-of-objects">Limiting number of objects</h2>
<ul>
<li>The following YAML specifies how many objects of specific types can be created:<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> ResourceQuota</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> quota-for-objects</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  hard:</span></div><div class="remark-code-line"><span class="hljs-attr">    pods:</span> <span class="hljs-number">100</span></div><div class="remark-code-line"><span class="hljs-attr">    services:</span> <span class="hljs-number">10</span></div><div class="remark-code-line"><span class="hljs-attr">    secrets:</span> <span class="hljs-number">10</span></div><div class="remark-code-line"><span class="hljs-attr">    configmaps:</span> <span class="hljs-number">10</span></div><div class="remark-code-line"><span class="hljs-attr">    persistentvolumeclaims:</span> <span class="hljs-number">20</span></div><div class="remark-code-line">    services.nodeports: <span class="hljs-number">0</span></div><div class="remark-code-line">    services.loadbalancers: <span class="hljs-number">0</span></div><div class="remark-code-line">    count/roles.rbac.authorization.k8s.io: <span class="hljs-number">10</span></div></code></pre>
</li>
</ul>
<p>(The <code class="remark-inline-code">count/</code> syntax allows limiting arbitrary objects, including CRDs.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">633 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="yaml-vs-cli">YAML vs CLI</h2>
<ul>
<li><p>Quotas can be created with a YAML definition</p>
</li>
<li><p>... Or with the <code class="remark-inline-code">kubectl create quota</code> command</p>
</li>
<li><p>Example:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create quota sparta --hard=pods=300,limits.memory=300Gi</div></code></pre>
</li>
<li><p>With both YAML and CLI form, the values are always under the <code class="remark-inline-code">hard</code> section</p>
<p>(there is no <code class="remark-inline-code">soft</code> quota)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">634 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="viewing-current-usage">Viewing current usage</h2>
<p>When a ResourceQuota is created, we can see how much of it is used:</p>
<pre><code class="remark-code"><div class="remark-code-line">kubectl describe resourcequota my-resource-quota</div><div class="remark-code-line"></div><div class="remark-code-line">Name:                            my-resource-quota</div><div class="remark-code-line">Namespace:                       default</div><div class="remark-code-line">Resource                         Used  Hard</div><div class="remark-code-line">--------                         ----  ----</div><div class="remark-code-line">pods                             12    100</div><div class="remark-code-line">services                         1     5</div><div class="remark-code-line">services.loadbalancers           0     0</div><div class="remark-code-line">services.nodeports               0     0</div></code></pre><p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">635 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="advanced-quotas-and-priorityclass">Advanced quotas and PriorityClass</h2>
<ul>
<li><p>Since Kubernetes 1.12, it is possible to create PriorityClass objects</p>
</li>
<li><p>Pods can be assigned a PriorityClass</p>
</li>
<li><p>Quotas can be linked to a PriorityClass</p>
</li>
<li><p>This allows us to reserve resources for pods within a namespace</p>
</li>
<li><p>For more details, check <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/#resource-quota-per-priorityclass">this documentation page</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">636 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/chinook-helicopter-container.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">637 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-limiting-resources-in-practice" class="remark-slide-content title hljs-default"><p>Limiting resources in practice</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-namespace-quotas">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-8">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-checking-pod-and-node-resource-usage">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">638 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="limiting-resources-in-practice">Limiting resources in practice</h1>
<ul>
<li><p>We have at least three mechanisms:</p>
<ul>
<li><p>requests and limits per Pod</p>
</li>
<li><p>LimitRange per namespace</p>
</li>
<li><p>ResourceQuota per namespace</p>
</li>
</ul>
</li>
<li><p>Let's see a simple recommendation to get started with resource limits</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">639 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="set-a-limitrange">Set a LimitRange</h2>
<ul>
<li><p>In each namespace, create a LimitRange object</p>
</li>
<li><p>Set a small default CPU request and CPU limit</p>
<p>(e.g. "100m")</p>
</li>
<li><p>Set a default memory request and limit depending on your most common workload</p>
<ul>
<li><p>for Java, Ruby: start with "1G"</p>
</li>
<li><p>for Go, Python, PHP, Node: start with "250M"</p>
</li>
</ul>
</li>
<li><p>Set upper bounds slightly below your expected node size</p>
<p>(80-90% of your node size, with at least a 500M memory buffer)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">640 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="set-a-resourcequota">Set a ResourceQuota</h2>
<ul>
<li><p>In each namespace, create a ResourceQuota object</p>
</li>
<li><p>Set generous CPU and memory limits</p>
<p>(e.g. half the cluster size if the cluster hosts multiple apps)</p>
</li>
<li><p>Set generous objects limits</p>
<ul>
<li><p>these limits should not be here to constrain your users</p>
</li>
<li><p>they should catch a runaway process creating many resources</p>
</li>
<li><p>example: a custom controller creating many pods</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">641 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="observe-refine-iterate">Observe, refine, iterate</h2>
<ul>
<li><p>Observe the resource usage of your pods</p>
<p>(we will see how in the next chapter)</p>
</li>
<li><p>Adjust individual pod limits</p>
</li>
<li><p>If you see trends: adjust the LimitRange</p>
<p>(rather than adjusting every individual set of pod limits)</p>
</li>
<li><p>Observe the resource usage of your namespaces</p>
<p>(with <code class="remark-inline-code">kubectl describe resourcequota ...</code>)</p>
</li>
<li><p>Rinse and repeat regularly</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/resource-limits.md">k8s/resource-limits.md</a></span></p><div class="remark-slide-number">642 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-cranes.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">643 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-checking-pod-and-node-resource-usage" class="remark-slide-content title hljs-default"><p>Checking pod and node resource usage</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-limiting-resources-in-practice">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-8">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-cluster-sizing">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">644 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="checking-pod-and-node-resource-usage">Checking pod and node resource usage</h1>
<ul>
<li><p>Since Kubernetes 1.8, metrics are collected by the <a href="https://v1-13.docs.kubernetes.io/docs/tasks/debug-application-cluster/core-metrics-pipeline/">core metrics pipeline</a></p>
</li>
<li><p>The core metrics pipeline is:</p>
<ul>
<li><p>optional (Kubernetes can function without it)</p>
</li>
<li><p>necessary for some features (like the Horizontal Pod Autoscaler)</p>
</li>
<li><p>exposed through the Kubernetes API using the <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">aggregation layer</a></p>
</li>
<li><p>usually implemented by the "metrics server"</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md">k8s/metrics-server.md</a></span></p><div class="remark-slide-number">645 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-to-know-if-the-metrics-server-is-running-">How to know if the metrics server is running?</h2>
<ul>
<li>The easiest way to know is to run <code class="remark-inline-code">kubectl top</code></li>
</ul>
<div class="exercise"><ul>
<li>Check if the core metrics pipeline is available:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl top nodes</div></code></pre>
</li>
</ul>
</div>

<p>If it shows our nodes and their CPU and memory load, we're good!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md">k8s/metrics-server.md</a></span></p><div class="remark-slide-number">646 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="installing-metrics-server">Installing metrics server</h2>
<ul>
<li><p>The metrics server doesn't have any particular requirements</p>
<p>(it doesn't need persistence, as it doesn't <em>store</em> metrics)</p>
</li>
<li><p>It has its own repository, <a href="https://github.com/kubernetes-incubator/metrics-server]">kubernetes-incubator/metrics-server</a></p>
</li>
<li><p>The repository comes with <a href="https://github.com/kubernetes-incubator/metrics-server/tree/master/deploy/1.8%2B">YAML files for deployment</a></p>
</li>
<li><p>These files may not work on some clusters</p>
<p>(e.g. if your node names are not in DNS)</p>
</li>
<li><p>The container.training repository has a <a href="https://github.com/jpetazzo/container.training/blob/master/k8s/metrics-server.yaml#L90">metrics-server.yaml</a> file to help with that</p>
<p>(we can <code class="remark-inline-code">kubectl apply -f</code> that file if needed)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md">k8s/metrics-server.md</a></span></p><div class="remark-slide-number">647 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="showing-container-resource-usage">Showing container resource usage</h2>
<ul>
<li>Once the metrics server is running, we can check container resource usage</li>
</ul>
<div class="exercise"><ul>
<li>Show resource usage across all containers:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kuebectl top pods --containers --all-namespaces</div></code></pre>
</li>
</ul>
</div>

<ul>
<li>We can also use selectors (<code class="remark-inline-code">-l app=...</code>)</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/metrics-server.md">k8s/metrics-server.md</a></span></p><div class="remark-slide-number">648 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-housing.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">649 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-cluster-sizing" class="remark-slide-content title hljs-default"><p>Cluster sizing</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-checking-pod-and-node-resource-usage">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-8">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-the-horizontal-pod-autoscaler">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">650 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="cluster-sizing">Cluster sizing</h1>
<ul>
<li><p>What happens when the cluster gets full?</p>
</li>
<li><p>How can we scale up the cluster?</p>
</li>
<li><p>Can we do it automatically?</p>
</li>
<li><p>What are other methods to address capacity planning?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">651 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="when-are-we-out-of-resources-">When are we out of resources?</h2>
<ul>
<li><p>kubelet monitors node resources:</p>
<ul>
<li><p>memory</p>
</li>
<li><p>node disk usage (typically the root filesystem of the node)</p>
</li>
<li><p>image disk usage (where container images and RW layers are stored)</p>
</li>
</ul>
</li>
<li><p>For each resource, we can provide two thresholds:</p>
<ul>
<li><p>a hard threshold (if it's met, it provokes immediate action)</p>
</li>
<li><p>a soft threshold (provokes action only after a grace period)</p>
</li>
</ul>
</li>
<li><p>Resource thresholds and grace periods are configurable</p>
<p>(by passing kubelet command-line flags)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">652 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-happens-then-">What happens then?</h2>
<ul>
<li><p>If disk usage is too high:</p>
<ul>
<li><p>kubelet will try to remove terminated pods</p>
</li>
<li><p>then, it will try to <em>evict</em> pods</p>
</li>
</ul>
</li>
<li><p>If memory usage is too high:</p>
<ul>
<li>it will try to evict pods</li>
</ul>
</li>
<li><p>The node is marked as "under pressure"</p>
</li>
<li><p>This temporarily prevents new pods from being scheduled on the node</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">653 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="which-pods-get-evicted-">Which pods get evicted?</h2>
<ul>
<li><p>kubelet looks at the pods' QoS and PriorityClass</p>
</li>
<li><p>First, pods with BestEffort QoS are considered</p>
</li>
<li><p>Then, pods with Burstable QoS exceeding their <em>requests</em></p>
<p>(but only if the exceeding resource is the one that is low on the node)</p>
</li>
<li><p>Finally, pods with Guaranteed QoS, and Burstable pods within their requests</p>
</li>
<li><p>Within each group, pods are sorted by PriorityClass</p>
</li>
<li><p>If there are pods with the same PriorityClass, they are sorted by usage excess</p>
<p>(i.e. the pods whose usage exceeds their requests the most are evicted first)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">654 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="eviction-of-guaranteed-pods">Eviction of Guaranteed pods</h2>
<ul>
<li><p><em>Normally</em>, pods with Guaranteed QoS should not be evicted</p>
</li>
<li><p>A chunk of resources is reserved for node processes (like kubelet)</p>
</li>
<li><p>It is expected that these processes won't use more than this reservation</p>
</li>
<li><p>If they do use more resources anyway, all bets are off!</p>
</li>
<li><p>If this happens, kubelet must evict Guaranteed pods to preserve node stability</p>
<p>(or Burstable pods that are still within their requested usage)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">655 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-happens-to-evicted-pods-">What happens to evicted pods?</h2>
<ul>
<li><p>The pod is terminated</p>
</li>
<li><p>It is marked as <code class="remark-inline-code">Failed</code> at the API level</p>
</li>
<li><p>If the pod was created by a controller, the controller will recreate it</p>
</li>
<li><p>The pod will be recreated on another node, <em>if there are resources available!</em></p>
</li>
<li><p>For more details about the eviction process, see:</p>
<ul>
<li><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/">this documentation page</a> about resource pressure and pod eviction,</p>
</li>
<li><p><a href="https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/">this other documentation page</a> about pod priority and preemption.</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">656 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-if-there-are-no-resources-available-">What if there are no resources available?</h2>
<ul>
<li><p>Sometimes, a pod cannot be scheduled anywhere:</p>
<ul>
<li><p>all the nodes are under pressure,</p>
</li>
<li><p>or the pod requests more resources than are available</p>
</li>
</ul>
</li>
<li><p>The pod then remains in <code class="remark-inline-code">Pending</code> state until the situation improves</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">657 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cluster-scaling">Cluster scaling</h2>
<ul>
<li><p>One way to improve the situation is to add new nodes</p>
</li>
<li><p>This can be done automatically with the <a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">Cluster Autoscaler</a></p>
</li>
<li><p>The autoscaler will automatically scale up:</p>
<ul>
<li>if there are pods that failed to be scheduled</li>
</ul>
</li>
<li><p>The autoscaler will automatically scale down:</p>
<ul>
<li>if nodes have a low utilization for an extended period of time</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">658 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="restrictions-gotchas-">Restrictions, gotchas ...</h2>
<ul>
<li><p>The Cluster Autoscaler only supports a few cloud infrastructures</p>
<p>(see <a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider">here</a> for a list)</p>
</li>
<li><p>The Cluster Autoscaler cannot scale down nodes that have pods using:</p>
<ul>
<li><p>local storage</p>
</li>
<li><p>affinity/anti-affinity rules preventing them from being rescheduled</p>
</li>
<li><p>a restrictive PodDisruptionBudget</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">659 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="other-way-to-do-capacity-planning">Other way to do capacity planning</h2>
<ul>
<li><p>"Running Kubernetes without nodes"</p>
</li>
<li><p>Systems like <a href="https://virtual-kubelet.io/">Virtual Kubelet</a> or Kiyot can run pods using on-demand resources</p>
<ul>
<li><p>Virtual Kubelet can leverage e.g. ACI or Fargate to run pods</p>
</li>
<li><p>Kiyot runs pods in ad-hoc EC2 instances (1 instance per pod)</p>
</li>
</ul>
</li>
<li><p>Economic advantage (no wasted capacity)</p>
</li>
<li><p>Security advantage (stronger isolation between pods)</p>
</li>
</ul>
<p>Check <a href="http://jpetazzo.github.io/2019/02/13/running-kubernetes-without-nodes-with-kiyot/">this blog post</a> for more details.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-sizing.md">k8s/cluster-sizing.md</a></span></p><div class="remark-slide-number">660 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/containers-by-the-water.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">661 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-the-horizontal-pod-autoscaler" class="remark-slide-content title hljs-default"><p>The Horizontal Pod Autoscaler</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-cluster-sizing">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-8">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-additional-lab-environments">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">662 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="the-horizontal-pod-autoscaler">The Horizontal Pod Autoscaler</h1>
<ul>
<li><p>What is the Horizontal Pod Autoscaler, or HPA?</p>
</li>
<li><p>It is a controller that can perform <em>horizontal</em> scaling automatically</p>
</li>
<li><p>Horizontal scaling = changing the number of replicas</p>
<p>(adding / removing pods)</p>
</li>
<li><p>Vertical scaling = changing the size of individual replicas</p>
<p>(increasing / reducing CPU and RAM per pod)</p>
</li>
<li><p>Cluster scaling = changing the size of the cluster</p>
<p>(adding / removing nodes)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">663 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="principle-of-operation">Principle of operation</h2>
<ul>
<li><p>Each HPA resource (or "policy") specifies:</p>
<ul>
<li><p>which object to monitor and scale (e.g. a Deployment, ReplicaSet...)</p>
</li>
<li><p>min/max scaling ranges (the max is a safety limit!)</p>
</li>
<li><p>a target resource usage (e.g. the default is CPU=80%)</p>
</li>
</ul>
</li>
<li><p>The HPA continuously monitors the CPU usage for the related object</p>
</li>
<li><p>It computes how many pods should be running:</p>
<p><code class="remark-inline-code">TargetNumOfPods = ceil(sum(CurrentPodsCPUUtilization) / Target)</code></p>
</li>
<li><p>It scales the related object up/down to this target number of pods</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">664 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pre-requirements">Pre-requirements</h2>
<ul>
<li><p>The metrics server needs to be running</p>
<p>(i.e. we need to be able to see pod metrics with <code class="remark-inline-code">kubectl top pods</code>)</p>
</li>
<li><p>The pods that we want to autoscale need to have resource requests</p>
<p>(because the target CPU% is not absolute, but relative to the request)</p>
</li>
<li><p>The latter actually makes a lot of sense:</p>
<ul>
<li><p>if a Pod doesn't have a CPU request, it might be using 10% of CPU ...</p>
</li>
<li><p>... but only because there is no CPU time available!</p>
</li>
<li><p>this makes sure that we won't add pods to nodes that are already resource-starved</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">665 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-the-hpa">Testing the HPA</h2>
<ul>
<li><p>We will start a CPU-intensive web service</p>
</li>
<li><p>We will send some traffic to that service</p>
</li>
<li><p>We will create an HPA policy</p>
</li>
<li><p>The HPA will automatically scale up the service for us</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">666 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-cpu-intensive-web-service">A CPU-intensive web service</h2>
<ul>
<li><p>Let's use <code class="remark-inline-code">jpetazzo/busyhttp</code></p>
<p>(it is a web server that will use 1s of CPU for each HTTP request)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Deploy the web server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment busyhttp --image=jpetazzo/busyhttp</div></code></pre>
</li>
<li><p>Expose it with a ClusterIP service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment busyhttp --port=80</div></code></pre>
</li>
<li><p>Get the ClusterIP allocated to the service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc busyhttp</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">667 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="monitor-what-s-going-on">Monitor what's going on</h2>
<ul>
<li>Let's start a bunch of commands to watch what is happening</li>
</ul>
<div class="exercise"><ul>
<li><p>Monitor pod CPU usage:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">watch kubectl top pods</div></code></pre>
</li>
<li><p>Monitor service latency:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">httping http://<span class="remark-code-span-highlighted">ClusterIP</span>/</div></code></pre>
</li>
<li><p>Monitor cluster events:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get events -w</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">668 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="send-traffic-to-the-service">Send traffic to the service</h2>
<ul>
<li>We will use <code class="remark-inline-code">ab</code> (Apache Bench) to send traffic</li>
</ul>
<div class="exercise"><ul>
<li>Send a lot of requests to the service, with a concurrency level of 3:<pre><code class="bash hljs remark-code"><div class="remark-code-line">ab -c 3 -n 100000 http://<span class="remark-code-span-highlighted">ClusterIP</span>/</div></code></pre>
</li>
</ul>
</div>

<p>The latency (reported by <code class="remark-inline-code">httping</code>) should increase above 3s.</p>
<p>The CPU utilization should increase to 100%.</p>
<p>(The server is single-threaded and won't go above 100%.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">669 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="create-an-hpa-policy">Create an HPA policy</h2>
<ul>
<li>There is a helper command to do that for us: <code class="remark-inline-code">kubectl autoscale</code></li>
</ul>
<div class="exercise"><ul>
<li>Create the HPA policy for the <code class="remark-inline-code">busyhttp</code> deployment:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl autoscale deployment busyhttp --max=10</div></code></pre>
</li>
</ul>
</div>

<p>By default, it will assume a target of 80% CPU usage.</p>
<p>This can also be set with <code class="remark-inline-code">--cpu-percent=</code>.</p><div class="remark-slide-number">670 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="create-an-hpa-policy">Create an HPA policy</h2>
<ul>
<li>There is a helper command to do that for us: <code class="remark-inline-code">kubectl autoscale</code></li>
</ul>
<div class="exercise"><ul>
<li>Create the HPA policy for the <code class="remark-inline-code">busyhttp</code> deployment:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl autoscale deployment busyhttp --max=10</div></code></pre>
</li>
</ul>
</div>

<p>By default, it will assume a target of 80% CPU usage.</p>
<p>This can also be set with <code class="remark-inline-code">--cpu-percent=</code>.</p>
<p><em>The autoscaler doesn't seem to work. Why?</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">671 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-did-we-miss-">What did we miss?</h2>
<ul>
<li><p>The events stream gives us a hint, but to be honest, it's not very clear:</p>
<p><code class="remark-inline-code">missing request for cpu</code></p>
</li>
<li><p>We forgot to specify a resource request for our Deployment!</p>
</li>
<li><p>The HPA target is not an absolute CPU%</p>
</li>
<li><p>It is relative to the CPU requested by the pod</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">672 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-a-cpu-request">Adding a CPU request</h2>
<ul>
<li><p>Let's edit the deployment and add a CPU request</p>
</li>
<li><p>Since our server can use up to 1 core, let's request 1 core</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit the Deployment definition:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl edit deployment busyhttp</div></code></pre>
</li>
<li><p>In the <code class="remark-inline-code">containers</code> list, add the following block:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">resources:</span></div><div class="remark-code-line"><span class="hljs-attr">  requests:</span></div><div class="remark-code-line"><span class="hljs-attr">    cpu:</span> <span class="hljs-string">"1"</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">673 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="results">Results</h2>
<ul>
<li><p>After saving and quitting, a rolling update happens</p>
<p>(if <code class="remark-inline-code">ab</code> or <code class="remark-inline-code">httping</code> exits, make sure to restart it)</p>
</li>
<li><p>It will take a minute or two for the HPA to kick in:</p>
<ul>
<li><p>the HPA runs every 30 seconds by default</p>
</li>
<li><p>it needs to gather metrics from the metrics server first</p>
</li>
</ul>
</li>
<li><p>If we scale further up (or down), the HPA will react after a few minutes:</p>
<ul>
<li><p>it won't scale up if it already scaled in the last 3 minutes</p>
</li>
<li><p>it won't scale down if it already scaled in the last 5 minutes</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">674 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-about-other-metrics-">What about other metrics?</h2>
<ul>
<li><p>The HPA in API group <code class="remark-inline-code">autoscaling/v1</code> only supports CPU scaling</p>
</li>
<li><p>The HPA in API group <code class="remark-inline-code">autoscaling/v2beta2</code> supports metrics from various API groups:</p>
<ul>
<li><p>metrics.k8s.io, aka metrics server (per-Pod CPU and RAM)</p>
</li>
<li><p>custom.metrics.k8s.io, custom metrics per Pod</p>
</li>
<li><p>external.metrics.k8s.io, external metrics (not associated to Pods)</p>
</li>
</ul>
</li>
<li><p>Kubernetes doesn't implement any of these API groups</p>
</li>
<li><p>Using these metrics requires to <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis">register additional APIs</a></p>
</li>
<li><p>The metrics provided by metrics server are standard; everything else is custom</p>
</li>
<li><p>For more details, see <a href="https://medium.com/uptime-99/kubernetes-hpa-autoscaling-with-custom-and-external-metrics-da7f41ff7846">this great blog post</a> or <a href="https://www.youtube.com/watch?v=gSiGFH4ZnS8">this talk</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/horizontal-pod-autoscaler.md">k8s/horizontal-pod-autoscaler.md</a></span></p><div class="remark-slide-number">675 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/distillery-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">676 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-additional-lab-environments" class="remark-slide-content title hljs-default"><p>Additional lab environments</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-the-horizontal-pod-autoscaler">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-9">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-kubernetes-architecture-deep-dive">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">677 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="additional-lab-environments">Additional lab environments</h1>
<ul>
<li><p>We will now use new sets of VMs</p>
</li>
<li><p>Look out for new individual card with connection information!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prereqs-admin.md">k8s/prereqs-admin.md</a></span></p><div class="remark-slide-number">678 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="doing-or-re-doing-this-on-your-own-">Doing or re-doing this on your own?</h2>
<ul>
<li><p>We are using basic cloud VMs with Ubuntu LTS</p>
</li>
<li><p>Kubernetes <a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">packages</a> or <a href="https://kubernetes.io/docs/setup/release/notes/#server-binaries">binaries</a> have been installed</p>
<p>(depending on what we want to accomplish in the lab)</p>
</li>
<li><p>We disabled IP address checks</p>
<ul>
<li><p>we want to route pod traffic directly between nodes</p>
</li>
<li><p>most cloud providers will treat pod IP addresses as invalid</p>
</li>
<li><p>... and filter them out; so we disable that filter
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prereqs-admin.md">k8s/prereqs-admin.md</a></span></p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">679 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/lots-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">680 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-kubernetes-architecture-deep-dive" class="remark-slide-content title hljs-default"><p>Kubernetes architecture deep dive</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-additional-lab-environments">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-9">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-the-kubernetes-api">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">681 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="kubernetes-architecture-deep-dive">Kubernetes architecture deep dive</h1>
<p>We can arbitrarily split Kubernetes in two parts:</p>
<ul>
<li><p>the <em>nodes</em>, a set of machines that run our containerized workloads;</p>
</li>
<li><p>the <em>control plane</em>, a set of processes implementing the Kubernetes APIs.</p>
</li>
</ul>
<p>Kubernetes also relies on underlying infrastructure:</p>
<ul>
<li><p>servers, network connectivity (obviously!),</p>
</li>
<li><p>optional components like storage systems, load balancers ...</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">682 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="control-plane-location">Control plane location</h2>
<p>The control plane can run:</p>
<ul>
<li><p>in containers, on the same nodes that run other application workloads</p>
<p>(example: Minikube; 1 node runs everything)</p>
</li>
<li><p>on a dedicated node</p>
<p>(example: a cluster installed with kubeadm)</p>
</li>
<li><p>on a dedicated set of nodes</p>
<p>(example: Kubernetes The Hard Way; kops)</p>
</li>
<li><p>outside of the cluster</p>
<p>(example: most managed clusters like AKS, EKS, GKE)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">683 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/k8s-arch2.png" alt="Kubernetes architecture diagram: control plane and nodes"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">684 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-runs-on-a-node">What runs on a node</h2>
<ul>
<li><p>Our containerized workloads</p>
</li>
<li><p>A container engine like Docker, CRI-O, containerd...</p>
<p>(in theory, the choice doesn't matter, as the engine is abstracted by Kubernetes)</p>
</li>
<li><p>kubelet: an agent connecting the node to the cluster</p>
<p>(it connects to the API server, registers the node, receives instructions)</p>
</li>
<li><p>kube-proxy: a component used for internal cluster communication</p>
<p>(note that this is <em>not</em> an overlay network or a CNI plugin!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">685 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-in-the-control-plane">What's in the control plane</h2>
<ul>
<li><p>Everything is stored in etcd</p>
<p>(it's the only stateful component)</p>
</li>
<li><p>Everyone communicates exclusively through the API server:</p>
<ul>
<li><p>we (users) interact with the cluster through the API server</p>
</li>
<li><p>the nodes register and get their instructions through the API server</p>
</li>
<li><p>the other control plane components also register with the API server</p>
</li>
</ul>
</li>
<li><p>API server is the only component that reads/writes from/to etcd</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">686 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="communication-protocols-api-server">Communication protocols: API server</h2>
<ul>
<li><p>The API server exposes a REST API</p>
<p>(except for some calls, e.g. to attach interactively to a container)</p>
</li>
<li><p>Almost all requests and responses are JSON following a strict format</p>
</li>
<li><p>For performance, the requests and responses can also be done over protobuf</p>
<p>(see this <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/protobuf.md">design proposal</a> for details)</p>
</li>
<li><p>In practice, protobuf is used for all internal communication</p>
<p>(between control plane components, and with kubelet)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">687 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="communication-protocols-on-the-nodes">Communication protocols: on the nodes</h2>
<p>The kubelet agent uses a number of special-purpose protocols and interfaces, including:</p>
<ul>
<li><p>CRI (Container Runtime Interface)</p>
<ul>
<li>used for communication with the container engine</li>
<li>abstracts the differences between container engines</li>
<li>based on gRPC+protobuf</li>
</ul>
</li>
<li><p><a href="https://github.com/containernetworking/cni/blob/master/SPEC.md">CNI (Container Network Interface)</a></p>
<ul>
<li>used for communication with network plugins</li>
<li>network plugins are implemented as executable programs invoked by kubelet</li>
<li>network plugins provide IPAM</li>
<li>network plugins set up network interfaces in pods</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">688 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/k8s-arch4-thanks-luxas.png" alt="Kubernetes architecture diagram: communication between components"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">689 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/plastic-containers.JPG" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">690 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-the-kubernetes-api" class="remark-slide-content title hljs-default"><p>The Kubernetes API</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-architecture-deep-dive">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-9">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-other-control-plane-components">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">691 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="the-kubernetes-api">The Kubernetes API</h1>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/protobuf.md#proposal-and-motivation">
<em>The Kubernetes API server is a "dumb server" which offers storage, versioning, validation, update, and watch semantics on API resources.</em>
</a></p>
<p>(<a href="https://twitter.com/smarterclayton">Clayton Coleman</a>, Kubernetes Architect and Maintainer)</p>
<p>What does that mean?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">692 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-kubernetes-api-is-declarative">The Kubernetes API is declarative</h2>
<ul>
<li><p>We cannot tell the API, "run a pod"</p>
</li>
<li><p>We can tell the API, "here is the definition for pod X"</p>
</li>
<li><p>The API server will store that definition (in etcd)</p>
</li>
<li><p><em>Controllers</em> will then wake up and create a pod matching the definition</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">693 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-core-features-of-the-kubernetes-api">The core features of the Kubernetes API</h2>
<ul>
<li><p>We can create, read, update, and delete objects</p>
</li>
<li><p>We can also <em>watch</em> objects</p>
<p>(be notified when an object changes, or when an object of a given type is created)</p>
</li>
<li><p>Objects are strongly typed</p>
</li>
<li><p>Types are <em>validated</em> and <em>versioned</em></p>
</li>
<li><p>Storage and watch operations are provided by etcd</p>
<p>(note: the <a href="https://k3s.io/">k3s</a> project allows us to use sqlite instead of etcd)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">694 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="let-s-experiment-a-bit-">Let's experiment a bit!</h2>
<ul>
<li>For the exercises in this section, connect to the first node of the <code class="remark-inline-code">test</code> cluster</li>
</ul>
<div class="exercise"><ul>
<li><p>SSH to the first node of the test cluster</p>
</li>
<li><p>Check that the cluster is operational:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes</div></code></pre>
</li>
<li><p>All nodes should be <code class="remark-inline-code">Ready</code></p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">695 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="create">Create</h2>
<ul>
<li>Let's create a simple object</li>
</ul>
<div class="exercise"><ul>
<li>Create a namespace with the following command:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span>- &lt;&lt;EOF</div><div class="remark-code-line">apiVersion: v1</div><div class="remark-code-line">kind: Namespace</div><div class="remark-code-line">metadata:</div><div class="remark-code-line">  name: hello</div><div class="remark-code-line">EOF</div></code></pre>
</li>
</ul>
</div>

<p>This is equivalent to <code class="remark-inline-code">kubectl create namespace hello</code>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">696 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="read">Read</h2>
<ul>
<li>Let's retrieve the object we just created</li>
</ul>
<div class="exercise"><ul>
<li>Read back our object:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get namespace hello -o yaml</div></code></pre>
</li>
</ul>
</div>

<p>We see a lot of data that wasn't here when we created the object.</p>
<p>Some data was automatically added to the object (like <code class="remark-inline-code">spec.finalizers</code>).</p>
<p>Some data is dynamic (typically, the content of <code class="remark-inline-code">status</code>.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">697 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="api-requests-and-responses">API requests and responses</h2>
<ul>
<li><p>Almost every Kubernetes API payload (requests and responses) has the same format:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> xxx</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> yyy</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> zzz</div><div class="remark-code-line">  (more metadata fields here)</div><div class="remark-code-line">(more fields here)</div></code></pre>
</li>
<li><p>The fields shown above are mandatory, except for some special cases</p>
<p>(e.g.: in lists of resources, the list itself doesn't have a <code class="remark-inline-code">metadata.name</code>)</p>
</li>
<li><p>We show YAML for convenience, but the API uses JSON</p>
<p>(with optional protobuf encoding)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">698 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="api-versions">API versions</h2>
<ul>
<li><p>The <code class="remark-inline-code">apiVersion</code> field corresponds to an <em>API group</em></p>
</li>
<li><p>It can be either <code class="remark-inline-code">v1</code> (aka "core" group or "legacy group"), or <code class="remark-inline-code">group/versions</code>; e.g.:</p>
<ul>
<li><code class="remark-inline-code">apps/v1</code></li>
<li><code class="remark-inline-code">rbac.authorization.k8s.io/v1</code></li>
<li><code class="remark-inline-code">extensions/v1beta1</code></li>
</ul>
</li>
<li><p>It does not indicate which version of Kubernetes we're talking about</p>
</li>
<li><p>It <em>indirectly</em> indicates the version of the <code class="remark-inline-code">kind</code></p>
<p>(which fields exist, their format, which ones are mandatory...)</p>
</li>
<li><p>A single resource type (<code class="remark-inline-code">kind</code>) is rarely versioned alone</p>
<p>(e.g.: the <code class="remark-inline-code">batch</code> API group contains <code class="remark-inline-code">jobs</code> and <code class="remark-inline-code">cronjobs</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">699 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="update">Update</h2>
<ul>
<li><p>Let's update our namespace object</p>
</li>
<li><p>There are many ways to do that, including:</p>
<ul>
<li><code class="remark-inline-code">kubectl apply</code> (and provide an updated YAML file)</li>
<li><code class="remark-inline-code">kubectl edit</code></li>
<li><code class="remark-inline-code">kubectl patch</code></li>
<li>many helpers, like <code class="remark-inline-code">kubectl label</code>, or <code class="remark-inline-code">kubectl set</code></li>
</ul>
</li>
<li><p>In each case, <code class="remark-inline-code">kubectl</code> will:</p>
<ul>
<li>get the current definition of the object</li>
<li>compute changes</li>
<li>submit the changes (with <code class="remark-inline-code">PATCH</code> requests)</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">700 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-a-label">Adding a label</h2>
<ul>
<li><p>For demonstration purposes, let's add a label to the namespace</p>
</li>
<li><p>The easiest way is to use <code class="remark-inline-code">kubectl label</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>In one terminal, watch namespaces:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get namespaces --show-labels -w</div></code></pre>
</li>
<li><p>In the other, update our namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl label namespaces hello color=purple</div></code></pre>
</li>
</ul>
</div>

<p>We demonstrated <em>update</em> and <em>watch</em> semantics.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">701 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-special-about-watch-">What's special about <em>watch</em>?</h2>
<ul>
<li><p>The API server itself doesn't do anything: it's just a fancy object store</p>
</li>
<li><p>All the actual logic in Kubernetes is implemented with <em>controllers</em></p>
</li>
<li><p>A <em>controller</em> watches a set of resources, and takes action when they change</p>
</li>
<li><p>Examples:</p>
<ul>
<li><p>when a Pod object is created, it gets scheduled and started</p>
</li>
<li><p>when a Pod belonging to a ReplicaSet terminates, it gets replaced</p>
</li>
<li><p>when a Deployment object is updated, it can trigger a rolling update</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">702 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-1.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">703 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-other-control-plane-components" class="remark-slide-content title hljs-default"><p>Other control plane components</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-the-kubernetes-api">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-9">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-building-our-own-cluster">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">704 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="other-control-plane-components">Other control plane components</h1>
<ul>
<li><p>API server ✔️</p>
</li>
<li><p>etcd ✔️</p>
</li>
<li><p>Controller manager</p>
</li>
<li><p>Scheduler</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">705 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="controller-manager">Controller manager</h2>
<ul>
<li><p>This is a collection of loops watching all kinds of objects</p>
</li>
<li><p>That's where the actual logic of Kubernetes lives</p>
</li>
<li><p>When we create a Deployment (e.g. with <code class="remark-inline-code">kubectl run web --image=nginx</code>),</p>
<ul>
<li><p>we create a Deployment object</p>
</li>
<li><p>the Deployment controller notices it, and creates a ReplicaSet</p>
</li>
<li><p>the ReplicaSet controller notices the ReplicaSet, and creates a Pod</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">706 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="scheduler">Scheduler</h2>
<ul>
<li><p>When a pod is created, it is in <code class="remark-inline-code">Pending</code> state</p>
</li>
<li><p>The scheduler (or rather: <em>a scheduler</em>) must bind it to a node</p>
<ul>
<li><p>Kubernetes comes with an efficient scheduler with many features</p>
</li>
<li><p>if we have special requirements, we can add another scheduler
<br>
(example: this <a href="https://github.com/kelseyhightower/scheduler">demo scheduler</a> uses the cost of nodes, stored in node annotations)</p>
</li>
</ul>
</li>
<li><p>A pod might stay in <code class="remark-inline-code">Pending</code> state for a long time:</p>
<ul>
<li><p>if the cluster is full</p>
</li>
<li><p>if the pod has special constraints that can't be met</p>
</li>
<li><p>if the scheduler is not running (!)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/architecture.md">k8s/architecture.md</a></span></p><div class="remark-slide-number">707 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-2.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">708 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-building-our-own-cluster" class="remark-slide-content title hljs-default"><p>Building our own cluster</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-other-control-plane-components">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-9">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-adding-nodes-to-the-cluster">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">709 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="building-our-own-cluster">Building our own cluster</h1>
<ul>
<li><p>Let's build our own cluster!</p>
<p><em>Perfection is attained not when there is nothing left to add, but when there is nothing left to take away. (Antoine de Saint-Exupery)</em></p>
</li>
<li><p>Our goal is to build a minimal cluster allowing us to:</p>
<ul>
<li>create a Deployment (with <code class="remark-inline-code">kubectl run</code> or <code class="remark-inline-code">kubectl create deployment</code>)</li>
<li>expose it with a Service</li>
<li>connect to that service</li>
</ul>
</li>
</ul>
<ul>
<li><p>"Minimal" here means:</p>
<ul>
<li>smaller number of components</li>
<li>smaller number of command-line flags</li>
<li>smaller number of configuration files</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">710 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="non-goals">Non-goals</h2>
<ul>
<li><p>For now, we don't care about security</p>
</li>
<li><p>For now, we don't care about scalability</p>
</li>
<li><p>For now, we don't care about high availability</p>
</li>
<li><p>All we care about is <em>simplicity</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">711 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-environment">Our environment</h2>
<ul>
<li><p>We will use the machine indicated as <code class="remark-inline-code">dmuc1</code></p>
<p>(this stands for "Dessine Moi Un Cluster" or "Draw Me A Sheep",
<br>in homage to Saint-Exupery's "The Little Prince")</p>
</li>
<li><p>This machine:</p>
<ul>
<li><p>runs Ubuntu LTS</p>
</li>
<li><p>has Kubernetes, Docker, and etcd binaries installed</p>
</li>
<li><p>but nothing is running</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">712 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-our-environment">Checking our environment</h2>
<ul>
<li>Let's make sure we have everything we need first</li>
</ul>
<div class="exercise"><ul>
<li><p>Log into the <code class="remark-inline-code">dmuc1</code> machine</p>
</li>
<li><p>Get root:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo -i</div></code></pre>
</li>
<li><p>Check available versions:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">etcd -version</div><div class="remark-code-line">kube-apiserver --version</div><div class="remark-code-line">dockerd --version</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">713 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-plan">The plan</h2>
<ol>
<li><p>Start API server</p>
</li>
<li><p>Interact with it (create Deployment and Service)</p>
</li>
<li><p>See what's broken</p>
</li>
<li><p>Fix it and go back to step 2 until it works!</p>
</li>
</ol>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">714 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="dealing-with-multiple-processes">Dealing with multiple processes</h2>
<ul>
<li><p>We are going to start many processes</p>
</li>
<li><p>Depending on what you're comfortable with, you can:</p>
<ul>
<li><p>open multiple windows and multiple SSH connections</p>
</li>
<li><p>use a terminal multiplexer like screen or tmux</p>
</li>
<li><p>put processes in the background with <code class="remark-inline-code">&amp;</code>
<br>(warning: log output might get confusing to read!)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">715 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-api-server">Starting API server</h2>
<div class="exercise"><ul>
<li>Try to start the API server:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kube-apiserver</div><div class="remark-code-line"><span class="hljs-comment"># It will fail with "--etcd-servers must be specified"</span></div></code></pre>
</li>
</ul>
</div>

<p>Since the API server stores everything in etcd,
it cannot start without it.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">716 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-etcd">Starting etcd</h2>
<div class="exercise"><ul>
<li>Try to start etcd:<pre><code class="bash hljs remark-code"><div class="remark-code-line">etcd</div></code></pre>
</li>
</ul>
</div>

<p>Success!</p>
<p>Note the last line of output:</p>
<pre><code class="remark-code"><div class="remark-code-line">serving insecure client requests on 127.0.0.1:2379, this is strongly discouraged!</div></code></pre><p><em>Sure, that's discouraged. But thanks for telling us the address!</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">717 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-api-server-for-real-">Starting API server (for real)</h2>
<ul>
<li><p>Try again, passing the <code class="remark-inline-code">--etcd-servers</code> argument</p>
</li>
<li><p>That argument should be a comma-separated list of URLs</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Start API server:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kube-apiserver --etcd-servers http://127.0.0.1:2379</div></code></pre>
</li>
</ul>
</div>

<p>Success!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">718 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="interacting-with-api-server">Interacting with API server</h2>
<ul>
<li>Let's try a few "classic" commands</li>
</ul>
<div class="exercise"><ul>
<li><p>List nodes:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes</div></code></pre>
</li>
<li><p>List services:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get services</div></code></pre>
</li>
</ul>
</div>

<p>So far, so good.</p>
<p>Note: the API server automatically created the <code class="remark-inline-code">kubernetes</code> service entry.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">719 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="what-about-kubeconfig-">What about <code class="remark-inline-code">kubeconfig</code>?</h2>
<ul>
<li><p>We didn't need to create a <code class="remark-inline-code">kubeconfig</code> file</p>
</li>
<li><p>By default, the API server is listening on <code class="remark-inline-code">localhost:8080</code></p>
<p>(without requiring authentication)</p>
</li>
<li><p>By default, <code class="remark-inline-code">kubectl</code> connects to <code class="remark-inline-code">localhost:8080</code></p>
<p>(without providing authentication)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">720 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-a-deployment">Creating a Deployment</h2>
<ul>
<li>Let's run a web server!</li>
</ul>
<div class="exercise"><ul>
<li>Create a Deployment with NGINX:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment web --image=nginx</div></code></pre>
</li>
</ul>
</div>

<p>Success?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">721 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-our-deployment-status">Checking our Deployment status</h2>
<div class="exercise"><ul>
<li>Look at pods, deployments, etc.:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>Our Deployment is in a bad shape:</p>
<pre><code class="remark-code"><div class="remark-code-line">NAME                  READY   UP-TO-DATE   AVAILABLE   AGE</div><div class="remark-code-line">deployment.apps/web   0/1     0            0           2m26s</div></code></pre><p>And, there is no ReplicaSet, and no Pod.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">722 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-going-on-">What's going on?</h2>
<ul>
<li><p>We stored the definition of our Deployment in etcd</p>
<p>(through the API server)</p>
</li>
<li><p>But there is no <em>controller</em> to do the rest of the work</p>
</li>
<li><p>We need to start the <em>controller manager</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">723 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-the-controller-manager">Starting the controller manager</h2>
<div class="exercise"><ul>
<li>Try to start the controller manager:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kube-controller-manager</div></code></pre>
</li>
</ul>
</div>

<p>The final error message is:</p>
<pre><code class="remark-code"><div class="remark-code-line">invalid configuration: no configuration has been provided</div></code></pre><p>But the logs include another useful piece of information:</p>
<pre><code class="remark-code"><div class="remark-code-line">Neither --kubeconfig nor --master was specified.</div><div class="remark-code-line">Using the inClusterConfig.  This might not work.</div></code></pre><p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">724 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="reminder-everyone-talks-to-api-server">Reminder: everyone talks to API server</h2>
<ul>
<li><p>The controller manager needs to connect to the API server</p>
</li>
<li><p>It <em>does not</em> have a convenient <code class="remark-inline-code">localhost:8080</code> default</p>
</li>
<li><p>We can pass the connection information in two ways:</p>
<ul>
<li><p><code class="remark-inline-code">--master</code> and a host:port combination (easy)</p>
</li>
<li><p><code class="remark-inline-code">--kubeconfig</code> and a <code class="remark-inline-code">kubeconfig</code> file</p>
</li>
</ul>
</li>
<li><p>For simplicity, we'll use the first option</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">725 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-the-controller-manager-for-real-">Starting the controller manager (for real)</h2>
<div class="exercise"><ul>
<li>Start the controller manager:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kube-controller-manager --master http://localhost:8080</div></code></pre>
</li>
</ul>
</div>

<p>Success!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">726 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-our-deployment-status">Checking our Deployment status</h2>
<div class="exercise"><ul>
<li>Check all our resources again:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>We now have a ReplicaSet.</p>
<p>But we still don't have a Pod.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">727 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-going-on-">What's going on?</h2>
<p>In the controller manager logs, we should see something like this:</p>
<pre><code class="remark-code"><div class="remark-code-line">E0404 15:46:25.753376   22847 replica_set.go:450] Sync "default/web-5bc9bd5b8d"</div><div class="remark-code-line">failed with <span class="remark-code-span-highlighted">No API token found for service account "default"</span>, retry after the</div><div class="remark-code-line">token is automatically created and added to the service account</div></code></pre><ul>
<li><p>The service account <code class="remark-inline-code">default</code> was automatically added to our Deployment</p>
<p>(and to its pods)</p>
</li>
<li><p>The service account <code class="remark-inline-code">default</code> exists</p>
</li>
<li><p>But it doesn't have an associated token</p>
<p>(the token is a secret; creating it requires signature; therefore a CA)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">728 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="solving-the-missing-token-issue">Solving the missing token issue</h2>
<p>There are many ways to solve that issue.</p>
<p>We are going to list a few (to get an idea of what's happening behind the scenes).</p>
<p>Of course, we don't need to perform <em>all</em> the solutions mentioned here.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">729 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-1-disable-service-accounts">Option 1: disable service accounts</h2>
<ul>
<li><p>Restart the API server with
<code class="remark-inline-code">--disable-admission-plugins=ServiceAccount</code></p>
</li>
<li><p>The API server will no longer add a service account automatically</p>
</li>
<li><p>Our pods will be created without a service account</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">730 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-2-do-not-mount-the-missing-token">Option 2: do not mount the (missing) token</h2>
<ul>
<li><p>Add <code class="remark-inline-code">automountServiceAccountToken: false</code> to the Deployment spec</p>
<p><em>or</em></p>
</li>
<li><p>Add <code class="remark-inline-code">automountServiceAccountToken: false</code> to the default ServiceAccount</p>
</li>
<li><p>The ReplicaSet controller will no longer create pods referencing the (missing) token</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Programmatically change the <code class="remark-inline-code">default</code> ServiceAccount:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl patch sa default -p <span class="hljs-string">"automountServiceAccountToken: false"</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">731 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-3-set-up-service-accounts-properly">Option 3: set up service accounts properly</h2>
<ul>
<li><p>This is the most complex option!</p>
</li>
<li><p>Generate a key pair</p>
</li>
<li><p>Pass the private key to the controller manager</p>
<p>(to generate and sign tokens)</p>
</li>
<li><p>Pass the public key to the API server</p>
<p>(to verify these tokens)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">732 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="continuing-without-service-account-token">Continuing without service account token</h2>
<ul>
<li>Once we patch the default service account, the ReplicaSet can create a Pod</li>
</ul>
<div class="exercise"><ul>
<li>Check that we now have a pod:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>Note: we might have to wait a bit for the ReplicaSet controller to retry.</p>
<p>If we're impatient, we can restart the controller manager.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">733 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-next-">What's next?</h2>
<ul>
<li><p>Our pod exists, but it is in <code class="remark-inline-code">Pending</code> state</p>
</li>
<li><p>Remember, we don't have a node so far</p>
<p>(<code class="remark-inline-code">kubectl get nodes</code> shows an empty list)</p>
</li>
<li><p>We need to:</p>
<ul>
<li><p>start a container engine</p>
</li>
<li><p>start kubelet</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">734 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-a-container-engine">Starting a container engine</h2>
<ul>
<li>We're going to use Docker (because it's the default option)</li>
</ul>
<div class="exercise"><ul>
<li>Start the Docker Engine:<pre><code class="bash hljs remark-code"><div class="remark-code-line">dockerd</div></code></pre>
</li>
</ul>
</div>

<p>Success!</p>
<p>Feel free to check that it actually works with e.g.:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker run alpine <span class="hljs-built_in">echo</span> hello world</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">735 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-kubelet">Starting kubelet</h2>
<ul>
<li><p>If we start kubelet without arguments, it <em>will</em> start</p>
</li>
<li><p>But it will not join the cluster!</p>
</li>
<li><p>It will start in <em>standalone</em> mode</p>
</li>
<li><p>Just like with the controller manager, we need to tell kubelet where the API server is</p>
</li>
<li><p>Alas, kubelet doesn't have a simple <code class="remark-inline-code">--master</code> option</p>
</li>
<li><p>We have to use <code class="remark-inline-code">--kubeconfig</code></p>
</li>
<li><p>We need to write a <code class="remark-inline-code">kubeconfig</code> file for kubelet</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">736 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="writing-a-kubeconfig-file">Writing a kubeconfig file</h2>
<ul>
<li><p>We can copy/paste a bunch of YAML</p>
</li>
<li><p>Or we can generate the file with <code class="remark-inline-code">kubectl</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Create the file <code class="remark-inline-code">kubeconfig.kubelet</code> with <code class="remark-inline-code">kubectl</code>:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --kubeconfig kubeconfig.kubelet config \</div><div class="remark-code-line">        <span class="hljs-built_in">set</span>-cluster localhost --server http://localhost:8080</div><div class="remark-code-line">kubectl --kubeconfig kubeconfig.kubelet config \</div><div class="remark-code-line">        <span class="hljs-built_in">set</span>-context localhost --cluster localhost</div><div class="remark-code-line">kubectl --kubeconfig kubeconfig.kubelet config \</div><div class="remark-code-line">        use-context localhost</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">737 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="all-kubernetes-clients-can-use-kubeconfig-">All Kubernetes clients can use <code class="remark-inline-code">kubeconfig</code></h2>
<ul>
<li><p>The <code class="remark-inline-code">kubeconfig.kubelet</code> file has the same format as e.g. <code class="remark-inline-code">~/.kubeconfig</code></p>
</li>
<li><p>All Kubernetes clients can use a similar file</p>
</li>
<li><p>The <code class="remark-inline-code">kubectl config</code> commands can be used to manipulate these files</p>
</li>
<li><p>This highlights that kubelet is a "normal" client of the API server</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">738 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-kubeconfig-kubelet-file">Our <code class="remark-inline-code">kubeconfig.kubelet</code> file</h2>
<p>The file that we generated looks like the one below.</p>
<p>That one has been slightly simplified (removing extraneous fields), but it is still valid.</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Config</div><div class="remark-code-line"><span class="hljs-attr">current-context:</span> localhost</div><div class="remark-code-line"><span class="hljs-attr">contexts:</span></div><div class="remark-code-line"><span class="hljs-attr">- name:</span> localhost</div><div class="remark-code-line"><span class="hljs-attr">  context:</span></div><div class="remark-code-line"><span class="hljs-attr">    cluster:</span> localhost</div><div class="remark-code-line"><span class="hljs-attr">clusters:</span></div><div class="remark-code-line"><span class="hljs-attr">- name:</span> localhost</div><div class="remark-code-line"><span class="hljs-attr">  cluster:</span></div><div class="remark-code-line"><span class="hljs-attr">    server:</span> http://localhost:<span class="hljs-number">8080</span></div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">739 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-kubelet">Starting kubelet</h2>
<div class="exercise"><ul>
<li>Start kubelet with that <code class="remark-inline-code">kubeconfig.kubelet</code> file:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubelet --kubeconfig kubeconfig.kubelet</div></code></pre>
</li>
</ul>
</div>

<p>Success!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">740 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="looking-at-our-1-node-cluster">Looking at our 1-node cluster</h2>
<ul>
<li>Let's check that our node registered correctly</li>
</ul>
<div class="exercise"><ul>
<li>List the nodes in our cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes</div></code></pre>
</li>
</ul>
</div>

<p>Our node should show up.</p>
<p>Its name will be its hostname (it should be <code class="remark-inline-code">dmuc1</code>).</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">741 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="are-we-there-yet-">Are we there yet?</h2>
<ul>
<li>Let's check if our pod is running</li>
</ul>
<div class="exercise"><ul>
<li>List all resources:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">742 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="are-we-there-yet-">Are we there yet?</h2>
<ul>
<li>Let's check if our pod is running</li>
</ul>
<div class="exercise"><ul>
<li>List all resources:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>Our pod is still <code class="remark-inline-code">Pending</code>. 🤔</p><div class="remark-slide-number">743 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="are-we-there-yet-">Are we there yet?</h2>
<ul>
<li>Let's check if our pod is running</li>
</ul>
<div class="exercise"><ul>
<li>List all resources:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>Our pod is still <code class="remark-inline-code">Pending</code>. 🤔</p>
<p>Which is normal: it needs to be <em>scheduled</em>.</p>
<p>(i.e., something needs to decide which node it should go on.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">744 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="scheduling-our-pod">Scheduling our pod</h2>
<ul>
<li><p>Why do we need a scheduling decision, since we have only one node?</p>
</li>
<li><p>The node might be full, unavailable; the pod might have constraints ...</p>
</li>
<li><p>The easiest way to schedule our pod is to start the scheduler</p>
<p>(we could also schedule it manually)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">745 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-the-scheduler">Starting the scheduler</h2>
<ul>
<li><p>The scheduler also needs to know how to connect to the API server</p>
</li>
<li><p>Just like for controller manager, we can use <code class="remark-inline-code">--kubeconfig</code> or <code class="remark-inline-code">--master</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Start the scheduler:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kube-scheduler --master http://localhost:8080</div></code></pre>
</li>
</ul>
</div>

<ul>
<li>Our pod should now start correctly</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">746 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-the-status-of-our-pod">Checking the status of our pod</h2>
<ul>
<li><p>Our pod will go through a short <code class="remark-inline-code">ContainerCreating</code> phase</p>
</li>
<li><p>Then it will be <code class="remark-inline-code">Running</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check pod status:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
</li>
</ul>
</div>

<p>Success!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">747 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="scheduling-a-pod-manually">Scheduling a pod manually</h2>
<ul>
<li><p>We can schedule a pod in <code class="remark-inline-code">Pending</code> state by creating a Binding, e.g.:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span>- &lt;&lt;EOF</div><div class="remark-code-line">apiVersion: v1</div><div class="remark-code-line">kind: Binding</div><div class="remark-code-line">metadata:</div><div class="remark-code-line">  name: name-of-the-pod</div><div class="remark-code-line">target:</div><div class="remark-code-line">  apiVersion: v1</div><div class="remark-code-line">  kind: Node</div><div class="remark-code-line">  name: name-of-the-node</div><div class="remark-code-line">EOF</div></code></pre>
</li>
<li><p>This is actually how the scheduler works!</p>
</li>
<li><p>It watches pods, makes scheduling decisions, and creates Binding objects</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">748 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="connecting-to-our-pod">Connecting to our pod</h2>
<ul>
<li>Let's check that our pod correctly runs NGINX</li>
</ul>
<div class="exercise"><ul>
<li><p>Check our pod's IP address:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide</div></code></pre>
</li>
<li><p>Send some HTTP request to the pod:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="remark-code-span-highlighted">X.X.X.X</span></div></code></pre>
</li>
</ul>
</div>

<p>We should see the <code class="remark-inline-code">Welcome to nginx!</code> page.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">749 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="exposing-our-deployment">Exposing our Deployment</h2>
<ul>
<li>We can now create a Service associated with this Deployment</li>
</ul>
<div class="exercise"><ul>
<li><p>Expose the Deployment's port 80:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment web --port=80</div></code></pre>
</li>
<li><p>Check the Service's ClusterIP, and try connecting:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get service web</div><div class="remark-code-line">curl http://<span class="remark-code-span-highlighted">X.X.X.X</span></div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">750 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="exposing-our-deployment">Exposing our Deployment</h2>
<ul>
<li>We can now create a Service associated with this Deployment</li>
</ul>
<div class="exercise"><ul>
<li><p>Expose the Deployment's port 80:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment web --port=80</div></code></pre>
</li>
<li><p>Check the Service's ClusterIP, and try connecting:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get service web</div><div class="remark-code-line">curl http://<span class="remark-code-span-highlighted">X.X.X.X</span></div></code></pre>
</li>
</ul>
</div>

<p>This won't work. We need kube-proxy to enable internal communication.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">751 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-kube-proxy">Starting kube-proxy</h2>
<ul>
<li><p>kube-proxy also needs to connect to the API server</p>
</li>
<li><p>It can work with the <code class="remark-inline-code">--master</code> flag</p>
<p>(although that will be deprecated in the future)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Start kube-proxy:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kube-proxy --master http://localhost:8080</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">752 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="connecting-to-our-service">Connecting to our Service</h2>
<ul>
<li>Now that kube-proxy is running, we should be able to connect</li>
</ul>
<div class="exercise"><ul>
<li>Check the Service's ClusterIP again, and retry connecting:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get service web</div><div class="remark-code-line">curl http://<span class="remark-code-span-highlighted">X.X.X.X</span></div></code></pre>
</li>
</ul>
</div>

<p>Success!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">753 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="how-kube-proxy-works">How kube-proxy works</h2>
<ul>
<li><p>kube-proxy watches Service resources</p>
</li>
<li><p>When a Service is created or updated, kube-proxy creates iptables rules</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Check out the <code class="remark-inline-code">OUTPUT</code> chain in the <code class="remark-inline-code">nat</code> table:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">iptables -t nat -L OUTPUT</div></code></pre>
</li>
<li><p>Traffic is sent to <code class="remark-inline-code">KUBE-SERVICES</code>; check that too:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">iptables -t nat -L KUBE-SERVICES</div></code></pre>
</li>
</ul>
</div>

<p>For each Service, there is an entry in that chain.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">754 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="diving-into-iptables">Diving into iptables</h2>
<ul>
<li>The last command showed a chain named <code class="remark-inline-code">KUBE-SVC-...</code> corresponding to our service</li>
</ul>
<div class="exercise"><ul>
<li><p>Check that <code class="remark-inline-code">KUBE-SVC-...</code> chain:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">iptables -t nat -L <span class="remark-code-span-highlighted">KUBE-SVC-...</span></div></code></pre>
</li>
<li><p>It should show a jump to a <code class="remark-inline-code">KUBE-SEP-...</code> chains; check it out too:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">iptables -t nat -L <span class="remark-code-span-highlighted">KUBE-SEP-...</span></div></code></pre>
</li>
</ul>
</div>

<p>This is a <code class="remark-inline-code">DNAT</code> rule to rewrite the destination address of the connection to our pod.</p>
<p>This is how kube-proxy works!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">755 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="kube-router-ipvs">kube-router, IPVS</h2>
<ul>
<li><p>With recent versions of Kubernetes, it is possible to tell kube-proxy to use IPVS</p>
</li>
<li><p>IPVS is a more powerful load balancing framework</p>
<p>(remember: iptables was primarily designed for firewalling, not load balancing!)</p>
</li>
<li><p>It is also possible to replace kube-proxy with kube-router</p>
</li>
<li><p>kube-router uses IPVS by default</p>
</li>
<li><p>kube-router can also perform other functions</p>
<p>(e.g., we can use it as a CNI plugin to provide pod connectivity)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">756 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="what-about-the-kubernetes-service-">What about the <code class="remark-inline-code">kubernetes</code> service?</h2>
<ul>
<li><p>If we try to connect, it won't work</p>
<p>(by default, it should be <code class="remark-inline-code">10.0.0.1</code>)</p>
</li>
<li><p>If we look at the Endpoints for this service, we will see one endpoint:</p>
<p><code class="remark-inline-code">host-address:6443</code></p>
</li>
<li><p>By default, the API server expects to be running directly on the nodes</p>
<p>(it could be as a bare process, or in a container/pod using the host network)</p>
</li>
<li><p>... And it expects to be listening on port 6443 with TLS</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/dmuc.md">k8s/dmuc.md</a></span></p><div class="remark-slide-number">757 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/two-containers-on-a-truck.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">758 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-adding-nodes-to-the-cluster" class="remark-slide-content title hljs-default"><p>Adding nodes to the cluster</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-building-our-own-cluster">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-10">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-the-container-network-interface">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">759 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="adding-nodes-to-the-cluster">Adding nodes to the cluster</h1>
<ul>
<li><p>So far, our cluster has only 1 node</p>
</li>
<li><p>Let's see what it takes to add more nodes</p>
</li>
<li><p>We are going to use another set of machines: <code class="remark-inline-code">kubenet</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">760 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-environment">The environment</h2>
<ul>
<li><p>We have 3 identical machines: <code class="remark-inline-code">kubenet1</code>, <code class="remark-inline-code">kubenet2</code>, <code class="remark-inline-code">kubenet3</code></p>
</li>
<li><p>The Docker Engine is installed (and running) on these machines</p>
</li>
<li><p>The Kubernetes packages are installed, but nothing is running</p>
</li>
<li><p>We will use <code class="remark-inline-code">kubenet1</code> to run the control plane</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">761 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-plan">The plan</h2>
<ul>
<li><p>Start the control plane on <code class="remark-inline-code">kubenet1</code></p>
</li>
<li><p>Join the 3 nodes to the cluster</p>
</li>
<li><p>Deploy and scale a simple web server</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Log into <code class="remark-inline-code">kubenet1</code></li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">762 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-the-control-plane">Running the control plane</h2>
<ul>
<li>We will use a Compose file to start the control plane components</li>
</ul>
<div class="exercise"><ul>
<li><p>Clone the repository containing the workshop materials:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">git <span class="hljs-built_in">clone</span> https://github.com/jpetazzo/container.training</div></code></pre>
</li>
<li><p>Go to the <code class="remark-inline-code">compose/simple-k8s-control-plane</code> directory:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">cd</span> container.training/compose/simple-k8s-control-plane</div></code></pre>
</li>
<li><p>Start the control plane:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker-compose up</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">763 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-the-control-plane-status">Checking the control plane status</h2>
<ul>
<li>Before moving on, verify that the control plane works</li>
</ul>
<div class="exercise"><ul>
<li><p>Show control plane component statuses:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get componentstatuses</div><div class="remark-code-line">kubectl get cs</div></code></pre>
</li>
<li><p>Show the (empty) list of nodes:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">764 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="differences-from-dmuc-">Differences from <code class="remark-inline-code">dmuc</code></h2>
<ul>
<li><p>Our new control plane listens on <code class="remark-inline-code">0.0.0.0</code> instead of the default <code class="remark-inline-code">127.0.0.1</code></p>
</li>
<li><p>The ServiceAccount admission plugin is disabled</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">765 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="joining-the-nodes">Joining the nodes</h2>
<ul>
<li><p>We need to generate a <code class="remark-inline-code">kubeconfig</code> file for kubelet</p>
</li>
<li><p>This time, we need to put the IP address of <code class="remark-inline-code">kubenet1</code></p>
<p>(instead of <code class="remark-inline-code">localhost</code> or <code class="remark-inline-code">127.0.0.1</code>)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Generate the <code class="remark-inline-code">kubeconfig</code> file:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --kubeconfig ~/kubeconfig config \</div><div class="remark-code-line">        <span class="hljs-built_in">set</span>-cluster kubenet --server http://<span class="remark-code-span-highlighted">X.X.X.X</span>:8080</div><div class="remark-code-line">kubectl --kubeconfig ~/kubeconfig config \</div><div class="remark-code-line">        <span class="hljs-built_in">set</span>-context kubenet --cluster kubenet</div><div class="remark-code-line">kubectl --kubeconfig ~/kubeconfig config\</div><div class="remark-code-line">        use-context kubenet</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">766 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="distributing-the-kubeconfig-file">Distributing the <code class="remark-inline-code">kubeconfig</code> file</h2>
<ul>
<li>We need that <code class="remark-inline-code">kubeconfig</code> file on the other nodes, too</li>
</ul>
<div class="exercise"><ul>
<li>Copy <code class="remark-inline-code">kubeconfig</code> to the other nodes:<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-keyword">for</span> N <span class="hljs-keyword">in</span> 2 3; <span class="hljs-keyword">do</span></div><div class="remark-code-line">    scp ~/kubeconfig kubenet<span class="hljs-variable">$N</span>:</div><div class="remark-code-line"><span class="hljs-keyword">done</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">767 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-kubelet">Starting kubelet</h2>
<ul>
<li>Reminder: kubelet needs to run as root; don't forget <code class="remark-inline-code">sudo</code>!</li>
</ul>
<div class="exercise"><ul>
<li><p>Join the first node:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo kubelet --kubeconfig ~/kubeconfig</div></code></pre>
</li>
<li><p>Open more terminals and join the other nodes to the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ssh kubenet2 sudo kubelet --kubeconfig ~/kubeconfig</div><div class="remark-code-line">ssh kubenet3 sudo kubelet --kubeconfig ~/kubeconfig</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">768 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-cluster-status">Checking cluster status</h2>
<ul>
<li><p>We should now see all 3 nodes</p>
</li>
<li><p>At first, their <code class="remark-inline-code">STATUS</code> will be <code class="remark-inline-code">NotReady</code></p>
</li>
<li><p>They will move to <code class="remark-inline-code">Ready</code> state after approximately 10 seconds</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check the list of nodes:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">769 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploy-a-web-server">Deploy a web server</h2>
<ul>
<li><p>Let's create a Deployment and scale it</p>
<p>(so that we have multiple pods on multiple nodes)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a Deployment running NGINX:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment web --image=nginx</div></code></pre>
</li>
<li><p>Scale it:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment web --replicas=5</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">770 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="check-our-pods">Check our pods</h2>
<ul>
<li><p>The pods will be scheduled to the nodes</p>
</li>
<li><p>The nodes will pull the <code class="remark-inline-code">nginx</code> image, and start the pods</p>
</li>
<li><p>What are the IP addresses of our pods?</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check the IP addresses of our pods<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide</div></code></pre>
</li>
</ul>
</div><div class="remark-slide-number">771 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="check-our-pods">Check our pods</h2>
<ul>
<li><p>The pods will be scheduled to the nodes</p>
</li>
<li><p>The nodes will pull the <code class="remark-inline-code">nginx</code> image, and start the pods</p>
</li>
<li><p>What are the IP addresses of our pods?</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check the IP addresses of our pods<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide</div></code></pre>
</li>
</ul>
</div>

<p>🤔 Something's not right ... Some pods have the same IP address!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">772 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-going-on-">What's going on?</h2>
<ul>
<li><p>On a normal cluster, kubelet is configured to set up pod networking with CNI plugins</p>
</li>
<li><p>This requires:</p>
<ul>
<li><p>installing CNI plugins</p>
</li>
<li><p>writing CNI configuration files</p>
</li>
<li><p>running kubelet with <code class="remark-inline-code">--network-plugin=cni</code></p>
</li>
</ul>
</li>
<li><p>Without the <code class="remark-inline-code">--network-plugin</code> flag, kubelet defaults to "no-op" networking</p>
</li>
<li><p>It lets the container engine use a default network</p>
<p>(in that case, we end up with the default Docker bridge)</p>
</li>
<li><p>Our pods are running on independent, disconnected, host-local networks</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">773 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-network-plugins">Using network plugins</h2>
<ul>
<li><p>We need to set up a better network</p>
</li>
<li><p>Before diving into CNI, we will use the <code class="remark-inline-code">kubenet</code> plugin</p>
</li>
<li><p>This plugin creates a <code class="remark-inline-code">cbr0</code> bridge and connects the containers to that bridge</p>
</li>
<li><p>This plugin allocates IP addresses from a range:</p>
<ul>
<li><p>either specified to kubelet (e.g. with <code class="remark-inline-code">--pod-cidr</code>)</p>
</li>
<li><p>or stored in the node's <code class="remark-inline-code">spec.podCIDR</code> field</p>
</li>
</ul>
</li>
</ul>
<p><span class="footnote">See <a href="https://github.com/containernetworking/plugins/tree/master/plugins">here</a> for more details about this <code class="remark-inline-code">kubenet</code> plugin.</span>
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">774 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-kubenet-does-and-does-not-do">What <code class="remark-inline-code">kubenet</code> does and <em>does not</em> do</h2>
<ul>
<li><p>It allocates IP addresses to pods <em>locally</em></p>
<p>(each node has its own local subnet)</p>
</li>
<li><p>It connects the pods to a <em>local</em> bridge</p>
<p>(pods on the same node can communicate together; not with other nodes)</p>
</li>
<li><p>It doesn't set up routing or tunneling</p>
<p>(we get pods on separated networks; we need to connect them somehow)</p>
</li>
<li><p>It doesn't allocate subnets to nodes</p>
<p>(this can be done manually, or by the controller manager) </p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">775 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-routing-or-tunneling">Setting up routing or tunneling</h2>
<ul>
<li><p><em>On each node</em>, we will add routes to the other nodes' pod network</p>
</li>
<li><p>Of course, this is not convenient or scalable!</p>
</li>
<li><p>We will see better techniques to do this; but for now, hang on!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">776 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="allocating-subnets-to-nodes">Allocating subnets to nodes</h2>
<ul>
<li><p>There are multiple options:</p>
<ul>
<li><p>passing the subnet to kubelet with the <code class="remark-inline-code">--pod-cidr</code> flag</p>
</li>
<li><p>manually setting <code class="remark-inline-code">spec.podCIDR</code> on each node</p>
</li>
<li><p>allocating node CIDRs automatically with the controller manager</p>
</li>
</ul>
</li>
<li><p>The last option would be implemented by adding these flags to controller manager:</p>
<pre><code class="remark-code"><div class="remark-code-line">--allocate-node-cidrs=true --cluster-cidr=&lt;cidr&gt;</div></code></pre></li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">777 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="the-pod-cidr-field-is-not-mandatory">The pod CIDR field is not mandatory</h2>
<ul>
<li><p><code class="remark-inline-code">kubenet</code> needs the pod CIDR, but other plugins don't need it</p>
<p>(e.g. because they allocate addresses in multiple pools, or a single big one)</p>
</li>
<li><p>The pod CIDR field may eventually be deprecated and replaced by an annotation</p>
<p>(see <a href="https://github.com/kubernetes/kubernetes/issues/57130">kubernetes/kubernetes#57130</a>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">778 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="restarting-kubelet-wih-pod-cidr">Restarting kubelet wih pod CIDR</h2>
<ul>
<li><p>We need to stop and restart all our kubelets</p>
</li>
<li><p>We will add the <code class="remark-inline-code">--network-plugin</code> and <code class="remark-inline-code">--pod-cidr</code> flags</p>
</li>
<li><p>We all have a "cluster number" (let's call that <code class="remark-inline-code">C</code>)</p>
</li>
<li><p>We will use pod CIDR <code class="remark-inline-code">10.C.N.0/24</code> (where <code class="remark-inline-code">N</code> is the node number: 1, 2, 3)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Stop all the kubelets (Ctrl-C is fine)</p>
</li>
<li><p>Restart them all, adding <code class="remark-inline-code">--network-plugin=kubenet --pod-cidr 10.C.N.0/24</code></p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">779 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-happens-to-our-pods-">What happens to our pods?</h2>
<ul>
<li><p>When we stop (or kill) kubelet, the containers keep running</p>
</li>
<li><p>When kubelet starts again, it detects the containers</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check that our pods are still here:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide</div></code></pre>
</li>
</ul>
</div>

<p>🤔 But our pods still use local IP addresses!</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">780 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="recreating-the-pods">Recreating the pods</h2>
<ul>
<li><p>The IP address of a pod cannot change</p>
</li>
<li><p>kubelet doesn't automatically kill/restart containers with "invalid" addresses
<br>
(in fact, from kubelet's point of view, there is no such thing as an "invalid" address)</p>
</li>
<li><p>We must delete our pods and recreate them</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Delete all the pods, and let the ReplicaSet recreate them:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl delete pods --all</div></code></pre>
</li>
<li><p>Wait for the pods to be up again:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide -w</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">781 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-kube-proxy">Adding kube-proxy</h2>
<ul>
<li><p>Let's start kube-proxy to provide internal load balancing</p>
</li>
<li><p>Then see if we can create a Service and use it to contact our pods</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Start kube-proxy:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo kube-proxy --kubeconfig ~/kubeconfig</div></code></pre>
</li>
<li><p>Expose our Deployment:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment web --port=80</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">782 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="test-internal-load-balancing">Test internal load balancing</h2>
<div class="exercise"><ul>
<li><p>Retrieve the ClusterIP address:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc web</div></code></pre>
</li>
<li><p>Send a few requests to the ClusterIP address (with <code class="remark-inline-code">curl</code>)</p>
</li>
</ul>
</div><div class="remark-slide-number">783 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="test-internal-load-balancing">Test internal load balancing</h2>
<div class="exercise"><ul>
<li><p>Retrieve the ClusterIP address:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc web</div></code></pre>
</li>
<li><p>Send a few requests to the ClusterIP address (with <code class="remark-inline-code">curl</code>)</p>
</li>
</ul>
</div>

<p>Sometimes it works, sometimes it doesn't. Why?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">784 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="routing-traffic">Routing traffic</h2>
<ul>
<li><p>Our pods have new, distinct IP addresses</p>
</li>
<li><p>But they are on host-local, isolated networks</p>
</li>
<li><p>If we try to ping a pod on a different node, it won't work</p>
</li>
<li><p>kube-proxy merely rewrites the destination IP address</p>
</li>
<li><p>But we need that IP address to be reachable in the first place</p>
</li>
<li><p>How do we fix this?</p>
<p>(hint: check the title of this slide!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">785 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="important-warning">Important warning</h2>
<ul>
<li><p>The technique that we are about to use doesn't work everywhere</p>
</li>
<li><p>It only works if:</p>
<ul>
<li><p>all the nodes are directly connected to each other (at layer 2)</p>
</li>
<li><p>the underlying network allows the IP addresses of our pods</p>
</li>
</ul>
</li>
<li><p>If we are on physical machines connected by a switch: OK</p>
</li>
<li><p>If we are on virtual machines in a public cloud: NOT OK</p>
<ul>
<li><p>on AWS, we need to disable "source and destination checks" on our instances</p>
</li>
<li><p>on OpenStack, we need to disable "port security" on our network ports</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">786 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="routing-basics">Routing basics</h2>
<ul>
<li><p>We need to tell <em>each</em> node:</p>
<p>"The subnet 10.C.N.0/24 is located on node N" (for all values of N)</p>
</li>
<li><p>This is how we add a route on Linux:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ip route add 10.C.N.0/24 via W.X.Y.Z</div></code></pre>
<p>(where <code class="remark-inline-code">W.X.Y.Z</code> is the internal IP address of node N)</p>
</li>
<li><p>We can see the internal IP addresses of our nodes with:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes -o wide</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p>
</li>
</ul><div class="remark-slide-number">787 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-routing">Setting up routing</h2>
<div class="exercise"><ul>
<li><p>Create all the routes on all the nodes</p>
</li>
<li><p>Check that you can ping all the pods from one of the nodes</p>
</li>
<li><p>Check that you can <code class="remark-inline-code">curl</code> the ClusterIP of the Service successfully</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">788 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-next-">What's next?</h2>
<ul>
<li><p>We did a lot of manual operations:</p>
<ul>
<li><p>allocating subnets to nodes</p>
</li>
<li><p>adding command-line flags to kubelet</p>
</li>
<li><p>updating the routing tables on our nodes</p>
</li>
</ul>
</li>
<li><p>We want to automate all these steps</p>
</li>
<li><p>We want something that works on all networks</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/multinode.md">k8s/multinode.md</a></span></p><div class="remark-slide-number">789 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/wall-of-containers.jpeg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">790 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-the-container-network-interface" class="remark-slide-content title hljs-default"><p>The Container Network Interface</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-adding-nodes-to-the-cluster">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-10">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-interconnecting-clusters">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">791 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="the-container-network-interface">The Container Network Interface</h1>
<ul>
<li><p>Allows us to decouple network configuration from Kubernetes</p>
</li>
<li><p>Implemented by <em>plugins</em></p>
</li>
<li><p>Plugins are executables that will be invoked by kubelet</p>
</li>
<li><p>Plugins are responsible for:</p>
<ul>
<li><p>allocating IP addresses for containers</p>
</li>
<li><p>configuring the network for containers</p>
</li>
</ul>
</li>
<li><p>Plugins can be combined and chained when it makes sense</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">792 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="combining-plugins">Combining plugins</h2>
<ul>
<li><p>Interface could be created by e.g. <code class="remark-inline-code">vlan</code> or <code class="remark-inline-code">bridge</code> plugin</p>
</li>
<li><p>IP address could be allocated by e.g. <code class="remark-inline-code">dhcp</code> or <code class="remark-inline-code">host-local</code> plugin</p>
</li>
<li><p>Interface parameters (MTU, sysctls) could be tweaked by the <code class="remark-inline-code">tuning</code> plugin</p>
</li>
</ul>
<p>The reference plugins are available <a href="https://github.com/containernetworking/plugins/tree/master/plugins">here</a>.</p>
<p>Look in each plugin's directory for its documentation.
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">793 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-does-kubelet-know-which-plugins-to-use-">How does kubelet know which plugins to use?</h2>
<ul>
<li><p>The plugin (or list of plugins) is set in the CNI configuration</p>
</li>
<li><p>The CNI configuration is a <em>single file</em> in <code class="remark-inline-code">/etc/cni/net.d</code></p>
</li>
<li><p>If there are multiple files in that directory, the first one is used</p>
<p>(in lexicographic order)</p>
</li>
<li><p>That path can be changed with the <code class="remark-inline-code">--cni-conf-dir</code> flag of kubelet</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">794 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cni-configuration-in-practice">CNI configuration in practice</h2>
<ul>
<li><p>When we set up the "pod network" (like Calico, Weave...) it ships a CNI configuration</p>
<p>(and sometimes, custom CNI plugins)</p>
</li>
<li><p>Very often, that configuration (and plugins) is installed automatically</p>
<p>(by a DaemonSet featuring an initContainer with hostPath volumes)</p>
</li>
<li><p>Examples:</p>
<ul>
<li><p>Calico <a href="https://github.com/projectcalico/calico/blob/1372b56e3bfebe2b9c9cbf8105d6a14764f44159/v2.6/getting-started/kubernetes/installation/hosted/calico.yaml#L25">CNI config</a>
and <a href="https://github.com/projectcalico/calico/blob/1372b56e3bfebe2b9c9cbf8105d6a14764f44159/v2.6/getting-started/kubernetes/installation/hosted/calico.yaml#L219">volume</a></p>
</li>
<li><p>kube-router <a href="https://github.com/cloudnativelabs/kube-router/blob/c2f893f64fd60cf6d2b6d3fee7191266c0fc0fe5/daemonset/generic-kuberouter.yaml#L10">CNI config</a>
and <a href="https://github.com/cloudnativelabs/kube-router/blob/c2f893f64fd60cf6d2b6d3fee7191266c0fc0fe5/daemonset/generic-kuberouter.yaml#L73">volume</a></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">795 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="conf-vs-conflist">Conf vs conflist</h2>
<ul>
<li><p>There are two slightly different configuration formats</p>
</li>
<li><p>Basic configuration format:</p>
<ul>
<li>holds configuration for a single plugin</li>
<li>typically has a <code class="remark-inline-code">.conf</code> name suffix</li>
<li>has a <code class="remark-inline-code">type</code> string field in the top-most structure</li>
<li><a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#example-configurations">examples</a></li>
</ul>
</li>
<li><p>Configuration list format:</p>
<ul>
<li>can hold configuration for multiple (chained) plugins</li>
<li>typically has a <code class="remark-inline-code">.conflist</code> name suffix</li>
<li>has a <code class="remark-inline-code">plugins</code> list field in the top-most structure</li>
<li><a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration-lists">examples</a></li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">796 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="how-plugins-are-invoked">How plugins are invoked</h2>
<ul>
<li><p>Parameters are given through environment variables, including:</p>
<ul>
<li><p>CNI_COMMAND: desired operation (ADD, DEL, CHECK, or VERSION)</p>
</li>
<li><p>CNI_CONTAINERID: container ID</p>
</li>
<li><p>CNI_NETNS: path to network namespace file</p>
</li>
<li><p>CNI_IFNAME: what the network interface should be named</p>
</li>
</ul>
</li>
<li><p>The network configuration must be provided to the plugin on stdin</p>
<p>(this avoids race conditions that could happen by passing a file path)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">797 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-practice-kube-router">In practice: kube-router</h2>
<ul>
<li><p>We are going to set up a new cluster</p>
</li>
<li><p>For this new cluster, we will use kube-router</p>
</li>
<li><p>kube-router will provide the "pod network"</p>
<p>(connectivity with pods)</p>
</li>
<li><p>kube-router will also provide internal service connectivity</p>
<p>(replacing kube-proxy)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">798 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-kube-router-works">How kube-router works</h2>
<ul>
<li><p>Very simple architecture</p>
</li>
<li><p>Does not introduce new CNI plugins</p>
<p>(uses the <code class="remark-inline-code">bridge</code> plugin, with <code class="remark-inline-code">host-local</code> for IPAM)</p>
</li>
<li><p>Pod traffic is routed between nodes</p>
<p>(no tunnel, no new protocol)</p>
</li>
<li><p>Internal service connectivity is implemented with IPVS</p>
</li>
<li><p>Can provide pod network and/or internal service connectivity</p>
</li>
<li><p>kube-router daemon runs on every node</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">799 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-kube-router-does">What kube-router does</h2>
<ul>
<li><p>Connect to the API server</p>
</li>
<li><p>Obtain the local node's <code class="remark-inline-code">podCIDR</code></p>
</li>
<li><p>Inject it into the CNI configuration file</p>
<p>(we'll use <code class="remark-inline-code">/etc/cni/net.d/10-kuberouter.conflist</code>)</p>
</li>
<li><p>Obtain the addresses of all nodes</p>
</li>
<li><p>Establish a <em>full mesh</em> BGP peering with the other nodes</p>
</li>
<li><p>Exchange routes over BGP</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">800 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-bgp-">What's BGP?</h2>
<ul>
<li><p>BGP (Border Gateway Protocol) is the protocol used between internet routers</p>
</li>
<li><p>It <a href="https://www.cidr-report.org/as2.0/">scales</a>
pretty <a href="https://www.cidr-report.org/cgi-bin/plota?file=%2fvar%2fdata%2fbgp%2fas2.0%2fbgp-active%2etxt&amp;descr=Active%20BGP%20entries%20%28FIB%29&amp;ylabel=Active%20BGP%20entries%20%28FIB%29&amp;with=step">well</a>
(it is used to announce the 700k CIDR prefixes of the internet)</p>
</li>
<li><p>It is spoken by many hardware routers from many vendors</p>
</li>
<li><p>It also has many software implementations (Quagga, Bird, FRR...)</p>
</li>
<li><p>Experienced network folks generally know it (and appreciate it)</p>
</li>
<li><p>It also used by Calico (another popular network system for Kubernetes)</p>
</li>
<li><p>Using BGP allows us to interconnect our "pod network" with other systems</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">801 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-plan">The plan</h2>
<ul>
<li><p>We'll work in a new cluster (named <code class="remark-inline-code">kuberouter</code>)</p>
</li>
<li><p>We will run a simple control plane (like before)</p>
</li>
<li><p>... But this time, the controller manager will allocate <code class="remark-inline-code">podCIDR</code> subnets</p>
</li>
<li><p>We will start kube-router with a DaemonSet</p>
</li>
<li><p>This DaemonSet will start one instance of kube-router on each node</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">802 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="logging-into-the-new-cluster">Logging into the new cluster</h2>
<div class="exercise"><ul>
<li><p>Log into node <code class="remark-inline-code">kuberouter1</code></p>
</li>
<li><p>Clone the workshop repository:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">git <span class="hljs-built_in">clone</span> https://github.com/jpetazzo/container.training</div></code></pre>
</li>
<li><p>Move to this directory:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">cd</span> container.training/compose/kube-router-k8s-control-plane</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">803 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-control-plane">Our control plane</h2>
<ul>
<li><p>We will use a Compose file to start the control plane</p>
</li>
<li><p>It is similar to the one we used with the <code class="remark-inline-code">kubenet</code> cluster</p>
</li>
<li><p>The API server is started with <code class="remark-inline-code">--allow-privileged</code></p>
<p>(because we will start kube-router in privileged pods)</p>
</li>
<li><p>The controller manager is started with extra flags too:</p>
<p><code class="remark-inline-code">--allocate-node-cidrs</code> and <code class="remark-inline-code">--cluster-cidr</code></p>
</li>
<li><p>We need to edit the Compose file to set the Cluster CIDR</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">804 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-the-control-plane">Starting the control plane</h2>
<ul>
<li><p>Our cluster CIDR will be <code class="remark-inline-code">10.C.0.0/16</code></p>
<p>(where <code class="remark-inline-code">C</code> is our cluster number)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit the Compose file to set the Cluster CIDR:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">vim docker-compose.yaml</div></code></pre>
</li>
<li><p>Start the control plane:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker-compose up</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">805 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-kube-router-daemonset">The kube-router DaemonSet</h2>
<ul>
<li><p>In the same directory, there is a <code class="remark-inline-code">kuberouter.yaml</code> file</p>
</li>
<li><p>It contains the definition for a DaemonSet and a ConfigMap</p>
</li>
<li><p>Before we load it, we also need to edit it</p>
</li>
<li><p>We need to indicate the address of the API server</p>
<p>(because kube-router needs to connect to it to retrieve node information)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">806 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-the-daemonset">Creating the DaemonSet</h2>
<ul>
<li><p>The address of the API server will be <code class="remark-inline-code">http://A.B.C.D:8080</code></p>
<p>(where <code class="remark-inline-code">A.B.C.D</code> is the address of <code class="remark-inline-code">kuberouter1</code>, running the control plane)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit the YAML file to set the API server address:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">vim kuberouter.yaml</div></code></pre>
</li>
<li><p>Create the DaemonSet:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span> kuberouter.yaml</div></code></pre>
</li>
</ul>
</div>

<p>Note: the DaemonSet won't create any pods (yet) since there are no nodes (yet).</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">807 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="generating-the-kubeconfig-for-kubelet">Generating the kubeconfig for kubelet</h2>
<ul>
<li>This is similar to what we did for the <code class="remark-inline-code">kubenet</code> cluster</li>
</ul>
<div class="exercise"><ul>
<li>Generate the kubeconfig file (replacing <code class="remark-inline-code">X.X.X.X</code> with the address of <code class="remark-inline-code">kuberouter1</code>):<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --kubeconfig ~/kubeconfig config \</div><div class="remark-code-line">        <span class="hljs-built_in">set</span>-cluster kubenet --server http://<span class="remark-code-span-highlighted">X.X.X.X</span>:8080</div><div class="remark-code-line">kubectl --kubeconfig ~/kubeconfig config \</div><div class="remark-code-line">        <span class="hljs-built_in">set</span>-context kubenet --cluster kubenet</div><div class="remark-code-line">kubectl --kubeconfig ~/kubeconfig config\</div><div class="remark-code-line">        use-context kubenet</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">808 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="distributing-kubeconfig">Distributing kubeconfig</h2>
<ul>
<li>We need to copy that kubeconfig file to the other nodes</li>
</ul>
<div class="exercise"><ul>
<li>Copy <code class="remark-inline-code">kubeconfig</code> to the other nodes:<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-keyword">for</span> N <span class="hljs-keyword">in</span> 2 3; <span class="hljs-keyword">do</span></div><div class="remark-code-line">    scp ~/kubeconfig kuberouter<span class="hljs-variable">$N</span>:</div><div class="remark-code-line"><span class="hljs-keyword">done</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">809 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-kubelet">Starting kubelet</h2>
<ul>
<li><p>We don't need the <code class="remark-inline-code">--pod-cidr</code> option anymore</p>
<p>(the controller manager will allocate these automatically)</p>
</li>
<li><p>We need to pass <code class="remark-inline-code">--network-plugin=cni</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Join the first node:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo kubelet --kubeconfig ~/kubeconfig --network-plugin=cni</div></code></pre>
</li>
<li><p>Open more terminals and join the other nodes:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ssh kuberouter2 sudo kubelet --kubeconfig ~/kubeconfig --network-plugin=cni</div><div class="remark-code-line">ssh kuberouter3 sudo kubelet --kubeconfig ~/kubeconfig --network-plugin=cni</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">810 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-a-test">Setting up a test</h2>
<ul>
<li>Let's create a Deployment and expose it with a Service</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a Deployment running a web server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment web --image=jpetazzo/httpenv</div></code></pre>
</li>
<li><p>Scale it so that it spans multiple nodes:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl scale deployment web --replicas=5</div></code></pre>
</li>
<li><p>Expose it with a Service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl expose deployment web --port=8888</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">811 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-that-everything-works">Checking that everything works</h2>
<div class="exercise"><ul>
<li><p>Get the ClusterIP address for the service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc web</div></code></pre>
</li>
<li><p>Send a few requests there:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="remark-code-span-highlighted">X.X.X.X</span>:8888</div></code></pre>
</li>
</ul>
</div>

<p>Note that if you send multiple requests, they are load-balanced in a round robin manner.</p>
<p>This shows that we are using IPVS (vs. iptables, which picked random endpoints).</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">812 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li>What if we need to check that everything is working properly?</li>
</ul>
<div class="exercise"><ul>
<li><p>Check the IP addresses of our pods:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide</div></code></pre>
</li>
<li><p>Check our routing table:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">route -n</div><div class="remark-code-line">ip route</div></code></pre>
</li>
</ul>
</div>

<p>We should see the local pod CIDR connected to <code class="remark-inline-code">kube-bridge</code>, and the other nodes' pod CIDRs having individual routes, with each node being the gateway.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">813 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-troubleshooting">More troubleshooting</h2>
<ul>
<li><p>We can also look at the output of the kube-router pods</p>
<p>(with <code class="remark-inline-code">kubectl logs</code>)</p>
</li>
<li><p>kube-router also comes with a special shell that gives lots of useful info</p>
<p>(we can access it with <code class="remark-inline-code">kubectl exec</code>)</p>
</li>
<li><p>But with the current setup of the cluster, these options may not work!</p>
</li>
<li><p>Why?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">814 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="trying-kubectl-logs-kubectl-exec-">Trying <code class="remark-inline-code">kubectl logs</code> / <code class="remark-inline-code">kubectl exec</code></h2>
<div class="exercise"><ul>
<li><p>Try to show the logs of a kube-router pod:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-system logs ds/kube-router</div></code></pre>
</li>
<li><p>Or try to exec into one of the kube-router pods:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -n kube-system <span class="hljs-built_in">exec</span> kuber-router-xxxxx bash</div></code></pre>
</li>
</ul>
</div>

<p>These commands will give an error message that includes:</p>
<pre><code class="remark-code"><div class="remark-code-line">dial tcp: lookup kuberouterX on 127.0.0.11:53: no such host</div></code></pre><p>What does that mean?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">815 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="internal-name-resolution">Internal name resolution</h2>
<ul>
<li><p>To execute these commands, the API server needs to connect to kubelet</p>
</li>
<li><p>By default, it creates a connection using the kubelet's name</p>
<p>(e.g. <code class="remark-inline-code">http://kuberouter1:...</code>)</p>
</li>
<li><p>This requires our nodes names to be in DNS</p>
</li>
<li><p>We can change that by setting a flag on the API server:</p>
<p><code class="remark-inline-code">--kubelet-preferred-address-types=InternalIP</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">816 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="another-way-to-check-the-logs">Another way to check the logs</h2>
<ul>
<li><p>We can also ask the logs directly to the container engine</p>
</li>
<li><p>First, get the container ID, with <code class="remark-inline-code">docker ps</code> or like this:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">CID=$(docker ps</div><div class="remark-code-line">    --filter label=io.kubernetes.pod.namespace=kube-system</div><div class="remark-code-line">    --filter label=io.kubernetes.container.name=kube-router)</div></code></pre>
</li>
<li><p>Then view the logs:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker logs <span class="hljs-variable">$CID</span></div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">817 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="other-ways-to-distribute-routing-tables">Other ways to distribute routing tables</h2>
<ul>
<li><p>We don't need kube-router and BGP to distribute routes</p>
</li>
<li><p>The list of nodes (and associated <code class="remark-inline-code">podCIDR</code> subnets) is available through the API</p>
</li>
<li><p>This shell snippet generates the commands to add all required routes on a node:</p>
</li>
</ul>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">NODES=$(kubectl get nodes -o name | cut <span class="hljs-_">-d</span>/ <span class="hljs-_">-f</span>2)</div><div class="remark-code-line"><span class="hljs-keyword">for</span> DESTNODE <span class="hljs-keyword">in</span> <span class="hljs-variable">$NODES</span>; <span class="hljs-keyword">do</span></div><div class="remark-code-line">  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$DESTNODE</span>"</span> != <span class="hljs-string">"<span class="hljs-variable">$HOSTNAME</span>"</span> ]; <span class="hljs-keyword">then</span></div><div class="remark-code-line">    <span class="hljs-built_in">echo</span> $(kubectl get node <span class="hljs-variable">$DESTNODE</span> -o go-template=<span class="hljs-string">"</span></div><div class="remark-code-line">      route add -net {{.spec.podCIDR}} gw {{(index .status.addresses 0).address}}")</div><div class="remark-code-line">  <span class="hljs-keyword">fi</span></div><div class="remark-code-line"><span class="hljs-keyword">done</span></div></code></pre>
<ul>
<li><p>This could be useful for embedded platforms with very limited resources</p>
<p>(or lab environments for learning purposes)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">818 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">819 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-interconnecting-clusters" class="remark-slide-content title hljs-default"><p>Interconnecting clusters</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-the-container-network-interface">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-10">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-installing-a-managed-cluster">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">820 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="interconnecting-clusters">Interconnecting clusters</h1>
<ul>
<li><p>We assigned different Cluster CIDRs to each cluster</p>
</li>
<li><p>This allows us to connect our clusters together</p>
</li>
<li><p>We will leverage kube-router BGP abilities for that</p>
</li>
<li><p>We will <em>peer</em> each kube-router instance with a <em>route reflector</em></p>
</li>
<li><p>As a result, we will be able to ping each other's pods</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">821 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="disclaimers">Disclaimers</h2>
<ul>
<li><p>There are many methods to interconnect clusters</p>
</li>
<li><p>Depending on your network implementation, you will use different methods</p>
</li>
<li><p>The method shown here only works for nodes with direct layer 2 connection</p>
</li>
<li><p>We will often need to use tunnels or other network techniques</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">822 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-plan">The plan</h2>
<ul>
<li><p>Someone will start the <em>route reflector</em></p>
<p>(typically, that will be the person presenting these slides!)</p>
</li>
<li><p>We will update our kube-router configuration</p>
</li>
<li><p>We will add a <em>peering</em> with the route reflector</p>
<p>(instructing kube-router to connect to it and exchange route information)</p>
</li>
<li><p>We should see the routes to other clusters on our nodes</p>
<p>(in the output of e.g. <code class="remark-inline-code">route -n</code> or <code class="remark-inline-code">ip route show</code>)</p>
</li>
<li><p>We should be able to ping pods of other nodes</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">823 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="starting-the-route-reflector">Starting the route reflector</h2>
<ul>
<li><p>Only do this if you are doing this on your own</p>
</li>
<li><p>There is a Compose file in the <code class="remark-inline-code">compose/frr-route-reflector</code> directory</p>
</li>
<li><p>Before continuing, make sure that you have the IP address of the route reflector</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">824 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="configuring-kube-router">Configuring kube-router</h2>
<ul>
<li><p>This can be done in two ways:</p>
<ul>
<li><p>with command-line flags to the <code class="remark-inline-code">kube-router</code> process</p>
</li>
<li><p>with annotations to Node objects</p>
</li>
</ul>
</li>
<li><p>We will use the command-line flags</p>
<p>(because it will automatically propagate to all nodes)</p>
</li>
</ul>
<p><span class="footnote">Note: with Calico, this is achieved by creating a BGPPeer CRD.</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">825 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-kube-router-configuration">Updating kube-router configuration</h2>
<ul>
<li>We need to pass two command-line flags to the kube-router process</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit the <code class="remark-inline-code">kuberouter.yaml</code> file</p>
</li>
<li><p>Add the following flags to the kube-router arguments:</p>
<pre><code class="remark-code"><div class="remark-code-line">- "--peer-router-ips=<span class="remark-code-span-highlighted">X.X.X.X</span>"</div><div class="remark-code-line">- "--peer-router-asns=64512"</div></code></pre><p>(Replace <code class="remark-inline-code">X.X.X.X</code> with the route reflector address)</p>
</li>
<li><p>Update the DaemonSet definition:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> kuberouter.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">826 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="restarting-kube-router">Restarting kube-router</h2>
<ul>
<li><p>The DaemonSet will not update the pods automatically</p>
<p>(it is using the default <code class="remark-inline-code">updateStrategy</code>, which is <code class="remark-inline-code">OnDelete</code>)</p>
</li>
<li><p>We will therefore delete the pods</p>
<p>(they will be recreated with the updated definition)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Delete all the kube-router pods:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl delete pods -n kube-system <span class="hljs-_">-l</span> k8s-app=kube-router</div></code></pre>
</li>
</ul>
</div>

<p>Note: the other <code class="remark-inline-code">updateStrategy</code> for a DaemonSet is RollingUpdate.
<br>
For critical services, we might want to precisely control the update process.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">827 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-peering-status">Checking peering status</h2>
<ul>
<li><p>We can see informative messages in the output of kube-router:</p>
<pre><code class="remark-code"><div class="remark-code-line">time="2019-04-07T15:53:56Z" level=info msg="Peer Up"</div><div class="remark-code-line">Key=X.X.X.X State=BGP_FSM_OPENCONFIRM Topic=Peer</div></code></pre></li>
<li><p>We should see the routes of the other clusters show up</p>
</li>
<li><p>For debugging purposes, the reflector also exports a route to 1.0.0.2/32</p>
</li>
<li><p>That route will show up like this:</p>
<pre><code class="remark-code"><div class="remark-code-line">1.0.0.2     172.31.X.Y    255.255.255.255 UGH   0      0        0 eth0</div></code></pre></li>
<li><p>We should be able to ping the pods of other clusters!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">828 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="if-we-wanted-to-do-more-">If we wanted to do more ...</h2>
<ul>
<li><p>kube-router can also export ClusterIP addresses</p>
<p>(by adding the flag <code class="remark-inline-code">--advertise-cluster-ip</code>)</p>
</li>
<li><p>They are exported individually (as /32)</p>
</li>
<li><p>This would allow us to easily access other clusters' services</p>
<p>(without having to resolve the individual addresses of pods)</p>
</li>
<li><p>Even better if it's combined with DNS integration</p>
<p>(to facilitate name → ClusterIP resolution)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cni.md">k8s/cni.md</a></span></p><div class="remark-slide-number">829 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/ShippingContainerSFBay.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">830 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-installing-a-managed-cluster" class="remark-slide-content title hljs-default"><p>Installing a managed cluster</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-interconnecting-clusters">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-11">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-kubernetes-distributions-and-installers">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">831 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="installing-a-managed-cluster">Installing a managed cluster</h1>
<p><em>"The easiest way to install Kubernetes is to get someone
else to do it for you."
<br>
(<a href="https://twitter.com/jpetazzo">Jérôme Petazzoni</a>)</em></p>
<ul>
<li><p>Let's see a few options to install managed clusters!</p>
</li>
<li><p>This is not an exhaustive list</p>
<p>(the goal is to show the actual steps to get started)</p>
</li>
<li><p>All the options mentioned here require an account
with a cloud provider</p>
</li>
<li><p>... And a credit card</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">832 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="eks-the-hard-way-">EKS (the hard way)</h2>
<ul>
<li><p><a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html">Read the doc</a></p>
</li>
<li><p>Create service roles, VPCs, and a bunch of other oddities</p>
</li>
<li><p>Try to figure out why it doesn't work</p>
</li>
<li><p>Start over, following an <a href="https://aws.amazon.com/blogs/aws/amazon-eks-now-generally-available/">official AWS blog post</a></p>
</li>
<li><p>Try to find the missing Cloud Formation template</p>
</li>
</ul><div class="remark-slide-number">833 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="eks-the-hard-way-">EKS (the hard way)</h2>
<ul>
<li><p><a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html">Read the doc</a></p>
</li>
<li><p>Create service roles, VPCs, and a bunch of other oddities</p>
</li>
<li><p>Try to figure out why it doesn't work</p>
</li>
<li><p>Start over, following an <a href="https://aws.amazon.com/blogs/aws/amazon-eks-now-generally-available/">official AWS blog post</a></p>
</li>
<li><p>Try to find the missing Cloud Formation template</p>
</li>
</ul>
<p><span class="footnote">(╯°□°)╯︵ ┻━┻</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">834 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="eks-the-easy-way-">EKS (the easy way)</h2>
<ul>
<li><p>Install <code class="remark-inline-code">eksctl</code></p>
</li>
<li><p>Set the usual environment variables</p>
<p>(<a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#eks_region">AWS_DEFAULT_REGION</a>, AWS_ACCESS_KEY, AWS_SECRET_ACCESS_KEY)</p>
</li>
<li><p>Create the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">eksctl create cluster</div></code></pre>
</li>
<li><p>Wait 15-20 minutes (yes, it's sloooooooooooooooooow)</p>
</li>
<li><p>Add cluster add-ons</p>
<p>(by default, it doesn't come with metrics-server, logging, etc.)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">835 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="eks-cleanup-">EKS (cleanup)</h2>
<ul>
<li><p>Delete the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">eksctl delete cluster &lt;clustername&gt;</div></code></pre>
</li>
<li><p>If you need to find the name of the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">eksctl get clusters</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">836 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="gke-initial-setup-">GKE (initial setup)</h2>
<ul>
<li><p>Install <code class="remark-inline-code">gcloud</code></p>
</li>
<li><p>Login:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">gcloud auth init</div></code></pre>
</li>
<li><p>Create a "project":</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">gcloud projects create my-gke-project</div><div class="remark-code-line">gcloud config <span class="hljs-built_in">set</span> project my-gke-project</div></code></pre>
</li>
<li><p>Pick a <a href="https://cloud.google.com/compute/docs/regions-zones/">region</a></p>
<p>(example: <code class="remark-inline-code">europe-west1</code>, <code class="remark-inline-code">us-west1</code>, ...)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">837 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="gke-create-cluster-">GKE (create cluster)</h2>
<ul>
<li><p>Create the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">gcloud container clusters create my-gke-cluster --region us-west1 --num-nodes=2</div></code></pre>
<p>(without <code class="remark-inline-code">--num-nodes</code> you might exhaust your IP address quota!)</p>
</li>
<li><p>The first time you try to create a cluster in a given project, you get an error</p>
<ul>
<li>you need to enable the Kubernetes Engine API</li>
<li>the error message gives you a link</li>
<li>follow the link and enable the API (and billing)
<br>(it's just a couple of clicks and it's instantaneous)</li>
</ul>
</li>
<li><p>Wait a couple of minutes (yes, it's faaaaaaaaast)</p>
</li>
<li><p>The cluster comes with many add-ons</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">838 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="gke-cleanup-">GKE (cleanup)</h2>
<ul>
<li><p>List clusters (if you forgot its name):</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">gcloud container clusters list</div></code></pre>
</li>
<li><p>Delete the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">gcloud container clusters delete my-gke-cluster --region us-west1</div></code></pre>
</li>
<li><p>Delete the project (optional):</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">gcloud projects delete my-gke-project</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">839 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="aks-initial-setup-">AKS (initial setup)</h2>
<ul>
<li><p>Install the Azure CLI</p>
</li>
<li><p>Login:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">az login</div></code></pre>
</li>
<li><p>Select a <a href="https://azure.microsoft.com/en-us/global-infrastructure/services/?products=kubernetes-service\%C2%AEions=all">region</a></p>
</li>
<li><p>Create a "resource group":</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">az group create --name my-aks-group --location westeurope</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">840 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="aks-create-cluster-">AKS (create cluster)</h2>
<ul>
<li><p>Create the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">az aks create --resource-group my-aks-group --name my-aks-cluster</div></code></pre>
</li>
<li><p>Wait about 5-10 minutes</p>
</li>
<li><p>Add credentials to <code class="remark-inline-code">kubeconfig</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">az aks get-credentials --resource-group my-aks-group --name my-aks-cluster</div></code></pre>
</li>
<li><p>The cluster has a lot of goodies pre-installed</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">841 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="aks-cleanup-">AKS (cleanup)</h2>
<ul>
<li><p>Delete the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">az aks delete --resource-group my-aks-group --name my-aks-cluster</div></code></pre>
</li>
<li><p>Delete the resource group:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">az group delete --resource-group my-aks-group</div></code></pre>
</li>
<li><p>Note: delete actions can take a while too!</p>
<p>(5-10 minutes as well)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">842 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="digital-ocean-initial-setup-">Digital Ocean (initial setup)</h2>
<ul>
<li><p>Install <code class="remark-inline-code">doctl</code></p>
</li>
<li><p>Generate API token (in web console)</p>
</li>
<li><p>Set up the CLI authentication:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">doctl auth init</div></code></pre>
<p>(It will ask you for the API token)</p>
</li>
<li><p>Check the list of regions and pick one:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">doctl compute region list</div></code></pre>
<p>(If you don't specify the region later, it will use <code class="remark-inline-code">nyc1</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">843 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="digital-ocean-create-cluster-">Digital Ocean (create cluster)</h2>
<ul>
<li><p>Create the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">doctl kubernetes cluster create my-do-cluster [--region xxx1]</div></code></pre>
</li>
<li><p>Wait 5 minutes</p>
</li>
<li><p>Update <code class="remark-inline-code">kubeconfig</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config use-context <span class="hljs-keyword">do</span>-xxx1-my-do-cluster</div></code></pre>
</li>
<li><p>The cluster comes with some goodies (like Cilium) but no metrics server</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">844 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="digital-ocean-cleanup-">Digital Ocean (cleanup)</h2>
<ul>
<li><p>List clusters (if you forgot its name):</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">doctl kubernetes cluster list</div></code></pre>
</li>
<li><p>Delete the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">doctl kubernetes cluster delete my-do-cluster</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">845 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-options">More options</h2>
<ul>
<li><p>Alibaba Cloud</p>
</li>
<li><p><a href="https://console.bluemix.net/docs/containers/cs_cli_install.html#cs_cli_install">IBM Cloud</a></p>
</li>
<li><p>OVH</p>
</li>
<li><p>Scaleway (private beta)</p>
</li>
<li><p>...</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-managed.md">k8s/setup-managed.md</a></span></p><div class="remark-slide-number">846 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/aerial-view-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">847 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-kubernetes-distributions-and-installers" class="remark-slide-content title hljs-default"><p>Kubernetes distributions and installers</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-installing-a-managed-cluster">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-11">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-static-pods">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">848 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="kubernetes-distributions-and-installers">Kubernetes distributions and installers</h1>
<ul>
<li><p>There are <a href="https://kubernetes.io/docs/setup/pick-right-solution/">countless</a> distributions available</p>
</li>
<li><p>We can't review them all</p>
</li>
<li><p>We're just going to explore a few options</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">849 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kops">kops</h2>
<ul>
<li><p>Deploys Kubernetes using cloud infrastructure</p>
<p>(supports AWS, GCE, Digital Ocean ...)</p>
</li>
<li><p>Leverages special cloud features when possible</p>
<p>(e.g. Auto Scaling Groups ...)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">850 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubeadm">kubeadm</h2>
<ul>
<li><p>Provisions Kubernetes nodes on top of existing machines</p>
</li>
<li><p><code class="remark-inline-code">kubeadm init</code> to provision a single-node control plane</p>
</li>
<li><p><code class="remark-inline-code">kubeadm join</code> to join a node to the cluster</p>
</li>
<li><p>Supports HA control plane <a href="https://kubernetes.io/docs/setup/independent/high-availability/">with some extra steps</a> </p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">851 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubespray">Kubespray</h2>
<ul>
<li><p>Based on Ansible</p>
</li>
<li><p>Works on bare metal and cloud infrastructure</p>
<p>(good for hybrid deployments)</p>
</li>
<li><p>The expert says: ultra flexible; slow; complex</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">852 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="rke-rancher-kubernetes-engine-">RKE (Rancher Kubernetes Engine)</h2>
<ul>
<li><p>Opinionated installer with low requirements</p>
</li>
<li><p>Requires a set of machines with Docker + SSH access</p>
</li>
<li><p>Supports highly available etcd and control plane</p>
</li>
<li><p>The expert says: fast; maintenance can be tricky</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">853 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="terraform-kubeadm">Terraform + kubeadm</h2>
<ul>
<li><p>Sometimes it is necessary to build a custom solution</p>
</li>
<li><p>Example use case: </p>
<ul>
<li><p>deploying Kubernetes on OpenStack</p>
</li>
<li><p>... with highly available control plane</p>
</li>
<li><p>... and Cloud Controller Manager integration</p>
</li>
</ul>
</li>
<li><p>Solution: Terraform + kubeadm (kubeadm driven by remote-exec)</p>
<ul>
<li><p><a href="https://github.com/enix/terraform-openstack-kubernetes">GitHub repository</a></p>
</li>
<li><p><a href="https://enix.io/fr/blog/deployer-kubernetes-1-13-sur-openstack-grace-a-terraform/">Blog post (in French)</a></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">854 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="and-many-more-">And many more ...</h2>
<ul>
<li><p>Docker Enterprise Edition</p>
</li>
<li><p>Pivotal Container Service (PKS)</p>
</li>
<li><p>Tectonic by CoreOS</p>
</li>
<li><p>etc.</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">855 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bottom-line">Bottom line</h2>
<ul>
<li><p>Each distribution / installer has pros and cons</p>
</li>
<li><p>Before picking one, we should sort out our priorities:</p>
<ul>
<li><p>cloud, on-premises, hybrid?</p>
</li>
<li><p>integration with existing network/storage architecture or equipment?</p>
</li>
<li><p>are we storing very sensitive data, like finance, health, military?</p>
</li>
<li><p>how many clusters are we deploying (and maintaining): 2, 10, 50?</p>
</li>
<li><p>which team will be responsible for deployment and maintenance?
<br>(do they need training?)</p>
</li>
<li><p>etc.</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/setup-selfhosted.md">k8s/setup-selfhosted.md</a></span></p><div class="remark-slide-number">856 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/blue-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">857 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-static-pods" class="remark-slide-content title hljs-default"><p>Static pods</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-kubernetes-distributions-and-installers">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-11">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-api-server-availability">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">858 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="static-pods">Static pods</h1>
<ul>
<li><p>Hosting the Kubernetes control plane on Kubernetes has advantages:</p>
<ul>
<li><p>we can use Kubernetes' replication and scaling features for the control plane</p>
</li>
<li><p>we can leverage rolling updates to upgrade the control plane</p>
</li>
</ul>
</li>
<li><p>However, there is a catch:</p>
<ul>
<li><p>deploying on Kubernetes requires the API to be available</p>
</li>
<li><p>the API won't be available until the control plane is deployed</p>
</li>
</ul>
</li>
<li><p>How can we get out of that chicken-and-egg problem?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">859 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-possible-approach">A possible approach</h2>
<ul>
<li><p>Since each component of the control plane can be replicated ...</p>
</li>
<li><p>We could set up the control plane outside of the cluster</p>
</li>
<li><p>Then, once the cluster is fully operational, create replicas running on the cluster</p>
</li>
<li><p>Finally, remove the replicas that are running outside of the cluster</p>
</li>
</ul>
<p><em>What could possibly go wrong?</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">860 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="sawing-off-the-branch-you-re-sitting-on">Sawing off the branch you're sitting on</h2>
<ul>
<li><p>What if anything goes wrong?</p>
<p>(During the setup or at a later point)</p>
</li>
<li><p>Worst case scenario, we might need to:</p>
<ul>
<li><p>set up a new control plane (outside of the cluster)</p>
</li>
<li><p>restore a backup from the old control plane</p>
</li>
<li><p>move the new control plane to the cluster (again)</p>
</li>
</ul>
</li>
<li><p>This doesn't sound like a great experience</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">861 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="static-pods-to-the-rescue">Static pods to the rescue</h2>
<ul>
<li><p>Pods are started by kubelet (an agent running on every node)</p>
</li>
<li><p>To know which pods it should run, the kubelet queries the API server</p>
</li>
<li><p>The kubelet can also get a list of <em>static pods</em> from:</p>
<ul>
<li><p>a directory containing one (or multiple) <em>manifests</em>, and/or</p>
</li>
<li><p>a URL (serving a <em>manifest</em>)</p>
</li>
</ul>
</li>
<li><p>These "manifests" are basically YAML definitions</p>
<p>(As produced by <code class="remark-inline-code">kubectl get pod my-little-pod -o yaml</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">862 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="static-pods-are-dynamic">Static pods are dynamic</h2>
<ul>
<li><p>Kubelet will periodically reload the manifests</p>
</li>
<li><p>It will start/stop pods accordingly</p>
<p>(i.e. it is not necessary to restart the kubelet after updating the manifests)</p>
</li>
<li><p>When connected to the Kubernetes API, the kubelet will create <em>mirror pods</em></p>
</li>
<li><p>Mirror pods are copies of the static pods</p>
<p>(so they can be seen with e.g. <code class="remark-inline-code">kubectl get pods</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">863 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bootstrapping-a-cluster-with-static-pods">Bootstrapping a cluster with static pods</h2>
<ul>
<li><p>We can run control plane components with these static pods</p>
</li>
<li><p>They can start without requiring access to the API server</p>
</li>
<li><p>Once they are up and running, the API becomes available</p>
</li>
<li><p>These pods are then visible through the API</p>
<p>(We cannot upgrade them from the API, though)</p>
</li>
</ul>
<p><em>This is how kubeadm has initialized our clusters.</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">864 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="static-pods-vs-normal-pods">Static pods vs normal pods</h2>
<ul>
<li><p>The API only gives us a read-only access to static pods</p>
</li>
<li><p>We can <code class="remark-inline-code">kubectl delete</code> a static pod ...</p>
<p>... But the kubelet will re-mirror it immediately</p>
</li>
<li><p>Static pods can be selected just like other pods</p>
<p>(So they can receive service traffic)</p>
</li>
<li><p>A service can select a mixture of static and other pods</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">865 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="from-static-pods-to-normal-pods">From static pods to normal pods</h2>
<ul>
<li><p>Once the control plane is up and running, it can be used to create normal pods</p>
</li>
<li><p>We can then set up a copy of the control plane in normal pods</p>
</li>
<li><p>Then the static pods can be removed</p>
</li>
<li><p>The scheduler and the controller manager use leader election</p>
<p>(Only one is active at a time; removing an instance is seamless)</p>
</li>
<li><p>Each instance of the API server adds itself to the <code class="remark-inline-code">kubernetes</code> service</p>
</li>
<li><p>Etcd will typically require more work!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">866 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="from-normal-pods-back-to-static-pods">From normal pods back to static pods</h2>
<ul>
<li><p>Alright, but what if the control plane is down and we need to fix it?</p>
</li>
<li><p>We restart it using static pods!</p>
</li>
<li><p>This can be done automatically with the <a href="https://github.com/kubernetes-incubator/bootkube/blob/master/cmd/checkpoint/README.md">Pod Checkpointer</a></p>
</li>
<li><p>The Pod Checkpointer automatically generates manifests of running pods</p>
</li>
<li><p>The manifests are used to restart these pods if API contact is lost</p>
<p>(More details in the <a href="https://github.com/kubernetes-incubator/bootkube/blob/master/cmd/checkpoint/README.md">Pod Checkpointer</a> documentation page)</p>
</li>
<li><p>This technique is used by <a href="https://github.com/kubernetes-incubator/bootkube">bootkube</a>
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p>
</li>
</ul><div class="remark-slide-number">867 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="where-should-the-control-plane-run-">Where should the control plane run?</h2>
<p><em>Is it better to run the control plane in static pods, or normal pods?</em></p>
<ul>
<li><p>If I'm a <em>user</em> of the cluster: I don't care, it makes no difference to me</p>
</li>
<li><p>What if I'm an <em>admin</em>, i.e. the person who installs, upgrades, repairs... the cluster?</p>
</li>
<li><p>If I'm using a managed Kubernetes cluster (AKS, EKS, GKE...) it's not my problem</p>
<p>(I'm not the one setting up and managing the control plane)</p>
</li>
<li><p>If I already picked a tool (kubeadm, kops...) to set up my cluster, the tool decides for me</p>
</li>
<li><p>What if I haven't picked a tool yet, or if I'm installing from scratch?</p>
<ul>
<li><p>static pods = easier to set up, easier to troubleshoot, less risk of outage</p>
</li>
<li><p>normal pods = easier to upgrade, easier to move (if nodes need to be shut down)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">868 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="static-pods-in-action">Static pods in action</h2>
<ul>
<li>On our clusters, the <code class="remark-inline-code">staticPodPath</code> is <code class="remark-inline-code">/etc/kubernetes/manifests</code></li>
</ul>
<div class="exercise"><ul>
<li>Have a look at this directory:<pre><code class="bash hljs remark-code"><div class="remark-code-line">ls <span class="hljs-_">-l</span> /etc/kubernetes/manifests</div></code></pre>
</li>
</ul>
</div>

<p>We should see YAML files corresponding to the pods of the control plane.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">869 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content static-pods-exercise hljs-default"><h2 id="running-a-static-pod">Running a static pod</h2>
<ul>
<li>We are going to add a pod manifest to the directory, and kubelet will run it</li>
</ul>
<div class="exercise"><ul>
<li><p>Copy a manifest to the directory:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo cp ~/container.training/k8s/just<span class="hljs-_">-a</span>-pod.yaml /etc/kubernetes/manifests</div></code></pre>
</li>
<li><p>Check that it's running:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
</li>
</ul>
</div>

<p>The output should include a pod named <code class="remark-inline-code">hello-node1</code>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">870 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content static-pods-exercise hljs-default"><h2 id="remarks">Remarks</h2>
<p>In the manifest, the pod was named <code class="remark-inline-code">hello</code>.</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">Kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> hello</div><div class="remark-code-line"><span class="hljs-attr">  namespace:</span> default</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> hello</div><div class="remark-code-line"><span class="hljs-attr">    image:</span> nginx</div></code></pre>
<p>The <code class="remark-inline-code">-node1</code> suffix was added automatically by kubelet.</p>
<p>If we delete the pod (with <code class="remark-inline-code">kubectl delete</code>), it will be recreated immediately.</p>
<p>To delete the pod, we need to delete (or move) the manifest file.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/staticpods.md">k8s/staticpods.md</a></span></p><div class="remark-slide-number">871 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/chinook-helicopter-container.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">872 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-api-server-availability" class="remark-slide-content title hljs-default"><p>API server availability</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-static-pods">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-12">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-upgrading-clusters">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">873 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="api-server-availability">API server availability</h1>
<ul>
<li><p>When we set up a node, we need the address of the API server:</p>
<ul>
<li><p>for kubelet</p>
</li>
<li><p>for kube-proxy</p>
</li>
<li><p>sometimes for the pod network system (like kube-router)</p>
</li>
</ul>
</li>
<li><p>How do we ensure the availability of that endpoint?</p>
<p>(what if the node running the API server goes down?)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md">k8s/apilb.md</a></span></p><div class="remark-slide-number">874 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-1-external-load-balancer">Option 1: external load balancer</h2>
<ul>
<li><p>Set up an external load balancer</p>
</li>
<li><p>Point kubelet (and other components) to that load balancer</p>
</li>
<li><p>Put the node(s) running the API server behind that load balancer</p>
</li>
<li><p>Update the load balancer if/when an API server node needs to be replaced</p>
</li>
<li><p>On cloud infrastructures, some mechanisms provide automation for this</p>
<p>(e.g. on AWS, an Elastic Load Balancer + Auto Scaling Group)</p>
</li>
<li><p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/08-bootstrapping-kubernetes-controllers.md#the-kubernetes-frontend-load-balancer">Example in Kubernetes The Hard Way</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md">k8s/apilb.md</a></span></p><div class="remark-slide-number">875 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-2-local-load-balancer">Option 2: local load balancer</h2>
<ul>
<li><p>Set up a load balancer (like NGINX, HAProxy...) on <em>each</em> node</p>
</li>
<li><p>Configure that load balancer to send traffic to the API server node(s)</p>
</li>
<li><p>Point kubelet (and other components) to <code class="remark-inline-code">localhost</code></p>
</li>
<li><p>Update the load balancer configuration when API server nodes are updated</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md">k8s/apilb.md</a></span></p><div class="remark-slide-number">876 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-local-load-balancer-config">Updating the local load balancer config</h2>
<ul>
<li><p>Distribute the updated configuration (push)</p>
</li>
<li><p>Or regularly check for updates (pull)</p>
</li>
<li><p>The latter requires an external, highly available store</p>
<p>(it could be an object store, an HTTP server, or even DNS...)</p>
</li>
<li><p>Updates can be facilitated by a DaemonSet</p>
<p>(but remember that it can't be used when installing a new node!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md">k8s/apilb.md</a></span></p><div class="remark-slide-number">877 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-3-dns-records">Option 3: DNS records</h2>
<ul>
<li><p>Put all the API server nodes behind a round-robin DNS</p>
</li>
<li><p>Point kubelet (and other components) to that name</p>
</li>
<li><p>Update the records when needed</p>
</li>
<li><p>Note: this option is not officially supported</p>
<p>(but since kubelet supports reconnection anyway, it <em>should</em> work)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md">k8s/apilb.md</a></span></p><div class="remark-slide-number">878 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-4-">Option 4: ....................</h2>
<ul>
<li><p>Many managed clusters expose a high-availability API endpoint</p>
<p>(and you don't have to worry about it)</p>
</li>
<li><p>You can also use HA mechanisms that you're familiar with</p>
<p>(e.g. virtual IPs)</p>
</li>
<li><p>Tunnels are also fine</p>
<p>(e.g. <a href="https://k3s.io/">k3s</a> uses a tunnel to allow each node to contact the API server)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/apilb.md">k8s/apilb.md</a></span></p><div class="remark-slide-number">879 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-cranes.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">880 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-upgrading-clusters" class="remark-slide-content title hljs-default"><p>Upgrading clusters</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-api-server-availability">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-12">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-backing-up-clusters">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">881 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="upgrading-clusters">Upgrading clusters</h1>
<ul>
<li><p>It's <em>recommended</em> to run consistent versions across a cluster</p>
<p>(mostly to have feature parity and latest security updates)</p>
</li>
<li><p>It's not <em>mandatory</em></p>
<p>(otherwise, cluster upgrades would be a nightmare!)</p>
</li>
<li><p>Components can be upgraded one at a time without problems</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">882 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-what-we-re-running">Checking what we're running</h2>
<ul>
<li>It's easy to check the version for the API server</li>
</ul>
<div class="exercise"><ul>
<li><p>Log into node <code class="remark-inline-code">test1</code></p>
</li>
<li><p>Check the version of kubectl and of the API server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl version</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>In a HA setup with multiple API servers, they can have different versions</p>
</li>
<li><p>Running the command above multiple times can return different values</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">883 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="node-versions">Node versions</h2>
<ul>
<li>It's also easy to check the version of kubelet</li>
</ul>
<div class="exercise"><ul>
<li>Check node versions (includes kubelet, kernel, container engine):<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes -o wide</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>Different nodes can run different kubelet versions</p>
</li>
<li><p>Different nodes can run different kernel versions</p>
</li>
<li><p>Different nodes can run different container engines</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">884 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="control-plane-versions">Control plane versions</h2>
<ul>
<li>If the control plane is self-hosted (running in pods), we can check it</li>
</ul>
<div class="exercise"><ul>
<li>Show image versions for all pods in <code class="remark-inline-code">kube-system</code> namespace:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --namespace=kube-system get pods -o json \</div><div class="remark-code-line">        | jq -r <span class="hljs-string">'</span></div><div class="remark-code-line">          .items[]</div><div class="remark-code-line">          | [.spec.nodeName, .metadata.name]</div><div class="remark-code-line">            + </div><div class="remark-code-line">            (.spec.containers[].image | split(":"))</div><div class="remark-code-line">          | @tsv</div><div class="remark-code-line">          ' \</div><div class="remark-code-line">        | column -t</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">885 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-version-are-we-running-anyway-">What version are we running anyway?</h2>
<ul>
<li><p>When I say, "I'm running Kubernetes 1.11", is that the version of:</p>
<ul>
<li><p>kubectl</p>
</li>
<li><p>API server</p>
</li>
<li><p>kubelet</p>
</li>
<li><p>controller manager</p>
</li>
<li><p>something else?</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">886 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="other-versions-that-are-important">Other versions that are important</h2>
<ul>
<li><p>etcd</p>
</li>
<li><p>kube-dns or CoreDNS</p>
</li>
<li><p>CNI plugin(s)</p>
</li>
<li><p>Network controller, network policy controller</p>
</li>
<li><p>Container engine</p>
</li>
<li><p>Linux kernel</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">887 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="general-guidelines">General guidelines</h2>
<ul>
<li><p>To update a component, use whatever was used to install it</p>
</li>
<li><p>If it's a distro package, update that distro package</p>
</li>
<li><p>If it's a container or pod, update that container or pod</p>
</li>
<li><p>If you used configuration management, update with that</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">888 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="know-where-your-binaries-come-from">Know where your binaries come from</h2>
<ul>
<li><p>Sometimes, we need to upgrade <em>quickly</em></p>
<p>(when a vulnerability is announced and patched)</p>
</li>
<li><p>If we are using an installer, we should:</p>
<ul>
<li><p>make sure it's using upstream packages</p>
</li>
<li><p>or make sure that whatever packages it uses are current</p>
</li>
<li><p>make sure we can tell it to pin specific component versions</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">889 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-practice">In practice</h2>
<ul>
<li><p>We are going to update a few cluster components</p>
</li>
<li><p>We will change the kubelet version on one node</p>
</li>
<li><p>We will change the version of the API server</p>
</li>
<li><p>We will work with cluster <code class="remark-inline-code">test</code> (nodes <code class="remark-inline-code">test1</code>, <code class="remark-inline-code">test2</code>, <code class="remark-inline-code">test3</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">890 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-kubelet">Updating kubelet</h2>
<ul>
<li><p>These nodes have been installed using the official Kubernetes packages</p>
</li>
<li><p>We can therefore use <code class="remark-inline-code">apt</code> or <code class="remark-inline-code">apt-get</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Log into node <code class="remark-inline-code">test3</code></p>
</li>
<li><p>View available versions for package <code class="remark-inline-code">kubelet</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">apt show kubelet <span class="hljs-_">-a</span> | grep ^Version</div></code></pre>
</li>
<li><p>Upgrade kubelet:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">apt install kubelet=1.14.2-00</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">891 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-what-we-ve-done">Checking what we've done</h2>
<div class="exercise"><ul>
<li><p>Log into node <code class="remark-inline-code">test1</code></p>
</li>
<li><p>Check node versions:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes -o wide</div></code></pre>
</li>
<li><p>Create a deployment and scale it to make sure that the node still works</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">892 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-api-server">Updating the API server</h2>
<ul>
<li><p>This cluster has been deployed with kubeadm</p>
</li>
<li><p>The control plane runs in <em>static pods</em></p>
</li>
<li><p>These pods are started automatically by kubelet</p>
<p>(even when kubelet can't contact the API server)</p>
</li>
<li><p>They are defined in YAML files in <code class="remark-inline-code">/etc/kubernetes/manifests</code></p>
<p>(this path is set by a kubelet command-line flag)</p>
</li>
<li><p>kubelet automatically updates the pods when the files are changed</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">893 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="changing-the-api-server-version">Changing the API server version</h2>
<ul>
<li>We will edit the YAML file to use a different image version</li>
</ul>
<div class="exercise"><ul>
<li><p>Log into node <code class="remark-inline-code">test1</code></p>
</li>
<li><p>Check API server version:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl version</div></code></pre>
</li>
<li><p>Edit the API server pod manifest:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo vim /etc/kubernetes/manifests/kube-apiserver.yaml</div></code></pre>
</li>
<li><p>Look for the <code class="remark-inline-code">image:</code> line, and update it to e.g. <code class="remark-inline-code">v1.14.0</code></p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">894 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-what-we-ve-done">Checking what we've done</h2>
<ul>
<li>The API server will be briefly unavailable while kubelet restarts it</li>
</ul>
<div class="exercise"><ul>
<li>Check the API server version:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl version</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">895 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-whole-control-plane">Updating the whole control plane</h2>
<ul>
<li><p>As an example, we'll use kubeadm to upgrade the entire control plane</p>
<p>(note: this is possible only because the cluster was installed with kubeadm)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Check what will be upgraded:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo kubeadm upgrade plan</div></code></pre>
<p>(Note: kubeadm is confused by our manual upgrade of the API server.
<br>It thinks the cluster is running 1.14.0!)</p>
</li>
</ul>
<!-- ##VERSION## -->

<ul>
<li>Perform the upgrade:<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo kubeadm upgrade apply v1.14.2</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">896 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-kubelets">Updating kubelets</h2>
<ul>
<li><p>After updating the control plane, we need to update each kubelet</p>
</li>
<li><p>This requires to run a special command on each node, to download the config</p>
<p>(this config is generated by kubeadm)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Download the configuration on each node, and upgrade kubelet:<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-keyword">for</span> N <span class="hljs-keyword">in</span> 1 2 3; <span class="hljs-keyword">do</span></div><div class="remark-code-line">    ssh node<span class="hljs-variable">$N</span> sudo kubeadm upgrade node config --kubelet-version v1.14.2</div><div class="remark-code-line">    ssh node <span class="hljs-variable">$N</span> sudo apt install kubelet=1.14.2-00</div><div class="remark-code-line"><span class="hljs-keyword">done</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">897 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-what-we-ve-done">Checking what we've done</h2>
<ul>
<li>All our nodes should now be updated to version 1.14.2</li>
</ul>
<div class="exercise"><ul>
<li>Check nodes versions:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get nodes -o wide</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-upgrade.md">k8s/cluster-upgrade.md</a></span></p><div class="remark-slide-number">898 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-housing.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">899 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-backing-up-clusters" class="remark-slide-content title hljs-default"><p>Backing up clusters</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-upgrading-clusters">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-12">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-the-cloud-controller-manager">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">900 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="backing-up-clusters">Backing up clusters</h1>
<ul>
<li><p>Backups can have multiple purposes:</p>
<ul>
<li><p>disaster recovery (servers or storage are destroyed or unreachable)</p>
</li>
<li><p>error recovery (human or process has altered or corrupted data)</p>
</li>
<li><p>cloning environments (for testing, validation ...)</p>
</li>
</ul>
</li>
<li><p>Let's see the strategies and tools available with Kubernetes!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">901 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="important">Important</h2>
<ul>
<li><p>Kubernetes helps us with disaster recovery</p>
<p>(it gives us replication primitives)</p>
</li>
<li><p>Kubernetes helps us to clone / replicate environments</p>
<p>(all resources can be described with manifests)</p>
</li>
<li><p>Kubernetes <em>does not</em> help us with error recovery</p>
</li>
<li><p>We still need to backup / snapshot our data:</p>
<ul>
<li><p>with database backups (mysqldump, pgdump, etc.)</p>
</li>
<li><p>and/or snapshots at the storage layer</p>
</li>
<li><p>and/or traditional full disk backups</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">902 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-a-perfect-world-">In a perfect world ...</h2>
<ul>
<li><p>The deployment of our Kubernetes clusters is automated</p>
<p>(recreating a cluster takes less than a minute of human time)</p>
</li>
<li><p>All the resources (Deployments, Services...) on our clusters are under version control</p>
<p>(never use <code class="remark-inline-code">kubectl run</code>; always apply YAML files coming from a repository)</p>
</li>
<li><p>Stateful components are either:</p>
<ul>
<li><p>stored on systems with regular snapshots</p>
</li>
<li><p>backed up regularly to an external, durable storage</p>
</li>
<li><p>outside of Kubernetes</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">903 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubernetes-cluster-deployment">Kubernetes cluster deployment</h2>
<ul>
<li><p>If our deployment system isn't fully automated, it should at least be documented</p>
</li>
<li><p>Litmus test: how long does it take to deploy a cluster ...</p>
<ul>
<li><p>for a senior engineer?</p>
</li>
<li><p>for a new hire?</p>
</li>
</ul>
</li>
<li><p>Does it require external intervention?</p>
<p>(e.g. provisioning servers, signing TLS certs ...)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">904 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="plan-b">Plan B</h2>
<ul>
<li><p>Full machine backups of the control plane can help</p>
</li>
<li><p>If the control plane is in pods (or containers), pay attention to storage drivers</p>
<p>(if the backup mechanism is not container-aware, the backups can take way more resources than they should, or even be unusable!)</p>
</li>
<li><p>If the previous sentence worries you:</p>
<p><strong>automate the deployment of your clusters!</strong></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">905 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="managing-our-kubernetes-resources">Managing our Kubernetes resources</h2>
<ul>
<li><p>Ideal scenario:</p>
<ul>
<li><p>never create a resource directly on a cluster</p>
</li>
<li><p>push to a code repository</p>
</li>
<li><p>a special branch (<code class="remark-inline-code">production</code> or even <code class="remark-inline-code">master</code>) gets automatically deployed</p>
</li>
</ul>
</li>
<li><p>Some folks call this "GitOps"</p>
<p>(it's the logical evolution of configuration management and infrastructure as code)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">906 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="gitops-in-theory">GitOps in theory</h2>
<ul>
<li><p>What do we keep in version control?</p>
</li>
<li><p>For very simple scenarios: source code, Dockerfiles, scripts</p>
</li>
<li><p>For real applications: add resources (as YAML files)</p>
</li>
<li><p>For applications deployed multiple times: Helm, Kustomize ...</p>
<p>(staging and production count as "multiple times")</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">907 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="gitops-tooling">GitOps tooling</h2>
<ul>
<li><p>Various tools exist (Weave Flux, GitKube...)</p>
</li>
<li><p>These tools are still very young</p>
</li>
<li><p>You still need to write YAML for all your resources</p>
</li>
<li><p>There is no tool to:</p>
<ul>
<li><p>list <em>all</em> resources in a namespace</p>
</li>
<li><p>get resource YAML in a canonical form</p>
</li>
<li><p>diff YAML descriptions with current state</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">908 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="gitops-in-practice">GitOps in practice</h2>
<ul>
<li><p>Start describing your resources with YAML</p>
</li>
<li><p>Leverage a tool like Kustomize or Helm</p>
</li>
<li><p>Make sure that you can easily deploy to a new namespace</p>
<p>(or even better: to a new cluster)</p>
</li>
<li><p>When tooling matures, you will be ready</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">909 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="plan-b">Plan B</h2>
<ul>
<li><p>What if we can't describe everything with YAML?</p>
</li>
<li><p>What if we manually create resources and forget to commit them to source control?</p>
</li>
<li><p>What about global resources, that don't live in a namespace?</p>
</li>
<li><p>How can we be sure that we saved <em>everything</em>?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">910 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="backing-up-etcd">Backing up etcd</h2>
<ul>
<li><p>All objects are saved in etcd</p>
</li>
<li><p>etcd data should be relatively small</p>
<p>(and therefore, quick and easy to back up)</p>
</li>
<li><p>Two options to back up etcd:</p>
<ul>
<li><p>snapshot the data directory</p>
</li>
<li><p>use <code class="remark-inline-code">etcdctl snapshot</code></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">911 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="making-an-etcd-snapshot">Making an etcd snapshot</h2>
<ul>
<li><p>The basic command is simple:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">etcdctl snapshot save &lt;filename&gt;</div></code></pre>
</li>
<li><p>But we also need to specify:</p>
<ul>
<li><p>an environment variable to specify that we want etcdctl v3</p>
</li>
<li><p>the address of the server to back up</p>
</li>
<li><p>the path to the key, certificate, and CA certificate
<br>(if our etcd uses TLS certificates)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">912 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="snapshotting-etcd-on-kubeadm">Snapshotting etcd on kubeadm</h2>
<ul>
<li><p>The following command will work on clusters deployed with kubeadm</p>
<p>(and maybe others)</p>
</li>
<li><p>It should be executed on a master node</p>
</li>
</ul>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker run --rm --net host -v <span class="hljs-variable">$PWD</span>:/vol \</div><div class="remark-code-line">    -v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd:ro \</div><div class="remark-code-line">    <span class="hljs-_">-e</span> ETCDCTL_API=3 k8s.gcr.io/etcd:3.3.10 \</div><div class="remark-code-line">    etcdctl --endpoints=https://[127.0.0.1]:2379 \</div><div class="remark-code-line">            --cacert=/etc/kubernetes/pki/etcd/ca.crt \</div><div class="remark-code-line">            --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \</div><div class="remark-code-line">            --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \</div><div class="remark-code-line">            snapshot save /vol/snapshot</div></code></pre>
<ul>
<li>It will create a file named <code class="remark-inline-code">snapshot</code> in the current directory</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">913 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-can-we-remember-all-these-flags-">How can we remember all these flags?</h2>
<ul>
<li><p>Look at the static pod manifest for etcd</p>
<p>(in <code class="remark-inline-code">/etc/kubernetes/manifests</code>)</p>
</li>
<li><p>The healthcheck probe is calling <code class="remark-inline-code">etcdctl</code> with all the right flags 
😉👍✌️</p>
</li>
<li><p>Exercise: write the YAML for a batch job to perform the backup</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">914 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="restoring-an-etcd-snapshot">Restoring an etcd snapshot</h2>
<ul>
<li><p><del>Execute exactly the same command, but replacing <code class="remark-inline-code">save</code> with <code class="remark-inline-code">restore</code></del></p>
<p>(Believe it or not, doing that will <em>not</em> do anything useful!)</p>
</li>
<li><p>The <code class="remark-inline-code">restore</code> command does <em>not</em> load a snapshot into a running etcd server</p>
</li>
<li><p>The <code class="remark-inline-code">restore</code> command creates a new data directory from the snapshot</p>
<p>(it's an offline operation; it doesn't interact with an etcd server)</p>
</li>
<li><p>It will create a new data directory in a temporary container</p>
<p>(leaving the running etcd node untouched)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">915 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="when-using-kubeadm">When using kubeadm</h2>
<ol>
<li><p>Create a new data directory from the snapshot:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo rm -rf /var/lib/etcd</div><div class="remark-code-line">docker run --rm -v /var/lib:/var/lib -v <span class="hljs-variable">$PWD</span>:/vol \</div><div class="remark-code-line">      <span class="hljs-_">-e</span> ETCDCTL_API=3 k8s.gcr.io/etcd:3.3.10 \</div><div class="remark-code-line">      etcdctl snapshot restore /vol/snapshot --data-dir=/var/lib/etcd</div></code></pre>
</li>
<li><p>Provision the control plane, using that data directory:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo kubeadm init \</div><div class="remark-code-line">    --ignore-preflight-errors=DirAvailable--var-lib-etcd</div></code></pre>
</li>
<li><p>Rejoin the other nodes</p>
</li>
</ol>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">916 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-fine-print">The fine print</h2>
<ul>
<li><p>This only saves etcd state</p>
</li>
<li><p>It <strong>does not</strong> save persistent volumes and local node data</p>
</li>
<li><p>Some critical components (like the pod network) might need to be reset</p>
</li>
<li><p>As a result, our pods might have to be recreated, too</p>
</li>
<li><p>If we have proper liveness checks, this should happen automatically</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">917 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-information-about-etcd-backups">More information about etcd backups</h2>
<ul>
<li><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#built-in-snapshot">Kubernetes documentation</a> about etcd backups</p>
</li>
<li><p><a href="https://coreos.com/etcd/docs/latest/op-guide/recovery.html#snapshotting-the-keyspace">etcd documentation</a> about snapshots and restore</p>
</li>
<li><p><a href="https://elastisys.com/2018/12/10/backup-kubernetes-how-and-why/">A good blog post by elastisys</a> explaining how to restore a snapshot</p>
</li>
<li><p><a href="https://labs.consol.de/kubernetes/2018/05/25/kubeadm-backup.html">Another good blog post by consol labs</a> on the same topic</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">918 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="don-t-forget-">Don't forget ...</h2>
<ul>
<li><p>Also back up the TLS information</p>
<p>(at the very least: CA key and cert; API server key and cert)</p>
</li>
<li><p>With clusters provisioned by kubeadm, this is in <code class="remark-inline-code">/etc/kubernetes/pki</code></p>
</li>
<li><p>If you don't:</p>
<ul>
<li><p>you will still be able to restore etcd state and bring everything back up</p>
</li>
<li><p>you will need to redistribute user certificates</p>
</li>
</ul>
</li>
</ul>
<div class="warning"><p><strong>TLS information is highly sensitive! 
<br>Anyone who has it has full access to your cluster!</strong></p>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">919 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="stateful-services">Stateful services</h2>
<ul>
<li><p>It's totally fine to keep your production databases outside of Kubernetes</p>
<p><em>Especially if you have only one database server!</em></p>
</li>
<li><p>Feel free to put development and staging databases on Kubernetes</p>
<p>(as long as they don't hold important data)</p>
</li>
<li><p>Using Kubernetes for stateful services makes sense if you have <em>many</em></p>
<p>(because then you can leverage Kubernetes automation)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">920 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="snapshotting-persistent-volumes">Snapshotting persistent volumes</h2>
<ul>
<li><p>Option 1: snapshot volumes out of band</p>
<p>(with the API/CLI/GUI of our SAN/cloud/...)</p>
</li>
<li><p>Option 2: storage system integration</p>
<p>(e.g. <a href="https://docs.portworx.com/portworx-install-with-kubernetes/storage-operations/create-snapshots/">Portworx</a> can <a href="https://docs.portworx.com/portworx-install-with-kubernetes/storage-operations/create-snapshots/snaps-annotations/#taking-periodic-snapshots-on-a-running-pod">create snapshots through annotations</a>)</p>
</li>
<li><p>Option 3: <a href="https://kubernetes.io/blog/2018/10/09/introducing-volume-snapshot-alpha-for-kubernetes/">snapshots through Kubernetes API</a></p>
<p>(now in alpha for a few storage providers: GCE, OpenSDS, Ceph, Portworx)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">921 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-backup-tools">More backup tools</h2>
<ul>
<li><p><a href="https://appscode.com/products/stash/">Stash</a></p>
<p>back up Kubernetes persistent volumes</p>
</li>
<li><p><a href="https://github.com/mhausenblas/reshifter">ReShifter</a></p>
<p>cluster state management</p>
</li>
<li><p><del>Heptio Ark</del> <a href="https://github.com/heptio/velero">Velero</a></p>
<p>full cluster backup</p>
</li>
<li><p><a href="https://github.com/pieterlange/kube-backup">kube-backup</a></p>
<p>simple scripts to save resource YAML to a git repository</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cluster-backup.md">k8s/cluster-backup.md</a></span></p><div class="remark-slide-number">922 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/containers-by-the-water.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">923 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-the-cloud-controller-manager" class="remark-slide-content title hljs-default"><p>The Cloud Controller Manager</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-backing-up-clusters">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-12">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-authentication-and-authorization">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">924 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="the-cloud-controller-manager">The Cloud Controller Manager</h1>
<ul>
<li><p>Kubernetes has many features that are cloud-specific</p>
<p>(e.g. providing cloud load balancers when a Service of type LoadBalancer is created)</p>
</li>
<li><p>These features were initially implemented in API server and controller manager</p>
</li>
<li><p>Since Kubernetes 1.6, these features are available through a separate process:</p>
<p>the <em>Cloud Controller Manager</em></p>
</li>
<li><p>The CCM is optional, but if we run in a cloud, we probably want it!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">925 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cloud-controller-manager-duties">Cloud Controller Manager duties</h2>
<ul>
<li><p>Creating and updating cloud load balancers</p>
</li>
<li><p>Configuring routing tables in the cloud network (specific to GCE)</p>
</li>
<li><p>Updating node labels to indicate region, zone, instance type ...</p>
</li>
<li><p>Obtain node name, internal and external addresses from cloud metadata service</p>
</li>
<li><p>Deleting nodes from Kubernetes when they're deleted in the cloud</p>
</li>
<li><p>Managing <em>some</em> volumes (e.g. ELBs, AzureDisks ...)</p>
<p>(Eventually, volumes will be managed by the CSI)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">926 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-tree-vs-out-of-tree">In-tree vs. out-of-tree</h2>
<ul>
<li><p>A number of cloud providers are supported "in-tree"</p>
<p>(in the main kubernetes/kubernetes repository on GitHub)</p>
</li>
<li><p>More cloud providers are supported "out-of-tree"</p>
<p>(with code in different repositories)</p>
</li>
<li><p>There is an <a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/cloudprovider">ongoing effort</a> to move everything to out-of-tree providers</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">927 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-tree-providers">In-tree providers</h2>
<p>The following providers are actively maintained:</p>
<ul>
<li>Amazon Web Services</li>
<li>Azure</li>
<li>Google Compute Engine</li>
<li>IBM Cloud</li>
<li>OpenStack</li>
<li>VMware vSphere</li>
</ul>
<p>These ones are less actively maintained:</p>
<ul>
<li>Apache CloudStack</li>
<li>oVirt</li>
<li>VMware Photon</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">928 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="out-of-tree-providers">Out-of-tree providers</h2>
<p>The list includes the following providers:</p>
<ul>
<li><p>DigitalOcean</p>
</li>
<li><p>keepalived (not exactly a cloud; provides VIPs for load balancers)</p>
</li>
<li><p>Linode</p>
</li>
<li><p>Oracle Cloud Infrastructure</p>
</li>
</ul>
<p>(And possibly others; there is no central registry for these.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">929 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cloud-controller-manager-in-practice">Cloud Controller Manager in practice</h2>
<ul>
<li><p>Write a configuration file</p>
<p>(typically <code class="remark-inline-code">/etc/kubernetes/cloud.conf</code>)</p>
</li>
<li><p>Run the CCM process</p>
<p>(on self-hosted clusters, this can be a DaemonSet selecting the control plane nodes)</p>
</li>
<li><p>Start kubelet with <code class="remark-inline-code">--cloud-provider=external</code></p>
</li>
<li><p>When using managed clusters, this is done automatically</p>
</li>
<li><p>There is very little documentation to write the configuration file</p>
<p>(except for OpenStack)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">930 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bootstrapping-challenges">Bootstrapping challenges</h2>
<ul>
<li><p>When a node joins the cluster, it needs to obtain a signed TLS certificate</p>
</li>
<li><p>That certificate must contain the node's addresses</p>
</li>
<li><p>These addresses are provided by the Cloud Controller Manager</p>
<p>(at least the external address)</p>
</li>
<li><p>To get these addresses, the node needs to communicate with the control plane</p>
</li>
<li><p>... Which means joining the cluster</p>
</li>
</ul>
<p>(The problem didn't occur when cloud-specific code was running in kubelet: kubelet could obtain the required information directly from the cloud provider's metadata service.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">931 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-information-about-ccm">More information about CCM</h2>
<ul>
<li><p>CCM configuration and operation is highly specific to each cloud provider</p>
<p>(which is why this section remains very generic)</p>
</li>
<li><p>The Kubernetes documentation has <em>some</em> information:</p>
<ul>
<li><p><a href="https://kubernetes.io/docs/concepts/architecture/cloud-controller/">architecture and diagrams</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/">configuration</a> (mainly for OpenStack)</p>
</li>
<li><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/running-cloud-controller/">deployment</a></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/cloud-controller-manager.md">k8s/cloud-controller-manager.md</a></span></p><div class="remark-slide-number">932 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/distillery-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">933 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-authentication-and-authorization" class="remark-slide-content title hljs-default"><p>Authentication and authorization</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-the-cloud-controller-manager">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-13">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-the-csr-api">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">934 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="authentication-and-authorization">Authentication and authorization</h1>
<p><em>And first, a little refresher!</em></p>
<ul>
<li><p>Authentication = verifying the identity of a person</p>
<p>On a UNIX system, we can authenticate with login+password, SSH keys ...</p>
</li>
<li><p>Authorization = listing what they are allowed to do</p>
<p>On a UNIX system, this can include file permissions, sudoer entries ...</p>
</li>
<li><p>Sometimes abbreviated as "authn" and "authz"</p>
</li>
<li><p>In good modular systems, these things are decoupled</p>
<p>(so we can e.g. change a password or SSH key without having to reset access rights)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">935 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authentication-in-kubernetes">Authentication in Kubernetes</h2>
<ul>
<li><p>When the API server receives a request, it tries to authenticate it</p>
<p>(it examines headers, certificates ... anything available)</p>
</li>
<li><p>Many authentication methods are available and can be used simultaneously</p>
<p>(we will see them on the next slide)</p>
</li>
<li><p>It's the job of the authentication method to produce:</p>
<ul>
<li>the user name</li>
<li>the user ID</li>
<li>a list of groups</li>
</ul>
</li>
<li><p>The API server doesn't interpret these; it'll be the job of <em>authorizers</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">936 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authentication-methods">Authentication methods</h2>
<ul>
<li><p>TLS client certificates</p>
<p>(that's what we've been doing with <code class="remark-inline-code">kubectl</code> so far)</p>
</li>
<li><p>Bearer tokens</p>
<p>(a secret token in the HTTP headers of the request)</p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Basic_access_authentication">HTTP basic auth</a></p>
<p>(carrying user and password in a HTTP header)</p>
</li>
<li><p>Authentication proxy</p>
<p>(sitting in front of the API and setting trusted headers)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">937 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="anonymous-requests">Anonymous requests</h2>
<ul>
<li><p>If any authentication method <em>rejects</em> a request, it's denied</p>
<p>(<code class="remark-inline-code">401 Unauthorized</code> HTTP code)</p>
</li>
<li><p>If a request is neither rejected nor accepted by anyone, it's anonymous</p>
<ul>
<li><p>the user name is <code class="remark-inline-code">system:anonymous</code></p>
</li>
<li><p>the list of groups is <code class="remark-inline-code">[system:unauthenticated]</code></p>
</li>
</ul>
</li>
<li><p>By default, the anonymous user can't do anything</p>
<p>(that's what you get if you just <code class="remark-inline-code">curl</code> the Kubernetes API)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">938 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authentication-with-tls-certificates">Authentication with TLS certificates</h2>
<ul>
<li><p>This is enabled in most Kubernetes deployments</p>
</li>
<li><p>The user name is derived from the <code class="remark-inline-code">CN</code> in the client certificates</p>
</li>
<li><p>The groups are derived from the <code class="remark-inline-code">O</code> fields in the client certificate</p>
</li>
<li><p>From the point of view of the Kubernetes API, users do not exist</p>
<p>(i.e. they are not stored in etcd or anywhere else)</p>
</li>
<li><p>Users can be created (and given membership to groups) independently of the API</p>
</li>
<li><p>The Kubernetes API can be set up to use your custom CA to validate client certs</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">939 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="viewing-our-admin-certificate">Viewing our admin certificate</h2>
<ul>
<li>Let's inspect the certificate we've been using all this time!</li>
</ul>
<div class="exercise"><ul>
<li>This command will show the <code class="remark-inline-code">CN</code> and <code class="remark-inline-code">O</code> fields for our certificate:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config view \</div><div class="remark-code-line">      --raw \</div><div class="remark-code-line">      -o json \</div><div class="remark-code-line">      | jq -r .users[0].user[\<span class="hljs-string">"client-certificate-data\"] \</span></div><div class="remark-code-line">      | openssl base64 -d -A \</div><div class="remark-code-line">      | openssl x509 -text \</div><div class="remark-code-line">      | grep Subject:</div></code></pre>
</li>
</ul>
</div>

<p>Let's break down that command together! 😅</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">940 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="breaking-down-the-command">Breaking down the command</h2>
<ul>
<li><code class="remark-inline-code">kubectl config view</code> shows the Kubernetes user configuration</li>
<li><code class="remark-inline-code">--raw</code> includes certificate information (which shows as REDACTED otherwise)</li>
<li><code class="remark-inline-code">-o json</code> outputs the information in JSON format</li>
<li><code class="remark-inline-code">| jq ...</code> extracts the field with the user certificate (in base64)</li>
<li><code class="remark-inline-code">| openssl base64 -d -A</code> decodes the base64 format (now we have a PEM file)</li>
<li><code class="remark-inline-code">| openssl x509 -text</code> parses the certificate and outputs it as plain text</li>
<li><code class="remark-inline-code">| grep Subject:</code> shows us the line that interests us</li>
</ul>
<p>→ We are user <code class="remark-inline-code">kubernetes-admin</code>, in group <code class="remark-inline-code">system:masters</code>.</p>
<p>(We will see later how and why this gives us the permissions that we have.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">941 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="user-certificates-in-practice">User certificates in practice</h2>
<ul>
<li><p>The Kubernetes API server does not support certificate revocation</p>
<p>(see issue <a href="https://github.com/kubernetes/kubernetes/issues/18982">#18982</a>)</p>
</li>
<li><p>As a result, we don't have an easy way to terminate someone's access</p>
<p>(if their key is compromised, or they leave the organization)</p>
</li>
<li><p>Option 1: re-create a new CA and re-issue everyone's certificates 
<br>
→ Maybe OK if we only have a few users; no way otherwise</p>
</li>
<li><p>Option 2: don't use groups; grant permissions to individual users
<br>
→ Inconvenient if we have many users and teams; error-prone</p>
</li>
<li><p>Option 3: issue short-lived certificates (e.g. 24 hours) and renew them often
<br>
→ This can be facilitated by e.g. Vault or by the Kubernetes CSR API</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">942 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authentication-with-tokens">Authentication with tokens</h2>
<ul>
<li><p>Tokens are passed as HTTP headers:</p>
<p><code class="remark-inline-code">Authorization: Bearer and-then-here-comes-the-token</code></p>
</li>
<li><p>Tokens can be validated through a number of different methods:</p>
<ul>
<li><p>static tokens hard-coded in a file on the API server</p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/">bootstrap tokens</a> (special case to create a cluster or join nodes)</p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens">OpenID Connect tokens</a> (to delegate authentication to compatible OAuth2 providers)</p>
</li>
<li><p>service accounts (these deserve more details, coming right up!)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">943 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="service-accounts">Service accounts</h2>
<ul>
<li><p>A service account is a user that exists in the Kubernetes API</p>
<p>(it is visible with e.g. <code class="remark-inline-code">kubectl get serviceaccounts</code>)</p>
</li>
<li><p>Service accounts can therefore be created / updated dynamically</p>
<p>(they don't require hand-editing a file and restarting the API server)</p>
</li>
<li><p>A service account is associated with a set of secrets</p>
<p>(the kind that you can view with <code class="remark-inline-code">kubectl get secrets</code>)</p>
</li>
<li><p>Service accounts are generally used to grant permissions to applications, services ...</p>
<p>(as opposed to humans)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">944 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="token-authentication-in-practice">Token authentication in practice</h2>
<ul>
<li><p>We are going to list existing service accounts</p>
</li>
<li><p>Then we will extract the token for a given service account</p>
</li>
<li><p>And we will use that token to authenticate with the API</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">945 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="listing-service-accounts">Listing service accounts</h2>
<div class="exercise"><ul>
<li>The resource name is <code class="remark-inline-code">serviceaccount</code> or <code class="remark-inline-code">sa</code> in short:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get sa</div></code></pre>
</li>
</ul>
</div>

<p>There should be just one service account in the default namespace: <code class="remark-inline-code">default</code>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">946 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="finding-the-secret">Finding the secret</h2>
<div class="exercise"><ul>
<li>List the secrets for the <code class="remark-inline-code">default</code> service account:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get sa default -o yaml</div><div class="remark-code-line">SECRET=$(kubectl get sa default -o json | jq -r .secrets[0].name)</div></code></pre>
</li>
</ul>
</div>

<p>It should be named <code class="remark-inline-code">default-token-XXXXX</code>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">947 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="extracting-the-token">Extracting the token</h2>
<ul>
<li>The token is stored in the secret, wrapped with base64 encoding</li>
</ul>
<div class="exercise"><ul>
<li><p>View the secret:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get secret <span class="hljs-variable">$SECRET</span> -o yaml</div></code></pre>
</li>
<li><p>Extract the token and decode it:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">TOKEN=$(kubectl get secret <span class="hljs-variable">$SECRET</span> -o json \</div><div class="remark-code-line">      | jq -r .data.token | openssl base64 <span class="hljs-_">-d</span> -A)</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">948 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="using-the-token">Using the token</h2>
<ul>
<li>Let's send a request to the API, without and with the token</li>
</ul>
<div class="exercise"><ul>
<li><p>Find the ClusterIP for the <code class="remark-inline-code">kubernetes</code> service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc kubernetes</div><div class="remark-code-line">API=$(kubectl get svc kubernetes -o json | jq -r .spec.clusterIP)</div></code></pre>
</li>
<li><p>Connect without the token:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k https://<span class="hljs-variable">$API</span></div></code></pre>
</li>
<li><p>Connect with the token:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$TOKEN</span>"</span> https://<span class="hljs-variable">$API</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">949 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="results">Results</h2>
<ul>
<li><p>In both cases, we will get a "Forbidden" error</p>
</li>
<li><p>Without authentication, the user is <code class="remark-inline-code">system:anonymous</code></p>
</li>
<li><p>With authentication, it is shown as <code class="remark-inline-code">system:serviceaccount:default:default</code></p>
</li>
<li><p>The API "sees" us as a different user</p>
</li>
<li><p>But neither user has any right, so we can't do nothin'</p>
</li>
<li><p>Let's change that!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">950 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authorization-in-kubernetes">Authorization in Kubernetes</h2>
<ul>
<li><p>There are multiple ways to grant permissions in Kubernetes, called <a href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/#authorization-modules">authorizers</a>:</p>
<ul>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">Node Authorization</a> (used internally by kubelet; we can ignore it)</p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/abac/">Attribute-based access control</a> (powerful but complex and static; ignore it too)</p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/webhook/">Webhook</a> (each API request is submitted to an external service for approval)</p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Role-based access control</a> (associates permissions to users dynamically)</p>
</li>
</ul>
</li>
<li><p>The one we want is the last one, generally abbreviated as RBAC</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">951 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="role-based-access-control">Role-based access control</h2>
<ul>
<li><p>RBAC allows to specify fine-grained permissions</p>
</li>
<li><p>Permissions are expressed as <em>rules</em></p>
</li>
<li><p>A rule is a combination of:</p>
<ul>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb">verbs</a> like create, get, list, update, delete ...</p>
</li>
<li><p>resources (as in "API resource", like pods, nodes, services ...)</p>
</li>
<li><p>resource names (to specify e.g. one specific pod instead of all pods)</p>
</li>
<li><p>in some case, <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#referring-to-resources">subresources</a> (e.g. logs are subresources of pods)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">952 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="from-rules-to-roles-to-rolebindings">From rules to roles to rolebindings</h2>
<ul>
<li><p>A <em>role</em> is an API object containing a list of <em>rules</em></p>
<p>Example: role "external-load-balancer-configurator" can:</p>
<ul>
<li>[list, get] resources [endpoints, services, pods]</li>
<li>[update] resources [services]</li>
</ul>
</li>
<li><p>A <em>rolebinding</em> associates a role with a user</p>
<p>Example: rolebinding "external-load-balancer-configurator":</p>
<ul>
<li>associates user "external-load-balancer-configurator"</li>
<li>with role "external-load-balancer-configurator"</li>
</ul>
</li>
<li><p>Yes, there can be users, roles, and rolebindings with the same name</p>
</li>
<li><p>It's a good idea for 1-1-1 bindings; not so much for 1-N ones</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">953 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cluster-scope-permissions">Cluster-scope permissions</h2>
<ul>
<li><p>API resources Role and RoleBinding are for objects within a namespace</p>
</li>
<li><p>We can also define API resources ClusterRole and ClusterRoleBinding</p>
</li>
<li><p>These are a superset, allowing to:</p>
<ul>
<li><p>specify actions on cluster-wide objects (like nodes)</p>
</li>
<li><p>operate across all namespaces</p>
</li>
</ul>
</li>
<li><p>We can create Role and RoleBinding resources within a namespaces</p>
</li>
<li><p>ClusterRole and ClusterRoleBinding resources are global</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">954 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pods-and-service-accounts">Pods and service accounts</h2>
<ul>
<li><p>A pod can be associated to a service account</p>
<ul>
<li><p>by default, it is associated to the <code class="remark-inline-code">default</code> service account</p>
</li>
<li><p>as we've seen earlier, this service account has no permission anyway</p>
</li>
</ul>
</li>
<li><p>The associated token is exposed into the pod's filesystem</p>
<p>(in <code class="remark-inline-code">/var/run/secrets/kubernetes.io/serviceaccount/token</code>)</p>
</li>
<li><p>Standard Kubernetes tooling (like <code class="remark-inline-code">kubectl</code>) will look for it there</p>
</li>
<li><p>So Kubernetes tools running in a pod will automatically use the service account</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">955 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-practice">In practice</h2>
<ul>
<li><p>We are going to create a service account</p>
</li>
<li><p>We will use a default cluster role (<code class="remark-inline-code">view</code>)</p>
</li>
<li><p>We will bind together this role and this service account</p>
</li>
<li><p>Then we will run a pod using that service account</p>
</li>
<li><p>In this pod, we will install <code class="remark-inline-code">kubectl</code> and check our permissions</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">956 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-a-service-account">Creating a service account</h2>
<ul>
<li><p>We will call the new service account <code class="remark-inline-code">viewer</code></p>
<p>(note that nothing prevents us from calling it <code class="remark-inline-code">view</code>, like the role)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the new service account:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create serviceaccount viewer</div></code></pre>
</li>
<li><p>List service accounts now:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get serviceaccounts</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">957 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="binding-a-role-to-the-service-account">Binding a role to the service account</h2>
<ul>
<li><p>Binding a role = creating a <em>rolebinding</em> object</p>
</li>
<li><p>We will call that object <code class="remark-inline-code">viewercanview</code></p>
<p>(but again, we could call it <code class="remark-inline-code">view</code>)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Create the new role binding:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create rolebinding viewercanview \</div><div class="remark-code-line">      --clusterrole=view \</div><div class="remark-code-line">      --serviceaccount=default:viewer</div></code></pre>
</li>
</ul>
</div>

<p>It's important to note a couple of details in these flags ...</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">958 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="roles-vs-cluster-roles">Roles vs Cluster Roles</h2>
<ul>
<li><p>We used <code class="remark-inline-code">--clusterrole=view</code></p>
</li>
<li><p>What would have happened if we had used <code class="remark-inline-code">--role=view</code>?</p>
<ul>
<li><p>we would have bound the role <code class="remark-inline-code">view</code> from the local namespace
<br>(instead of the cluster role <code class="remark-inline-code">view</code>)</p>
</li>
<li><p>the command would have worked fine (no error)</p>
</li>
<li><p>but later, our API requests would have been denied</p>
</li>
</ul>
</li>
<li><p>This is a deliberate design decision</p>
<p>(we can reference roles that don't exist, and create/update them later)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">959 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="users-vs-service-accounts">Users vs Service Accounts</h2>
<ul>
<li><p>We used <code class="remark-inline-code">--serviceaccount=default:viewer</code></p>
</li>
<li><p>What would have happened if we had used <code class="remark-inline-code">--user=default:viewer</code>?</p>
<ul>
<li><p>we would have bound the role to a user instead of a service account</p>
</li>
<li><p>again, the command would have worked fine (no error)</p>
</li>
<li><p>... but our API requests would have been denied later</p>
</li>
</ul>
</li>
<li><p>What's about the <code class="remark-inline-code">default:</code> prefix?</p>
<ul>
<li><p>that's the namespace of the service account</p>
</li>
<li><p>yes, it could be inferred from context, but ... <code class="remark-inline-code">kubectl</code> requires it</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">960 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing">Testing</h2>
<ul>
<li>We will run an <code class="remark-inline-code">alpine</code> pod and install <code class="remark-inline-code">kubectl</code> there</li>
</ul>
<div class="exercise"><ul>
<li><p>Run a one-time pod:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run eyepod --rm -ti --restart=Never \</div><div class="remark-code-line">      --serviceaccount=viewer \</div><div class="remark-code-line">      --image alpine</div></code></pre>
</li>
<li><p>Install <code class="remark-inline-code">curl</code>, then use it to install <code class="remark-inline-code">kubectl</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">apk add --no-cache curl</div><div class="remark-code-line">URLBASE=https://storage.googleapis.com/kubernetes-release/release</div><div class="remark-code-line">KUBEVER=$(curl <span class="hljs-_">-s</span> <span class="hljs-variable">$URLBASE</span>/stable.txt)</div><div class="remark-code-line">curl -LO <span class="hljs-variable">$URLBASE</span>/<span class="hljs-variable">$KUBEVER</span>/bin/linux/amd64/kubectl</div><div class="remark-code-line">chmod +x kubectl</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">961 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-kubectl-in-the-pod">Running <code class="remark-inline-code">kubectl</code> in the pod</h2>
<ul>
<li>We'll try to use our <code class="remark-inline-code">view</code> permissions, then to create an object</li>
</ul>
<div class="exercise"><ul>
<li><p>Check that we can, indeed, view things:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">./kubectl get all</div></code></pre>
</li>
<li><p>But that we can't create things:</p>
<pre><code class="remark-code"><div class="remark-code-line">./kubectl create deployment testrbac --image=nginx</div></code></pre></li>
<li><p>Exit the container with <code class="remark-inline-code">exit</code> or <code class="remark-inline-code">^D</code></p>
</li>
</ul>
<!-- ```keys ^D``` -->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">962 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-directly-with-kubectl-">Testing directly with <code class="remark-inline-code">kubectl</code></h2>
<ul>
<li><p>We can also check for permission with <code class="remark-inline-code">kubectl auth can-i</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl auth can-i list nodes</div><div class="remark-code-line">kubectl auth can-i create pods</div><div class="remark-code-line">kubectl auth can-i get pod/name-of-pod</div><div class="remark-code-line">kubectl auth can-i get /url-fragment-of-api-request/</div><div class="remark-code-line">kubectl auth can-i <span class="hljs-string">'*'</span> services</div></code></pre>
</li>
<li><p>And we can check permissions on behalf of other users:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl auth can-i list nodes \</div><div class="remark-code-line">      --as some-user</div><div class="remark-code-line">kubectl auth can-i list nodes \</div><div class="remark-code-line">      --as system:serviceaccount:&lt;namespace&gt;:&lt;name-of-service-account&gt;</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">963 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="where-does-this-view-role-come-from-">Where does this <code class="remark-inline-code">view</code> role come from?</h2>
<ul>
<li><p>Kubernetes defines a number of ClusterRoles intended to be bound to users</p>
</li>
<li><p><code class="remark-inline-code">cluster-admin</code> can do <em>everything</em> (think <code class="remark-inline-code">root</code> on UNIX)</p>
</li>
<li><p><code class="remark-inline-code">admin</code> can do <em>almost everything</em> (except e.g. changing resource quotas and limits)</p>
</li>
<li><p><code class="remark-inline-code">edit</code> is similar to <code class="remark-inline-code">admin</code>, but cannot view or edit permissions</p>
</li>
<li><p><code class="remark-inline-code">view</code> has read-only access to most resources, except permissions and secrets</p>
</li>
</ul>
<p><em>In many situations, these roles will be all you need.</em></p>
<p><em>You can also customize them if needed!</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">964 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="customizing-the-default-roles">Customizing the default roles</h2>
<ul>
<li><p>If you need to <em>add</em> permissions to these default roles (or others),
<br>
you can do it through the <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#aggregated-clusterroles">ClusterRole Aggregation</a> mechanism</p>
</li>
<li><p>This happens by creating a ClusterRole with the following labels:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  labels:</span></div><div class="remark-code-line">    rbac.authorization.k8s.io/aggregate-to-admin: <span class="hljs-string">"true"</span></div><div class="remark-code-line">    rbac.authorization.k8s.io/aggregate-to-edit: <span class="hljs-string">"true"</span></div><div class="remark-code-line">    rbac.authorization.k8s.io/aggregate-to-view: <span class="hljs-string">"true"</span></div></code></pre>
</li>
<li><p>This ClusterRole permissions will be added to <code class="remark-inline-code">admin</code>/<code class="remark-inline-code">edit</code>/<code class="remark-inline-code">view</code> respectively</p>
</li>
<li><p>This is particulary useful when using CustomResourceDefinitions</p>
<p>(since Kubernetes cannot guess which resources are sensitive and which ones aren't)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">965 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="where-do-our-permissions-come-from-">Where do our permissions come from?</h2>
<ul>
<li><p>When interacting with the Kubernetes API, we are using a client certificate</p>
</li>
<li><p>We saw previously that this client certificate contained:</p>
<p><code class="remark-inline-code">CN=kubernetes-admin</code> and <code class="remark-inline-code">O=system:masters</code></p>
</li>
<li><p>Let's look for these in existing ClusterRoleBindings:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get clusterrolebindings -o yaml | </div><div class="remark-code-line">grep <span class="hljs-_">-e</span> kubernetes-admin <span class="hljs-_">-e</span> system:masters</div></code></pre>
<p>(<code class="remark-inline-code">system:masters</code> should show up, but not <code class="remark-inline-code">kubernetes-admin</code>.)</p>
</li>
<li><p>Where does this match come from?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">966 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="the-system-masters-group">The <code class="remark-inline-code">system:masters</code> group</h2>
<ul>
<li><p>If we eyeball the output of <code class="remark-inline-code">kubectl get clusterrolebindings -o yaml</code>, we'll find out!</p>
</li>
<li><p>It is in the <code class="remark-inline-code">cluster-admin</code> binding:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl describe clusterrolebinding cluster-admin</div></code></pre>
</li>
<li><p>This binding associates <code class="remark-inline-code">system:masters</code> to the cluster role <code class="remark-inline-code">cluster-admin</code></p>
</li>
<li><p>And the <code class="remark-inline-code">cluster-admin</code> is, basically, <code class="remark-inline-code">root</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl describe clusterrole cluster-admin</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">967 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="figuring-out-who-can-do-what">Figuring out who can do what</h2>
<ul>
<li><p>For auditing purposes, sometimes we want to know who can perform an action</p>
</li>
<li><p>Here is a proof-of-concept tool by Aqua Security, doing exactly that:</p>
<p><a href="https://github.com/aquasecurity/kubectl-who-can">https://github.com/aquasecurity/kubectl-who-can</a></p>
</li>
<li><p>This is one way to install it:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">docker run --rm -v /usr/<span class="hljs-built_in">local</span>/bin:/go/bin golang \</div><div class="remark-code-line">     go get -v github.com/aquasecurity/kubectl-who-can</div></code></pre>
</li>
<li><p>This is one way to use it:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl-who-can create pods</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/authn-authz.md">k8s/authn-authz.md</a></span></p><div class="remark-slide-number">968 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/lots-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">969 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-the-csr-api" class="remark-slide-content title hljs-default"><p>The CSR API</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-authentication-and-authorization">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-13">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-openid-connect">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">970 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="the-csr-api">The CSR API</h1>
<ul>
<li><p>The Kubernetes API exposes CSR resources</p>
</li>
<li><p>We can use these resources to issue TLS certificates</p>
</li>
<li><p>First, we will go through a quick reminder about TLS certificates</p>
</li>
<li><p>Then, we will see how to obtain a certificate for a user</p>
</li>
<li><p>We will use that certificate to authenticate with the cluster</p>
</li>
<li><p>Finally, we will grant some privileges to that user</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">971 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="reminder-about-tls">Reminder about TLS</h2>
<ul>
<li><p>TLS (Transport Layer Security) is a protocol providing:</p>
<ul>
<li><p>encryption (to prevent eavesdropping)</p>
</li>
<li><p>authentication (using public key cryptography)</p>
</li>
</ul>
</li>
<li><p>When we access an https:// URL, the server authenticates itself</p>
<p>(it proves its identity to us; as if it were "showing its ID")</p>
</li>
<li><p>But we can also have mutual TLS authentication (mTLS)</p>
<p>(client proves its identity to server; server proves its identity to client)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">972 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authentication-with-certificates">Authentication with certificates</h2>
<ul>
<li><p>To authenticate, someone (client or server) needs:</p>
<ul>
<li><p>a <em>private key</em> (that remains known only to them)</p>
</li>
<li><p>a <em>public key</em> (that they can distribute)</p>
</li>
<li><p>a <em>certificate</em> (associating the public key with an identity)</p>
</li>
</ul>
</li>
<li><p>A message encrypted with the private key can only be decrypted with the public key</p>
<p>(and vice versa)</p>
</li>
<li><p>If I use someone's public key to encrypt / decrypt their messages,
<br>
I can be certain that I am talking to them / they are talking to me</p>
</li>
<li><p>The certificate proves that I have the correct public key for them</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">973 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="certificate-generation-workflow">Certificate generation workflow</h2>
<p>This is what I do if I want to obtain a certificate.</p>
<ol>
<li><p>Create public and private key.</p>
</li>
<li><p>Create a Certificate Signing Request (CSR).</p>
<p>(The CSR contains the identity that I claim and an expiration date.)</p>
</li>
<li><p>Send that CSR to the Certificate Authority (CA).</p>
</li>
<li><p>The CA verifies that I can claim the identity in the CSR.</p>
</li>
<li><p>The CA generates my certificate and gives it to me.</p>
</li>
</ol>
<p>The CA (or anyone else) never needs to know my private key.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">974 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-csr-api">The CSR API</h2>
<ul>
<li><p>The Kubernetes API has a CertificateSigningRequest resource type</p>
<p>(we can list them with e.g. <code class="remark-inline-code">kubectl get csr</code>)</p>
</li>
<li><p>We can create a CSR object</p>
<p>(= upload a CSR to the Kubernetes API)</p>
</li>
<li><p>Then, using the Kubernetes API, we can approve / deny the request</p>
</li>
<li><p>If we approve the request, the Kubernetes API generates a certificate</p>
</li>
<li><p>The certificate gets attached to the CSR object and can be retrieved</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">975 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-csr-api">Using the CSR API</h2>
<ul>
<li><p>We will show how to use the CSR API to obtain user certificates</p>
</li>
<li><p>This will be a rather complex demo</p>
</li>
<li><p>... And yet, we will take a few shortcuts to simplify it</p>
<p>(but it will illustrate the general idea)</p>
</li>
<li><p>The demo also won't be automated</p>
<p>(we would have to write extra code to make it fully functional)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">976 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="general-idea">General idea</h2>
<ul>
<li><p>We will create a Namespace named "users"</p>
</li>
<li><p>Each user will get a ServiceAccount in that Namespace</p>
</li>
<li><p>That ServiceAccount will give read/write access to <em>one</em> CSR object</p>
</li>
<li><p>Users will use that ServiceAccount's token to submit a CSR</p>
</li>
<li><p>We will approve the CSR (or not)</p>
</li>
<li><p>Users can then retrieve their certificate from their CSR object</p>
</li>
<li><p>... And use that certificate for subsequent interactions</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">977 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="resource-naming">Resource naming</h2>
<p>For a user named <code class="remark-inline-code">jean.doe</code>, we will have:</p>
<ul>
<li><p>ServiceAccount <code class="remark-inline-code">jean.doe</code> in Namespace <code class="remark-inline-code">users</code></p>
</li>
<li><p>CertificateSigningRequest <code class="remark-inline-code">users:jean.doe</code></p>
</li>
<li><p>ClusterRole <code class="remark-inline-code">users:jean.doe</code> giving read/write access to that CSR</p>
</li>
<li><p>ClusterRoleBinding <code class="remark-inline-code">users:jean.doe</code> binding ClusterRole and ServiceAccount</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">978 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-the-user-s-resources">Creating the user's resources</h2>
<p><span class="warning">If you want to use another name than <code class="remark-inline-code">jean.doe</code>, update the YAML file!</span></p>
<div class="exercise"><ul>
<li><p>Create the global namespace for all users:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create namespace users</div></code></pre>
</li>
<li><p>Create the ServiceAccount, ClusterRole, ClusterRoleBinding for <code class="remark-inline-code">jean.doe</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/users:jean.doe.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">979 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="extracting-the-user-s-token">Extracting the user's token</h2>
<ul>
<li><p>Let's obtain the user's token and give it to them</p>
<p>(the token will be their password)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>List the user's secrets:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --namespace=users describe serviceaccount jean.doe</div></code></pre>
</li>
<li><p>Show the user's token:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --namespace=users describe secret <span class="remark-code-span-highlighted">jean.doe-token-xxxxx</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">980 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="configure-kubectl-to-use-the-token">Configure <code class="remark-inline-code">kubectl</code> to use the token</h2>
<ul>
<li>Let's create a new context that will use that token to access the API</li>
</ul>
<div class="exercise"><ul>
<li><p>Add a new identity to our kubeconfig file:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-credentials token:jean.doe --token=...</div></code></pre>
</li>
<li><p>Add a new context using that identity:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-context jean.doe --user=token:jean.doe --cluster=kubernetes</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">981 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="access-the-api-with-the-token">Access the API with the token</h2>
<ul>
<li>Let's check that our access rights are set properly</li>
</ul>
<div class="exercise"><ul>
<li><p>Try to access any resource:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
<p>(This should tell us "Forbidden")</p>
</li>
<li><p>Try to access "our" CertificateSigningRequest:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get csr users:jean.doe</div></code></pre>
<p>(This should tell us "NotFound")</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">982 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="create-a-key-and-a-csr">Create a key and a CSR</h2>
<ul>
<li><p>There are many tools to generate TLS keys and CSRs</p>
</li>
<li><p>Let's use OpenSSL; it's not the best one, but it's installed everywhere</p>
<p>(many people prefer cfssl, easyrsa, or other tools; that's fine too!)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Generate the key and certificate signing request:<pre><code class="bash hljs remark-code"><div class="remark-code-line">openssl req -newkey rsa:2048 -nodes -keyout key.pem \</div><div class="remark-code-line">            -new -subj /CN=jean.doe/O=devs/ -out csr.pem</div></code></pre>
</li>
</ul>
</div>

<p>The command above generates:</p>
<ul>
<li>a 2048-bit RSA key, without DES encryption, stored in key.pem</li>
<li>a CSR for the name <code class="remark-inline-code">jean.doe</code> in group <code class="remark-inline-code">devs</code></li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">983 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="inside-the-kubernetes-csr-object">Inside the Kubernetes CSR object</h2>
<ul>
<li><p>The Kubernetes CSR object is a thin wrapper around the CSR PEM file</p>
</li>
<li><p>The PEM file needs to be encoded to base64 on a single line</p>
<p>(we will use <code class="remark-inline-code">base64 -w0</code> for that purpose)</p>
</li>
<li><p>The Kubernetes CSR object also needs to list the right "usages"</p>
<p>(these are flags indicating how the certificate can be used)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">984 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="sending-the-csr-to-kubernetes">Sending the CSR to Kubernetes</h2>
<div class="exercise"><ul>
<li>Generate and create the CSR resource:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> - &lt;&lt;EOF</div><div class="remark-code-line">apiVersion: certificates.k8s.io/v1beta1</div><div class="remark-code-line">kind: CertificateSigningRequest</div><div class="remark-code-line">metadata:</div><div class="remark-code-line">  name: users:jean.doe</div><div class="remark-code-line">spec:</div><div class="remark-code-line">  request: $(base64 -w0 &lt; csr.pem)</div><div class="remark-code-line">  usages:</div><div class="remark-code-line">  - digital signature</div><div class="remark-code-line">  - key encipherment</div><div class="remark-code-line">  - client auth</div><div class="remark-code-line">EOF</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">985 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adjusting-certificate-expiration">Adjusting certificate expiration</h2>
<ul>
<li><p>By default, the CSR API generates certificates valid 1 year</p>
</li>
<li><p>We want to generate short-lived certificates, so we will lower that to 1 hour</p>
</li>
<li><p>Fow now, this is configured <a href="https://github.com/kubernetes/kubernetes/issues/67324">through an experimental controller manager flag</a></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit the static pod definition for the controller manager:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo vim /etc/kubernetes/manifests/kube-controller-manager.yaml</div></code></pre>
</li>
<li><p>In the list of flags, add the following line:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">- --experimental-cluster-signing-duration=1h</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">986 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="verifying-and-approving-the-csr">Verifying and approving the CSR</h2>
<ul>
<li>Let's inspect the CSR, and if it is valid, approve it</li>
</ul>
<div class="exercise"><ul>
<li><p>Switch back to <code class="remark-inline-code">cluster-admin</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kctx -</div></code></pre>
</li>
<li><p>Inspect the CSR:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl describe csr users:jean.doe</div></code></pre>
</li>
<li><p>Approve it:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl certificate approve users:jean.doe</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">987 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="obtaining-the-certificate">Obtaining the certificate</h2>
<div class="exercise"><ul>
<li><p>Switch back to the user's identity:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kctx -</div></code></pre>
</li>
<li><p>Retrieve the certificate from the CSR:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get csr users:jean.doe \</div><div class="remark-code-line">      -o jsonpath={.status.certificate} \</div><div class="remark-code-line">      | base64 <span class="hljs-_">-d</span> &gt; cert.pem</div></code></pre>
</li>
<li><p>Inspect the certificate:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">openssl x509 -in cert.pem -text -noout</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">988 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-certificate">Using the certificate</h2>
<div class="exercise"><ul>
<li><p>Add the key and certificate to kubeconfig:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-credentials cert:jean.doe --embed-certs \</div><div class="remark-code-line">      --client-certificate=cert.pem --client-key=key.pem</div></code></pre>
</li>
<li><p>Update the user's context to use the key and cert to authenticate:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-context jean.doe --user cert:jean.doe</div></code></pre>
</li>
<li><p>Confirm that we are seen as <code class="remark-inline-code">jean.doe</code> (but don't have permissions):</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">989 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-missing-">What's missing?</h2>
<p>We shown, step by step, a method to issue short-lived certificates for users.</p>
<p>To be usable in real environments, we would need to add:</p>
<ul>
<li><p>a kubectl helper to automatically generate the CSR and obtain the cert</p>
<p>(and transparently renew the cert when needed)</p>
</li>
<li><p>a Kubernetes controller to automatically validate and approve CSRs</p>
<p>(checking that the subject and groups are valid)</p>
</li>
<li><p>a way for the users to know the groups to add to their CSR</p>
<p>(e.g.: annotations on their ServiceAccount + read access to the ServiceAccount)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">990 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="is-this-realistic-">Is this realistic?</h2>
<ul>
<li><p>Larger organizations typically integrate with their own directory</p>
</li>
<li><p>The general principle, however, is the same:</p>
<ul>
<li><p>users have long-term credentials (password, token, ...)</p>
</li>
<li><p>they use these credentials to obtain other, short-lived credentials</p>
</li>
</ul>
</li>
<li><p>This provides enhanced security:</p>
<ul>
<li><p>the long-term credentials can use long passphrases, 2FA, HSM ...</p>
</li>
<li><p>the short-term credentials are more convenient to use</p>
</li>
<li><p>we get strong security <em>and</em> convenience</p>
</li>
</ul>
</li>
<li><p>Systems like Vault also have certificate issuance mechanisms</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/csr-api.md">k8s/csr-api.md</a></span></p><div class="remark-slide-number">991 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/plastic-containers.JPG" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">992 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-openid-connect" class="remark-slide-content title hljs-default"><p>OpenID Connect</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-the-csr-api">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-13">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-securing-the-control-plane">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">993 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="openid-connect">OpenID Connect</h1>
<ul>
<li><p>The Kubernetes API server can perform authentication with OpenID connect</p>
</li>
<li><p>This requires an <em>OpenID provider</em></p>
<p>(external authorization server using the OAuth 2.0 protocol)</p>
</li>
<li><p>We can use a third-party provider (e.g. Google) or run our own (e.g. Dex)</p>
</li>
<li><p>We are going to give an overview of the protocol</p>
</li>
<li><p>We will show it in action (in a simplified scenario)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">994 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="workflow-overview">Workflow overview</h2>
<ul>
<li><p>We want to access our resources (a Kubernetes cluster)</p>
</li>
<li><p>We authenticate with the OpenID provider</p>
<ul>
<li><p>we can do this directly (e.g. by going to <a href="https://accounts.google.com/">https://accounts.google.com</a>)</p>
</li>
<li><p>or maybe a kubectl plugin can open a browser page on our behalf</p>
</li>
</ul>
</li>
<li><p>After authenticating us, the OpenID provider gives us:</p>
<ul>
<li><p>an <em>id token</em> (a short-lived signed JSON Web Token, see next slide)</p>
</li>
<li><p>a <em>refresh token</em> (to renew the previous one when needed)</p>
</li>
</ul>
</li>
<li><p>We can now issue requests to the Kubernetes API with the <em>id token</em></p>
</li>
<li><p>The API server will verify that token's content to authenticate us</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">995 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="json-web-tokens">JSON Web Tokens</h2>
<ul>
<li><p>A JSON Web Token (JWT) has three parts:</p>
<ul>
<li><p>a header specifying algorithms and token type</p>
</li>
<li><p>a payload (indicating who issued the token, for whom, which purposes...)</p>
</li>
<li><p>a signature generated by the issuer (the issuer = the OpenID provider)</p>
</li>
</ul>
</li>
<li><p>Anyone can verify a JWT without contacting the issuer</p>
<p>(except to obtain the issuer's public key)</p>
</li>
<li><p>Pro tip: we can inspect a JWT with <a href="https://jwt.io/">https://jwt.io/</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">996 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-the-kubernetes-api-uses-jwt">How the Kubernetes API uses JWT</h2>
<ul>
<li><p>Server side</p>
<ul>
<li><p>enable OIDC authentication</p>
</li>
<li><p>indicate which issuer (provider) should be allowed</p>
</li>
<li><p>indicate which audience (or "client id") should be allowed</p>
</li>
<li><p>if necessary, map or prefix user and group names</p>
</li>
</ul>
</li>
<li><p>Client side</p>
<ul>
<li><p>obtain JWT as described earlier</p>
</li>
<li><p>pass JWT as authentication token</p>
</li>
<li><p>renew JWT when needed (using the refresh token)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">997 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="demo-time-">Demo time!</h2>
<ul>
<li><p>We will use <a href="https://accounts.google.com/">Google Accounts</a> as our OpenID provider</p>
</li>
<li><p>We will use the <a href="https://developers.google.com/oauthplayground">Google OAuth Playground</a> as the "audience" or "client id"</p>
</li>
<li><p>We will obtain a JWT through Google Accounts and the OAuth Playground</p>
</li>
<li><p>We will enable OIDC in the Kubernetes API server</p>
</li>
<li><p>We will use the JWT to authenticate</p>
</li>
</ul>
<p><span class="footnote">If you can't or won't use a Google Account, you can try to adapt to another provider.</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">998 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-the-api-server-logs">Checking the API server logs</h2>
<ul>
<li><p>The API server logs will be particularly useful in this section</p>
<p>(they will indicate e.g. why a specific token is rejected)</p>
</li>
<li><p>Let's keep an eye on the API server output!</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Tail the logs of the API server:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl logs kube-apiserver-node1 --follow --namespace=kube-system</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">999 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authenticate-with-the-openid-provider">Authenticate with the OpenID provider</h2>
<ul>
<li><p>We will use the Google OAuth Playground for convenience</p>
</li>
<li><p>In a real scenario, we would need our own OAuth client instead of the playground</p>
<p>(even if we were still using Google as the OpenID provider)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Open the Google OAuth Playground:</p>
<pre><code class="remark-code"><div class="remark-code-line">https://developers.google.com/oauthplayground/</div></code></pre></li>
<li><p>Enter our own custom scope in the text field:</p>
<pre><code class="remark-code"><div class="remark-code-line">https://www.googleapis.com/auth/userinfo.email</div></code></pre></li>
<li><p>Click on "Authorize APIs" and allow the playground to access our email address</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1000 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="obtain-our-json-web-token">Obtain our JSON Web Token</h2>
<ul>
<li><p>The previous step gave us an "authorization code"</p>
</li>
<li><p>We will use it to obtain tokens</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Click on "Exchange authorization code for tokens"</li>
</ul>
</div>

<ul>
<li><p>The JWT is the very long <code class="remark-inline-code">id_token</code> that shows up on the right hand side</p>
<p>(it is a base64-encoded JSON object, and should therefore start with <code class="remark-inline-code">eyJ</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1001 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-our-json-web-token">Using our JSON Web Token</h2>
<ul>
<li><p>We need to create a context (in kubeconfig) for our token</p>
<p>(if we just add the token or use <code class="remark-inline-code">kubectl --token</code>, our certificate will still be used)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a new authentication section in kubeconfig:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-credentials myjwt --token=eyJ...</div></code></pre>
</li>
<li><p>Try to use it:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --user=myjwt get nodes</div></code></pre>
</li>
</ul>
</div>

<p>We should get an <code class="remark-inline-code">Unauthorized</code> response, since we haven't enabled OpenID Connect in the API server yet. We should also see <code class="remark-inline-code">invalid bearer token</code> in the API server log output.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1002 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="enabling-openid-connect">Enabling OpenID Connect</h2>
<ul>
<li><p>We need to add a few flags to the API server configuration</p>
</li>
<li><p>These two are mandatory:</p>
<p><code class="remark-inline-code">--oidc-issuer-url</code> → URL of the OpenID provider</p>
<p><code class="remark-inline-code">--oidc-client-id</code> → app requesting the authentication
<br>(in our case, that's the ID for the Google OAuth Playground)</p>
</li>
<li><p>This one is optional:</p>
<p><code class="remark-inline-code">--oidc-username-claim</code> → which field should be used as user name
<br>(we will use the user's email address instead of an opaque ID)</p>
</li>
<li><p>See the <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#configuring-the-api-server">API server documentation</a> for more details about all available flags</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1003 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-api-server-configuration">Updating the API server configuration</h2>
<ul>
<li><p>The instructions below will work for clusters deployed with kubeadm</p>
<p>(or where the control plane is deployed in static pods)</p>
</li>
<li><p>If your cluster is different, you will need to adapt them</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit <code class="remark-inline-code">/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
</li>
<li><p>Add the following lines to the list of command-line flags:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-bullet">-</span> --oidc-issuer-url=https://accounts.google.com</div><div class="remark-code-line"><span class="hljs-bullet">-</span> --oidc-client-id=<span class="hljs-number">407408718192.</span>apps.googleusercontent.com</div><div class="remark-code-line"><span class="hljs-bullet">-</span> --oidc-username-claim=email</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1004 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="restarting-the-api-server">Restarting the API server</h2>
<ul>
<li><p>The kubelet monitors the files in <code class="remark-inline-code">/etc/kubernetes/manifests</code></p>
</li>
<li><p>When we save the pod manifest, kubelet will restart the corresponding pod</p>
<p>(using the updated command line flags)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>After making the changes described on the previous slide, save the file</p>
</li>
<li><p>Issue a simple command (like <code class="remark-inline-code">kubectl version</code>) until the API server is back up</p>
<p>(it might take between a few seconds and one minute for the API server to restart)</p>
</li>
<li><p>Restart the <code class="remark-inline-code">kubectl logs</code> command to view the logs of the API server</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1005 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-our-json-web-token">Using our JSON Web Token</h2>
<ul>
<li>Now that the API server is set up to recognize our token, try again!</li>
</ul>
<div class="exercise"><ul>
<li>Try an API command with our token:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --user=myjwt get nodes</div><div class="remark-code-line">kubectl --user=myjwt get pods</div></code></pre>
</li>
</ul>
</div>

<p>We should see a message like:</p>
<pre><code class="remark-code"><div class="remark-code-line">Error from server (Forbidden): nodes is forbidden: User "jean.doe@gmail.com"</div><div class="remark-code-line">cannot list resource "nodes" in API group "" at the cluster scope</div></code></pre><p>→ We were successfully <em>authenticated</em>, but not <em>authorized</em>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1006 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authorizing-our-user">Authorizing our user</h2>
<ul>
<li><p>As an extra step, let's grant read access to our user</p>
</li>
<li><p>We will use the pre-defined ClusterRole <code class="remark-inline-code">view</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a ClusterRoleBinding allowing us read access to the cluster:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create clusterrolebinding i-can-view \</div><div class="remark-code-line">        --user=<span class="remark-code-span-highlighted">jean.doe@gmail.com</span> --clusterrole=view</div></code></pre>
</li>
<li><p>Confirm that we can now list pods with our token:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl --user=myjwt get pods</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1007 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="from-demo-to-production">From demo to production</h2>
<p><span class="warning">This was a very simplified demo! In a real deployment...</span></p>
<ul>
<li><p>We wouldn't use the Google OAuth Playground</p>
</li>
<li><p>We <em>probably</em> wouldn't even use Google at all</p>
<p>(it doesn't seem to provide a way to include groups!)</p>
</li>
<li><p>Some popular alternatives:</p>
<ul>
<li><p><a href="https://github.com/dexidp/dex">Dex</a>,
<a href="https://www.keycloak.org/">Keycloak</a>
(self-hosted)</p>
</li>
<li><p><a href="https://developer.okta.com/docs/how-to/creating-token-with-groups-claim/#step-five-decode-the-jwt-to-verify">Okta</a>
(SaaS)</p>
</li>
</ul>
</li>
<li><p>We would use a helper (like the <a href="https://github.com/int128/kubelogin">kubelogin</a> plugin) to automatically obtain tokens</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1008 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="service-account-tokens">Service Account tokens</h2>
<ul>
<li><p>The tokens used by Service Accounts are JWT tokens as well</p>
</li>
<li><p>They are signed and verified using a special service account key pair</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Extract the token of a service account in the current namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get secrets -o jsonpath={..token} | base64 <span class="hljs-_">-d</span></div></code></pre>
</li>
<li><p>Copy-paste the token to a verification service like <a href="https://jwt.io/">https://jwt.io</a> </p>
</li>
<li><p>Notice that it says "Invalid Signature"</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1009 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="verifying-service-account-tokens">Verifying Service Account tokens</h2>
<ul>
<li><p>JSON Web Tokens embed the URL of the "issuer" (=OpenID provider)</p>
</li>
<li><p>The issuer provides its public key through a well-known discovery endpoint</p>
<p>(similar to <a href="https://accounts.google.com/.well-known/openid-configuration">https://accounts.google.com/.well-known/openid-configuration</a>)</p>
</li>
<li><p>There is no such endpoint for the Service Account key pair</p>
</li>
<li><p>But we can provide the public key ourselves for verification</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1010 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="verifying-a-service-account-token">Verifying a Service Account token</h2>
<ul>
<li><p>On clusters provisioned with kubeadm, the Service Account key pair is:</p>
<p><code class="remark-inline-code">/etc/kubernetes/pki/sa.key</code> (used by the controller manager to generate tokens)</p>
<p><code class="remark-inline-code">/etc/kubernetes/pki/sa.pub</code> (used by the API server to validate the same tokens)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Display the public key used to sign Service Account tokens:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo cat /etc/kubernetes/pki/sa.pub</div></code></pre>
</li>
<li><p>Copy-paste the key in the "verify signature" area on <a href="https://jwt.io/">https://jwt.io</a></p>
</li>
<li><p>It should now say "Signature Verified"</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/openid-connect.md">k8s/openid-connect.md</a></span></p><div class="remark-slide-number">1011 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-1.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1012 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-securing-the-control-plane" class="remark-slide-content title hljs-default"><p>Securing the control plane</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-openid-connect">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-14">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-tls-bootstrap-extra-material">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1013 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="securing-the-control-plane">Securing the control plane</h1>
<ul>
<li><p>Many components accept connections (and requests) from others:</p>
<ul>
<li><p>API server</p>
</li>
<li><p>etcd</p>
</li>
<li><p>kubelet</p>
</li>
</ul>
</li>
<li><p>We must secure these connections:</p>
<ul>
<li><p>to deny unauthorized requests</p>
</li>
<li><p>to prevent eavesdropping secrets, tokens, and other sensitive information</p>
</li>
</ul>
</li>
<li><p>Disabling authentication and/or authorization is <strong>strongly discouraged</strong></p>
<p>(but it's possible to do it, e.g. for learning / troubleshooting purposes)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1014 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authentication-and-authorization">Authentication and authorization</h2>
<ul>
<li><p>Authentication (checking "who you are") is done with mutual TLS</p>
<p>(both the client and the server need to hold a valid certificate)</p>
</li>
<li><p>Authorization (checking "what you can do") is done in different ways</p>
<ul>
<li><p>the API server implements a sophisticated permission logic (with RBAC)</p>
</li>
<li><p>some services will defer authorization to the API server (through webhooks)</p>
</li>
<li><p>some services require a certificate signed by a particular CA / sub-CA</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1015 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="in-practice">In practice</h2>
<ul>
<li><p>We will review the various communication channels in the control plane</p>
</li>
<li><p>We will describe how they are secured</p>
</li>
<li><p>When TLS certificates are used, we will indicate:</p>
<ul>
<li><p>which CA signs them</p>
</li>
<li><p>what their subject (CN) should be, when applicable</p>
</li>
</ul>
</li>
<li><p>We will indicate how to configure security (client- and server-side)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1016 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="etcd-peers">etcd peers</h2>
<ul>
<li><p>Replication and coordination of etcd happens on a dedicated port</p>
<p>(typically port 2380; the default port for normal client connections is 2379)</p>
</li>
<li><p>Authentication uses TLS certificates with a separate sub-CA</p>
<p>(otherwise, anyone with a Kubernetes client certificate could access etcd!)</p>
</li>
<li><p>The etcd command line flags involved are:</p>
<p><code class="remark-inline-code">--peer-client-cert-auth=true</code> to activate it</p>
<p><code class="remark-inline-code">--peer-cert-file</code>, <code class="remark-inline-code">--peer-key-file</code>, <code class="remark-inline-code">--peer-trusted-ca-file</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1017 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="etcd-clients">etcd clients</h2>
<ul>
<li><p>The only¹ thing that connects to etcd is the API server</p>
</li>
<li><p>Authentication uses TLS certificates with a separate sub-CA</p>
<p>(for the same reasons as for etcd inter-peer authentication)</p>
</li>
<li><p>The etcd command line flags involved are:</p>
<p><code class="remark-inline-code">--client-cert-auth=true</code> to activate it</p>
<p><code class="remark-inline-code">--trusted-ca-file</code>, <code class="remark-inline-code">--cert-file</code>, <code class="remark-inline-code">--key-file</code></p>
</li>
<li><p>The API server command line flags involved are:</p>
<p><code class="remark-inline-code">--etcd-cafile</code>, <code class="remark-inline-code">--etcd-certfile</code>, <code class="remark-inline-code">--etcd-keyfile</code></p>
</li>
</ul>
<p><span class="footnote">¹Technically, there is also the etcd healthcheck. Let's ignore it for now.</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1018 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="api-server-clients">API server clients</h2>
<ul>
<li><p>The API server has a sophisticated authentication and authorization system</p>
</li>
<li><p>For connections coming from other components of the control plane:</p>
<ul>
<li><p>authentication uses certificates (trusting the certificates' subject or CN)</p>
</li>
<li><p>authorization uses whatever mechanism is enabled (most oftentimes, RBAC)</p>
</li>
</ul>
</li>
<li><p>The relevant API server flags are:</p>
<p><code class="remark-inline-code">--client-ca-file</code>, <code class="remark-inline-code">--tls-cert-file</code>, <code class="remark-inline-code">--tls-private-key-file</code></p>
</li>
<li><p>Each component connecting to the API server takes a <code class="remark-inline-code">--kubeconfig</code> flag</p>
<p>(to specify a kubeconfig file containing the CA cert, client key, and client cert)</p>
</li>
<li><p>Yes, that kubeconfig file follows the same format as our <code class="remark-inline-code">~/.kube/config</code> file!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1019 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubelet-and-api-server">Kubelet and API server</h2>
<ul>
<li><p>Communication between kubelet and API server can be established both ways</p>
</li>
<li><p>Kubelet → API server:</p>
<ul>
<li><p>kubelet registers itself ("hi, I'm node42, do you have work for me?")</p>
</li>
<li><p>connection is kept open and re-established if it breaks</p>
</li>
<li><p>that's how the kubelet knows which pods to start/stop</p>
</li>
</ul>
</li>
<li><p>API server → kubelet:</p>
<ul>
<li>used to retrieve logs, exec, attach to containers</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1020 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kubelet-api-server">Kubelet → API server</h2>
<ul>
<li><p>Kubelet is started with <code class="remark-inline-code">--kubeconfig</code> with API server information</p>
</li>
<li><p>The client certificate of the kubelet will typically have:</p>
<p><code class="remark-inline-code">CN=system:node:&lt;nodename&gt;</code> and groups <code class="remark-inline-code">O=system:nodes</code></p>
</li>
<li><p>Nothing special on the API server side</p>
<p>(it will authenticate like any other client)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1021 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="api-server-kubelet">API server → kubelet</h2>
<ul>
<li><p>Kubelet is started with the flag <code class="remark-inline-code">--client-ca-file</code></p>
<p>(typically using the same CA as the API server)</p>
</li>
<li><p>API server will use a dedicated key pair when contacting kubelet</p>
<p>(specified with <code class="remark-inline-code">--kubelet-client-certificate</code> and <code class="remark-inline-code">--kubelet-client-key</code>)</p>
</li>
<li><p>Authorization uses webhooks</p>
<p>(enabled with <code class="remark-inline-code">--authorization-mode=Webhook</code> on kubelet)</p>
</li>
<li><p>The webhook server is the API server itself</p>
<p>(the kubelet sends back a request to the API server to ask, "can this person do that?")</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1022 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="scheduler">Scheduler</h2>
<ul>
<li><p>The scheduler connects to the API server like an ordinary client</p>
</li>
<li><p>The certificate of the scheduler will have <code class="remark-inline-code">CN=system:kube-scheduler</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1023 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="controller-manager">Controller manager</h2>
<ul>
<li><p>The controller manager is also a normal client to the API server</p>
</li>
<li><p>Its certificate will have <code class="remark-inline-code">CN=system:kube-controller-manager</code></p>
</li>
<li><p>If we use the CSR API, the controller manager needs the CA cert and key</p>
<p>(passed with flags <code class="remark-inline-code">--cluster-signing-cert-file</code> and <code class="remark-inline-code">--cluster-signing-key-file</code>)</p>
</li>
<li><p>We usually want the controller manager to generate tokens for service accounts</p>
</li>
<li><p>These tokens deserve some details (on the next slide!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1024 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="service-account-tokens">Service account tokens</h2>
<ul>
<li><p>Each time we create a service account, the controller manager generates a token</p>
</li>
<li><p>These tokens are JWT tokens, signed with a particular key</p>
</li>
<li><p>These tokens are used for authentication with the API server</p>
<p>(and therefore, the API server needs to be able to verify their integrity)</p>
</li>
<li><p>This uses another keypair:</p>
<ul>
<li><p>the private key (used for signature) is passed to the controller manager
<br>(using flags <code class="remark-inline-code">--service-account-private-key-file</code> and <code class="remark-inline-code">--root-ca-file</code>)</p>
</li>
<li><p>the public key (used for verification) is passed to the API server
<br>(using flag <code class="remark-inline-code">--service-account-key-file</code>)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1025 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="kube-proxy">kube-proxy</h2>
<ul>
<li><p>kube-proxy is "yet another API server client"</p>
</li>
<li><p>In many clusters, it runs as a Daemon Set</p>
</li>
<li><p>In that case, it will have its own Service Account and associated permissions</p>
</li>
<li><p>It will authenticate using the token of that Service Account</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1026 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="webhooks">Webhooks</h2>
<ul>
<li><p>We mentioned webhooks earlier; how does that really work?</p>
</li>
<li><p>The Kubernetes API has special resource types to check permissions</p>
</li>
<li><p>One of them is SubjectAccessReview</p>
</li>
<li><p>To check if a particular user can do a particular action on a particular resource:</p>
<ul>
<li><p>we prepare a SubjectAccessReview object</p>
</li>
<li><p>we send that object to the API server</p>
</li>
<li><p>the API server responds with allow/deny (and optional explanations)</p>
</li>
</ul>
</li>
<li><p>Using webhooks for authorization = sending SAR to authorize each request</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1027 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="subject-access-review">Subject Access Review</h2>
<p>Here is an example showing how to check if <code class="remark-inline-code">jean.doe</code> can <code class="remark-inline-code">get</code> some <code class="remark-inline-code">pods</code> in <code class="remark-inline-code">kube-system</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl -v9 create <span class="hljs-_">-f</span>- &lt;&lt;EOF</div><div class="remark-code-line">apiVersion: authorization.k8s.io/v1beta1</div><div class="remark-code-line">kind: SubjectAccessReview</div><div class="remark-code-line">spec:</div><div class="remark-code-line">  user: jean.doe</div><div class="remark-code-line">  group:</div><div class="remark-code-line">  - foo</div><div class="remark-code-line">  - bar</div><div class="remark-code-line">  resourceAttributes:</div><div class="remark-code-line">    <span class="hljs-comment">#group: blah.k8s.io</span></div><div class="remark-code-line">    namespace: kube-system</div><div class="remark-code-line">    resource: pods</div><div class="remark-code-line">    verb: get</div><div class="remark-code-line">    <span class="hljs-comment">#name: web-xyz1234567-pqr89</span></div><div class="remark-code-line">EOF</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/control-plane-auth.md">k8s/control-plane-auth.md</a></span></p><div class="remark-slide-number">1028 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/train-of-containers-2.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1029 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-tls-bootstrap-extra-material" class="remark-slide-content title hljs-default"><p>TLS bootstrap (extra material)</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-securing-the-control-plane">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-14">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-network-policies">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1030 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="tls-bootstrap-extra-material-">TLS bootstrap (extra material)</h1>
<ul>
<li><p>kubelet needs TLS keys and certificates to communicate with the control plane</p>
</li>
<li><p>How do we generate this information?</p>
</li>
<li><p>How do we make it available to kubelet?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1031 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-1-push">Option 1: push</h2>
<ul>
<li><p>When we want to provision a node:</p>
<ul>
<li><p>generate its keys, certificate, and sign centrally</p>
</li>
<li><p>push the files to the node</p>
</li>
</ul>
</li>
<li><p>OK for "traditional", on-premises deployments</p>
</li>
<li><p>Not OK for cloud deployments with auto-scaling</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1032 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-2-poll-push">Option 2: poll + push</h2>
<ul>
<li><p>Discover nodes when they are created</p>
<p>(e.g. with cloud API)</p>
</li>
<li><p>When we detect a new node, push TLS material to the node</p>
<p>(like in option 1)</p>
</li>
<li><p>It works, but:</p>
<ul>
<li><p>discovery code is specific to each provider</p>
</li>
<li><p>relies heavily on the cloud provider API</p>
</li>
<li><p>doesn't work on-premises</p>
</li>
<li><p>doesn't scale</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1033 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="option-3-bootstrap-tokens-csr-api">Option 3: bootstrap tokens + CSR API</h2>
<ul>
<li><p>Since Kubernetes 1.4, the Kubernetes API supports CSR</p>
<p>(Certificate Signing Requests)</p>
</li>
<li><p>This is similar to the protocol used to obtain e.g. HTTPS certificates:</p>
<ul>
<li><p>subject (here, kubelet) generates TLS keys and CSR</p>
</li>
<li><p>subject submits CSR to CA</p>
</li>
<li><p>CA validates (or not) the CSR</p>
</li>
<li><p>CA sends back signed certificate to subject</p>
</li>
</ul>
</li>
<li><p>This is combined with <em>bootstrap tokens</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1034 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bootstrap-tokens">Bootstrap tokens</h2>
<ul>
<li><p>A <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/">bootstrap token</a> is an API access token</p>
<ul>
<li><p>it is a Secret with type <code class="remark-inline-code">bootstrap.kubernetes.io/token</code></p>
</li>
<li><p>it is 6 public characters (ID) + 16 secret characters
<br>(example: <code class="remark-inline-code">whd3pq.d1ushuf6ccisjacu</code>)</p>
</li>
<li><p>it gives access to groups <code class="remark-inline-code">system:bootstrap:&lt;ID&gt;</code> and <code class="remark-inline-code">system:bootstrappers</code></p>
</li>
<li><p>additional groups can be specified in the Secret</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1035 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bootstrap-tokens-with-kubeadm">Bootstrap tokens with kubeadm</h2>
<ul>
<li><p>kubeadm automatically creates a bootstrap token</p>
<p>(it is shown at the end of <code class="remark-inline-code">kubeadm init</code>)</p>
</li>
<li><p>That token adds the group <code class="remark-inline-code">system:bootstrappers:kubeadm:default-node-token</code></p>
</li>
<li><p>kubeadm also creates a ClusterRoleBinding <code class="remark-inline-code">kubeadm:kubelet-bootstrap</code>
<br>binding <code class="remark-inline-code">...:default-node-token</code> to ClusterRole <code class="remark-inline-code">system:node-bootstrapper</code></p>
</li>
<li><p>That ClusterRole gives create/get/list/watch permissions on the CSR API</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1036 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bootstrap-tokens-in-practice">Bootstrap tokens in practice</h2>
<ul>
<li>Let's list our bootstrap tokens on a cluster created with kubeadm</li>
</ul>
<div class="exercise"><ul>
<li><p>Log into node <code class="remark-inline-code">test1</code></p>
</li>
<li><p>View bootstrap tokens:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo kubeadm token list</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>Tokens are short-lived</p>
</li>
<li><p>We can create new tokens with <code class="remark-inline-code">kubeadm</code> if necessary</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1037 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="retrieving-bootstrap-tokens-with-kubectl">Retrieving bootstrap tokens with kubectl</h2>
<ul>
<li><p>Bootstrap tokens are Secrets with type <code class="remark-inline-code">bootstrap.kubernetes.io/token</code></p>
</li>
<li><p>Token ID and secret are in data fields <code class="remark-inline-code">token-id</code> and <code class="remark-inline-code">token-secret</code></p>
</li>
<li><p>In Secrets, data fields are encoded with Base64</p>
</li>
<li><p>This "very simple" command will show us the tokens:</p>
</li>
</ul>
<pre><code class="remark-code"><div class="remark-code-line">kubectl -n kube-system get secrets -o json | </div><div class="remark-code-line">        jq -r '.items[] </div><div class="remark-code-line">        | select(.type=="bootstrap.kubernetes.io/token")</div><div class="remark-code-line">        | ( .data["token-id"] + "Lg==" + .data["token-secret"] + "Cg==")</div><div class="remark-code-line">        ' | base64 -d</div></code></pre><p>(On recent versions of <code class="remark-inline-code">jq</code>, you can simplify by using filter <code class="remark-inline-code">@base64d</code>.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1038 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="using-a-bootstrap-token">Using a bootstrap token</h2>
<ul>
<li>The token we need to use has the form <code class="remark-inline-code">abcdef.1234567890abcdef</code></li>
</ul>
<div class="exercise"><ul>
<li><p>Check that it is accepted by the API server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k -H <span class="hljs-string">"Authorization: Bearer abcdef.1234567890abcdef"</span></div></code></pre>
</li>
<li><p>We should see that we are <em>authenticated</em> but not <em>authorized</em>:</p>
<pre><code class="remark-code"><div class="remark-code-line">User \"system:bootstrap:abcdef\" cannot get path \"/\""</div></code></pre></li>
<li><p>Check that we can access the CSR API:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k -H <span class="hljs-string">"Authorization: Bearer abcdef.1234567890abcdef"</span> \</div><div class="remark-code-line">   https://10.96.0.1/apis/certificates.k8s.io/v1beta1/certificatesigningrequests</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1039 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-cluster-info-configmap">The cluster-info ConfigMap</h2>
<ul>
<li><p>Before we can talk to the API, we need:</p>
<ul>
<li><p>the API server address (obviously!)</p>
</li>
<li><p>the cluster CA certificate</p>
</li>
</ul>
</li>
<li><p>That information is stored in a public ConfigMap</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Retrieve that ConfigMap:<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl -k https://10.96.0.1/api/v1/namespaces/kube-public/configmaps/cluster-info</div></code></pre>
</li>
</ul>
</div>

<p><em>Extracting the kubeconfig file is left as an exercise for the reader.</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1040 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="signature-of-the-config-map">Signature of the config-map</h2>
<ul>
<li><p>You might have noticed a few <code class="remark-inline-code">jws-kubeconfig-...</code> fields</p>
</li>
<li><p>These are config-map signatures</p>
<p>(so that the client can protect against MITM attacks)</p>
</li>
<li><p>These are JWS signatures using HMAC-SHA256</p>
<p>(see <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#configmap-signing">here</a> for more details)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1041 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="putting-it-all-together">Putting it all together</h2>
<p>This is the TLS bootstrap mechanism, step by step.</p>
<ul>
<li><p>The node uses the cluster-info ConfigMap to get the cluster CA certificate</p>
</li>
<li><p>The node generates its keys and CSR</p>
</li>
<li><p>Using the bootstrap token, the node creates a CertificateSigningRequest object</p>
</li>
<li><p>The node watches the CSR object</p>
</li>
<li><p>The CSR object is accepted (automatically or by an admin)</p>
</li>
<li><p>The node gets notified, and retrieves the certificate</p>
</li>
<li><p>The node can now join the cluster</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1042 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bottom-line">Bottom line</h2>
<ul>
<li><p>If you paid attention, we still need a way to:</p>
<ul>
<li><p>either safely get the bootstrap token to the nodes</p>
</li>
<li><p>or disable auto-approval and manually approve the nodes when they join</p>
</li>
</ul>
</li>
<li><p>The goal of the TLS bootstrap mechanism is <em>not</em> to solve this</p>
<p>(in terms of information knowledge, it's fundamentally impossible!)</p>
</li>
<li><p>But it reduces the differences between environments, infrastructures, providers ...</p>
</li>
<li><p>It gives a mechanism that is easier to use, and flexible enough, for most scenarios</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1043 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-information">More information</h2>
<ul>
<li><p>As always, the Kubernetes documentation has extra details:</p>
<ul>
<li><p><a href="https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/">TLS management</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/">Authenticating with bootstrap tokens</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/">TLS bootstrapping</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-token/">kubeadm token</a> command</p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/">kubeadm join</a> command (has details about <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/#join-workflow">the join workflow</a>)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/bootstrap.md">k8s/bootstrap.md</a></span></p><div class="remark-slide-number">1044 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/two-containers-on-a-truck.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1045 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-network-policies" class="remark-slide-content title hljs-default"><p>Network policies</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-tls-bootstrap-extra-material">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-14">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-pod-security-policies">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1046 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="network-policies">Network policies</h1>
<ul>
<li><p>Namespaces help us to <em>organize</em> resources</p>
</li>
<li><p>Namespaces do not provide isolation</p>
</li>
<li><p>By default, every pod can contact every other pod</p>
</li>
<li><p>By default, every service accepts traffic from anyone</p>
</li>
<li><p>If we want this to be different, we need <em>network policies</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1047 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-a-network-policy-">What's a network policy?</h2>
<p>A network policy is defined by the following things.</p>
<ul>
<li><p>A <em>pod selector</em> indicating which pods it applies to</p>
<p>e.g.: "all pods in namespace <code class="remark-inline-code">blue</code> with the label <code class="remark-inline-code">zone=internal</code>"</p>
</li>
<li><p>A list of <em>ingress rules</em> indicating which inbound traffic is allowed</p>
<p>e.g.: "TCP connections to ports 8000 and 8080 coming from pods with label <code class="remark-inline-code">zone=dmz</code>,
and from the external subnet 4.42.6.0/24, except 4.42.6.5"</p>
</li>
<li><p>A list of <em>egress rules</em> indicating which outbound traffic is allowed</p>
</li>
</ul>
<p>A network policy can provide ingress rules, egress rules, or both.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1048 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-do-network-policies-apply-">How do network policies apply?</h2>
<ul>
<li><p>A pod can be "selected" by any number of network policies</p>
</li>
<li><p>If a pod isn't selected by any network policy, then its traffic is unrestricted</p>
<p>(In other words: in the absence of network policies, all traffic is allowed)</p>
</li>
<li><p>If a pod is selected by at least one network policy, then all traffic is blocked ...</p>
<p>... unless it is explicitly allowed by one of these network policies</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1049 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="traffic-filtering-is-flow-oriented">Traffic filtering is flow-oriented</h2>
<ul>
<li><p>Network policies deal with <em>connections</em>, not individual packets</p>
</li>
<li><p>Example: to allow HTTP (80/tcp) connections to pod A, you only need an ingress rule</p>
<p>(You do not need a matching egress rule to allow response traffic to go through)</p>
</li>
<li><p>This also applies for UDP traffic</p>
<p>(Allowing DNS traffic can be done with a single rule)</p>
</li>
<li><p>Network policy implementations use stateful connection tracking</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1050 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pod-to-pod-traffic">Pod-to-pod traffic</h2>
<ul>
<li><p>Connections from pod A to pod B have to be allowed by both pods:</p>
<ul>
<li><p>pod A has to be unrestricted, or allow the connection as an <em>egress</em> rule</p>
</li>
<li><p>pod B has to be unrestricted, or allow the connection as an <em>ingress</em> rule</p>
</li>
</ul>
</li>
<li><p>As a consequence: if a network policy restricts traffic going from/to a pod,
<br>
the restriction cannot be overridden by a network policy selecting another pod</p>
</li>
<li><p>This prevents an entity managing network policies in namespace A
(but without permission to do so in namespace B)
from adding network policies giving them access to namespace B</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1051 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-rationale-for-network-policies">The rationale for network policies</h2>
<ul>
<li><p>In network security, it is generally considered better to "deny all, then allow selectively"</p>
<p>(The other approach, "allow all, then block selectively" makes it too easy to leave holes)</p>
</li>
<li><p>As soon as one network policy selects a pod, the pod enters this "deny all" logic</p>
</li>
<li><p>Further network policies can open additional access</p>
</li>
<li><p>Good network policies should be scoped as precisely as possible</p>
</li>
<li><p>In particular: make sure that the selector is not too broad</p>
<p>(Otherwise, you end up affecting pods that were otherwise well secured)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1052 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-first-network-policy">Our first network policy</h2>
<p>This is our game plan:</p>
<ul>
<li><p>run a web server in a pod</p>
</li>
<li><p>create a network policy to block all access to the web server</p>
</li>
<li><p>create another network policy to allow access only from specific pods</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1053 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-our-test-web-server">Running our test web server</h2>
<div class="exercise"><ul>
<li><p>Let's use the <code class="remark-inline-code">nginx</code> image:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment testweb --image=nginx</div></code></pre>
</li>
<li><p>Find out the IP address of the pod with one of these two commands:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide <span class="hljs-_">-l</span> app=testweb</div><div class="remark-code-line">IP=$(kubectl get pods <span class="hljs-_">-l</span> app=testweb -o json | jq -r .items[0].status.podIP)</div></code></pre>
</li>
<li><p>Check that we can connect to the server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="hljs-variable">$IP</span></div></code></pre>
</li>
</ul>
</div>

<p>The <code class="remark-inline-code">curl</code> command should show us the "Welcome to nginx!" page.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1054 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-a-very-restrictive-network-policy">Adding a very restrictive network policy</h2>
<ul>
<li><p>The policy will select pods with the label <code class="remark-inline-code">app=testweb</code></p>
</li>
<li><p>It will specify an empty list of ingress rules (matching nothing)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Apply the policy in this YAML file:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/netpol-deny-all-for-testweb.yaml</div></code></pre>
</li>
<li><p>Check if we can still access the server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">curl <span class="hljs-variable">$IP</span></div></code></pre>
</li>
</ul>
</div>

<p>The <code class="remark-inline-code">curl</code> command should now time out.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1055 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="looking-at-the-network-policy">Looking at the network policy</h2>
<p>This is the file that we applied:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">kind:</span> NetworkPolicy</div><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> networking.k8s.io/v1</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> deny-all-for-testweb</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  podSelector:</span></div><div class="remark-code-line"><span class="hljs-attr">    matchLabels:</span></div><div class="remark-code-line"><span class="hljs-attr">      app:</span> testweb</div><div class="remark-code-line"><span class="hljs-attr">  ingress:</span> []</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1056 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="allowing-connections-only-from-specific-pods">Allowing connections only from specific pods</h2>
<ul>
<li><p>We want to allow traffic from pods with the label <code class="remark-inline-code">run=testcurl</code></p>
</li>
<li><p>Reminder: this label is automatically applied when we do <code class="remark-inline-code">kubectl run testcurl ...</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li>Apply another policy:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/netpol-allow-testcurl-for-testweb.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1057 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="looking-at-the-network-policy">Looking at the network policy</h2>
<p>This is the second file that we applied:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">kind:</span> NetworkPolicy</div><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> networking.k8s.io/v1</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> allow-testcurl-for-testweb</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  podSelector:</span></div><div class="remark-code-line"><span class="hljs-attr">    matchLabels:</span></div><div class="remark-code-line"><span class="hljs-attr">      app:</span> testweb</div><div class="remark-code-line"><span class="hljs-attr">  ingress:</span></div><div class="remark-code-line"><span class="hljs-attr">  - from:</span></div><div class="remark-code-line"><span class="hljs-attr">    - podSelector:</span></div><div class="remark-code-line"><span class="hljs-attr">        matchLabels:</span></div><div class="remark-code-line"><span class="hljs-attr">          run:</span> testcurl</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1058 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-the-network-policy">Testing the network policy</h2>
<ul>
<li>Let's create pods with, and without, the required label</li>
</ul>
<div class="exercise"><ul>
<li><p>Try to connect to testweb from a pod with the <code class="remark-inline-code">run=testcurl</code> label:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run testcurl --rm -i --image=centos -- curl -m3 <span class="hljs-variable">$IP</span></div></code></pre>
</li>
<li><p>Try to connect to testweb with a different label:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run testkurl --rm -i --image=centos -- curl -m3 <span class="hljs-variable">$IP</span></div></code></pre>
</li>
</ul>
</div>

<p>The first command will work (and show the "Welcome to nginx!" page).</p>
<p>The second command will fail and time out after 3 seconds.</p>
<p>(The timeout is obtained with the <code class="remark-inline-code">-m3</code> option.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1059 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="an-important-warning">An important warning</h2>
<ul>
<li><p>Some network plugins only have partial support for network policies</p>
</li>
<li><p>For instance, Weave added support for egress rules <a href="https://github.com/weaveworks/weave/pull/3313">in version 2.4</a> (released in July 2018)</p>
</li>
<li><p>But only recently added support for ipBlock <a href="https://github.com/weaveworks/weave/pull/3367">in version 2.5</a> (released in Nov 2018)</p>
</li>
<li><p>Unsupported features might be silently ignored</p>
<p>(Making you believe that you are secure, when you're not)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1060 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="network-policies-pods-and-services">Network policies, pods, and services</h2>
<ul>
<li><p>Network policies apply to <em>pods</em></p>
</li>
<li><p>A <em>service</em> can select multiple pods</p>
<p>(And load balance traffic across them)</p>
</li>
<li><p>It is possible that we can connect to some pods, but not some others</p>
<p>(Because of how network policies have been defined for these pods)</p>
</li>
<li><p>In that case, connections to the service will randomly pass or fail</p>
<p>(Depending on whether the connection was sent to a pod that we have access to or not)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1061 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="network-policies-and-namespaces">Network policies and namespaces</h2>
<ul>
<li><p>A good strategy is to isolate a namespace, so that:</p>
<ul>
<li><p>all the pods in the namespace can communicate together</p>
</li>
<li><p>other namespaces cannot access the pods</p>
</li>
<li><p>external access has to be enabled explicitly</p>
</li>
</ul>
</li>
<li><p>Let's see what this would look like for the DockerCoins app!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1062 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="network-policies-for-dockercoins">Network policies for DockerCoins</h2>
<ul>
<li><p>We are going to apply two policies</p>
</li>
<li><p>The first policy will prevent traffic from other namespaces</p>
</li>
<li><p>The second policy will allow traffic to the <code class="remark-inline-code">webui</code> pods</p>
</li>
<li><p>That's all we need for that app!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1063 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="blocking-traffic-from-other-namespaces">Blocking traffic from other namespaces</h2>
<p>This policy selects all pods in the current namespace.</p>
<p>It allows traffic only from pods in the current namespace.</p>
<p>(An empty <code class="remark-inline-code">podSelector</code> means "all pods".)</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">kind:</span> NetworkPolicy</div><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> networking.k8s.io/v1</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> deny-from-other-namespaces</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  podSelector:</span> {}</div><div class="remark-code-line"><span class="hljs-attr">  ingress:</span></div><div class="remark-code-line"><span class="hljs-attr">  - from:</span></div><div class="remark-code-line"><span class="hljs-attr">    - podSelector:</span> {}</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1064 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="allowing-traffic-to-webui-pods">Allowing traffic to <code class="remark-inline-code">webui</code> pods</h2>
<p>This policy selects all pods with label <code class="remark-inline-code">app=webui</code>.</p>
<p>It allows traffic from any source.</p>
<p>(An empty <code class="remark-inline-code">from</code> fields means "all sources".)</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">kind:</span> NetworkPolicy</div><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> networking.k8s.io/v1</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> allow-webui</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  podSelector:</span></div><div class="remark-code-line"><span class="hljs-attr">    matchLabels:</span></div><div class="remark-code-line"><span class="hljs-attr">      app:</span> webui</div><div class="remark-code-line"><span class="hljs-attr">  ingress:</span></div><div class="remark-code-line"><span class="hljs-attr">  - from:</span> []</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1065 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="applying-both-network-policies">Applying both network policies</h2>
<ul>
<li>Both network policies are declared in the file <code class="remark-inline-code">k8s/netpol-dockercoins.yaml</code></li>
</ul>
<div class="exercise"><ul>
<li><p>Apply the network policies:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/netpol-dockercoins.yaml</div></code></pre>
</li>
<li><p>Check that we can still access the web UI from outside
<br>
(and that the app is still working correctly!)</p>
</li>
<li><p>Check that we can't connect anymore to <code class="remark-inline-code">rng</code> or <code class="remark-inline-code">hasher</code> through their ClusterIP</p>
</li>
</ul>
</div>

<p>Note: using <code class="remark-inline-code">kubectl proxy</code> or <code class="remark-inline-code">kubectl port-forward</code> allows us to connect
regardless of existing network policies. This allows us to debug and
troubleshoot easily, without having to poke holes in our firewall.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1066 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cleaning-up-our-network-policies">Cleaning up our network policies</h2>
<ul>
<li><p>The network policies that we have installed block all traffic to the default namespace</p>
</li>
<li><p>We should remove them, otherwise further exercises will fail!</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Remove all network policies:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl delete networkpolicies --all</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1067 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="protecting-the-control-plane">Protecting the control plane</h2>
<ul>
<li><p>Should we add network policies to block unauthorized access to the control plane?</p>
<p>(etcd, API server, etc.)</p>
</li>
</ul><div class="remark-slide-number">1068 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="protecting-the-control-plane">Protecting the control plane</h2>
<ul>
<li><p>Should we add network policies to block unauthorized access to the control plane?</p>
<p>(etcd, API server, etc.)</p>
</li>
<li><p>At first, it seems like a good idea ...</p>
</li>
</ul><div class="remark-slide-number">1069 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="protecting-the-control-plane">Protecting the control plane</h2>
<ul>
<li><p>Should we add network policies to block unauthorized access to the control plane?</p>
<p>(etcd, API server, etc.)</p>
</li>
<li><p>At first, it seems like a good idea ...</p>
</li>
<li><p>But it <em>shouldn't</em> be necessary:</p>
<ul>
<li><p>not all network plugins support network policies</p>
</li>
<li><p>the control plane is secured by other methods (mutual TLS, mostly)</p>
</li>
<li><p>the code running in our pods can reasonably expect to contact the API
<br>
(and it can do so safely thanks to the API permission model)</p>
</li>
</ul>
</li>
<li><p>If we block access to the control plane, we might disrupt legitimate code</p>
</li>
<li><p>... Without necessarily improving security</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1070 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="further-resources">Further resources</h2>
<ul>
<li><p>As always, the <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">Kubernetes documentation</a> is a good starting point</p>
</li>
<li><p>The API documentation has a lot of detail about the format of various objects:</p>
<ul>
<li><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#networkpolicy-v1-networking-k8s-io">NetworkPolicy</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#networkpolicyspec-v1-networking-k8s-io">NetworkPolicySpec</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#networkpolicyingressrule-v1-networking-k8s-io">NetworkPolicyIngressRule</a></p>
</li>
<li><p>etc.</p>
</li>
</ul>
</li>
<li><p>And two resources by <a href="https://ahmet.im/">Ahmet Alp Balkan</a>:</p>
<ul>
<li><p>a <a href="https://www.youtube.com/watch?list=PLj6h78yzYM2P-3-xqvmWaZbbI1sW-ulZb&amp;v=3gGpMmYeEO8">very good talk about network policies</a> at KubeCon North America 2017</p>
</li>
<li><p>a repository of <a href="https://github.com/ahmetb/kubernetes-network-policy-recipes">ready-to-use recipes</a> for network policies</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/netpol.md">k8s/netpol.md</a></span></p><div class="remark-slide-number">1071 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/wall-of-containers.jpeg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1072 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-pod-security-policies" class="remark-slide-content title hljs-default"><p>Pod Security Policies</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-network-policies">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-14">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-extending-the-kubernetes-api">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1073 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="pod-security-policies">Pod Security Policies</h1>
<ul>
<li><p>By default, our pods and containers can do <em>everything</em></p>
<p>(including taking over the entire cluster)</p>
</li>
<li><p>We are going to show an example of a malicious pod</p>
</li>
<li><p>Then we will explain how to avoid this with PodSecurityPolicies</p>
</li>
<li><p>We will illustrate this by creating a non-privileged user limited to a namespace</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1074 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-a-namespace">Setting up a namespace</h2>
<ul>
<li>Let's create a new namespace called "green"</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the "green" namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create namespace green</div></code></pre>
</li>
<li><p>Change to that namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kns green</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1075 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-limited-credentials">Using limited credentials</h2>
<ul>
<li><p>When a namespace is created, a <code class="remark-inline-code">default</code> ServiceAccount is added</p>
</li>
<li><p>By default, this ServiceAccount doesn't have any access rights</p>
</li>
<li><p>We will use this ServiceAccount as our non-privileged user</p>
</li>
<li><p>We will obtain this ServiceAccount's token and add it to a context</p>
</li>
<li><p>Then we will give basic access rights to this ServiceAccount</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1076 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="obtaining-the-serviceaccount-s-token">Obtaining the ServiceAccount's token</h2>
<ul>
<li><p>The token is stored in a Secret</p>
</li>
<li><p>The Secret is listed in the ServiceAccount</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Obtain the name of the Secret from the ServiceAccount::</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">SECRET=$(kubectl get sa default -o jsonpath={.secrets[0].name})</div></code></pre>
</li>
<li><p>Extract the token from the Secret object:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">TOKEN=$(kubectl get secrets <span class="hljs-variable">$SECRET</span> -o jsonpath={.data.token}</div><div class="remark-code-line">      | base64 <span class="hljs-_">-d</span>)</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1077 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="inspecting-a-kubernetes-token">Inspecting a Kubernetes token</h2>
<ul>
<li><p>Kubernetes tokens are JSON Web Tokens</p>
<p>(as defined by <a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>)</p>
</li>
<li><p>We can view their content (and even verify them) easily</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Display the token that we obtained:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$TOKEN</span></div></code></pre>
</li>
<li><p>Copy paste the token in the verification form on <a href="https://jwt.io/">https://jwt.io</a></p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1078 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="authenticating-using-the-serviceaccount-token">Authenticating using the ServiceAccount token</h2>
<ul>
<li>Let's create a new <em>context</em> accessing our cluster with that token</li>
</ul>
<div class="exercise"><ul>
<li><p>First, add the token credentials to our kubeconfig file:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-credentials green --token=<span class="hljs-variable">$TOKEN</span></div></code></pre>
</li>
<li><p>Then, create a new context using these credentials:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config <span class="hljs-built_in">set</span>-context green --user=green --cluster=kubernetes</div></code></pre>
</li>
<li><p>Check the results:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl config get-contexts</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1079 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-the-new-context">Using the new context</h2>
<ul>
<li>Normally, this context doesn't let us access <em>anything</em> (yet)</li>
</ul>
<div class="exercise"><ul>
<li><p>Change to the new context with one of these two commands:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kctx green</div><div class="remark-code-line">kubectl config use-context green</div></code></pre>
</li>
<li><p>Also change to the green namespace in that context:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kns green</div></code></pre>
</li>
<li><p>Confirm that we don't have access to anything:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1080 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="giving-basic-access-rights">Giving basic access rights</h2>
<ul>
<li><p>Let's bind the ClusterRole <code class="remark-inline-code">edit</code> to our ServiceAccount</p>
</li>
<li><p>To allow access only to the namespace, we use a RoleBinding</p>
<p>(instead of a ClusterRoleBinding, which would give global access)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Switch back to <code class="remark-inline-code">cluster-admin</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kctx -</div></code></pre>
</li>
<li><p>Create the Role Binding:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create rolebinding green --clusterrole=edit --serviceaccount=green:default</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1081 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="verifying-access-rights">Verifying access rights</h2>
<ul>
<li>Let's switch back to the <code class="remark-inline-code">green</code> context and check that we have rights</li>
</ul>
<div class="exercise"><ul>
<li><p>Switch back to <code class="remark-inline-code">green</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kctx green</div></code></pre>
</li>
<li><p>Check our permissions:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>We should see an empty list.</p>
<p>(Better than a series of permission errors!)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1082 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-a-basic-deployment">Creating a basic Deployment</h2>
<ul>
<li>Just to demonstrate that everything works correctly, deploy NGINX</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a Deployment using the official NGINX image:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment web --image=nginx</div></code></pre>
</li>
<li><p>Confirm that the Deployment, ReplicaSet, and Pod exist, and Pod is running:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1083 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="one-example-of-malicious-pods">One example of malicious pods</h2>
<ul>
<li><p>We will now show an escalation technique in action</p>
</li>
<li><p>We will deploy a DaemonSet that adds our SSH key to the root account</p>
<p>(on <em>each</em> node of the cluster)</p>
</li>
<li><p>The Pods of the DaemonSet will do so by mounting <code class="remark-inline-code">/root</code> from the host</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Check the file <code class="remark-inline-code">k8s/hacktheplanet.yaml</code> with a text editor:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">vim ~/container.training/k8s/hacktheplanet.yaml</div></code></pre>
</li>
<li><p>If you would like, change the SSH key (by changing the GitHub user name)</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1084 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploying-the-malicious-pods">Deploying the malicious pods</h2>
<ul>
<li>Let's deploy our "exploit"!</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the DaemonSet:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span> ~/container.training/k8s/hacktheplanet.yaml</div></code></pre>
</li>
<li><p>Check that the pods are running:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods</div></code></pre>
</li>
<li><p>Confirm that the SSH key was added to the node's root account:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo cat /root/.ssh/authorized_keys</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1085 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cleaning-up">Cleaning up</h2>
<ul>
<li>Before setting up our PodSecurityPolicies, clean up that namespace</li>
</ul>
<div class="exercise"><ul>
<li><p>Remove the DaemonSet:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl delete daemonset hacktheplanet</div></code></pre>
</li>
<li><p>Remove the Deployment:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl delete deployment web</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1086 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pod-security-policies-in-theory">Pod Security Policies in theory</h2>
<ul>
<li><p>To use PSPs, we need to activate their specific <em>admission controller</em></p>
</li>
<li><p>That admission controller will intercept each pod creation attempt</p>
</li>
<li><p>It will look at:</p>
<ul>
<li><p><em>who/what</em> is creating the pod</p>
</li>
<li><p>which PodSecurityPolicies they can use</p>
</li>
<li><p>which PodSecurityPolicies can be used by the Pod's ServiceAccount</p>
</li>
</ul>
</li>
<li><p>Then it will compare the Pod with each PodSecurityPolicy one by one</p>
</li>
<li><p>If a PodSecurityPolicy accepts all the parameters of the Pod, it is created</p>
</li>
<li><p>Otherwise, the Pod creation is denied and it won't even show up in <code class="remark-inline-code">kubectl get pods</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1087 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pod-security-policies-fine-print">Pod Security Policies fine print</h2>
<ul>
<li><p>With RBAC, using a PSP corresponds to the verb <code class="remark-inline-code">use</code> on the PSP</p>
<p>(that makes sense, right?)</p>
</li>
<li><p>If no PSP is defined, no Pod can be created</p>
<p>(even by cluster admins)</p>
</li>
<li><p>Pods that are already running are <em>not</em> affected</p>
</li>
<li><p>If we create a Pod directly, it can use a PSP to which <em>we</em> have access</p>
</li>
<li><p>If the Pod is created by e.g. a ReplicaSet or DaemonSet, it's different:</p>
<ul>
<li><p>the ReplicaSet / DaemonSet controllers don't have access to <em>our</em> policies</p>
</li>
<li><p>therefore, we need to give access to the PSP to the Pod's ServiceAccount</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1088 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pod-security-policies-in-practice">Pod Security Policies in practice</h2>
<ul>
<li><p>We are going to enable the PodSecurityPolicy admission controller</p>
</li>
<li><p>At that point, we won't be able to create any more pods (!)</p>
</li>
<li><p>Then we will create a couple of PodSecurityPolicies</p>
</li>
<li><p>... And associated ClusterRoles (giving <code class="remark-inline-code">use</code> access to the policies)</p>
</li>
<li><p>Then we will create RoleBindings to grant these roles to ServiceAccounts</p>
</li>
<li><p>We will verify that we can't run our "exploit" anymore</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1089 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="enabling-pod-security-policies">Enabling Pod Security Policies</h2>
<ul>
<li><p>To enable Pod Security Policies, we need to enable their <em>admission plugin</em></p>
</li>
<li><p>This is done by adding a flag to the API server</p>
</li>
<li><p>On clusters deployed with <code class="remark-inline-code">kubeadm</code>, the control plane runs in static pods</p>
</li>
<li><p>These pods are defined in YAML files located in <code class="remark-inline-code">/etc/kubernetes/manifests</code></p>
</li>
<li><p>Kubelet watches this directory</p>
</li>
<li><p>Each time a file is added/removed there, kubelet creates/deletes the corresponding pod</p>
</li>
<li><p>Updating a file causes the pod to be deleted and recreated</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1090 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="updating-the-api-server-flags">Updating the API server flags</h2>
<ul>
<li>Let's edit the manifest for the API server pod</li>
</ul>
<div class="exercise"><ul>
<li><p>Have a look at the static pods:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ls <span class="hljs-_">-l</span> /etc/kubernetes/manifest</div></code></pre>
</li>
<li><p>Edit the one corresponding to the API server:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo vim /etc/kubernetes/manifests/kube-apiserver.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1091 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="adding-the-psp-admission-plugin">Adding the PSP admission plugin</h2>
<ul>
<li><p>There should already be a line with <code class="remark-inline-code">--enable-admission-plugins=...</code></p>
</li>
<li><p>Let's add <code class="remark-inline-code">PodSecurityPolicy</code> on that line</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Locate the line with <code class="remark-inline-code">--enable-admission-plugins=</code></p>
</li>
<li><p>Add <code class="remark-inline-code">PodSecurityPolicy</code></p>
<p>(It should read <code class="remark-inline-code">--enable-admission-plugins=NodeRestriction,PodSecurityPolicy</code>)</p>
</li>
<li><p>Save, quit</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1092 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="waiting-for-the-api-server-to-restart">Waiting for the API server to restart</h2>
<ul>
<li><p>The kubelet detects that the file was modified</p>
</li>
<li><p>It kills the API server pod, and starts a new one</p>
</li>
<li><p>During that time, the API server is unavailable</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Wait until the API server is available again</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1093 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="check-that-the-admission-plugin-is-active">Check that the admission plugin is active</h2>
<ul>
<li>Normally, we can't create any Pod at this point</li>
</ul>
<div class="exercise"><ul>
<li><p>Try to create a Pod directly:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run testpsp1 --image=nginx --restart=Never</div></code></pre>
</li>
<li><p>Try to create a Deployment:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl run testpsp2 --image=nginx</div></code></pre>
</li>
<li><p>Look at existing resources:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p>We can get hints at what's happening by looking at the ReplicaSet and Events.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1094 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="introducing-our-pod-security-policies">Introducing our Pod Security Policies</h2>
<ul>
<li><p>We will create two policies:</p>
<ul>
<li><p>privileged (allows everything)</p>
</li>
<li><p>restricted (blocks some unsafe mechanisms)</p>
</li>
</ul>
</li>
<li><p>For each policy, we also need an associated ClusterRole granting <em>use</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1095 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-our-pod-security-policies">Creating our Pod Security Policies</h2>
<ul>
<li><p>We have a couple of files, each defining a PSP and associated ClusterRole:</p>
<ul>
<li>k8s/psp-privileged.yaml: policy <code class="remark-inline-code">privileged</code>, role <code class="remark-inline-code">psp:privileged</code></li>
<li>k8s/psp-restricted.yaml: policy <code class="remark-inline-code">restricted</code>, role <code class="remark-inline-code">psp:restricted</code></li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Create both policies and their associated ClusterRoles:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span> ~/container.training/k8s/psp-restricted.yaml</div><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span> ~/container.training/k8s/psp-privileged.yaml</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>The privileged policy comes from <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#example-policies">the Kubernetes documentation</a></p>
</li>
<li><p>The restricted policy is inspired by that same documentation page</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1096 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="binding-the-restricted-policy">Binding the restricted policy</h2>
<ul>
<li><p>Let's bind the role <code class="remark-inline-code">psp:restricted</code> to ServiceAccount <code class="remark-inline-code">green:default</code></p>
<p>(aka the default ServiceAccount in the green Namespace)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Create the following RoleBinding:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create rolebinding psp:restricted \</div><div class="remark-code-line">        --clusterrole=psp:restricted \</div><div class="remark-code-line">        --serviceaccount=green:default</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1097 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="trying-it-out">Trying it out</h2>
<ul>
<li>Let's switch to the <code class="remark-inline-code">green</code> context, and try to create resources</li>
</ul>
<div class="exercise"><ul>
<li><p>Switch to the <code class="remark-inline-code">green</code> context:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kctx green</div></code></pre>
</li>
<li><p>Create a simple Deployment:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create deployment web --image=nginx</div></code></pre>
</li>
<li><p>Look at the Pods that have been created:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1098 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="trying-to-hack-the-cluster">Trying to hack the cluster</h2>
<ul>
<li>Let's create the same DaemonSet we used earlier</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a hostile DaemonSet:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create <span class="hljs-_">-f</span> ~/container.training/k8s/hacktheplanet.yaml</div></code></pre>
</li>
<li><p>Look at the state of the namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get all</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1099 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="what-s-in-our-restricted-policy-">What's in our restricted policy?</h2>
<ul>
<li><p>The restricted PSP is similar to the one provided in the docs, but:</p>
<ul>
<li><p>it allows containers to run as root</p>
</li>
<li><p>it doesn't drop capabilities</p>
</li>
</ul>
</li>
<li><p>Many containers run as root by default, and would require additional tweaks</p>
</li>
<li><p>Many containers use e.g. <code class="remark-inline-code">chown</code>, which requires a specific capability</p>
<p>(that's the case for the NGINX official image, for instance)</p>
</li>
<li><p>We still block: hostPath, privileged containers, and much more!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1100 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="the-case-of-static-pods">The case of static pods</h2>
<ul>
<li><p>If we list the pods in the <code class="remark-inline-code">kube-system</code> namespace, <code class="remark-inline-code">kube-apiserver</code> is missing</p>
</li>
<li><p>However, the API server is obviously running</p>
<p>(otherwise, <code class="remark-inline-code">kubectl get pods --namespace=kube-system</code> wouldn't work)</p>
</li>
<li><p>The API server Pod is created directly by kubelet</p>
<p>(without going through the PSP admission plugin)</p>
</li>
<li><p>Then, kubelet creates a "mirror pod" representing that Pod in etcd</p>
</li>
<li><p>That "mirror pod" creation goes through the PSP admission plugin</p>
</li>
<li><p>And it gets blocked!</p>
</li>
<li><p>This can be fixed by binding <code class="remark-inline-code">psp:privileged</code> to group <code class="remark-inline-code">system:nodes</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1101 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-span-class-warning-before-moving-on-span-"><span class="warning">Before moving on...</span></h2>
<ul>
<li><p>Our cluster is currently broken</p>
<p>(we can't create pods in namespaces kube-system, default, ...)</p>
</li>
<li><p>We need to either:</p>
<ul>
<li><p>disable the PSP admission plugin</p>
</li>
<li><p>allow use of PSP to relevant users and groups</p>
</li>
</ul>
</li>
<li><p>For instance, we could:</p>
<ul>
<li><p>bind <code class="remark-inline-code">psp:restricted</code> to the group <code class="remark-inline-code">system:authenticated</code></p>
</li>
<li><p>bind <code class="remark-inline-code">psp:privileged</code> to the ServiceAccount <code class="remark-inline-code">kube-system:default</code></p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/podsecuritypolicy.md">k8s/podsecuritypolicy.md</a></span></p><div class="remark-slide-number">1102 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1103 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-extending-the-kubernetes-api" class="remark-slide-content title hljs-default"><p>Extending the Kubernetes API</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-pod-security-policies">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-15">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-operators">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1104 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="extending-the-kubernetes-api">Extending the Kubernetes API</h1>
<p>There are multiple ways to extend the Kubernetes API.</p>
<p>We are going to cover:</p>
<ul>
<li><p>Custom Resource Definitions (CRDs)</p>
</li>
<li><p>Admission Webhooks</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1105 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="revisiting-the-api-server">Revisiting the API server</h2>
<ul>
<li><p>The Kubernetes API server is a central point of the control plane</p>
<p>(everything connects to it: controller manager, scheduler, kubelets)</p>
</li>
<li><p>Almost everything in Kubernetes is materialized by a resource</p>
</li>
<li><p>Resources have a type (or "kind")</p>
<p>(similar to strongly typed languages)</p>
</li>
<li><p>We can see existing types with <code class="remark-inline-code">kubectl api-resources</code></p>
</li>
<li><p>We can list resources of a given type with <code class="remark-inline-code">kubectl get &lt;type&gt;</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1106 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-new-types">Creating new types</h2>
<ul>
<li><p>We can create new types with Custom Resource Definitions (CRDs)</p>
</li>
<li><p>CRDs are created dynamically</p>
<p>(without recompiling or restarting the API server)</p>
</li>
<li><p>CRDs themselves are resources:</p>
<ul>
<li><p>we can create a new type with <code class="remark-inline-code">kubectl create</code> and some YAML</p>
</li>
<li><p>we can see all our custom types with <code class="remark-inline-code">kubectl get crds</code></p>
</li>
</ul>
</li>
<li><p>After we create a CRD, the new type works just like built-in types</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1107 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-can-we-do-with-crds-">What can we do with CRDs?</h2>
<p>There are many possibilities!</p>
<ul>
<li><p><em>Operators</em> encapsulate complex sets of resources</p>
<p>(e.g.: a PostgreSQL replicated cluster; an etcd cluster...
<br>
see <a href="https://github.com/operator-framework/awesome-operators">awesome operators</a> and
<a href="https://operatorhub.io/">OperatorHub</a> to find more)</p>
</li>
<li><p>Custom use-cases like <a href="https://gitkube.sh/">gitkube</a></p>
<ul>
<li><p>creates a new custom type, <code class="remark-inline-code">Remote</code>, exposing a git+ssh server</p>
</li>
<li><p>deploy by pushing YAML or Helm charts to that remote</p>
</li>
</ul>
</li>
<li><p>Replacing built-in types with CRDs</p>
<p>(see <a href="https://www.youtube.com/watch?v=ji0FWzFwNhA&amp;index=2&amp;list=PLj6h78yzYM2PZf9eA7bhWnIh_mK1vyOfU">this lightning talk by Tim Hockin</a>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1108 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="little-details">Little details</h2>
<ul>
<li><p>By default, CRDs are not <em>validated</em></p>
<p>(we can put anything we want in the <code class="remark-inline-code">spec</code>)</p>
</li>
<li><p>When creating a CRD, we can pass an OpenAPI v3 schema (BETA!)</p>
<p>(which will then be used to validate resources)</p>
</li>
<li><p>Generally, when creating a CRD, we also want to run a <em>controller</em></p>
<p>(otherwise nothing will happen when we create resources of that type) </p>
</li>
<li><p>The controller will typically <em>watch</em> our custom resources</p>
<p>(and take action when they are created/updated)</p>
</li>
</ul>
<p><em>
Examples:
<a href="https://storage.googleapis.com/gitkube/gitkube-setup-stable.yaml">YAML to install the gitkube CRD</a>,
<a href="https://github.com/amaizfinance/redis-operator/blob/master/deploy/crds/k8s_v1alpha1_redis_crd.yaml">YAML to install a redis operator CRD</a>
</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1109 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="service-catalog">Service catalog</h2>
<ul>
<li><p><em>Service catalog</em> is another extension mechanism</p>
</li>
<li><p>It's not extending the Kubernetes API strictly speaking</p>
<p>(but it still provides new features!)</p>
</li>
<li><p>It doesn't create new types; it uses:</p>
<ul>
<li>ClusterServiceBroker</li>
<li>ClusterServiceClass</li>
<li>ClusterServicePlan</li>
<li>ServiceInstance</li>
<li>ServiceBinding </li>
</ul>
</li>
<li><p>It uses the Open service broker API</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1110 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="admission-controllers">Admission controllers</h2>
<ul>
<li><p>When a Pod is created, it is associated to a ServiceAccount</p>
<p>(even if we did not specify one explicitly)</p>
</li>
<li><p>That ServiceAccount was added on the fly by an <em>admission controller</em></p>
<p>(specifically, a <em>mutating admission controller</em>)</p>
</li>
<li><p>Admission controllers sit on the API request path</p>
<p>(see the cool diagram on next slide, courtesy of Banzai Cloud)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1111 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><img src="./Kubernetes Administrator Training_files/api-request-lifecycle.png" alt="API request lifecycle"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1112 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="admission-controllers">Admission controllers</h2>
<ul>
<li><p><em>Validating</em> admission controllers can accept/reject the API call</p>
</li>
<li><p><em>Mutating</em> admission controllers can modify the API request payload</p>
</li>
<li><p>Both types can also trigger additional actions</p>
<p>(e.g. automatically create a Namespace if it doesn't exist)</p>
</li>
<li><p>There are a number of built-in admission controllers</p>
<p>(see <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do">documentation</a> for a list)</p>
</li>
<li><p>But we can also define our own!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1113 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="admission-webhooks">Admission Webhooks</h2>
<ul>
<li><p>We can setup <em>admission webhooks</em> to extend the behavior of the API server</p>
</li>
<li><p>The API server will submit incoming API requests to these webhooks</p>
</li>
<li><p>These webhooks can be <em>validating</em> or <em>mutating</em></p>
</li>
<li><p>Webhooks can be setup dynamically (without restarting the API server)</p>
</li>
<li><p>To setup a dynamic admission webhook, we create a special resource:</p>
<p>a <code class="remark-inline-code">ValidatingWebhookConfiguration</code> or a <code class="remark-inline-code">MutatingWebhookConfiguration</code></p>
</li>
<li><p>These resources are created and managed like other resources</p>
<p>(i.e. <code class="remark-inline-code">kubectl create</code>, <code class="remark-inline-code">kubectl get</code> ...)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1114 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="webhook-configuration">Webhook Configuration</h2>
<ul>
<li><p>A ValidatingWebhookConfiguration or MutatingWebhookConfiguration contains:</p>
<ul>
<li><p>the address of the webhook</p>
</li>
<li><p>the authentication information to use with the webhook</p>
</li>
<li><p>a list of rules</p>
</li>
</ul>
</li>
<li><p>The rules indicate for which objects and actions the webhook is triggered</p>
<p>(to avoid e.g. triggering webhooks when setting up webhooks)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1115 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-ab-using-the-api-server">(Ab)using the API server</h2>
<ul>
<li><p>If we need to store something "safely" (as in: in etcd), we can use CRDs</p>
</li>
<li><p>This gives us primitives to read/write/list objects (and optionally validate them)</p>
</li>
<li><p>The Kubernetes API server can run on its own</p>
<p>(without the scheduler, controller manager, and kubelets)</p>
</li>
<li><p>By loading CRDs, we can have it manage totally different objects</p>
<p>(unrelated to containers, clusters, etc.)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1116 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="documentation">Documentation</h2>
<ul>
<li><p><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource Definitions: when to use them</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/">Custom Resources Definitions: how to use them</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/service-catalog/">Service Catalog</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">Built-in Admission Controllers</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/">Dynamic Admission Controllers</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/extending-api.md">k8s/extending-api.md</a></span></p><div class="remark-slide-number">1117 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/ShippingContainerSFBay.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1118 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-operators" class="remark-slide-content title hljs-default"><p>Operators</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-extending-the-kubernetes-api">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-15">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-stateful-sets">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1119 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="operators">Operators</h1>
<ul>
<li><p>Operators are one of the many ways to extend Kubernetes</p>
</li>
<li><p>We will define operators</p>
</li>
<li><p>We will see how they work</p>
</li>
<li><p>We will install a specific operator (for ElasticSearch)</p>
</li>
<li><p>We will use it to provision an ElasticSearch cluster</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1120 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-are-operators-">What are operators?</h2>
<p><em>An operator represents <strong>human operational knowledge in software,</strong>
<br>
to reliably manage an application.
— <a href="https://coreos.com/blog/introducing-operators.html">CoreOS</a></em></p>
<p>Examples:</p>
<ul>
<li><p>Deploying and configuring replication with MySQL, PostgreSQL ...</p>
</li>
<li><p>Setting up Elasticsearch, Kafka, RabbitMQ, Zookeeper ...</p>
</li>
<li><p>Reacting to failures when intervention is needed</p>
</li>
<li><p>Scaling up and down these systems</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1121 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-are-they-made-from-">What are they made from?</h2>
<ul>
<li><p>Operators combine two things:</p>
<ul>
<li><p>Custom Resource Definitions</p>
</li>
<li><p>controller code watching the corresponding resources and acting upon them</p>
</li>
</ul>
</li>
<li><p>A given operator can define one or multiple CRDs</p>
</li>
<li><p>The controller code (control loop) typically runs within the cluster</p>
<p>(running as a Deployment with 1 replica is a common scenario)</p>
</li>
<li><p>But it could also run elsewhere</p>
<p>(nothing mandates that the code run on the cluster, as long as it has API access)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1122 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="why-use-operators-">Why use operators?</h2>
<ul>
<li><p>Kubernetes gives us Deployments, StatefulSets, Services ...</p>
</li>
<li><p>These mechanisms give us building blocks to deploy applications</p>
</li>
<li><p>They work great for services that are made of <em>N</em> identical containers</p>
<p>(like stateless ones)</p>
</li>
<li><p>They also work great for some stateful applications like Consul, etcd ...</p>
<p>(with the help of highly persistent volumes)</p>
</li>
<li><p>They're not enough for complex services:</p>
<ul>
<li><p>where different containers have different roles</p>
</li>
<li><p>where extra steps have to be taken when scaling or replacing containers</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1123 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="use-cases-for-operators">Use-cases for operators</h2>
<ul>
<li><p>Systems with primary/secondary replication</p>
<p>Examples: MariaDB, MySQL, PostgreSQL, Redis ...</p>
</li>
<li><p>Systems where different groups of nodes have different roles</p>
<p>Examples: ElasticSearch, MongoDB ...</p>
</li>
<li><p>Systems with complex dependencies (that are themselves managed with operators)</p>
<p>Examples: Flink or Kafka, which both depend on Zookeeper</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1124 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="more-use-cases">More use-cases</h2>
<ul>
<li><p>Representing and managing external resources</p>
<p>(Example: <a href="https://operatorhub.io/operator/alpha/aws-service-operator.v0.0.1">AWS Service Operator</a>)</p>
</li>
<li><p>Managing complex cluster add-ons</p>
<p>(Example: <a href="https://operatorhub.io/operator/beta/istio-operator.0.1.6">Istio operator</a>)</p>
</li>
<li><p>Deploying and managing our applications' lifecycles</p>
<p>(more on that later)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1125 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="how-operators-work">How operators work</h2>
<ul>
<li><p>An operator creates one or more CRDs</p>
<p>(i.e., it creates new "Kinds" of resources on our cluster)</p>
</li>
<li><p>The operator also runs a <em>controller</em> that will watch its resources</p>
</li>
<li><p>Each time we create/update/delete a resource, the controller is notified</p>
<p>(we could write our own cheap controller with <code class="remark-inline-code">kubectl get --watch</code>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1126 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="one-operator-in-action">One operator in action</h2>
<ul>
<li><p>We will install the UPMC Enterprises ElasticSearch operator</p>
</li>
<li><p>This operator requires PersistentVolumes</p>
</li>
<li><p>We will install Rancher's <a href="https://github.com/rancher/local-path-provisioner">local path storage provisioner</a> to automatically create these</p>
</li>
<li><p>Then, we will create an ElasticSearch resource</p>
</li>
<li><p>The operator will detect that resource and provision the cluster</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1127 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="installing-a-persistent-volume-provisioner">Installing a Persistent Volume provisioner</h2>
<p>(This step can be skipped if you already have a dynamic volume provisioner.)</p>
<ul>
<li><p>This provisioner creates Persistent Volumes backed by <code class="remark-inline-code">hostPath</code></p>
<p>(local directories on our nodes)</p>
</li>
<li><p>It doesn't require anything special ...</p>
</li>
<li><p>... But losing a node = losing the volumes on that node!</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Install the local path storage provisioner:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/<span class="hljs-built_in">local</span>-path-storage.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1128 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="making-sure-we-have-a-default-storageclass">Making sure we have a default StorageClass</h2>
<ul>
<li><p>The ElasticSearch operator will create StatefulSets</p>
</li>
<li><p>These StatefulSets will instantiate PersistentVolumeClaims</p>
</li>
<li><p>These PVCs need to be explicitly associated with a StorageClass</p>
</li>
<li><p>Or we need to tag a StorageClass to be used as the default one</p>
</li>
</ul>
<div class="exercise"><ul>
<li>List StorageClasses:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get storageclasses</div></code></pre>
</li>
</ul>
</div>

<p>We should see the <code class="remark-inline-code">local-path</code> StorageClass.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1129 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-a-default-storageclass">Setting a default StorageClass</h2>
<ul>
<li><p>This is done by adding an annotation to the StorageClass:</p>
<p><code class="remark-inline-code">storageclass.kubernetes.io/is-default-class: true</code></p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Tag the StorageClass so that it's the default one:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl annotate storageclass <span class="hljs-built_in">local</span>-path \</div><div class="remark-code-line">        storageclass.kubernetes.io/is-default-class=<span class="hljs-literal">true</span></div></code></pre>
</li>
<li><p>Check the result:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get storageclasses</div></code></pre>
</li>
</ul>
</div>

<p>Now, the StorageClass should have <code class="remark-inline-code">(default)</code> next to its name.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1130 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="install-the-elasticsearch-operator">Install the ElasticSearch operator</h2>
<ul>
<li><p>The operator needs:</p>
<ul>
<li>a Deployment for its controller</li>
<li>a ServiceAccount, ClusterRole, ClusterRoleBinding for permissions</li>
<li>a Namespace</li>
</ul>
</li>
<li><p>We have grouped all the definitions for these resources in a YAML file</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Install the operator:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/elasticsearch-operator.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1131 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="wait-for-the-operator-to-be-ready">Wait for the operator to be ready</h2>
<ul>
<li><p>Some operators require to create their CRDs separately</p>
</li>
<li><p>This operator will create its CRD itself</p>
<p>(i.e. the CRD is not listed in the YAML that we applied earlier)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Wait until the <code class="remark-inline-code">elasticsearchclusters</code> CRD shows up:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get crds</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1132 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="create-an-elasticsearch-resource">Create an ElasticSearch resource</h2>
<ul>
<li><p>We can now create a resource with <code class="remark-inline-code">kind: ElasticsearchCluster</code></p>
</li>
<li><p>The YAML for that resource will specify all the desired parameters:</p>
<ul>
<li>how many nodes do we want of each type (client, master, data)</li>
<li>image to use</li>
<li>add-ons (kibana, cerebro, ...)</li>
<li>whether to use TLS or not</li>
<li>etc.</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Create our ElasticSearch cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/elasticsearch-cluster.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1133 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="operator-in-action">Operator in action</h2>
<ul>
<li><p>Over the next minutes, the operator will create:</p>
<ul>
<li><p>StatefulSets (one for master nodes, one for data nodes)</p>
</li>
<li><p>Deployments (for client nodes; and for add-ons like cerebro and kibana)</p>
</li>
<li><p>Services (for all these pods)</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Wait for all the StatefulSets to be fully up and running:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get statefulsets -w</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1134 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="connecting-to-our-cluster">Connecting to our cluster</h2>
<ul>
<li>Since connecting directly to the ElasticSearch API is a bit raw,
<br>we'll connect to the cerebro frontend instead</li>
</ul>
<div class="exercise"><ul>
<li><p>Edit the cerebro service to change its type from ClusterIP to NodePort:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl patch svc cerebro-es -p <span class="hljs-string">"spec: { type: NodePort }"</span></div></code></pre>
</li>
<li><p>Retrieve the NodePort that was allocated:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get svc cerebreo-es</div></code></pre>
</li>
<li><p>Connect to that port with a browser</p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1135 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-bonus-setup-filebeat">(Bonus) Setup filebeat</h2>
<ul>
<li><p>Let's send some data to our brand new ElasticSearch cluster!</p>
</li>
<li><p>We'll deploy a filebeat DaemonSet to collect node logs</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Deploy filebeat:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/filebeat.yaml</div></code></pre>
</li>
</ul>
</div>

<p>We should see at least one index being created in cerebro.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1136 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="-bonus-access-log-data-with-kibana">(Bonus) Access log data with kibana</h2>
<ul>
<li><p>Let's expose kibana (by making kibana-es a NodePort too)</p>
</li>
<li><p>Then access kibana</p>
</li>
<li><p>We'll need to configure kibana indexes</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1137 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploying-our-apps-with-operators">Deploying our apps with operators</h2>
<ul>
<li><p>It is very simple to deploy with <code class="remark-inline-code">kubectl run</code> / <code class="remark-inline-code">kubectl expose</code></p>
</li>
<li><p>We can unlock more features by writing YAML and using <code class="remark-inline-code">kubectl apply</code></p>
</li>
<li><p>Kustomize or Helm let us deploy in multiple environments</p>
<p>(and adjust/tweak parameters in each environment)</p>
</li>
<li><p>We can also use an operator to deploy our application</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1138 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="pros-and-cons-of-deploying-with-operators">Pros and cons of deploying with operators</h2>
<ul>
<li><p>The app definition and configuration is persisted in the Kubernetes API</p>
</li>
<li><p>Multiple instances of the app can be manipulated with <code class="remark-inline-code">kubectl get</code></p>
</li>
<li><p>We can add labels, annotations to the app instances</p>
</li>
<li><p>Our controller can execute custom code for any lifecycle event</p>
</li>
<li><p>However, we need to write this controller</p>
</li>
<li><p>We need to be careful about changes</p>
<p>(what happens when the resource <code class="remark-inline-code">spec</code> is updated?)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1139 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="operators-are-not-magic">Operators are not magic</h2>
<ul>
<li><p>Look at the ElasticSearch resource definition</p>
<p>(<code class="remark-inline-code">~/container.training/k8s/elasticsearch-cluster.yaml</code>)</p>
</li>
<li><p>What should happen if we flip the <code class="remark-inline-code">use-tls</code> flag? Twice?</p>
</li>
<li><p>What should happen if we remove / re-add the kibana or cerebro sections?</p>
</li>
<li><p>What should happen if we change the number of nodes?</p>
</li>
<li><p>What if we want different images or parameters for the different nodes?</p>
</li>
</ul>
<p><em>Operators can be very powerful, iff we know exactly the scenarios that they can handle.</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators.md">k8s/operators.md</a></span></p><div class="remark-slide-number">1140 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="operator-design-extra-material-">Operator design (extra material)</h2>
<ul>
<li><p>Writing a quick-and-dirty operator, or a POC/MVP, is easy</p>
</li>
<li><p>Writing a robust operator is hard</p>
</li>
<li><p>We will describe the general idea</p>
</li>
<li><p>We will identify some of the associated challenges</p>
</li>
<li><p>We will list a few tools that can help us</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1141 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="top-down-vs-bottom-up">Top-down vs. bottom-up</h2>
<ul>
<li><p>Both approaches are possible</p>
</li>
<li><p>Let's see what they entail, and their respective pros and cons</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1142 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="top-down-approach">Top-down approach</h2>
<ul>
<li><p>Start with high-level design (see next slide)</p>
</li>
<li><p>Pros:</p>
<ul>
<li>can yield cleaner design that will be more robust</li>
</ul>
</li>
<li><p>Cons:</p>
<ul>
<li><p>must be able to anticipate all the events that might happen</p>
</li>
<li><p>design will be better only to the extend of what we anticipated</p>
</li>
<li><p>hard to anticipate if we don't have production experience</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1143 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="high-level-design">High-level design</h2>
<ul>
<li><p>What are we solving?</p>
<p>(e.g.: geographic databases backed by PostGIS with Redis caches)</p>
</li>
<li><p>What are our use-cases, stories?</p>
<p>(e.g.: adding/resizing caches and read replicas; load balancing queries)</p>
</li>
<li><p>What kind of outage do we want to address?</p>
<p>(e.g.: loss of individual node, pod, volume)</p>
</li>
<li><p>What are our <em>non-features</em>, the things we don't want to address?</p>
<p>(e.g.: loss of datacenter/zone; differentiating between read and write queries;
<br>
cache invalidation; upgrading to newer major versions of Redis, PostGIS, PostgreSQL)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1144 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="low-level-design">Low-level design</h2>
<ul>
<li><p>What Custom Resource Definitions do we need?</p>
<p>(one, many?)</p>
</li>
<li><p>How will we store configuration information?</p>
<p>(part of the CRD spec fields, annotations, other?)</p>
</li>
<li><p>Do we need to store state? If so, where?</p>
<ul>
<li><p>state that is small and doesn't change much can be stored via the Kubernetes API
<br>
(e.g.: leader information, configuration, credentials)</p>
</li>
<li><p>things that are big and/or change a lot should go elsewhere
<br>
(e.g.: metrics, bigger configuration file like GeoIP)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1145 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="what-can-we-store-via-the-kubernetes-api-">What can we store via the Kubernetes API?</h2>
<ul>
<li><p>The API server stores most Kubernetes resources into etcd</p>
</li>
<li><p>Etcd is designed for reliability, not for performance</p>
</li>
<li><p>If our storage needs exceed what etcd can offer, we need to use something else:</p>
<ul>
<li><p>either directly</p>
</li>
<li><p>or by extending the API server
<br>(for instance by using the agregation layer, like <a href="https://github.com/kubernetes-incubator/metrics-server">metrics server</a> does)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1146 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bottom-up-approach">Bottom-up approach</h2>
<ul>
<li><p>Start with existing Kubernetes resources (Deployment, Stateful Set...)</p>
</li>
<li><p>Run the system in production</p>
</li>
<li><p>Add scripts, automation, to facilitate day-to-day operations</p>
</li>
<li><p>Turn the scripts into an operator</p>
</li>
<li><p>Pros: simpler to get started; reflects actual use-cases</p>
</li>
<li><p>Cons: can result in convoluted designs requiring extensive refactor</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1147 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="general-idea">General idea</h2>
<ul>
<li><p>Our operator will watch its CRDs <em>and associated resources</em></p>
</li>
<li><p>Drawing state diagrams and finite state automata helps a lot</p>
</li>
<li><p>It's OK if some transitions lead to a big catch-all "human intervention"</p>
</li>
<li><p>Over time, we will learn about new failure modes and add to these diagrams</p>
</li>
<li><p>It's OK to start with CRD creation / deletion and prevent any modification</p>
<p>(that's the easy POC/MVP we were talking about)</p>
</li>
<li><p><em>Presentation</em> and <em>validation</em> will help our users</p>
<p>(more on that later)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1148 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="challenges">Challenges</h2>
<ul>
<li><p>Reacting to infrastructure disruption can seem hard at first</p>
</li>
<li><p>Kubernetes gives us a lot of primitives to help:</p>
<ul>
<li><p>Pods and Persistent Volumes will <em>eventually</em> recover</p>
</li>
<li><p>Stateful Sets give us easy ways to "add N copies" of a thing</p>
</li>
</ul>
</li>
<li><p>The real challenges come with configuration changes</p>
<p>(i.e., what to do when our users update our CRDs)</p>
</li>
<li><p>Keep in mind that <a href="https://www.datacenterdynamics.com/news/gcp-outage-mainone-leaked-google-cloudflare-ip-addresses-china-telecom/">some</a> of the <a href="https://aws.amazon.com/message/41926/">largest</a> cloud <a href="https://aws.amazon.com/message/65648/">outages</a> haven't been caused by <a href="https://www.datacenterknowledge.com/amazon/aws-says-it-s-never-seen-whole-data-center-go-down">natural catastrophes</a>, or even code bugs, but by configuration changes
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p>
</li>
</ul><div class="remark-slide-number">1149 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="configuration-changes">Configuration changes</h2>
<ul>
<li><p>It is helpful to analyze and understand how Kubernetes controllers work:</p>
<ul>
<li><p>watch resource for modifications</p>
</li>
<li><p>compare desired state (CRD) and current state</p>
</li>
<li><p>issue actions to converge state</p>
</li>
</ul>
</li>
<li><p>Configuration changes will probably require <em>another</em> state diagram or FSA</p>
</li>
<li><p>Again, it's OK to have transitions labeled as "unsupported"</p>
<p>(i.e. reject some modifications because we can't execute them)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1150 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="tools">Tools</h2>
<ul>
<li><p>CoreOS / RedHat Operator Framework</p>
<p><a href="https://github.com/operator-framework">GitHub</a>
|
<a href="https://developers.redhat.com/blog/2018/12/18/introduction-to-the-kubernetes-operator-framework/">Blog</a>
|
<a href="https://www.youtube.com/watch?v=8k_ayO1VRXE">Intro talk</a>
|
<a href="https://www.youtube.com/watch?v=fu7ecA2rXmc">Deep dive talk</a></p>
</li>
<li><p>Zalando Kubernetes Operator Pythonic Framework (KOPF)</p>
<p><a href="https://github.com/zalando-incubator/kopf">GitHub</a>
|
<a href="https://kopf.readthedocs.io/">Docs</a>
|
<a href="https://kopf.readthedocs.io/en/stable/walkthrough/problem/">Step-by-step tutorial</a></p>
</li>
<li><p>Mesosphere Kubernetes Universal Declarative Operator (KUDO)</p>
<p><a href="https://github.com/kudobuilder/kudo">GitHub</a>
|
<a href="https://mesosphere.com/blog/announcing-maestro-a-declarative-no-code-approach-to-kubernetes-day-2-operators/">Blog</a>
|
<a href="https://kudo.dev/">Docs</a>
|
<a href="https://github.com/kudobuilder/frameworks/tree/master/repo/stable/zookeeper">Zookeeper example</a></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1151 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="validation">Validation</h2>
<ul>
<li><p>By default, a CRD is "free form"</p>
<p>(we can put pretty much anything we want in it)</p>
</li>
<li><p>When creating a CRD, we can provide an OpenAPI v3 schema
(<a href="https://github.com/amaizfinance/redis-operator/blob/master/deploy/crds/k8s_v1alpha1_redis_crd.yaml#L34">Example</a>)</p>
</li>
<li><p>The API server will then validate resources created/edited with this schema</p>
</li>
<li><p>If we need a stronger validation, we can use a Validating Admission Webhook:</p>
<ul>
<li><p>run an <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#write-an-admission-webhook-server">admission webhook server</a> to receive validation requests</p>
</li>
<li><p>register the webhook by creating a <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#configure-admission-webhooks-on-the-fly">ValidatingWebhookConfiguration</a></p>
</li>
<li><p>each time the API server receives a request matching the configuration,
<br>the request is sent to our server for validation</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1152 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="presentation">Presentation</h2>
<ul>
<li><p>By default, <code class="remark-inline-code">kubectl get mycustomresource</code> won't display much information</p>
<p>(just the name and age of each resource)</p>
</li>
<li><p>When creating a CRD, we can specify additional columns to print
(<a href="https://github.com/amaizfinance/redis-operator/blob/master/deploy/crds/k8s_v1alpha1_redis_crd.yaml#L6">Example</a>,
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#additional-printer-columns">Docs</a>)</p>
</li>
<li><p>By default, <code class="remark-inline-code">kubectl describe mycustomresource</code> will also be generic</p>
</li>
<li><p><code class="remark-inline-code">kubectl describe</code> can show events related to our custom resources</p>
<p>(for that, we need to create Event resources, and fill the <code class="remark-inline-code">involvedObject</code> field)</p>
</li>
<li><p>For scalable resources, we can define a <code class="remark-inline-code">scale</code> sub-resource</p>
</li>
<li><p>This will enable the use of <code class="remark-inline-code">kubectl scale</code> and other scaling-related operations</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1153 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="about-scaling">About scaling</h2>
<ul>
<li><p>It is possible to use the HPA (Horizontal Pod Autoscaler) with CRDs</p>
</li>
<li><p>But it is not always desirable</p>
</li>
<li><p>The HPA works very well for homogenous, stateless workloads</p>
</li>
<li><p>For other workloads, your mileage may vary</p>
</li>
<li><p>Some systems can scale across multiple dimensions</p>
<p>(for instance: increase number of replicas, or number of shards?)</p>
</li>
<li><p>If autoscaling is desired, the operator will have to take complex decisions</p>
<p>(example: Zalando's Elasticsearch Operator (<a href="https://www.youtube.com/watch?v=lprE0J0kAq0">Video</a>))</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1154 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="versioning">Versioning</h2>
<ul>
<li><p>As our operator evolves over time, we may have to change the CRD</p>
<p>(add, remove, change fields)</p>
</li>
<li><p>Like every other resource in Kubernetes, <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definition-versioning/">custom resources are versioned</a></p>
</li>
<li><p>When creating a CRD, we need to specify a <em>list</em> of versions</p>
</li>
<li><p>Versions can be marked as <code class="remark-inline-code">stored</code> and/or <code class="remark-inline-code">served</code></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1155 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="stored-version">Stored version</h2>
<ul>
<li><p>Exactly one version has to be marked as the <code class="remark-inline-code">stored</code> version</p>
</li>
<li><p>As the name implies, it is the one that will be stored in etcd</p>
</li>
<li><p>Resources in storage are never converted automatically</p>
<p>(we need to read and re-write them ourselves)</p>
</li>
<li><p>Yes, this means that we can have different versions in etcd at any time</p>
</li>
<li><p>Our code needs to handle all the versions that still exist in storage</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1156 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="served-versions">Served versions</h2>
<ul>
<li><p>By default, the Kubernetes API will serve resources "as-is"</p>
<p>(using their stored version)</p>
</li>
<li><p>It will assume that all versions are compatible storage-wise</p>
<p>(i.e. that the spec and fields are compatible between versions)</p>
</li>
<li><p>We can provide <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definition-versioning/#webhook-conversion">conversion webhooks</a> to "translate" requests</p>
<p>(the alternative is to upgrade all stored resources and stop serving old versions)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1157 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="operator-reliability">Operator reliability</h2>
<ul>
<li><p>Remember that the operator itself must be resilient</p>
<p>(e.g.: the node running it can fail)</p>
</li>
<li><p>Our operator must be able to restart and recover gracefully</p>
</li>
<li><p>Do not store state locally</p>
<p>(unless we can reconstruct that state when we restart)</p>
</li>
<li><p>As indicated earlier, we can use the Kubernetes API to store data:</p>
<ul>
<li><p>in the custom resources themselves</p>
</li>
<li><p>in other resources' annotations</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1158 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="beyond-crds">Beyond CRDs</h2>
<ul>
<li><p>CRDs cannot use custom storage (e.g. for time series data)</p>
</li>
<li><p>CRDs cannot support arbitrary subresources (like logs or exec for Pods)</p>
</li>
<li><p>CRDs cannot support protobuf (for faster, more efficient communication)</p>
</li>
<li><p>If we need these things, we can use the <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">aggregation layer</a> instead</p>
</li>
<li><p>The aggregation layer proxies all requests below a specific path to another server</p>
<p>(this is used e.g. by the metrics server)</p>
</li>
<li><p><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#choosing-a-method-for-adding-custom-resources">This documentation page</a> compares the features of CRDs and API aggregation</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/operators-design.md">k8s/operators-design.md</a></span></p><div class="remark-slide-number">1159 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/aerial-view-of-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1160 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-stateful-sets" class="remark-slide-content title hljs-default"><p>Stateful sets</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-operators">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-16">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-running-a-consul-cluster">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1161 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="stateful-sets">Stateful sets</h1>
<ul>
<li><p>Stateful sets are a type of resource in the Kubernetes API</p>
<p>(like pods, deployments, services...)</p>
</li>
<li><p>They offer mechanisms to deploy scaled stateful applications</p>
</li>
<li><p>At a first glance, they look like <em>deployments</em>:</p>
<ul>
<li><p>a stateful set defines a pod spec and a number of replicas <em>R</em></p>
</li>
<li><p>it will make sure that <em>R</em> copies of the pod are running</p>
</li>
<li><p>that number can be changed while the stateful set is running</p>
</li>
<li><p>updating the pod spec will cause a rolling update to happen</p>
</li>
</ul>
</li>
<li><p>But they also have some significant differences</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1162 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="stateful-sets-unique-features">Stateful sets unique features</h2>
<ul>
<li><p>Pods in a stateful set are numbered (from 0 to <em>R-1</em>) and ordered</p>
</li>
<li><p>They are started and updated in order (from 0 to <em>R-1</em>)</p>
</li>
<li><p>A pod is started (or updated) only when the previous one is ready</p>
</li>
<li><p>They are stopped in reverse order (from <em>R-1</em> to 0)</p>
</li>
<li><p>Each pod know its identity (i.e. which number it is in the set)</p>
</li>
<li><p>Each pod can discover the IP address of the others easily</p>
</li>
<li><p>The pods can persist data on attached volumes</p>
</li>
</ul>
<p>🤔 Wait a minute ... Can't we already attach volumes to pods and deployments?</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1163 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="revisiting-volumes">Revisiting volumes</h2>
<ul>
<li><p><a href="https://kubernetes.io/docs/concepts/storage/volumes/">Volumes</a> are used for many purposes:</p>
<ul>
<li><p>sharing data between containers in a pod</p>
</li>
<li><p>exposing configuration information and secrets to containers</p>
</li>
<li><p>accessing storage systems</p>
</li>
</ul>
</li>
<li><p>Let's see examples of the latter usage</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1164 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="volumes-types">Volumes types</h2>
<ul>
<li><p>There are many <a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes">types of volumes</a> available:</p>
<ul>
<li><p>public cloud storage (GCEPersistentDisk, AWSElasticBlockStore, AzureDisk...)</p>
</li>
<li><p>private cloud storage (Cinder, VsphereVolume...)</p>
</li>
<li><p>traditional storage systems (NFS, iSCSI, FC...)</p>
</li>
<li><p>distributed storage (Ceph, Glusterfs, Portworx...)</p>
</li>
</ul>
</li>
<li><p>Using a persistent volume requires:</p>
<ul>
<li><p>creating the volume out-of-band (outside of the Kubernetes API)</p>
</li>
<li><p>referencing the volume in the pod description, with all its parameters</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1165 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-a-cloud-volume">Using a cloud volume</h2>
<p>Here is a pod definition using an AWS EBS volume (that has to be created first):</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> pod-using-my-ebs-volume</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - image:</span> ...</div><div class="remark-code-line"><span class="hljs-attr">    name:</span> container-using-my-ebs-volume</div><div class="remark-code-line"><span class="hljs-attr">    volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">    - mountPath:</span> /my-ebs</div><div class="remark-code-line"><span class="hljs-attr">      name:</span> my-ebs-volume</div><div class="remark-code-line"><span class="hljs-attr">  volumes:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> my-ebs-volume</div><div class="remark-code-line"><span class="hljs-attr">    awsElasticBlockStore:</span></div><div class="remark-code-line"><span class="hljs-attr">      volumeID:</span> vol<span class="hljs-bullet">-049</span>df61146c4d7901</div><div class="remark-code-line"><span class="hljs-attr">      fsType:</span> ext4</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1166 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-an-nfs-volume">Using an NFS volume</h2>
<p>Here is another example using a volume on an NFS server:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> pod-using-my-nfs-volume</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - image:</span> ...</div><div class="remark-code-line"><span class="hljs-attr">    name:</span> container-using-my-nfs-volume</div><div class="remark-code-line"><span class="hljs-attr">    volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">    - mountPath:</span> /my-nfs</div><div class="remark-code-line"><span class="hljs-attr">      name:</span> my-nfs-volume</div><div class="remark-code-line"><span class="hljs-attr">  volumes:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> my-nfs-volume</div><div class="remark-code-line"><span class="hljs-attr">      nfs:</span></div><div class="remark-code-line"><span class="hljs-attr">        server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.55</span></div><div class="remark-code-line"><span class="hljs-attr">        path:</span> <span class="hljs-string">"/exports/assets"</span></div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1167 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="shortcomings-of-volumes">Shortcomings of volumes</h2>
<ul>
<li><p>Their lifecycle (creation, deletion...) is managed outside of the Kubernetes API</p>
<p>(we can't just use <code class="remark-inline-code">kubectl apply/create/delete/...</code> to manage them)</p>
</li>
<li><p>If a Deployment uses a volume, all replicas end up using the same volume</p>
</li>
<li><p>That volume must then support concurrent access</p>
<ul>
<li><p>some volumes do (e.g. NFS servers support multiple read/write access)</p>
</li>
<li><p>some volumes support concurrent reads</p>
</li>
<li><p>some volumes support concurrent access for colocated pods</p>
</li>
</ul>
</li>
<li><p>What we really need is a way for each replica to have its own volume</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1168 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="persistent-volume-claims">Persistent Volume Claims</h2>
<ul>
<li><p>To abstract the different types of storage, a pod can use a special volume type</p>
</li>
<li><p>This type is a <em>Persistent Volume Claim</em></p>
</li>
<li><p>A Persistent Volume Claim (PVC) is a resource type</p>
<p>(visible with <code class="remark-inline-code">kubectl get persistentvolumeclaims</code> or <code class="remark-inline-code">kubectl get pvc</code>)</p>
</li>
<li><p>A PVC is not a volume; it is a <em>request for a volume</em></p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1169 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="persistent-volume-claims-in-practice">Persistent Volume Claims in practice</h2>
<ul>
<li><p>Using a Persistent Volume Claim is a two-step process:</p>
<ul>
<li><p>creating the claim</p>
</li>
<li><p>using the claim in a pod (as if it were any other kind of volume)</p>
</li>
</ul>
</li>
<li><p>A PVC starts by being Unbound (without an associated volume)</p>
</li>
<li><p>Once it is associated with a Persistent Volume, it becomes Bound</p>
</li>
<li><p>A Pod referring an unbound PVC will not start</p>
<p>(but as soon as the PVC is bound, the Pod can start)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1170 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="binding-pv-and-pvc">Binding PV and PVC</h2>
<ul>
<li><p>A Kubernetes controller continuously watches PV and PVC objects</p>
</li>
<li><p>When it notices an unbound PVC, it tries to find a satisfactory PV</p>
<p>("satisfactory" in terms of size and other characteristics; see next slide)</p>
</li>
<li><p>If no PV fits the PVC, a PV can be created dynamically</p>
<p>(this requires to configure a <em>dynamic provisioner</em>, more on that later)</p>
</li>
<li><p>Otherwise, the PVC remains unbound indefinitely</p>
<p>(until we manually create a PV or setup dynamic provisioning)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1171 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-in-a-persistent-volume-claim-">What's in a Persistent Volume Claim?</h2>
<ul>
<li><p>At the very least, the claim should indicate:</p>
<ul>
<li><p>the size of the volume (e.g. "5 GiB")</p>
</li>
<li><p>the access mode (e.g. "read-write by a single pod")</p>
</li>
</ul>
</li>
<li><p>Optionally, it can also specify a Storage Class</p>
</li>
<li><p>The Storage Class indicates:</p>
<ul>
<li><p>which storage system to use (e.g. Portworx, EBS...)</p>
</li>
<li><p>extra parameters for that storage system</p>
</li>
</ul>
<p>e.g.: "replicate the data 3 times, and use SSD media"</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1172 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-a-storage-class-">What's a Storage Class?</h2>
<ul>
<li><p>A Storage Class is yet another Kubernetes API resource</p>
<p>(visible with e.g. <code class="remark-inline-code">kubectl get storageclass</code> or <code class="remark-inline-code">kubectl get sc</code>)</p>
</li>
<li><p>It indicates which <em>provisioner</em> to use</p>
<p>(which controller will create the actual volume)</p>
</li>
<li><p>And arbitrary parameters for that provisioner</p>
<p>(replication levels, type of disk ... anything relevant!)</p>
</li>
<li><p>Storage Classes are required if we want to use <a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">dynamic provisioning</a></p>
<p>(but we can also create volumes manually, and ignore Storage Classes)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1173 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="defining-a-persistent-volume-claim">Defining a Persistent Volume Claim</h2>
<p>Here is a minimal PVC:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">kind:</span> PersistentVolumeClaim</div><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">   name:</span> my-claim</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">   accessModes:</span></div><div class="remark-code-line"><span class="hljs-bullet">     -</span> ReadWriteOnce</div><div class="remark-code-line"><span class="hljs-attr">   resources:</span></div><div class="remark-code-line"><span class="hljs-attr">     requests:</span></div><div class="remark-code-line"><span class="hljs-attr">       storage:</span> <span class="hljs-number">1</span>Gi</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1174 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="using-a-persistent-volume-claim">Using a Persistent Volume Claim</h2>
<p>Here is a Pod definition like the ones shown earlier, but using a PVC:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> Pod</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> pod-using-a-claim</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  containers:</span></div><div class="remark-code-line"><span class="hljs-attr">  - image:</span> ...</div><div class="remark-code-line"><span class="hljs-attr">    name:</span> container-using-a-claim</div><div class="remark-code-line"><span class="hljs-attr">    volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">    - mountPath:</span> /my-vol</div><div class="remark-code-line"><span class="hljs-attr">      name:</span> my-volume</div><div class="remark-code-line"><span class="hljs-attr">  volumes:</span></div><div class="remark-code-line"><span class="hljs-attr">  - name:</span> my-volume</div><div class="remark-code-line"><span class="hljs-attr">    persistentVolumeClaim:</span></div><div class="remark-code-line"><span class="hljs-attr">      claimName:</span> my-claim</div></code></pre>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1175 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="persistent-volume-claims-and-stateful-sets">Persistent Volume Claims and Stateful sets</h2>
<ul>
<li><p>The pods in a stateful set can define a <code class="remark-inline-code">volumeClaimTemplate</code></p>
</li>
<li><p>A <code class="remark-inline-code">volumeClaimTemplate</code> will dynamically create one Persistent Volume Claim per pod</p>
</li>
<li><p>Each pod will therefore have its own volume</p>
</li>
<li><p>These volumes are numbered (like the pods)</p>
</li>
<li><p>When updating the stateful set (e.g. image upgrade), each pod keeps its volume</p>
</li>
<li><p>When pods get rescheduled (e.g. node failure), they keep their volume</p>
<p>(this requires a storage system that is not node-local)</p>
</li>
<li><p>These volumes are not automatically deleted</p>
<p>(when the stateful set is scaled down or deleted)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1176 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="stateful-set-recap">Stateful set recap</h2>
<ul>
<li><p>A Stateful sets manages a number of identical pods</p>
<p>(like a Deployment)</p>
</li>
<li><p>These pods are numbered, and started/upgraded/stopped in a specific order</p>
</li>
<li><p>These pods are aware of their number</p>
<p>(e.g., #0 can decide to be the primary, and #1 can be secondary)</p>
</li>
<li><p>These pods can find the IP addresses of the other pods in the set</p>
<p>(through a <em>headless service</em>)</p>
</li>
<li><p>These pods can each have their own persistent storage</p>
<p>(Deployments cannot do that)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1177 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/blue-containers.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1178 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-running-a-consul-cluster" class="remark-slide-content title hljs-default"><p>Running a Consul cluster</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-stateful-sets">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-16">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-local-persistent-volumes">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1179 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="running-a-consul-cluster">Running a Consul cluster</h1>
<ul>
<li><p>Here is a good use-case for Stateful sets!</p>
</li>
<li><p>We are going to deploy a Consul cluster with 3 nodes</p>
</li>
<li><p>Consul is a highly-available key/value store</p>
<p>(like etcd or Zookeeper)</p>
</li>
<li><p>One easy way to bootstrap a cluster is to tell each node:</p>
<ul>
<li><p>the addresses of other nodes</p>
</li>
<li><p>how many nodes are expected (to know when quorum is reached)</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1180 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bootstrapping-a-consul-cluster">Bootstrapping a Consul cluster</h2>
<p><em>After reading the Consul documentation carefully (and/or asking around),
we figure out the minimal command-line to run our Consul cluster.</em></p>
<pre><code class="remark-code"><div class="remark-code-line">consul agent -data=dir=/consul/data -client=0.0.0.0 -server -ui \</div><div class="remark-code-line">       -bootstrap-expect=3 \</div><div class="remark-code-line">       -retry-join=<span class="remark-code-span-highlighted">X.X.X.X</span> \</div><div class="remark-code-line">       -retry-join=<span class="remark-code-span-highlighted">Y.Y.Y.Y</span></div></code></pre><ul>
<li><p>Replace X.X.X.X and Y.Y.Y.Y with the addresses of other nodes</p>
</li>
<li><p>The same command-line can be used on all nodes (convenient!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1181 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="cloud-auto-join">Cloud Auto-join</h2>
<ul>
<li><p>Since version 1.4.0, Consul can use the Kubernetes API to find its peers</p>
</li>
<li><p>This is called <a href="https://www.consul.io/docs/agent/cloud-auto-join.html#kubernetes-k8s-">Cloud Auto-join</a></p>
</li>
<li><p>Instead of passing an IP address, we need to pass a parameter like this:</p>
<pre><code class="remark-code"><div class="remark-code-line">consul agent -retry-join "provider=k8s label_selector=\"app=consul\""</div></code></pre></li>
<li><p>Consul needs to be able to talk to the Kubernetes API</p>
</li>
<li><p>We can provide a <code class="remark-inline-code">kubeconfig</code> file</p>
</li>
<li><p>If Consul runs in a pod, it will use the <em>service account</em> of the pod
<span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p>
</li>
</ul><div class="remark-slide-number">1182 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-cloud-auto-join">Setting up Cloud auto-join</h2>
<ul>
<li><p>We need to create a service account for Consul</p>
</li>
<li><p>We need to create a role that can <code class="remark-inline-code">list</code> and <code class="remark-inline-code">get</code> pods</p>
</li>
<li><p>We need to bind that role to the service account</p>
</li>
<li><p>And of course, we need to make sure that Consul pods use that service account</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1183 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="putting-it-all-together">Putting it all together</h2>
<ul>
<li><p>The file <code class="remark-inline-code">k8s/consul.yaml</code> defines the required resources</p>
<p>(service account, cluster role, cluster role binding, service, stateful set)</p>
</li>
<li><p>It has a few extra touches:</p>
<ul>
<li><p>a <code class="remark-inline-code">podAntiAffinity</code> prevents two pods from running on the same node</p>
</li>
<li><p>a <code class="remark-inline-code">preStop</code> hook makes the pod leave the cluster when shutdown gracefully</p>
</li>
</ul>
</li>
</ul>
<p>This was inspired by this <a href="https://github.com/kelseyhightower/consul-on-kubernetes">excellent tutorial</a> by Kelsey Hightower.
Some features from the original tutorial (TLS authentication between
nodes and encryption of gossip traffic) were removed for simplicity.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1184 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-our-consul-cluster">Running our Consul cluster</h2>
<ul>
<li>We'll use the provided YAML file</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the stateful set and associated service:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/consul.yaml</div></code></pre>
</li>
<li><p>Check the logs as the pods come up one after another:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">stern consul</div></code></pre>
</li>
</ul>
<!--
```wait Synced node info```
```keys ^C```
-->

<ul>
<li>Check the health of the cluster:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl <span class="hljs-built_in">exec</span> consul-0 consul members</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1185 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="caveats">Caveats</h2>
<ul>
<li><p>We haven't used a <code class="remark-inline-code">volumeClaimTemplate</code> here</p>
</li>
<li><p>That's because we don't have a storage provider yet</p>
<p>(except if you're running this on your own and your cluster has one)</p>
</li>
<li><p>What happens if we lose a pod?</p>
<ul>
<li><p>a new pod gets rescheduled (with an empty state)</p>
</li>
<li><p>the new pod tries to connect to the two others</p>
</li>
<li><p>it will be accepted (after 1-2 minutes of instability)</p>
</li>
<li><p>and it will retrieve the data from the other pods</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1186 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="failure-modes">Failure modes</h2>
<ul>
<li><p>What happens if we lose two pods?</p>
<ul>
<li><p>manual repair will be required</p>
</li>
<li><p>we will need to instruct the remaining one to act solo</p>
</li>
<li><p>then rejoin new pods</p>
</li>
</ul>
</li>
<li><p>What happens if we lose three pods? (aka all of them)</p>
<ul>
<li>we lose all the data (ouch)</li>
</ul>
</li>
<li><p>If we run Consul without persistent storage, backups are a good idea!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/statefulsets.md">k8s/statefulsets.md</a></span></p><div class="remark-slide-number">1187 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/chinook-helicopter-container.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1188 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-local-persistent-volumes" class="remark-slide-content title hljs-default"><p>Local Persistent Volumes</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-running-a-consul-cluster">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-16">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-highly-available-persistent-volumes">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1189 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="local-persistent-volumes">Local Persistent Volumes</h1>
<ul>
<li><p>We want to run that Consul cluster <em>and</em> actually persist data</p>
</li>
<li><p>But we don't have a distributed storage system</p>
</li>
<li><p>We are going to use local volumes instead</p>
<p>(similar conceptually to <code class="remark-inline-code">hostPath</code> volumes)</p>
</li>
<li><p>We can use local volumes without installing extra plugins</p>
</li>
<li><p>However, they are tied to a node</p>
</li>
<li><p>If that node goes down, the volume becomes unavailable</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1190 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="with-or-without-dynamic-provisioning">With or without dynamic provisioning</h2>
<ul>
<li><p>We will deploy a Consul cluster <em>with</em> persistence</p>
</li>
<li><p>That cluster's StatefulSet will create PVCs</p>
</li>
<li><p>These PVCs will remain unbound¹, until we will create local volumes manually</p>
<p>(we will basically do the job of the dynamic provisioner)</p>
</li>
<li><p>Then, we will see how to automate that with a dynamic provisioner</p>
</li>
</ul>
<p><span class="footnote">¹Unbound = without an associated Persistent Volume.</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1191 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="if-we-have-a-dynamic-provisioner-">If we have a dynamic provisioner ...</h2>
<ul>
<li><p>The labs in this section assume that we <em>do not</em> have a dynamic provisioner</p>
</li>
<li><p>If we do have one, we need to disable it</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Check if we have a dynamic provisioner:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get storageclass</div></code></pre>
</li>
<li><p>If the output contains a line with <code class="remark-inline-code">(default)</code>, run this command:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl annotate sc storageclass.kubernetes.io/is-default-class- --all</div></code></pre>
</li>
<li><p>Check again that it is no longer marked as <code class="remark-inline-code">(default)</code></p>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1192 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="work-in-a-separate-namespace">Work in a separate namespace</h2>
<ul>
<li>To avoid conflicts with existing resources, let's create and use a new namespace</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a new namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl create namespace orange</div></code></pre>
</li>
<li><p>Switch to that namespace:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kns orange</div></code></pre>
</li>
</ul>
</div>

<p><span class="warning">Make sure to call that namespace <code class="remark-inline-code">orange</code>: it is hardcoded in the YAML files.</span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1193 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="deploying-consul">Deploying Consul</h2>
<ul>
<li><p>We will use a slightly different YAML file</p>
</li>
<li><p>The only differences between that file and the previous one are:</p>
<ul>
<li><p><code class="remark-inline-code">volumeClaimTemplate</code> defined in the Stateful Set spec</p>
</li>
<li><p>the corresponding <code class="remark-inline-code">volumeMounts</code> in the Pod spec</p>
</li>
<li><p>the namespace <code class="remark-inline-code">orange</code> used for discovery of Pods</p>
</li>
</ul>
</li>
</ul>
<div class="exercise"><ul>
<li>Apply the persistent Consul YAML file:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/persistent-consul.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1194 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="observing-the-situation">Observing the situation</h2>
<ul>
<li>Let's look at Persistent Volume Claims and Pods</li>
</ul>
<div class="exercise"><ul>
<li><p>Check that we now have an unbound Persistent Volume Claim:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pvc</div></code></pre>
</li>
<li><p>We don't have any Persistent Volume:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pv</div></code></pre>
</li>
<li><p>The Pod <code class="remark-inline-code">consul-0</code> is not scheduled yet:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pods -o wide</div></code></pre>
</li>
</ul>
</div>

<p><em>Hint: leave these commands running with <code class="remark-inline-code">-w</code> in different windows.</em></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1195 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="explanations">Explanations</h2>
<ul>
<li><p>In a Stateful Set, the Pods are started one by one</p>
</li>
<li><p><code class="remark-inline-code">consul-1</code> won't be created until <code class="remark-inline-code">consul-0</code> is running</p>
</li>
<li><p><code class="remark-inline-code">consul-0</code> has a dependency on an unbound Persistent Volume Claim</p>
</li>
<li><p>The scheduler won't schedule the Pod until the PVC is bound</p>
<p>(because the PVC might be bound to a volume that is only available on a subset of nodes; for instance EBS are tied to an availability zone)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1196 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-persistent-volumes">Creating Persistent Volumes</h2>
<ul>
<li><p>Let's create 3 local directories (<code class="remark-inline-code">/mnt/consul</code>) on node2, node3, node4</p>
</li>
<li><p>Then create 3 Persistent Volumes corresponding to these directories</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the local directories:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-keyword">for</span> NODE <span class="hljs-keyword">in</span> node2 node3 node4; <span class="hljs-keyword">do</span></div><div class="remark-code-line">  ssh <span class="hljs-variable">$NODE</span> sudo mkdir -p /mnt/consul</div><div class="remark-code-line"><span class="hljs-keyword">done</span></div></code></pre>
</li>
<li><p>Create the PV objects:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/volumes-for-consul.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1197 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="check-our-consul-cluster">Check our Consul cluster</h2>
<ul>
<li><p>The PVs that we created will be automatically matched with the PVCs</p>
</li>
<li><p>Once a PVC is bound, its pod can start normally</p>
</li>
<li><p>Once the pod <code class="remark-inline-code">consul-0</code> has started, <code class="remark-inline-code">consul-1</code> can be created, etc.</p>
</li>
<li><p>Eventually, our Consul cluster is up, and backend by "persistent" volumes</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Check that our Consul clusters has 3 members indeed:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl <span class="hljs-built_in">exec</span> consul-0 consul members</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1198 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="devil-is-in-the-details-1-2-">Devil is in the details (1/2)</h2>
<ul>
<li><p>The size of the Persistent Volumes is bogus</p>
<p>(it is used when matching PVs and PVCs together, but there is no actual quota or limit)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1199 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="devil-is-in-the-details-2-2-">Devil is in the details (2/2)</h2>
<ul>
<li><p>This specific example worked because we had exactly 1 free PV per node:</p>
<ul>
<li><p>if we had created multiple PVs per node ...</p>
</li>
<li><p>we could have ended with two PVCs bound to PVs on the same node ...</p>
</li>
<li><p>which would have required two pods to be on the same node ...</p>
</li>
<li><p>which is forbidden by the anti-affinity constraints in the StatefulSet</p>
</li>
</ul>
</li>
<li><p>To avoid that, we need to associated the PVs with a Storage Class that has:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">volumeBindingMode:</span> WaitForFirstConsumer</div></code></pre>
<p>(this means that a PVC will be bound to a PV only after being used by a Pod)</p>
</li>
<li><p>See <a href="https://kubernetes.io/blog/2018/04/13/local-persistent-volumes-beta/">this blog post</a> for more details</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1200 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="bulk-provisioning">Bulk provisioning</h2>
<ul>
<li><p>It's not practical to manually create directories and PVs for each app</p>
</li>
<li><p>We <em>could</em> pre-provision a number of PVs across our fleet</p>
</li>
<li><p>We could even automate that with a Daemon Set:</p>
<ul>
<li><p>creating a number of directories on each node</p>
</li>
<li><p>creating the corresponding PV objects</p>
</li>
</ul>
</li>
<li><p>We also need to recycle volumes</p>
</li>
<li><p>... This can quickly get out of hand</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1201 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="dynamic-provisioning">Dynamic provisioning</h2>
<ul>
<li><p>We could also write our own provisioner, which would:</p>
<ul>
<li><p>watch the PVCs across all namespaces</p>
</li>
<li><p>when a PVC is created, create a corresponding PV on a node</p>
</li>
</ul>
</li>
<li><p>Or we could use one of the dynamic provisioners for local persistent volumes</p>
<p>(for instance the <a href="https://github.com/rancher/local-path-provisioner">Rancher local path provisioner</a>)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1202 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="strategies-for-local-persistent-volumes">Strategies for local persistent volumes</h2>
<ul>
<li><p>Remember, when a node goes down, the volumes on that node become unavailable</p>
</li>
<li><p>High availability will require another layer of replication</p>
<p>(like what we've just seen with Consul; or primary/secondary; etc)</p>
</li>
<li><p>Pre-provisioning PVs makes sense for machines with local storage</p>
<p>(e.g. cloud instance storage; or storage directly attached to a physical machine)</p>
</li>
<li><p>Dynamic provisioning makes sense for large number of applications</p>
<p>(when we can't or won't dedicate a whole disk to a volume)</p>
</li>
<li><p>It's possible to mix both (using distinct Storage Classes)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/local-persistent-volumes.md">k8s/local-persistent-volumes.md</a></span></p><div class="remark-slide-number">1203 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-cranes.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1204 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-highly-available-persistent-volumes" class="remark-slide-content title hljs-default"><p>Highly available Persistent Volumes</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-local-persistent-volumes">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-16">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-whats-next">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1205 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="highly-available-persistent-volumes">Highly available Persistent Volumes</h1>
<ul>
<li><p>How can we achieve true durability?</p>
</li>
<li><p>How can we store data that would survive the loss of a node?</p>
</li>
</ul><div class="remark-slide-number">1206 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="highly-available-persistent-volumes">Highly available Persistent Volumes</h1>
<ul>
<li><p>How can we achieve true durability?</p>
</li>
<li><p>How can we store data that would survive the loss of a node?</p>
</li>
<li><p>We need to use Persistent Volumes backed by highly available storage systems</p>
</li>
<li><p>There are many ways to achieve that:</p>
<ul>
<li><p>leveraging our cloud's storage APIs</p>
</li>
<li><p>using NAS/SAN systems or file servers</p>
</li>
<li><p>distributed storage systems</p>
</li>
</ul>
</li>
</ul><div class="remark-slide-number">1207 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="highly-available-persistent-volumes">Highly available Persistent Volumes</h1>
<ul>
<li><p>How can we achieve true durability?</p>
</li>
<li><p>How can we store data that would survive the loss of a node?</p>
</li>
<li><p>We need to use Persistent Volumes backed by highly available storage systems</p>
</li>
<li><p>There are many ways to achieve that:</p>
<ul>
<li><p>leveraging our cloud's storage APIs</p>
</li>
<li><p>using NAS/SAN systems or file servers</p>
</li>
<li><p>distributed storage systems</p>
</li>
</ul>
</li>
<li><p>We are going to see one distributed storage system in action</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1208 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-test-scenario">Our test scenario</h2>
<ul>
<li><p>We will set up a distributed storage system on our cluster</p>
</li>
<li><p>We will use it to deploy a SQL database (PostgreSQL)</p>
</li>
<li><p>We will insert some test data in the database</p>
</li>
<li><p>We will disrupt the node running the database</p>
</li>
<li><p>We will see how it recovers</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1209 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="portworx">Portworx</h2>
<ul>
<li><p>Portworx is a <em>commercial</em> persistent storage solution for containers</p>
</li>
<li><p>It works with Kubernetes, but also Mesos, Swarm ...</p>
</li>
<li><p>It provides <a href="https://en.wikipedia.org/wiki/Hyper-converged_infrastructure">hyper-converged</a> storage</p>
<p>(=storage is provided by regular compute nodes)</p>
</li>
<li><p>We're going to use it here because it can be deployed on any Kubernetes cluster</p>
<p>(it doesn't require any particular infrastructure)</p>
</li>
<li><p>We don't endorse or support Portworx in any particular way</p>
<p>(but we appreciate that it's super easy to install!)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1210 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="a-useful-reminder">A useful reminder</h2>
<ul>
<li><p>We're installing Portworx because we need a storage system</p>
</li>
<li><p>If you are using AKS, EKS, GKE ... you already have a storage system</p>
<p>(but you might want another one, e.g. to leverage local storage)</p>
</li>
<li><p>If you have setup Kubernetes yourself, there are other solutions available too</p>
<ul>
<li><p>on premises, you can use a good old SAN/NAS</p>
</li>
<li><p>on a private cloud like OpenStack, you can use e.g. Cinder</p>
</li>
<li><p>everywhere, you can use other systems, e.g. Gluster, StorageOS</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1211 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="portworx-requirements">Portworx requirements</h2>
<ul>
<li><p>Kubernetes cluster ✔️</p>
</li>
<li><p>Optional key/value store (etcd or Consul) ❌</p>
</li>
<li><p>At least one available block device ❌</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1212 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="the-key-value-store">The key-value store</h2>
<ul>
<li><p>In the current version of Portworx (1.4) it is recommended to use etcd or Consul</p>
</li>
<li><p>But Portworx also has beta support for an embedded key/value store</p>
</li>
<li><p>For simplicity, we are going to use the latter option</p>
<p>(but if we have deployed Consul or etcd, we can use that, too)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1213 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="one-available-block-device">One available block device</h2>
<ul>
<li><p>Block device = disk or partition on a disk</p>
</li>
<li><p>We can see block devices with <code class="remark-inline-code">lsblk</code></p>
<p>(or <code class="remark-inline-code">cat /proc/partitions</code> if we're old school like that!)</p>
</li>
<li><p>If we don't have a spare disk or partition, we can use a <em>loop device</em></p>
</li>
<li><p>A loop device is a block device actually backed by a file</p>
</li>
<li><p>These are frequently used to mount ISO (CD/DVD) images or VM disk images</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1214 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="setting-up-a-loop-device">Setting up a loop device</h2>
<ul>
<li><p>We are going to create a 10 GB (empty) file on each node</p>
</li>
<li><p>Then make a loop device from it, to be used by Portworx</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>Create a 10 GB file on each node:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-keyword">for</span> N <span class="hljs-keyword">in</span> $(seq 1 4); <span class="hljs-keyword">do</span> ssh node<span class="hljs-variable">$N</span> sudo truncate --size 10G /portworx.blk; <span class="hljs-keyword">done</span></div></code></pre>
<p>(If SSH asks to confirm host keys, enter <code class="remark-inline-code">yes</code> each time.)</p>
</li>
<li><p>Associate the file to a loop device on each node:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line"><span class="hljs-keyword">for</span> N <span class="hljs-keyword">in</span> $(seq 1 4); <span class="hljs-keyword">do</span> ssh node<span class="hljs-variable">$N</span> sudo losetup /dev/loop4 /portworx.blk; <span class="hljs-keyword">done</span></div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1215 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="installing-portworx">Installing Portworx</h2>
<ul>
<li><p>To install Portworx, we need to go to <a href="https://install.portworx.com/">https://install.portworx.com/</a></p>
</li>
<li><p>This website will ask us a bunch of questions about our cluster</p>
</li>
<li><p>Then, it will generate a YAML file that we should apply to our cluster</p>
</li>
</ul><div class="remark-slide-number">1216 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="installing-portworx">Installing Portworx</h2>
<ul>
<li><p>To install Portworx, we need to go to <a href="https://install.portworx.com/">https://install.portworx.com/</a></p>
</li>
<li><p>This website will ask us a bunch of questions about our cluster</p>
</li>
<li><p>Then, it will generate a YAML file that we should apply to our cluster</p>
</li>
<li><p>Or, we can just apply that YAML file directly (it's in <code class="remark-inline-code">k8s/portworx.yaml</code>)</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Install Portworx:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/portworx.yaml</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1217 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="generating-a-custom-yaml-file">Generating a custom YAML file</h2>
<p>If you want to generate a YAML file tailored to your own needs, the easiest
way is to use <a href="https://install.portworx.com/">https://install.portworx.com/</a>.</p>
<p>FYI, this is how we obtained the YAML file used earlier:</p>
<pre><code class="remark-code"><div class="remark-code-line">KBVER=$(kubectl version -o json | jq -r .serverVersion.gitVersion)</div><div class="remark-code-line">BLKDEV=/dev/loop4</div><div class="remark-code-line">curl https://install.portworx.com/1.4/?kbver=$KBVER&amp;b=true&amp;s=$BLKDEV&amp;c=px-workshop&amp;stork=true&amp;lh=true</div></code></pre><p>If you want to use an external key/value store, add one of the following:</p>
<pre><code class="remark-code"><div class="remark-code-line">&amp;k=etcd://<span class="remark-code-span-highlighted">XXX</span>:2379</div><div class="remark-code-line">&amp;k=consul://<span class="remark-code-span-highlighted">XXX</span>:8500</div></code></pre><p>... where <code class="remark-inline-code">XXX</code> is the name or address of your etcd or Consul server.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1218 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="waiting-for-portworx-to-be-ready">Waiting for Portworx to be ready</h2>
<ul>
<li>The installation process will take a few minutes</li>
</ul>
<div class="exercise"><ul>
<li><p>Check out the logs:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">stern -n kube-system portworx</div></code></pre>
</li>
<li><p>Wait until it gets quiet</p>
<p>(you should see <code class="remark-inline-code">portworx service is healthy</code>, too)</p>
</li>
</ul>
<!--
```longwait PX node status reports portworx service is healthy```
```keys ^C```
-->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1219 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="dynamic-provisioning-of-persistent-volumes">Dynamic provisioning of persistent volumes</h2>
<ul>
<li><p>We are going to run PostgreSQL in a Stateful set</p>
</li>
<li><p>The Stateful set will specify a <code class="remark-inline-code">volumeClaimTemplate</code></p>
</li>
<li><p>That <code class="remark-inline-code">volumeClaimTemplate</code> will create Persistent Volume Claims</p>
</li>
<li><p>Kubernetes' <a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">dynamic provisioning</a> will satisfy these Persistent Volume Claims</p>
<p>(by creating Persistent Volumes and binding them to the claims)</p>
</li>
<li><p>The Persistent Volumes are then available for the PostgreSQL pods</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1220 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="storage-classes">Storage Classes</h2>
<ul>
<li><p>It's possible that multiple storage systems are available</p>
</li>
<li><p>Or, that a storage system offers multiple tiers of storage</p>
<p>(SSD vs. magnetic; mirrored or not; etc.)</p>
</li>
<li><p>We need to tell Kubernetes <em>which</em> system and tier to use</p>
</li>
<li><p>This is achieved by creating a Storage Class</p>
</li>
<li><p>A <code class="remark-inline-code">volumeClaimTemplate</code> can indicate which Storage Class to use</p>
</li>
<li><p>It is also possible to mark a Storage Class as "default"</p>
<p>(it will be used if a <code class="remark-inline-code">volumeClaimTemplate</code> doesn't specify one)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1221 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-default-storage-class">Our default Storage Class</h2>
<p>This is our Storage Class (in <code class="remark-inline-code">k8s/storage-class.yaml</code>):</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">kind:</span> StorageClass</div><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> storage.k8s.io/v1beta1</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> portworx-replicated</div><div class="remark-code-line"><span class="hljs-attr">  annotations:</span></div><div class="remark-code-line">    storageclass.kubernetes.io/is-default-class: <span class="hljs-string">"true"</span></div><div class="remark-code-line"><span class="hljs-attr">provisioner:</span> kubernetes.io/portworx-volume</div><div class="remark-code-line"><span class="hljs-attr">parameters:</span></div><div class="remark-code-line"><span class="hljs-attr"> repl:</span> <span class="hljs-string">"2"</span></div><div class="remark-code-line"><span class="hljs-attr"> priority_io:</span> <span class="hljs-string">"high"</span></div></code></pre>
<ul>
<li><p>It says "use Portworx to create volumes"</p>
</li>
<li><p>It tells Portworx to "keep 2 replicas of these volumes"</p>
</li>
<li><p>It marks the Storage Class as being the default one</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1222 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-our-storage-class">Creating our Storage Class</h2>
<ul>
<li>Let's apply that YAML file!</li>
</ul>
<div class="exercise"><ul>
<li><p>Create the Storage Class:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/storage-class.yaml</div></code></pre>
</li>
<li><p>Check that it is now available:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get sc</div></code></pre>
</li>
</ul>
</div>

<p>It should show as <code class="remark-inline-code">portworx-replicated (default)</code>.</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1223 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="our-postgres-stateful-set">Our Postgres Stateful set</h2>
<ul>
<li><p>The next slide shows <code class="remark-inline-code">k8s/postgres.yaml</code></p>
</li>
<li><p>It defines a Stateful set</p>
</li>
<li><p>With a <code class="remark-inline-code">volumeClaimTemplate</code> requesting a 1 GB volume</p>
</li>
<li><p>That volume will be mounted to <code class="remark-inline-code">/var/lib/postgresql/data</code></p>
</li>
<li><p>There is another little detail: we enable the <code class="remark-inline-code">stork</code> scheduler</p>
</li>
<li><p>The <code class="remark-inline-code">stork</code> scheduler is optional (it's specific to Portworx)</p>
</li>
<li><p>It helps the Kubernetes scheduler to colocate the pod with its volume</p>
<p>(see <a href="https://portworx.com/stork-storage-orchestration-kubernetes/">this blog post</a> for more details about that)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1224 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><div class="small"><pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">apiVersion:</span> apps/v1</div><div class="remark-code-line"><span class="hljs-attr">kind:</span> StatefulSet</div><div class="remark-code-line"><span class="hljs-attr">metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">  name:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">spec:</span></div><div class="remark-code-line"><span class="hljs-attr">  selector:</span></div><div class="remark-code-line"><span class="hljs-attr">    matchLabels:</span></div><div class="remark-code-line"><span class="hljs-attr">      app:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">  serviceName:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">  template:</span></div><div class="remark-code-line"><span class="hljs-attr">    metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">      labels:</span></div><div class="remark-code-line"><span class="hljs-attr">        app:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">    spec:</span></div><div class="remark-code-line"><span class="hljs-attr">      schedulerName:</span> stork</div><div class="remark-code-line"><span class="hljs-attr">      containers:</span></div><div class="remark-code-line"><span class="hljs-attr">      - name:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">        image:</span> postgres:<span class="hljs-number">10.5</span></div><div class="remark-code-line"><span class="hljs-attr">        volumeMounts:</span></div><div class="remark-code-line"><span class="hljs-attr">        - mountPath:</span> /var/lib/postgresql/data</div><div class="remark-code-line"><span class="hljs-attr">          name:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">  volumeClaimTemplates:</span></div><div class="remark-code-line"><span class="hljs-attr">  - metadata:</span></div><div class="remark-code-line"><span class="hljs-attr">      name:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">    spec:</span></div><div class="remark-code-line"><span class="hljs-attr">      accessModes:</span> [<span class="hljs-string">"ReadWriteOnce"</span>]</div><div class="remark-code-line"><span class="hljs-attr">      resources:</span></div><div class="remark-code-line"><span class="hljs-attr">        requests:</span></div><div class="remark-code-line"><span class="hljs-attr">          storage:</span> <span class="hljs-number">1</span>Gi</div></code></pre>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1225 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="creating-the-stateful-set">Creating the Stateful set</h2>
<ul>
<li>Before applying the YAML, watch what's going on with <code class="remark-inline-code">kubectl get events -w</code></li>
</ul>
<div class="exercise"><ul>
<li>Apply that YAML:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl apply <span class="hljs-_">-f</span> ~/container.training/k8s/postgres.yaml</div></code></pre>
</li>
</ul>
<!-- ```hide kubectl wait pod postgres-0 --for condition=ready``` -->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1226 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="testing-our-postgresql-pod">Testing our PostgreSQL pod</h2>
<ul>
<li><p>We will use <code class="remark-inline-code">kubectl exec</code> to get a shell in the pod</p>
</li>
<li><p>Good to know: we need to use the <code class="remark-inline-code">postgres</code> user in the pod</p>
</li>
</ul>
<div class="exercise"><ul>
<li>Get a shell in the pod, as the <code class="remark-inline-code">postgres</code> user:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl <span class="hljs-built_in">exec</span> -ti postgres-0 su postgres</div></code></pre>
</li>
</ul>
<!--
autopilot prompt detection expects $ or # at the beginning of the line.
```wait postgres@postgres```
```keys PS1="\u@\h:\w\n\$ "```
```keys ^J```
-->

<ul>
<li>Check that default databases have been created correctly:<pre><code class="bash hljs remark-code"><div class="remark-code-line">psql <span class="hljs-_">-l</span></div></code></pre>
</li>
</ul>
</div>

<p>(This should show us 3 lines: postgres, template0, and template1.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1227 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="inserting-data-in-postgresql">Inserting data in PostgreSQL</h2>
<ul>
<li>We will create a database and populate it with <code class="remark-inline-code">pgbench</code></li>
</ul>
<div class="exercise"><ul>
<li><p>Create a database named <code class="remark-inline-code">demo</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">createdb demo</div></code></pre>
</li>
<li><p>Populate it with <code class="remark-inline-code">pgbench</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">pgbench -i <span class="hljs-_">-s</span> 10 demo</div></code></pre>
</li>
</ul>
</div>

<ul>
<li><p>The <code class="remark-inline-code">-i</code> flag means "create tables"</p>
</li>
<li><p>The <code class="remark-inline-code">-s 10</code> flag means "create 10 x 100,000 rows"</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1228 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="checking-how-much-data-we-have-now">Checking how much data we have now</h2>
<ul>
<li>The <code class="remark-inline-code">pgbench</code> tool inserts rows in table <code class="remark-inline-code">pgbench_accounts</code></li>
</ul>
<div class="exercise"><ul>
<li><p>Check that the <code class="remark-inline-code">demo</code> base exists:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">psql <span class="hljs-_">-l</span></div></code></pre>
</li>
<li><p>Check how many rows we have in <code class="remark-inline-code">pgbench_accounts</code>:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">psql demo -c <span class="hljs-string">"select count(*) from pgbench_accounts"</span></div></code></pre>
</li>
</ul>
<!-- ```keys ^D``` -->

</div>

<p>(We should see a count of 1,000,000 rows.)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1229 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="find-out-which-node-is-hosting-the-database">Find out which node is hosting the database</h2>
<ul>
<li>We can find that information with <code class="remark-inline-code">kubectl get pods -o wide</code></li>
</ul>
<div class="exercise"><ul>
<li>Check the node running the database:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod postgres-0 -o wide</div></code></pre>
</li>
</ul>
</div>

<p>We are going to disrupt that node.</p><div class="remark-slide-number">1230 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h2 id="find-out-which-node-is-hosting-the-database">Find out which node is hosting the database</h2>
<ul>
<li>We can find that information with <code class="remark-inline-code">kubectl get pods -o wide</code></li>
</ul>
<div class="exercise"><ul>
<li>Check the node running the database:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod postgres-0 -o wide</div></code></pre>
</li>
</ul>
</div>

<p>We are going to disrupt that node.</p>
<p>By "disrupt" we mean: "disconnect it from the network".</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1231 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="disconnect-the-node">Disconnect the node</h2>
<ul>
<li><p>We will use <code class="remark-inline-code">iptables</code> to block all traffic exiting the node</p>
<p>(except SSH traffic, so we can repair the node later if needed)</p>
</li>
</ul>
<div class="exercise"><ul>
<li><p>SSH to the node to disrupt:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ssh <span class="remark-code-span-highlighted">nodeX</span></div></code></pre>
</li>
<li><p>Allow SSH traffic leaving the node, but block all other traffic:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo iptables -I OUTPUT -p tcp --sport 22 -j ACCEPT</div><div class="remark-code-line">sudo iptables -I OUTPUT 2 -j DROP</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1232 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="check-that-the-node-is-disconnected">Check that the node is disconnected</h2>
<div class="exercise"><ul>
<li><p>Check that the node can't communicate with other nodes:</p>
<pre><code class="remark-code"><div class="remark-code-line">ping node1</div></code></pre></li>
<li><p>Logout to go back on <code class="remark-inline-code">node1</code></p>
</li>
</ul>
<!-- ```keys ^D``` -->

<ul>
<li>Watch the events unfolding with <code class="remark-inline-code">kubectl get events -w</code> and <code class="remark-inline-code">kubectl get pods -w</code></li>
</ul>
</div>

<ul>
<li><p>It will take some time for Kubernetes to mark the node as unhealthy</p>
</li>
<li><p>Then it will attempt to reschedule the pod to another node</p>
</li>
<li><p>In about a minute, our pod should be up and running again</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1233 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="check-that-our-data-is-still-available">Check that our data is still available</h2>
<ul>
<li>We are going to reconnect to the (new) pod and check</li>
</ul>
<div class="exercise"><ul>
<li>Get a shell on the pod:<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl <span class="hljs-built_in">exec</span> -ti postgres-0 su postgres</div></code></pre>
</li>
</ul>
<!--
```wait postgres@postgres```
```keys PS1="\u@\h:\w\n\$ "```
```keys ^J```
-->

<ul>
<li>Check the number of rows in the <code class="remark-inline-code">pgbench_accounts</code> table:<pre><code class="bash hljs remark-code"><div class="remark-code-line">psql demo -c <span class="hljs-string">"select count(*) from pgbench_accounts"</span></div></code></pre>
</li>
</ul>
<!-- ```keys ^D``` -->

</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1234 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="double-check-that-the-pod-has-really-moved">Double-check that the pod has really moved</h2>
<ul>
<li>Just to make sure the system is not bluffing!</li>
</ul>
<div class="exercise"><ul>
<li>Look at which node the pod is now running on<pre><code class="bash hljs remark-code"><div class="remark-code-line">kubectl get pod postgres-0 -o wide</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1235 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="re-enable-the-node">Re-enable the node</h2>
<ul>
<li>Let's fix the node that we disconnected from the network</li>
</ul>
<div class="exercise"><ul>
<li><p>SSH to the node:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">ssh <span class="remark-code-span-highlighted">nodeX</span></div></code></pre>
</li>
<li><p>Remove the iptables rule blocking traffic:</p>
<pre><code class="bash hljs remark-code"><div class="remark-code-line">sudo iptables -D OUTPUT 2</div></code></pre>
</li>
</ul>
</div>

<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1236 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="a-few-words-about-this-postgresql-setup">A few words about this PostgreSQL setup</h2>
<ul>
<li><p>In a real deployment, you would want to set a password</p>
</li>
<li><p>This can be done by creating a <code class="remark-inline-code">secret</code>:</p>
<pre><code class="remark-code"><div class="remark-code-line">kubectl create secret generic postgres \</div><div class="remark-code-line">      --from-literal=password=$(base64 /dev/urandom | head -c16)</div></code></pre></li>
<li><p>And then passing that secret to the container:</p>
<pre><code class="yaml hljs remark-code"><div class="remark-code-line"><span class="hljs-attr">env:</span></div><div class="remark-code-line"><span class="hljs-attr">- name:</span> POSTGRES_PASSWORD</div><div class="remark-code-line"><span class="hljs-attr">valueFrom:</span></div><div class="remark-code-line"><span class="hljs-attr">  secretKeyRef:</span></div><div class="remark-code-line"><span class="hljs-attr">    name:</span> postgres</div><div class="remark-code-line"><span class="hljs-attr">    key:</span> password</div></code></pre>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1237 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="troubleshooting-portworx">Troubleshooting Portworx</h2>
<ul>
<li><p>If we need to see what's going on with Portworx:</p>
<pre><code class="remark-code"><div class="remark-code-line">PXPOD=$(kubectl -n kube-system get pod -l name=portworx -o json | </div><div class="remark-code-line">        jq -r .items[0].metadata.name)</div><div class="remark-code-line">kubectl -n kube-system exec $PXPOD -- /opt/pwx/bin/pxctl status</div></code></pre></li>
<li><p>We can also connect to Lighthouse (a web UI)</p>
<ul>
<li><p>check the port with <code class="remark-inline-code">kubectl -n kube-system get svc px-lighthouse</code></p>
</li>
<li><p>connect to that port</p>
</li>
<li><p>the default login/password is <code class="remark-inline-code">admin/Password1</code></p>
</li>
<li><p>then specify <code class="remark-inline-code">portworx-service</code> as the endpoint</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1238 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="removing-portworx">Removing Portworx</h2>
<ul>
<li><p>Portworx provides a storage driver</p>
</li>
<li><p>It needs to place itself "above" the Kubelet</p>
<p>(it installs itself straight on the nodes)</p>
</li>
<li><p>To remove it, we need to do more than just deleting its Kubernetes resources</p>
</li>
<li><p>It is done by applying a special label:</p>
<pre><code class="remark-code"><div class="remark-code-line">kubectl label nodes --all px/enabled=remove --overwrite</div></code></pre></li>
<li><p>Then removing a bunch of local files:</p>
<pre><code class="remark-code"><div class="remark-code-line">sudo chattr -i /etc/pwx/.private.json</div><div class="remark-code-line">sudo rm -rf /etc/pwx /opt/pwx</div></code></pre><p>(on each node where Portworx was running)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1239 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="dynamic-provisioning-without-a-provider">Dynamic provisioning without a provider</h2>
<ul>
<li><p>What if we want to use Stateful sets without a storage provider?</p>
</li>
<li><p>We will have to create volumes manually</p>
<p>(by creating Persistent Volume objects)</p>
</li>
<li><p>These volumes will be automatically bound with matching Persistent Volume Claims</p>
</li>
<li><p>We can use local volumes (essentially bind mounts of host directories)</p>
</li>
<li><p>Of course, these volumes won't be available in case of node failure</p>
</li>
<li><p>Check <a href="https://kubernetes.io/blog/2018/04/13/local-persistent-volumes-beta/">this blog post</a> for more information and gotchas</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1240 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="acknowledgements">Acknowledgements</h2>
<p>The Portworx installation tutorial, and the PostgreSQL example,
were inspired by <a href="https://katacoda.com/portworx/scenarios/">Portworx examples on Katacoda</a>, in particular:</p>
<ul>
<li><p><a href="https://www.katacoda.com/portworx/scenarios/deploy-px-k8s">installing Portworx on Kubernetes</a></p>
<p>(with adapatations to use a loop device and an embedded key/value store)</p>
</li>
<li><p><a href="https://www.katacoda.com/portworx/scenarios/px-k8s-vol-basic">persistent volumes on Kubernetes using Portworx</a></p>
<p>(with adapatations to specify a default Storage Class)</p>
</li>
<li><p><a href="https://www.katacoda.com/portworx/scenarios/px-k8s-postgres-all-in-one">HA PostgreSQL on Kubernetes with Portworx</a></p>
<p>(with adaptations to use a Stateful Set and simplify PostgreSQL's setup)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/portworx.md">k8s/portworx.md</a></span></p><div class="remark-slide-number">1241 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/container-housing.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1242 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-whats-next" class="remark-slide-content title hljs-default"><p>What's next?</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-highly-available-persistent-volumes">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-17">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-links-and-resources">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1243 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="what-s-next-">What's next?</h1>
<ul>
<li><p>Congratulations!</p>
</li>
<li><p>We learned a lot about Kubernetes, its internals, its advanced concepts</p>
</li>
</ul><div class="remark-slide-number">1244 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="what-s-next-">What's next?</h1>
<ul>
<li><p>Congratulations!</p>
</li>
<li><p>We learned a lot about Kubernetes, its internals, its advanced concepts</p>
</li>
<li><p>That was just the easy part</p>
</li>
<li><p>The hard challenges will revolve around <em>culture</em> and <em>people</em></p>
</li>
</ul><div class="remark-slide-number">1245 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide remark-slide-incremental"><div class="remark-slide-content hljs-default"><h1 id="what-s-next-">What's next?</h1>
<ul>
<li><p>Congratulations!</p>
</li>
<li><p>We learned a lot about Kubernetes, its internals, its advanced concepts</p>
</li>
<li><p>That was just the easy part</p>
</li>
<li><p>The hard challenges will revolve around <em>culture</em> and <em>people</em></p>
</li>
<li><p>... What does that mean?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1246 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="running-an-app-involves-many-steps">Running an app involves many steps</h2>
<ul>
<li><p>Write the app</p>
</li>
<li><p>Tests, QA ...</p>
</li>
<li><p>Ship <em>something</em> (more on that later)</p>
</li>
<li><p>Provision resources (e.g. VMs, clusters)</p>
</li>
<li><p>Deploy the <em>something</em> on the resources</p>
</li>
<li><p>Manage, maintain, monitor the resources</p>
</li>
<li><p>Manage, maintain, monitor the app</p>
</li>
<li><p>And much more</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1247 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="who-does-what-">Who does what?</h2>
<ul>
<li><p>The old "devs vs ops" division has changed</p>
</li>
<li><p>In some organizations, "ops" are now called "SRE" or "platform" teams</p>
<p>(and they have very different sets of skills)</p>
</li>
<li><p>Do you know which team is responsible for each item on the list on the previous page?</p>
</li>
<li><p>Acknowledge that a lot of tasks are outsourced</p>
<p>(e.g. if we add "buy / rack / provision machines" in that list)</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1248 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-do-we-ship-">What do we ship?</h2>
<ul>
<li><p>Some organizations embrace "you build it, you run it"</p>
</li>
<li><p>When "build" and "run" are owned by different teams, where's the line?</p>
</li>
<li><p>What does the "build" team ship to the "run" team?</p>
</li>
<li><p>Let's see a few options, and what they imply</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1249 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="shipping-code">Shipping code</h2>
<ul>
<li><p>Team "build" ships code</p>
<p>(hopefully in a repository, identified by a commit hash)</p>
</li>
<li><p>Team "run" containerizes that code</p>
</li>
</ul>
<p>✔️ no extra work for developers</p>
<p>❌ very little advantage of using containers</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1250 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="shipping-container-images">Shipping container images</h2>
<ul>
<li><p>Team "build" ships container images</p>
<p>(hopefully built automatically from a source repository)</p>
</li>
<li><p>Team "run" uses theses images to create e.g. Kubernetes resources</p>
</li>
</ul>
<p>✔️ universal artefact (support all languages uniformly)</p>
<p>✔️ easy to start a single component (good for monoliths)</p>
<p>❌ complex applications will require a lot of extra work</p>
<p>❌ adding/removing components in the stack also requires extra work</p>
<p>❌ complex applications will run very differently between dev and prod</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1251 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="shipping-compose-files">Shipping Compose files</h2>
<p>(Or another kind of dev-centric manifest)</p>
<ul>
<li><p>Team "build" ships a manifest that works on a single node</p>
<p>(as well as images, or ways to build them)</p>
</li>
<li><p>Team "run" adapts that manifest to work on a cluster</p>
</li>
</ul>
<p>✔️ all teams can start the stack in a reliable, deterministic manner</p>
<p>❌ adding/removing components still requires <em>some</em> work (but less than before)</p>
<p>❌ there will be <em>some</em> differences between dev and prod</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1252 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="shipping-kubernetes-manifests">Shipping Kubernetes manifests</h2>
<ul>
<li><p>Team "build" ships ready-to-run manifests</p>
<p>(YAML, Helm charts, Kustomize ...)</p>
</li>
<li><p>Team "run" adjusts some parameters and monitors the application </p>
</li>
</ul>
<p>✔️ parity between dev and prod environments</p>
<p>✔️ "run" team can focus on SLAs, SLOs, and overall quality</p>
<p>❌ requires <em>a lot</em> of extra work (and new skills) from the "build" team</p>
<p>❌ Kubernetes is not a very convenient development platform (at least, not yet)</p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1253 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="what-s-the-right-answer-">What's the right answer?</h2>
<ul>
<li><p>It depends on our teams</p>
<ul>
<li><p>existing skills (do they know how to do it?)</p>
</li>
<li><p>availability (do they have the time to do it?)</p>
</li>
<li><p>potential skills (can they learn to do it?)</p>
</li>
</ul>
</li>
<li><p>It depends on our culture</p>
<ul>
<li><p>owning "run" often implies being on call</p>
</li>
<li><p>do we reward on-call duty without encouraging hero syndrome?</p>
</li>
<li><p>do we give resources (time, money) to people to learn?</p>
</li>
</ul>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1254 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="tools-to-develop-on-kubernetes">Tools to develop on Kubernetes</h2>
<p><em>If we decide to make Kubernetes the primary development platform, here
are a few tools that can help us.</em></p>
<ul>
<li><p>Docker Desktop</p>
</li>
<li><p>Draft</p>
</li>
<li><p>Minikube</p>
</li>
<li><p>Skaffold</p>
</li>
<li><p>Tilt</p>
</li>
<li><p>...</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1255 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="where-do-we-run-">Where do we run?</h2>
<ul>
<li><p>Managed vs. self-hosted</p>
</li>
<li><p>Cloud vs. on-premises</p>
</li>
<li><p>If cloud: public vs. private</p>
</li>
<li><p>Which vendor / distribution to pick?</p>
</li>
<li><p>Which versions / features to enable?</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1256 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h2 id="some-guidelines">Some guidelines</h2>
<ul>
<li><p>Start small</p>
</li>
<li><p>Outsource what we don't know</p>
</li>
<li><p>Start simple, and stay simple as long as possible</p>
<p>(try to stay away from complex features that we don't need)</p>
</li>
<li><p>Automate</p>
<p>(regularly check that we can successfully redeploy by following scripts)</p>
</li>
<li><p>Transfer knowledge</p>
<p>(make sure everyone is on the same page / same level)</p>
</li>
<li><p>Iterate!</p>
</li>
</ul>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/lastwords-admin.md">k8s/lastwords-admin.md</a></span></p><div class="remark-slide-number">1257 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content pic hljs-default"><p><span class="interstitial"><img src="./Kubernetes Administrator Training_files/containers-by-the-water.jpg" alt="Image separating from the next chapter"></span></p><div class="remark-slide-number">1258 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div id="slide-toc-links-and-resources" class="remark-slide-content title hljs-default"><p>Links and resources</p>
<div class="nav"><p><a href="https://wwrk-2019-06.container.training/#toc-whats-next">Previous section</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-chapter-17">Back to table of contents</a>
|
<a href="https://wwrk-2019-06.container.training/#toc-">Next section</a></p>
</div>

<p><span class="debug">(automatically generated title slide)</span></p><div class="remark-slide-number">1259 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content hljs-default"><h1 id="links-and-resources">Links and resources</h1>
<p>All things Kubernetes:</p>
<ul>
<li><a href="https://kubernetes.io/community/">Kubernetes Community</a> - Slack, Google Groups, meetups</li>
<li><a href="https://stackoverflow.com/questions/tagged/kubernetes">Kubernetes on StackOverflow</a></li>
<li><a href="https://medium.com/@marcosnils/introducing-pwk-play-with-k8s-159fcfeb787b">Play With Kubernetes Hands-On Labs</a></li>
</ul>
<p>All things Docker:</p>
<ul>
<li><a href="http://docs.docker.com/">Docker documentation</a></li>
<li><a href="https://hub.docker.com/">Docker Hub</a></li>
<li><a href="https://stackoverflow.com/questions/tagged/docker">Docker on StackOverflow</a></li>
<li><a href="http://training.play-with-docker.com/">Play With Docker Hands-On Labs</a></li>
</ul>
<p>Everything else:</p>
<ul>
<li><a href="https://www.meetup.com/">Local meetups</a></li>
</ul>
<p><span class="footnote">These slides (and future updates) are on → <a href="http://container.training/"></a><a href="http://container.training/">http://container.training/</a></span></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/links.md">k8s/links.md</a></span></p><div class="remark-slide-number">1260 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content title in-person hljs-default"><p>That's all, folks! <br> Questions?</p>
<p><img src="./Kubernetes Administrator Training_files/end.jpg" alt="end"></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/shared/thankyou.md">shared/thankyou.md</a></span></p><div class="remark-slide-number">1261 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div></div>
<div class="remark-preview-area"><div class="remark-slide-container"><div class="remark-slide-scaler" style="width: 1210px; height: 681px; transform: scale(0); left: 0px; top: 0px;"><div class="remark-slide"><div class="remark-slide-content extra-details hljs-default"><h2 id="container-metrics">Container metrics</h2>
<ul>
<li><p>Similar to node metrics, but not totally identical</p>
</li>
<li><p>RAM breakdown will be different</p>
<ul>
<li>active vs inactive memory</li>
<li>some memory is <em>shared</em> between containers, and accounted specially</li>
</ul>
</li>
<li><p>I/O activity is also harder to track</p>
<ul>
<li>async writes can cause deferred "charges"</li>
<li>some page-ins are also shared between containers</li>
</ul>
</li>
</ul>
<p>For details about container metrics, see:
<br>
<a href="http://jpetazzo.github.io/2013/10/08/docker-containers-metrics/">http://jpetazzo.github.io/2013/10/08/docker-containers-metrics/</a></p>
<p><span class="debug"><a href="https://github.com/jpetazzo/container.training/tree/wwrk-2019-06/slides/k8s/prometheus.md">k8s/prometheus.md</a></span></p><div class="remark-slide-number">600 / 1261</div></div></div></div><div class="remark-slide-notes"></div></div></div>
<div class="remark-backdrop"></div>
<div class="remark-pause" style="transform: scale(1.03965); left: 171.013px; top: 0px;">
  <div class="remark-pause-lozenge">
    <span>Paused</span>
  </div>
</div>
<div class="remark-help" style="width: 1210px; height: 681px; transform: scale(1.03965); left: 171.013px; top: 0px;">
  <div class="remark-help-content">
    <h1>Help</h1>
    <p><b>Keyboard shortcuts</b></p>
    <table class="light-keys">
      <tbody><tr>
        <td>
          <span class="key"><b>↑</b></span>,
          <span class="key"><b>←</b></span>,
          <span class="key">Pg Up</span>,
          <span class="key">k</span>
        </td>
        <td>Go to previous slide</td>
      </tr>
      <tr>
        <td>
          <span class="key"><b>↓</b></span>,
          <span class="key"><b>→</b></span>,
          <span class="key">Pg Dn</span>,
          <span class="key">Space</span>,
          <span class="key">j</span>
        </td>
        <td>Go to next slide</td>
      </tr>
      <tr>
        <td>
          <span class="key">Home</span>
        </td>
        <td>Go to first slide</td>
      </tr>
      <tr>
        <td>
          <span class="key">End</span>
        </td>
        <td>Go to last slide</td>
      </tr>
      <tr>
        <td>
          Number + <span class="key">Return</span>
        </td>
        <td>Go to specific slide</td>
      </tr>
      <tr>
        <td>
          <span class="key">b</span>&nbsp;/
          <span class="key">m</span>&nbsp;/
          <span class="key">f</span>
        </td>
        <td>Toggle blackout / mirrored / fullscreen mode</td>
      </tr>
      <tr>
        <td>
          <span class="key">c</span>
        </td>
        <td>Clone slideshow</td>
      </tr>
      <tr>
        <td>
          <span class="key">p</span>
        </td>
        <td>Toggle presenter mode</td>
      </tr>
      <tr>
        <td>
          <span class="key">t</span>
        </td>
        <td>Restart the presentation timer</td>
      </tr>
      <tr>
        <td>
          <span class="key">?</span>,
          <span class="key">h</span>
        </td>
        <td>Toggle this help</td>
      </tr>
    </tbody></table>
  </div>
  <div class="content dismiss">
    <table class="light-keys">
      <tbody><tr>
        <td>
          <span class="key">Esc</span>
        </td>
        <td>Back to slideshow</td>
      </tr>
    </tbody></table>
  </div>
</div>

    
    <!-- 
    These two scripts will be available only when loading the
    content using the pub/sub server. Otherwise, they'll just
    404 and that's OK.
    -->
    <script src="./Kubernetes Administrator Training_files/socket.io.js.download">
    </script>
    <script src="./Kubernetes Administrator Training_files/remote.js.download">
    </script>

  

</body><editor-card style="animation: initial; transition: initial; color: initial; font: initial; font-feature-settings: initial; font-kerning: initial; font-optical-sizing: initial; font-variation-settings: initial; text-orientation: initial; text-rendering: initial; -webkit-font-smoothing: initial; -webkit-locale: initial; -webkit-text-orientation: initial; -webkit-writing-mode: initial; writing-mode: initial; zoom: initial; place-content: initial; place-items: initial; place-self: initial; alignment-baseline: initial; backdrop-filter: initial; backface-visibility: initial; background: initial; background-blend-mode: initial; baseline-shift: initial; block-size: initial; border-block-end: initial; border-block-start: initial; border: initial; border-radius: initial; border-collapse: initial; border-inline-end: initial; border-inline-start: initial; bottom: initial; box-shadow: initial; box-sizing: initial; break-after: initial; break-before: initial; break-inside: initial; buffered-rendering: initial; caption-side: initial; caret-color: initial; clear: initial; clip: initial; clip-path: initial; clip-rule: initial; color-interpolation: initial; color-interpolation-filters: initial; color-rendering: initial; columns: initial; column-fill: initial; gap: initial; column-rule: initial; column-span: initial; contain: initial; content: initial; counter-increment: initial; counter-reset: initial; cursor: initial; cx: initial; cy: initial; d: initial; display: initial; dominant-baseline: initial; empty-cells: initial; fill: initial; fill-opacity: initial; fill-rule: initial; filter: initial; flex: initial; flex-flow: initial; float: initial; flood-color: initial; flood-opacity: initial; grid: initial; grid-area: initial; height: initial; hyphens: initial; image-rendering: initial; inline-size: initial; isolation: initial; left: 0px; letter-spacing: initial; lighting-color: initial; line-break: initial; list-style: initial; margin-block-end: initial; margin-block-start: initial; margin: initial; margin-inline-end: initial; margin-inline-start: initial; marker: initial; mask: initial; mask-type: initial; max-block-size: initial; max-height: initial; max-inline-size: initial; max-width: initial; min-block-size: initial; min-height: initial; min-inline-size: initial; min-width: initial; mix-blend-mode: initial; object-fit: initial; object-position: initial; offset: initial; opacity: initial; order: initial; orphans: initial; outline: initial; outline-offset: initial; overflow-anchor: initial; overflow-wrap: initial; overflow: initial; overscroll-behavior-block: initial; overscroll-behavior-inline: initial; overscroll-behavior: initial; padding-block-end: initial; padding-block-start: initial; padding: initial; padding-inline-end: initial; padding-inline-start: initial; page: initial; paint-order: initial; perspective: initial; perspective-origin: initial; pointer-events: initial; position: absolute; quotes: initial; r: initial; resize: initial; right: initial; rx: initial; ry: initial; scroll-behavior: initial; scroll-margin-block: initial; scroll-margin: initial; scroll-margin-inline: initial; scroll-padding-block: initial; scroll-padding: initial; scroll-padding-inline: initial; scroll-snap-align: initial; scroll-snap-stop: initial; scroll-snap-type: initial; shape-image-threshold: initial; shape-margin: initial; shape-outside: initial; shape-rendering: initial; size: initial; speak: initial; stop-color: initial; stop-opacity: initial; stroke: initial; stroke-dasharray: initial; stroke-dashoffset: initial; stroke-linecap: initial; stroke-linejoin: initial; stroke-miterlimit: initial; stroke-opacity: initial; stroke-width: initial; tab-size: initial; table-layout: initial; text-align: initial; text-align-last: initial; text-anchor: initial; text-combine-upright: initial; text-decoration: initial; text-decoration-skip-ink: initial; text-indent: initial; text-overflow: initial; text-shadow: initial; text-size-adjust: initial; text-transform: initial; text-underline-position: initial; top: 0px; touch-action: initial; transform: initial; transform-box: initial; transform-origin: initial; transform-style: initial; user-select: initial; vector-effect: initial; vertical-align: initial; visibility: initial; -webkit-app-region: initial; -webkit-appearance: initial; border-spacing: initial; -webkit-border-image: initial; -webkit-box-align: initial; -webkit-box-decoration-break: initial; -webkit-box-direction: initial; -webkit-box-flex: initial; -webkit-box-ordinal-group: initial; -webkit-box-orient: initial; -webkit-box-pack: initial; -webkit-box-reflect: initial; -webkit-font-size-delta: initial; -webkit-highlight: initial; -webkit-hyphenate-character: initial; -webkit-line-break: initial; -webkit-line-clamp: initial; -webkit-margin-collapse: initial; -webkit-margin-bottom-collapse: initial; -webkit-margin-top-collapse: initial; -webkit-mask-box-image: initial; -webkit-mask: initial; -webkit-mask-composite: initial; -webkit-perspective-origin-x: initial; -webkit-perspective-origin-y: initial; -webkit-print-color-adjust: initial; -webkit-rtl-ordering: initial; -webkit-ruby-position: initial; -webkit-tap-highlight-color: initial; -webkit-text-combine: initial; -webkit-text-decorations-in-effect: initial; -webkit-text-emphasis: initial; -webkit-text-emphasis-position: initial; -webkit-text-fill-color: initial; -webkit-text-security: initial; -webkit-text-stroke: initial; -webkit-transform-origin-x: initial; -webkit-transform-origin-y: initial; -webkit-transform-origin-z: initial; -webkit-user-drag: initial; -webkit-user-modify: initial; white-space: initial; widows: initial; width: initial; will-change: initial; word-break: initial; word-spacing: initial; x: initial; y: initial; z-index: auto;"></editor-card></html>